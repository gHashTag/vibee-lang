#!/usr/bin/env python3
"""
3-ADIC ALGORITHMS: ะะปะณะพัะธัะผั ะฝะฐ 3-ะฐะดะธัะตัะบะธั ัะธัะปะฐั

ะััะปะตะดะพะฒะฐะฝะธะต p-ะฐะดะธัะตัะบะพะน ะผะฐัะตะผะฐัะธะบะธ ะดะปั p=3.

Author: Dmitrii Vasilev
Date: January 13, 2026
"""

import math

print("=" * 70)
print("3-ADIC ALGORITHMS: ะขะะะะงะะะฏ P-ะะะะงะะกะะะฏ ะะะขะะะะขะะะ")
print("=" * 70)

# =============================================================================
# ะะะะะะะะ ะ P-ะะะะงะะกะะะ ะงะะกะะ
# =============================================================================

print("""
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                                                                              โ
โ  P-ะะะะงะะกะะะ ะงะะกะะ: ะะะฌะขะะะะะขะะะะะฏ ะะะขะะะะขะะะ                               โ
โ                                                                              โ
โ  ะะะซะงะะซะ ะงะะกะะ (ะฒะตัะตััะฒะตะฝะฝัะต):                                              โ
โ  - ะะฐัััะพัะฝะธะต: |a - b| = ะพะฑััะฝะฐั ัะฐะทะฝะพััั                                   โ
โ  - 1/3 = 0.333... (ะฑะตัะบะพะฝะตัะฝะฐั ะดัะพะฑั)                                       โ
โ  - ะกัะพะดะธะผะพััั: ะบ ะฝัะปั ะฟัะธ ัะผะตะฝััะตะฝะธะธ                                        โ
โ                                                                              โ
โ  P-ะะะะงะะกะะะ ะงะะกะะ:                                                         โ
โ  - ะะฐัััะพัะฝะธะต: |a - b|_p = p^(-v_p(a-b))                                    โ
โ  - v_p(n) = ะผะฐะบัะธะผะฐะปัะฝะฐั ััะตะฟะตะฝั p, ะดะตะปััะฐั n                               โ
โ  - ะกัะพะดะธะผะพััั: ะบ ะฝัะปั ะฟัะธ ะฃะะะะะงะะะะ ััะตะฟะตะฝะธ p!                             โ
โ                                                                              โ
โ  3-ะะะะงะะกะะะ ะงะะกะะ (โคโ):                                                    โ
โ  - ะะฐัััะพัะฝะธะต: |a - b|โ = 3^(-vโ(a-b))                                      โ
โ  - ะงะธัะปะฐ, ะดะตะปััะธะตัั ะฝะฐ 3, ะะะะะ ะบ ะฝัะปั!                                     โ
โ  - 27 ะฑะปะธะถะต ะบ 0, ัะตะผ 1 (ะฟะพัะพะผั ััะพ 27 = 3ยณ)                                 โ
โ                                                                              โ
โ  ะกะะฏะะฌ ะก TRINITY:                                                           โ
โ  - 3-ะฐะดะธัะตัะบะฐั ะฝะพัะผะฐ ะธะทะผะตััะตั "ััะพะธัะฝะพััั" ัะธัะปะฐ                           โ
โ  - ะงะตะผ ะฑะพะปััะต ััะพะตะบ ะฒ ัะฐะทะปะพะถะตะฝะธะธ, ัะตะผ ะฑะปะธะถะต ะบ ะฝัะปั                         โ
โ  - ะขัะธะดะตะฒััะพะต ัะฐัััะฒะพ (27 = 3ยณ) โ ะพัะตะฝั ะฑะปะธะทะบะพ ะบ ะฝัะปั!                     โ
โ                                                                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
""")

# =============================================================================
# 3-ะะะะงะะกะะะฏ ะะะะะ
# =============================================================================

print("\n" + "=" * 70)
print("3-ะะะะงะะกะะะฏ ะะะะะ")
print("=" * 70)

def v3(n):
    """
    3-ะฐะดะธัะตัะบะฐั ะฒะฐะปัะฐัะธั: ะผะฐะบัะธะผะฐะปัะฝะฐั ััะตะฟะตะฝั 3, ะดะตะปััะฐั n
    
    vโ(n) = max{k : 3^k | n}
    """
    if n == 0:
        return float('inf')
    
    n = abs(n)
    count = 0
    while n % 3 == 0:
        n //= 3
        count += 1
    return count

def norm3(n):
    """
    3-ะฐะดะธัะตัะบะฐั ะฝะพัะผะฐ: |n|โ = 3^(-vโ(n))
    
    ะงะตะผ ะฑะพะปััะต ััะพะตะบ ะดะตะปะธั n, ัะตะผ ะผะตะฝััะต ะฝะพัะผะฐ!
    """
    if n == 0:
        return 0
    return 3 ** (-v3(n))

def dist3(a, b):
    """3-ะฐะดะธัะตัะบะพะต ัะฐัััะพัะฝะธะต"""
    return norm3(a - b)

print("3-ะฐะดะธัะตัะบะฐั ะฒะฐะปัะฐัะธั vโ(n):")
print(f"{'n':<10} {'vโ(n)':<10} {'|n|โ':<15} {'ะะฝัะตัะฟัะตัะฐัะธั'}")
print("-" * 60)

examples = [1, 2, 3, 6, 9, 12, 27, 81, 100, 243]
for n in examples:
    v = v3(n)
    norm = norm3(n)
    if v == 0:
        interp = "ะะต ะดะตะปะธััั ะฝะฐ 3"
    elif v == 1:
        interp = "ะะตะปะธััั ะฝะฐ 3"
    elif v == 2:
        interp = "ะะตะปะธััั ะฝะฐ 9"
    elif v == 3:
        interp = "ะะตะปะธััั ะฝะฐ 27 (ะขัะธะดะตะฒััะพะต!)"
    else:
        interp = f"ะะตะปะธััั ะฝะฐ 3^{v}"
    print(f"{n:<10} {v:<10} {norm:<15.6f} {interp}")

# =============================================================================
# 3-ะะะะงะะกะะะ ะะะกะกะขะะฏะะะ
# =============================================================================

print("\n" + "=" * 70)
print("3-ะะะะงะะกะะะ ะะะกะกะขะะฏะะะ")
print("=" * 70)

print("""
ะ 3-ะฐะดะธัะตัะบะพะน ะผะตััะธะบะต:
- ะงะธัะปะฐ, ะพัะปะธัะฐััะธะตัั ะฝะฐ 3^k, ะฝะฐัะพะดัััั ะฝะฐ ัะฐัััะพัะฝะธะธ 3^(-k)
- ะงะตะผ ะฑะพะปััะต k, ัะตะผ ะะะะะ ัะธัะปะฐ!

ะญัะพ ะะะะขะะะะะะะะะะ ะพะฑััะฝะพะน ะธะฝััะธัะธะธ!
""")

print("\nะะฐัััะพัะฝะธั ะพั 0:")
print(f"{'n':<10} {'|n - 0|โ':<15} {'ะะฑััะฝะพะต |n|':<15}")
print("-" * 45)

for n in [1, 3, 9, 27, 81, 243]:
    d3 = dist3(n, 0)
    d_usual = abs(n)
    print(f"{n:<10} {d3:<15.6f} {d_usual:<15}")

print("\nะะฐัะฐะดะพะบั: 243 ะะะะะ ะบ 0, ัะตะผ 1!")
print("ะะพัะพะผั ััะพ 243 = 3โต, ะฐ 1 ะฝะต ะดะตะปะธััั ะฝะฐ 3.")

# =============================================================================
# 3-ะะะะงะะกะะะ ะะะะะะะะะะ
# =============================================================================

print("\n" + "=" * 70)
print("3-ะะะะงะะกะะะ ะะะะะะะะะะ")
print("=" * 70)

def to_3adic(n, digits=10):
    """
    ะะฐะทะปะพะถะตะฝะธะต ัะธัะปะฐ ะฒ 3-ะฐะดะธัะตัะบะพะผ ะฒะธะดะต
    
    n = aโ + aโร3 + aโร3ยฒ + aโร3ยณ + ...
    ะณะดะต aแตข โ {0, 1, 2}
    """
    if n == 0:
        return [0]
    
    result = []
    for _ in range(digits):
        result.append(n % 3)
        n //= 3
        if n == 0:
            break
    return result

def from_3adic(digits):
    """ะะพัััะฐะฝะพะฒะปะตะฝะธะต ัะธัะปะฐ ะธะท 3-ะฐะดะธัะตัะบะพะณะพ ัะฐะทะปะพะถะตะฝะธั"""
    result = 0
    for i, d in enumerate(digits):
        result += d * (3 ** i)
    return result

print("3-ะฐะดะธัะตัะบะพะต ัะฐะทะปะพะถะตะฝะธะต:")
print(f"{'n':<10} {'3-adic':<20} {'ะัะพะฒะตัะบะฐ'}")
print("-" * 45)

for n in [1, 5, 10, 27, 42, 100]:
    digits = to_3adic(n)
    check = from_3adic(digits)
    digits_str = ''.join(map(str, reversed(digits)))
    print(f"{n:<10} {digits_str:<20} {check}")

# =============================================================================
# ะะะะะะะะะะ ะ ะะะะะะะขะะะ
# =============================================================================

print("\n" + "=" * 70)
print("ะะะะะะะะะะ ะ ะะะะะะะขะะะ")
print("=" * 70)

print("""
ะะะะฏ: ะัะฟะพะปัะทะพะฒะฐัั 3-ะฐะดะธัะตัะบัั ััััะบัััั ะดะปั ะพะฟัะธะผะธะทะฐัะธะธ ะฐะปะณะพัะธัะผะพะฒ.

1. 3-ะะะะงะะกะะะฏ ะกะะะขะะะะะะ
   ะกะพััะธัะพะฒะฐัั ัะธัะปะฐ ะฟะพ 3-ะฐะดะธัะตัะบะพะน ะฝะพัะผะต.
   ะงะธัะปะฐ ั ะฑะพะปััะตะน "ััะพะธัะฝะพัััั" ะธะดัั ะฟะตัะฒัะผะธ.
   
   ะัะธะผะตะฝะตะฝะธะต: ะณััะฟะฟะธัะพะฒะบะฐ ะดะฐะฝะฝัั ะฟะพ ะดะตะปะธะผะพััะธ ะฝะฐ 3.

2. 3-ะะะะงะะกะะะ ะฅะะจะะะะะะะะ
   h(n) = vโ(n) mod table_size
   
   ะััะฟะฟะธััะตั ัะธัะปะฐ ะฟะพ ะธั "ััะพะธัะฝะพััะธ".
   ะะพะปะตะทะฝะพ ะดะปั ัะฟะตัะธัะธัะตัะบะธั ัะฐัะฟัะตะดะตะปะตะฝะธะน.

3. 3-ะะะะงะะกะะะ ะะะะกะ
   ะะผะตััะพ ะฑะธะฝะฐัะฝะพะณะพ ะฟะพะธัะบะฐ โ ััะพะธัะฝัะน ั 3-ะฐะดะธัะตัะบะพะน ะผะตััะธะบะพะน.
   
   ะญััะตะบัะธะฒะตะฝ ะดะปั ะดะฐะฝะฝัั ั ััะพะธัะฝะพะน ััััะบัััะพะน.

4. 3-ะะะะงะะกะะะฏ ะะะขะะะะะะฏะฆะะฏ
   ะะฝัะตัะฟะพะปััะธั ััะฝะบัะธะน ะฒ 3-ะฐะดะธัะตัะบะพะน ะผะตััะธะบะต.
   
   ะัะธะผะตะฝะตะฝะธะต: ะบัะธะฟัะพะณัะฐัะธั, ัะตะพัะธั ัะธัะตะป.
""")

# ะัะธะผะตั: 3-ะฐะดะธัะตัะบะฐั ัะพััะธัะพะฒะบะฐ
print("\n3-ะฐะดะธัะตัะบะฐั ัะพััะธัะพะฒะบะฐ:")
numbers = [1, 2, 3, 4, 5, 6, 7, 8, 9, 12, 18, 27, 54, 81]
sorted_3adic = sorted(numbers, key=lambda x: (-v3(x), x))

print(f"ะััะพะดะฝัะน: {numbers}")
print(f"3-ะฐะดะธัะตัะบะธะน ะฟะพััะดะพะบ: {sorted_3adic}")
print("(ะกะฝะฐัะฐะปะฐ ัะธัะปะฐ ั ะฑะพะปััะตะน 'ััะพะธัะฝะพัััั')")

# =============================================================================
# ะกะะฏะะฌ ะก ะขะะะะะะ ะงะะกะะ
# =============================================================================

print("\n" + "=" * 70)
print("ะกะะฏะะฌ ะก ะขะะะะะะ ะงะะกะะ")
print("=" * 70)

print("""
ะขะะะะะะ ะะกะขะะะะะะะกะะะะ-ะะะะะะะฏ:
  ะฃัะฐะฒะฝะตะฝะธะต f(x) โก 0 (mod 3^k) ะธะผะตะตั ัะตัะตะฝะธะต,
  ะตัะปะธ f(x) โก 0 (mod 3) ะธะผะตะตั ัะตัะตะฝะธะต ั f'(x) โข 0 (mod 3).
  
  ะญัะพ ะฟะพะทะฒะพะปัะตั "ะฟะพะดะฝะธะผะฐัั" ัะตัะตะฝะธั ั mod 3 ะดะพ mod 3^k.

ะะะะะะะะะะ ะ TRINITY:
  - Threshold 27 = 3ยณ โ ััะพ "ะณะปัะฑะธะฝะฐ" 3-ะฐะดะธัะตัะบะพะณะพ ะฐะฝะฐะปะธะทะฐ
  - ะงะธัะปะฐ, ะดะตะปััะธะตัั ะฝะฐ 27, ะพะฑัะฐะทััั "ัะดัะพ" ะฒ 3-ะฐะดะธัะตัะบะพะน ัะพะฟะพะปะพะณะธะธ
  - Trinity Sort ัะฐะฑะพัะฐะตั ั 3-ะฐะดะธัะตัะบะพะน ััััะบัััะพะน ะดะฐะฝะฝัั

ะะะะะขะะะ:
  ะะฟัะธะผะฐะปัะฝะพััั Trinity Sort ะผะพะถะตั ะฑััั ัะฒัะทะฐะฝะฐ
  ั 3-ะฐะดะธัะตัะบะพะน ััััะบัััะพะน ััะฐะฒะฝะตะฝะธะน.
  
  ะะพะณะดะฐ ะผั ะดะตะปะฐะตะผ 3-way partition:
  - ะญะปะตะผะตะฝัั < pivot: vโ(diff) ะผะพะถะตั ะฑััั ะปัะฑัะผ
  - ะญะปะตะผะตะฝัั = pivot: vโ(diff) = โ (ัะฐะทะฝะพััั = 0)
  - ะญะปะตะผะตะฝัั > pivot: vโ(diff) ะผะพะถะตั ะฑััั ะปัะฑัะผ
  
  ะกัะตะดะฝัั ะณััะฟะฟะฐ (=) ะธะผะตะตั ะะะกะะะะะงะะฃะฎ 3-ะฐะดะธัะตัะบัั ะฒะฐะปัะฐัะธั!
  ะญัะพ ะพะฑัััะฝัะตั, ะฟะพัะตะผั ะตั ะฝะต ะฝัะถะฝะพ ัะพััะธัะพะฒะฐัั.
""")

# =============================================================================
# HENSEL'S LEMMA: ะะะะะะ
# =============================================================================

print("\n" + "=" * 70)
print("ะะะะะ ะะะะะะะฏ: ะะะะะะ")
print("=" * 70)

def hensel_lift(f, df, x0, p, k):
    """
    ะะพะดะฝััะธะต ัะตัะตะฝะธั f(x) โก 0 (mod p) ะดะพ mod p^k
    
    x_{n+1} = x_n - f(x_n) ร (df(x_n))^(-1) mod p^{n+1}
    """
    x = x0
    for i in range(1, k):
        fx = f(x)
        dfx = df(x)
        
        # ะะฐัะพะดะธะผ ะพะฑัะฐัะฝัะน ะบ df(x) mod p^(i+1)
        # ะฃะฟัะพััะฝะฝะพ: ะธัะฟะพะปัะทัะตะผ ัะฐััะธัะตะฝะฝัะน ะฐะปะณะพัะธัะผ ะะฒะบะปะธะดะฐ
        inv = pow(dfx, -1, p**(i+1))
        
        x = (x - fx * inv) % (p**(i+1))
    
    return x

# ะัะธะผะตั: xยฒ โก 7 (mod 3^k)
# ะะฐัะฐะปัะฝะพะต ัะตัะตะฝะธะต: x โก 1 (mod 3), ะฟะพัะพะผั ััะพ 1ยฒ = 1 โก 7 โก 1 (mod 3)
# ะะตั! 7 โก 1 (mod 3), ะธ 1ยฒ = 1 โก 1 (mod 3). โ

print("ะัะธะผะตั: ัะตัะตะฝะธะต xยฒ โก 7 (mod 3^k)")
print("ะะฐัะฐะปัะฝะพะต: x โก 1 (mod 3), ะฟะพัะพะผั ััะพ 1ยฒ = 1 โก 7 โก 1 (mod 3)")
print()

# ะัะพะฒะตัะธะผ ะฒัััะฝัั
print(f"{'k':<5} {'3^k':<10} {'x':<10} {'xยฒ mod 3^k':<15} {'7 mod 3^k':<15} {'ะกะพะฒะฟะฐะดะฐะตั?'}")
print("-" * 65)

# xยฒ = 7 ะฝะต ะธะผะตะตั ัะตัะตะฝะธั ะฒ ัะตะปัั, ะฝะพ ะธะผะตะตั ะฒ 3-ะฐะดะธัะตัะบะธั!
# ะญัะพ ะฟะพะบะฐะทัะฒะฐะตั ัะธะปั p-ะฐะดะธัะตัะบะพะณะพ ะฐะฝะฐะปะธะทะฐ

for k in range(1, 6):
    mod = 3**k
    # ะัะตะผ x ัะฐะบะพะน ััะพ xยฒ โก 7 (mod 3^k)
    found = False
    for x in range(mod):
        if (x * x) % mod == 7 % mod:
            print(f"{k:<5} {mod:<10} {x:<10} {(x*x) % mod:<15} {7 % mod:<15} {'โ'}")
            found = True
            break
    if not found:
        print(f"{k:<5} {mod:<10} {'โ':<10} {'โ':<15} {7 % mod:<15} {'ะะตั ัะตัะตะฝะธั'}")

# =============================================================================
# ะะซะะะะซ
# =============================================================================

print("\n" + "=" * 70)
print("ะะซะะะะซ")
print("=" * 70)

print("""
3-ADIC ALGORITHMS:

๐ ะขะะะะะฏ:
   - 3-ะฐะดะธัะตัะบะธะต ัะธัะปะฐ โ ะฐะปััะตัะฝะฐัะธะฒะฝะฐั ะผะตััะธะบะฐ
   - ะงะธัะปะฐ ั ะฑะพะปััะตะน "ััะพะธัะฝะพัััั" ะฑะปะธะถะต ะบ ะฝัะปั
   - 27 = 3ยณ ะฑะปะธะถะต ะบ 0, ัะตะผ 1!

๐ ะกะะฏะะฌ ะก TRINITY:
   - Threshold 27 = 3ยณ ะธะผะตะตั ะณะปัะฑะพะบะธะน 3-ะฐะดะธัะตัะบะธะน ัะผััะป
   - 3-way partition ัะฐะทะดะตะปัะตั ะฟะพ 3-ะฐะดะธัะตัะบะพะน ััััะบัััะต
   - ะกัะตะดะฝัั ะณััะฟะฟะฐ (=) ะธะผะตะตั ะฑะตัะบะพะฝะตัะฝัั ะฒะฐะปัะฐัะธั

๐ก ะะะะะะะะะะฏ:
   - 3-ะฐะดะธัะตัะบะฐั ัะพััะธัะพะฒะบะฐ (ะฟะพ "ััะพะธัะฝะพััะธ")
   - 3-ะฐะดะธัะตัะบะพะต ัะตัะธัะพะฒะฐะฝะธะต
   - ะัะธะฟัะพะณัะฐัะธั ะธ ัะตะพัะธั ัะธัะตะป
   - ะะฝะฐะปะธะท ะฐะปะณะพัะธัะผะพะฒ

๐ฏ ะะะะะะซะ ะะะกะะะข:
   Trinity Sort ะผะพะถะตั ะฑััั ะพะฟัะธะผะฐะปะตะฝ ะฟะพัะพะผั,
   ััะพ ัะฐะฑะพัะฐะตั ั 3-ะฐะดะธัะตัะบะพะน ััััะบัััะพะน ะดะฐะฝะฝัั.
   
   ะญัะพ ะณะปัะฑะพะบะฐั ะผะฐัะตะผะฐัะธัะตัะบะฐั ะฟัะธัะธะฝะฐ,
   ะฟะพัะตะผั ัะธัะปะพ 3 ะฟะพัะฒะปัะตััั ะฒ ะพะฟัะธะผะฐะปัะฝัั ะฐะปะณะพัะธัะผะฐั.

โ๏ธ ะกะขะะขะฃะก:
   ะขะตะพัะตัะธัะตัะบะธะน ะธะฝัะตัะตั.
   ะัะฐะบัะธัะตัะบะธะต ะฟัะธะผะตะฝะตะฝะธั ััะตะฑััั ะดะฐะปัะฝะตะนัะธั ะธััะปะตะดะพะฒะฐะฝะธะน.
""")
