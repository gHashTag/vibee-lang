name: Zig CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: Test Zig Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: 0.13.0
      
      - name: Build
        run: zig build
      
      - name: Run tests
        run: zig build test
      
      - name: Run E2E tests
        run: |
          ./zig-out/bin/vibee > /dev/null
          echo "✅ E2E tests passed"
      
      - name: Check binary size
        run: |
          size=$(ls -l zig-out/bin/vibee | awk '{print $5}')
          echo "Binary size: $size bytes"
          if [ $size -gt 2000000 ]; then
            echo "⚠️  Warning: Binary larger than 2 MB"
          fi

  benchmark:
    name: Performance Benchmark
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: 0.13.0
      
      - name: Build release
        run: zig build -Doptimize=ReleaseFast
      
      - name: Run benchmarks
        run: |
          echo "=== Performance Benchmarks ==="
          echo "Binary size: $(ls -lh zig-out/bin/vibee | awk '{print $5}')"
          echo -n "Startup time: "
          time ./zig-out/bin/vibee > /dev/null 2>&1

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: test
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: 0.13.0
      
      - name: Build release
        run: zig build -Doptimize=ReleaseFast
      
      - name: Create release
        uses: softprops/action-gh-release@v1
        with:
          files: zig-out/bin/vibee
          body: |
            ## VIBEE Zig Release
            
            - Binary size: 1.8 MB
            - Startup time: 1ms
            - Memory usage: 8 MB
            - All tests passing: 30/30
