name: VIBEE CI/CD

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  ZIG_VERSION: "0.13.0"

jobs:
  # ═══════════════════════════════════════════════════════════════════════════
  # WASM BUILD & TEST (PRIMARY)
  # ═══════════════════════════════════════════════════════════════════════════
  wasm-test:
    name: WASM Build & Test
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: ${{ env.ZIG_VERSION }}
          
      - name: Test phi_core
        run: cd trinity/wasm && zig test src/phi_core.zig
        
      - name: Test phi_structures
        run: cd trinity/wasm && zig test src/phi_structures.zig
        
      - name: Test phi_layout
        run: cd trinity/wasm && zig test src/phi_layout.zig
        
      - name: Test phi_crypto
        run: cd trinity/wasm && zig test src/phi_crypto.zig
        
      - name: Build WASM (Release + SIMD)
        run: cd trinity/wasm && zig build -Doptimize=ReleaseSmall -Dsimd=true
        
      - name: Check WASM Sizes
        run: |
          echo "╔══════════════════════════════════════════════════════════════╗"
          echo "║                    WASM MODULE SIZES                         ║"
          echo "╚══════════════════════════════════════════════════════════════╝"
          ls -la trinity/wasm/zig-out/bin/*.wasm
          total=$(stat -c%s trinity/wasm/zig-out/bin/*.wasm | awk '{sum += $1} END {print sum}')
          echo "Total: $total bytes"
          if [ "$total" -gt 102400 ]; then
            echo "❌ WASM size exceeds 100KB!"
            exit 1
          fi
          echo "✅ WASM size OK"
          
      - name: Upload WASM
        uses: actions/upload-artifact@v4
        with:
          name: wasm-modules
          path: trinity/wasm/zig-out/bin/*.wasm

  # ═══════════════════════════════════════════════════════════════════════════
  # VIBEEC COMPILER TEST
  # ═══════════════════════════════════════════════════════════════════════════
  vibeec-test:
    name: VIBEEC Compiler Test
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: ${{ env.ZIG_VERSION }}
          
      - name: Test vibee_parser
        run: cd src/vibeec && zig test vibee_parser.zig
        
      - name: Test zig_codegen
        run: cd src/vibeec && zig test zig_codegen.zig
        
      - name: Build vibeec
        run: cd src/vibeec && zig build-exe gen_cmd.zig --name vibeec
        
      - name: Generate from spec
        run: cd src/vibeec && ./vibeec gen ../../specs/phi_core.vibee ../../generated/phi_core_gen.zig
        
      - name: Test generated code
        run: cd generated && zig test phi_core_gen.zig

  # ═══════════════════════════════════════════════════════════════════════════
  # BENCHMARKS
  # ═══════════════════════════════════════════════════════════════════════════
  benchmark:
    name: Performance Benchmarks
    runs-on: ubuntu-latest
    needs: [wasm-test, vibeec-test]
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: ${{ env.ZIG_VERSION }}
          
      - name: Run Benchmarks
        run: |
          cd trinity/wasm
          cat > bench_ci.zig << 'EOFZIG'
          const std = @import("std");
          const phi_core = @import("src/phi_core.zig");
          var g: f64 = 0;
          pub fn main() !void {
              const out = std.io.getStdOut().writer();
              var t1 = try std.time.Timer.start();
              var i: u32 = 0;
              while (i < 5_000_000) : (i += 1) { g += phi_core.phi_power(@intCast(i % 100)); }
              const phi_ops = 5_000_000.0 / (@as(f64, @floatFromInt(t1.read())) / 1e9);
              
              var t2 = try std.time.Timer.start();
              i = 0;
              while (i < 50_000_000) : (i += 1) { g += phi_core.verify_trinity(); }
              const trinity_ops = 50_000_000.0 / (@as(f64, @floatFromInt(t2.read())) / 1e9);
              
              var t3 = try std.time.Timer.start();
              i = 0;
              while (i < 50_000) : (i += 1) { g += phi_core.simd_verify_trinity_batch(1000); }
              const simd_ops = 50_000_000.0 / (@as(f64, @floatFromInt(t3.read())) / 1e9);
              
              try out.print("phi_power: {d:.0} ops/sec\n", .{phi_ops});
              try out.print("verify_trinity: {d:.0} ops/sec\n", .{trinity_ops});
              try out.print("simd_trinity: {d:.0} ops/sec\n", .{simd_ops});
              try out.print("simd_speedup: {d:.2}x\n", .{simd_ops / trinity_ops});
          }
          EOFZIG
          zig run bench_ci.zig
          rm bench_ci.zig

  # ═══════════════════════════════════════════════════════════════════════════
  # SPEC VALIDATION
  # ═══════════════════════════════════════════════════════════════════════════
  validate-specs:
    name: Validate .vibee Specs
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check .vibee files syntax (YAML)
        run: |
          echo "Validating .vibee specification files..."
          for file in $(find specs -name "*.vibee" 2>/dev/null); do
            echo "Checking: $file"
            python3 -c "import yaml; yaml.safe_load(open('$file'))" || exit 1
          done
          echo "All .vibee files are valid YAML"

      - name: Check Given/When/Then format
        run: |
          echo "Checking Given/When/Then format..."
          for file in $(find specs -name "*.vibee" 2>/dev/null); do
            if grep -q "behaviors:" "$file"; then
              if ! grep -q "given:" "$file" || ! grep -q "when:" "$file" || ! grep -q "then:" "$file"; then
                echo "Missing Given/When/Then in $file"
                exit 1
              fi
            fi
          done
          echo "All specs have Given/When/Then format"

  zig-build:
    name: Zig Build & Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: 0.13.0

      - name: Build VIBEEC Compiler
        working-directory: src/vibeec
        run: zig build

      - name: Run Unit Tests
        working-directory: src/vibeec
        run: zig build test
        continue-on-error: true

      - name: Build and test Zig modules
        run: |
          echo "Building Zig modules..."
          find src/pollen -name "*.zig" -type f 2>/dev/null | head -5 | while read file; do
            echo "Testing: $file"
            zig test "$file" 2>/dev/null || echo "Skipped: $file"
          done
          echo "Zig build completed"

  pas-tests:
    name: PAS Component Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: 0.13.0

      - name: Test PAS Engine
        working-directory: src/vibeec
        run: zig test pas.zig
        continue-on-error: true

      - name: Test SIMD Parser
        working-directory: src/vibeec
        run: zig test simd_parser.zig
        continue-on-error: true

      - name: Test E-Graph Optimizer
        working-directory: src/vibeec
        run: zig test egraph.zig
        continue-on-error: true

      - name: Test Incremental Types
        working-directory: src/vibeec
        run: zig test incremental_types.zig
        continue-on-error: true

      - name: Test Property Testing
        working-directory: src/vibeec
        run: zig test property_testing.zig
        continue-on-error: true

      - name: Test Coverage Fuzzer
        working-directory: src/vibeec
        run: zig test coverage_fuzzer.zig
        continue-on-error: true

      - name: Test Superoptimizer
        working-directory: src/vibeec
        run: zig test superoptimizer.zig
        continue-on-error: true

      - name: Test ML Templates
        working-directory: src/vibeec
        run: zig test ml_templates.zig
        continue-on-error: true

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check for secrets
        run: |
          echo "Scanning for leaked secrets..."
          if grep -rE "(sk-[a-zA-Z0-9]{20,}|AKIA[A-Z0-9]{16}|ghp_[a-zA-Z0-9]{36}|[0-9]{10}:[A-Za-z0-9_-]{35})" --include="*.md" --include="*.json" --include="*.yaml" . 2>/dev/null | grep -v ".gitleaks"; then
            echo "Potential secrets found!"
            exit 1
          fi
          echo "No secrets detected"
