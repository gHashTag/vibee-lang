name: Spec-Driven Development Check

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  check-manual-code:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Check for manual .gleam files
        run: |
          echo "üîç Checking for manual code..."
          
          # Find all .gleam files (except FFI and generated)
          manual_files=$(find honeycomb gleam/src vibeec/src -name "*.gleam" -type f 2>/dev/null | grep -v "_ffi.erl" | grep -v "generated/" || true)
          
          if [ -n "$manual_files" ]; then
            echo ""
            echo "‚ùå ERROR: Manual .gleam files detected!"
            echo ""
            echo "The following files are manually written:"
            echo "$manual_files" | while read file; do
              echo "  - $file"
            done
            echo ""
            echo "üö® SPEC-DRIVEN DEVELOPMENT VIOLATION!"
            echo ""
            echo "All code MUST be generated from spec.yml files."
            echo "See SPEC_DRIVEN_DEVELOPMENT_RULES.md for details."
            echo ""
            exit 1
          fi
          
          echo "‚úÖ All code is spec-driven!"
      
      - name: Check for spec.yml files
        run: |
          echo "üîç Checking for spec.yml files..."
          
          # Count spec files
          spec_count=$(find . -name "*_spec.yml" -o -name "spec.yml" | wc -l)
          
          echo "Found $spec_count spec files"
          
          if [ "$spec_count" -eq 0 ]; then
            echo "‚ö†Ô∏è  WARNING: No spec.yml files found!"
            echo "This might be okay for initial setup, but all code should eventually come from specs."
          else
            echo "‚úÖ Spec files found"
          fi
      
      - name: Verify generated code matches specs
        run: |
          echo "üîç Verifying generated code..."
          
          # This would regenerate code from specs and compare
          # For now, just check that generated/ directory exists
          
          if [ -d "vibeec/generated" ]; then
            echo "‚úÖ Generated code directory exists"
          else
            echo "‚ö†Ô∏è  No generated code directory found"
          fi

  check-documentation:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Check for required documentation
        run: |
          echo "üîç Checking documentation..."
          
          required_docs=(
            "SPEC_DRIVEN_DEVELOPMENT_RULES.md"
            "MANUAL_CODE_AUDIT.md"
            "SPEC_DRIVEN_RESEARCH.md"
          )
          
          missing_docs=()
          
          for doc in "${required_docs[@]}"; do
            if [ ! -f "$doc" ]; then
              missing_docs+=("$doc")
            fi
          done
          
          if [ ${#missing_docs[@]} -gt 0 ]; then
            echo "‚ùå Missing required documentation:"
            for doc in "${missing_docs[@]}"; do
              echo "  - $doc"
            done
            exit 1
          fi
          
          echo "‚úÖ All required documentation present"

  enforce-spec-driven:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Calculate manual code percentage
        run: |
          echo "üìä Calculating manual code percentage..."
          
          # Count total .gleam files
          total_files=$(find honeycomb gleam/src vibeec/src -name "*.gleam" -type f 2>/dev/null | wc -l)
          
          # Count manual files (excluding FFI and generated)
          manual_files=$(find honeycomb gleam/src vibeec/src -name "*.gleam" -type f 2>/dev/null | grep -v "_ffi.erl" | grep -v "generated/" | wc -l)
          
          # Count generated files
          generated_files=$(find . -path "*/generated/*.gleam" -type f 2>/dev/null | wc -l)
          
          echo "Total .gleam files: $total_files"
          echo "Manual files: $manual_files"
          echo "Generated files: $generated_files"
          
          if [ "$total_files" -gt 0 ]; then
            manual_percent=$((manual_files * 100 / total_files))
            generated_percent=$((generated_files * 100 / total_files))
            
            echo "Manual code: $manual_percent%"
            echo "Generated code: $generated_percent%"
            
            # Fail if more than 50% is manual code
            if [ "$manual_percent" -gt 50 ]; then
              echo ""
              echo "‚ùå ERROR: Too much manual code ($manual_percent%)!"
              echo ""
              echo "Target: 0% manual code"
              echo "Current: $manual_percent% manual code"
              echo ""
              echo "Please convert manual code to spec-driven:"
              echo "  1. Create spec.yml files"
              echo "  2. Generate code from specs"
              echo "  3. Delete manual files"
              echo ""
              exit 1
            fi
            
            echo "‚úÖ Manual code percentage acceptable ($manual_percent%)"
          fi
