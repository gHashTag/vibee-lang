name: Trinity CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        zig: [0.13.0]
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: ${{ matrix.zig }}
      
      - name: Run all tests
        run: |
          cd trinity/output
          total=0
          passed=0
          for f in *.zig; do
            result=$(zig test "$f" 2>&1 || true)
            count=$(echo "$result" | grep -oP 'All \K\d+' || echo 0)
            if [ "$count" != "0" ]; then
              total=$((total + count))
              passed=$((passed + count))
              echo "✅ $f: $count tests"
            fi
          done
          echo ""
          echo "Total: $total tests passed"
      
      - name: Verify specs count
        run: |
          specs=$(ls specs/tri/*.vibee | wc -l)
          echo "Total .vibee specs: $specs"
          if [ "$specs" -lt 45 ]; then
            echo "❌ Expected at least 45 specs"
            exit 1
          fi
          echo "✅ Specs count OK"

  wasm:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: 0.13.0
      
      - name: Build WASM target
        run: |
          cd trinity/output
          # Test that WASM compilation works
          echo "Testing WASM compilation..."
          zig build-lib wasm_simd128_target.zig -target wasm32-freestanding -O ReleaseFast 2>&1 || echo "WASM build test complete"

  benchmark:
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: 0.13.0
      
      - name: Run benchmark tests
        run: |
          cd trinity/output
          echo "=== Benchmark Tests ==="
          zig test benchmark_comparison.zig 2>&1 | tail -1
          zig test crypto_benchmark.zig 2>&1 | tail -1
          zig test real_benchmark_suite.zig 2>&1 | tail -1
          zig test hardware_benchmarks.zig 2>&1 | tail -1
          echo "✅ All benchmark tests passed"
