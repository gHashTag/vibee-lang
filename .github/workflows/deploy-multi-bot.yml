name: Deploy Multi-Bot

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'gleam/src/vibee/infra/partner/**'
      - 'gleam/src/vibee/apps/app_launcher.gleam'
      - 'gleam/fly.bot.toml'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Fly.io
        uses: superfly/flyctl-actions/setup-flyctl@master
        
      - name: Deploy to Fly.io
        run: |
          cd gleam
          flyctl deploy -c fly.bot.toml -a vibee-bot
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
          
      - name: Verify Deployment
        run: |
          sleep 10
          curl -f https://vibee-bot.fly.dev/health || exit 1
          
      - name: Check Multi-Bot Status
        run: |
          RESPONSE=$(curl -s https://vibee-bot.fly.dev/health)
          echo "Health check: $RESPONSE"
          
          if echo "$RESPONSE" | grep -q "vibee-multi-bot"; then
            echo "✅ Multi-bot mode active!"
          else
            echo "⚠️  Still in normal mode"
          fi
