name: Check Generated Code

on:
  pull_request:
    paths:
      - '**/*.gleam'
      - '**/*_spec.yml'
  push:
    branches:
      - main
    paths:
      - '**/*.gleam'

jobs:
  check-generated:
    name: Verify all code is generated from spec.yml
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check for hand-written .gleam files
        run: |
          echo "ğŸ” Checking for hand-written code..."
          echo "===================================="
          echo ""
          
          # ĞĞ°Ğ¹Ñ‚Ğ¸ Ğ²ÑĞµ .gleam Ñ„Ğ°Ğ¹Ğ»Ñ‹ (Ğ¸ÑĞºĞ»ÑÑ‡Ğ°Ñ build/, FFI)
          files=$(find . -name "*.gleam" -type f \
            -not -path "./build/*" \
            -not -path "./.migration_backup*" \
            -not -name "*_ffi.erl")
          
          total=0
          errors=0
          
          for file in $files; do
            total=$((total + 1))
            
            # ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ Ğ¿ĞµÑ€Ğ²Ñ‹Ğµ 20 ÑÑ‚Ñ€Ğ¾Ğº
            header=$(head -n 20 "$file")
            
            if ! echo "$header" | grep -q "GENERATED FROM:"; then
              echo "âŒ ERROR: $file is not generated!"
              errors=$((errors + 1))
            fi
          done
          
          echo ""
          echo "Statistics:"
          echo "  Total files checked: $total"
          echo "  Hand-written files:  $errors"
          echo ""
          
          if [ $errors -gt 0 ]; then
            echo "âŒ FAILED: Found $errors hand-written files!"
            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "  All .gleam files must be generated from spec.yml"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            echo "Why this matters:"
            echo "  â€¢ Ensures consistency across codebase"
            echo "  â€¢ Guarantees 100% test coverage"
            echo "  â€¢ Prevents manual errors"
            echo "  â€¢ Maintains single source of truth"
            echo ""
            echo "How to fix:"
            echo "  1. Create <module>_spec.yml with your specification"
            echo "  2. Run: gleam run -m spec_generator -- <module>_spec.yml"
            echo "  3. Commit both spec.yml and generated .gleam file"
            echo ""
            echo "Learn more:"
            echo "  â€¢ WHY_CODEGEN.md"
            echo "  â€¢ SPEC_DRIVEN_DEVELOPMENT.md"
            echo ""
            exit 1
          fi
          
          echo "âœ… All files are generated!"
      
      - name: Check spec.yml exists for each .gleam file
        run: |
          echo ""
          echo "ğŸ” Checking spec.yml files..."
          echo "===================================="
          echo ""
          
          files=$(find . -name "*.gleam" -type f \
            -not -path "./build/*" \
            -not -path "./.migration_backup*" \
            -not -name "*_ffi.erl")
          
          errors=0
          
          for file in $files; do
            # Ğ˜Ğ·Ğ²Ğ»ĞµÑ‡ÑŒ spec Ñ„Ğ°Ğ¹Ğ» Ğ¸Ğ· Ğ¼Ğ°Ñ€ĞºĞµÑ€Ğ°
            spec_file=$(head -n 20 "$file" | grep "GENERATED FROM:" | sed 's/.*GENERATED FROM: //' | tr -d ' ' || echo "")
            
            if [ -n "$spec_file" ] && [ ! -f "$spec_file" ]; then
              echo "âŒ ERROR: Missing $spec_file for $file"
              errors=$((errors + 1))
            fi
          done
          
          if [ $errors -gt 0 ]; then
            echo ""
            echo "âŒ FAILED: Found $errors missing spec.yml files!"
            echo ""
            echo "Each generated .gleam file must have a corresponding spec.yml"
            exit 1
          fi
          
          echo "âœ… All spec.yml files exist!"
      
      - name: Setup Gleam
        uses: erlef/setup-beam@v1
        with:
          otp-version: "26.0"
          gleam-version: "1.0.0"
      
      - name: Verify files can be regenerated
        run: |
          echo ""
          echo "ğŸ”„ Verifying regeneration..."
          echo "===================================="
          echo ""
          
          # Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹
          mkdir -p /tmp/backup
          cp -r . /tmp/backup/
          
          # ĞĞ°Ğ¹Ñ‚Ğ¸ Ğ²ÑĞµ spec.yml Ñ„Ğ°Ğ¹Ğ»Ñ‹
          spec_files=$(find . -name "*_spec.yml" -type f -not -path "./.migration_backup*")
          
          if [ -z "$spec_files" ]; then
            echo "âš ï¸  No spec.yml files found, skipping regeneration check"
            exit 0
          fi
          
          # Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ ÑĞ³ĞµĞ½ĞµÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹
          find . -name "*.gleam" -type f \
            -not -path "./build/*" \
            -not -path "./.migration_backup*" \
            -not -name "*_ffi.erl" \
            -delete
          
          # Ğ ĞµĞ³ĞµĞ½ĞµÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¹ spec Ñ„Ğ°Ğ¹Ğ»
          for spec in $spec_files; do
            echo "Regenerating from $spec..."
            gleam run -m spec_generator -- "$spec" || {
              echo "âš ï¸  Failed to regenerate from $spec"
              echo "   This might be expected if generator is not yet implemented"
            }
          done
          
          # Ğ¡Ñ€Ğ°Ğ²Ğ½Ğ¸Ñ‚ÑŒ (ĞµÑĞ»Ğ¸ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚)
          if command -v diff &> /dev/null; then
            if ! diff -r . /tmp/backup/ --exclude=build --exclude=.git; then
              echo "âš ï¸  WARNING: Regenerated files differ from committed!"
              echo "   This might indicate manual modifications"
              echo "   Or generator version mismatch"
            else
              echo "âœ… Files match regenerated versions!"
            fi
          fi
      
      - name: Summary
        if: always()
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  Generated Code Check Complete"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "This check ensures:"
          echo "  âœ“ All .gleam files are generated from spec.yml"
          echo "  âœ“ All spec.yml files exist"
          echo "  âœ“ Files can be regenerated"
          echo ""
          echo "Learn more: WHY_CODEGEN.md"
          echo ""
