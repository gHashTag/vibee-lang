name: Codegen Guard

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  guard:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Check for custom generators
      run: |
        echo "üõ°Ô∏è Checking for custom generators..."
        
        # Check for generate.sh files
        if find . -name "generate.sh" -not -path "./node_modules/*" -not -path "./.git/*" | grep -q .; then
          echo "‚ùå ERROR: Custom generate.sh files found!"
          echo ""
          echo "Found files:"
          find . -name "generate.sh" -not -path "./node_modules/*" -not -path "./.git/*"
          echo ""
          echo "Use: make generate PLUGIN=path/to/plugin"
          exit 1
        fi
        
        echo "‚úÖ No custom generators found"
    
    - name: Check for .gleam in honeycomb
      run: |
        echo "üõ°Ô∏è Checking for .gleam files in honeycomb..."
        
        # Allow only specific .gleam files
        ALLOWED="spec_generator|spec_validator|dedup_checker"
        
        if find honeycomb -name "*.gleam" -not -path "*/test/*" | grep -v -E "$ALLOWED" | grep -q .; then
          echo "‚ö†Ô∏è  WARNING: .gleam files found in honeycomb/"
          echo ""
          echo "Should be .vibee files!"
          echo ""
          find honeycomb -name "*.gleam" -not -path "*/test/*" | grep -v -E "$ALLOWED" | head -10
          # Don't fail, just warn
        fi
        
        echo "‚úÖ Check complete"
    
    - name: Verify Makefile exists
      run: |
        if [ ! -f Makefile ]; then
          echo "‚ùå ERROR: Makefile not found!"
          exit 1
        fi
        echo "‚úÖ Makefile exists"
    
    - name: Verify codegen guard exists
      run: |
        if [ ! -f .codegen-guard ]; then
          echo "‚ùå ERROR: .codegen-guard not found!"
          exit 1
        fi
        echo "‚úÖ Codegen guard exists"
