name: Auto-Documentation

on:
  push:
    branches: [main]
    paths:
      - 'gleam/src/vibee_lang/**/*.gleam'
      - 'docs-vibee/**/*.md'
      - 'scripts/generate-*.sh'
  pull_request:
    branches: [main]
    paths:
      - 'gleam/src/vibee_lang/**/*.gleam'
      - 'docs-vibee/**/*.md'

jobs:
  generate-docs:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Gleam
        uses: erlef/setup-beam@v1
        with:
          otp-version: '27.1'
          gleam-version: '1.6.1'
      
      - name: Generate VIBEE Lang API docs
        run: |
          bash scripts/generate-vibee-lang-docs.sh
      
      - name: Generate API reference from code
        run: |
          bash scripts/generate-api-reference.sh
      
      - name: Build Gleam docs
        working-directory: gleam
        run: |
          gleam docs build
      
      - name: Upload documentation artifacts
        uses: actions/upload-artifact@v4
        with:
          name: documentation
          path: |
            vibee_lang/docs/
            docs-vibee/reference/api/
            gleam/build/dev/docs/
      
      - name: Check documentation coverage
        run: |
          TOTAL=$(find gleam/src/vibee_lang -name "*.gleam" | wc -l)
          DOCUMENTED=$(find gleam/src/vibee_lang -name "*.gleam" -exec grep -l "^////" {} \; | wc -l)
          COVERAGE=$((DOCUMENTED * 100 / TOTAL))
          echo "Documentation coverage: $COVERAGE%"
          
          if [ $COVERAGE -lt 50 ]; then
            echo "‚ö†Ô∏è Warning: Documentation coverage is below 50%"
          fi
      
      - name: Deploy to GitHub Pages
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./vibee_lang/docs
          destination_dir: vibee-lang
      
      - name: Comment PR with docs preview
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const stats = fs.readFileSync('vibee_lang/docs/api/statistics.md', 'utf8');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## üìö Documentation Preview\n\n${stats}\n\n[View full documentation](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`
            });
