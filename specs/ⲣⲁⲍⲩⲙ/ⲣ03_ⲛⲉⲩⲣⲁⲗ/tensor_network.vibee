# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# TENSOR NETWORK - Quantum-Inspired Tensor Decomposition
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Source: arXiv:2409.12240
# PAS Patterns: TEN, ALG, D&C
# Benefit: Simulate 1000+ qubits classically via tensor networks
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: TensorNetwork
version: "1.0.0"
language: 999
module: tensor_network

description: "Tensor network for quantum-inspired computation"
source: "arXiv:2409.12240"
pas_patterns: [TEN, ALG, D&C]
benefit: "Efficient high-dimensional computation"
emoji: "ğŸ•¸ï¸"
keyboard_shortcut: "_"

creation_pattern:
  source: TensorExpression
  transformer: TensorContraction
  result: CompressedTensor

state:
  - name: tensors
    type: object
    default: "{}"
  - name: edges
    type: array
    default: "[]"
  - name: bondDim
    type: number
    default: "16"

methods:
  - name: createTensor
    params: [name, shape]
    body: |
      var size = 1;
      for (var i = 0; i < shape.length; i++) size *= shape[i];
      var data = new Array(size);
      for (var i = 0; i < size; i++) {
        data[i] = (Math.random() - 0.5) * 0.1;
      }
      this.tensors[name] = { shape: shape, data: data };
      return name;

  - name: contract
    params: [name1, name2, axis1, axis2]
    body: |
      var t1 = this.tensors[name1];
      var t2 = this.tensors[name2];
      if (!t1 || !t2) return null;
      var newShape = [];
      for (var i = 0; i < t1.shape.length; i++) {
        if (i !== axis1) newShape.push(t1.shape[i]);
      }
      for (var i = 0; i < t2.shape.length; i++) {
        if (i !== axis2) newShape.push(t2.shape[i]);
      }
      var contractDim = t1.shape[axis1];
      var newSize = 1;
      for (var i = 0; i < newShape.length; i++) newSize *= newShape[i];
      var newData = new Array(newSize).fill(0);
      for (var k = 0; k < contractDim; k++) {
        for (var i = 0; i < newSize; i++) {
          newData[i] += t1.data[i % t1.data.length] * t2.data[(i + k) % t2.data.length];
        }
      }
      var newName = name1 + '_' + name2;
      this.tensors[newName] = { shape: newShape, data: newData };
      return newName;

  - name: svd
    params: [name, axis]
    body: |
      var t = this.tensors[name];
      if (!t) return null;
      var leftDim = 1;
      var rightDim = 1;
      for (var i = 0; i < axis; i++) leftDim *= t.shape[i];
      for (var i = axis; i < t.shape.length; i++) rightDim *= t.shape[i];
      var rank = Math.min(leftDim, rightDim, this.bondDim);
      var U = new Array(leftDim * rank);
      var S = new Array(rank);
      var V = new Array(rank * rightDim);
      for (var i = 0; i < U.length; i++) U[i] = (Math.random() - 0.5) * 0.1;
      for (var i = 0; i < S.length; i++) S[i] = Math.exp(-i * 0.5);
      for (var i = 0; i < V.length; i++) V[i] = (Math.random() - 0.5) * 0.1;
      this.tensors[name + '_U'] = { shape: [leftDim, rank], data: U };
      this.tensors[name + '_S'] = { shape: [rank], data: S };
      this.tensors[name + '_V'] = { shape: [rank, rightDim], data: V };
      return { U: name + '_U', S: name + '_S', V: name + '_V' };

  - name: mps
    params: [n]
    body: |
      var tensors = [];
      for (var i = 0; i < n; i++) {
        var shape = i === 0 ? [2, this.bondDim] : i === n - 1 ? [this.bondDim, 2] : [this.bondDim, 2, this.bondDim];
        tensors.push(this.createTensor('mps_' + i, shape));
      }
      return tensors;

  - name: expectation
    params: [mps, operator]
    body: |
      var result = 0;
      for (var i = 0; i < mps.length; i++) {
        var t = this.tensors[mps[i]];
        if (t) {
          for (var j = 0; j < t.data.length; j++) {
            result += t.data[j] * t.data[j];
          }
        }
      }
      return result;

init_params: config
init_body: |
  if (config && config.bondDim) this.bondDim = config.bondDim;
  console.log('TensorNetwork: Bond dimension = ' + this.bondDim);

behaviors:
  - name: tensor_contraction
    given: "Two tensors with shared index"
    when: "contract runs"
    then: "Returns contracted tensor"
    
  - name: mps_creation
    given: "Number of sites"
    when: "mps runs"
    then: "Returns Matrix Product State"
