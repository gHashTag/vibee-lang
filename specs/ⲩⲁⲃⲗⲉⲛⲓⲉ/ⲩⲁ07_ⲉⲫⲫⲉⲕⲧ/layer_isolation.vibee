# ═══════════════════════════════════════════════════════════════════════════════
# LAYER ISOLATION - Strict 3-Layer Architecture
# Изоляция слоёв по паттерну 999 (3 слоя)
# ═══════════════════════════════════════════════════════════════════════════════

name: layer_isolation
version: "1.0.0"
language: 999
module: architecture

# ═══════════════════════════════════════════════════════════════════════════════
# 3-LAYER ARCHITECTURE (999 Pattern)
# ═══════════════════════════════════════════════════════════════════════════════

layers:
  # ═══════════════════════════════════════════════════════════════════════════
  # LAYER 1: SPECIFICATION (.vibee)
  # Декларативный слой - ЧТО делать
  # ═══════════════════════════════════════════════════════════════════════════
  - id: 1
    name: "Specification Layer"
    extension: ".vibee"
    location: "specs/"
    purpose: "Декларативное описание поведения"
    allowed:
      - YAML syntax
      - Creation patterns
      - Behaviors (BDD)
      - Test cases
    forbidden:
      - Implementation code
      - Direct rendering
      - DOM manipulation
      - Side effects
    dependencies: []  # Не зависит ни от чего
    
  # ═══════════════════════════════════════════════════════════════════════════
  # LAYER 2: GENERATED CODE (.999)
  # Императивный слой - КАК делать
  # ═══════════════════════════════════════════════════════════════════════════
  - id: 2
    name: "Generated Layer"
    extension: ".999"
    location: "generated/"
    purpose: "Сгенерированная реализация"
    allowed:
      - Pure functions
      - Data structures
      - Algorithms
      - State machines
    forbidden:
      - Direct DOM access
      - Global window
      - document.*
      - External HTTP
    dependencies: [1]  # Зависит только от specs
    
  # ═══════════════════════════════════════════════════════════════════════════
  # LAYER 3: RUNTIME (runtime.html)
  # Исполняемый слой - ГДЕ выполнять
  # ═══════════════════════════════════════════════════════════════════════════
  - id: 3
    name: "Runtime Layer"
    extension: ".html"
    location: "runtime/"
    purpose: "Единая точка входа и исполнения"
    allowed:
      - Canvas setup
      - Event binding
      - Module loading
      - Render loop
    forbidden:
      - Business logic
      - Algorithm implementation
      - Data processing
    dependencies: [2]  # Зависит только от generated
    immutable: true

# ═══════════════════════════════════════════════════════════════════════════════
# ISOLATION RULES
# ═══════════════════════════════════════════════════════════════════════════════

isolation_rules:
  # Rule 1: Однонаправленный поток данных
  - name: "Unidirectional Flow"
    pattern: "specs → generated → runtime"
    violation: "Обратные зависимости запрещены"
    
  # Rule 2: Чистые функции в Layer 2
  - name: "Pure Functions"
    layer: 2
    rule: "Функции не должны иметь side effects"
    check: "No global state mutation"
    
  # Rule 3: Immutable Runtime
  - name: "Immutable Runtime"
    layer: 3
    rule: "runtime.html никогда не изменяется"
    check: "Hash verification"
    
  # Rule 4: No Cross-Layer Imports
  - name: "No Cross-Layer"
    rule: "Layer N может импортировать только Layer N-1"
    violation: "specs не может импортировать generated"

# ═══════════════════════════════════════════════════════════════════════════════
# MODULE SYSTEM FOR .999
# ═══════════════════════════════════════════════════════════════════════════════

module_system:
  # Каждый .999 файл - изолированный модуль
  structure:
    header: |
      // @module: module_name
      // @version: 1.0.0
      // @depends: [dep1, dep2]
      // @exports: [func1, func2]
      
    body: |
      (function(exports, require) {
        'use strict';
        // Module code here
        exports.func1 = function() {};
      })(MODULE.exports, MODULE.require);
      
  namespaces:
    - V999      # Core VIBEE
    - PAS       # Predictive Algorithmic Systematics
    - UI        # User Interface
    - NET       # Neural Networks
    - GEN       # Generation
    - SEN       # Sensors

# ═══════════════════════════════════════════════════════════════════════════════
# LAYER GUARDIAN
# ═══════════════════════════════════════════════════════════════════════════════

guardian:
  checks:
    - name: "No .js files"
      pattern: "**/*.js"
      action: "BLOCK"
      
    - name: "No .html except runtime"
      pattern: "**/*.html"
      except: "runtime/runtime.html"
      action: "BLOCK"
      
    - name: "No DOM in .999"
      pattern: "document\\.|window\\."
      location: "generated/*.999"
      action: "WARN"
      
    - name: "No implementation in .vibee"
      pattern: "function\\s+\\w+\\s*\\("
      location: "specs/*.vibee"
      action: "BLOCK"

# ═══════════════════════════════════════════════════════════════════════════════
# INTERFACE CONTRACTS
# ═══════════════════════════════════════════════════════════════════════════════

contracts:
  # Layer 1 → Layer 2 Contract
  spec_to_generated:
    input: "Specification AST"
    output: "Generated .999 module"
    validation: "Type checking"
    
  # Layer 2 → Layer 3 Contract
  generated_to_runtime:
    input: "Module exports"
    output: "Render functions"
    validation: "Interface matching"

# ═══════════════════════════════════════════════════════════════════════════════
# CREATION PATTERN
# ═══════════════════════════════════════════════════════════════════════════════

creation_pattern:
  source: "File path and content"
  transformer: "LayerGuardian"
  result: "Validation result (pass/violation)"

# ═══════════════════════════════════════════════════════════════════════════════
# BEHAVIORS
# ═══════════════════════════════════════════════════════════════════════════════

behaviors:
  - name: layer_violation_detection
    given: "Code change in any layer"
    when: "Guardian scans the change"
    then: "Violations are reported and blocked"
    test_cases:
      - name: detect_forbidden_html
        input:
          path: "test.html"
          content: "<html></html>"
        expected:
          violation: "ForbiddenFileType"
          
      - name: allow_runtime_html
        input:
          path: "runtime/runtime.html"
          content: "<html></html>"
        expected:
          violation: null
    
  - name: module_isolation
    given: "Module A in Layer 2"
    when: "Module A tries to access Module B internals"
    then: "Access is denied, only exports visible"
    test_cases:
      - name: valid_import
        input:
          source: "module.999"
          target: "spec.vibee"
        expected:
          allowed: true
          
      - name: invalid_upward_import
        input:
          source: "spec.vibee"
          target: "module.999"
        expected:
          allowed: false
          violation_type: "upward_dependency"
    
  - name: runtime_immutability
    given: "Attempt to modify runtime.html"
    when: "Guardian detects modification"
    then: "Change is rejected with error"
    test_cases:
      - name: block_runtime_modification
        input:
          path: "runtime/runtime.html"
          action: "modify"
        expected:
          blocked: true
          error: "RuntimeModificationAttempt"
          
  - name: content_validation
    given: "File content in specific layer"
    when: "Guardian validates content"
    then: "Forbidden patterns are detected"
    test_cases:
      - name: spec_no_implementation
        input:
          path: "test.vibee"
          content: "function doSomething() {}"
        expected:
          violation: true
          pattern: "function "
          
      - name: generated_no_dom
        input:
          path: "module.999"
          content: "document.getElementById('test')"
        expected:
          violation: true
          pattern: "document.getElementById"
          
      - name: valid_spec_content
        input:
          path: "test.vibee"
          content: "name: test\nbehaviors:\n  - given: input"
        expected:
          violation: false

# ═══════════════════════════════════════════════════════════════════════════════
# IMPLEMENTATION REFERENCE
# ═══════════════════════════════════════════════════════════════════════════════

implementation:
  guardian: "src/ⲥⲩⲛⲧⲁⲝⲓⲥ/guardian.zig"
  module_system: "src/ⲥⲩⲛⲧⲁⲝⲓⲥ/module999.zig"
  
  functions:
    - name: "checkFileCreation"
      purpose: "Validate file type against forbidden extensions"
      
    - name: "validateLayerContent"
      purpose: "Check content for forbidden patterns per layer"
      
    - name: "checkLayerDependency"
      purpose: "Ensure dependencies flow downward only"
      
    - name: "enforceLayerIsolation"
      purpose: "Full validation of imports against layer rules"
      
    - name: "fullGuard"
      purpose: "Complete protection: type + content + deps + integrity"
