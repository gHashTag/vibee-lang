# PAS Architecture Guard - Защита от нарушения архитектуры
# Предотвращает галлюцинации и антипаттерны
# Автор: Дмитрий Васильев

name: pas_architecture_guard
version: "1.0.0"
language: 999
module: architecture_guard

creation_pattern:
  source: FileOperation
  transformer: ArchitectureValidator
  result: ValidationResult

# ═══════════════════════════════════════════════════════════════════════════
# КРИТИЧЕСКИЕ ПРАВИЛА АРХИТЕКТУРЫ VIBEE
# ═══════════════════════════════════════════════════════════════════════════

architecture_rules:
  # Правило 1: Трёхуровневая архитектура
  three_layer_architecture:
    description: "Все изменения должны следовать паттерну .vibee → .999 → runtime.html"
    layers:
      - level: 1
        name: specification
        extension: ".vibee"
        location: "specs/"
        purpose: "Спецификации и поведения"
        
      - level: 2
        name: generated_code
        extension: ".999"
        location: "999/"
        purpose: "Сгенерированный код"
        
      - level: 3
        name: runtime
        file: "runtime/runtime.html"
        purpose: "Единый интерпретатор"

  # Правило 2: Запрещённые файлы
  forbidden_files:
    description: "Эти типы файлов ЗАПРЕЩЕНО создавать напрямую"
    extensions:
      - extension: ".html"
        exception: "runtime/runtime.html"
        reason: "Только один HTML файл в проекте"
        
      - extension: ".css"
        exception: null
        reason: "Стили интегрируются в runtime.html"
        
      - extension: ".js"
        exception: null
        reason: "JavaScript интегрируется в runtime.html"
        
      - extension: ".ts"
        exception: null
        reason: "TypeScript - legacy технология"
        
      - extension: ".jsx"
        exception: null
        reason: "React JSX - legacy технология"
        
      - extension: ".tsx"
        exception: null
        reason: "React TSX - legacy технология"

  # Правило 3: Разрешённые операции
  allowed_operations:
    - operation: "create_spec"
      target: "specs/*.vibee"
      description: "Создание спецификаций"
      
    - operation: "generate_999"
      target: "999/**/*.999"
      description: "Генерация кода из спецификаций"
      
    - operation: "update_runtime"
      target: "runtime/runtime.html"
      description: "Обновление единого runtime"
      
    - operation: "update_compiler"
      target: "src/vibeec/*.zig"
      description: "Обновление компилятора (исключение)"

# ═══════════════════════════════════════════════════════════════════════════
# PAS ПАТТЕРНЫ ДЛЯ ЗАЩИТЫ
# ═══════════════════════════════════════════════════════════════════════════

patterns:
  - name: hallucination_prevention
    symbol: HAL-PREV
    confidence: 0.95
    description: "Предотвращение галлюцинаций AI агентов"
    techniques:
      - name: extension_check
        description: "Проверка расширения файла перед созданием"
        
      - name: path_validation
        description: "Валидация пути файла"
        
      - name: architecture_enforcement
        description: "Принудительное соблюдение архитектуры"

  - name: dogfooding_enforcement
    symbol: DOG-ENF
    confidence: 0.90
    description: "Принудительное использование собственных инструментов"
    rules:
      - "Новый функционал → .vibee спецификация"
      - "Код → генерация из .vibee"
      - "UI → интеграция в runtime.html"

  - name: layer_isolation
    symbol: LAY-ISO
    confidence: 0.92
    description: "Изоляция слоёв архитектуры"
    violations:
      - "Прямое создание .zig вместо .vibee"
      - "Прямое создание .html вместо runtime.html"
      - "Обход генератора кода"

# ═══════════════════════════════════════════════════════════════════════════
# ВАЛИДАТОР АРХИТЕКТУРЫ
# ═══════════════════════════════════════════════════════════════════════════

components:
  - name: ArchitectureValidator
    description: "Валидатор соблюдения архитектуры"
    methods:
      - name: validateFileCreation
        params:
          - path: string
          - content: string
        returns: ValidationResult
        logic: |
          1. Извлечь расширение файла
          2. Проверить в списке запрещённых
          3. Если запрещено - вернуть ошибку
          4. Проверить путь соответствует слою
          5. Вернуть результат

      - name: suggestCorrectApproach
        params:
          - forbidden_path: string
        returns: Suggestion
        logic: |
          1. Определить намерение по пути
          2. Предложить правильный .vibee файл
          3. Показать пример спецификации

      - name: enforceArchitecture
        params:
          - operation: FileOperation
        returns: EnforcementResult
        logic: |
          1. Валидировать операцию
          2. Если нарушение - заблокировать
          3. Предложить альтернативу
          4. Логировать попытку

# ═══════════════════════════════════════════════════════════════════════════
# ТИПЫ ДАННЫХ
# ═══════════════════════════════════════════════════════════════════════════

types:
  - name: ValidationResult
    fields:
      - is_valid: bool
      - violation_type: optional[ViolationType]
      - message: string
      - suggestion: optional[Suggestion]

  - name: ViolationType
    enum:
      - forbidden_extension
      - wrong_layer
      - bypass_generator
      - direct_code_creation
      - hallucination

  - name: Suggestion
    fields:
      - correct_path: string
      - correct_approach: string
      - example_spec: string

  - name: FileOperation
    fields:
      - operation_type: OperationType
      - path: string
      - content: optional[string]

  - name: OperationType
    enum:
      - create
      - modify
      - delete

  - name: EnforcementResult
    fields:
      - allowed: bool
      - reason: string
      - alternative: optional[string]

# ═══════════════════════════════════════════════════════════════════════════
# ПОВЕДЕНИЯ (ТЕСТЫ)
# ═══════════════════════════════════════════════════════════════════════════

behaviors:
  - name: block_direct_zig_creation
    given: Попытка создать .zig файл напрямую
    when: AI агент пытается создать src/feature.zig
    then: Операция блокируется с предложением создать .vibee
    test_cases:
      - name: block_zig
        input:
          path: "src/ⲥⲩⲛⲧⲁⲝⲓⲥ/new_feature.zig"
        expected:
          is_valid: false
          violation_type: "direct_code_creation"
          suggestion_contains: ".vibee"

  - name: block_direct_html_creation
    given: Попытка создать .html файл
    when: AI агент пытается создать новый HTML
    then: Операция блокируется
    test_cases:
      - name: block_html
        input:
          path: "src/new_page.html"
        expected:
          is_valid: false
          violation_type: "forbidden_extension"

  - name: allow_vibee_creation
    given: Создание .vibee спецификации
    when: AI агент создаёт specs/feature.vibee
    then: Операция разрешена
    test_cases:
      - name: allow_vibee
        input:
          path: "specs/new_feature.vibee"
        expected:
          is_valid: true

  - name: allow_999_generation
    given: Генерация .999 кода
    when: Компилятор генерирует 999/module.999
    then: Операция разрешена
    test_cases:
      - name: allow_999
        input:
          path: "999/ⲕⲉⲣⲛⲉⲗ/new_module.999"
        expected:
          is_valid: true

  - name: allow_runtime_update
    given: Обновление runtime.html
    when: Интеграция в единый runtime
    then: Операция разрешена
    test_cases:
      - name: allow_runtime
        input:
          path: "runtime/runtime.html"
        expected:
          is_valid: true

  - name: detect_hallucination
    given: AI агент галлюцинирует
    when: Создаётся файл нарушающий архитектуру
    then: Галлюцинация детектируется и блокируется
    test_cases:
      - name: detect_js_hallucination
        input:
          path: "src/utils.js"
        expected:
          is_valid: false
          violation_type: "hallucination"
          message_contains: "legacy"

# ═══════════════════════════════════════════════════════════════════════════
# СООБЩЕНИЯ ОБ ОШИБКАХ
# ═══════════════════════════════════════════════════════════════════════════

error_messages:
  forbidden_extension: |
    ⛔ ОШИБКА АРХИТЕКТУРЫ: Запрещённое расширение файла
    
    Файл: {path}
    Расширение: {extension}
    
    VIBEE использует трёхуровневую архитектуру:
    .vibee (спецификация) → .999 (код) → runtime.html (интерпретатор)
    
    Правильный подход:
    1. Создайте specs/{name}.vibee
    2. Сгенерируйте код: vibeec gen specs/{name}.vibee
    3. Интегрируйте в runtime/runtime.html

  direct_code_creation: |
    ⛔ АНТИПАТТЕРН: Прямое создание кода
    
    Вы пытаетесь создать код напрямую: {path}
    
    Это нарушает принцип dogfooding!
    
    Правильный подход:
    1. Опишите функционал в .vibee спецификации
    2. Используйте компилятор для генерации
    
    Пример спецификации:
    ```yaml
    name: {suggested_name}
    version: "1.0.0"
    language: 999
    
    creation_pattern:
      source: Input
      transformer: Process
      result: Output
    ```

  hallucination: |
    ⚠️ ДЕТЕКТИРОВАНА ГАЛЛЮЦИНАЦИЯ
    
    AI агент попытался создать: {path}
    
    Это legacy технология, запрещённая в VIBEE.
    
    VIBEE не использует:
    ❌ .html (кроме runtime/runtime.html)
    ❌ .css
    ❌ .js / .ts
    ❌ .jsx / .tsx
    
    VIBEE использует:
    ✅ .vibee - спецификации
    ✅ .999 - сгенерированный код
    ✅ runtime.html - единый интерпретатор

# ═══════════════════════════════════════════════════════════════════════════
# ИНТЕГРАЦИЯ С AI АГЕНТАМИ
# ═══════════════════════════════════════════════════════════════════════════

ai_agent_rules:
  pre_file_creation:
    - "Проверить расширение файла"
    - "Проверить путь файла"
    - "Если нарушение - остановиться"
    - "Предложить правильный подход"

  mandatory_workflow:
    - step: 1
      action: "Создать .vibee спецификацию"
      location: "specs/"
      
    - step: 2
      action: "Сгенерировать .999 код"
      command: "vibeec gen specs/{name}.vibee"
      
    - step: 3
      action: "Интегрировать в runtime"
      location: "runtime/runtime.html"

  forbidden_actions:
    - "Создание .zig файлов для нового функционала"
    - "Создание .html файлов"
    - "Создание .css файлов"
    - "Создание .js/.ts файлов"
    - "Обход компилятора vibeec"

# ═══════════════════════════════════════════════════════════════════════════
# МЕТАДАННЫЕ
# ═══════════════════════════════════════════════════════════════════════════

metadata:
  author: "Дмитрий Васильев"
  date: "2026-01-14"
  purpose: "Защита архитектуры VIBEE от нарушений"
  confidence: 0.95
  prevents:
    - "Галлюцинации AI агентов"
    - "Нарушение трёхуровневой архитектуры"
    - "Создание legacy файлов"
    - "Обход dogfooding принципа"
