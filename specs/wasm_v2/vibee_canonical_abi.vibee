# ═══════════════════════════════════════════════════════════════════════════════
# VIBEE Canonical ABI - Component Model ABI
# ═══════════════════════════════════════════════════════════════════════════════
# φ² + 1/φ² = 3 | PHOENIX = 999
# PAS Patterns: ALG (flattening), PRE (ABI caching)
# ═══════════════════════════════════════════════════════════════════════════════

name: vibee_canonical_abi
version: "1.1.0"
language: zig
module: vibee_canonical_abi

constants:
  PHI: 1.6180339887498948482
  PHOENIX: 999
  MAX_FLAT_PARAMS: 16
  MAX_FLAT_RESULTS: 1

types:
  CanonOptions:
    fields:
      memory: Int
      realloc: Int
      post_return: Int
      string_encoding: String

  FlattenedFunc:
    fields:
      params: List<String>
      results: List<String>
      uses_memory: Bool

  LiftedValue:
    fields:
      type_index: Int
      flat_values: List<Int>

  LoweredValue:
    fields:
      type_index: Int
      core_values: List<Int>

  StringEncoding:
    fields:
      kind: String
      tagged: Bool

  ListRepr:
    fields:
      ptr: Int
      len: Int

  RecordRepr:
    fields:
      fields: List<Int>

behaviors:
  - name: flatten_func_type
    given: FuncType
    when: Flatten for ABI
    then: FlattenedFunc

  - name: lift_flat_values
    given: Flat values and type
    when: Lift to interface
    then: LiftedValue

  - name: lower_value
    given: Value and type
    when: Lower to core
    then: LoweredValue

  - name: load_string
    given: Memory, ptr, len
    when: Load string
    then: String value

  - name: store_string
    given: Memory, string
    when: Store string
    then: Ptr and len

  - name: load_list
    given: Memory, ptr, len, elem_type
    when: Load list
    then: List value

  - name: store_list
    given: Memory, list, elem_type
    when: Store list
    then: Ptr and len

  - name: realloc
    given: Old ptr, old size, align, new size
    when: Reallocate
    then: New ptr

  - name: canon_lift
    given: Core func and options
    when: Create lifted func
    then: Component func

  - name: canon_lower
    given: Component func and options
    when: Create lowered func
    then: Core func

  - name: canon_resource_new
    given: Resource type and rep
    when: Create resource
    then: Resource handle

  - name: canon_resource_drop
    given: Resource handle
    when: Drop resource
    then: Resource freed

  - name: post_return
    given: Flat results
    when: Cleanup after return
    then: Cleanup done

test_cases:
  - name: test_flatten_simple
    input:
      params: ["i32", "i32"]
      results: ["i32"]
    expected:
      flat_params: 2
      flat_results: 1

  - name: test_load_string
    input:
      ptr: 0
      len: 5
    expected:
      string_valid: true
