# ═══════════════════════════════════════════════════════════════════════════════
# VIBEE Atomics - Atomic Operations
# ═══════════════════════════════════════════════════════════════════════════════
# φ² + 1/φ² = 3 | PHOENIX = 999
# PAS Patterns: ALG (lock-free), PRE (memory ordering)
# ═══════════════════════════════════════════════════════════════════════════════

name: vibee_atomics
version: "1.1.0"
language: zig
module: vibee_atomics

constants:
  PHI: 1.6180339887498948482
  PHOENIX: 999
  MEMORY_ORDER_RELAXED: 0
  MEMORY_ORDER_ACQUIRE: 1
  MEMORY_ORDER_RELEASE: 2
  MEMORY_ORDER_SEQ_CST: 3

types:
  AtomicI32:
    fields:
      value: Int
      address: Int

  AtomicI64:
    fields:
      value: Int
      address: Int

  AtomicFlag:
    fields:
      flag: Bool
      address: Int

  WaitResult:
    fields:
      woken: Bool
      timed_out: Bool

  Mutex:
    fields:
      locked: Bool
      owner: Int
      waiters: Int

  Semaphore:
    fields:
      count: Int
      max_count: Int
      waiters: Int

behaviors:
  - name: atomic_load_i32
    given: Address
    when: Load atomically
    then: i32 value

  - name: atomic_store_i32
    given: Address and value
    when: Store atomically
    then: Value stored

  - name: atomic_add_i32
    given: Address and delta
    when: Add atomically
    then: Previous value

  - name: atomic_sub_i32
    given: Address and delta
    when: Subtract atomically
    then: Previous value

  - name: atomic_and_i32
    given: Address and mask
    when: AND atomically
    then: Previous value

  - name: atomic_or_i32
    given: Address and mask
    when: OR atomically
    then: Previous value

  - name: atomic_xor_i32
    given: Address and mask
    when: XOR atomically
    then: Previous value

  - name: atomic_cmpxchg_i32
    given: Address, expected, desired
    when: Compare and swap
    then: Success and old value

  - name: atomic_wait_i32
    given: Address, expected, timeout
    when: Wait for change
    then: WaitResult

  - name: atomic_notify
    given: Address and count
    when: Wake waiters
    then: Woken count

  - name: mutex_lock
    given: Mutex
    when: Acquire lock
    then: Lock held

  - name: mutex_unlock
    given: Mutex
    when: Release lock
    then: Lock released

  - name: semaphore_wait
    given: Semaphore
    when: Decrement
    then: Acquired

  - name: semaphore_signal
    given: Semaphore
    when: Increment
    then: Released

test_cases:
  - name: test_atomic_add
    input:
      initial: 10
      delta: 5
    expected:
      previous: 10
      new: 15

  - name: test_cmpxchg_success
    input:
      current: 10
      expected: 10
      desired: 20
    expected:
      success: true
