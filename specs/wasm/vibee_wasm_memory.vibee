# ═══════════════════════════════════════════════════════════════════════════════
# VIBEE WASM Memory - Linear Memory Management
# ═══════════════════════════════════════════════════════════════════════════════
# φ² + 1/φ² = 3 | PHOENIX = 999
#
# Linear memory management for WASM modules
# Handles allocation, deallocation, and memory views
# ═══════════════════════════════════════════════════════════════════════════════

name: vibee_wasm_memory
version: "1.1.0"
language: zig
module: vibee_wasm_memory

constants:
  PHI: 1.6180339887498948482
  PHOENIX: 999
  PAGE_SIZE: 65536
  MAX_PAGES: 65536
  ALIGNMENT: 8

types:
  LinearMemory:
    fields:
      base: Int
      size: Int
      pages: Int
      max_pages: Int
      flags: Int

  MemoryView:
    fields:
      offset: Int
      length: Int
      readonly: Bool

  Allocation:
    fields:
      address: Int
      size: Int
      alignment: Int
      tag: String

  MemoryPool:
    fields:
      name: String
      start: Int
      end: Int
      free_list: List<Int>
      used: Int

  MemoryStats:
    fields:
      total_pages: Int
      used_bytes: Int
      free_bytes: Int
      allocations: Int
      peak_usage: Int

  MemoryRegion:
    fields:
      start: Int
      end: Int
      protection: String
      name: String

behaviors:
  - name: create_memory
    given: Initial pages and max pages
    when: Allocate linear memory
    then: LinearMemory created

  - name: grow_memory
    given: Memory and delta pages
    when: Expand memory
    then: Previous size or -1 on failure

  - name: read_bytes
    given: Memory, offset, length
    when: Read from memory
    then: Byte slice returned

  - name: write_bytes
    given: Memory, offset, data
    when: Write to memory
    then: Bytes written

  - name: read_i32
    given: Memory and offset
    when: Read 32-bit integer
    then: i32 value

  - name: write_i32
    given: Memory, offset, value
    when: Write 32-bit integer
    then: Value stored

  - name: read_i64
    given: Memory and offset
    when: Read 64-bit integer
    then: i64 value

  - name: write_i64
    given: Memory, offset, value
    when: Write 64-bit integer
    then: Value stored

  - name: read_f32
    given: Memory and offset
    when: Read 32-bit float
    then: f32 value

  - name: read_f64
    given: Memory and offset
    when: Read 64-bit float
    then: f64 value

  - name: alloc
    given: Pool, size, alignment
    when: Allocate from pool
    then: Address or null

  - name: free
    given: Pool and address
    when: Return to pool
    then: Memory freed

  - name: create_view
    given: Memory, offset, length
    when: Create typed view
    then: MemoryView returned

  - name: copy_within
    given: Memory, dest, src, length
    when: Copy memory region
    then: Bytes copied

  - name: fill
    given: Memory, offset, value, length
    when: Fill memory region
    then: Region filled

  - name: get_stats
    given: Memory
    when: Query usage stats
    then: MemoryStats returned

test_cases:
  - name: test_create_memory
    input:
      initial_pages: 1
      max_pages: 256
    expected:
      size: 65536

  - name: test_read_write_i32
    input:
      offset: 0
      value: 42
    expected:
      read_value: 42

  - name: test_grow_memory
    input:
      current: 1
      delta: 2
    expected:
      previous: 1
      new_size: 196608
