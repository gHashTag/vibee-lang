# ═══════════════════════════════════════════════════════════════════════════════
# VIBEE WASM Interop - Host Function Calls
# ═══════════════════════════════════════════════════════════════════════════════
# φ² + 1/φ² = 3 | PHOENIX = 999
#
# Bidirectional communication between WASM and host
# Handles function imports, callbacks, and data marshaling
# ═══════════════════════════════════════════════════════════════════════════════

name: vibee_wasm_interop
version: "1.1.0"
language: zig
module: vibee_wasm_interop

constants:
  PHI: 1.6180339887498948482
  PHOENIX: 999
  MAX_ARGS: 16
  STRING_BUFFER_SIZE: 65536

types:
  HostFunction:
    fields:
      module: String
      name: String
      signature: String
      callback_id: Int

  ImportObject:
    fields:
      modules: Map<String, String>
      functions: List<HostFunction>
      memory: String
      table: String

  CallContext:
    fields:
      instance: String
      function: String
      args: List<Int>
      result: Int

  StringMarshaler:
    fields:
      encoding: String
      null_terminated: Bool
      max_length: Int

  ArrayMarshaler:
    fields:
      element_type: String
      element_size: Int
      length_prefix: Bool

  StructMarshaler:
    fields:
      name: String
      fields: List<String>
      offsets: List<Int>
      size: Int

  CallbackRegistry:
    fields:
      callbacks: Map<Int, String>
      next_id: Int

behaviors:
  - name: create_import_object
    given: Module definitions
    when: Build import object
    then: ImportObject ready

  - name: register_host_function
    given: Module, name, callback
    when: Add host function
    then: Function registered

  - name: call_host
    given: Function name and args
    when: WASM calls host
    then: Result returned to WASM

  - name: call_wasm
    given: Export name and args
    when: Host calls WASM
    then: Result returned to host

  - name: marshal_string_to_wasm
    given: String and memory
    when: Copy string to WASM
    then: Pointer returned

  - name: marshal_string_from_wasm
    given: Pointer and length
    when: Read string from WASM
    then: Host string returned

  - name: marshal_array_to_wasm
    given: Array and memory
    when: Copy array to WASM
    then: Pointer returned

  - name: marshal_array_from_wasm
    given: Pointer, length, type
    when: Read array from WASM
    then: Host array returned

  - name: marshal_struct_to_wasm
    given: Struct and marshaler
    when: Serialize to WASM
    then: Pointer returned

  - name: marshal_struct_from_wasm
    given: Pointer and marshaler
    when: Deserialize from WASM
    then: Host struct returned

  - name: register_callback
    given: Callback function
    when: Create WASM-callable
    then: Callback ID returned

  - name: invoke_callback
    given: Callback ID and args
    when: WASM triggers callback
    then: Callback executed

  - name: free_callback
    given: Callback ID
    when: Unregister callback
    then: Callback removed

  - name: get_memory_view
    given: Instance
    when: Access shared memory
    then: Memory view returned

test_cases:
  - name: test_register_host_function
    input:
      module: "env"
      name: "log"
    expected:
      registered: true

  - name: test_marshal_string
    input:
      string: "Hello WASM"
    expected:
      length: 10

  - name: test_call_wasm
    input:
      function: "add"
      args: [1, 2]
    expected:
      result: 3
