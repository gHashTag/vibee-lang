# ═══════════════════════════════════════════════════════════════════════════════
# VIBEE ANTIPATTERNS LIBRARY
# ═══════════════════════════════════════════════════════════════════════════════
# Библиотека антипаттернов для обнаружения и предотвращения нарушений
# архитектуры VIBEE
#
# СВЯЩЕННАЯ ФОРМУЛА: V = n × 3^k × π^m × φ^p × e^q
# ЗОЛОТАЯ ИДЕНТИЧНОСТЬ: φ² + 1/φ² = 3
#
# ПРАВИЛО: .vibee → .999 → runtime.html
# НАРУШЕНИЕ: Прямое создание .zig/.js/.ts/.html/.css файлов
# ═══════════════════════════════════════════════════════════════════════════════

name: antipatterns_library
version: "1.0.0"
language: zig
module: antipatterns

sacred_formula:
  expression: "V = n × 3^k × π^m × φ^p × e^q"
  golden_identity: "φ² + 1/φ² = 3"
  self_evolution: enabled

creation_pattern:
  source: CodeArtifact
  transformer: AntipatternDetector
  result: ValidationResult

# ═══════════════════════════════════════════════════════════════════════════════
# FORBIDDEN FILE TYPES
# ═══════════════════════════════════════════════════════════════════════════════

forbidden_extensions:
  - extension: ".html"
    exception: "runtime/runtime.html"
    reason: "Legacy web technology"
    severity: CRITICAL
    
  - extension: ".css"
    exception: null
    reason: "Legacy styling"
    severity: CRITICAL
    
  - extension: ".js"
    exception: null
    reason: "Legacy scripting"
    severity: CRITICAL
    
  - extension: ".ts"
    exception: null
    reason: "Legacy TypeScript"
    severity: CRITICAL
    
  - extension: ".jsx"
    exception: null
    reason: "Legacy React"
    severity: CRITICAL
    
  - extension: ".tsx"
    exception: null
    reason: "Legacy React+TS"
    severity: CRITICAL

# ═══════════════════════════════════════════════════════════════════════════════
# ALLOWED FILE TYPES
# ═══════════════════════════════════════════════════════════════════════════════

allowed_extensions:
  - extension: ".vibee"
    purpose: "Specification files"
    required: true
    
  - extension: ".999"
    purpose: "Generated code"
    generated_from: ".vibee"
    
  - extension: ".zig"
    purpose: "Compiler implementation"
    location: "src/vibeec/"
    must_have_spec: true
    
  - extension: ".md"
    purpose: "Documentation"
    
  - extension: ".json"
    purpose: "Configuration"
    
  - extension: ".yaml"
    purpose: "Configuration"

# ═══════════════════════════════════════════════════════════════════════════════
# ANTIPATTERNS
# ═══════════════════════════════════════════════════════════════════════════════

antipatterns:
  - id: AP001
    name: "Direct Implementation"
    description: "Создание .zig файла без .vibee спецификации"
    severity: CRITICAL
    detection:
      pattern: "*.zig without corresponding *.vibee"
      locations: ["src/", "generated/"]
    fix: "Сначала создайте .vibee спецификацию, затем сгенерируйте код"
    example_bad: |
      // Создание src/vibeec/jit_trinity.zig напрямую
      // БЕЗ specs/jit_compiler_trinity.vibee
    example_good: |
      // 1. Создать specs/jit_compiler_trinity.vibee
      // 2. Запустить vibeec gen specs/jit_compiler_trinity.vibee
      // 3. Получить generated/jit_trinity.zig
      
  - id: AP002
    name: "Legacy Web Files"
    description: "Создание .html/.css/.js файлов вне runtime.html"
    severity: CRITICAL
    detection:
      pattern: "*.html|*.css|*.js|*.ts|*.jsx|*.tsx"
      exclude: "runtime/runtime.html"
    fix: "Интегрируйте функциональность в runtime/runtime.html"
    example_bad: |
      // Создание pages/dashboard.html
      // Создание styles/main.css
      // Создание scripts/app.js
    example_good: |
      // Добавить новую вкладку в runtime/runtime.html
      // Добавить стили inline в <style>
      // Добавить логику в <script>
      
  - id: AP003
    name: "Missing Creation Pattern"
    description: ".vibee файл без creation_pattern"
    severity: HIGH
    detection:
      pattern: ".vibee without creation_pattern section"
    fix: "Добавьте creation_pattern: source → transformer → result"
    example_bad: |
      name: my_feature
      version: "1.0.0"
      # Нет creation_pattern!
    example_good: |
      name: my_feature
      version: "1.0.0"
      creation_pattern:
        source: InputType
        transformer: MyTransformation
        result: OutputType
        
  - id: AP004
    name: "Missing Sacred Formula"
    description: ".vibee файл без священной формулы"
    severity: MEDIUM
    detection:
      pattern: ".vibee without sacred_formula section"
    fix: "Добавьте sacred_formula с golden_identity"
    example_bad: |
      name: my_feature
      # Нет sacred_formula!
    example_good: |
      name: my_feature
      sacred_formula:
        expression: "V = n × 3^k × π^m × φ^p × e^q"
        golden_identity: "φ² + 1/φ² = 3"
        
  - id: AP005
    name: "Missing Test Cases"
    description: "Behavior без test_cases"
    severity: HIGH
    detection:
      pattern: "behavior without test_cases"
    fix: "Добавьте test_cases для каждого behavior"
    example_bad: |
      behaviors:
        - name: my_behavior
          given: "..."
          when: "..."
          then: "..."
          # Нет test_cases!
    example_good: |
      behaviors:
        - name: my_behavior
          given: "..."
          when: "..."
          then: "..."
          test_cases:
            - name: test_1
              input: {...}
              expected: {...}
              
  - id: AP006
    name: "Hardcoded Magic Numbers"
    description: "Использование чисел вместо священных констант"
    severity: MEDIUM
    detection:
      pattern: "1.618|2.618|0.382|0.0382|0.0618"
      context: "without PHI/PHI2/INV_PHI2/MU/CHI reference"
    fix: "Используйте священные константы"
    example_bad: |
      const scale = 1.618;  // Magic number!
    example_good: |
      const scale = PHI;  // Священная константа
      
  - id: AP007
    name: "Missing Self-Evolution"
    description: "Компонент без поддержки самоэволюции"
    severity: LOW
    detection:
      pattern: ".vibee without self_evolution: enabled"
    fix: "Добавьте self_evolution: enabled"
    
  - id: AP008
    name: "Non-Trinity Architecture"
    description: "Архитектура не следует принципу TRINITY (3 слоя)"
    severity: MEDIUM
    detection:
      pattern: "architecture with != 3 main layers"
    fix: "Реорганизуйте в 3 слоя (МАТРЁШКА)"
    example_good: |
      architecture:
        layers:
          outer: "VM TRINITY"
          middle: "JIT ENGINE"
          inner: "LLM CORE"
          
  - id: AP009
    name: "Missing PAS Analysis"
    description: "Алгоритм без PAS предсказания"
    severity: LOW
    detection:
      pattern: "algorithm without pas_predictions"
    fix: "Добавьте pas_predictions с паттернами"
    
  - id: AP010
    name: "Simulated Data"
    description: "Использование Math.sin/random для фейковых данных"
    severity: HIGH
    detection:
      pattern: "Math.sin|Math.random in visualization without real data source"
    fix: "Подключите реальные данные или явно пометьте как симуляцию"

# ═══════════════════════════════════════════════════════════════════════════════
# STRUCTURES
# ═══════════════════════════════════════════════════════════════════════════════

structures:
  Antipattern:
    fields:
      - name: id
        type: "[]const u8"
      - name: name
        type: "[]const u8"
      - name: description
        type: "[]const u8"
      - name: severity
        type: Severity
      - name: detection_pattern
        type: "[]const u8"
      - name: fix
        type: "[]const u8"
        
  Severity:
    type: enum
    values:
      - CRITICAL
      - HIGH
      - MEDIUM
      - LOW
      
  ValidationResult:
    fields:
      - name: file_path
        type: "[]const u8"
      - name: violations
        type: "[]Violation"
      - name: is_valid
        type: bool
        
  Violation:
    fields:
      - name: antipattern
        type: Antipattern
      - name: line
        type: usize
      - name: column
        type: usize
      - name: context
        type: "[]const u8"
        
  AntipatternDetector:
    fields:
      - name: antipatterns
        type: "[]Antipattern"
      - name: violations_found
        type: u64
      - name: files_scanned
        type: u64
    methods:
      - name: scan
        params: [path: "[]const u8"]
        returns: ValidationResult
      - name: scanDirectory
        params: [dir: "[]const u8"]
        returns: "[]ValidationResult"
      - name: getStats
        returns: DetectorStats
        
  DetectorStats:
    fields:
      - name: files_scanned
        type: u64
      - name: violations_found
        type: u64
      - name: critical_count
        type: u64
      - name: high_count
        type: u64
      - name: medium_count
        type: u64
      - name: low_count
        type: u64

# ═══════════════════════════════════════════════════════════════════════════════
# BEHAVIORS
# ═══════════════════════════════════════════════════════════════════════════════

behaviors:
  - name: detect_direct_implementation
    description: "Обнаружить .zig без .vibee"
    given: ".zig файл в src/"
    when: "scan вызван"
    then: "Violation если нет соответствующего .vibee"
    test_cases:
      - name: missing_spec
        input:
          file: "src/vibeec/new_feature.zig"
          specs_dir: "specs/"
        expected:
          violation: true
          antipattern_id: "AP001"
          
  - name: detect_legacy_files
    description: "Обнаружить legacy web файлы"
    given: "Файл с запрещённым расширением"
    when: "scan вызван"
    then: "Violation если не runtime.html"
    test_cases:
      - name: forbidden_html
        input:
          file: "pages/index.html"
        expected:
          violation: true
          antipattern_id: "AP002"
          
      - name: allowed_runtime
        input:
          file: "runtime/runtime.html"
        expected:
          violation: false
          
  - name: detect_missing_creation_pattern
    description: "Обнаружить .vibee без creation_pattern"
    given: ".vibee файл"
    when: "scan вызван"
    then: "Violation если нет creation_pattern"
    test_cases:
      - name: missing_pattern
        input:
          content: "name: test\nversion: '1.0.0'"
        expected:
          violation: true
          antipattern_id: "AP003"

# ═══════════════════════════════════════════════════════════════════════════════
# GIT HOOKS INTEGRATION
# ═══════════════════════════════════════════════════════════════════════════════

git_hooks:
  pre_commit:
    enabled: true
    actions:
      - scan_staged_files
      - block_if_critical_violations
      - warn_if_high_violations
    blocked_extensions:
      - ".html"
      - ".css"
      - ".js"
      - ".ts"
      - ".jsx"
      - ".tsx"
    exceptions:
      - "runtime/runtime.html"

# ═══════════════════════════════════════════════════════════════════════════════
# CODEGEN
# ═══════════════════════════════════════════════════════════════════════════════

codegen:
  target: zig
  output: "generated/antipatterns.zig"
  
test_generation:
  enabled: true
  coverage_target: 95
