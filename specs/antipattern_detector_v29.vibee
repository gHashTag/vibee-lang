# ═══════════════════════════════════════════════════════════════════════════════
# ANTIPATTERN DETECTOR v29 - REAL CODE ANALYSIS
# ═══════════════════════════════════════════════════════════════════════════════
# v28: Extension checking only
# v29: Real code analysis, complexity detection, smell detection
# ═══════════════════════════════════════════════════════════════════════════════

name: antipattern_detector_v29
version: "29.0.0"
language: zig
module: antipattern_detector

sacred_constants:
  phi: 1.618033988749895
  max_complexity: 10
  max_function_lines: 50

creation_pattern:
  source: SourceCode
  transformer: AntipatternAnalyzer
  result: ViolationReport

# ═══════════════════════════════════════════════════════════════════════════════
# REAL CODE ANALYSIS
# ═══════════════════════════════════════════════════════════════════════════════

code_smells:
  long_function:
    threshold: 50
    description: "Function exceeds 50 lines"
    severity: MEDIUM
    
  deep_nesting:
    threshold: 4
    description: "Nesting depth exceeds 4 levels"
    severity: HIGH
    
  high_complexity:
    threshold: 10
    description: "Cyclomatic complexity exceeds 10"
    severity: HIGH
    
  magic_numbers:
    description: "Unexplained numeric literals"
    severity: LOW
    
  duplicate_code:
    threshold: 10
    description: "Duplicate code blocks > 10 lines"
    severity: MEDIUM

structures:
  CodeMetrics:
    fields:
      - name: lines
        type: usize
      - name: nesting_depth
        type: usize
      - name: cyclomatic_complexity
        type: usize
      - name: magic_number_count
        type: usize
    methods:
      - name: analyze
        params: ["source: []const u8"]
        returns: void
        
  ComplexityAnalyzer:
    fields:
      - name: current_depth
        type: usize
      - name: max_depth
        type: usize
      - name: branch_count
        type: usize
    methods:
      - name: analyzeFunction
        params: ["source: []const u8"]
        returns: usize
      - name: countBranches
        params: ["source: []const u8"]
        returns: usize
        
  DuplicateDetector:
    fields:
      - name: hashes
        type: "std.AutoHashMap(u64, usize)"
      - name: duplicates
        type: "[]Duplicate"
    methods:
      - name: findDuplicates
        params: ["source: []const u8", "min_lines: usize"]
        returns: "[]Duplicate"
        
  Duplicate:
    fields:
      - name: line1
        type: usize
      - name: line2
        type: usize
      - name: length
        type: usize
        
  RealViolation:
    fields:
      - name: kind
        type: ViolationKind
      - name: line
        type: usize
      - name: column
        type: usize
      - name: severity
        type: Severity
      - name: message
        type: "[128]u8"
      - name: suggestion
        type: "[128]u8"
        
  ViolationKind:
    type: enum
    values:
      - LONG_FUNCTION
      - DEEP_NESTING
      - HIGH_COMPLEXITY
      - MAGIC_NUMBER
      - DUPLICATE_CODE
      - FORBIDDEN_FILE
      
  CodeAnalyzer:
    fields:
      - name: metrics
        type: CodeMetrics
      - name: complexity
        type: ComplexityAnalyzer
      - name: duplicates
        type: DuplicateDetector
    methods:
      - name: analyze
        params: ["source: []const u8"]
        returns: "[]RealViolation"
      - name: getMetrics
        returns: CodeMetrics

behaviors:
  - name: detect_long_function
    given: "Function with 60 lines"
    when: "analyze called"
    then: "LONG_FUNCTION violation reported"
    test_cases:
      - name: long_fn
        input:
          lines: 60
        expected:
          violation: "LONG_FUNCTION"
          
  - name: detect_deep_nesting
    given: "Code with 5 levels of nesting"
    when: "analyze called"
    then: "DEEP_NESTING violation reported"
    test_cases:
      - name: deep_nest
        input:
          depth: 5
        expected:
          violation: "DEEP_NESTING"
          
  - name: calculate_complexity
    given: "Function with 3 if statements and 2 loops"
    when: "analyzeFunction called"
    then: "Cyclomatic complexity = 6"
    test_cases:
      - name: complexity_calc
        input:
          ifs: 3
          loops: 2
        expected:
          complexity: 6

codegen:
  targets:
    - format: zig
      output: "generated/antipattern_detector_v29.zig"
