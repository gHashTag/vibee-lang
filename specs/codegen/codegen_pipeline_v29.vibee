# ═══════════════════════════════════════════════════════════════════════════════
# CODEGEN PIPELINE v29 - UNIVERSAL CODE GENERATION FROM .vibee
# ═══════════════════════════════════════════════════════════════════════════════
# PRINCIPLE: .vibee is the SINGLE SOURCE OF TRUTH
# All code in .zig/.rs/.ts/.go/.py is GENERATED, never hand-written
# φ² + 1/φ² = 3.0 ✅ | 33 = 3 × 11 ✅ | 999 = 3³ × 37 ✅
# ═══════════════════════════════════════════════════════════════════════════════

name: codegen_pipeline_v29
version: "29.0.0"
language: zig
module: codegen_pipeline

sacred_constants:
  phi: 1.618033988749895
  golden_identity: 3.0
  trinity_prime: 33
  phoenix_generations: 999

creation_pattern:
  source: VibeeSpecification
  transformer: UniversalCodeGenerator
  result: MultiLanguageCode

# ═══════════════════════════════════════════════════════════════════════════════
# CORE PRINCIPLE: SPEC-FIRST DEVELOPMENT
# ═══════════════════════════════════════════════════════════════════════════════

principles:
  - name: single_source_of_truth
    description: ".vibee is the ONLY place where logic is defined"
    enforcement: "Antipattern detector scans for orphan code"
    
  - name: no_hand_written_logic
    description: "All .zig/.rs/.ts code is generated from .vibee"
    enforcement: "Pre-commit hook blocks manual edits to generated/"
    
  - name: spec_implementation_parity
    description: "Every .vibee construct has exactly one implementation"
    enforcement: "Detector compares spec AST with generated code"

# ═══════════════════════════════════════════════════════════════════════════════
# TARGET LANGUAGES
# ═══════════════════════════════════════════════════════════════════════════════

targets:
  zig:
    extension: ".zig"
    output_dir: "generated/"
    features:
      - comptime
      - simd
      - manual_memory
    template: "templates/zig.template"
    
  rust:
    extension: ".rs"
    output_dir: "generated/rust/"
    features:
      - ownership
      - traits
      - macros
    template: "templates/rust.template"
    
  typescript:
    extension: ".ts"
    output_dir: "generated/ts/"
    features:
      - types
      - async
      - decorators
    template: "templates/typescript.template"
    
  go:
    extension: ".go"
    output_dir: "generated/go/"
    features:
      - goroutines
      - interfaces
      - channels
    template: "templates/go.template"
    
  python:
    extension: ".py"
    output_dir: "generated/python/"
    features:
      - type_hints
      - dataclasses
      - async
    template: "templates/python.template"
    
  code_999:
    extension: ".999"
    output_dir: "generated/999/"
    features:
      - sacred_bytecode
      - trinity_opcodes
      - phoenix_runtime
    template: "templates/999.template"

# ═══════════════════════════════════════════════════════════════════════════════
# GENERATION PIPELINE
# ═══════════════════════════════════════════════════════════════════════════════

pipeline:
  stages:
    - name: parse
      input: ".vibee file"
      output: "AST"
      description: "Parse .vibee specification into AST"
      
    - name: validate
      input: "AST"
      output: "Validated AST"
      description: "Validate sacred constants, behaviors, test cases"
      
    - name: transform
      input: "Validated AST"
      output: "IR"
      description: "Transform to intermediate representation"
      
    - name: optimize
      input: "IR"
      output: "Optimized IR"
      description: "Apply PAS patterns for optimization"
      
    - name: generate
      input: "Optimized IR"
      output: "Target code"
      description: "Generate code for each target language"
      
    - name: verify
      input: "Target code"
      output: "Verified code"
      description: "Verify generated code matches spec"

# ═══════════════════════════════════════════════════════════════════════════════
# STRUCTURES
# ═══════════════════════════════════════════════════════════════════════════════

structures:
  VibeeSpec:
    fields:
      - name: name
        type: "[]const u8"
      - name: version
        type: "[]const u8"
      - name: module
        type: "[]const u8"
      - name: sacred_constants
        type: SacredConstants
      - name: creation_pattern
        type: CreationPattern
      - name: behaviors
        type: "[]Behavior"
      - name: structures
        type: "[]Structure"
        
  SacredConstants:
    fields:
      - name: phi
        type: f64
        default: 1.618033988749895
      - name: golden_identity
        type: f64
        default: 3.0
      - name: trinity_prime
        type: u32
        default: 33
      - name: phoenix_generations
        type: u32
        default: 999
        
  CreationPattern:
    fields:
      - name: source
        type: "[]const u8"
      - name: transformer
        type: "[]const u8"
      - name: result
        type: "[]const u8"
        
  Behavior:
    fields:
      - name: name
        type: "[]const u8"
      - name: given
        type: "[]const u8"
      - name: when
        type: "[]const u8"
      - name: then
        type: "[]const u8"
      - name: test_cases
        type: "[]TestCase"
        
  TestCase:
    fields:
      - name: name
        type: "[]const u8"
      - name: input
        type: "[]const u8"
      - name: expected
        type: "[]const u8"
        
  GeneratedCode:
    fields:
      - name: target
        type: TargetLanguage
      - name: source_spec
        type: "[]const u8"
      - name: code
        type: "[]const u8"
      - name: tests
        type: "[]const u8"
      - name: hash
        type: u64
        
  TargetLanguage:
    type: enum
    values:
      - ZIG
      - RUST
      - TYPESCRIPT
      - GO
      - PYTHON
      - CODE_999
      
  GenerationResult:
    fields:
      - name: success
        type: bool
      - name: files_generated
        type: usize
      - name: tests_generated
        type: usize
      - name: errors
        type: "[]GenerationError"
        
  GenerationError:
    fields:
      - name: kind
        type: ErrorKind
      - name: message
        type: "[]const u8"
      - name: line
        type: usize
      - name: spec_file
        type: "[]const u8"
        
  ErrorKind:
    type: enum
    values:
      - PARSE_ERROR
      - VALIDATION_ERROR
      - SACRED_VIOLATION
      - SPEC_MISMATCH
      - ORPHAN_CODE

# ═══════════════════════════════════════════════════════════════════════════════
# CODE GENERATOR
# ═══════════════════════════════════════════════════════════════════════════════

code_generator:
  name: UniversalCodeGenerator
  methods:
    - name: parseSpec
      params: ["spec_path: []const u8"]
      returns: "?VibeeSpec"
      
    - name: validateSpec
      params: ["spec: VibeeSpec"]
      returns: "[]GenerationError"
      
    - name: generateZig
      params: ["spec: VibeeSpec"]
      returns: GeneratedCode
      
    - name: generateRust
      params: ["spec: VibeeSpec"]
      returns: GeneratedCode
      
    - name: generateTypeScript
      params: ["spec: VibeeSpec"]
      returns: GeneratedCode
      
    - name: generateGo
      params: ["spec: VibeeSpec"]
      returns: GeneratedCode
      
    - name: generatePython
      params: ["spec: VibeeSpec"]
      returns: GeneratedCode
      
    - name: generate999
      params: ["spec: VibeeSpec"]
      returns: GeneratedCode
      
    - name: generateAll
      params: ["spec: VibeeSpec"]
      returns: GenerationResult
      
    - name: verifySacred
      params: ["spec: VibeeSpec"]
      returns: bool
      description: "Verify φ² + 1/φ² = 3.0"

# ═══════════════════════════════════════════════════════════════════════════════
# BEHAVIORS
# ═══════════════════════════════════════════════════════════════════════════════

behaviors:
  - name: parse_vibee_spec
    given: "Valid .vibee file"
    when: "parseSpec called"
    then: "VibeeSpec returned with all fields populated"
    test_cases:
      - name: simple_spec
        input: "name: test\nversion: 1.0.0"
        expected: "VibeeSpec with name='test'"
        
  - name: validate_sacred_constants
    given: "VibeeSpec with sacred constants"
    when: "verifySacred called"
    then: "true if φ² + 1/φ² = 3.0"
    test_cases:
      - name: valid_sacred
        input: "phi: 1.618033988749895"
        expected: true
      - name: invalid_sacred
        input: "phi: 1.5"
        expected: false
        
  - name: generate_zig_code
    given: "Valid VibeeSpec"
    when: "generateZig called"
    then: "GeneratedCode with valid Zig syntax"
    test_cases:
      - name: simple_struct
        input: "structure with 2 fields"
        expected: "pub const Struct = struct { ... }"
        
  - name: generate_all_targets
    given: "Valid VibeeSpec"
    when: "generateAll called"
    then: "GenerationResult with 6 files"
    test_cases:
      - name: all_targets
        input: "complete spec"
        expected: "files_generated: 6"
        
  - name: detect_spec_mismatch
    given: "Generated code differs from spec"
    when: "validate called"
    then: "SPEC_MISMATCH error returned"
    test_cases:
      - name: missing_function
        input: "spec has fn, code missing"
        expected: "SPEC_MISMATCH"

# ═══════════════════════════════════════════════════════════════════════════════
# CODEGEN
# ═══════════════════════════════════════════════════════════════════════════════

codegen:
  targets:
    - format: zig
      output: "generated/codegen_pipeline_v29.zig"
    - format: "999"
      output: "generated/codegen_pipeline_v29.999"
