# task_executor_v999.vibee - Task Execution Engine
# KOSCHEI PATTERN - Main agent loop and task management
# φ² + 1/φ² = 3 | PHOENIX = 999

name: task_executor_v999
version: "999.0.0"
language: zig
module: task_executor_v999

types:
  Task:
    fields:
      task_id: Int
      intent: String
      start_url: String
      max_steps: Int
      timeout_ms: Int

  ExecutionState:
    fields:
      current_step: Int
      current_url: String
      current_title: String
      is_complete: Bool
      last_action: String

  StepRecord:
    fields:
      step: Int
      url: String
      observation: String
      thought: String
      action: String
      action_input: String
      result: String
      timestamp: Timestamp

  Trajectory:
    fields:
      task_id: Int
      steps: List<String>
      total_time_ms: Int

  ExecutionResult:
    fields:
      task_id: Int
      success: Bool
      score: Float
      answer: String
      trajectory: String
      execution_time_ms: Int
      steps_count: Int

  ExecutionError:
    fields:
      step: Int
      error_type: String
      message: String
      recoverable: Bool

behaviors:
  - name: init_executor
    given: Task definition
    when: Initialize execution context
    then: Return ExecutionState ready for loop

  - name: execute_step
    given: Current state and observation
    when: Think and execute one action
    then: Return updated ExecutionState

  - name: run_loop
    given: Task and initial state
    when: Execute steps until done or max
    then: Return ExecutionResult with trajectory

  - name: check_completion
    given: Current state and task intent
    when: Evaluate if goal is achieved
    then: Return Bool and confidence score

  - name: record_step
    given: Step details and result
    when: Add step to trajectory
    then: Return updated Trajectory

  - name: calculate_final_score
    given: Trajectory and task intent
    when: Evaluate overall task success
    then: Return Float score 0.0 to 1.0

  - name: handle_timeout
    given: Execution timeout reached
    when: Gracefully terminate execution
    then: Return partial result with timeout flag

  - name: handle_max_steps
    given: Max steps reached without completion
    when: Finalize with partial success
    then: Return result with 0.5 score

  - name: format_observation
    given: Page state and elements
    when: Create observation string for LLM
    then: Return formatted observation text

  - name: validate_action
    given: Parsed action from LLM
    when: Validate action is executable
    then: Return Bool and error if invalid

sacred_constants:
  phi: 1.618033988749895
  phi_squared_plus_inverse_squared: 3
  phoenix: 999
  default_max_steps: 8
  partial_success_score: 0.5
