# iGLA v4 Prefix Caching - 5x on Repeated Queries
# Paper: SGLang SOSP'24 "Efficiently Programming Large Language Models"
# φ² + 1/φ² = 3 | КОЩЕЙ БЕССМЕРТЕН

name: igla_v4_prefix_cache
version: "4.0.0"
language: zig
module: igla_v4_prefix_cache

types:
  RadixNode:
    fields:
      token_ids: String
      kv_cache_ref: String
      children: String
      ref_count: Int
      
  PrefixCache:
    fields:
      radix_tree: String
      total_cached_tokens: Int
      eviction_policy: String
      
  CacheHit:
    fields:
      matched_prefix_len: Int
      kv_cache: String
      remaining_tokens: String

behaviors:
  - name: radix_tree_insert
    given: "Token sequence, KV cache"
    when: "Insert into radix tree"
    then: "Prefix stored with shared nodes"
    
  - name: prefix_match
    given: "New token sequence"
    when: "Radix tree lookup"
    then: "Longest matching prefix found"
    
  - name: kv_cache_reuse
    given: "Matched prefix KV cache"
    when: "Continue generation"
    then: "Skip prefix computation, 5x speedup"
    
  - name: lru_eviction
    given: "Cache full, new entry"
    when: "LRU eviction triggered"
    then: "Least recently used prefix removed"
    
  - name: reference_counting
    given: "Multiple requests sharing prefix"
    when: "Request completes"
    then: "Ref count decremented, evict if zero"
