# VIBEE Specification: Bandwidth Estimation v1312
# YOLO XV - Production Ascension
# Based on: GCC (Google Congestion Control), REMB

name: browser_rtc_bandwidth
version: "1312"
language: zig
module: browser_rtc_bandwidth

types:
  BandwidthEstimator:
    fields:
      current_estimate: Int
      min_bitrate: Int
      max_bitrate: Int
      algorithm: String

  CongestionController:
    fields:
      state: String
      rtt: Int
      loss_rate: Float
      delay_gradient: Float

  TransportFeedback:
    fields:
      packets: List
      reference_time: Int
      feedback_count: Int

  PacketInfo:
    fields:
      sequence: Int
      size: Int
      send_time: Int
      recv_time: Int
      lost: Bool

  REMBMessage:
    fields:
      bitrate: Int
      ssrcs: List
      timestamp: Int

  BWEStats:
    fields:
      estimated_bitrate: Int
      rtt_ms: Int
      loss_percent: Float
      jitter_ms: Int

behaviors:
  - name: create_estimator
    given: "Configuration"
    when: "Creating bandwidth estimator"
    then: "Returns initialized estimator"

  - name: on_packet_sent
    given: "Estimator, packet info"
    when: "Packet sent"
    then: "Records send time"

  - name: on_transport_feedback
    given: "Estimator, feedback"
    when: "Receiving feedback"
    then: "Updates estimate"

  - name: compute_delay_gradient
    given: "Estimator, packet times"
    when: "Computing delay trend"
    then: "Returns gradient"

  - name: detect_overuse
    given: "Estimator, delay gradient"
    when: "Detecting congestion"
    then: "Returns overuse signal"

  - name: update_estimate
    given: "Estimator, signal"
    when: "Updating bandwidth"
    then: "Adjusts estimate"

  - name: apply_loss_based
    given: "Estimator, loss rate"
    when: "Applying loss-based control"
    then: "Reduces if high loss"

  - name: send_remb
    given: "Estimator"
    when: "Sending receiver estimate"
    then: "Creates REMB message"

  - name: handle_remb
    given: "Estimator, REMB"
    when: "Receiving REMB"
    then: "Caps sending rate"

  - name: get_target_bitrate
    given: "Estimator"
    when: "Getting target"
    then: "Returns current estimate"

creation_pattern:
  source: BandwidthEstimator
  transformer: CongestionControl
  result: AdaptiveBitrate

scientific_references:
  - author: "Holmer et al."
    title: "A Google Congestion Control Algorithm for Real-Time Communication"
    venue: "IETF Draft"
    year: 2016

test_cases:
  - name: test_initial_estimate
    input:
      start_bitrate: 300000
    expected:
      estimate: 300000

  - name: test_overuse_detection
    input:
      delay_increase: true
    expected:
      overuse_detected: true

  - name: test_bandwidth_increase
    input:
      no_congestion: true
      duration_ms: 5000
    expected:
      estimate_increased: true

  - name: test_bandwidth_decrease
    input:
      packet_loss: 10
    expected:
      estimate_decreased: true

  - name: test_remb_handling
    input:
      remb_bitrate: 500000
      current_estimate: 1000000
    expected:
      capped_to_remb: true

  - name: test_rtt_measurement
    input:
      packets: 100
    expected:
      rtt_computed: true

  - name: test_jitter_calculation
    input:
      packet_delays: [10, 15, 8, 20, 12]
    expected:
      jitter_computed: true

  - name: test_recovery_after_congestion
    input:
      congestion_cleared: true
    expected:
      estimate_recovers: true
