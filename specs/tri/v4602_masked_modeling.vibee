# v4602 - Masked Modeling
# ========================
# BERT, MAE, BEiT - маскирование как pretext task
# φ² + 1/φ² = 3 | PHOENIX = 999

name: masked_modeling
version: "4.6.2"
language: zig
module: masked_modeling

constants:
  PHI: 1.618033988749895
  MASK_RATIO: 0.75
  MASK_TOKEN_ID: 103
  PATCH_SIZE: 16

types:
  MaskingConfig:
    fields:
      mask_ratio: Float
      mask_strategy: String
      decoder_depth: Int
      
  MaskedInput:
    fields:
      visible_tokens: List
      mask_positions: List
      original: List
      
  MAEEncoder:
    fields:
      encoder: Object
      mask_token: List
      
  MAEDecoder:
    fields:
      decoder: Object
      pred_head: Object
      
  ReconstructionTarget:
    fields:
      target_type: String
      targets: List
      
  BERTMask:
    fields:
      input_ids: List
      masked_positions: List
      labels: List
      
  PatchMask:
    fields:
      visible_patches: List
      masked_patches: List
      patch_positions: List
      
  ReconstructionLoss:
    fields:
      loss: Float
      per_token_loss: List

behaviors:
  - name: random_masking
    given: Tokens и mask ratio
    when: Случайное маскирование
    then: Вернуть masked input
    
  - name: block_masking
    given: Patches и block size
    when: Блочное маскирование
    then: Вернуть masked patches
    
  - name: encode_visible
    given: Visible tokens и encoder
    when: Кодирование видимых
    then: Вернуть latent representations
    
  - name: decode_masked
    given: Latent и mask positions
    when: Декодирование masked
    then: Вернуть predictions
    
  - name: compute_reconstruction_loss
    given: Predictions и targets
    when: MSE/CrossEntropy loss
    then: Вернуть reconstruction loss
    
  - name: bert_mlm_loss
    given: Logits и labels
    when: MLM loss
    then: Вернуть cross-entropy loss
    
  - name: mae_pixel_loss
    given: Predicted и original patches
    when: Pixel reconstruction
    then: Вернуть normalized MSE
    
  - name: beit_tokenizer_loss
    given: Predictions и visual tokens
    when: Discrete token prediction
    then: Вернуть token loss
