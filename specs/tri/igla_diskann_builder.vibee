# iGLA DiskANN Builder
# Build DiskANN index on disk
# Scientific basis: Jayaram Subramanya et al. 2019
# φ² + 1/φ² = 3 | V = n × 3^k × π^m × φ^p

name: igla_diskann_builder
version: "1.0.0"
language: zig
module: igla_diskann_builder

sacred_constants:
  phi: 1.618033988749895
  trinity: 3.0
  phoenix: 999

scientific_references:
  - "Jayaram Subramanya et al. 2019: DiskANN"
  - "Simhadri et al. 2022: NeurIPS Challenge"

types:
  BuildConfig:
    fields:
      R: Int
      L: Int
      alpha: Float
      num_threads: Int
      memory_budget_gb: Float

  BuildPhase:
    fields:
      phase_name: String
      progress: Float
      elapsed_ms: Float

  ShardBuild:
    fields:
      shard_id: Int
      num_points: Int
      status: String

  MergeConfig:
    fields:
      num_shards: Int
      output_path: String

  BuildStats:
    fields:
      total_time_s: Float
      peak_memory_gb: Float
      disk_writes_gb: Float
      points_indexed: Int

  CheckpointData:
    fields:
      phase: String
      progress: Int
      timestamp: Int

behaviors:
  - name: build_memory_index
    given: "Vectors in memory"
    when: "Small dataset"
    then: "In-memory Vamana graph"

  - name: build_disk_index
    given: "Vectors on disk"
    when: "Large dataset"
    then: "Disk-based index"

  - name: build_sharded
    given: "Vectors, num_shards"
    when: "Parallel build"
    then: "Sharded index"

  - name: merge_shards
    given: "Shard indices"
    when: "Shard merging"
    then: "Unified index"

  - name: compute_pq_codes
    given: "Vectors, codebooks"
    when: "PQ encoding"
    then: "Compressed vectors"

  - name: write_index
    given: "Graph, vectors, path"
    when: "Persistence"
    then: "Index written to disk"

  - name: checkpoint
    given: "Build state"
    when: "Checkpointing"
    then: "Progress saved"

  - name: phi_shard_distribution
    given: "Total points"
    when: "Sacred sharding"
    then: "φ-ratio shard sizes"
