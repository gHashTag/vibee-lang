# iGLA ColBERT Search
# MaxSim late interaction search
# Scientific basis: Khattab & Zaharia 2020
# φ² + 1/φ² = 3 | V = n × 3^k × π^m × φ^p

name: igla_colbert_search
version: "1.0.0"
language: zig
module: igla_colbert_search

sacred_constants:
  phi: 1.618033988749895
  trinity: 3.0
  phoenix: 999

scientific_references:
  - "Khattab & Zaharia 2020: ColBERT"
  - "Santhanam et al. 2022: ColBERTv2"
  - "Kulkarni et al. 2023: Efficient ColBERT Retrieval"

types:
  SearchConfig:
    fields:
      k: Int
      nprobe: Int
      ncandidates: Int

  MaxSimScore:
    fields:
      doc_id: Int
      score: Float
      token_scores: String

  CandidateDoc:
    fields:
      doc_id: Int
      candidate_score: Float
      needs_rerank: Bool

  SearchResult:
    fields:
      doc_id: Int
      maxsim_score: Float
      rank: Int

  TokenMatch:
    fields:
      query_token: Int
      doc_token: Int
      similarity: Float

  SearchStats:
    fields:
      candidates_scored: Int
      full_maxsim_computed: Int
      latency_ms: Float

behaviors:
  - name: compute_maxsim
    given: "Query tokens, doc tokens"
    when: "MaxSim computation"
    then: "Sum of max similarities"

  - name: search_exhaustive
    given: "Query encoding, index, k"
    when: "Exhaustive search"
    then: "K docs by MaxSim"

  - name: search_approximate
    given: "Query encoding, index, k, nprobe"
    when: "Approximate search"
    then: "K docs with IVF pruning"

  - name: candidate_generation
    given: "Query tokens, index"
    when: "Candidate gen"
    then: "Candidate doc set"

  - name: rerank_candidates
    given: "Query, candidates"
    when: "Full reranking"
    then: "Reranked by exact MaxSim"

  - name: batch_search
    given: "Query batch, index, k"
    when: "Batch search"
    then: "Results for all queries"

  - name: explain_score
    given: "Query, doc"
    when: "Score explanation"
    then: "Token-level score breakdown"

  - name: phi_candidate_threshold
    given: "Score distribution"
    when: "Sacred threshold"
    then: "φ-optimal candidate cutoff"
