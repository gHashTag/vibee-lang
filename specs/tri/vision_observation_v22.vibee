# vision_observation_v22.vibee
# KOSCHEI CYCLE 22 - Visual Observation for Agent
# Screenshot + DOM = Rich Observation
# φ² + 1/φ² = 3 | PHOENIX = 999

name: vision_observation_v22
version: "22.0.0"
language: zig
module: vision_observation_v22

types:
  ObservationConfig:
    fields:
      include_screenshot: Bool
      include_dom: Bool
      include_accessibility: Bool
      max_elements: Int

  VisualObservation:
    fields:
      url: String
      title: String
      screenshot_base64: String
      dom_summary: String
      interactive_elements: String
      timestamp: Timestamp

  DOMSummary:
    fields:
      text_content: String
      links_count: Int
      buttons_count: Int
      inputs_count: Int
      headings: String

  InteractiveMap:
    fields:
      clickable: String
      typeable: String
      scrollable: String

  ObservationResult:
    fields:
      success: Bool
      observation: String
      capture_time_ms: Int
      elements_found: Int

  AgentContext:
    fields:
      task: String
      current_step: Int
      history: String
      observation: String

  FormattedObservation:
    fields:
      for_llm: String
      token_count: Int
      truncated: Bool

  VisualElement:
    fields:
      bounding_box: String
      element_type: String
      text: String
      selector: String

behaviors:
  - name: capture_observation
    given: ObservationConfig
    when: Capturing full page observation
    then: Return VisualObservation

  - name: get_dom_summary
    given: Page session
    when: Creating DOM summary
    then: Return DOMSummary

  - name: get_interactive_map
    given: Page session
    when: Mapping interactive elements
    then: Return InteractiveMap

  - name: format_for_agent
    given: VisualObservation
    when: Formatting for LLM agent
    then: Return FormattedObservation

  - name: build_context
    given: Task, step, history, observation
    when: Building agent context
    then: Return AgentContext

  - name: truncate_observation
    given: Observation and max tokens
    when: Truncating for context window
    then: Return truncated observation

  - name: extract_visual_elements
    given: Screenshot and DOM
    when: Extracting visual element info
    then: Return list of VisualElement

  - name: compare_observations
    given: Two observations
    when: Detecting page changes
    then: Return diff summary

  - name: highlight_element
    given: Selector
    when: Highlighting element in screenshot
    then: Return modified screenshot

  - name: create_observation_prompt
    given: Task and observation
    when: Creating prompt for LLM
    then: Return prompt string

test_cases:
  - name: full_observation
    input: example.com
    expected: observation contains title

  - name: format_for_llm
    input: observation
    expected: formatted string < 4000 tokens

  - name: interactive_map
    input: google.com
    expected: clickable elements found

sacred_constants:
  phi: 1.618033988749895
  phi_squared_plus_inverse_squared: 3
  phoenix: 999
