name: pipeline_backpressure_v561
version: "561.0.0"
language: zig
module: pipeline_backpressure_v561

types:
  BackpressureController:
    fields:
      controller_id: String
      strategy: String
      phi_threshold: Float
      propagation_delay_us: Int

  PressureSignal:
    fields:
      signal_id: String
      source_stage: String
      pressure_level: Float
      timestamp: Timestamp

  FlowControl:
    fields:
      control_id: String
      rate_limit: Float
      window_size: Int
      tokens_available: Int

  BackpressureMetrics:
    fields:
      signals_sent: Int
      signals_received: Int
      throttle_events: Int
      phi_stability: Float

  BackpressureConfig:
    fields:
      high_watermark: Float
      low_watermark: Float
      propagate_upstream: Bool
      phi_smoothing: Bool

behaviors:
  - name: create_controller
    given: Backpressure config
    when: Controller creation
    then: Initialize flow controller

  - name: monitor_pressure
    given: Buffer levels
    when: Monitoring active
    then: Calculate pressure

  - name: emit_signal
    given: High pressure
    when: Threshold exceeded
    then: Send backpressure signal

  - name: receive_signal
    given: Pressure signal
    when: Signal received
    then: Apply throttling

  - name: throttle_upstream
    given: Throttle rate
    When: Throttling needed
    then: Slow upstream stages

  - name: release_pressure
    given: Low pressure
    When: Recovery detected
    then: Remove throttling

  - name: token_bucket
    given: Rate limit
    When: Token bucket mode
    then: Control with tokens

  - name: sliding_window
    given: Window config
    When: Window mode
    then: Control with window

  - name: get_metrics
    given: Controller state
    When: Metrics query
    then: Return backpressure metrics
