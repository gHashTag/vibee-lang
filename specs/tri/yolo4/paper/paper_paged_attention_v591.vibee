name: paper_paged_attention_v591
version: "591.0.0"
language: zig
module: paper_paged_attention_v591

types:
  PagedAttention:
    fields:
      attention_id: String
      page_size: Int
      num_pages: Int
      block_tables: Map<String,List<Int>>
      phi_allocation: Bool

  KVPage:
    fields:
      page_id: Int
      k_data: Object
      v_data: Object
      ref_count: Int

  BlockTable:
    fields:
      sequence_id: String
      logical_blocks: List<Int>
      physical_blocks: List<Int>

  PagedMetrics:
    fields:
      pages_allocated: Int
      pages_shared: Int
      memory_efficiency: Float
      phi_utilization: Float

behaviors:
  - name: create_paged_attention
    given: Attention config
    when: Creation
    then: Initialize paged attention

  - name: allocate_page
    given: Sequence
    when: Page needed
    then: Allocate physical page

  - name: free_page
    given: Page ID
    when: Page freed
    then: Return to pool

  - name: copy_on_write
    given: Shared page
    When: Write needed
    then: Copy before write

  - name: share_prefix
    given: Common prefix
    When: Sharing possible
    then: Share KV pages

  - name: compute_attention
    given: Query and block table
    When: Attention computation
    then: Paged attention forward

  - name: defragment
    given: Fragmented pages
    When: Defragmentation needed
    then: Compact pages

  - name: get_metrics
    given: Attention state
    When: Metrics query
    then: Return paged metrics
