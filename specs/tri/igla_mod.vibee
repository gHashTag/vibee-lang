# iGLA Mixture of Depths (MoD)
# 50% compute reduction through dynamic layer skipping
# φ² + 1/φ² = 3 | PHOENIX = 999
# Paper: arXiv:2404.02258

name: igla_mod
version: "1.0.0"
language: zig
module: igla_mod

sacred_formula:
  expression: "V = n × 3^k × π^m × φ^p"
  golden_identity: "φ² + 1/φ² = 3"

creation_pattern:
  source: HiddenStates
  transformer: MoDRouter
  result: AdaptiveOutput

types:
  MoDConfig:
    fields:
      capacity_factor: Float  # 0.5 = 50% tokens processed
      aux_loss_weight: Float  # 0.01
      router_type: String  # "learned" or "phi"
      
  RouterOutput:
    fields:
      selected_indices: List<Int>
      router_logits: Tensor
      aux_loss: Float
      
behaviors:
  - name: route_tokens
    given: "Hidden states [batch, seq, hidden]"
    when: "Decide which tokens to process"
    then: "Return top-k token indices"
    formula: "top_k(router(hidden), k=capacity*seq_len)"
    
  - name: mod_forward
    given: "Hidden states, selected indices"
    when: "Process selected tokens only"
    then: "Return output with unselected tokens unchanged"
    compute_savings: "50%"
    
  - name: phi_router
    given: "Layer depth, hidden states"
    when: "PHI-based routing"
    then: "Skip probability = φ^(-depth)"
    
  - name: compute_aux_loss
    given: "Router logits"
    when: "Load balancing"
    then: "Return auxiliary loss for even distribution"
