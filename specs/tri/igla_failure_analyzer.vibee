# IGLA Failure Analyzer
# Categorizes and analyzes failures for self-improvement
# φ² + 1/φ² = 3 | PHOENIX = 999

name: igla_failure_analyzer
version: "1.0.0"
language: zig
module: igla_failure_analyzer

sacred_constants:
  phi: 1.618033988749895
  phoenix: 999
  trinity: 3

creation_pattern:
  source: FailureData
  transformer: FailureAnalyzer
  result: FailureAnalysis

types:
  FailureCategory:
    enum:
      - PatchSyntax
      - PatchApplication
      - TestFailure
      - Timeout
      - DependencyMissing
      - LogicError
      - EdgeCase
      - Regression

  FailureSeverity:
    enum:
      - Critical
      - Major
      - Minor
      - Cosmetic

  FailureData:
    fields:
      instance_id: String
      patch: String
      error_output: String
      test_output: String
      exit_code: Int

  FailureAnalysis:
    fields:
      category: String
      severity: String
      root_cause: String
      suggested_fix: String
      confidence: Float
      related_failures: List<String>

  FailurePattern:
    fields:
      pattern_id: String
      regex: String
      category: String
      fix_template: String
      occurrence_count: Int

  FailureStats:
    fields:
      total_failures: Int
      by_category: Object
      by_severity: Object
      most_common: String
      improvement_suggestions: List<String>

  TestFailureDetail:
    fields:
      test_name: String
      expected: String
      actual: String
      traceback: String
      line_number: Int

behaviors:
  - name: analyze_failure
    given: "FailureData"
    when: "Analysis requested"
    then: "Returns FailureAnalysis"

  - name: categorize_error
    given: "Error output string"
    when: "Categorization requested"
    then: "Returns FailureCategory"

  - name: extract_root_cause
    given: "FailureData"
    when: "Root cause extraction requested"
    then: "Returns root cause description"

  - name: suggest_fix
    given: "FailureAnalysis"
    when: "Fix suggestion requested"
    then: "Returns suggested fix approach"

  - name: parse_test_output
    given: "Test output string"
    when: "Parsing requested"
    then: "Returns list of TestFailureDetail"

  - name: match_pattern
    given: "Error output and patterns"
    when: "Pattern matching requested"
    then: "Returns matched FailurePattern or null"

  - name: calculate_severity
    given: "FailureCategory and context"
    when: "Severity calculation requested"
    then: "Returns FailureSeverity"

  - name: find_related_failures
    given: "FailureAnalysis and history"
    when: "Related failures search requested"
    then: "Returns list of similar failure IDs"

  - name: aggregate_stats
    given: "List of FailureAnalysis"
    when: "Stats aggregation requested"
    then: "Returns FailureStats"

  - name: generate_improvement_plan
    given: "FailureStats"
    when: "Improvement plan requested"
    then: "Returns prioritized list of improvements"

  - name: is_recoverable
    given: "FailureAnalysis"
    when: "Recoverability check requested"
    then: "Returns true if failure can be fixed"

  - name: extract_assertion_error
    given: "Test output"
    when: "Assertion extraction requested"
    then: "Returns expected vs actual values"

test_cases:
  - name: test_categorize_syntax_error
    input:
      error: "SyntaxError: invalid syntax"
    expected:
      category: "PatchSyntax"

  - name: test_categorize_test_failure
    input:
      error: "AssertionError: expected True"
    expected:
      category: "TestFailure"

  - name: test_categorize_timeout
    input:
      error: "TimeoutError: test exceeded 300s"
    expected:
      category: "Timeout"

  - name: test_root_cause_extraction
    input:
      traceback: "File test.py line 42"
    expected:
      line_extracted: true

  - name: test_severity_calculation
    input:
      category: "Regression"
    expected:
      severity: "Critical"

  - name: test_pattern_matching
    input:
      error: "ModuleNotFoundError: No module"
    expected:
      pattern_matched: true
