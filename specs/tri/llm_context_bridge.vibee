# LLM Context Bridge
# Connects Context Engineering system to LLM providers
# Enables rapid iteration with real model calls

name: llm_context_bridge
version: "1.0.0"
language: zig
module: llm_context_bridge

types:
  BridgeConfig:
    fields:
      bridge_id: String
      primary_provider: String
      fallback_providers: List<String>
      context_engine_id: String
      max_retries: Int

  ContextToPrompt:
    fields:
      context_stack: String
      resolved_variables: Map<String,String>
      final_prompt: String
      token_count: Int

  PromptExecution:
    fields:
      execution_id: String
      prompt: String
      provider_used: String
      model_used: String
      started_at: Timestamp
      completed_at: Option<Timestamp>

  ExecutionResult:
    fields:
      execution_id: String
      response: String
      tokens_input: Int
      tokens_output: Int
      latency_ms: Int
      cost_usd: Float
      provider: String

  IterationFeedback:
    fields:
      feedback_id: String
      execution_id: String
      quality_score: Float
      latency_acceptable: Bool
      cost_acceptable: Bool
      notes: String

  ABTestExecution:
    fields:
      test_id: String
      control_context: String
      variant_context: String
      control_results: List<String>
      variant_results: List<String>
      winner: Option<String>

  ProviderFallback:
    fields:
      fallback_id: String
      primary_provider: String
      fallback_provider: String
      trigger_condition: String
      fallback_count: Int

  CostTracker:
    fields:
      tracker_id: String
      total_cost_usd: Float
      budget_limit_usd: Float
      requests_count: Int
      tokens_total: Int

behaviors:
  - name: compile_context_to_prompt
    given: Context stack and variables
    when: Prompt compilation requested
    then: Returns optimized prompt within token budget

  - name: execute_with_provider
    given: Compiled prompt and provider selection
    when: LLM call is made
    then: Returns execution result with metrics

  - name: execute_with_fallback
    given: Prompt and fallback chain
    when: Primary provider fails
    then: Tries fallback providers until success

  - name: run_ab_test
    given: Control and variant contexts
    when: A/B test execution requested
    then: Returns comparative results

  - name: collect_iteration_feedback
    given: Execution result and quality criteria
    when: Feedback collection triggered
    then: Returns structured feedback for iteration

  - name: track_costs
    given: Execution result with usage
    when: Cost tracking enabled
    then: Updates cost tracker with new usage

  - name: select_provider_for_task
    given: Task requirements and available providers
    when: Provider selection needed
    then: Returns optimal provider based on constraints

  - name: cache_response
    given: Prompt hash and response
    when: Caching enabled
    then: Stores response for future identical prompts
