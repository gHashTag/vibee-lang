# ═══════════════════════════════════════════════════════════════════════════════
# PLUGIN SYSTEM SPECIFICATION
# Extensible Plugin Architecture for TRI
# Sacred Formula: V = n × 3^k × π^m × φ^p × e^q
# Golden Identity: φ² + 1/φ² = 3
# ═══════════════════════════════════════════════════════════════════════════════

name: plugin_system
version: "1.0.0"
language: tri
module: plugins

sacred_constants:
  phi: 1.618033988749895
  trinity: 3.0
  phoenix: 999

creation_pattern:
  source: PluginManifest
  transformer: PluginLoader
  result: LoadedPlugin

# ═══════════════════════════════════════════════════════════════════════════════
# TYPES
# ═══════════════════════════════════════════════════════════════════════════════

types:
  PluginManifest:
    fields:
      name: String
      version: String
      description: String
      author: Author?
      license: String?
      homepage: String?
      repository: String?
      keywords: List<String>?
      tri_version: String  # minimum TRI version
      
      # Plugin components
      commands: List<CommandDef>?
      hooks: List<HookDef>?
      agents: List<AgentDef>?
      providers: List<ProviderDef>?

  Author:
    fields:
      name: String
      email: String?
      url: String?

  CommandDef:
    fields:
      name: String
      description: String
      usage: String?
      file: String  # path to command implementation

  HookDef:
    fields:
      event: HookEvent
      handler: String  # path to handler
      priority: Int?

  HookEvent:
    enum:
      - pre_chat        # Before sending to AI
      - post_chat       # After receiving from AI
      - pre_tool_use    # Before tool execution
      - post_tool_use   # After tool execution
      - pre_commit      # Before git commit
      - post_commit     # After git commit
      - on_error        # On any error
      - on_startup      # When TRI starts
      - on_shutdown     # When TRI exits

  AgentDef:
    fields:
      name: String
      description: String
      system_prompt: String
      tools: List<String>?
      file: String?

  ProviderDef:
    fields:
      name: String
      type: ProviderType
      config: Object

  ProviderType:
    enum:
      - ai          # AI provider
      - storage     # Storage backend
      - auth        # Authentication
      - logging     # Logging backend

  LoadedPlugin:
    fields:
      manifest: PluginManifest
      path: String
      enabled: Bool
      loaded_at: Timestamp
      commands: List<Command>
      hooks: List<Hook>

  PluginContext:
    fields:
      tri_version: String
      config_dir: String
      data_dir: String
      cache_dir: String
      env: Map<String, String>

# ═══════════════════════════════════════════════════════════════════════════════
# PLUGIN MANAGER
# ═══════════════════════════════════════════════════════════════════════════════

class PluginManager:
  plugins: Map<String, LoadedPlugin>
  hooks: Map<HookEvent, List<Hook>>
  plugin_dir: String
  
  fn init() -> PluginManager:
    plugin_dir = get_plugin_dir()
    return PluginManager(
      plugins: {},
      hooks: {},
      plugin_dir: plugin_dir
    )
  
  fn get_plugin_dir() -> String:
    # Check multiple locations
    locations = [
      "./.tri/plugins",
      "~/.tri/plugins",
      "/usr/local/share/tri/plugins"
    ]
    for loc in locations:
      if dir_exists(loc):
        return loc
    return "~/.tri/plugins"
  
  fn discover_plugins(self) -> List<String>:
    plugins = []
    for entry in list_directory(self.plugin_dir):
      if entry.is_dir:
        manifest_path = "{self.plugin_dir}/{entry.name}/plugin.json"
        if file_exists(manifest_path):
          plugins.append(entry.name)
    return plugins
  
  fn load_plugin(self, name: String) -> Result<LoadedPlugin, Error>:
    manifest_path = "{self.plugin_dir}/{name}/plugin.json"
    
    if not file_exists(manifest_path):
      return Error("Plugin not found: {name}")
    
    manifest = json_decode(fs_read(manifest_path)) as PluginManifest
    
    # Check TRI version compatibility
    if not is_compatible(manifest.tri_version):
      return Error("Plugin requires TRI {manifest.tri_version}")
    
    # Load commands
    commands = []
    for cmd_def in manifest.commands ?? []:
      cmd = self.load_command(name, cmd_def)
      commands.append(cmd)
    
    # Load hooks
    hooks = []
    for hook_def in manifest.hooks ?? []:
      hook = self.load_hook(name, hook_def)
      hooks.append(hook)
      self.register_hook(hook_def.event, hook)
    
    plugin = LoadedPlugin(
      manifest: manifest,
      path: "{self.plugin_dir}/{name}",
      enabled: true,
      loaded_at: now(),
      commands: commands,
      hooks: hooks
    )
    
    self.plugins[name] = plugin
    return Ok(plugin)
  
  fn unload_plugin(self, name: String):
    if name not in self.plugins:
      return
    
    plugin = self.plugins[name]
    
    # Unregister hooks
    for event, hooks in self.hooks.items():
      self.hooks[event] = hooks.filter(h -> h.plugin != name)
    
    del self.plugins[name]
  
  fn register_hook(self, event: HookEvent, hook: Hook):
    if event not in self.hooks:
      self.hooks[event] = []
    self.hooks[event].append(hook)
    # Sort by priority
    self.hooks[event].sort(key: h -> h.priority)
  
  fn trigger_hook(self, event: HookEvent, context: Object) -> Object:
    if event not in self.hooks:
      return context
    
    for hook in self.hooks[event]:
      context = hook.handler(context)
      if context.abort:
        break
    
    return context
  
  fn list_plugins(self) -> List<PluginInfo>:
    return self.plugins.values().map(p -> PluginInfo(
      name: p.manifest.name,
      version: p.manifest.version,
      description: p.manifest.description,
      enabled: p.enabled,
      commands: p.commands.len(),
      hooks: p.hooks.len()
    ))

# ═══════════════════════════════════════════════════════════════════════════════
# PLUGIN MANIFEST FORMAT
# ═══════════════════════════════════════════════════════════════════════════════

manifest_example: |
  {
    "name": "tri-git-hooks",
    "version": "1.0.0",
    "description": "Git integration hooks for TRI",
    "author": {
      "name": "VIBEE Team",
      "email": "team@vibee.dev"
    },
    "license": "MIT",
    "tri_version": ">=1.0.0",
    "keywords": ["git", "hooks", "automation"],
    
    "commands": [
      {
        "name": "smart-commit",
        "description": "AI-powered commit message generation",
        "usage": "tri smart-commit [--amend]",
        "file": "commands/smart-commit.tri"
      }
    ],
    
    "hooks": [
      {
        "event": "pre_commit",
        "handler": "hooks/pre-commit.tri",
        "priority": 10
      },
      {
        "event": "post_chat",
        "handler": "hooks/post-chat.tri",
        "priority": 50
      }
    ],
    
    "agents": [
      {
        "name": "code-reviewer",
        "description": "Automated code review agent",
        "system_prompt": "You are a code reviewer...",
        "tools": ["read_file", "search", "git_diff"]
      }
    ]
  }

# ═══════════════════════════════════════════════════════════════════════════════
# BUILT-IN PLUGINS
# ═══════════════════════════════════════════════════════════════════════════════

builtin_plugins:
  - name: "tri-ternary"
    description: "Ternary logic operations"
    commands:
      - "eval"
      - "truth"
    hooks: []

  - name: "tri-pas"
    description: "PAS DAEMONS integration"
    commands:
      - "pas analyze"
      - "pas predict"
      - "pas patterns"
    hooks: []

  - name: "tri-git"
    description: "Git operations"
    commands:
      - "commit"
      - "push"
      - "pr"
      - "review"
    hooks:
      - event: pre_commit
        handler: "security_check"

  - name: "tri-phi"
    description: "Sacred constants"
    commands:
      - "phi"
    hooks: []

# ═══════════════════════════════════════════════════════════════════════════════
# BEHAVIORS
# ═══════════════════════════════════════════════════════════════════════════════

behaviors:
  - name: discover_plugins
    given: Plugin directory exists
    when: PluginManager initializes
    then: Find all valid plugins
    test_cases:
      - name: find_plugins
        setup:
          create_dir: "~/.tri/plugins/test-plugin"
          create_file: "~/.tri/plugins/test-plugin/plugin.json"
        expected:
          plugins: contains("test-plugin")

  - name: load_plugin
    given: Valid plugin manifest
    when: Plugin is loaded
    then: Register commands and hooks
    test_cases:
      - name: load_success
        input:
          name: "test-plugin"
        expected:
          success: true
          commands_registered: true

  - name: trigger_hook
    given: Hooks registered for event
    when: Event is triggered
    then: Execute hooks in priority order
    test_cases:
      - name: hook_chain
        setup:
          hooks:
            - { event: pre_chat, priority: 10 }
            - { event: pre_chat, priority: 5 }
        input:
          event: pre_chat
        expected:
          execution_order: [5, 10]

# ═══════════════════════════════════════════════════════════════════════════════
# COMMANDS
# ═══════════════════════════════════════════════════════════════════════════════

commands:
  - name: "tri plugin list"
    usage: "tri plugin list [--all]"
    description: "List installed plugins"
    examples:
      - "tri plugin list"
      - "tri plugin list --all"

  - name: "tri plugin install"
    usage: "tri plugin install <name|url>"
    description: "Install a plugin"
    examples:
      - "tri plugin install tri-git-hooks"
      - "tri plugin install https://github.com/user/plugin.git"

  - name: "tri plugin uninstall"
    usage: "tri plugin uninstall <name>"
    description: "Uninstall a plugin"
    examples:
      - "tri plugin uninstall tri-git-hooks"

  - name: "tri plugin enable"
    usage: "tri plugin enable <name>"
    description: "Enable a disabled plugin"

  - name: "tri plugin disable"
    usage: "tri plugin disable <name>"
    description: "Disable a plugin without uninstalling"

  - name: "tri plugin create"
    usage: "tri plugin create <name>"
    description: "Create a new plugin scaffold"
    examples:
      - "tri plugin create my-plugin"

# ═══════════════════════════════════════════════════════════════════════════════
# PLUGIN API
# ═══════════════════════════════════════════════════════════════════════════════

plugin_api:
  # Available to plugins
  exports:
    - name: "tri.chat"
      description: "Send message to AI"
      signature: "fn(message: String) -> String"
      
    - name: "tri.eval"
      description: "Evaluate ternary expression"
      signature: "fn(expr: String) -> Ternary"
      
    - name: "tri.read_file"
      description: "Read file content"
      signature: "fn(path: String) -> String"
      
    - name: "tri.write_file"
      description: "Write file content"
      signature: "fn(path: String, content: String) -> Bool"
      
    - name: "tri.exec"
      description: "Execute shell command"
      signature: "fn(cmd: String) -> ExecResult"
      
    - name: "tri.config"
      description: "Access TRI configuration"
      signature: "fn(key: String) -> Any"
      
    - name: "tri.log"
      description: "Log message"
      signature: "fn(level: LogLevel, message: String)"

# ═══════════════════════════════════════════════════════════════════════════════
# PAS PREDICTIONS
# ═══════════════════════════════════════════════════════════════════════════════

pas_predictions:
  - target: "Plugin Load Time"
    current: "100ms per plugin"
    predicted: "10ms with lazy loading"
    confidence: 0.85
    patterns: [PRE]
    timeline: "2026"

  - target: "Hook Execution"
    current: "Sequential"
    predicted: "Parallel where safe"
    confidence: 0.70
    patterns: [D&C]
    timeline: "2026"

# ═══════════════════════════════════════════════════════════════════════════════
# φ² + 1/φ² = 3
# ═══════════════════════════════════════════════════════════════════════════════
