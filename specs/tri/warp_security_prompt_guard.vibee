name: warp_security_prompt_guard
version: "1.0.0"
language: zig
module: warp_security_prompt_guard

description: |
  WARP Security Prompt Guard - защита от prompt injection
  Научные основы: Indirect Prompt Injection (Greshake et al., 2023)
  Разделение user content и page content
  φ² + 1/φ² = 3 | PHOENIX = 999

types:
  ContentSource:
    fields:
      source_type: String
      origin: String
      trust_level: Int
      sanitized: Bool

  PromptTemplate:
    fields:
      system_prompt: String
      user_section: String
      page_section: String
      delimiter: String

  InjectionDetection:
    fields:
      detected: Bool
      injection_type: String
      malicious_content: String
      confidence: Float

  SanitizedContent:
    fields:
      original_length: Int
      sanitized_length: Int
      removed_patterns: List<String>
      safe_content: String

  PromptGuardConfig:
    fields:
      strict_mode: Bool
      max_page_tokens: Int
      blocked_patterns: List<String>
      escape_special: Bool

behaviors:
  - name: detect_injection
    given: Контент страницы
    when: Проверка на prompt injection
    then: InjectionDetection результат

  - name: sanitize_page_content
    given: Сырой контент страницы
    when: Очистка от опасных паттернов
    then: SanitizedContent безопасный контент

  - name: build_safe_prompt
    given: User запрос и page content
    when: Построение безопасного промпта
    then: PromptTemplate с разделением

  - name: validate_response
    given: Ответ LLM
    when: Проверка ответа на манипуляции
    then: Bool безопасен или нет

  - name: escape_delimiters
    given: Текст с потенциальными delimiters
    when: Экранирование специальных символов
    then: Экранированный текст

  - name: log_injection_attempt
    given: InjectionDetection обнаруженная атака
    when: Логирование попытки
    then: Запись в security log
