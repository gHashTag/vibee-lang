# browser_agent_e2e_v999.vibee - E2E Browser Agent
# KOSCHEI PATTERN - Full browser automation agent
# φ² + 1/φ² = 3 | PHOENIX = 999

name: browser_agent_e2e_v999
version: "999.0.0"
language: zig
module: browser_agent_e2e_v999

types:
  BrowserConfig:
    fields:
      headless: Bool
      timeout_ms: Int
      max_steps: Int
      retry_count: Int

  PageState:
    fields:
      url: String
      title: String
      content: String
      elements: String

  AgentAction:
    fields:
      action_type: String
      selector: String
      value: String
      timestamp: Timestamp

  TaskIntent:
    fields:
      task_id: Int
      intent: String
      start_url: String
      max_steps: Int

  TaskResult:
    fields:
      task_id: Int
      success: Bool
      score: Float
      answer: String
      steps_count: Int
      execution_time_ms: Int

  TrajectoryStep:
    fields:
      step: Int
      url: String
      observation: String
      thought: String
      action: String
      action_input: String
      result: String

  LLMResponse:
    fields:
      thought: String
      action: String
      action_input: String
      raw_response: String
      provider: String
      model: String

  BrowserAction:
    fields:
      goto: String
      click: String
      search: String
      done: String

behaviors:
  - name: init_browser
    given: BrowserConfig with headless mode and timeout
    when: Initialize browser automation client
    then: Return configured browser instance ready for navigation

  - name: navigate_to_url
    given: Target URL string
    when: Browser navigates to the specified URL
    then: Return PageState with title, content, and interactive elements

  - name: click_element
    given: CSS selector or element description
    when: Click on the target element
    then: Return updated PageState after click action

  - name: search_input
    given: Selector and search text
    when: Type text into input field and press Enter
    then: Return PageState with search results

  - name: extract_page_content
    given: Current page DOM
    when: Extract text content and interactive elements
    then: Return structured PageState with elements list

  - name: think_next_action
    given: Current observation and task intent
    when: LLM analyzes page state and decides next action
    then: Return LLMResponse with thought, action, and input

  - name: parse_llm_response
    given: Raw LLM response text
    when: Parse structured action from response
    then: Return parsed AgentAction with type and parameters

  - name: execute_action
    given: AgentAction and current PageState
    when: Execute the specified browser action
    then: Return new PageState after action execution

  - name: check_task_complete
    given: Current state and task intent
    when: Evaluate if task goal is achieved
    then: Return Bool indicating completion status

  - name: run_agent_loop
    given: TaskIntent with goal and start URL
    when: Execute agent loop until done or max steps
    then: Return TaskResult with success, score, and answer

  - name: calculate_score
    given: TaskResult and expected outcome
    when: Evaluate task completion quality
    then: Return Float score between 0.0 and 1.0

  - name: record_trajectory
    given: Step number and action details
    when: Record step in trajectory history
    then: Return TrajectoryStep for logging

  - name: handle_error
    given: Error message and current state
    when: Handle browser or LLM error gracefully
    then: Return recovery action or error result

  - name: retry_action
    given: Failed action and retry count
    when: Retry failed action with backoff
    then: Return action result or final error

sacred_constants:
  phi: 1.618033988749895
  phi_squared_plus_inverse_squared: 3
  phoenix: 999
  max_trajectory_steps: 8
  default_timeout_ms: 30000
