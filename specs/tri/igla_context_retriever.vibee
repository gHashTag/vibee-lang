# IGLA Context Retriever
# Retrieves relevant code context for LLM prompts
# φ² + 1/φ² = 3 | PHOENIX = 999

name: igla_context_retriever
version: "1.0.0"
language: zig
module: igla_context_retriever

sacred_constants:
  phi: 1.618033988749895
  phoenix: 999
  trinity: 3

types:
  RetrievalStrategy:
    enum: [BM25, TFIDF, Hybrid, Symbol, AST]

  ContextRequest:
    fields:
      query: String
      max_chunks: Int
      strategy: String
      include_imports: Bool

  RetrievedContext:
    fields:
      chunks: List<String>
      sources: List<String>
      relevance_scores: List<Float>
      total_tokens: Int

  ContextConfig:
    fields:
      max_tokens: Int
      min_relevance: Float
      dedup_threshold: Float

behaviors:
  - name: retrieve
    given: ContextRequest and index
    when: Retrieval requested
    then: Returns RetrievedContext

  - name: retrieve_hybrid
    given: Query and indices
    when: Hybrid retrieval requested
    then: Returns combined results

  - name: deduplicate
    given: Retrieved chunks
    when: Deduplication requested
    then: Returns unique chunks

  - name: format_context
    given: RetrievedContext
    when: Formatting requested
    then: Returns formatted string

  - name: estimate_tokens
    given: Text
    when: Token estimation requested
    then: Returns token count

  - name: truncate_context
    given: Context and max_tokens
    when: Truncation requested
    then: Returns truncated context

test_cases:
  - name: test_retrieval
    expected: context_retrieved
  - name: test_hybrid_search
    expected: results_combined
  - name: test_deduplication
    expected: duplicates_removed
  - name: test_token_estimation
    expected: tokens_counted
  - name: test_truncation
    expected: context_truncated
