# observation_builder_v22.vibee
# KOSCHEI CYCLE 22.1 - Observation Builder
# Builds rich observations from DOM + Screenshot
# φ² + 1/φ² = 3 | PHOENIX = 999

name: observation_builder_v22
version: "22.1.0"
language: zig
module: observation_builder_v22

types:
  ObservationConfig:
    fields:
      include_screenshot: Bool
      include_dom: Bool
      include_accessibility: Bool
      max_elements: Int
      max_text_length: Int

  RichObservation:
    fields:
      url: String
      title: String
      screenshot_base64: Option<String>
      visible_text: String
      links: String
      buttons: String
      inputs: String
      headings: String
      timestamp: Timestamp

  DOMElements:
    fields:
      links_count: Int
      buttons_count: Int
      inputs_count: Int
      images_count: Int
      forms_count: Int

  InteractiveElement:
    fields:
      element_type: String
      selector: String
      text: String
      is_visible: Bool
      bounding_box: String

  PageMetadata:
    fields:
      url: String
      title: String
      favicon_url: String
      language: String
      charset: String

  ObservationSummary:
    fields:
      page_type: String
      main_content: String
      navigation_options: String
      form_fields: String

  BuildResult:
    fields:
      success: Bool
      observation: String
      build_time_ms: Int
      elements_found: Int

  ObservationDiff:
    fields:
      url_changed: Bool
      title_changed: Bool
      content_changed: Bool
      new_elements: Int
      removed_elements: Int

behaviors:
  - name: create_builder
    given: ObservationConfig
    when: Creating observation builder
    then: Return builder handle

  - name: build_observation
    given: CDP session
    when: Building full observation
    then: Return RichObservation

  - name: get_dom_elements
    given: CDP session
    when: Extracting DOM elements
    then: Return DOMElements

  - name: get_interactive_elements
    given: CDP session
    when: Finding interactive elements
    then: Return list of InteractiveElement

  - name: get_page_metadata
    given: CDP session
    when: Getting page metadata
    then: Return PageMetadata

  - name: summarize
    given: RichObservation
    when: Creating summary for LLM
    then: Return ObservationSummary

  - name: format_for_prompt
    given: RichObservation
    when: Formatting for LLM prompt
    then: Return formatted string

  - name: compare_observations
    given: Two observations
    when: Comparing for changes
    then: Return ObservationDiff

  - name: truncate
    given: Observation and max length
    when: Truncating for context window
    then: Return truncated observation

  - name: extract_actionable
    given: RichObservation
    when: Extracting actionable elements
    then: Return list of elements

test_cases:
  - name: build_full_observation
    input: example.com page
    expected: observation with all fields

  - name: format_for_llm
    input: observation
    expected: formatted string < 4000 chars

  - name: compare_same_page
    input: two identical observations
    expected: no changes detected

sacred_constants:
  phi: 1.618033988749895
  phi_squared_plus_inverse_squared: 3
  phoenix: 999
