# v3600 - Mixture of Experts
# ===========================
# Sparse activation for efficient scaling
# φ² + 1/φ² = 3 | PHOENIX = 999

name: mixture_of_experts
version: "3.6.0"
language: zig
module: mixture_of_experts

constants:
  PHI: 1.618033988749895
  NUM_EXPERTS: 8
  TOP_K: 2
  CAPACITY_FACTOR: 1.25
  LOAD_BALANCE_WEIGHT: 0.01

types:
  MoEConfig:
    fields:
      num_experts: Int
      top_k: Int
      hidden_size: Int
      expert_size: Int
      capacity_factor: Float
      
  Expert:
    fields:
      expert_id: Int
      weight_up: List
      weight_down: List
      
  Router:
    fields:
      router_weights: List
      noise_std: Float
      
  GatingOutput:
    fields:
      expert_indices: List
      expert_weights: List
      aux_loss: Float
      
  ExpertOutput:
    fields:
      output: List
      load_balance_loss: Float
      
  CapacityConfig:
    fields:
      max_tokens_per_expert: Int
      drop_tokens: Bool
      
  LoadBalanceStats:
    fields:
      expert_counts: List
      router_z_loss: Float
      load_balance_loss: Float

behaviors:
  - name: init_moe_layer
    given: MoE configuration
    when: Creating MoE layer
    then: Return initialized experts and router
    
  - name: compute_router_logits
    given: Input tokens and router weights
    when: Computing expert selection
    then: Return logits for each expert
    
  - name: top_k_gating
    given: Router logits and k
    when: Selecting top-k experts
    then: Return expert indices and weights
    
  - name: dispatch_to_experts
    given: Tokens and gating output
    when: Routing tokens to experts
    then: Return tokens grouped by expert
    
  - name: expert_forward
    given: Expert and input tokens
    when: Computing expert output
    then: Return expert activations
    
  - name: combine_expert_outputs
    given: Expert outputs and weights
    when: Combining weighted outputs
    then: Return final MoE output
    
  - name: compute_load_balance_loss
    given: Expert assignments
    when: Encouraging balanced routing
    then: Return auxiliary loss term
    
  - name: apply_capacity_factor
    given: Tokens and capacity
    when: Limiting tokens per expert
    then: Return capacity-limited assignments
