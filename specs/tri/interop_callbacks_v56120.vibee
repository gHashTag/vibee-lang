# Interop Callbacks v56120 - Callback Mechanisms
# Cross-Language Callback Support
# φ² + 1/φ² = 3 | PHOENIX = 999

name: interop_callbacks_v56120
version: "56.1.20"
language: zig
module: interop_callbacks

creation_pattern:
  source: ManagedFunction
  transformer: CallbackWrapper
  result: NativeCallback

types:
  CallbackSignature:
    fields:
      name: String
      return_type: String
      param_types: List<String>
      calling_convention: String

  CallbackClosure:
    fields:
      signature: CallbackSignature
      user_data: String
      invoke_fn: String
      destroy_fn: Option<String>

  CallbackHandle:
    fields:
      id: Int
      closure: CallbackClosure
      native_ptr: Int
      is_registered: Bool

  CallbackRegistry:
    fields:
      callbacks: List<CallbackHandle>
      next_id: Int
      mutex: String

  CallbackError:
    fields:
      code: Int
      message: String
      callback_id: Option<Int>

  TrampolineCode:
    fields:
      machine_code: String
      size: Int
      executable: Bool

  CallbackContext:
    fields:
      handle: CallbackHandle
      thread_id: Int
      recursion_depth: Int

  CallbackResult:
    fields:
      value: String
      error: Option<CallbackError>
      elapsed_ns: Int

behaviors:
  - name: create_callback
    given: Managed function and signature
    when: Native callback needed
    then: CallbackHandle with native pointer

  - name: invoke_callback
    given: CallbackHandle and arguments
    when: Callback invocation needed
    then: CallbackResult

  - name: destroy_callback
    given: CallbackHandle
    when: Callback cleanup needed
    then: Resources freed

  - name: generate_trampoline
    given: CallbackSignature
    When: JIT trampoline needed
    then: TrampolineCode

  - name: register_callback
    given: CallbackHandle
    when: Registration needed
    then: Registered in CallbackRegistry

  - name: unregister_callback
    given: Callback ID
    when: Unregistration needed
    then: Removed from registry

  - name: wrap_exception
    given: Managed exception
    when: Exception in callback
    then: Error propagation

  - name: get_callback_context
    given: Native callback invocation
    when: Context needed
    then: CallbackContext
