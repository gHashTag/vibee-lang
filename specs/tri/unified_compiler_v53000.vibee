name: unified_compiler_v53000
version: "53000.0.0"
language: zig
module: unified_compiler

# UNIFIED VIBEE COMPILER
# Объединяет все компоненты компилятора в единую архитектуру:
# - Parser (vibee_parser, parser_v3, simd_parser_v2)
# - Codegen (zig_codegen, codegen_v4, codegen_wasm, ml_codegen)
# - Compiler (compiler, spec_compiler)
# - Optimizer (egraph, superopt, dce)

types:
  # ═══════════════════════════════════════════════════════════════
  # CORE TYPES
  # ═══════════════════════════════════════════════════════════════
  
  CompilerConfig:
    fields:
      optimization_level: Int
      target: String
      simd_enabled: Bool
      parallel_enabled: Bool
      cache_enabled: Bool
      debug_mode: Bool

  SourceFile:
    fields:
      path: String
      content: String
      hash: Int
      size_bytes: Int

  # ═══════════════════════════════════════════════════════════════
  # PARSER TYPES (unified from vibee_parser, parser_v3, simd_parser)
  # ═══════════════════════════════════════════════════════════════

  Token:
    fields:
      kind: Int
      start: Int
      length: Int
      line: Int
      column: Int

  ParsedSpec:
    fields:
      name: String
      version: String
      module: String
      language: String

  TypeDefinition:
    fields:
      name: String
      fields_count: Int
      is_generic: Bool

  FieldDefinition:
    fields:
      name: String
      field_type: String
      is_optional: Bool
      default_value: String

  BehaviorDefinition:
    fields:
      name: String
      given: String
      when_clause: String
      then_clause: String

  ParseMetrics:
    fields:
      tokens_count: Int
      parse_time_ns: Int
      memory_used: Int
      simd_operations: Int

  # ═══════════════════════════════════════════════════════════════
  # CODEGEN TYPES (unified from zig_codegen, codegen_v4, codegen_wasm)
  # ═══════════════════════════════════════════════════════════════

  CodegenTarget:
    fields:
      name: String
      extension: String
      supports_simd: Bool
      supports_wasm: Bool

  GeneratedCode:
    fields:
      content: String
      line_count: Int
      byte_size: Int
      checksum: Int

  CodegenMetrics:
    fields:
      generation_time_ns: Int
      output_size: Int
      structs_generated: Int
      functions_generated: Int
      tests_generated: Int

  CodeBuffer:
    fields:
      capacity: Int
      length: Int
      indent_level: Int

  # ═══════════════════════════════════════════════════════════════
  # OPTIMIZER TYPES (unified from egraph, superopt, dce)
  # ═══════════════════════════════════════════════════════════════

  OptimizationPass:
    fields:
      name: String
      enabled: Bool
      priority: Int

  OptimizationResult:
    fields:
      original_size: Int
      optimized_size: Int
      passes_applied: Int
      time_ns: Int

  # ═══════════════════════════════════════════════════════════════
  # COMPILER TYPES (unified from compiler, spec_compiler)
  # ═══════════════════════════════════════════════════════════════

  CompilationUnit:
    fields:
      source_path: String
      output_path: String
      is_dirty: Bool
      last_compiled: Int

  CompilationResult:
    fields:
      success: Bool
      output_path: String
      errors_count: Int
      warnings_count: Int
      time_ms: Int

  CompilerState:
    fields:
      files_processed: Int
      files_cached: Int
      total_time_ms: Int

behaviors:
  # ═══════════════════════════════════════════════════════════════
  # UNIFIED PARSER BEHAVIORS
  # ═══════════════════════════════════════════════════════════════

  - name: tokenize
    given: Source file content
    when: Tokenization triggered
    then: Token stream produced

  - name: tokenize_simd
    given: Source file content with SIMD enabled
    when: SIMD tokenization triggered
    then: Token stream with 3x speedup

  - name: parse_spec
    given: Token stream
    when: Parsing triggered
    then: ParsedSpec with all definitions

  - name: parse_types
    given: Types section tokens
    when: Type parsing triggered
    then: List of TypeDefinitions

  - name: parse_behaviors
    given: Behaviors section tokens
    when: Behavior parsing triggered
    then: List of BehaviorDefinitions

  # ═══════════════════════════════════════════════════════════════
  # UNIFIED CODEGEN BEHAVIORS
  # ═══════════════════════════════════════════════════════════════

  - name: generate_code
    given: ParsedSpec and target
    when: Code generation triggered
    then: GeneratedCode for target language

  - name: generate_zig
    given: ParsedSpec
    when: Zig generation triggered
    then: Zig source code

  - name: generate_wasm
    given: ParsedSpec
    when: WASM generation triggered
    then: WASM module

  - name: generate_structs
    given: List of TypeDefinitions
    when: Struct generation triggered
    then: Struct declarations in target language

  - name: generate_functions
    given: List of BehaviorDefinitions
    when: Function generation triggered
    then: Function implementations

  - name: generate_tests
    given: List of BehaviorDefinitions
    when: Test generation triggered
    then: Test functions for each behavior

  # ═══════════════════════════════════════════════════════════════
  # UNIFIED OPTIMIZER BEHAVIORS
  # ═══════════════════════════════════════════════════════════════

  - name: optimize
    given: Generated code
    when: Optimization triggered
    then: Optimized code with metrics

  - name: apply_dce
    given: Code with dead paths
    when: DCE pass triggered
    then: Dead code eliminated

  - name: apply_inlining
    given: Code with small functions
    when: Inlining pass triggered
    then: Small functions inlined

  # ═══════════════════════════════════════════════════════════════
  # UNIFIED COMPILER BEHAVIORS
  # ═══════════════════════════════════════════════════════════════

  - name: compile
    given: Source file path
    when: Compilation triggered
    then: CompilationResult with output

  - name: compile_incremental
    given: Changed files only
    when: Incremental compilation triggered
    then: Only dirty files recompiled

  - name: compile_parallel
    given: Multiple source files
    when: Parallel compilation triggered
    then: All files compiled in parallel

  - name: validate_output
    given: Generated code
    when: Validation triggered
    then: Syntax and type errors reported
