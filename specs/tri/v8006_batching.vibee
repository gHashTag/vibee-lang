# v8006 - Dynamic Batching
# =========================
# Continuous batching for LLMs
# Based on: vLLM, Orca
# φ² + 1/φ² = 3 | PHOENIX = 999

name: batching
version: "8.0.6"
language: zig
module: batching

constants:
  PHI: 1.618033988749895

types:
  BatchConfig:
    fields:
      max_batch_size: Int
      max_waiting_time_ms: Int
      padding_strategy: String
      
  ContinuousBatch:
    fields:
      sequences: List
      positions: List
      is_prefill: List
      
  SequenceState:
    fields:
      seq_id: Int
      tokens: List
      kv_cache_slot: Int

behaviors:
  - name: add_sequence
    given: New sequence
    when: Adding to batch
    then: Вернуть updated batch
    
  - name: remove_sequence
    given: Completed sequence
    when: Removing from batch
    then: Вернуть updated batch
    
  - name: iteration_step
    given: Current batch
    when: One iteration
    then: Вернуть next tokens
    
  - name: schedule_prefill
    given: Waiting sequences
    when: Scheduling prefill
    then: Вернуть prefill batch
    
  - name: schedule_decode
    given: Active sequences
    when: Scheduling decode
    then: Вернуть decode batch
    
  - name: preempt_sequence
    given: Low priority sequence
    when: Preemption needed
    then: Preempt and swap out
