name: openai_client_v22
version: "22.2.0"
language: zig
module: openai_client_v22

types:
  OpenAIConfig:
    fields:
      api_key: String
      organization: Option<String>
      base_url: String
      timeout_ms: Int

  OpenAIMessage:
    fields:
      role: String
      content: String
      name: Option<String>

  OpenAIRequest:
    fields:
      model: String
      messages: List<String>
      max_tokens: Int
      temperature: Float
      top_p: Float
      stream: Bool

  OpenAIResponse:
    fields:
      id: String
      model: String
      content: String
      finish_reason: String
      prompt_tokens: Int
      completion_tokens: Int
      total_tokens: Int

  OpenAIError:
    fields:
      code: String
      message: String
      type: String

  VisionContent:
    fields:
      type: String
      text: Option<String>
      image_url: Option<String>

  OpenAIMetrics:
    fields:
      requests: Int
      tokens: Int
      errors: Int
      avg_latency: Float

behaviors:
  - name: create_client
    given: OpenAIConfig
    when: Initialize client
    then: OpenAI client

  - name: chat_completion
    given: Client and OpenAIRequest
    when: Send request
    then: OpenAIResponse

  - name: chat_with_vision
    given: Client, messages, and image_url
    when: Send vision request
    then: OpenAIResponse

  - name: list_models
    given: Client
    when: Get models
    then: Model list

  - name: validate_api_key
    given: Client
    when: Check key
    then: Validation result

  - name: build_request
    given: Messages and config
    when: Build HTTP request
    then: Request body

  - name: parse_response
    given: HTTP response
    when: Parse JSON
    then: OpenAIResponse

  - name: handle_error
    given: Error response
    when: Parse error
    then: OpenAIError

  - name: get_metrics
    given: Client
    when: Get stats
    then: OpenAIMetrics

  - name: estimate_tokens
    given: Text
    when: Estimate count
    then: Token estimate

  - name: close
    given: Client
    when: Cleanup
    then: Closed
