# v7006 - Sequence Parallelism
# =============================
# Parallelism along sequence dimension
# Based on: Korthikanti et al. 2022
# φ² + 1/φ² = 3 | PHOENIX = 999

name: sequence_parallel
version: "7.0.6"
language: zig
module: sequence_parallel

constants:
  PHI: 1.618033988749895

types:
  SPConfig:
    fields:
      sp_size: Int
      sp_rank: Int
      
  SequenceSplit:
    fields:
      local_seq_len: Int
      global_seq_len: Int
      start_idx: Int
      end_idx: Int

behaviors:
  - name: split_sequence
    given: Input и sp_size
    when: Splitting sequence
    then: Вернуть local sequence chunk
    
  - name: gather_sequence
    given: Local outputs
    when: Gathering results
    then: Вернуть full sequence
    
  - name: sp_layernorm
    given: Input и sp_config
    when: Sequence parallel LayerNorm
    then: Вернуть normalized output
    
  - name: sp_dropout
    given: Input и sp_config
    when: Sequence parallel dropout
    then: Вернуть dropped output
    
  - name: all_to_all
    given: Tensor и groups
    when: All-to-all communication
    then: Вернуть redistributed tensor
    
  - name: ring_attention
    given: Q, K, V и sp_config
    when: Ring attention
    then: Вернуть attention with ring comm
