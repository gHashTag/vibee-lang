name: anthropic_client_v22
version: "22.2.0"
language: zig
module: anthropic_client_v22

types:
  AnthropicConfig:
    fields:
      api_key: String
      base_url: String
      timeout_ms: Int
      max_retries: Int

  AnthropicMessage:
    fields:
      role: String
      content: String

  AnthropicRequest:
    fields:
      model: String
      messages: List<String>
      max_tokens: Int
      temperature: Float
      system: Option<String>
      stream: Bool

  AnthropicResponse:
    fields:
      id: String
      model: String
      content: String
      stop_reason: String
      input_tokens: Int
      output_tokens: Int

  AnthropicError:
    fields:
      type: String
      message: String

  ImageBlock:
    fields:
      type: String
      media_type: String
      data: String

  AnthropicMetrics:
    fields:
      requests: Int
      input_tokens: Int
      output_tokens: Int
      errors: Int
      avg_latency: Float

behaviors:
  - name: create_client
    given: AnthropicConfig
    when: Initialize client
    then: Anthropic client

  - name: messages_create
    given: Client and AnthropicRequest
    when: Send request
    then: AnthropicResponse

  - name: messages_with_vision
    given: Client, messages, and image
    when: Send vision request
    then: AnthropicResponse

  - name: validate_api_key
    given: Client
    when: Check key
    then: Validation result

  - name: build_request
    given: Messages and config
    when: Build HTTP request
    then: Request body

  - name: parse_response
    given: HTTP response
    when: Parse JSON
    then: AnthropicResponse

  - name: handle_error
    given: Error response
    when: Parse error
    then: AnthropicError

  - name: get_metrics
    given: Client
    when: Get stats
    then: AnthropicMetrics

  - name: count_tokens
    given: Text
    when: Count tokens
    then: Token count

  - name: set_system_prompt
    given: Client and prompt
    when: Set system
    then: Updated client

  - name: close
    given: Client
    when: Cleanup
    then: Closed
