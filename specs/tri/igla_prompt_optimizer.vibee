# IGLA Prompt Optimizer
# Automatic prompt mutation and selection for improvement
# φ² + 1/φ² = 3 | PHOENIX = 999

name: igla_prompt_optimizer
version: "1.0.0"
language: zig
module: igla_prompt_optimizer

sacred_constants:
  phi: 1.618033988749895
  phoenix: 999
  trinity: 3

creation_pattern:
  source: PromptCandidate
  transformer: PromptOptimizer
  result: OptimizedPrompt

types:
  MutationType:
    enum:
      - AddConstraint
      - RemoveConstraint
      - Rephrase
      - AddExample
      - AddContext
      - Simplify
      - Elaborate

  PromptTemplate:
    fields:
      id: String
      system_prompt: String
      user_template: String
      variables: List<String>
      version: Int

  PromptCandidate:
    fields:
      template: PromptTemplate
      mutation_type: String
      parent_id: String
      score: Float
      evaluations: Int

  PromptPopulation:
    fields:
      candidates: List<PromptCandidate>
      generation: Int
      best_score: Float
      diversity_score: Float

  OptimizationConfig:
    fields:
      population_size: Int
      mutation_rate: Float
      crossover_rate: Float
      elite_count: Int
      max_generations: Int

  OptimizedPrompt:
    fields:
      template: PromptTemplate
      final_score: Float
      generations_evolved: Int
      mutation_history: List<String>

  EvaluationResult:
    fields:
      prompt_id: String
      success_rate: Float
      avg_patch_quality: Float
      avg_tokens_used: Int

behaviors:
  - name: create_initial_population
    given: "Base template and config"
    when: "Population initialization requested"
    then: "Returns PromptPopulation with mutations"

  - name: mutate_prompt
    given: "PromptCandidate and MutationType"
    when: "Mutation requested"
    then: "Returns mutated PromptCandidate"

  - name: crossover
    given: "Two PromptCandidates"
    when: "Crossover requested"
    then: "Returns child PromptCandidate"

  - name: evaluate_candidate
    given: "PromptCandidate and test cases"
    when: "Evaluation requested"
    then: "Returns EvaluationResult"

  - name: select_parents
    given: "PromptPopulation"
    when: "Parent selection requested"
    then: "Returns top candidates for breeding"

  - name: evolve_generation
    given: "PromptPopulation and config"
    when: "Evolution step requested"
    then: "Returns next generation population"

  - name: run_optimization
    given: "Base template and config"
    when: "Full optimization requested"
    then: "Returns OptimizedPrompt"

  - name: add_constraint
    given: "Prompt and constraint text"
    when: "Constraint addition requested"
    then: "Returns prompt with new constraint"

  - name: add_example
    given: "Prompt and example"
    when: "Example addition requested"
    then: "Returns prompt with new example"

  - name: simplify_prompt
    given: "Prompt"
    when: "Simplification requested"
    then: "Returns simplified prompt"

  - name: calculate_diversity
    given: "PromptPopulation"
    when: "Diversity calculation requested"
    then: "Returns diversity score 0.0-1.0"

  - name: tournament_select
    given: "Population and tournament size"
    when: "Tournament selection requested"
    then: "Returns winner candidate"

test_cases:
  - name: test_mutation_add_constraint
    input:
      prompt: "Generate a patch"
      constraint: "Use minimal changes"
    expected:
      constraint_added: true

  - name: test_mutation_add_example
    input:
      prompt: "Fix the bug"
      example: "diff --git example"
    expected:
      example_added: true

  - name: test_crossover
    input:
      parent1: "Prompt A"
      parent2: "Prompt B"
    expected:
      child_created: true

  - name: test_population_evolution
    input:
      generation: 1
      population_size: 10
    expected:
      evolved: true

  - name: test_diversity_calculation
    input:
      candidates: 5
    expected:
      diversity_calculated: true

  - name: test_optimization_run
    input:
      max_generations: 3
    expected:
      optimized: true
