# ═══════════════════════════════════════════════════════════════════════════════
# ЖАР-ПТИЦА (FIREBIRD) - WebArena Champion Agent
# ═══════════════════════════════════════════════════════════════════════════════
# Target: Beat OpenAI Operator (58.1%) → Achieve 75%+ on WebArena
# Architecture: Perception → Reasoning → Action → Verification Loop
# Sacred Formula: V = n × 3^k × π^m × φ^p × e^q
# Golden Identity: φ² + 1/φ² = 3 | PHOENIX = 999
# ═══════════════════════════════════════════════════════════════════════════════

name: zhar_ptitsa_webarena
version: "1.0.0"
language: zig
module: zhar_ptitsa_webarena
author: "VIBEE Team"

# ═══════════════════════════════════════════════════════════════════════════════
# SACRED CONSTANTS
# ═══════════════════════════════════════════════════════════════════════════════

sacred_constants:
  phi: 1.618033988749895
  phi_squared: 2.618033988749895
  trinity: 3.0
  phoenix: 999
  target_accuracy: 0.75
  operator_baseline: 0.581
  human_baseline: 0.7824

# ═══════════════════════════════════════════════════════════════════════════════
# WEBARENA TASK TYPES
# ═══════════════════════════════════════════════════════════════════════════════

types:
  # WebArena Task Configuration
  WebArenaTask:
    fields:
      task_id: Int
      site: String
      intent: String
      start_url: String
      expected_result: String
      difficulty: Int
      max_steps: Int

  # WebArena Sites (6 domains)
  WebArenaSite:
    fields:
      name: String
      base_url: String
      auth_required: Bool
      cookies: Object
      site_knowledge: Object

  # Accessibility Tree Observation (WebArena format)
  AccessibilityTree:
    fields:
      tree_id: String
      root_node: Object
      elements: List<Object>
      focused_element: Option<String>
      viewport_info: Object

  # Element in Accessibility Tree
  A11yElement:
    fields:
      element_id: Int
      role: String
      name: String
      value: Option<String>
      bounds: Object
      is_focusable: Bool
      is_clickable: Bool
      children: List<Int>

  # Agent Action (WebArena action space)
  WebArenaAction:
    fields:
      action_type: String
      element_id: Option<Int>
      text_input: Option<String>
      coordinates: Option<Object>
      reasoning: String
      confidence: Float

  # Action Types Enum
  ActionType:
    fields:
      click: String
      type_text: String
      scroll: String
      hover: String
      press_key: String
      go_back: String
      go_forward: String
      goto_url: String
      stop: String

  # Agent State
  FirebirdState:
    fields:
      task: Object
      current_url: String
      step_count: Int
      action_history: List<Object>
      observation_history: List<Object>
      working_memory: Object
      site_context: Object

  # Reasoning Chain (Chain-of-Thought)
  ReasoningChain:
    fields:
      observation_summary: String
      goal_analysis: String
      available_actions: List<String>
      selected_action: String
      justification: String
      confidence: Float
      fallback_plan: Option<String>

  # Task Result
  TaskResult:
    fields:
      task_id: Int
      success: Bool
      steps_taken: Int
      final_url: String
      error_message: Option<String>
      reasoning_trace: List<Object>

  # Benchmark Score
  WebArenaScore:
    fields:
      total_tasks: Int
      passed_tasks: Int
      success_rate: Float
      avg_steps: Float
      by_site: Object
      by_difficulty: Object

# ═══════════════════════════════════════════════════════════════════════════════
# PERCEPTION MODULE - Understanding the Page
# ═══════════════════════════════════════════════════════════════════════════════

behaviors:
  - name: parse_accessibility_tree
    given: Raw accessibility tree from browser
    when: New page observation received
    then: Return structured A11yElement list with clickable/focusable flags

  - name: extract_interactive_elements
    given: Parsed accessibility tree
    when: Element extraction requested
    then: Return filtered list of actionable elements (buttons, links, inputs)

  - name: summarize_page_state
    given: Accessibility tree and current URL
    when: State summary requested
    then: Return concise page description for LLM context

  - name: detect_page_type
    given: URL and page content
    when: Page classification needed
    then: Return page type (form, list, detail, search, checkout, etc.)

  - name: identify_task_relevant_elements
    given: Task intent and page elements
    when: Relevance filtering needed
    then: Return elements most likely relevant to current task

# ═══════════════════════════════════════════════════════════════════════════════
# REASONING MODULE - Chain-of-Thought Planning
# ═══════════════════════════════════════════════════════════════════════════════

  - name: analyze_task_goal
    given: Task intent and current state
    when: Goal decomposition needed
    then: Return sub-goals and success criteria

  - name: generate_reasoning_chain
    given: Observation, goal, and action history
    when: Action decision needed
    then: Return ReasoningChain with justified action selection

  - name: evaluate_action_candidates
    given: Available actions and task goal
    when: Action ranking needed
    then: Return ranked actions with confidence scores

  - name: detect_stuck_state
    given: Action history and observations
    when: Progress check needed
    then: Return stuck detection with recovery suggestions

  - name: plan_multi_step_sequence
    given: Complex task requiring multiple actions
    when: Planning requested
    then: Return action sequence with checkpoints

# ═══════════════════════════════════════════════════════════════════════════════
# ACTION MODULE - Executing Browser Actions
# ═══════════════════════════════════════════════════════════════════════════════

  - name: execute_click
    given: Element ID from accessibility tree
    when: Click action selected
    then: Click element and return new observation

  - name: execute_type
    given: Element ID and text to type
    when: Type action selected
    then: Focus element, clear existing text, type new text

  - name: execute_scroll
    given: Direction and amount
    when: Scroll action selected
    then: Scroll viewport and return new observation

  - name: execute_navigation
    given: URL or navigation command (back/forward)
    when: Navigation action selected
    then: Navigate and wait for page load

  - name: execute_keyboard
    given: Key combination (Enter, Tab, Escape, etc.)
    when: Keyboard action selected
    then: Send key event and return result

# ═══════════════════════════════════════════════════════════════════════════════
# VERIFICATION MODULE - Checking Action Results
# ═══════════════════════════════════════════════════════════════════════════════

  - name: verify_action_effect
    given: Action taken and new observation
    when: Effect verification needed
    then: Return whether action had expected effect

  - name: check_task_completion
    given: Task goal and current state
    when: Completion check needed
    then: Return completion status with confidence

  - name: detect_error_state
    given: Page observation
    when: Error detection needed
    then: Return error type if detected (404, form error, etc.)

  - name: validate_form_submission
    given: Form action and response
    when: Form validation needed
    then: Return success/failure with error details

# ═══════════════════════════════════════════════════════════════════════════════
# SITE-SPECIFIC KNOWLEDGE MODULE
# ═══════════════════════════════════════════════════════════════════════════════

  - name: load_site_knowledge
    given: Site name (shopping, reddit, gitlab, map, wikipedia)
    when: Site context needed
    then: Return site-specific patterns and shortcuts

  - name: apply_site_heuristics
    given: Site knowledge and current task
    when: Heuristic application needed
    then: Return site-optimized action suggestions

  - name: handle_site_auth
    given: Site requiring authentication
    when: Auth needed
    then: Load cookies and verify logged-in state

# ═══════════════════════════════════════════════════════════════════════════════
# MEMORY MODULE - Context Management
# ═══════════════════════════════════════════════════════════════════════════════

  - name: update_working_memory
    given: New observation and action result
    when: Memory update needed
    then: Update compressed state representation

  - name: retrieve_relevant_history
    given: Current context
    when: History retrieval needed
    then: Return relevant past actions and observations

  - name: compress_observation_history
    given: Full observation history
    when: Context window management needed
    then: Return summarized history fitting context limit

# ═══════════════════════════════════════════════════════════════════════════════
# MAIN AGENT LOOP
# ═══════════════════════════════════════════════════════════════════════════════

  - name: run_task
    given: WebArenaTask configuration
    when: Task execution requested
    then: Execute perception-reasoning-action loop until completion or max_steps

  - name: agent_step
    given: Current state and observation
    when: Single step execution
    then: Return action and updated state

  - name: handle_failure
    given: Failed action or stuck state
    when: Recovery needed
    then: Apply recovery strategy and continue

# ═══════════════════════════════════════════════════════════════════════════════
# BENCHMARK RUNNER
# ═══════════════════════════════════════════════════════════════════════════════

  - name: run_webarena_benchmark
    given: Task configuration files (812 tasks)
    when: Full benchmark requested
    then: Execute all tasks and return WebArenaScore

  - name: run_task_subset
    given: Task IDs and site filter
    when: Partial benchmark requested
    then: Execute subset and return partial score

  - name: generate_trajectory
    given: Completed task
    when: Trajectory export needed
    then: Return per-step observation and action log

# ═══════════════════════════════════════════════════════════════════════════════
# TEST CASES
# ═══════════════════════════════════════════════════════════════════════════════

test_cases:
  - name: test_parse_accessibility_tree
    input: {tree: "sample_a11y_tree"}
    expected: {elements_count: ">0", has_clickable: true}

  - name: test_reasoning_chain
    input: {observation: "login page", goal: "login as user"}
    expected: {action_type: "type", confidence: ">0.8"}

  - name: test_click_action
    input: {element_id: 42}
    expected: {success: true, new_observation: "changed"}

  - name: test_task_completion_detection
    input: {goal: "add item to cart", state: "cart_page_with_item"}
    expected: {completed: true, confidence: ">0.9"}

  - name: test_site_knowledge_shopping
    input: {site: "shopping"}
    expected: {has_patterns: true, auth_method: "cookies"}

  - name: test_golden_identity
    input: {phi: 1.618033988749895}
    expected: {phi_sq_plus_inv_sq: 3.0}

# ═══════════════════════════════════════════════════════════════════════════════
# PERFORMANCE TARGETS
# ═══════════════════════════════════════════════════════════════════════════════

performance_targets:
  webarena_accuracy: ">75%"
  beat_operator: ">58.1%"
  approach_human: "<78.24%"
  avg_steps_per_task: "<15"
  action_latency_ms: "<500"
  reasoning_latency_ms: "<2000"

# ═══════════════════════════════════════════════════════════════════════════════
# ARCHITECTURE DIAGRAM
# ═══════════════════════════════════════════════════════════════════════════════

architecture: |
  ┌─────────────────────────────────────────────────────────────────────────────┐
  │                        ЖАР-ПТИЦА (FIREBIRD) AGENT                           │
  │                     WebArena Champion Architecture                          │
  ├─────────────────────────────────────────────────────────────────────────────┤
  │                                                                             │
  │  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐  │
  │  │ PERCEPTION  │───▶│  REASONING  │───▶│   ACTION    │───▶│VERIFICATION │  │
  │  │   Module    │    │   Module    │    │   Module    │    │   Module    │  │
  │  └─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘  │
  │        │                  │                  │                  │          │
  │        ▼                  ▼                  ▼                  ▼          │
  │  ┌─────────────────────────────────────────────────────────────────────┐   │
  │  │                      WORKING MEMORY                                 │   │
  │  │  • Observation History (compressed)                                 │   │
  │  │  • Action History                                                   │   │
  │  │  • Site-Specific Context                                            │   │
  │  │  • Task Goal & Sub-goals                                            │   │
  │  └─────────────────────────────────────────────────────────────────────┘   │
  │                                                                             │
  │  ┌─────────────────────────────────────────────────────────────────────┐   │
  │  │                    SITE KNOWLEDGE BASE                              │   │
  │  │  • Shopping: cart, checkout, search patterns                        │   │
  │  │  • Reddit: post, comment, vote patterns                             │   │
  │  │  • GitLab: repo, issue, merge request patterns                      │   │
  │  │  • Map: search, directions, POI patterns                            │   │
  │  │  • Wikipedia: search, navigation patterns                           │   │
  │  └─────────────────────────────────────────────────────────────────────┘   │
  │                                                                             │
  │  ┌─────────────────────────────────────────────────────────────────────┐   │
  │  │                    FPGA ACCELERATION (Optional)                     │   │
  │  │  • Vision preprocessing: <10ms                                      │   │
  │  │  • Element matching: <5ms                                           │   │
  │  │  • Ternary inference: 5x faster                                     │   │
  │  └─────────────────────────────────────────────────────────────────────┘   │
  │                                                                             │
  │  φ² + 1/φ² = 3 | PHOENIX = 999 | TARGET: 75%+ WebArena                     │
  └─────────────────────────────────────────────────────────────────────────────┘

# ═══════════════════════════════════════════════════════════════════════════════
# KEY DIFFERENTIATORS vs OpenAI Operator
# ═══════════════════════════════════════════════════════════════════════════════

differentiators:
  - name: "Site-Specific Knowledge Adaptation"
    description: "Pre-loaded patterns for each WebArena site"
    impact: "+10% accuracy"
  
  - name: "Progressive Observation Summarization"
    description: "Compress long histories while preserving key info"
    impact: "+5% on long-horizon tasks"
  
  - name: "Verification Loop"
    description: "Check action effects before proceeding"
    impact: "+3% by catching failures early"
  
  - name: "FPGA Acceleration (Optional)"
    description: "Hardware-accelerated perception"
    impact: "10x faster screenshot analysis"
  
  - name: "Stuck Detection & Recovery"
    description: "Detect loops and apply recovery strategies"
    impact: "+2% by avoiding infinite loops"
