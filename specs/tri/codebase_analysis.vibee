# ═══════════════════════════════════════════════════════════════════════════════
# CODEBASE ANALYSIS SPECIFICATION
# TRI - TRINITY Terminal Interface
# Sacred Formula: V = n × 3^k × π^m × φ^p × e^q
# Golden Identity: φ² + 1/φ² = 3
# ═══════════════════════════════════════════════════════════════════════════════

name: codebase_analysis
version: "1.0.0"
language: tri
module: codebase

sacred_constants:
  phi: 1.618033988749895
  trinity: 3.0
  phoenix: 999

creation_pattern:
  source: ProjectDirectory
  transformer: CodebaseAnalyzer
  result: ProjectIndex

# ═══════════════════════════════════════════════════════════════════════════════
# TYPES
# ═══════════════════════════════════════════════════════════════════════════════

types:
  Language:
    enum:
      - zig
      - go
      - python
      - javascript
      - typescript
      - rust
      - vibee
      - tri
      - unknown

  ProjectType:
    enum:
      - library
      - application
      - cli
      - web
      - api
      - monorepo

  FileIndex:
    fields:
      path: String
      language: Language
      lines: Int
      functions: List<FunctionInfo>
      imports: List<String>
      exports: List<String>
      last_modified: Timestamp

  FunctionInfo:
    fields:
      name: String
      line: Int
      params: List<String>
      return_type: Option<String>
      is_public: Bool
      doc_comment: Option<String>

  ProjectIndex:
    fields:
      root: String
      name: String
      type: ProjectType
      languages: List<Language>
      files: List<FileIndex>
      dependencies: List<Dependency>
      entry_points: List<String>
      test_files: List<String>
      total_lines: Int
      total_functions: Int

  Dependency:
    fields:
      name: String
      version: String
      source: String  # npm, pip, go.mod, etc.

  AnalysisResult:
    fields:
      project: ProjectIndex
      issues: List<Issue>
      suggestions: List<Suggestion>
      metrics: CodeMetrics

  Issue:
    fields:
      severity: Severity
      file: String
      line: Int
      message: String
      rule: String

  Severity:
    enum:
      - error
      - warning
      - info
      - hint

  Suggestion:
    fields:
      type: SuggestionType
      description: String
      file: Option<String>
      confidence: Float

  SuggestionType:
    enum:
      - refactor
      - performance
      - security
      - style
      - documentation

  CodeMetrics:
    fields:
      total_files: Int
      total_lines: Int
      code_lines: Int
      comment_lines: Int
      blank_lines: Int
      functions: Int
      complexity: Float
      test_coverage: Option<Float>

# ═══════════════════════════════════════════════════════════════════════════════
# BEHAVIORS
# ═══════════════════════════════════════════════════════════════════════════════

behaviors:
  - name: detect_project
    given: Directory path
    when: Analyzer starts
    then: Detect project type and languages
    test_cases:
      - name: detect_zig_project
        input:
          path: "/workspaces/vibee-lang/src/vibeec"
        expected:
          languages: contains(zig)
          type: library or cli
      - name: detect_vibee_project
        input:
          path: "/workspaces/vibee-lang"
        expected:
          languages: contains(vibee)
          languages: contains(zig)

  - name: index_files
    given: Project root
    when: Index requested
    then: Build file index with functions
    test_cases:
      - name: index_zig_files
        input:
          path: "/workspaces/vibee-lang/src/vibeec"
          filter: "*.zig"
        expected:
          files: not_empty
          functions: not_empty

  - name: find_entry_points
    given: Project index
    when: Entry points requested
    then: Return main files and exports
    test_cases:
      - name: find_main
        input:
          path: "/workspaces/vibee-lang/src/vibeec"
        expected:
          entry_points: contains("main.zig") or contains("build.zig")

  - name: analyze_dependencies
    given: Project root
    when: Dependencies requested
    then: Parse dependency files
    test_cases:
      - name: parse_build_zig
        input:
          path: "/workspaces/vibee-lang/src/vibeec"
        expected:
          dependencies: list

  - name: calculate_metrics
    given: Project index
    when: Metrics requested
    then: Calculate code metrics
    test_cases:
      - name: count_lines
        input:
          path: "/workspaces/vibee-lang/src/vibeec"
        expected:
          total_lines: greater_than(1000)
          functions: greater_than(100)

# ═══════════════════════════════════════════════════════════════════════════════
# COMMANDS
# ═══════════════════════════════════════════════════════════════════════════════

commands:
  - name: "tri analyze"
    usage: "tri analyze [path] [--full] [--json]"
    description: "Analyze codebase structure"
    examples:
      - "tri analyze"
      - "tri analyze src/"
      - "tri analyze --full --json"

  - name: "tri index"
    usage: "tri index [path] [--rebuild]"
    description: "Build/rebuild project index"
    examples:
      - "tri index"
      - "tri index --rebuild"

  - name: "tri find"
    usage: "tri find <symbol> [--type func|type|var]"
    description: "Find symbol in codebase"
    examples:
      - "tri find main"
      - "tri find Parser --type type"

  - name: "tri deps"
    usage: "tri deps [--tree] [--outdated]"
    description: "Show dependencies"
    examples:
      - "tri deps"
      - "tri deps --tree"

  - name: "tri metrics"
    usage: "tri metrics [path] [--format table|json]"
    description: "Show code metrics"
    examples:
      - "tri metrics"
      - "tri metrics src/ --format json"

  - name: "tri structure"
    usage: "tri structure [path] [--depth N]"
    description: "Show project structure"
    examples:
      - "tri structure"
      - "tri structure --depth 3"

# ═══════════════════════════════════════════════════════════════════════════════
# LANGUAGE DETECTION
# ═══════════════════════════════════════════════════════════════════════════════

language_detection:
  by_extension:
    ".zig": zig
    ".go": go
    ".py": python
    ".js": javascript
    ".ts": typescript
    ".rs": rust
    ".vibee": vibee
    ".tri": tri
    ".999": tri

  by_file:
    "build.zig": zig
    "go.mod": go
    "requirements.txt": python
    "package.json": javascript
    "Cargo.toml": rust

  by_content:
    - pattern: "const std = @import"
      language: zig
    - pattern: "package main"
      language: go
    - pattern: "def __init__"
      language: python
    - pattern: "sacred_constants:"
      language: vibee

# ═══════════════════════════════════════════════════════════════════════════════
# IGNORE PATTERNS
# ═══════════════════════════════════════════════════════════════════════════════

ignore_patterns:
  directories:
    - node_modules
    - __pycache__
    - .git
    - .vscode
    - zig-cache
    - zig-out
    - target
    - dist
    - build
    - vendor

  files:
    - "*.lock"
    - "*.log"
    - ".DS_Store"
    - "*.pyc"
    - "*.o"
    - "*.a"

# ═══════════════════════════════════════════════════════════════════════════════
# PAS PREDICTIONS
# ═══════════════════════════════════════════════════════════════════════════════

pas_predictions:
  - target: "Index Build Time"
    current: "O(n) file scan"
    predicted: "Incremental indexing O(changed)"
    confidence: 0.85
    patterns: [PRE, D&C]
    timeline: "2026"

  - target: "Symbol Search"
    current: "Linear search"
    predicted: "Trie + fuzzy matching"
    confidence: 0.80
    patterns: [PRE, HSH]
    timeline: "2026"

  - target: "Semantic Analysis"
    current: "Syntax only"
    predicted: "ML-powered semantic understanding"
    confidence: 0.60
    patterns: [MLS]
    timeline: "2027"
