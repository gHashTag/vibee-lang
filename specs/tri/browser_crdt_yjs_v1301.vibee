# VIBEE Specification: Yjs CRDT Integration v1301
# YOLO XV - Production Ascension
# Based on: Yjs (Kevin Jahns), Eg-walker (Kleppmann 2024)

name: browser_crdt_yjs
version: "1301"
language: zig
module: browser_crdt_yjs

types:
  YDoc:
    fields:
      guid: String
      gc: Bool
      client_id: Int
      share: Map
      store: YStore
      subdocs: List
      transaction_handlers: List
      update_handlers: List

  YStore:
    fields:
      clients: Map
      pending_structs: List
      pending_ds: List

  YText:
    fields:
      doc: String
      start: YItem
      length: Int
      search_marker: List

  YArray:
    fields:
      doc: String
      start: YItem
      length: Int
      preliminary_content: List

  YMap:
    fields:
      doc: String
      map: Map
      preliminary_content: Map

  YItem:
    fields:
      id: YID
      left: String
      right: String
      origin: String
      right_origin: String
      parent: String
      parent_sub: String
      content: YContent
      deleted: Bool
      marker: Bool

  YID:
    fields:
      client: Int
      clock: Int

  YContent:
    fields:
      content_type: String
      value: String
      length: Int

  YTransaction:
    fields:
      doc: String
      local: Bool
      origin: String
      before_state: Map
      after_state: Map
      changed: Map
      changed_parent_types: Map
      deleted_structs: List
      meta: Map

  YUpdate:
    fields:
      structs: List
      ds: List
      encoded: String

  YAwareness:
    fields:
      doc: String
      client_id: Int
      states: Map
      meta: Map

  YUndoManager:
    fields:
      scope: List
      tracked_origins: List
      undo_stack: List
      redo_stack: List
      undoing: Bool
      redoing: Bool

behaviors:
  - name: create_ydoc
    given: "Configuration options"
    when: "Creating new Y.Doc"
    then: "Returns initialized YDoc with unique client ID"

  - name: create_ytext
    given: "YDoc instance"
    when: "Creating shared text type"
    then: "Returns YText bound to document"

  - name: create_yarray
    given: "YDoc instance"
    when: "Creating shared array type"
    then: "Returns YArray bound to document"

  - name: create_ymap
    given: "YDoc instance"
    when: "Creating shared map type"
    then: "Returns YMap bound to document"

  - name: ytext_insert
    given: "YText, index, content"
    when: "Inserting text at position"
    then: "Creates YItem, updates structure, broadcasts update"

  - name: ytext_delete
    given: "YText, index, length"
    when: "Deleting text range"
    then: "Marks items as deleted, updates length"

  - name: ytext_format
    given: "YText, index, length, attributes"
    when: "Applying formatting"
    then: "Creates format markers with attributes"

  - name: yarray_insert
    given: "YArray, index, content"
    when: "Inserting elements"
    then: "Creates YItems for each element"

  - name: yarray_delete
    given: "YArray, index, length"
    when: "Deleting elements"
    then: "Marks items as deleted"

  - name: ymap_set
    given: "YMap, key, value"
    when: "Setting key-value pair"
    then: "Creates or updates YItem for key"

  - name: ymap_delete
    given: "YMap, key"
    when: "Deleting key"
    then: "Marks item as deleted"

  - name: apply_update
    given: "YDoc, encoded update"
    when: "Receiving remote update"
    then: "Decodes, integrates structs, triggers handlers"

  - name: encode_state_as_update
    given: "YDoc, optional target state vector"
    when: "Encoding document state"
    then: "Returns encoded update for sync"

  - name: encode_state_vector
    given: "YDoc"
    when: "Getting state vector"
    then: "Returns map of client -> clock"

  - name: merge_updates
    given: "List of encoded updates"
    when: "Combining multiple updates"
    then: "Returns single merged update"

  - name: diff_update
    given: "Update, state vector"
    when: "Computing differential update"
    then: "Returns update containing only missing structs"

  - name: create_awareness
    given: "YDoc"
    when: "Creating awareness instance"
    then: "Returns YAwareness for presence tracking"

  - name: set_local_state
    given: "YAwareness, state object"
    when: "Updating local presence"
    then: "Broadcasts awareness update to peers"

  - name: apply_awareness_update
    given: "YAwareness, encoded update, origin"
    when: "Receiving awareness update"
    then: "Updates states map, triggers handlers"

  - name: create_undo_manager
    given: "YDoc, scope types"
    when: "Creating undo manager"
    then: "Returns YUndoManager tracking changes"

  - name: undo
    given: "YUndoManager"
    when: "Undoing last change"
    then: "Reverts to previous state"

  - name: redo
    given: "YUndoManager"
    when: "Redoing undone change"
    then: "Reapplies reverted change"

creation_pattern:
  source: YDoc
  transformer: YjsCRDT
  result: SynchronizedDocument

scientific_references:
  - author: "Kevin Jahns"
    title: "Yjs: A CRDT Framework"
    year: 2019
    url: "https://github.com/yjs/yjs"
  - author: "Gentle, Kleppmann"
    title: "Eg-walker: Better, Faster, Smaller"
    venue: "EuroSys 2025"
    year: 2024
    arxiv: "2409.14252"
  - author: "Shapiro et al."
    title: "Conflict-free Replicated Data Types"
    venue: "SSS 2011"
    year: 2011

test_cases:
  - name: test_ytext_concurrent_insert
    input:
      doc1_insert: {index: 0, text: "Hello"}
      doc2_insert: {index: 0, text: "World"}
    expected:
      merged: "HelloWorld or WorldHello"
      convergent: true

  - name: test_ytext_delete_insert_conflict
    input:
      doc1_delete: {index: 0, length: 5}
      doc2_insert: {index: 2, text: "X"}
    expected:
      convergent: true

  - name: test_awareness_presence
    input:
      user1: {cursor: 10, name: "Alice"}
      user2: {cursor: 20, name: "Bob"}
    expected:
      states_count: 2

  - name: test_undo_redo
    input:
      initial: "Hello"
      insert: " World"
      undo: true
    expected:
      after_undo: "Hello"

  - name: test_state_vector_sync
    input:
      doc1_state: {client1: 5}
      doc2_state: {client1: 3, client2: 2}
    expected:
      diff_contains: "client1 ops 4-5"

  - name: test_merge_updates
    input:
      update1: "encoded_update_1"
      update2: "encoded_update_2"
    expected:
      merged_valid: true

  - name: test_subdoc_sync
    input:
      parent_doc: "main"
      subdoc: "nested"
    expected:
      synced: true

  - name: test_gc_collection
    input:
      deleted_items: 100
      gc_enabled: true
    expected:
      items_collected: true
