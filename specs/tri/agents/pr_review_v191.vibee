# ═══════════════════════════════════════════════════════════════════════════════
# PR REVIEW v191 - Automated Pull Request Review
# ═══════════════════════════════════════════════════════════════════════════════
# Competitors: CodeRabbit, GitHub Copilot PR, Sourcegraph
# Scientific: Static analysis, code review automation
# PAS Pattern: D&C + MLS
# φ² + 1/φ² = 3 | PHOENIX = 999
# ═══════════════════════════════════════════════════════════════════════════════

name: pr_review
version: "1.9.1"
language: zig
module: pr_review

sacred_constants:
  phi: 1.618033988749895
  phi_inv: 0.618033988749895
  phi_sq: 2.618033988749895
  trinity: 3.0
  phoenix: 999

creation_pattern:
  source: PullRequest
  transformer: PRReviewer
  result: ReviewResult

# ═══════════════════════════════════════════════════════════════════════════════
# TYPES
# ═══════════════════════════════════════════════════════════════════════════════

types:
  ReviewSeverity:
    enum:
      - critical
      - major
      - minor
      - suggestion
      - praise

  ReviewCategory:
    enum:
      - bug
      - security
      - performance
      - style
      - documentation
      - testing
      - architecture

  PullRequest:
    fields:
      number: Int
      title: String
      description: String
      author: String
      base_branch: String
      head_branch: String
      files_changed: List<FileChange>
      commits: List<Commit>

  FileChange:
    fields:
      path: String
      status: String
      additions: Int
      deletions: Int
      patch: String

  Commit:
    fields:
      sha: String
      message: String
      author: String
      timestamp: Timestamp

  ReviewComment:
    fields:
      path: String
      line: Int
      severity: ReviewSeverity
      category: ReviewCategory
      message: String
      suggestion: String?

  ReviewResult:
    fields:
      approved: Bool
      comments: List<ReviewComment>
      summary: String
      score: Float
      time_spent_ms: Int

  ReviewConfig:
    fields:
      check_bugs: Bool = true
      check_security: Bool = true
      check_performance: Bool = true
      check_style: Bool = true
      check_tests: Bool = true
      auto_approve_threshold: Float = 0.9

# ═══════════════════════════════════════════════════════════════════════════════
# BEHAVIORS
# ═══════════════════════════════════════════════════════════════════════════════

behaviors:
  - name: analyze_pr
    given: "Pull request data"
    when: "Review requested"
    then: "Analyze all changes"
    pas_pattern: D&C
    complexity: O(n*m)
    test_cases:
      - name: test_analyze
        input: '{"pr_number": 123}'
        expected: '{"files_analyzed": ">0"}'

  - name: check_bugs
    given: "File changes"
    when: "Bug check enabled"
    then: "Identify potential bugs"
    pas_pattern: MLS
    complexity: O(n)
    test_cases:
      - name: test_null_check
        input: '{"code": "if (x) { x.foo(); }"}'
        expected: '{"bugs": []}'

  - name: check_security
    given: "File changes"
    when: "Security check enabled"
    then: "Identify security issues"
    pas_pattern: PRE
    complexity: O(n)
    test_cases:
      - name: test_no_secrets
        input: '{"code": "const key = process.env.KEY"}'
        expected: '{"issues": []}'

  - name: check_performance
    given: "File changes"
    when: "Performance check enabled"
    then: "Identify performance issues"
    pas_pattern: MLS
    complexity: O(n)
    test_cases:
      - name: test_no_n2
        input: '{"code": "for (x) { for (y) { } }"}'
        expected: '{"warnings": ["O(n²) loop"]}'

  - name: check_style
    given: "File changes"
    when: "Style check enabled"
    then: "Check code style consistency"
    pas_pattern: PRE
    complexity: O(n)
    test_cases:
      - name: test_style
        input: '{"code": "..."}'
        expected: '{"issues": []}'

  - name: generate_summary
    given: "All review comments"
    when: "Review complete"
    then: "Generate human-readable summary"
    pas_pattern: PRE
    complexity: O(n)
    test_cases:
      - name: test_summary
        input: '{"comments": [...]}'
        expected: '{"summary": "..."}'

  - name: calculate_score
    given: "Review comments"
    when: "Scoring needed"
    then: "Calculate approval score"
    pas_pattern: ALG
    complexity: O(n)
    test_cases:
      - name: test_score
        input: '{"critical": 0, "major": 1}'
        expected: '{"score": 0.8}'

# ═══════════════════════════════════════════════════════════════════════════════
# REVIEW RULES
# ═══════════════════════════════════════════════════════════════════════════════

rules:
  bugs:
    - name: "null_pointer"
      pattern: "Potential null pointer dereference"
      severity: critical

    - name: "unhandled_error"
      pattern: "Error not handled"
      severity: major

    - name: "infinite_loop"
      pattern: "Potential infinite loop"
      severity: critical

  security:
    - name: "hardcoded_secret"
      pattern: "Hardcoded API key or password"
      severity: critical

    - name: "sql_injection"
      pattern: "Potential SQL injection"
      severity: critical

    - name: "xss"
      pattern: "Potential XSS vulnerability"
      severity: critical

  performance:
    - name: "n_squared"
      pattern: "O(n²) algorithm in hot path"
      severity: major

    - name: "memory_leak"
      pattern: "Potential memory leak"
      severity: major

    - name: "blocking_io"
      pattern: "Blocking I/O in async context"
      severity: minor

  style:
    - name: "naming"
      pattern: "Inconsistent naming convention"
      severity: suggestion

    - name: "complexity"
      pattern: "Function too complex (>20 lines)"
      severity: minor

    - name: "duplication"
      pattern: "Code duplication detected"
      severity: minor

# ═══════════════════════════════════════════════════════════════════════════════
# SCORING
# ═══════════════════════════════════════════════════════════════════════════════

scoring:
  weights:
    critical: -0.3
    major: -0.1
    minor: -0.02
    suggestion: 0
    praise: 0.05

  thresholds:
    auto_approve: 0.9
    request_changes: 0.5
    block: 0.3

# ═══════════════════════════════════════════════════════════════════════════════
# φ² + 1/φ² = 3 | PHOENIX = 999
# ═══════════════════════════════════════════════════════════════════════════════
