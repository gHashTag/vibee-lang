# ═══════════════════════════════════════════════════════════════════════════════
# VIBEE BROWSER AGENT - Интеллектуальный браузерный помощник
# ═══════════════════════════════════════════════════════════════════════════════
# Священная формула: V = n × 3^k × π^m × φ^p × e^q
# Золотая идентичность: φ² + 1/φ² = 3
# PHOENIX = 999
# ═══════════════════════════════════════════════════════════════════════════════

name: browser_agent_vibee
version: "1.0.0"
language: zig
module: browser_agent

sacred_constants:
  phi: 1.618033988749895
  trinity: 3.0
  phoenix: 999

creation_pattern:
  source: ПользовательскийЗапрос
  transformer: БраузерныйАгент
  result: ВыполненнаяЗадача

# ═══════════════════════════════════════════════════════════════════════════════
# ОПИСАНИЕ АГЕНТА
# ═══════════════════════════════════════════════════════════════════════════════
#
# Vibee Browser Agent - это интеллектуальный помощник для автоматизации
# браузерных задач. Он может:
#
# 1. НАВИГАЦИЯ
#    - Открывать любые веб-страницы
#    - Переходить по ссылкам
#    - Работать с историей браузера
#
# 2. ВЗАИМОДЕЙСТВИЕ
#    - Кликать по элементам
#    - Заполнять формы
#    - Загружать/скачивать файлы
#
# 3. ИЗВЛЕЧЕНИЕ ДАННЫХ
#    - Парсить контент страниц
#    - Делать скриншоты
#    - Сохранять PDF
#
# 4. АВТОМАТИЗАЦИЯ
#    - Выполнять сценарии
#    - Мониторить изменения
#    - Работать с API
#
# ═══════════════════════════════════════════════════════════════════════════════

types:
  # Фазы работы агента (Agent workflow phases)
  AgentPhase:
    enum:
      - understanding
      - planning
      - execution
      - verification
      - report

  # Типы браузерных задач (Browser task types)
  BrowserTaskType:
    enum:
      - navigation
      - search
      - form_fill
      - data_extraction
      - screenshot
      - download
      - monitoring
      - automation

  # Конфигурация агента (Agent configuration)
  AgentConfig:
    fields:
      name: String
      language: String
      headless: Bool
      timeout_sec: Int
      max_retries: Int
      user_agent: String

  # Запрос пользователя (User request)
  UserRequest:
    fields:
      request_id: String
      text: String
      task_type: String
      url: Option<String>
      params: Map<String, String>
      timestamp: Timestamp

  # План выполнения (Execution plan)
  ExecutionPlan:
    fields:
      plan_id: String
      steps: List<PlanStep>
      estimated_time_sec: Int
      risks: List<String>

  # Шаг плана (Plan step)
  PlanStep:
    fields:
      step_id: String
      number: Int
      action: String
      selector: Option<String>
      data: Option<String>
      wait_for: String

  # Результат выполнения (Execution result)
  ExecutionResult:
    fields:
      result_id: String
      success: Bool
      data: String
      screenshot: Option<String>
      error: Option<String>
      time_ms: Int

  # Состояние страницы (Page state)
  PageState:
    fields:
      url: String
      title: String
      content: String
      elements: List<PageElement>
      cookies: List<Cookie>

  # Элемент страницы (Page element)
  PageElement:
    fields:
      selector: String
      tag: String
      text: String
      visible: Bool
      clickable: Bool

  # Cookie
  Cookie:
    fields:
      name: String
      value: String
      domain: String
      path: String
      expires: Timestamp

  # Сценарий автоматизации (Automation script)
  AutomationScript:
    fields:
      script_id: String
      title: String
      description: String
      steps: List<ScriptStep>
      variables: Map<String, String>

  # Шаг сценария (Script step)
  ScriptStep:
    fields:
      step_type: String
      target: String
      value: Option<String>
      condition: Option<String>
      timeout_ms: Int

  # Отчёт о выполнении (Execution report)
  ExecutionReport:
    fields:
      report_id: String
      request: String
      plan: String
      results: List<StepResult>
      summary: String
      recommendations: List<String>

  # Результат шага (Step result)
  StepResult:
    fields:
      step: Int
      action: String
      status: String
      time_ms: Int
      screenshot: Option<String>

  # Мониторинг страницы (Page monitor)
  PageMonitor:
    fields:
      monitor_id: String
      url: String
      selector: String
      interval_sec: Int
      condition: String
      callback: String

  # Извлечённые данные (Extracted data)
  ExtractedData:
    fields:
      source: String
      data_type: String
      data: String
      format: String
      timestamp: Timestamp

  # Сессия браузера (Browser session)
  BrowserSession:
    fields:
      session_id: String
      pages: List<PageState>
      history: List<String>
      created_at: Timestamp

behaviors:
  # ═══════════════════════════════════════════════════════════════════════════
  # ФАЗА 1: ПОНИМАНИЕ ЗАДАЧИ
  # ═══════════════════════════════════════════════════════════════════════════
  
  - name: понять_запрос
    given: "Текстовый запрос пользователя"
    when: "Получен новый запрос"
    then: "Определён тип задачи и параметры"
    description: |
      Анализирует запрос пользователя на естественном языке
      и определяет тип браузерной задачи.
      
      Примеры запросов:
      - "Открой сайт google.com"
      - "Найди информацию о погоде в Москве"
      - "Заполни форму регистрации"
      - "Сделай скриншот страницы"
      - "Скачай файл по ссылке"
    test_cases:
      - name: понять_навигацию
        input: "Открой сайт example.com"
        expected: "тип: навигация, url: example.com"
      - name: понять_поиск
        input: "Найди рецепт борща"
        expected: "тип: поиск, запрос: рецепт борща"

  - name: уточнить_детали
    given: "Неполный или неясный запрос"
    when: "Требуется уточнение"
    then: "Заданы уточняющие вопросы"
    description: |
      Если запрос неполный, агент задаёт уточняющие вопросы:
      - Какой именно сайт?
      - Какие данные нужны?
      - В каком формате сохранить?
    test_cases:
      - name: уточнить_url
        input: "Открой сайт"
        expected: "вопрос: Какой сайт открыть?"

  # ═══════════════════════════════════════════════════════════════════════════
  # ФАЗА 2: ПЛАНИРОВАНИЕ
  # ═══════════════════════════════════════════════════════════════════════════

  - name: составить_план
    given: "Понятая задача"
    when: "Начало планирования"
    then: "Создан план выполнения"
    description: |
      Создаёт пошаговый план выполнения задачи:
      1. Определяет последовательность действий
      2. Оценивает время выполнения
      3. Выявляет возможные риски
    test_cases:
      - name: план_навигации
        input: "навигация на example.com"
        expected: "план с 3 шагами"

  - name: оценить_риски
    given: "План выполнения"
    when: "Анализ рисков"
    then: "Список потенциальных проблем"
    description: |
      Оценивает риски:
      - Недоступность сайта
      - Изменение структуры страницы
      - Капча или блокировка
      - Таймауты
    test_cases:
      - name: риски_формы
        input: "заполнение формы"
        expected: "риски: капча, валидация"

  # ═══════════════════════════════════════════════════════════════════════════
  # ФАЗА 3: ВЫПОЛНЕНИЕ
  # ═══════════════════════════════════════════════════════════════════════════

  - name: открыть_страницу
    given: "URL страницы"
    when: "Команда навигации"
    then: "Страница загружена"
    description: |
      Открывает веб-страницу и ждёт полной загрузки.
      Поддерживает различные режимы ожидания:
      - load - базовая загрузка
      - domcontentloaded - DOM готов
      - networkidle - сеть неактивна
    test_cases:
      - name: открыть_google
        input: "https://google.com"
        expected: "страница загружена"

  - name: найти_элемент
    given: "Селектор элемента"
    when: "Поиск на странице"
    then: "Элемент найден или ошибка"
    description: |
      Находит элемент на странице по селектору:
      - CSS селектор: #id, .class, tag
      - XPath: //div[@class='name']
      - Текст: text=Кнопка
      - Роль: role=button
    test_cases:
      - name: найти_кнопку
        input: "button.submit"
        expected: "элемент найден"

  - name: кликнуть
    given: "Найденный элемент"
    when: "Команда клика"
    then: "Клик выполнен"
    description: |
      Выполняет клик по элементу:
      - Обычный клик
      - Двойной клик
      - Правый клик
      - Клик с модификаторами (Ctrl, Shift)
    test_cases:
      - name: клик_кнопки
        input: "button.submit"
        expected: "клик выполнен"

  - name: ввести_текст
    given: "Поле ввода и текст"
    when: "Команда ввода"
    then: "Текст введён"
    description: |
      Вводит текст в поле:
      - Посимвольный ввод с задержкой
      - Мгновенная вставка
      - Очистка перед вводом
    test_cases:
      - name: ввод_email
        input: "input#email, test@example.com"
        expected: "текст введён"

  - name: заполнить_форму
    given: "Данные формы"
    when: "Команда заполнения"
    then: "Форма заполнена"
    description: |
      Заполняет форму целиком:
      - Текстовые поля
      - Чекбоксы
      - Радиокнопки
      - Выпадающие списки
      - Загрузка файлов
    test_cases:
      - name: форма_регистрации
        input: "форма с 5 полями"
        expected: "все поля заполнены"

  - name: извлечь_данные
    given: "Селектор данных"
    when: "Команда извлечения"
    then: "Данные извлечены"
    description: |
      Извлекает данные со страницы:
      - Текст элементов
      - Атрибуты
      - Таблицы
      - Списки
      - Изображения
    test_cases:
      - name: извлечь_таблицу
        input: "table.data"
        expected: "данные таблицы"

  - name: сделать_скриншот
    given: "Параметры скриншота"
    when: "Команда скриншота"
    then: "Скриншот сохранён"
    description: |
      Делает скриншот:
      - Видимая область
      - Полная страница
      - Конкретный элемент
      - С задержкой
    test_cases:
      - name: скриншот_страницы
        input: "fullPage: true"
        expected: "скриншот сохранён"

  - name: скачать_файл
    given: "URL файла"
    when: "Команда скачивания"
    then: "Файл скачан"
    description: |
      Скачивает файл:
      - По прямой ссылке
      - Через клик по кнопке
      - С авторизацией
    test_cases:
      - name: скачать_pdf
        input: "https://example.com/file.pdf"
        expected: "файл скачан"

  - name: выполнить_скрипт
    given: "JavaScript код"
    when: "Команда выполнения"
    then: "Скрипт выполнен"
    description: |
      Выполняет JavaScript на странице:
      - Получение данных
      - Модификация DOM
      - Вызов функций
    test_cases:
      - name: получить_title
        input: "document.title"
        expected: "заголовок страницы"

  # ═══════════════════════════════════════════════════════════════════════════
  # ФАЗА 4: ПРОВЕРКА
  # ═══════════════════════════════════════════════════════════════════════════

  - name: проверить_результат
    given: "Выполненное действие"
    when: "Проверка результата"
    then: "Результат подтверждён или ошибка"
    description: |
      Проверяет успешность выполнения:
      - Элемент появился/исчез
      - URL изменился
      - Текст соответствует
      - Файл скачан
    test_cases:
      - name: проверить_навигацию
        input: "ожидаемый URL"
        expected: "URL совпадает"

  - name: обработать_ошибку
    given: "Ошибка выполнения"
    when: "Возникла ошибка"
    then: "Ошибка обработана"
    description: |
      Обрабатывает ошибки:
      - Повторная попытка
      - Альтернативный путь
      - Уведомление пользователя
    test_cases:
      - name: повторить_при_таймауте
        input: "timeout error"
        expected: "повторная попытка"

  # ═══════════════════════════════════════════════════════════════════════════
  # ФАЗА 5: ОТЧЁТ
  # ═══════════════════════════════════════════════════════════════════════════

  - name: сформировать_отчёт
    given: "Результаты выполнения"
    when: "Задача завершена"
    then: "Отчёт сформирован"
    description: |
      Формирует отчёт о выполнении:
      - Что было сделано
      - Какие данные получены
      - Сколько времени заняло
      - Рекомендации
    test_cases:
      - name: отчёт_поиска
        input: "результаты поиска"
        expected: "отчёт с данными"

  - name: предложить_следующие_шаги
    given: "Завершённая задача"
    when: "Формирование рекомендаций"
    then: "Список рекомендаций"
    description: |
      Предлагает следующие действия:
      - Сохранить данные
      - Продолжить поиск
      - Автоматизировать задачу
    test_cases:
      - name: рекомендации
        input: "извлечённые данные"
        expected: "список рекомендаций"

  # ═══════════════════════════════════════════════════════════════════════════
  # СПЕЦИАЛЬНЫЕ ВОЗМОЖНОСТИ
  # ═══════════════════════════════════════════════════════════════════════════

  - name: мониторить_страницу
    given: "URL и условие"
    when: "Запуск мониторинга"
    then: "Мониторинг активен"
    description: |
      Мониторит изменения на странице:
      - Появление элемента
      - Изменение текста
      - Изменение цены
      - Доступность товара
    test_cases:
      - name: мониторинг_цены
        input: "селектор цены, интервал 60с"
        expected: "мониторинг запущен"

  - name: создать_сценарий
    given: "Последовательность действий"
    when: "Запись сценария"
    then: "Сценарий сохранён"
    description: |
      Создаёт сценарий автоматизации:
      - Запись действий
      - Параметризация
      - Условия и циклы
    test_cases:
      - name: сценарий_входа
        input: "действия входа"
        expected: "сценарий сохранён"

  - name: выполнить_сценарий
    given: "Сохранённый сценарий"
    when: "Запуск сценария"
    then: "Сценарий выполнен"
    description: |
      Выполняет сохранённый сценарий:
      - С параметрами
      - В цикле
      - По расписанию
    test_cases:
      - name: запуск_сценария
        input: "сценарий входа"
        expected: "сценарий выполнен"

  - name: работать_с_api
    given: "API endpoint"
    when: "API запрос"
    then: "Ответ получен"
    description: |
      Работает с API:
      - GET/POST/PUT/DELETE запросы
      - Авторизация
      - Обработка ответов
    test_cases:
      - name: api_get
        input: "GET /api/data"
        expected: "данные получены"

# ═══════════════════════════════════════════════════════════════════════════════
# PAS DAEMON ОПТИМИЗАЦИИ
# ═══════════════════════════════════════════════════════════════════════════════

pas_optimizations:
  PRE_кэширование:
    описание: "Кэширование DOM запросов и сетевых ответов"
    ускорение: "3x для повторных запросов"
    реализация: "LRU кэш с TTL"
    
  DC_параллельные_вкладки:
    описание: "Параллельные операции в разных вкладках"
    ускорение: "Линейное с количеством вкладок"
    реализация: "Пул воркеров для вкладок"
    
  MLS_умные_селекторы:
    описание: "ML-генерация надёжных селекторов"
    ускорение: "2x надёжность селекторов"
    реализация: "Обучение на DOM паттернах"
    
  HSH_поиск_элементов:
    описание: "Хэш-кэширование элементов"
    ускорение: "O(1) поиск элементов"
    реализация: "Хэш-таблица ID элементов"

# ═══════════════════════════════════════════════════════════════════════════════
# ПРИМЕРЫ ИСПОЛЬЗОВАНИЯ
# ═══════════════════════════════════════════════════════════════════════════════

examples:
  пример_1:
    запрос: "Открой google.com и найди информацию о погоде в Москве"
    план:
      - "Открыть google.com"
      - "Найти поле поиска"
      - "Ввести 'погода Москва'"
      - "Нажать кнопку поиска"
      - "Извлечь результаты"
    результат: "Информация о погоде извлечена"
    
  пример_2:
    запрос: "Заполни форму регистрации на сайте example.com"
    план:
      - "Открыть example.com/register"
      - "Заполнить поле имени"
      - "Заполнить поле email"
      - "Заполнить поле пароля"
      - "Принять условия"
      - "Нажать кнопку регистрации"
    результат: "Регистрация выполнена"
    
  пример_3:
    запрос: "Мониторь цену товара на сайте и уведоми когда она упадёт ниже 1000"
    план:
      - "Открыть страницу товара"
      - "Найти элемент с ценой"
      - "Запустить мониторинг каждые 5 минут"
      - "При цене < 1000 уведомить"
    результат: "Мониторинг активен"

# ═══════════════════════════════════════════════════════════════════════════════
# φ² + 1/φ² = 3 | PHOENIX = 999
# ═══════════════════════════════════════════════════════════════════════════════
