# LLM Sampler - Top-p/Top-k Sampling
# φ² + 1/φ² = 3 | PHOENIX = 999

name: llm_sampler
version: "1.0.0"
language: zig
module: llm_sampler

sacred_formula:
  expression: "V = n × 3^k × π^m × φ^p"
  golden_identity: "φ² + 1/φ² = 3"

creation_pattern:
  source: Logits
  transformer: Sampler
  result: NextToken

types:
  SamplerConfig:
    fields:
      temperature: Float  # 0.7
      top_p: Float  # 0.9
      top_k: Int  # 40
      repetition_penalty: Float  # 1.1
      
  SamplerState:
    fields:
      generated_tokens: List<Int>
      token_counts: Map<Int, Int>
      
behaviors:
  - name: sample
    given: "Logits [vocab_size], config"
    when: "Sample next token"
    then: "Return sampled token ID"
    
  - name: apply_temperature
    given: "Logits, temperature"
    when: "Scale logits"
    then: "Return logits / temperature"
    
  - name: top_k_filter
    given: "Logits, k"
    when: "Keep top-k"
    then: "Set others to -inf"
    
  - name: top_p_filter
    given: "Logits, p"
    when: "Nucleus sampling"
    then: "Keep tokens until cumsum > p"
    
  - name: repetition_penalty
    given: "Logits, generated tokens, penalty"
    when: "Penalize repetition"
    then: "Divide repeated token logits by penalty"
    
  - name: greedy_decode
    given: "Logits"
    when: "Deterministic decoding"
    then: "Return argmax(logits)"
