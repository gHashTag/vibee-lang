# v4002 - Sensor Fusion
# ======================
# Multi-sensor state estimation
# φ² + 1/φ² = 3 | PHOENIX = 999

name: sensor_fusion
version: "4.0.2"
language: zig
module: sensor_fusion

constants:
  PHI: 1.618033988749895
  STATE_DIM: 12
  IMU_HZ: 200
  LIDAR_HZ: 10

types:
  SensorConfig:
    fields:
      sensor_type: String
      frequency: Int
      noise_covariance: List
      transform: List
      
  IMUReading:
    fields:
      acceleration: List
      angular_velocity: List
      timestamp: Timestamp
      
  LidarScan:
    fields:
      points: List
      intensities: List
      timestamp: Timestamp
      
  CameraFrame:
    fields:
      image: List
      depth: List
      intrinsics: List
      timestamp: Timestamp
      
  FusedState:
    fields:
      position: List
      velocity: List
      orientation: List
      covariance: List
      
  KalmanState:
    fields:
      mean: List
      covariance: List
      
  Landmark:
    fields:
      id: Int
      position: List
      descriptor: List
      
  OdometryDelta:
    fields:
      translation: List
      rotation: List
      covariance: List

behaviors:
  - name: predict_state
    given: Current state and IMU
    when: Propagating dynamics
    then: Return predicted state
    
  - name: update_with_lidar
    given: State and lidar scan
    when: Incorporating lidar
    then: Return updated state
    
  - name: update_with_camera
    given: State and camera frame
    when: Visual update
    then: Return updated state
    
  - name: compute_kalman_gain
    given: Prediction and measurement covariance
    when: Computing optimal gain
    then: Return Kalman gain
    
  - name: extract_landmarks
    given: Sensor data
    when: Feature extraction
    then: Return landmark list
    
  - name: data_association
    given: Predicted and observed landmarks
    when: Matching features
    then: Return associations
    
  - name: fuse_odometry
    given: Multiple odometry sources
    when: Combining estimates
    then: Return fused odometry
    
  - name: outlier_rejection
    given: Measurements and model
    when: Detecting outliers
    then: Return filtered measurements
