# iGLA ColBERT Index
# Token-level index for ColBERT retrieval
# Scientific basis: Khattab & Zaharia 2020, Santhanam et al. 2022
# φ² + 1/φ² = 3 | V = n × 3^k × π^m × φ^p

name: igla_colbert_index
version: "1.0.0"
language: zig
module: igla_colbert_index

sacred_constants:
  phi: 1.618033988749895
  trinity: 3.0
  phoenix: 999

scientific_references:
  - "Khattab & Zaharia 2020: ColBERT"
  - "Santhanam et al. 2022: ColBERTv2"
  - "Lin et al. 2023: How to Train Your ColBERT"

types:
  ColBERTIndexConfig:
    fields:
      dim: Int
      num_partitions: Int
      use_compression: Bool
      bits_per_dim: Int

  TokenIndex:
    fields:
      embeddings: String
      doc_ids: String
      token_positions: String
      count: Int

  PartitionedIndex:
    fields:
      partitions: String
      centroids: String
      num_partitions: Int

  DocMetadata:
    fields:
      doc_id: Int
      num_tokens: Int
      start_offset: Int

  IndexStats:
    fields:
      total_tokens: Int
      total_docs: Int
      memory_bytes: Int
      avg_tokens_per_doc: Float

  CompressionConfig:
    fields:
      residual_bits: Int
      use_centroid_residuals: Bool

behaviors:
  - name: build_index
    given: "Document encodings"
    when: "Index building"
    then: "ColBERT token index"

  - name: add_document
    given: "Doc encoding, doc_id"
    when: "Document addition"
    then: "Tokens added to index"

  - name: partition_index
    given: "Index, num_partitions"
    when: "Partitioning"
    then: "IVF-style partitioned index"

  - name: compress_residuals
    given: "Embeddings, centroids"
    when: "Residual compression"
    then: "Compressed token embeddings"

  - name: get_doc_tokens
    given: "Doc_id"
    when: "Token retrieval"
    then: "All tokens for document"

  - name: save_index
    given: "Index, path"
    when: "Persistence"
    then: "Index saved to disk"

  - name: load_index
    given: "Path"
    when: "Loading"
    then: "Index loaded from disk"

  - name: phi_partition_sizing
    given: "Total tokens"
    when: "Sacred partitioning"
    then: "φ-ratio partition sizes"
