# IGLA Patch Generator
# Generates code patches using LLM for SWE-bench tasks
# φ² + 1/φ² = 3 | PHOENIX = 999

name: igla_patch_generator
version: "1.0.0"
language: zig
module: igla_patch_generator

sacred_constants:
  phi: 1.618033988749895
  phoenix: 999
  trinity: 3

creation_pattern:
  source: SWEBenchInstance
  transformer: PatchGenerator
  result: GeneratedPatch

types:
  PatchStrategy:
    enum:
      - Direct
      - ReAct
      - ChainOfThought
      - TreeOfThought
      - Matryoshka

  GeneratorConfig:
    fields:
      strategy: String
      max_iterations: Int
      max_tokens: Int
      temperature: Float
      include_hints: Bool
      include_tests: Bool

  CodeContext:
    fields:
      file_path: String
      content: String
      start_line: Int
      end_line: Int
      language: String

  GeneratedPatch:
    fields:
      instance_id: String
      patch_content: String
      confidence: Float
      reasoning: String
      iterations: Int
      tokens_used: Int

  PatchAttempt:
    fields:
      attempt_number: Int
      patch: String
      validation_result: String
      error_message: String

  PromptTemplate:
    fields:
      name: String
      system_prompt: String
      user_template: String
      variables: List<String>

  ReActStep:
    fields:
      thought: String
      action: String
      observation: String

  FileEdit:
    fields:
      file_path: String
      old_content: String
      new_content: String
      edit_type: String

behaviors:
  - name: create_config
    given: "Strategy and parameters"
    when: "Config creation requested"
    then: "Returns GeneratorConfig"

  - name: generate_patch
    given: "SWEBenchInstance and GeneratorConfig"
    when: "Patch generation requested"
    then: "Returns GeneratedPatch"

  - name: generate_with_react
    given: "SWEBenchInstance"
    when: "ReAct strategy selected"
    then: "Returns patch using Thought-Action-Observation loop"

  - name: generate_with_cot
    given: "SWEBenchInstance"
    when: "Chain-of-Thought strategy selected"
    then: "Returns patch with step-by-step reasoning"

  - name: generate_with_matryoshka
    given: "SWEBenchInstance"
    when: "Matryoshka strategy selected"
    then: "Returns patch using φ-decomposition"

  - name: build_system_prompt
    given: "SWEBenchInstance"
    when: "System prompt needed"
    then: "Returns system prompt for SWE task"

  - name: build_user_prompt
    given: "SWEBenchInstance and CodeContext"
    when: "User prompt needed"
    then: "Returns formatted user prompt"

  - name: extract_patch_from_response
    given: "LLM response string"
    when: "Patch extraction needed"
    then: "Returns extracted diff patch"

  - name: validate_patch_syntax
    given: "Patch string"
    when: "Syntax validation requested"
    then: "Returns true if valid diff format"

  - name: locate_relevant_files
    given: "SWEBenchInstance and repo path"
    when: "File location needed"
    then: "Returns list of relevant CodeContext"

  - name: apply_patch_locally
    given: "Patch and repo path"
    when: "Local application requested"
    then: "Returns success or error"

  - name: revert_patch
    given: "Repo path"
    when: "Revert requested"
    then: "Reverts last applied patch"

  - name: iterative_refinement
    given: "Failed patch and error message"
    when: "Refinement requested"
    then: "Returns improved patch"

  - name: calculate_confidence
    given: "GeneratedPatch and validation results"
    when: "Confidence calculation requested"
    then: "Returns confidence score 0.0-1.0"

test_cases:
  - name: test_config_creation
    input:
      strategy: "ReAct"
      max_iterations: 5
    expected:
      valid: true

  - name: test_system_prompt
    input:
      repo: "django/django"
      problem: "Fix bug"
    expected:
      contains_repo: true

  - name: test_patch_extraction
    input:
      response: "```diff\n-old\n+new\n```"
    expected:
      extracted: true

  - name: test_syntax_validation
    input:
      patch: "diff --git a/file.py"
    expected:
      valid: true

  - name: test_confidence_calculation
    input:
      iterations: 1
      validated: true
    expected:
      confidence_high: true

  - name: test_matryoshka_decomposition
    input:
      problem: "Complex issue"
    expected:
      decomposed: true
