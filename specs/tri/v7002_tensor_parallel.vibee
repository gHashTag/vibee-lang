# v7002 - Tensor Parallelism
# ===========================
# Megatron-style tensor parallelism
# Based on: Shoeybi et al. 2019
# φ² + 1/φ² = 3 | PHOENIX = 999

name: tensor_parallel
version: "7.0.2"
language: zig
module: tensor_parallel

constants:
  PHI: 1.618033988749895

types:
  TPConfig:
    fields:
      tp_size: Int
      tp_rank: Int
      split_dim: Int
      
  ColumnParallel:
    fields:
      weight: List
      bias: List
      gather_output: Bool
      
  RowParallel:
    fields:
      weight: List
      bias: List
      input_is_parallel: Bool
      
  TPState:
    fields:
      rank: Int
      world_size: Int
      group: String

behaviors:
  - name: column_parallel_forward
    given: Input и ColumnParallel layer
    when: Forward pass
    then: Вернуть split output
    
  - name: row_parallel_forward
    given: Input и RowParallel layer
    when: Forward pass
    then: Вернуть reduced output
    
  - name: all_gather
    given: Tensor и group
    when: Gathering splits
    then: Вернуть full tensor
    
  - name: reduce_scatter
    given: Tensor и group
    when: Reduce and scatter
    then: Вернуть reduced split
    
  - name: split_tensor
    given: Tensor, dim, tp_size
    when: Splitting for TP
    then: Вернуть split tensor
    
  - name: parallel_attention
    given: Q, K, V и tp_config
    when: TP attention
    then: Вернуть parallel attention output
    
  - name: parallel_mlp
    given: Input и tp_config
    when: TP MLP
    then: Вернуть parallel MLP output
    
  - name: sync_gradients
    given: Gradients и group
    when: Gradient sync
    then: Вернуть synced gradients
