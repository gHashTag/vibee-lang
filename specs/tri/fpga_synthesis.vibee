# ═══════════════════════════════════════════════════════════════════════════════
# FPGA SYNTHESIS - Xilinx Vivado Project Configuration
# ═══════════════════════════════════════════════════════════════════════════════
# Complete synthesis configuration for BitNet FPGA accelerator
# Target: Xilinx VCU118 (Virtex UltraScale+ XCVU9P)
# Alternative: Xilinx ZCU104 (Zynq UltraScale+ XCZU7EV)
#
# Sacred Formula: V = n × 3^k × π^m × φ^p × e^q
# Golden Identity: φ² + 1/φ² = 3 | PHOENIX = 999
# ═══════════════════════════════════════════════════════════════════════════════

name: fpga_synthesis
version: "1.0.0"
language: varlog
module: fpga_synthesis
author: "VIBEE Team"

# ═══════════════════════════════════════════════════════════════════════════════
# TARGET FPGA SPECIFICATIONS
# ═══════════════════════════════════════════════════════════════════════════════

target_fpga:
  primary:
    name: "Xilinx VCU118"
    part: "xcvu9p-flga2104-2L-e"
    family: "Virtex UltraScale+"
    resources:
      luts: 1182240
      ffs: 2364480
      bram36: 2160
      dsp: 6840
      hbm: "8GB"
    interfaces:
      pcie: "Gen3 x16"
      ddr4: "2× 72-bit"
      qsfp: "4× 100G"
  
  alternative:
    name: "Xilinx ZCU104"
    part: "xczu7ev-ffvc1156-2-e"
    family: "Zynq UltraScale+"
    resources:
      luts: 230400
      ffs: 460800
      bram36: 312
      dsp: 1728
    interfaces:
      ps_ddr4: "64-bit"
      pl_ddr4: "64-bit"

# ═══════════════════════════════════════════════════════════════════════════════
# CLOCK DOMAINS
# ═══════════════════════════════════════════════════════════════════════════════

clock_domains:
  - name: clk_300
    frequency: 300000000
    period_ns: 3.333
    description: "Main compute clock"
    source: "MMCM from 100MHz reference"
  
  - name: clk_axi
    frequency: 250000000
    period_ns: 4.0
    description: "AXI interface clock"
    source: "MMCM from 100MHz reference"
  
  - name: clk_ddr
    frequency: 300000000
    period_ns: 3.333
    description: "DDR4 interface clock"
    source: "MIG generated"

# ═══════════════════════════════════════════════════════════════════════════════
# SOURCE FILES
# ═══════════════════════════════════════════════════════════════════════════════

source_files:
  # Core ternary logic
  - path: "trinity/output/fpga/ternary_logic_core.v"
    library: "work"
    type: "verilog"
  
  # SIMD core
  - path: "trinity/output/fpga/bitnet_simd_core.v"
    library: "work"
    type: "verilog"
  
  # Pipelined layer
  - path: "trinity/output/fpga/bitnet_pipelined_layer.v"
    library: "work"
    type: "verilog"
  
  # Multi-layer engine
  - path: "trinity/output/fpga/bitnet_multilayer_engine.v"
    library: "work"
    type: "verilog"
  
  # AXI host interface
  - path: "trinity/output/fpga/axi_host_interface.v"
    library: "work"
    type: "verilog"
  
  # Browser agent accelerator
  - path: "trinity/output/fpga/zhar_ptitsa_fpga.v"
    library: "work"
    type: "verilog"
  
  # Top-level wrapper
  - path: "trinity/output/fpga/vibee_top.v"
    library: "work"
    type: "verilog"
    top: true

# ═══════════════════════════════════════════════════════════════════════════════
# SYNTHESIS SETTINGS
# ═══════════════════════════════════════════════════════════════════════════════

synthesis_settings:
  strategy: "Flow_PerfOptimized_high"
  flatten_hierarchy: "rebuilt"
  gated_clock_conversion: "off"
  bufg_insertion: "auto"
  fanout_limit: 10000
  fsm_extraction: "auto"
  resource_sharing: "auto"
  retiming: true
  
  # Optimization directives
  directives:
    - "KEEP_HIERARCHY=soft"
    - "MAX_FANOUT=100"
    - "SHREG_EXTRACT=yes"

# ═══════════════════════════════════════════════════════════════════════════════
# IMPLEMENTATION SETTINGS
# ═══════════════════════════════════════════════════════════════════════════════

implementation_settings:
  strategy: "Performance_ExplorePostRoutePhysOpt"
  
  opt_design:
    directive: "ExploreWithRemap"
  
  place_design:
    directive: "ExtraNetDelay_high"
  
  phys_opt_design:
    directive: "AggressiveExplore"
  
  route_design:
    directive: "AggressiveExplore"

# ═══════════════════════════════════════════════════════════════════════════════
# TIMING CONSTRAINTS
# ═══════════════════════════════════════════════════════════════════════════════

timing_constraints:
  # Primary clock
  - type: "create_clock"
    name: "clk_300"
    period: 3.333
    port: "clk"
  
  # Input delays
  - type: "set_input_delay"
    clock: "clk_300"
    delay_max: 1.0
    delay_min: 0.5
    ports: ["s_axi_*"]
  
  # Output delays
  - type: "set_output_delay"
    clock: "clk_300"
    delay_max: 1.0
    delay_min: 0.5
    ports: ["m_axi_*", "irq"]
  
  # False paths
  - type: "set_false_path"
    from: "rst_n"
  
  # Multicycle paths (for accumulator)
  - type: "set_multicycle_path"
    setup: 2
    from: "*/accumulator*"
    to: "*/accumulator*"

# ═══════════════════════════════════════════════════════════════════════════════
# RESOURCE ESTIMATES
# ═══════════════════════════════════════════════════════════════════════════════

resource_estimates:
  # Per module
  ternary_logic_core:
    luts: 500
    ffs: 200
    bram: 0
  
  bitnet_simd_core:
    luts: 800
    ffs: 300
    bram: 0
  
  bitnet_pipelined_layer:
    luts: 1500
    ffs: 800
    bram: 4
  
  bitnet_multilayer_engine:
    luts: 2000
    ffs: 1000
    bram: 10
  
  axi_host_interface:
    luts: 2000
    ffs: 1200
    bram: 0
  
  # Total
  total:
    luts: 7000
    ffs: 3500
    bram: 14
    utilization_vcu118: "<1%"

# ═══════════════════════════════════════════════════════════════════════════════
# BEHAVIORS (Generate synthesis artifacts)
# ═══════════════════════════════════════════════════════════════════════════════

behaviors:
  # ───────────────────────────────────────────────────────────────────────────
  # TOP-LEVEL WRAPPER
  # ───────────────────────────────────────────────────────────────────────────
  - name: vibee_fpga_top
    given: All submodules
    when: Synthesis top level needed
    then: Instantiate complete BitNet accelerator with AXI interfaces
    implementation: |
      // Top-level ports:
      // - Clock and reset
      // - AXI-Lite slave (control)
      // - AXI4 master (DDR access)
      // - Interrupt output

  # ───────────────────────────────────────────────────────────────────────────
  # CLOCK WIZARD
  # ───────────────────────────────────────────────────────────────────────────
  - name: clock_wizard
    given: 100MHz reference clock
    when: Multiple clock domains needed
    then: Generate 300MHz and 250MHz clocks via MMCM
    implementation: |
      // Xilinx MMCM primitive
      // Input: 100MHz
      // Output: 300MHz (compute), 250MHz (AXI)

  # ───────────────────────────────────────────────────────────────────────────
  # RESET SYNCHRONIZER
  # ───────────────────────────────────────────────────────────────────────────
  - name: reset_sync
    given: Async reset input
    when: Synchronous reset needed
    then: Synchronize reset to each clock domain
    implementation: |
      // 2-stage synchronizer per clock domain
      // Async assert, sync deassert

  # ───────────────────────────────────────────────────────────────────────────
  # AXI INTERCONNECT
  # ───────────────────────────────────────────────────────────────────────────
  - name: axi_interconnect
    given: Multiple AXI masters/slaves
    when: Bus arbitration needed
    then: Route AXI transactions between components
    implementation: |
      // Xilinx AXI Interconnect IP
      // 1 slave port (from host)
      // 2 master ports (to DDR, to engine)

# ═══════════════════════════════════════════════════════════════════════════════
# TEST CASES
# ═══════════════════════════════════════════════════════════════════════════════

test_cases:
  - name: test_synthesis_completes
    input: {all_sources: true}
    expected: {synthesis_success: true, errors: 0}

  - name: test_timing_met
    input: {clock: "300MHz"}
    expected: {wns: ">0", tns: 0}

  - name: test_resource_utilization
    input: {target: "VCU118"}
    expected: {lut_util: "<1%", bram_util: "<1%"}

  - name: test_golden_identity
    input: {phi: 1.618033988749895}
    expected: {phi_sq_plus_inv_sq: 3.0}

# ═══════════════════════════════════════════════════════════════════════════════
# BUILD FLOW
# ═══════════════════════════════════════════════════════════════════════════════

build_flow: |
  ┌─────────────────────────────────────────────────────────────────────────────┐
  │                        VIVADO BUILD FLOW                                    │
  ├─────────────────────────────────────────────────────────────────────────────┤
  │                                                                             │
  │  1. CREATE PROJECT                                                          │
  │     vivado -mode batch -source create_project.tcl                           │
  │                                                                             │
  │  2. ADD SOURCES                                                             │
  │     add_files trinity/output/fpga/*.v                                       │
  │     set_property top vibee_fpga_top [current_fileset]                       │
  │                                                                             │
  │  3. ADD CONSTRAINTS                                                         │
  │     add_files -fileset constrs_1 constraints/vibee.xdc                      │
  │                                                                             │
  │  4. SYNTHESIS                                                               │
  │     synth_design -top vibee_fpga_top -part xcvu9p-flga2104-2L-e             │
  │     report_utilization -file reports/utilization_synth.rpt                  │
  │     report_timing_summary -file reports/timing_synth.rpt                    │
  │                                                                             │
  │  5. IMPLEMENTATION                                                          │
  │     opt_design                                                              │
  │     place_design                                                            │
  │     phys_opt_design                                                         │
  │     route_design                                                            │
  │                                                                             │
  │  6. REPORTS                                                                 │
  │     report_utilization -file reports/utilization_impl.rpt                   │
  │     report_timing_summary -file reports/timing_impl.rpt                     │
  │     report_power -file reports/power.rpt                                    │
  │                                                                             │
  │  7. BITSTREAM                                                               │
  │     write_bitstream -force vibee_bitnet.bit                                 │
  │                                                                             │
  └─────────────────────────────────────────────────────────────────────────────┘
