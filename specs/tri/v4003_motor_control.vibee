# v4003 - Motor Control
# ======================
# Low-level actuator control
# φ² + 1/φ² = 3 | PHOENIX = 999

name: motor_control
version: "4.0.3"
language: zig
module: motor_control

constants:
  PHI: 1.618033988749895
  PWM_FREQUENCY: 20000
  ENCODER_CPR: 4096
  CURRENT_LIMIT: 10.0

types:
  MotorConfig:
    fields:
      motor_type: String
      max_current: Float
      max_velocity: Float
      gear_ratio: Float
      
  MotorState:
    fields:
      position: Float
      velocity: Float
      current: Float
      temperature: Float
      
  PWMCommand:
    fields:
      duty_cycle: Float
      frequency: Int
      direction: Int
      
  EncoderReading:
    fields:
      counts: Int
      velocity_counts: Int
      timestamp: Timestamp
      
  CurrentCommand:
    fields:
      target_current: Float
      feedforward: Float
      
  TorqueCommand:
    fields:
      target_torque: Float
      current_limit: Float
      
  MotorFault:
    fields:
      fault_type: String
      severity: Int
      timestamp: Timestamp
      
  ControlLoop:
    fields:
      mode: String
      gains: List
      limits: List

behaviors:
  - name: position_control
    given: Target position and state
    when: Position servo
    then: Return current command
    
  - name: velocity_control
    given: Target velocity and state
    when: Velocity servo
    then: Return current command
    
  - name: torque_control
    given: Target torque and state
    when: Torque servo
    then: Return current command
    
  - name: read_encoder
    given: Encoder interface
    when: Reading position
    then: Return encoder reading
    
  - name: commutate_bldc
    given: Rotor angle and current
    when: BLDC commutation
    then: Return phase currents
    
  - name: detect_fault
    given: Motor state and limits
    when: Checking for faults
    then: Return fault info
    
  - name: calibrate_encoder
    given: Motor and encoder
    when: Finding index
    then: Return calibration offset
    
  - name: thermal_protection
    given: Temperature and limits
    when: Thermal management
    then: Return derated limit
