name: agent_eventbus_v325
version: "1.0.0"
language: zig
module: agent_eventbus_v325

types:
  Event:
    fields:
      id: String
      type: String
      source: String
      payload: Object
      timestamp: Timestamp

  Subscription:
    fields:
      id: String
      event_type: String
      handler: String
      filter: Option<String>
      priority: Int

  EventBus:
    fields:
      subscriptions: List<Subscription>
      queue_size: Int
      processed: Int
      dropped: Int

  DeliveryPolicy:
    fields:
      mode: String
      retry_count: Int
      timeout_ms: Int
      dead_letter: Bool

  EventHistory:
    fields:
      events: List<Event>
      max_size: Int
      retention_ms: Int

behaviors:
  - name: publish_event
    given: Event created
    when: Publish called
    then: Event delivered to subscribers

  - name: subscribe_handler
    given: Handler function
    when: Subscribe called
    then: Subscription registered

  - name: unsubscribe_handler
    given: Subscription exists
    when: Unsubscribe called
    then: Subscription removed

  - name: filter_events
    given: Filter expression
    when: Event published
    then: Only matching events delivered

  - name: prioritize_delivery
    given: Multiple subscribers
    when: Delivery runs
    then: High priority handlers first

  - name: handle_slow_consumer
    given: Consumer too slow
    when: Backpressure detected
    then: Events buffered or dropped

  - name: replay_events
    given: History available
    when: Replay requested
    then: Historical events replayed

  - name: dead_letter_queue
    given: Delivery fails
    when: Max retries exceeded
    then: Event moved to dead letter
