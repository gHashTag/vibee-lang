# agent_loop_v21.vibee
# KOSCHEI CYCLE 21 - Autonomous Browser Agent Loop
# Chrome CDP + Ollama LLM = Full Automation
# φ² + 1/φ² = 3 | PHOENIX = 999

name: agent_loop_v21
version: "21.0.0"
language: zig
module: agent_loop_v21

types:
  AgentConfig:
    fields:
      cdp_host: String
      cdp_port: Int
      ollama_host: String
      ollama_port: Int
      model: String
      max_steps: Int
      timeout_ms: Int

  AgentState:
    enum:
      - Idle
      - Observing
      - Thinking
      - Acting
      - Done
      - Error

  Task:
    fields:
      description: String
      start_url: String
      success_criteria: String
      max_steps: Int

  Observation:
    fields:
      url: String
      title: String
      dom_text: String
      timestamp: Timestamp

  BrowserAction:
    fields:
      thought: String
      action: String
      input: String

  ActionType:
    enum:
      - goto
      - click
      - type
      - scroll
      - extract
      - done
      - fail

  ActionResult:
    fields:
      success: Bool
      message: String
      duration_ms: Int

  Step:
    fields:
      step_number: Int
      observation: String
      thought: String
      action: String
      input: String
      result: String
      duration_ms: Int

  AgentResult:
    fields:
      task: String
      success: Bool
      steps_taken: Int
      total_duration_ms: Int
      final_observation: String
      error: Option<String>

  LoopMetrics:
    fields:
      observe_ms: Int
      think_ms: Int
      act_ms: Int
      total_ms: Int

behaviors:
  - name: create_agent
    given: AgentConfig with CDP and Ollama settings
    when: Initializing autonomous agent
    then: Return agent handle

  - name: run_task
    given: Agent and Task
    when: Starting autonomous task execution
    then: Return AgentResult after completion

  - name: observe
    given: Connected browser session
    when: Capturing current page state
    then: Return Observation

  - name: think
    given: Task, Observation, and history
    when: Asking LLM for next action
    then: Return BrowserAction

  - name: act
    given: BrowserAction to execute
    when: Performing action via CDP
    then: Return ActionResult

  - name: parse_action
    given: LLM response text
    when: Extracting Thought/Action/Input
    then: Return BrowserAction struct

  - name: execute_goto
    given: URL to navigate
    when: Navigating browser
    then: Return ActionResult

  - name: execute_click
    given: CSS selector
    when: Clicking element
    then: Return ActionResult

  - name: execute_type
    given: Selector and text
    when: Typing into input
    then: Return ActionResult

  - name: check_done
    given: Observation and success criteria
    when: Checking if task is complete
    then: Return true if done

  - name: build_prompt
    given: Task, Observation, history
    when: Creating LLM prompt
    then: Return formatted prompt string

  - name: agent_loop
    given: Agent, Task
    when: Running observe-think-act loop
    then: Iterate until done or max_steps

test_cases:
  - name: simple_navigation
    input: task="Go to example.com and get title"
    expected: success=true, title="Example Domain"

  - name: action_parsing
    input: "Thought: Navigate\nAction: goto\nInput: https://google.com"
    expected: action="goto", input="https://google.com"

  - name: done_detection
    input: observation contains success criteria
    expected: check_done returns true

sacred_constants:
  phi: 1.618033988749895
  phi_squared_plus_inverse_squared: 3
  phoenix: 999

# Agent Loop Flow:
# 1. OBSERVE: Get page state via CDP
# 2. THINK: Ask LLM for next action
# 3. ACT: Execute action via CDP
# 4. CHECK: Is task complete?
# 5. LOOP: If not done, go to step 1
