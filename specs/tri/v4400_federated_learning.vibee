# v4400 - Federated Learning
# ===========================
# Распределённое обучение без централизации данных
# φ² + 1/φ² = 3 | PHOENIX = 999

name: federated_learning
version: "4.4.0"
language: zig
module: federated_learning

constants:
  PHI: 1.618033988749895
  NUM_CLIENTS: 100
  ROUNDS: 500
  CLIENT_FRACTION: 0.1

types:
  FLConfig:
    fields:
      num_clients: Int
      rounds: Int
      client_fraction: Float
      aggregation: String
      
  Client:
    fields:
      client_id: Int
      local_data: Object
      local_model: Object
      
  GlobalModel:
    fields:
      parameters: List
      version: Int
      
  ClientUpdate:
    fields:
      client_id: Int
      gradients: List
      num_samples: Int
      
  AggregatedUpdate:
    fields:
      weighted_gradients: List
      total_samples: Int
      
  FLRound:
    fields:
      round_id: Int
      selected_clients: List
      global_accuracy: Float
      
  ClientSelection:
    fields:
      strategy: String
      selected_ids: List
      
  CommunicationBudget:
    fields:
      bytes_up: Int
      bytes_down: Int
      compression_ratio: Float

behaviors:
  - name: select_clients
    given: Клиенты и стратегия выбора
    when: Выбор участников раунда
    then: Вернуть выбранных клиентов
    
  - name: distribute_model
    given: Глобальная модель и клиенты
    when: Рассылка модели
    then: Вернуть статус доставки
    
  - name: local_train
    given: Клиент и локальные данные
    when: Локальное обучение
    then: Вернуть обновление клиента
    
  - name: aggregate_updates
    given: Обновления клиентов
    when: FedAvg агрегация
    then: Вернуть агрегированное обновление
    
  - name: update_global_model
    given: Глобальная модель и агрегация
    when: Обновление глобальной модели
    then: Вернуть новую глобальную модель
    
  - name: evaluate_global
    given: Глобальная модель и тестовые данные
    when: Оценка качества
    then: Вернуть метрики
    
  - name: compress_update
    given: Обновление и бюджет
    when: Сжатие для передачи
    then: Вернуть сжатое обновление
    
  - name: handle_stragglers
    given: Таймаут и ожидающие клиенты
    when: Обработка отставших
    then: Вернуть решение по раунду
