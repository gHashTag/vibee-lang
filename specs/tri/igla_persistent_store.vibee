# VIBEE Specification - IGLA Persistent Store
# SQLite/RocksDB vector storage
# RAG v3 - Persistent Storage
# φ² + 1/φ² = 3 | PHOENIX = 999

name: igla_persistent_store
version: "3.0.0"
language: zig
module: igla_persistent_store

types:
  PersistentStore:
    fields:
      id: String
      path: String
      backend: String
      opened: Bool
      total_vectors: Int

  StoreConfig:
    fields:
      backend: String
      path: String
      cache_size_mb: Int
      sync_mode: String
      compression: Bool

  VectorRecord:
    fields:
      id: String
      vector: String
      metadata: String
      text: String
      created_at: Int

  IndexMetadata:
    fields:
      name: String
      dimension: Int
      metric: String
      total_vectors: Int
      created_at: Int

  QueryResult:
    fields:
      id: String
      score: Float
      vector: String
      metadata: String

  BatchInsert:
    fields:
      records: String
      count: Int
      success_count: Int
      latency_ms: Float

  Snapshot:
    fields:
      id: String
      path: String
      size_bytes: Int
      created_at: Int

  StoreMetrics:
    fields:
      total_vectors: Int
      index_size_mb: Float
      avg_insert_ms: Float
      avg_query_ms: Float
      cache_hit_rate: Float

behaviors:
  - name: open_store
    given: Store config
    when: Store opened
    then: Connection established

  - name: close_store
    given: Open store
    when: Store closed
    then: Connection closed cleanly

  - name: insert_vector
    given: Vector and metadata
    when: Insert executed
    then: Vector stored with ID

  - name: insert_batch
    given: Vector batch
    when: Batch insert
    then: All vectors stored

  - name: get_vector
    given: Vector ID
    when: Get requested
    then: Vector record returned

  - name: delete_vector
    given: Vector ID
    when: Delete requested
    then: Vector removed

  - name: search_vectors
    given: Query vector and k
    when: Search executed
    then: Top-k results returned

  - name: create_index
    given: Index config
    when: Index creation
    then: Index built

  - name: create_snapshot
    given: Store
    when: Snapshot requested
    then: Snapshot created

  - name: restore_snapshot
    given: Snapshot path
    when: Restore requested
    then: Store restored

  - name: compact
    given: Store
    when: Compaction requested
    then: Storage optimized

  - name: get_metrics
    given: Store
    when: Metrics requested
    then: Store metrics returned

test_cases:
  - name: test_open_store
    input: { path: "test.db", backend: "sqlite" }
    expected: { opened: true }

  - name: test_insert
    input: { vector: "[0.1, 0.2]", text: "test" }
    expected: { inserted: true }

  - name: test_get
    input: { id: "vec_1" }
    expected: { found: true }

  - name: test_search
    input: { query: "[0.1, 0.2]", k: 5 }
    expected: { results_count: 5 }

  - name: test_batch
    input: { count: 100 }
    expected: { success_count: 100 }

  - name: test_snapshot
    input: {}
    expected: { created: true }

  - name: test_metrics
    input: {}
    expected: { total_vectors: 0 }
