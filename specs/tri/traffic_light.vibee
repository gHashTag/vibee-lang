name: traffic_light
version: "1.0.0"
language: verilog
module: traffic_light

# Generated from Python by py2vibee
# Sacred Formula: φ² + 1/φ² = 3

constants:
  CLOCK_FREQ: 50000000
  GREEN_TIME: 150000000
  YELLOW_TIME: 50000000
  RED_TIME: 200000000

signals:
  - name: clk
    width: 1
    direction: input
  - name: rst_n
    width: 1
    direction: input
  - name: pedestrian_button
    width: 1
    direction: input
  - name: red_light
    width: 1
    direction: output
  - name: yellow_light
    width: 1
    direction: output
  - name: green_light
    width: 1
    direction: output
  - name: timer_count
    width: 32
    direction: reg
  - name: timer_expired
    width: 1
    direction: reg

fsm:
  - name: TrafficLightFSM
    initial: RED
    encoding: onehot
    states:
      - RED
      - RED_YELLOW
      - GREEN
      - YELLOW
    transitions:
      - from: RED
        to: RED_YELLOW
        when: "timer_expired"
      - from: RED_YELLOW
        to: GREEN
        when: "timer_expired"
      - from: GREEN
        to: YELLOW
        when: "(timer_expired) || (pedestrian_button)"
      - from: YELLOW
        to: RED
        when: "timer_expired"
    outputs:
      - state: RED
        red_light: 1'b1
        yellow_light: 1'b0
        green_light: 1'b0
      - state: RED_YELLOW
        red_light: 1'b1
        yellow_light: 1'b1
        green_light: 1'b0
      - state: GREEN
        red_light: 1'b0
        yellow_light: 1'b0
        green_light: 1'b1
      - state: YELLOW
        red_light: 1'b0
        yellow_light: 1'b1
        green_light: 1'b0
    timers:
      - state: RED
        timeout_constant: RED_TIME
        timeout_value: 200000000
      - state: RED_YELLOW
        timeout_constant: YELLOW_TIME
        timeout_value: 50000000
      - state: GREEN
        timeout_constant: GREEN_TIME
        timeout_value: 150000000
      - state: YELLOW
        timeout_constant: YELLOW_TIME
        timeout_value: 50000000

behaviors:
  - name: transition
    given: "Current state and input signals"
    when: "Clock edge"
    then: "Returns next state"
    params:
      - name: current_state
        type: String
      - name: timer_expired
        type: Bool
      - name: pedestrian_button
        type: Bool
    returns: String
  - name: output
    given: "Current state"
    when: "Output requested"
    then: "Returns (red, yellow, green) light values"
    params:
      - name: current_state
        type: String
    returns: tuple
  - name: clk
    given: "System clock"
    when: "Function is called"
    then: "Returns Bool"
    returns: Bool
  - name: rst_n
    given: "Active-low reset"
    when: "Function is called"
    then: "Returns Bool"
    returns: Bool
  - name: pedestrian_button
    given: "Pedestrian crossing request"
    when: "Function is called"
    then: "Returns Bool"
    returns: Bool
  - name: red_light
    given: "Red light output"
    when: "Function is called"
    then: "Returns Bool"
    returns: Bool
  - name: yellow_light
    given: "Yellow light output"
    when: "Function is called"
    then: "Returns Bool"
    returns: Bool
  - name: green_light
    given: "Green light output"
    when: "Function is called"
    then: "Returns Bool"
    returns: Bool
  - name: timer_count
    given: "Timer counter for state duration"
    when: "Function is called"
    then: "Returns Int"
    returns: Int
  - name: timer_expired
    given: "Timer expired flag"
    when: "Function is called"
    then: "Returns Bool"
    returns: Bool
  - name: timer_process
    given: "Current state and timer count"
    when: "Clock edge"
    then: "Updates timer and expired flag"
    hdl_type: sequential
    clock: clk
    reset: rst_n
    params:
      - name: state
        type: String
      - name: timer_count
        type: Int
    returns: tuple
  - name: light_output
    given: "Current state"
    when: "State changes"
    then: "Updates light outputs"
    hdl_type: combinational
    sensitivity: [*]
    params:
      - name: state
        type: String
    returns: tuple
