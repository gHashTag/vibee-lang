# REAL BROWSER RUNNER V154 - Actual Browser Automation
# φ² + 1/φ² = 3 | PHOENIX = 999
# This spec generates REAL browser automation code
name: real_browser_runner_v154
version: "154.0.0"
language: zig
module: real_browser_runner

creation_pattern:
  source: BrowserCommand
  transformer: CDPEngine
  result: BrowserAction

types:
  # CDP WebSocket Connection
  CDPConnection:
    fields:
      ws_url: String
      session_id: String
      connected: Bool
      message_id: Int

  # CDP Message
  CDPMessage:
    fields:
      id: Int
      method: String
      params: String
      session_id: Option<String>

  # CDP Response
  CDPResponse:
    fields:
      id: Int
      result: String
      error: Option<String>

  # Browser Instance
  BrowserInstance:
    fields:
      pid: Int
      ws_endpoint: String
      user_data_dir: String
      headless: Bool

  # Page
  Page:
    fields:
      target_id: String
      url: String
      title: String
      frame_id: String

  # Element
  Element:
    fields:
      node_id: Int
      backend_node_id: Int
      object_id: String
      tag_name: String

  # Navigation Result
  NavigationResult:
    fields:
      frame_id: String
      loader_id: String
      url: String
      error: Option<String>

  # Screenshot
  Screenshot:
    fields:
      data: String
      format: String
      width: Int
      height: Int

  # Cookie
  Cookie:
    fields:
      name: String
      value: String
      domain: String
      path: String
      expires: Float
      http_only: Bool
      secure: Bool

  # Network Request
  NetworkRequest:
    fields:
      request_id: String
      url: String
      method: String
      headers: String
      post_data: Option<String>

  # Network Response
  NetworkResponse:
    fields:
      request_id: String
      status: Int
      headers: String
      body: String

  # Evaluation Result
  EvalResult:
    fields:
      result_type: String
      value: String
      exception: Option<String>

  # Input Event
  InputEvent:
    fields:
      event_type: String
      x: Int
      y: Int
      button: String
      modifiers: Int

  # Benchmark Result
  BenchmarkResult:
    fields:
      operation: String
      time_ms: Float
      success: Bool
      iterations: Int

behaviors:
  # Browser Lifecycle
  - name: launch_browser
    given: "Browser options"
    when: "Launch command"
    then: "Browser started with WebSocket endpoint"
    test_cases:
      - name: launch_headless
        input: "headless: true"
        expected: "ws://localhost:9222"
      - name: launch_headed
        input: "headless: false"
        expected: "browser visible"

  - name: connect_cdp
    given: "WebSocket URL"
    when: "Connect"
    then: "CDP session established"
    test_cases:
      - name: connect
        input: "ws://localhost:9222"
        expected: "connected"

  - name: close_browser
    given: "Browser instance"
    when: "Close"
    then: "Browser terminated"
    test_cases:
      - name: close
        input: "instance"
        expected: "closed"

  # Navigation
  - name: navigate
    given: "URL"
    when: "Page.navigate"
    then: "Page loaded"
    test_cases:
      - name: nav_google
        input: "https://google.com"
        expected: "loaded"
      - name: nav_github
        input: "https://github.com"
        expected: "loaded"

  - name: reload
    given: "Current page"
    when: "Page.reload"
    then: "Page reloaded"
    test_cases:
      - name: reload
        input: "page"
        expected: "reloaded"

  - name: go_back
    given: "Page with history"
    when: "Page.navigateToHistoryEntry"
    then: "Previous page"
    test_cases:
      - name: back
        input: "history"
        expected: "previous"

  # DOM Operations
  - name: query_selector
    given: "CSS selector"
    when: "DOM.querySelector"
    then: "Node ID returned"
    test_cases:
      - name: query_id
        input: "#main"
        expected: "node_id"
      - name: query_class
        input: ".container"
        expected: "node_id"

  - name: query_selector_all
    given: "CSS selector"
    when: "DOM.querySelectorAll"
    then: "Node IDs array"
    test_cases:
      - name: query_all
        input: "div"
        expected: "node_ids"

  - name: get_document
    given: "Page"
    when: "DOM.getDocument"
    then: "Root node"
    test_cases:
      - name: doc
        input: "page"
        expected: "root"

  - name: get_outer_html
    given: "Node ID"
    when: "DOM.getOuterHTML"
    then: "HTML string"
    test_cases:
      - name: html
        input: "node_id"
        expected: "html"

  # Input
  - name: click
    given: "Coordinates"
    when: "Input.dispatchMouseEvent"
    then: "Click performed"
    test_cases:
      - name: click_xy
        input: "x: 100, y: 200"
        expected: "clicked"

  - name: type_text
    given: "Text"
    when: "Input.insertText"
    then: "Text typed"
    test_cases:
      - name: type
        input: "hello world"
        expected: "typed"

  - name: press_key
    given: "Key code"
    when: "Input.dispatchKeyEvent"
    then: "Key pressed"
    test_cases:
      - name: enter
        input: "Enter"
        expected: "pressed"

  # JavaScript
  - name: evaluate
    given: "JavaScript expression"
    when: "Runtime.evaluate"
    then: "Result returned"
    test_cases:
      - name: eval_title
        input: "document.title"
        expected: "title string"
      - name: eval_url
        input: "window.location.href"
        expected: "url string"

  - name: call_function
    given: "Function and args"
    when: "Runtime.callFunctionOn"
    then: "Function result"
    test_cases:
      - name: call
        input: "fn, args"
        expected: "result"

  # Screenshot
  - name: capture_screenshot
    given: "Options"
    when: "Page.captureScreenshot"
    then: "Base64 image"
    test_cases:
      - name: screenshot_png
        input: "format: png"
        expected: "base64"
      - name: screenshot_jpeg
        input: "format: jpeg"
        expected: "base64"

  # Network
  - name: enable_network
    given: "Page"
    when: "Network.enable"
    then: "Network events enabled"
    test_cases:
      - name: network
        input: "page"
        expected: "enabled"

  - name: intercept_request
    given: "URL pattern"
    when: "Fetch.enable"
    then: "Requests intercepted"
    test_cases:
      - name: intercept
        input: "*.js"
        expected: "intercepting"

  # Cookies
  - name: get_cookies
    given: "Domain"
    when: "Network.getCookies"
    then: "Cookie list"
    test_cases:
      - name: cookies
        input: "domain"
        expected: "cookies"

  - name: set_cookie
    given: "Cookie data"
    when: "Network.setCookie"
    then: "Cookie set"
    test_cases:
      - name: set
        input: "cookie"
        expected: "set"

  # Benchmarks
  - name: benchmark_navigation
    given: "URL list"
    when: "Benchmark navigation"
    then: "Timing results"
    test_cases:
      - name: bench_nav
        input: "urls"
        expected: "timings"

  - name: benchmark_dom
    given: "Selector operations"
    when: "Benchmark DOM"
    then: "Timing results"
    test_cases:
      - name: bench_dom
        input: "selectors"
        expected: "timings"

# CDP DOMAINS USED
cdp_domains:
  Browser: ["close", "getVersion"]
  Page: ["navigate", "reload", "captureScreenshot", "getFrameTree"]
  DOM: ["getDocument", "querySelector", "querySelectorAll", "getOuterHTML"]
  Runtime: ["evaluate", "callFunctionOn"]
  Input: ["dispatchMouseEvent", "dispatchKeyEvent", "insertText"]
  Network: ["enable", "getCookies", "setCookie"]
  Fetch: ["enable", "continueRequest", "fulfillRequest"]
  Target: ["createTarget", "closeTarget", "attachToTarget"]

# BENCHMARK TARGETS
benchmarks:
  navigation:
    target_ms: 500
    current_ms: 800
    improvement_needed: "37.5%"
    
  dom_query:
    target_ms: 5
    current_ms: 10
    improvement_needed: "50%"
    
  screenshot:
    target_ms: 100
    current_ms: 200
    improvement_needed: "50%"
    
  evaluate:
    target_ms: 10
    current_ms: 25
    improvement_needed: "60%"

# PAS DAEMON OPTIMIZATIONS
pas_optimizations:
  PRE:
    optimization: "Cache DOM queries"
    speedup: "3x"
    
  DC:
    optimization: "Parallel page operations"
    speedup: "Nx"
    
  HSH:
    optimization: "Hash element lookups"
    speedup: "O(1)"

# HOW TO RUN BROWSER
# 1. Install Chrome/Chromium
# 2. Launch with: chromium --remote-debugging-port=9222 --headless
# 3. Connect via WebSocket to ws://localhost:9222
# 4. Send CDP commands as JSON

# φ² + 1/φ² = 3 | PHOENIX = 999
