# v3602 - Retrieval Augmented Generation
# =======================================
# External knowledge integration (RAG)
# φ² + 1/φ² = 3 | PHOENIX = 999

name: retrieval_augmentation
version: "3.6.2"
language: zig
module: retrieval_augmentation

constants:
  PHI: 1.618033988749895
  TOP_K_DOCS: 5
  CHUNK_SIZE: 512
  OVERLAP: 64
  EMBEDDING_DIM: 768

types:
  RAGConfig:
    fields:
      top_k: Int
      chunk_size: Int
      overlap: Int
      rerank: Bool
      
  Document:
    fields:
      doc_id: String
      content: String
      metadata: Map
      embedding: List
      
  Chunk:
    fields:
      chunk_id: String
      doc_id: String
      text: String
      start_idx: Int
      end_idx: Int
      embedding: List
      
  RetrievalResult:
    fields:
      chunks: List
      scores: List
      
  VectorIndex:
    fields:
      embeddings: List
      chunk_ids: List
      index_type: String
      
  QueryContext:
    fields:
      query: String
      query_embedding: List
      retrieved_context: String
      
  RerankConfig:
    fields:
      model: String
      top_n: Int

behaviors:
  - name: chunk_document
    given: Document and chunk config
    when: Splitting into chunks
    then: Return list of chunks with overlap
    
  - name: embed_chunks
    given: Chunks and embedding model
    when: Computing embeddings
    then: Return chunks with embeddings
    
  - name: build_index
    given: Embedded chunks
    when: Creating vector index
    then: Return searchable index
    
  - name: retrieve_similar
    given: Query embedding and index
    when: Finding similar chunks
    then: Return top-k chunks with scores
    
  - name: rerank_results
    given: Query and retrieved chunks
    when: Reranking with cross-encoder
    then: Return reranked chunks
    
  - name: format_context
    given: Retrieved chunks
    when: Preparing for LLM
    then: Return formatted context string
    
  - name: rag_generate
    given: Query, context, and LLM
    when: Generating with retrieval
    then: Return augmented response
    
  - name: update_index
    given: New documents
    when: Adding to existing index
    then: Return updated index
