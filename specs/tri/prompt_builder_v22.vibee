name: prompt_builder_v22
version: "22.1.0"
language: zig
module: prompt_builder_v22

types:
  PromptConfig:
    fields:
      system_prompt: String
      max_tokens: Int
      temperature: Float
      include_history: Bool
      include_observation: Bool
      include_goal: Bool

  PromptTemplate:
    fields:
      name: String
      template: String
      variables: List<String>
      version: String

  ConversationMessage:
    fields:
      role: String
      content: String
      timestamp: Timestamp

  PromptContext:
    fields:
      goal: String
      observation: String
      history: List<String>
      available_actions: List<String>
      constraints: List<String>

  BuiltPrompt:
    fields:
      system: String
      user: String
      total_tokens: Int
      truncated: Bool

  PromptBuilder:
    fields:
      config: Object
      templates: List<String>
      history: List<String>
      phi_ratio: Float

behaviors:
  - name: create_builder
    given: PromptConfig
    when: Initialize builder
    then: PromptBuilder instance

  - name: build_system_prompt
    given: PromptBuilder and goal
    when: Build system prompt
    then: System prompt string

  - name: build_user_prompt
    given: PromptBuilder and PromptContext
    when: Build user prompt
    then: User prompt string

  - name: add_template
    given: PromptBuilder and PromptTemplate
    when: Add template
    then: Updated builder

  - name: render_template
    given: Template name and variables
    when: Render template
    then: Rendered string

  - name: add_history
    given: PromptBuilder and ConversationMessage
    when: Add to history
    then: Updated builder

  - name: truncate_to_tokens
    given: Prompt and max_tokens
    when: Truncate if needed
    then: Truncated prompt

  - name: build_full_prompt
    given: PromptBuilder and PromptContext
    when: Build complete prompt
    then: BuiltPrompt

  - name: estimate_tokens
    given: Text string
    when: Estimate token count
    then: Token count

  - name: format_actions
    given: List of actions
    when: Format for prompt
    then: Formatted string

  - name: phi_optimize
    given: Prompt sections
    when: Apply phi ratio optimization
    then: Optimized prompt
