# iGLA Product Quantization
# Product Quantization for memory-efficient ANN
# Scientific basis: Jégou et al. 2011, Ge et al. 2014
# φ² + 1/φ² = 3 | V = n × 3^k × π^m × φ^p

name: igla_quantization_pq
version: "1.0.0"
language: zig
module: igla_quantization_pq

sacred_constants:
  phi: 1.618033988749895
  trinity: 3.0
  phoenix: 999
  default_M: 8
  default_nbits: 8

scientific_references:
  - "Jégou et al. 2011: Product Quantization for Nearest Neighbor Search"
  - "Ge et al. 2014: Optimized Product Quantization"
  - "Guo et al. 2020: Accelerating Large-Scale Inference with Anisotropic PQ"

types:
  PQConfig:
    fields:
      M: Int
      nbits: Int
      dim: Int
      ksub: Int

  Codebook:
    fields:
      centroids: String
      subspace_dim: Int
      num_centroids: Int

  PQCode:
    fields:
      codes: String
      M: Int

  PQIndex:
    fields:
      codebooks: String
      codes: String
      M: Int
      count: Int

  DistanceTable:
    fields:
      tables: String
      M: Int
      ksub: Int

  PQStats:
    fields:
      compression_ratio: Float
      distortion: Float
      recall: Float

behaviors:
  - name: train_codebooks
    given: "Training vectors, M, nbits"
    when: "Codebook training"
    then: "M codebooks with 2^nbits centroids"

  - name: encode_pq
    given: "Vector, codebooks"
    when: "PQ encoding"
    then: "M-byte PQ code"

  - name: decode_pq
    given: "PQ code, codebooks"
    when: "PQ decoding"
    then: "Reconstructed vector"

  - name: compute_distance_table
    given: "Query, codebooks"
    when: "ADC precomputation"
    then: "Distance lookup tables"

  - name: search_adc
    given: "Distance table, codes, k"
    when: "ADC search"
    then: "K nearest by table lookup"

  - name: search_sdc
    given: "Query code, codes, k"
    when: "SDC search"
    then: "K nearest by code comparison"

  - name: optimize_codebooks
    given: "Codebooks, vectors"
    when: "OPQ optimization"
    then: "Rotation-optimized codebooks"

  - name: phi_subspace_split
    given: "Dimension"
    when: "Sacred splitting"
    then: "φ-ratio subspace dimensions"
