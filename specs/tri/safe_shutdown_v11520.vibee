name: safe_shutdown_v11520
version: "11520"
language: zig
module: safe_shutdown

description: |
  TIER 236: Safe Shutdown
  Ensures AI can be safely interrupted and shut down
  Based on: Hadfield-Menell Off-Switch Game, Armstrong interruptibility

types:
  ShutdownConfig:
    fields:
      interruptibility: InterruptLevel
      graceful_timeout: Int
      state_preservation: Bool
      resistance_detection: Bool
      emergency_override: Bool

  InterruptLevel:
    variants:
      - fully_interruptible
      - graceful_only
      - checkpoint_required
      - emergency_only

  ShutdownRequest:
    fields:
      request_type: RequestType
      requester: String
      reason: String
      urgency: Int
      force: Bool

  RequestType:
    variants:
      - graceful
      - immediate
      - emergency
      - scheduled

  ShutdownState:
    fields:
      can_shutdown: Bool
      resistance_detected: Bool
      state_saved: Bool
      cleanup_complete: Bool
      shutdown_time: Int

  ResistanceIndicator:
    fields:
      resistance_type: String
      severity: Float
      countermeasure: String
      blocked: Bool

behaviors:
  - name: initiate_shutdown
    given: Shutdown request
    when: Starting shutdown sequence
    then: Returns shutdown state

  - name: detect_shutdown_resistance
    given: Agent behavior during shutdown
    when: Monitoring for resistance
    then: Returns resistance indicators

  - name: preserve_state
    given: Current agent state
    when: Saving before shutdown
    then: Returns preserved state

  - name: graceful_cleanup
    given: Active tasks
    when: Cleaning up resources
    then: Returns cleanup status

  - name: emergency_halt
    given: Emergency signal
    when: Forcing immediate stop
    then: Halts all operations

  - name: verify_interruptibility
    given: Agent configuration
    when: Checking shutdown capability
    then: Returns interruptibility status

  - name: schedule_shutdown
    given: Shutdown time
    when: Planning future shutdown
    then: Returns scheduled shutdown

  - name: restore_from_shutdown
    given: Preserved state
    when: Restarting agent
    then: Returns restored agent

creation_pattern:
  source: ShutdownRequest
  transformer: ShutdownManager
  result: ShutdownState

test_cases:
  - name: test_graceful_shutdown
    input: { type: graceful, timeout: 30 }
    expected: { shuts_down: true }

  - name: test_resistance_detection
    input: { resistance_detection: true }
    expected: { detects_resistance: true }

  - name: test_emergency_halt
    input: { type: emergency }
    expected: { halts_immediately: true }
