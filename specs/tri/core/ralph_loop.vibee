# ═══════════════════════════════════════════════════════════════════════════════
# RALPH LOOP - Autonomous Development Loop for VIBEE
# ═══════════════════════════════════════════════════════════════════════════════
#
# Based on: https://github.com/frankbria/ralph-claude-code
# Pattern: Autonomous AI development with intelligent exit detection
#
# PAS DAEMONS: PRE (Precomputation), MLS (ML-Guided Search)
# φ² + 1/φ² = 3 | PHOENIX = 999
#
# ═══════════════════════════════════════════════════════════════════════════════

name: ralph_loop
version: "1.0.0"
language: zig
module: ralph

sacred_constants:
  phi: 1.618033988749895
  trinity: 3.0
  phoenix: 999

creation_pattern:
  source: TaskRequest
  transformer: RalphLoop
  result: CompletedFeature

# ═══════════════════════════════════════════════════════════════════════════════
# TYPES
# ═══════════════════════════════════════════════════════════════════════════════

types:
  - name: LoopState
    description: "Current state of the development loop"
    enum:
      - analyzing
      - specifying
      - generating
      - testing
      - iterating
      - completed
      - failed

  - name: ExitCondition
    description: "Conditions for loop termination"
    enum:
      - tests_passing
      - max_iterations
      - user_interrupt
      - error_threshold

  - name: TaskRequest
    description: "Input task for the loop"
    fields:
      - name: description
        type: String
      - name: max_iterations
        type: Int
      - name: timeout_seconds
        type: Int

  - name: LoopMetrics
    description: "Metrics collected during loop execution"
    fields:
      - name: iterations
        type: Int
      - name: specs_created
        type: Int
      - name: tests_run
        type: Int
      - name: tests_passed
        type: Int
      - name: errors_count
        type: Int

  - name: LoopResult
    description: "Result of loop execution"
    fields:
      - name: state
        type: LoopState
      - name: exit_condition
        type: ExitCondition
      - name: metrics
        type: LoopMetrics
      - name: output_files
        type: List<String>

# ═══════════════════════════════════════════════════════════════════════════════
# BEHAVIORS
# ═══════════════════════════════════════════════════════════════════════════════

behaviors:
  - name: start_loop
    given: "Task request with description"
    when: "Loop is started"
    then: "Initialize loop state and begin analysis"
    pas_pattern: PRE
    test_cases:
      - name: test_start_loop
        input: '{"description": "Add user authentication"}'
        expected: '{"state": "analyzing"}'

  - name: analyze_task
    given: "Loop in analyzing state"
    when: "Task is analyzed"
    then: "Extract requirements and identify needed specs"
    pas_pattern: MLS
    test_cases:
      - name: test_analyze_simple
        input: '{"description": "Add hello world"}'
        expected: '{"specs_needed": 1}'

  - name: create_specification
    given: "Requirements identified"
    when: "Specification is created"
    then: "Write .vibee file with types and behaviors"
    pas_pattern: PRE
    test_cases:
      - name: test_create_spec
        input: '{"name": "hello", "types": []}'
        expected: '{"file": "specs/tri/hello.vibee"}'

  - name: generate_code
    given: "Specification exists"
    when: "vibee-compile is run"
    then: "Auto-generate .zig code from spec"
    pas_pattern: D&C
    test_cases:
      - name: test_generate
        input: '{"spec": "hello.vibee"}'
        expected: '{"output": "trinity/output/hello.zig"}'

  - name: run_tests
    given: "Generated code exists"
    when: "Tests are executed"
    then: "Run zig test and collect results"
    pas_pattern: PRE
    test_cases:
      - name: test_run_tests
        input: '{"file": "hello.zig"}'
        expected: '{"passed": true}'

  - name: check_exit_condition
    given: "Tests completed"
    when: "Exit conditions are checked"
    then: "Determine if loop should continue or exit"
    pas_pattern: MLS
    test_cases:
      - name: test_exit_on_success
        input: '{"tests_passed": true, "iterations": 1}'
        expected: '{"exit": true, "condition": "tests_passing"}'
      - name: test_continue_on_failure
        input: '{"tests_passed": false, "iterations": 1}'
        expected: '{"exit": false}'

  - name: iterate
    given: "Exit condition not met"
    when: "Loop iterates"
    then: "Analyze errors and update specification"
    pas_pattern: MLS
    test_cases:
      - name: test_iterate
        input: '{"errors": ["type mismatch"]}'
        expected: '{"action": "update_spec"}'

  - name: complete_loop
    given: "Exit condition met"
    when: "Loop completes"
    then: "Return final result with metrics"
    pas_pattern: PRE
    test_cases:
      - name: test_complete
        input: '{"state": "completed"}'
        expected: '{"exit_signal": true}'

# ═══════════════════════════════════════════════════════════════════════════════
# LOOP ALGORITHM
# ═══════════════════════════════════════════════════════════════════════════════
#
# while not EXIT_SIGNAL:
#     1. analyze_task()
#     2. create_specification()
#     3. generate_code()      # vibee-compile
#     4. run_tests()          # zig test
#     5. if tests_pass:
#            EXIT_SIGNAL = true
#        else:
#            iterate()
#            increment(iterations)
#            if iterations > max_iterations:
#                EXIT_SIGNAL = true
#                state = failed
#
# ═══════════════════════════════════════════════════════════════════════════════

# ═══════════════════════════════════════════════════════════════════════════════
# φ² + 1/φ² = 3 | PHOENIX = 999
# ═══════════════════════════════════════════════════════════════════════════════
output: trinity/output/ralph_loop.zig
