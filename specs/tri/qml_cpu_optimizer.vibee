# QML CPU Optimizer - CPU-специфичные оптимизации
# SIMD, Cache-aware, Mixed Precision для CPU
# φ² + 1/φ² = 3 | PHOENIX = 999

name: qml_cpu_optimizer
version: "1.0.0"
language: zig
module: qml_cpu_optimizer

sacred_formula:
  expression: "V = n × 3^k × π^m × φ^p"
  golden_identity: "φ² + 1/φ² = 3"

creation_pattern:
  source: GenericKernel
  transformer: CPUOptimizer
  result: OptimizedKernel

types:
  CPUFeatures:
    fields:
      has_avx2: Bool
      has_avx512: Bool
      has_vnni: Bool  # INT8 acceleration
      has_amx: Bool  # Advanced Matrix Extensions
      cache_line_size: Int
      l1_cache: Int
      l2_cache: Int
      l3_cache: Int
      num_cores: Int
      
  TilingConfig:
    fields:
      tile_m: Int
      tile_n: Int
      tile_k: Int
      
  MixedPrecisionConfig:
    fields:
      compute_dtype: DataType  # BF16/FP16
      accumulate_dtype: DataType  # FP32
      storage_dtype: DataType  # INT8/FP16

behaviors:
  - name: detect_cpu_features
    given: "Runtime environment"
    when: "Initialize optimizer"
    then: "Return CPUFeatures struct"
    
  - name: select_optimal_kernel
    given: "Operation type, CPU features"
    when: "Dispatch kernel"
    then: "Return best kernel for hardware"
    priority: ["AVX-512", "AVX2", "SSE4", "Scalar"]
    
  - name: compute_optimal_tiling
    given: "Matrix dimensions, cache sizes"
    when: "Tile for cache efficiency"
    then: "Return TilingConfig"
    goal: "Maximize L2 cache reuse"
    
  - name: fuse_operators
    given: "Sequence of operations"
    when: "Operator fusion"
    then: "Return fused kernel"
    examples:
      - "MatMul + Bias + GELU → FusedLinearGELU"
      - "LayerNorm + Dropout → FusedLNDropout"
      
  - name: parallel_schedule
    given: "Workload, num_cores"
    when: "Multi-threaded execution"
    then: "Return thread assignment"
    strategy: "Work-stealing with cache affinity"
    
  - name: prefetch_schedule
    given: "Memory access pattern"
    when: "Optimize memory access"
    then: "Insert prefetch instructions"
    lookahead: "2-3 cache lines"
