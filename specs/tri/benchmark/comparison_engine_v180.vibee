# ═══════════════════════════════════════════════════════════════════════════════
# COMPARISON ENGINE v180 - Version Comparison & Regression Detection
# ═══════════════════════════════════════════════════════════════════════════════
# PAS Pattern: ALG (Algebraic comparison formulas)
# φ² + 1/φ² = 3 | PHOENIX = 999
# ═══════════════════════════════════════════════════════════════════════════════

name: comparison_engine
version: "1.8.0"
language: zig
module: comparison_engine

sacred_constants:
  phi: 1.618033988749895
  phi_inv: 0.618033988749895
  phi_sq: 2.618033988749895
  trinity: 3.0
  phoenix: 999

creation_pattern:
  source: VersionPair
  transformer: ComparisonEngine
  result: ComparisonReport

# ═══════════════════════════════════════════════════════════════════════════════
# TYPES
# ═══════════════════════════════════════════════════════════════════════════════

types:
  ChangeType:
    enum:
      - improvement
      - regression
      - unchanged
      - new_metric
      - removed_metric

  Severity:
    enum:
      - critical    # >50% regression
      - major       # 20-50% regression
      - minor       # 5-20% regression
      - negligible  # <5% change

  VersionMetrics:
    fields:
      version: String
      timestamp: Timestamp
      metrics: Map<String, Float>
      test_count: Int
      pass_count: Int

  MetricComparison:
    fields:
      name: String
      baseline: Float
      current: Float
      change_percent: Float
      change_type: ChangeType
      severity: Severity

  ComparisonReport:
    fields:
      baseline_version: String
      current_version: String
      timestamp: Timestamp
      comparisons: List<MetricComparison>
      summary: ComparisonSummary
      recommendations: List<String>

  ComparisonSummary:
    fields:
      total_metrics: Int
      improvements: Int
      regressions: Int
      unchanged: Int
      overall_change_percent: Float
      verdict: String

# ═══════════════════════════════════════════════════════════════════════════════
# BEHAVIORS
# ═══════════════════════════════════════════════════════════════════════════════

behaviors:
  - name: compare_metrics
    given: "Baseline and current metrics"
    when: "Comparison requested"
    then: "Return detailed comparison"
    pas_pattern: ALG
    complexity: O(n)
    test_cases:
      - name: test_improvement
        input: '{"baseline": 100, "current": 50}'
        expected: '{"change_percent": -50, "type": "improvement"}'
      - name: test_regression
        input: '{"baseline": 100, "current": 150}'
        expected: '{"change_percent": 50, "type": "regression"}'

  - name: calculate_change_percent
    given: "Baseline and current values"
    when: "Percentage calculation needed"
    then: "Return change percentage"
    pas_pattern: ALG
    complexity: O(1)
    test_cases:
      - name: test_positive
        input: '{"baseline": 100, "current": 120}'
        expected: '{"percent": 20}'
      - name: test_negative
        input: '{"baseline": 100, "current": 80}'
        expected: '{"percent": -20}'

  - name: classify_severity
    given: "Change percentage"
    when: "Severity classification needed"
    then: "Return severity level"
    pas_pattern: PRE
    complexity: O(1)
    test_cases:
      - name: test_critical
        input: '{"change_percent": 60}'
        expected: '{"severity": "critical"}'
      - name: test_negligible
        input: '{"change_percent": 3}'
        expected: '{"severity": "negligible"}'

  - name: generate_recommendations
    given: "Comparison results"
    when: "Recommendations needed"
    then: "Return actionable suggestions"
    pas_pattern: MLS
    complexity: O(n)
    test_cases:
      - name: test_regression_recommendation
        input: '{"regressions": ["parsing"]}'
        expected: '{"recommendations": ["Investigate parsing performance"]}'

  - name: calculate_overall_score
    given: "All metric comparisons"
    when: "Overall score needed"
    then: "Return weighted average improvement"
    pas_pattern: ALG
    complexity: O(n)
    test_cases:
      - name: test_score
        input: '{"improvements": [10, 20], "regressions": [-5]}'
        expected: '{"overall": 8.33}'

  - name: generate_verdict
    given: "Comparison summary"
    when: "Verdict needed"
    then: "Return pass/fail verdict with reasoning"
    pas_pattern: PRE
    complexity: O(1)
    test_cases:
      - name: test_pass
        input: '{"regressions": 0, "improvements": 5}'
        expected: '{"verdict": "PASS", "reason": "All metrics improved or unchanged"}'
      - name: test_fail
        input: '{"regressions": 3, "critical": 1}'
        expected: '{"verdict": "FAIL", "reason": "Critical regression detected"}'

# ═══════════════════════════════════════════════════════════════════════════════
# COMPARISON THRESHOLDS
# ═══════════════════════════════════════════════════════════════════════════════

thresholds:
  severity:
    critical: 50      # >50% regression
    major: 20         # 20-50% regression
    minor: 5          # 5-20% regression
    negligible: 5     # <5% change

  verdict:
    pass_max_regressions: 2
    pass_max_critical: 0
    pass_min_improvement: -10  # Allow up to 10% overall regression

# ═══════════════════════════════════════════════════════════════════════════════
# VERSION HISTORY
# ═══════════════════════════════════════════════════════════════════════════════

version_history:
  - version: "v170"
    date: "2026-01-19"
    metrics:
      code_gen_ms: 100
      parse_ms: 10
      test_count: 350
      pass_rate: 0.98

  - version: "v175"
    date: "2026-01-20"
    metrics:
      code_gen_ms: 75
      parse_ms: 8
      test_count: 370
      pass_rate: 0.99

  - version: "v180"
    date: "2026-01-20"
    metrics:
      code_gen_ms: 50
      parse_ms: 5
      test_count: 390
      pass_rate: 1.0

# ═══════════════════════════════════════════════════════════════════════════════
# REPORT TEMPLATE
# ═══════════════════════════════════════════════════════════════════════════════

report_template: |
  # VIBEE Performance Comparison Report
  
  **Baseline**: {baseline_version}
  **Current**: {current_version}
  **Date**: {timestamp}
  
  ## Summary
  
  | Metric | Baseline | Current | Change | Severity |
  |--------|----------|---------|--------|----------|
  {metric_rows}
  
  ## Verdict: {verdict}
  
  {recommendations}
  
  ---
  φ² + 1/φ² = 3 | PHOENIX = 999

# ═══════════════════════════════════════════════════════════════════════════════
# φ² + 1/φ² = 3 | PHOENIX = 999
# ═══════════════════════════════════════════════════════════════════════════════
