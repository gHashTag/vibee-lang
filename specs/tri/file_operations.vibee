# ═══════════════════════════════════════════════════════════════════════════════
# FILE OPERATIONS SPECIFICATION
# TRI - TRINITY Terminal Interface
# Sacred Formula: V = n × 3^k × π^m × φ^p × e^q
# Golden Identity: φ² + 1/φ² = 3
# ═══════════════════════════════════════════════════════════════════════════════

name: file_operations
version: "1.0.0"
language: tri
module: files

sacred_constants:
  phi: 1.618033988749895
  trinity: 3.0
  phoenix: 999

creation_pattern:
  source: FilePath
  transformer: FileOperation
  result: FileContent | Status

# ═══════════════════════════════════════════════════════════════════════════════
# TYPES
# ═══════════════════════════════════════════════════════════════════════════════

types:
  FileOperation:
    enum:
      - read       # Read file content
      - write      # Write/create file
      - edit       # Edit existing file
      - delete     # Delete file
      - list       # List directory
      - search     # Search in files
      - diff       # Show diff

  FileInfo:
    fields:
      path: String
      name: String
      size: Int
      is_dir: Bool
      modified: Timestamp
      permissions: String

  ReadResult:
    fields:
      content: String
      lines: Int
      size: Int
      encoding: String

  WriteResult:
    fields:
      path: String
      bytes_written: Int
      success: Bool

  EditOperation:
    enum:
      - replace    # str_replace
      - insert     # insert at line
      - delete     # delete lines
      - append     # append to file

  EditRequest:
    fields:
      path: String
      operation: EditOperation
      old_str: Option<String>
      new_str: Option<String>
      line: Option<Int>

  SearchResult:
    fields:
      path: String
      line: Int
      content: String
      match: String

# ═══════════════════════════════════════════════════════════════════════════════
# BEHAVIORS
# ═══════════════════════════════════════════════════════════════════════════════

behaviors:
  - name: read_file
    given: Valid file path
    when: User requests file content
    then: Return file content with metadata
    test_cases:
      - name: read_existing
        input:
          path: "README.md"
        expected:
          success: true
          content: not_empty
      - name: read_nonexistent
        input:
          path: "nonexistent.txt"
        expected:
          success: false
          error: "File not found"

  - name: write_file
    given: Path and content
    when: User writes file
    then: Create or overwrite file
    test_cases:
      - name: write_new
        input:
          path: "test.txt"
          content: "Hello TRI"
        expected:
          success: true
          bytes_written: 9
      - name: write_with_dirs
        input:
          path: "new/dir/file.txt"
          content: "Nested"
        expected:
          success: true

  - name: edit_file
    given: File path and edit operation
    when: User edits file
    then: Apply edit and return result
    test_cases:
      - name: str_replace
        input:
          path: "test.txt"
          operation: replace
          old_str: "Hello"
          new_str: "Hi"
        expected:
          success: true
      - name: insert_line
        input:
          path: "test.txt"
          operation: insert
          line: 1
          new_str: "# Header"
        expected:
          success: true

  - name: list_directory
    given: Directory path
    when: User lists directory
    then: Return list of files and subdirs
    test_cases:
      - name: list_current
        input:
          path: "."
        expected:
          success: true
          items: not_empty
      - name: list_with_filter
        input:
          path: "."
          filter: "*.zig"
        expected:
          success: true

  - name: search_files
    given: Search pattern and path
    when: User searches
    then: Return matching lines
    test_cases:
      - name: search_pattern
        input:
          path: "."
          pattern: "TODO"
        expected:
          results: list
      - name: search_regex
        input:
          path: "."
          pattern: "fn \\w+\\("
          regex: true
        expected:
          results: list

# ═══════════════════════════════════════════════════════════════════════════════
# COMMANDS
# ═══════════════════════════════════════════════════════════════════════════════

commands:
  - name: "tri read"
    usage: "tri read <path> [--lines N] [--from L] [--to L]"
    description: "Read file content"
    examples:
      - "tri read src/main.zig"
      - "tri read README.md --lines 50"
      - "tri read file.txt --from 10 --to 20"

  - name: "tri write"
    usage: "tri write <path> <content>"
    description: "Write content to file"
    examples:
      - "tri write test.txt 'Hello World'"
      - "echo 'content' | tri write file.txt"

  - name: "tri edit"
    usage: "tri edit <path> --replace <old> <new>"
    description: "Edit file with str_replace"
    examples:
      - "tri edit main.zig --replace 'foo' 'bar'"
      - "tri edit file.txt --insert 1 '# Header'"

  - name: "tri ls"
    usage: "tri ls [path] [--all] [--long]"
    description: "List directory contents"
    examples:
      - "tri ls"
      - "tri ls src/ --long"
      - "tri ls . --all"

  - name: "tri search"
    usage: "tri search <pattern> [path] [--regex]"
    description: "Search in files"
    examples:
      - "tri search TODO"
      - "tri search 'fn main' src/"
      - "tri search 'error.*' --regex"

  - name: "tri diff"
    usage: "tri diff <file1> <file2>"
    description: "Show diff between files"
    examples:
      - "tri diff old.txt new.txt"

# ═══════════════════════════════════════════════════════════════════════════════
# SECURITY
# ═══════════════════════════════════════════════════════════════════════════════

security:
  blocked_paths:
    - "/etc/passwd"
    - "/etc/shadow"
    - "~/.ssh/*"
    - "*.pem"
    - "*.key"
    - ".env"
    - ".env.*"
  
  blocked_patterns:
    - "password"
    - "secret"
    - "api_key"
    - "private_key"
  
  max_file_size: 10485760  # 10 MB
  
  require_confirmation:
    - delete
    - write (if exists)

# ═══════════════════════════════════════════════════════════════════════════════
# PAS PREDICTIONS
# ═══════════════════════════════════════════════════════════════════════════════

pas_predictions:
  - target: "File Search"
    current: "grep-based O(n)"
    predicted: "Indexed search O(log n)"
    confidence: 0.80
    patterns: [PRE, HSH]
    timeline: "2026"

  - target: "Large File Handling"
    current: "Load entire file"
    predicted: "Memory-mapped streaming"
    confidence: 0.75
    patterns: [D&C, PRE]
    timeline: "2026"
