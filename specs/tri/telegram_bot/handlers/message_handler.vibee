name: message_handler
version: "2.0.0"
language: zig
module: message_handler

description: |
  Main message handler for VIBEE Telegram bot.
  Routes all incoming messages to appropriate handlers.
  Connects scenes, services, and database layers.

imports:
  - ../navigation/unified_navigation
  - ../menu/reply_keyboard
  - ../scenes/neuro_photo_wizard
  - ../scenes/text_to_video_wizard
  - ../scenes/image_to_video_wizard
  - ../services/replicate_api
  - ../db/user_repository
  - ../db/generation_repository

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# TYPES
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

types:
  MessageContext:
    description: "Incoming message context"
    fields:
      chat_id: Int
      user_id: Int
      message_id: Int
      text: Option<String>
      photo: Option<PhotoInfo>
      voice: Option<VoiceInfo>
      video: Option<VideoInfo>
      document: Option<DocumentInfo>
      from: UserInfo
      reply_to: Option<Int>

  UserInfo:
    description: "Telegram user info"
    fields:
      id: Int
      username: Option<String>
      first_name: Option<String>
      last_name: Option<String>
      language_code: Option<String>
      is_premium: Bool

  PhotoInfo:
    description: "Photo message info"
    fields:
      file_id: String
      file_unique_id: String
      width: Int
      height: Int
      file_size: Option<Int>

  VoiceInfo:
    description: "Voice message info"
    fields:
      file_id: String
      duration: Int
      mime_type: Option<String>

  VideoInfo:
    description: "Video message info"
    fields:
      file_id: String
      duration: Int
      width: Int
      height: Int

  DocumentInfo:
    description: "Document message info"
    fields:
      file_id: String
      file_name: Option<String>
      mime_type: Option<String>
      file_size: Option<Int>

  UserSession:
    description: "User session state"
    fields:
      telegram_id: Int
      current_menu: String
      current_scene: Option<String>
      scene_step: Option<Int>
      scene_data: Option<Object>
      language: String
      balance: Int
      last_activity: Timestamp

  HandlerResult:
    description: "Handler execution result"
    fields:
      success: Bool
      response_text: Option<String>
      response_photo: Option<String>
      response_video: Option<String>
      keyboard: Option<Object>
      edit_message: Bool
      delete_message: Bool
      next_scene: Option<String>
      next_step: Option<Int>

  RouteMatch:
    description: "Route matching result"
    fields:
      route_type: RouteType
      handler_name: String
      params: Option<Object>

  RouteType:
    description: "Route type enum"
    values:
      - command
      - menu_button
      - scene_input
      - media_upload
      - unknown

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ROUTING TABLE
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

routes:
  commands:
    "/start": handle_start
    "/menu": handle_menu
    "/balance": handle_balance
    "/help": handle_help
    "/settings": handle_settings
    "/language": handle_language
    "/support": handle_support
    "/cancel": handle_cancel

  main_menu:
    "ğŸ“¸ ĞĞµĞ¹Ñ€Ğ¾Ñ„Ğ¾Ñ‚Ğ¾": enter_photo_menu
    "ğŸ“¸ Neuro Photo": enter_photo_menu
    "ğŸ¥ Ğ’Ğ¸Ğ´ĞµĞ¾": enter_video_menu
    "ğŸ¥ Video": enter_video_menu
    "ğŸ¤ ĞÑƒĞ´Ğ¸Ğ¾": enter_audio_menu
    "ğŸ¤ Audio": enter_audio_menu
    "ğŸ¤– ĞĞ²Ğ°Ñ‚Ğ°Ñ€": enter_avatar_menu
    "ğŸ¤– Avatar": enter_avatar_menu
    "ğŸ›  Ğ˜Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚Ñ‹": enter_tools_menu
    "ğŸ›  Tools": enter_tools_menu
    "ğŸ’° Ğ‘Ğ°Ğ»Ğ°Ğ½Ñ": show_balance
    "ğŸ’° Balance": show_balance
    "ğŸ’ ĞŸĞ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ÑŒ": show_topup
    "ğŸ’ Top Up": show_topup
    "ğŸ’¬ ĞŸĞ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ°": show_support
    "ğŸ’¬ Support": show_support
    "ğŸŒ EN": switch_to_english
    "ğŸŒ RU": switch_to_russian

  photo_menu:
    "âœ¨ ĞĞµĞ¹Ñ€Ğ¾Ñ„Ğ¾Ñ‚Ğ¾": start_neuro_photo
    "âœ¨ Neuro Photo": start_neuro_photo
    "ğŸ” ĞŸÑ€Ğ¾Ğ¼Ğ¿Ñ‚ Ğ¸Ğ· Ñ„Ğ¾Ñ‚Ğ¾": start_prompt_from_photo
    "ğŸ” Prompt from Photo": start_prompt_from_photo
    "ğŸ­ Ğ—Ğ°Ğ¼ĞµĞ½Ğ° Ğ»Ğ¸Ñ†Ğ°": start_face_swap
    "ğŸ­ Face Swap": start_face_swap
    "â¬†ï¸ ĞĞ¿ÑĞºĞµĞ¹Ğ»": start_upscale
    "â¬†ï¸ Upscale": start_upscale
    "â—€ï¸ ĞĞ°Ğ·Ğ°Ğ´": back_to_main
    "â—€ï¸ Back": back_to_main

  video_menu:
    "ğŸ¥ Ğ¤Ğ¾Ñ‚Ğ¾ Ğ² Ğ²Ğ¸Ğ´ĞµĞ¾": start_image_to_video
    "ğŸ¥ Photo to Video": start_image_to_video
    "ğŸ¬ Ğ¢ĞµĞºÑÑ‚ Ğ² Ğ²Ğ¸Ğ´ĞµĞ¾": start_text_to_video
    "ğŸ¬ Text to Video": start_text_to_video
    "ğŸ‘„ Lip Sync": start_lip_sync
    "â—€ï¸ ĞĞ°Ğ·Ğ°Ğ´": back_to_main
    "â—€ï¸ Back": back_to_main

  audio_menu:
    "ğŸ¤ Ğ“Ğ¾Ğ»Ğ¾Ñ Ğ°Ğ²Ğ°Ñ‚Ğ°Ñ€Ğ°": start_voice_clone
    "ğŸ¤ Avatar Voice": start_voice_clone
    "ğŸ™ï¸ Ğ¢ĞµĞºÑÑ‚ Ğ² Ğ³Ğ¾Ğ»Ğ¾Ñ": start_text_to_speech
    "ğŸ™ï¸ Text to Speech": start_text_to_speech
    "â—€ï¸ ĞĞ°Ğ·Ğ°Ğ´": back_to_main
    "â—€ï¸ Back": back_to_main

  avatar_menu:
    "ğŸ¤– Ğ¦Ğ¸Ñ„Ñ€Ğ¾Ğ²Ğ¾Ğµ Ñ‚ĞµĞ»Ğ¾": start_digital_body
    "ğŸ¤– Digital Body": start_digital_body
    "ğŸ§  ĞœĞ¾Ğ·Ğ³ Ğ°Ğ²Ğ°Ñ‚Ğ°Ñ€Ğ°": start_avatar_brain
    "ğŸ§  Avatar Brain": start_avatar_brain
    "ğŸ’¬ Ğ§Ğ°Ñ‚": start_avatar_chat
    "ğŸ’¬ Chat": start_avatar_chat
    "â—€ï¸ ĞĞ°Ğ·Ğ°Ğ´": back_to_main
    "â—€ï¸ Back": back_to_main

  scene_handlers:
    neuro_photo: handle_neuro_photo_input
    text_to_video: handle_text_to_video_input
    image_to_video: handle_image_to_video_input
    face_swap: handle_face_swap_input
    upscale: handle_upscale_input
    voice_clone: handle_voice_clone_input
    text_to_speech: handle_tts_input
    lip_sync: handle_lip_sync_input
    digital_body: handle_digital_body_input
    avatar_brain: handle_avatar_brain_input

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# BEHAVIORS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

behaviors:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # MAIN ROUTER
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  - name: handle_message
    given: MessageContext
    when: Any message received
    then: |
      1. Get or create user session
      2. Match route (command > menu > scene > unknown)
      3. Execute matched handler
      4. Update session state
      5. Return HandlerResult

  - name: match_route
    given: MessageContext and UserSession
    when: Determining handler
    then: |
      1. If text starts with "/" -> command route
      2. If text matches menu button -> menu route
      3. If user in scene -> scene route
      4. If photo/video/voice -> media route
      5. Else -> unknown route

  - name: execute_handler
    given: RouteMatch and MessageContext
    when: Running handler
    then: |
      1. Load handler by name
      2. Execute with context
      3. Handle errors
      4. Return result

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # COMMAND HANDLERS
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  - name: handle_start
    given: /start command with optional referral code
    when: User starts bot
    then: |
      1. Create or update user in DB
      2. Process referral if present
      3. Reset session to main menu
      4. Send welcome message
      5. Show main menu keyboard

  - name: handle_menu
    given: /menu command
    when: User requests menu
    then: |
      1. Reset scene state
      2. Set menu to main
      3. Show main menu keyboard

  - name: handle_balance
    given: /balance command
    when: User checks balance
    then: |
      1. Get balance from DB
      2. Get spending stats
      3. Format balance message
      4. Send with topup button

  - name: handle_help
    given: /help command
    when: User requests help
    then: |
      1. Get user language
      2. Send help message
      3. Show support contact

  - name: handle_settings
    given: /settings command
    when: User opens settings
    then: |
      1. Show language option
      2. Show notification settings
      3. Show account info

  - name: handle_language
    given: /language command
    when: User changes language
    then: |
      1. Toggle language (ru <-> en)
      2. Update user in DB
      3. Refresh current menu

  - name: handle_support
    given: /support command
    when: User needs support
    then: |
      1. Show support message
      2. Provide contact info

  - name: handle_cancel
    given: /cancel command
    when: User cancels current action
    then: |
      1. Clear scene state
      2. Return to main menu
      3. Send cancellation message

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # MENU NAVIGATION
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  - name: enter_photo_menu
    given: Photo category button
    when: User enters photo menu
    then: |
      1. Set current_menu to "photo"
      2. Show photo submenu keyboard

  - name: enter_video_menu
    given: Video category button
    when: User enters video menu
    then: |
      1. Set current_menu to "video"
      2. Show video submenu keyboard

  - name: enter_audio_menu
    given: Audio category button
    when: User enters audio menu
    then: |
      1. Set current_menu to "audio"
      2. Show audio submenu keyboard

  - name: enter_avatar_menu
    given: Avatar category button
    when: User enters avatar menu
    then: |
      1. Set current_menu to "avatar"
      2. Show avatar submenu keyboard

  - name: enter_tools_menu
    given: Tools category button
    when: User enters tools menu
    then: |
      1. Set current_menu to "tools"
      2. Show tools submenu keyboard

  - name: back_to_main
    given: Back button
    when: User goes back
    then: |
      1. Clear scene state
      2. Set current_menu to "main"
      3. Show main menu keyboard

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # SCENE STARTERS
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  - name: start_neuro_photo
    given: Neuro photo button
    when: User starts neuro photo
    then: |
      1. Check balance >= cost
      2. Set scene to "neuro_photo"
      3. Set step to 1 (model selection)
      4. Show model selection keyboard

  - name: start_text_to_video
    given: Text to video button
    when: User starts text to video
    then: |
      1. Check balance >= cost
      2. Set scene to "text_to_video"
      3. Set step to 1 (model selection)
      4. Show model selection keyboard

  - name: start_image_to_video
    given: Image to video button
    when: User starts image to video
    then: |
      1. Check balance >= cost
      2. Set scene to "image_to_video"
      3. Set step to 1 (photo upload)
      4. Request photo upload

  - name: start_face_swap
    given: Face swap button
    when: User starts face swap
    then: |
      1. Check balance >= cost
      2. Set scene to "face_swap"
      3. Request source photo

  - name: start_upscale
    given: Upscale button
    when: User starts upscale
    then: |
      1. Check balance >= cost
      2. Set scene to "upscale"
      3. Request photo to upscale

  - name: start_voice_clone
    given: Voice clone button
    when: User starts voice clone
    then: |
      1. Check balance >= cost
      2. Set scene to "voice_clone"
      3. Request voice sample

  - name: start_text_to_speech
    given: TTS button
    when: User starts TTS
    then: |
      1. Check balance >= cost
      2. Set scene to "text_to_speech"
      3. Request text input

  - name: start_lip_sync
    given: Lip sync button
    when: User starts lip sync
    then: |
      1. Check balance >= cost
      2. Set scene to "lip_sync"
      3. Request video upload

  - name: start_digital_body
    given: Digital body button
    when: User starts avatar training
    then: |
      1. Check balance >= cost
      2. Set scene to "digital_body"
      3. Request photos for training

  - name: start_avatar_brain
    given: Avatar brain button
    when: User configures avatar AI
    then: |
      1. Set scene to "avatar_brain"
      2. Show brain configuration

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # SCENE INPUT HANDLERS
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  - name: handle_neuro_photo_input
    given: Input while in neuro_photo scene
    when: User provides scene input
    then: |
      1. Get current step
      2. Validate input for step
      3. Process step (model/prompt/size)
      4. If complete -> generate image
      5. Advance to next step or complete

  - name: handle_text_to_video_input
    given: Input while in text_to_video scene
    when: User provides scene input
    then: |
      1. Get current step
      2. Validate input for step
      3. Process step (model/prompt/duration)
      4. If complete -> generate video
      5. Advance to next step or complete

  - name: handle_image_to_video_input
    given: Input while in image_to_video scene
    when: User provides scene input
    then: |
      1. Get current step
      2. Validate input for step
      3. Process step (photo/prompt/duration)
      4. If complete -> animate image
      5. Advance to next step or complete

  - name: handle_face_swap_input
    given: Input while in face_swap scene
    when: User provides photos
    then: |
      1. Collect source and target photos
      2. Validate faces detected
      3. Process face swap
      4. Return result

  - name: handle_upscale_input
    given: Input while in upscale scene
    when: User provides photo
    then: |
      1. Validate photo
      2. Process upscale
      3. Return enhanced image

  - name: handle_voice_clone_input
    given: Input while in voice_clone scene
    when: User provides voice sample
    then: |
      1. Validate audio
      2. Clone voice
      3. Return voice ID

  - name: handle_tts_input
    given: Input while in text_to_speech scene
    when: User provides text
    then: |
      1. Validate text
      2. Generate speech
      3. Return audio

  - name: handle_lip_sync_input
    given: Input while in lip_sync scene
    when: User provides video and audio
    then: |
      1. Validate media
      2. Process lip sync
      3. Return synced video

  - name: handle_digital_body_input
    given: Input while in digital_body scene
    when: User provides training photos
    then: |
      1. Collect photos (10-20)
      2. Validate quality
      3. Start training
      4. Track progress

  - name: handle_avatar_brain_input
    given: Input while in avatar_brain scene
    when: User configures AI
    then: |
      1. Process configuration
      2. Save settings
      3. Confirm setup

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # UTILITY HANDLERS
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  - name: show_balance
    given: Balance button
    when: User checks balance
    then: Same as handle_balance

  - name: show_topup
    given: Top up button
    when: User wants to add funds
    then: |
      1. Show payment options
      2. Generate invoice buttons

  - name: show_support
    given: Support button
    when: User needs help
    then: Same as handle_support

  - name: switch_to_english
    given: EN button
    when: User switches to English
    then: |
      1. Set language to "en"
      2. Update DB
      3. Refresh menu

  - name: switch_to_russian
    given: RU button
    when: User switches to Russian
    then: |
      1. Set language to "ru"
      2. Update DB
      3. Refresh menu

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # SESSION MANAGEMENT
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  - name: get_session
    given: Telegram ID
    when: Loading user session
    then: |
      1. Check memory cache
      2. If not found, load from DB
      3. Create default if new user
      4. Return UserSession

  - name: save_session
    given: UserSession
    when: Persisting session
    then: |
      1. Update memory cache
      2. Persist to DB (async)

  - name: clear_scene
    given: UserSession
    when: Exiting scene
    then: |
      1. Set current_scene to null
      2. Set scene_step to null
      3. Clear scene_data

  - name: advance_scene_step
    given: UserSession
    when: Moving to next step
    then: |
      1. Increment scene_step
      2. Save session

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # ERROR HANDLING
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  - name: handle_insufficient_balance
    given: Required cost
    when: Balance too low
    then: |
      1. Send insufficient balance message
      2. Show current balance
      3. Offer top up option

  - name: handle_unknown_message
    given: Unrecognized input
    when: No route matched
    then: |
      1. Send help hint
      2. Show current menu

  - name: handle_error
    given: Error during processing
    when: Handler fails
    then: |
      1. Log error
      2. Send user-friendly message
      3. Offer retry or cancel

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# CONSTANTS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

constants:
  DEFAULT_LANGUAGE: "ru"
  DEFAULT_MENU: "main"
  SESSION_TTL_SECONDS: 3600
  MAX_PROMPT_LENGTH: 2000
  MIN_PROMPT_LENGTH: 3

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# MESSAGES
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

messages:
  welcome:
    ru: |
      ğŸ‘‹ Ğ”Ğ¾Ğ±Ñ€Ğ¾ Ğ¿Ğ¾Ğ¶Ğ°Ğ»Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ² VIBEE!
      
      Ğ¯ Ğ¿Ğ¾Ğ¼Ğ¾Ğ³Ñƒ ÑĞ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ:
      ğŸ“¸ ĞĞµĞ¹Ñ€Ğ¾Ñ„Ğ¾Ñ‚Ğ¾ Ñ AI
      ğŸ¥ Ğ’Ğ¸Ğ´ĞµĞ¾ Ğ¸Ğ· Ñ‚ĞµĞºÑÑ‚Ğ° Ğ¸ Ñ„Ğ¾Ñ‚Ğ¾
      ğŸ¤ ĞšĞ»Ğ¾Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ³Ğ¾Ğ»Ğ¾ÑĞ°
      ğŸ¤– Ğ¦Ğ¸Ñ„Ñ€Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ°Ğ²Ğ°Ñ‚Ğ°Ñ€Ğ°
      
      Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ñ Ğ² Ğ¼ĞµĞ½Ñ Ğ½Ğ¸Ğ¶Ğµ ğŸ‘‡
    en: |
      ğŸ‘‹ Welcome to VIBEE!
      
      I can help you create:
      ğŸ“¸ AI-generated photos
      ğŸ¥ Videos from text and photos
      ğŸ¤ Voice cloning
      ğŸ¤– Digital avatars
      
      Choose a category below ğŸ‘‡

  insufficient_balance:
    ru: |
      âŒ ĞĞµĞ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ Ğ·Ğ²Ñ‘Ğ·Ğ´
      
      ğŸ’° Ğ’Ğ°Ñˆ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ: {balance} â­
      ğŸ’ Ğ¢Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ: {cost} â­
      
      ĞŸĞ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚Ğµ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½Ğ¸Ñ
    en: |
      âŒ Insufficient stars
      
      ğŸ’° Your balance: {balance} â­
      ğŸ’ Required: {cost} â­
      
      Top up to continue

  balance_info:
    ru: |
      ğŸ’° Ğ’Ğ°Ñˆ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ: {balance} â­
      
      ğŸ“Š Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ°:
      â€¢ Ğ’ÑĞµĞ³Ğ¾ Ğ¿Ğ¾Ñ‚Ñ€Ğ°Ñ‡ĞµĞ½Ğ¾: {spent} â­
      â€¢ Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¹: {generations}
    en: |
      ğŸ’° Your balance: {balance} â­
      
      ğŸ“Š Statistics:
      â€¢ Total spent: {spent} â­
      â€¢ Generations: {generations}

  cancelled:
    ru: "âŒ Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ Ğ¾Ñ‚Ğ¼ĞµĞ½ĞµĞ½Ğ¾"
    en: "âŒ Action cancelled"

  unknown_command:
    ru: "â“ ĞĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ğ°Ñ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ°. Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ /help Ğ´Ğ»Ñ ÑĞ¿Ñ€Ğ°Ğ²ĞºĞ¸."
    en: "â“ Unknown command. Use /help for assistance."
