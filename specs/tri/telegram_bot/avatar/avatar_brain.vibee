name: avatar_brain
version: "1.0.0"
language: zig
module: avatar_brain

description: |
  Avatar brain for VIBEE Telegram bot.
  Personality, memory, conversation, knowledge base.
  Powers AI-driven avatar interactions.

# ═══════════════════════════════════════════════════════════════════════════════
# TYPES
# ═══════════════════════════════════════════════════════════════════════════════

types:
  BrainService:
    description: "Avatar brain service"
    fields:
      config: BrainConfig
      llm_client: Object
      vector_store: Object
      database: Object
      stats: BrainStats
      is_initialized: Bool

  BrainConfig:
    description: "Brain configuration"
    fields:
      default_model: String
      max_context_tokens: Int
      max_memory_items: Int
      memory_decay_days: Int
      enable_long_term_memory: Bool
      enable_knowledge_base: Bool
      temperature: Float
      top_p: Float

  BrainStats:
    description: "Brain statistics"
    fields:
      conversations_total: Int
      messages_processed: Int
      memories_stored: Int
      knowledge_items: Int
      avg_response_time_ms: Int
      tokens_used: Int

  # ─────────────────────────────────────────────────────────────────────────────
  # PERSONALITY
  # ─────────────────────────────────────────────────────────────────────────────

  Personality:
    description: "Avatar personality"
    fields:
      personality_id: String
      avatar_id: String
      name: String
      bio: String
      traits: PersonalityTraits
      background: PersonalityBackground
      communication_style: CommunicationStyle
      knowledge_domains: List<String>
      system_prompt: String
      created_at: Timestamp
      updated_at: Timestamp

  PersonalityTraits:
    description: "Personality traits (Big Five)"
    fields:
      openness: Float
      conscientiousness: Float
      extraversion: Float
      agreeableness: Float
      neuroticism: Float
      custom_traits: List<CustomTrait>

  CustomTrait:
    description: "Custom trait"
    fields:
      name: String
      value: Float
      description: String

  PersonalityBackground:
    description: "Personality background"
    fields:
      occupation: Option<String>
      company: Option<String>
      position: Option<String>
      education: Option<String>
      skills: List<String>
      interests: List<String>
      achievements: List<String>
      backstory: Option<String>

  CommunicationStyle:
    description: "Communication style"
    fields:
      tone: ConversationTone
      formality: FormalityLevel
      verbosity: VerbosityLevel
      humor_level: Float
      emoji_usage: EmojiUsage
      language: String
      dialect: Option<String>
      catchphrases: List<String>

  ConversationTone:
    description: "Conversation tone"
    values:
      - friendly
      - professional
      - casual
      - formal
      - playful
      - serious
      - empathetic
      - authoritative

  FormalityLevel:
    description: "Formality level"
    values:
      - very_informal
      - informal
      - neutral
      - formal
      - very_formal

  VerbosityLevel:
    description: "Verbosity level"
    values:
      - concise
      - balanced
      - detailed
      - verbose

  EmojiUsage:
    description: "Emoji usage"
    values:
      - none
      - minimal
      - moderate
      - frequent

  # ─────────────────────────────────────────────────────────────────────────────
  # MEMORY
  # ─────────────────────────────────────────────────────────────────────────────

  Memory:
    description: "Avatar memory"
    fields:
      memory_id: String
      avatar_id: String
      user_id: Int
      memory_type: MemoryType
      content: String
      embedding: Option<String>
      importance: Float
      access_count: Int
      last_accessed: Timestamp
      created_at: Timestamp
      expires_at: Option<Timestamp>
      metadata: Object

  MemoryType:
    description: "Memory type"
    values:
      - episodic
      - semantic
      - procedural
      - emotional
      - factual
      - preference

  MemoryBank:
    description: "Memory bank"
    fields:
      avatar_id: String
      user_id: Int
      short_term: List<Memory>
      long_term: List<Memory>
      working_memory: List<Memory>
      total_memories: Int
      last_consolidation: Timestamp

  MemoryQuery:
    description: "Memory query"
    fields:
      avatar_id: String
      user_id: Option<Int>
      query_text: String
      memory_types: Option<List<MemoryType>>
      min_importance: Option<Float>
      limit: Int

  MemoryResult:
    description: "Memory result"
    fields:
      memories: List<Memory>
      relevance_scores: List<Float>
      total_found: Int

  ConsolidationResult:
    description: "Memory consolidation result"
    fields:
      memories_consolidated: Int
      memories_expired: Int
      memories_strengthened: Int

  # ─────────────────────────────────────────────────────────────────────────────
  # CONVERSATION
  # ─────────────────────────────────────────────────────────────────────────────

  Conversation:
    description: "Conversation"
    fields:
      conversation_id: String
      avatar_id: String
      user_id: Int
      messages: List<Message>
      context: ConversationContext
      status: ConversationStatus
      started_at: Timestamp
      last_message_at: Timestamp
      metadata: Object

  Message:
    description: "Message"
    fields:
      message_id: String
      role: MessageRole
      content: String
      tokens: Int
      timestamp: Timestamp
      metadata: Object

  MessageRole:
    description: "Message role"
    values:
      - user
      - assistant
      - system
      - function

  ConversationContext:
    description: "Conversation context"
    fields:
      topic: Option<String>
      mood: Option<Mood>
      intent: Option<Intent>
      entities: List<Entity>
      relevant_memories: List<String>

  ConversationStatus:
    description: "Conversation status"
    values:
      - active
      - paused
      - ended
      - archived

  Mood:
    description: "Detected mood"
    values:
      - happy
      - sad
      - angry
      - neutral
      - excited
      - confused
      - curious

  Intent:
    description: "Detected intent"
    values:
      - question
      - statement
      - request
      - greeting
      - farewell
      - complaint
      - praise
      - small_talk

  Entity:
    description: "Extracted entity"
    fields:
      entity_type: String
      value: String
      confidence: Float

  # ─────────────────────────────────────────────────────────────────────────────
  # CHAT
  # ─────────────────────────────────────────────────────────────────────────────

  ChatInput:
    description: "Chat input"
    fields:
      avatar_id: String
      user_id: Int
      message: String
      conversation_id: Option<String>
      include_memory: Bool
      include_knowledge: Bool
      max_tokens: Option<Int>

  ChatOutput:
    description: "Chat output"
    fields:
      response: String
      conversation_id: String
      message_id: String
      tokens_used: Int
      memories_used: List<String>
      knowledge_used: List<String>
      detected_intent: Option<Intent>
      detected_mood: Option<Mood>
      response_time_ms: Int

  StreamChunk:
    description: "Stream chunk"
    fields:
      chunk_id: Int
      content: String
      is_final: Bool

  # ─────────────────────────────────────────────────────────────────────────────
  # KNOWLEDGE BASE
  # ─────────────────────────────────────────────────────────────────────────────

  KnowledgeItem:
    description: "Knowledge item"
    fields:
      item_id: String
      avatar_id: String
      category: KnowledgeCategory
      title: String
      content: String
      embedding: Option<String>
      source: Option<String>
      confidence: Float
      created_at: Timestamp
      updated_at: Timestamp

  KnowledgeCategory:
    description: "Knowledge category"
    values:
      - general
      - personal
      - professional
      - technical
      - creative
      - faq
      - custom

  KnowledgeQuery:
    description: "Knowledge query"
    fields:
      avatar_id: String
      query_text: String
      categories: Option<List<KnowledgeCategory>>
      min_confidence: Option<Float>
      limit: Int

  KnowledgeResult:
    description: "Knowledge result"
    fields:
      items: List<KnowledgeItem>
      relevance_scores: List<Float>
      total_found: Int

  # ─────────────────────────────────────────────────────────────────────────────
  # LEARNING
  # ─────────────────────────────────────────────────────────────────────────────

  LearningEvent:
    description: "Learning event"
    fields:
      event_id: String
      avatar_id: String
      event_type: LearningEventType
      content: String
      source: LearningSource
      confidence: Float
      created_at: Timestamp

  LearningEventType:
    description: "Learning event type"
    values:
      - user_correction
      - user_feedback
      - conversation_insight
      - knowledge_update
      - preference_learned

  LearningSource:
    description: "Learning source"
    values:
      - conversation
      - explicit_teaching
      - document_upload
      - api_integration

  FeedbackInput:
    description: "Feedback input"
    fields:
      message_id: String
      feedback_type: FeedbackType
      comment: Option<String>

  FeedbackType:
    description: "Feedback type"
    values:
      - positive
      - negative
      - correction
      - suggestion

  # ─────────────────────────────────────────────────────────────────────────────
  # ERRORS
  # ─────────────────────────────────────────────────────────────────────────────

  BrainError:
    description: "Brain error"
    fields:
      code: ErrorCode
      message: String
      details: Option<String>

  ErrorCode:
    description: "Error code"
    values:
      - avatar_not_found
      - personality_not_found
      - conversation_not_found
      - memory_limit_exceeded
      - context_too_long
      - llm_error
      - embedding_error
      - rate_limited

# ═══════════════════════════════════════════════════════════════════════════════
# BEHAVIORS
# ═══════════════════════════════════════════════════════════════════════════════

behaviors:
  # ─────────────────────────────────────────────────────────────────────────────
  # LIFECYCLE
  # ─────────────────────────────────────────────────────────────────────────────

  - name: create_service
    given: BrainConfig
    when: Creating service
    then: Return BrainService

  - name: initialize
    given: No parameters
    when: Initializing service
    then: Setup connections

  - name: get_stats
    given: No parameters
    when: Getting statistics
    then: Return BrainStats

  # ─────────────────────────────────────────────────────────────────────────────
  # PERSONALITY
  # ─────────────────────────────────────────────────────────────────────────────

  - name: create_personality
    given: Avatar ID and traits
    when: Creating personality
    then: Return Personality

  - name: get_personality
    given: Avatar ID
    when: Getting personality
    then: Return Personality

  - name: update_personality
    given: Avatar ID and updates
    when: Updating personality
    then: Return Personality

  - name: update_traits
    given: Avatar ID and PersonalityTraits
    when: Updating traits
    then: Return success

  - name: update_background
    given: Avatar ID and PersonalityBackground
    when: Updating background
    then: Return success

  - name: update_communication_style
    given: Avatar ID and CommunicationStyle
    when: Updating style
    then: Return success

  - name: generate_system_prompt
    given: Personality
    when: Generating prompt
    then: Return system prompt

  # ─────────────────────────────────────────────────────────────────────────────
  # MEMORY
  # ─────────────────────────────────────────────────────────────────────────────

  - name: store_memory
    given: Avatar ID, user ID, content
    when: Storing memory
    then: Return Memory

  - name: recall_memories
    given: MemoryQuery
    when: Recalling memories
    then: Return MemoryResult

  - name: get_memory_bank
    given: Avatar ID and user ID
    when: Getting memory bank
    then: Return MemoryBank

  - name: forget_memory
    given: Memory ID
    when: Forgetting memory
    then: Return success

  - name: consolidate_memories
    given: Avatar ID
    when: Consolidating memories
    then: Return ConsolidationResult

  - name: update_memory_importance
    given: Memory ID and importance
    when: Updating importance
    then: Return success

  - name: clear_user_memories
    given: Avatar ID and user ID
    when: Clearing memories
    then: Return deleted count

  # ─────────────────────────────────────────────────────────────────────────────
  # CONVERSATION
  # ─────────────────────────────────────────────────────────────────────────────

  - name: chat
    given: ChatInput
    when: Chatting
    then: Return ChatOutput

  - name: chat_stream
    given: ChatInput
    when: Streaming chat
    then: Return stream

  - name: start_conversation
    given: Avatar ID and user ID
    when: Starting conversation
    then: Return Conversation

  - name: get_conversation
    given: Conversation ID
    when: Getting conversation
    then: Return Conversation

  - name: get_conversation_history
    given: Avatar ID and user ID
    when: Getting history
    then: Return conversation list

  - name: end_conversation
    given: Conversation ID
    when: Ending conversation
    then: Return success

  - name: summarize_conversation
    given: Conversation ID
    when: Summarizing
    then: Return summary

  # ─────────────────────────────────────────────────────────────────────────────
  # KNOWLEDGE BASE
  # ─────────────────────────────────────────────────────────────────────────────

  - name: add_knowledge
    given: Avatar ID and content
    when: Adding knowledge
    then: Return KnowledgeItem

  - name: query_knowledge
    given: KnowledgeQuery
    when: Querying knowledge
    then: Return KnowledgeResult

  - name: update_knowledge
    given: Item ID and content
    when: Updating knowledge
    then: Return KnowledgeItem

  - name: delete_knowledge
    given: Item ID
    when: Deleting knowledge
    then: Return success

  - name: import_knowledge
    given: Avatar ID and documents
    when: Importing knowledge
    then: Return import count

  - name: get_knowledge_stats
    given: Avatar ID
    when: Getting stats
    then: Return knowledge stats

  # ─────────────────────────────────────────────────────────────────────────────
  # LEARNING
  # ─────────────────────────────────────────────────────────────────────────────

  - name: learn_from_conversation
    given: Conversation ID
    when: Learning
    then: Return LearningEvent list

  - name: process_feedback
    given: FeedbackInput
    when: Processing feedback
    then: Return success

  - name: teach_avatar
    given: Avatar ID and content
    when: Teaching
    then: Return LearningEvent

  - name: get_learning_history
    given: Avatar ID
    when: Getting history
    then: Return event list

  # ─────────────────────────────────────────────────────────────────────────────
  # ANALYSIS
  # ─────────────────────────────────────────────────────────────────────────────

  - name: analyze_mood
    given: Message text
    when: Analyzing mood
    then: Return Mood

  - name: detect_intent
    given: Message text
    when: Detecting intent
    then: Return Intent

  - name: extract_entities
    given: Message text
    when: Extracting entities
    then: Return Entity list

# ═══════════════════════════════════════════════════════════════════════════════
# CONSTANTS
# ═══════════════════════════════════════════════════════════════════════════════

constants:
  DEFAULT_MODEL: "gpt-4o-mini"
  DEFAULT_MAX_CONTEXT_TOKENS: 8000
  DEFAULT_MAX_MEMORY_ITEMS: 1000
  DEFAULT_MEMORY_DECAY_DAYS: 90
  DEFAULT_TEMPERATURE: 0.7
  DEFAULT_TOP_P: 0.9

  # Memory settings
  SHORT_TERM_MEMORY_SIZE: 20
  WORKING_MEMORY_SIZE: 5
  MEMORY_CONSOLIDATION_THRESHOLD: 0.5
  MEMORY_IMPORTANCE_DECAY: 0.95

  # Conversation settings
  MAX_CONVERSATION_MESSAGES: 100
  MAX_MESSAGE_LENGTH: 4000
  CONVERSATION_TIMEOUT_HOURS: 24

  # Knowledge settings
  MAX_KNOWLEDGE_ITEMS: 10000
  KNOWLEDGE_CHUNK_SIZE: 500
  KNOWLEDGE_OVERLAP: 50

  # Embedding settings
  EMBEDDING_MODEL: "text-embedding-3-small"
  EMBEDDING_DIMENSIONS: 1536
  SIMILARITY_THRESHOLD: 0.7
