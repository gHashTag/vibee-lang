# Supabase Database Schema
# PostgreSQL tables for 999-multibots-telegraf

name: supabase_schema
version: "1.0.0"
language: zig
module: supabase_schema

description: |
  Схема базы данных Supabase (PostgreSQL).
  Таблицы для хранения пользователей, платежей, генераций.

constants:
  DATABASE_URL: "SUPABASE_URL"
  SERVICE_KEY: "SUPABASE_SERVICE_KEY"

types:
  # ═══════════════════════════════════════════════════════════════
  # USERS TABLE
  # ═══════════════════════════════════════════════════════════════

  User:
    description: "Пользователь бота"
    table: "users"
    fields:
      id: String                    # UUID primary key
      telegram_id: Int              # Telegram user ID (unique)
      username: Option<String>      # Telegram username
      first_name: Option<String>
      last_name: Option<String>
      language_code: String         # ru, en, etc.
      balance: Int                  # Stars balance (default 0)
      level: Int                    # User level (default 1)
      is_premium: Bool              # Telegram Premium
      is_banned: Bool               # Banned status
      referral_code: Option<String> # Unique referral code
      referred_by: Option<String>   # Referrer's telegram_id
      created_at: Timestamp
      updated_at: Timestamp

  # ═══════════════════════════════════════════════════════════════
  # PAYMENTS TABLE (v2)
  # ═══════════════════════════════════════════════════════════════

  Payment:
    description: "Запись о платеже"
    table: "payments_v2"
    fields:
      id: String                    # UUID primary key
      telegram_id: Int              # User's telegram ID
      amount_stars: Int             # Amount in stars
      amount_usd: Option<Float>     # Amount in USD
      amount_rubles: Option<Float>  # Amount in rubles
      payment_method: String        # stars, robokassa, cryptobot
      payment_type: String          # top_up, service_payment
      service: Option<String>       # Service name if service_payment
      status: String                # pending, completed, failed, refunded
      external_id: Option<String>   # External payment ID
      metadata: Option<Object>      # Additional data (JSON)
      created_at: Timestamp
      completed_at: Option<Timestamp>

  # ═══════════════════════════════════════════════════════════════
  # PROMPTS HISTORY TABLE
  # ═══════════════════════════════════════════════════════════════

  PromptHistory:
    description: "История генераций"
    table: "prompts_history"
    fields:
      id: Int                       # Serial primary key
      telegram_id: Int              # User's telegram ID
      prompt: String                # User's prompt
      model: String                 # Model used
      result_url: Option<String>    # Result URL
      cost_stars: Int               # Cost in stars
      service: String               # Service name
      status: String                # pending, completed, failed
      error: Option<String>         # Error message if failed
      created_at: Timestamp

  # ═══════════════════════════════════════════════════════════════
  # MODEL TRAININGS TABLE
  # ═══════════════════════════════════════════════════════════════

  ModelTraining:
    description: "Обучение моделей (FLUX LoRA)"
    table: "model_trainings"
    fields:
      id: String                    # UUID primary key
      telegram_id: Int              # User's telegram ID
      model_name: String            # Custom model name
      trigger_word: String          # Trigger word for model
      zip_url: String               # Training images ZIP URL
      steps: Int                    # Training steps
      status: String                # starting, processing, succeeded, failed
      gender: Option<String>        # male, female
      api: String                   # replicate, fal
      bot_name: Option<String>      # Bot name
      model_url: Option<String>     # Trained model URL
      replicate_training_id: Option<String>
      replicate_model_id: Option<String>
      version_id: Option<String>
      error: Option<String>
      created_at: Timestamp
      completed_at: Option<Timestamp>

  # ═══════════════════════════════════════════════════════════════
  # AVATARS TABLE
  # ═══════════════════════════════════════════════════════════════

  Avatar:
    description: "Цифровые аватары пользователей"
    table: "avatars"
    fields:
      id: String                    # UUID primary key
      telegram_id: Int              # User's telegram ID
      name: String                  # Avatar name
      model_url: String             # Trained model URL
      trigger_word: String          # Trigger word
      gender: String                # male, female
      voice_id: Option<String>      # ElevenLabs voice ID
      is_active: Bool               # Is default avatar
      preview_url: Option<String>   # Preview image URL
      created_at: Timestamp

  # ═══════════════════════════════════════════════════════════════
  # BOTS TABLE
  # ═══════════════════════════════════════════════════════════════

  Bot:
    description: "Мультибот конфигурации"
    table: "bots"
    fields:
      id: String                    # UUID primary key
      bot_name: String              # Bot username
      bot_token: String             # Bot token (encrypted)
      owner_telegram_id: Int        # Owner's telegram ID
      is_active: Bool               # Is bot active
      settings: Option<Object>      # Bot settings (JSON)
      created_at: Timestamp

  # ═══════════════════════════════════════════════════════════════
  # TRANSLATIONS TABLE
  # ═══════════════════════════════════════════════════════════════

  Translation:
    description: "Локализация"
    table: "translations"
    fields:
      id: Int                       # Serial primary key
      key: String                   # Translation key
      language: String              # Language code
      value: String                 # Translated text
      category: Option<String>      # Category for grouping

  # ═══════════════════════════════════════════════════════════════
  # DAILY BALANCE STATS TABLE
  # ═══════════════════════════════════════════════════════════════

  DailyBalanceStats:
    description: "Ежедневная статистика балансов"
    table: "daily_balance_stats"
    fields:
      id: Int                       # Serial primary key
      date: String                  # Date (YYYY-MM-DD)
      total_users: Int              # Total users count
      total_balance: Int            # Sum of all balances
      total_payments: Int           # Total payments count
      total_revenue_stars: Int      # Revenue in stars
      total_revenue_usd: Float      # Revenue in USD
      created_at: Timestamp

behaviors:
  # ═══════════════════════════════════════════════════════════════
  # USER OPERATIONS
  # ═══════════════════════════════════════════════════════════════

  - name: get_user_by_telegram_id
    given: Telegram ID
    when: Fetching user
    then: Returns User or null

  - name: create_user
    given: User data
    when: Creating new user
    then: Inserts user and returns User

  - name: update_user_balance
    given: Telegram ID and delta
    when: Updating balance
    then: Updates balance and returns new value

  - name: get_user_balance
    given: Telegram ID
    when: Fetching balance
    then: Returns balance in stars

  # ═══════════════════════════════════════════════════════════════
  # PAYMENT OPERATIONS
  # ═══════════════════════════════════════════════════════════════

  - name: create_payment
    given: Payment data
    when: Recording payment
    then: Inserts payment record

  - name: complete_payment
    given: Payment ID
    when: Payment completed
    then: Updates status and completed_at

  - name: get_payment_history
    given: Telegram ID and pagination
    when: Fetching history
    then: Returns list of payments

  # ═══════════════════════════════════════════════════════════════
  # GENERATION OPERATIONS
  # ═══════════════════════════════════════════════════════════════

  - name: save_prompt
    given: Prompt data
    when: Saving generation
    then: Inserts prompt history record

  - name: get_user_generations
    given: Telegram ID and pagination
    when: Fetching generations
    then: Returns list of generations

  # ═══════════════════════════════════════════════════════════════
  # MODEL TRAINING OPERATIONS
  # ═══════════════════════════════════════════════════════════════

  - name: create_model_training
    given: Training data
    when: Starting training
    then: Inserts training record

  - name: update_model_training
    given: Training ID and status
    when: Updating training
    then: Updates training record

  - name: get_user_models
    given: Telegram ID
    when: Fetching models
    then: Returns list of trained models

  # ═══════════════════════════════════════════════════════════════
  # AVATAR OPERATIONS
  # ═══════════════════════════════════════════════════════════════

  - name: get_user_avatars
    given: Telegram ID
    when: Fetching avatars
    then: Returns list of avatars

  - name: set_active_avatar
    given: Telegram ID and avatar ID
    when: Setting active avatar
    then: Updates is_active flags

# Indexes for performance
indexes:
  users:
    - column: telegram_id
      unique: true
  payments_v2:
    - column: telegram_id
    - column: status
    - column: created_at
  prompts_history:
    - column: telegram_id
    - column: created_at
  model_trainings:
    - column: telegram_id
    - column: status
  avatars:
    - column: telegram_id
