name: generation_repository
version: "1.0.0"
language: zig
module: generation_repository

description: |
  Generation repository for VIBEE Telegram bot.
  Handles AI generation history and statistics.

imports:
  - supabase_client
  - user

types:
  CreateGenerationInput:
    description: "Input for creating generation record"
    fields:
      user_id: String
      telegram_id: String
      generation_type: String
      prompt: Option<String>
      model_url: Option<String>
      input_url: Option<String>
      cost_stars: Int

  GenerationRecord:
    description: "Generation record in database"
    fields:
      id: String
      user_id: String
      telegram_id: String
      generation_type: String
      prompt: Option<String>
      model_url: Option<String>
      input_url: Option<String>
      output_urls: Option<List<String>>
      status: String
      cost_stars: Int
      created_at: Timestamp
      completed_at: Option<Timestamp>

  GenerationFilter:
    description: "Filter for querying generations"
    fields:
      user_id: Option<String>
      telegram_id: Option<String>
      generation_type: Option<String>
      status: Option<String>
      created_after: Option<Timestamp>
      created_before: Option<Timestamp>

  GenerationStats:
    description: "Generation statistics"
    fields:
      total_count: Int
      by_type: Object
      total_cost: Int
      success_rate: Float

behaviors:
  - name: create_generation
    given: CreateGenerationInput
    when: Creating generation record
    then: Returns GenerationRecord

  - name: get_generation_by_id
    given: Generation ID
    when: Fetching generation
    then: Returns GenerationRecord or null

  - name: update_generation_status
    given: Generation ID and status
    when: Updating status
    then: Returns updated GenerationRecord

  - name: set_generation_output
    given: Generation ID and output URLs
    when: Setting output
    then: Returns updated GenerationRecord

  - name: get_user_generations
    given: User ID and pagination
    when: Fetching history
    then: Returns list of GenerationRecord

  - name: find_generations
    given: GenerationFilter
    when: Searching generations
    then: Returns list of GenerationRecord

  - name: get_generation_stats
    given: User ID and date range
    when: Getting statistics
    then: Returns GenerationStats

  - name: increment_generated_images
    given: User ID
    when: Incrementing count
    then: Returns new count

  - name: get_generated_images_count
    given: User ID
    when: Getting count
    then: Returns count

  - name: save_prompt
    given: User ID and prompt
    when: Saving prompt
    then: Returns success status

  - name: get_saved_prompts
    given: User ID
    when: Fetching prompts
    then: Returns list of prompts
