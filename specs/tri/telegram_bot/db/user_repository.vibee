name: user_repository
version: "1.0.0"
language: zig
module: user_repository

description: |
  User repository for VIBEE Telegram bot.
  Handles all user-related database operations.

imports:
  - supabase_client
  - user

types:
  CreateUserInput:
    description: "Input for creating user"
    fields:
      telegram_id: String
      username: Option<String>
      first_name: Option<String>
      last_name: Option<String>
      language_code: String
      is_bot: Bool
      is_premium: Bool
      inviter_id: Option<String>

  UpdateUserInput:
    description: "Input for updating user"
    fields:
      username: Option<String>
      first_name: Option<String>
      last_name: Option<String>
      language_code: Option<String>
      is_premium: Option<Bool>

  UserFilter:
    description: "Filter for querying users"
    fields:
      telegram_id: Option<String>
      username: Option<String>
      is_premium: Option<Bool>
      level_min: Option<Int>
      level_max: Option<Int>
      created_after: Option<Timestamp>
      created_before: Option<Timestamp>

  UserStats:
    description: "User statistics"
    fields:
      total_generations: Int
      total_spent_stars: Int
      total_spent_rubles: Float
      referral_count: Int
      days_active: Int

behaviors:
  - name: create_user
    given: CreateUserInput
    when: Creating new user
    then: Returns User

  - name: get_user_by_telegram_id
    given: Telegram ID
    when: Fetching user
    then: Returns User or null

  - name: get_user_by_id
    given: User ID
    when: Fetching user
    then: Returns User or null

  - name: update_user
    given: User ID and UpdateUserInput
    when: Updating user
    then: Returns updated User

  - name: delete_user
    given: User ID
    when: Deleting user
    then: Returns success status

  - name: get_user_balance
    given: Telegram ID
    when: Fetching balance
    then: Returns UserBalance

  - name: update_user_balance
    given: Telegram ID and amount
    when: Updating balance
    then: Returns new balance

  - name: get_user_level
    given: Telegram ID
    when: Fetching level
    then: Returns UserLevel

  - name: update_user_level
    given: Telegram ID and level
    when: Updating level
    then: Returns success status

  - name: increment_user_level
    given: Telegram ID
    when: Incrementing level
    then: Returns new level

  - name: get_user_language
    given: Telegram ID
    when: Fetching language
    then: Returns language code

  - name: update_user_language
    given: Telegram ID and language
    when: Updating language
    then: Returns success status

  - name: get_user_stats
    given: User ID
    when: Fetching statistics
    then: Returns UserStats

  - name: get_referrals_count
    given: User ID
    when: Counting referrals
    then: Returns count

  - name: find_users
    given: UserFilter
    when: Searching users
    then: Returns list of User

  - name: count_users
    given: UserFilter
    when: Counting users
    then: Returns count

  - name: deduplicate_users
    given: No parameters
    when: Removing duplicates
    then: Returns removed count
