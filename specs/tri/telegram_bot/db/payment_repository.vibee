name: payment_repository
version: "1.0.0"
language: zig
module: payment_repository

description: |
  Payment repository for VIBEE Telegram bot.
  Handles all payment-related database operations.

imports:
  - supabase_client
  - payment_handler

types:
  CreatePaymentInput:
    description: "Input for creating payment"
    fields:
      user_id: String
      telegram_id: String
      amount: Int
      payment_type: String
      service: Option<String>
      description: String
      external_id: Option<String>

  PaymentFilter:
    description: "Filter for querying payments"
    fields:
      user_id: Option<String>
      telegram_id: Option<String>
      payment_type: Option<String>
      status: Option<String>
      service: Option<String>
      created_after: Option<Timestamp>
      created_before: Option<Timestamp>

  PaymentSummary:
    description: "Payment summary statistics"
    fields:
      total_amount: Int
      total_count: Int
      by_type: Object
      by_service: Object

behaviors:
  - name: create_payment
    given: CreatePaymentInput
    when: Creating payment record
    then: Returns PaymentRecord

  - name: get_payment_by_id
    given: Payment ID
    when: Fetching payment
    then: Returns PaymentRecord or null

  - name: update_payment_status
    given: Payment ID and status
    when: Updating status
    then: Returns updated PaymentRecord

  - name: get_payments_by_user
    given: User ID and pagination
    when: Fetching user payments
    then: Returns list of PaymentRecord

  - name: get_payments_by_telegram_id
    given: Telegram ID and pagination
    when: Fetching payments
    then: Returns list of PaymentRecord

  - name: find_payments
    given: PaymentFilter
    when: Searching payments
    then: Returns list of PaymentRecord

  - name: get_payment_summary
    given: User ID and date range
    when: Getting summary
    then: Returns PaymentSummary

  - name: check_payment_status
    given: External ID
    when: Checking external payment
    then: Returns payment status

  - name: create_successful_payment
    given: Payment data
    when: Recording successful payment
    then: Returns PaymentRecord

  - name: get_total_revenue
    given: Date range
    when: Calculating revenue
    then: Returns total amount

  - name: get_payments_count
    given: PaymentFilter
    when: Counting payments
    then: Returns count
