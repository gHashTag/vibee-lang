name: balance_middleware
version: "1.0.0"
language: zig
module: balance_middleware

description: |
  Balance middleware for VIBEE Telegram bot.
  Handles balance checks before paid operations.

imports:
  - telegram
  - user
  - cost_calculator

types:
  BalanceCheckResult:
    description: "Balance check result"
    fields:
      has_sufficient_balance: Bool
      current_balance: Int
      required_amount: Int
      shortfall: Int

behaviors:
  - name: check_balance
    given: Context and required amount
    when: Checking balance
    then: Returns BalanceCheckResult

  - name: deduct_balance
    given: Telegram ID and amount
    when: Deducting balance
    then: Returns new balance

  - name: refund_balance
    given: Telegram ID and amount
    when: Refunding balance
    then: Returns new balance

  - name: send_insufficient_balance_message
    given: Context and shortfall
    when: Balance insufficient
    then: Sends payment prompt

  - name: get_balance_display
    given: Balance amount
    when: Formatting balance
    then: Returns formatted string

constants:
  MIN_BALANCE_WARNING: 10
