name: auth_middleware
version: "2.0.0"
language: zig
module: auth_middleware

description: |
  Authentication middleware for VIBEE Telegram bot.
  Handles user authentication, session management, and access control.
  First middleware in the chain - ensures user exists and is not banned.

imports:
  - ../db/user_repository
  - ../core/supabase_client

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# TYPES
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

types:
  AuthContext:
    description: "Authentication context passed through middleware"
    fields:
      telegram_id: Int
      chat_id: Int
      message_id: Int
      user: Option<AuthenticatedUser>
      session: Option<SessionData>
      is_authenticated: Bool
      is_new_user: Bool
      auth_error: Option<AuthError>

  AuthenticatedUser:
    description: "Authenticated user data"
    fields:
      id: String
      telegram_id: Int
      username: Option<String>
      first_name: Option<String>
      last_name: Option<String>
      language_code: String
      balance: Int
      level: Int
      is_premium: Bool
      is_banned: Bool
      referral_code: Option<String>
      created_at: Timestamp

  SessionData:
    description: "User session data"
    fields:
      telegram_id: Int
      current_menu: String
      current_scene: Option<String>
      scene_step: Option<Int>
      scene_data: Option<Object>
      language: String
      last_activity: Timestamp
      expires_at: Timestamp

  AuthError:
    description: "Authentication error"
    fields:
      code: AuthErrorCode
      message: String
      retry_after: Option<Int>

  AuthErrorCode:
    description: "Authentication error codes"
    values:
      - user_banned
      - session_expired
      - invalid_token
      - rate_limited
      - maintenance_mode
      - unknown_error

  AuthResult:
    description: "Authentication result"
    fields:
      success: Bool
      context: Option<AuthContext>
      error: Option<AuthError>

  TelegramUser:
    description: "Telegram user from update"
    fields:
      id: Int
      is_bot: Bool
      first_name: String
      last_name: Option<String>
      username: Option<String>
      language_code: Option<String>
      is_premium: Option<Bool>

  BanInfo:
    description: "User ban information"
    fields:
      is_banned: Bool
      reason: Option<String>
      banned_at: Option<Timestamp>
      banned_until: Option<Timestamp>
      banned_by: Option<Int>

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# BEHAVIORS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

behaviors:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # MAIN AUTHENTICATION
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  - name: authenticate
    given: TelegramUser and chat_id
    when: Processing any update
    then: |
      1. Check maintenance mode
      2. Check if user is banned
      3. Get or create user in DB
      4. Load or create session
      5. Update last activity
      6. Return AuthResult

  - name: authenticate_message
    given: Telegram message update
    when: Processing message
    then: |
      1. Extract user from message.from
      2. Call authenticate
      3. Return AuthContext

  - name: authenticate_callback
    given: Telegram callback query
    when: Processing callback
    then: |
      1. Extract user from callback_query.from
      2. Call authenticate
      3. Return AuthContext

  - name: authenticate_payment
    given: Telegram pre-checkout or payment
    when: Processing payment
    then: |
      1. Extract user from payment.from
      2. Call authenticate
      3. Verify payment permissions
      4. Return AuthContext

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # USER MANAGEMENT
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  - name: get_or_create_user
    given: TelegramUser
    when: Ensuring user exists
    then: |
      1. Try to get user by telegram_id
      2. If not found, create new user
      3. If found, update profile if changed
      4. Return AuthenticatedUser and is_new flag

  - name: create_user
    given: TelegramUser
    when: Creating new user
    then: |
      1. Generate referral code
      2. Set default balance and level
      3. Insert into DB
      4. Return new user

  - name: update_user_profile
    given: AuthenticatedUser and TelegramUser
    when: Profile data changed
    then: |
      1. Compare username, first_name, etc.
      2. If changed, update in DB
      3. Return updated user

  - name: get_user_by_telegram_id
    given: Telegram ID
    when: Fetching user
    then: Return AuthenticatedUser or null

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # SESSION MANAGEMENT
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  - name: get_or_create_session
    given: Telegram ID
    when: Loading session
    then: |
      1. Try to get session from cache
      2. If not found or expired, create new
      3. Return SessionData

  - name: create_session
    given: Telegram ID and language
    when: Creating new session
    then: |
      1. Set default menu to "main"
      2. Set expiry time
      3. Save to cache
      4. Return SessionData

  - name: load_session
    given: Telegram ID
    when: Loading from cache
    then: |
      1. Get from Redis/memory cache
      2. Check expiry
      3. Return SessionData or null

  - name: save_session
    given: SessionData
    when: Persisting session
    then: |
      1. Update last_activity
      2. Save to cache
      3. Return success

  - name: update_session
    given: Telegram ID and updates
    when: Updating session fields
    then: |
      1. Load current session
      2. Apply updates
      3. Save session
      4. Return updated SessionData

  - name: clear_session
    given: Telegram ID
    when: Logging out or resetting
    then: |
      1. Delete from cache
      2. Return success

  - name: is_session_expired
    given: SessionData
    when: Checking expiry
    then: Return true if expires_at < now

  - name: extend_session
    given: Telegram ID
    when: Extending session lifetime
    then: |
      1. Load session
      2. Update expires_at
      3. Save session

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # BAN MANAGEMENT
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  - name: is_user_banned
    given: Telegram ID
    when: Checking ban status
    then: |
      1. Get user from DB
      2. Check is_banned flag
      3. Check ban expiry if temporary
      4. Return BanInfo

  - name: ban_user
    given: Telegram ID, reason, duration
    when: Banning user
    then: |
      1. Update is_banned in DB
      2. Set ban reason and expiry
      3. Clear user session
      4. Return success

  - name: unban_user
    given: Telegram ID
    when: Unbanning user
    then: |
      1. Update is_banned to false
      2. Clear ban info
      3. Return success

  - name: check_temporary_ban_expiry
    given: BanInfo
    when: Checking if ban expired
    then: |
      1. If banned_until is set
      2. Check if now > banned_until
      3. If expired, auto-unban
      4. Return is_still_banned

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # ACCESS CONTROL
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  - name: is_admin
    given: Telegram ID
    when: Checking admin status
    then: Return true if in ADMIN_IDS list

  - name: check_permission
    given: AuthContext and permission name
    when: Checking specific permission
    then: |
      1. Check if admin (all permissions)
      2. Check user level for permission
      3. Return allowed/denied

  - name: require_admin
    given: AuthContext
    when: Requiring admin access
    then: |
      1. Check is_admin
      2. If not, return error
      3. If yes, continue

  - name: require_level
    given: AuthContext and min_level
    when: Requiring minimum level
    then: |
      1. Check user.level >= min_level
      2. If not, return error
      3. If yes, continue

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # MAINTENANCE MODE
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  - name: is_maintenance_mode
    given: No parameters
    when: Checking maintenance status
    then: Return true if maintenance enabled

  - name: set_maintenance_mode
    given: Enabled flag and message
    when: Toggling maintenance
    then: |
      1. Update maintenance flag
      2. Set maintenance message
      3. Return success

  - name: get_maintenance_message
    given: Language
    when: Getting maintenance text
    then: Return localized maintenance message

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # ERROR HANDLING
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  - name: create_auth_error
    given: AuthErrorCode and message
    when: Creating error response
    then: Return AuthError

  - name: handle_banned_user
    given: AuthContext and BanInfo
    when: User is banned
    then: |
      1. Create ban error
      2. Send ban message to user
      3. Return error result

  - name: handle_maintenance
    given: AuthContext
    when: In maintenance mode
    then: |
      1. Check if admin (admins bypass)
      2. If not admin, send maintenance message
      3. Return error result

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# CONSTANTS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

constants:
  SESSION_TTL_HOURS: 24
  SESSION_EXTEND_HOURS: 12
  ADMIN_IDS: [144022504]
  DEFAULT_LANGUAGE: "ru"
  DEFAULT_MENU: "main"
  MAINTENANCE_MODE: false

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# MESSAGES
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

messages:
  banned:
    ru: |
      â›” Ğ’Ğ°Ñˆ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚ Ğ·Ğ°Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½.
      
      ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ°: {reason}
      
      Ğ”Ğ»Ñ Ñ€Ğ°Ğ·Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²ĞºĞ¸ Ğ¾Ğ±Ñ€Ğ°Ñ‚Ğ¸Ñ‚ĞµÑÑŒ Ğ² Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºÑƒ: @vibee_support
    en: |
      â›” Your account is banned.
      
      Reason: {reason}
      
      Contact support to appeal: @vibee_support

  banned_temporary:
    ru: |
      â›” Ğ’Ğ°Ñˆ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ğ¾ Ğ·Ğ°Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½.
      
      ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ°: {reason}
      Ğ Ğ°Ğ·Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²ĞºĞ°: {until}
    en: |
      â›” Your account is temporarily banned.
      
      Reason: {reason}
      Unban: {until}

  maintenance:
    ru: |
      ğŸ”§ Ğ‘Ğ¾Ñ‚ Ğ½Ğ° Ñ‚ĞµÑ…Ğ½Ğ¸Ñ‡ĞµÑĞºĞ¾Ğ¼ Ğ¾Ğ±ÑĞ»ÑƒĞ¶Ğ¸Ğ²Ğ°Ğ½Ğ¸Ğ¸.
      
      {message}
      
      ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ Ğ¿Ğ¾Ğ·Ğ¶Ğµ.
    en: |
      ğŸ”§ Bot is under maintenance.
      
      {message}
      
      Please try again later.

  welcome_new_user:
    ru: "ğŸ‘‹ Ğ”Ğ¾Ğ±Ñ€Ğ¾ Ğ¿Ğ¾Ğ¶Ğ°Ğ»Ğ¾Ğ²Ğ°Ñ‚ÑŒ! Ğ’Ğ°Ñˆ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚ ÑĞ¾Ğ·Ğ´Ğ°Ğ½."
    en: "ğŸ‘‹ Welcome! Your account has been created."

  session_expired:
    ru: "â° Ğ¡ĞµÑÑĞ¸Ñ Ğ¸ÑÑ‚ĞµĞºĞ»Ğ°. Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ /start"
    en: "â° Session expired. Use /start"
