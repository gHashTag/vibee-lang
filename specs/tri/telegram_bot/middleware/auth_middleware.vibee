name: auth_middleware
version: "1.0.0"
language: zig
module: auth_middleware

description: |
  Authentication middleware for VIBEE Telegram bot.
  Handles user authentication and session management.

imports:
  - telegram
  - user

types:
  AuthResult:
    description: "Authentication result"
    fields:
      is_authenticated: Bool
      user: Option<User>
      is_new_user: Bool
      error: Option<String>

  SessionData:
    description: "Session data"
    fields:
      user_id: String
      telegram_id: String
      is_ru: Bool
      current_scene: Option<String>
      last_activity: Timestamp

behaviors:
  - name: authenticate
    given: Context
    when: Processing request
    then: Returns AuthResult

  - name: ensure_user_exists
    given: Telegram user data
    when: Checking user
    then: Creates user if not exists

  - name: load_session
    given: Telegram ID
    when: Loading session
    then: Returns SessionData

  - name: save_session
    given: Telegram ID and session
    when: Saving session
    then: Returns success status

  - name: clear_session
    given: Telegram ID
    when: Clearing session
    then: Returns success status

  - name: update_last_activity
    given: Telegram ID
    when: Updating activity
    then: Returns success status

  - name: is_banned
    given: Telegram ID
    when: Checking ban status
    then: Returns true if banned

  - name: check_rate_limit
    given: Telegram ID
    when: Checking rate limit
    then: Returns true if allowed

constants:
  SESSION_TTL_HOURS: 24
  RATE_LIMIT_REQUESTS: 30
  RATE_LIMIT_WINDOW_SEC: 60
