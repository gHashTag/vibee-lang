# Video Transcription Service
# Replicate model: turian/insanely-fast-whisper-with-video
# Cost: $0.003 per minute

name: video_transcription
version: "1.0.0"
language: zig
module: video_transcription

description: |
  –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è –≤–∏–¥–µ–æ –∏ –∞—É–¥–∏–æ –≤ —Ç–µ–∫—Å—Ç.
  –ú–æ–¥–µ–ª—å: turian/insanely-fast-whisper-with-video
  Whisper large-v3, –Ω–µ–≤–µ—Ä–æ—è—Ç–Ω–æ –±—ã—Å—Ç—Ä—ã–π.
  –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç 99+ —è–∑—ã–∫–æ–≤.

imports:
  - replicate_client
  - pricing_system

constants:
  MODEL_ID: "turian/insanely-fast-whisper-with-video"
  # Real price from Replicate: $0.088 per run (~91 seconds typical)
  # Can transcribe 150 min in ~98 seconds
  BASE_COST_USD_PER_RUN: 0.088
  # stars = (0.088 / 0.016) * 1.5 = 8.25 -> 8 stars per run
  COST_STARS_PER_RUN: 8
  # For short videos (<5 min) use minimum
  COST_STARS_MINIMUM: 3
  MAX_DURATION_MINUTES: 150  # 2.5 hours max (150 min in ~98 sec)
  SUPPORTED_FORMATS: ["mp4", "mov", "webm", "mp3", "wav", "m4a", "ogg"]

types:
  TranscriptionLanguage:
    description: "–Ø–∑—ã–∫ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏"
    variants:
      - Auto        # –ê–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ
      - Russian
      - English
      - Spanish
      - French
      - German
      - Chinese
      - Japanese
      - Korean
      - Other

  OutputFormat:
    description: "–§–æ—Ä–º–∞—Ç –≤—ã–≤–æ–¥–∞"
    variants:
      - Text        # –ü—Ä–æ—Å—Ç–æ–π —Ç–µ–∫—Å—Ç
      - SRT         # –°—É–±—Ç–∏—Ç—Ä—ã SRT
      - VTT         # –°—É–±—Ç–∏—Ç—Ä—ã WebVTT
      - JSON        # JSON —Å —Ç–∞–π–º–∫–æ–¥–∞–º–∏

  TranscriptionRequest:
    description: "–ó–∞–ø—Ä–æ—Å –Ω–∞ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—é"
    fields:
      media_url: String
      language: TranscriptionLanguage
      output_format: OutputFormat
      include_timestamps: Bool
      telegram_id: String
      username: String

  TranscriptionResponse:
    description: "–†–µ–∑—É–ª—å—Ç–∞—Ç —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏"
    fields:
      success: Bool
      text: Option<String>
      subtitles_url: Option<String>
      detected_language: String
      duration_minutes: Float
      word_count: Int
      processing_time_ms: Int
      cost_stars: Int

  TranscriptionSegment:
    description: "–°–µ–≥–º–µ–Ω—Ç —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏"
    fields:
      start_time: Float
      end_time: Float
      text: String
      confidence: Float

behaviors:
  - name: transcribe
    given: URL –º–µ–¥–∏–∞—Ñ–∞–π–ª–∞
    when: –ó–∞–ø—Ä–æ—Å –Ω–∞ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—é
    then: –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—Å—Ç –∏/–∏–ª–∏ —Å—É–±—Ç–∏—Ç—Ä—ã
    api_call: |
      replicate.run("turian/insanely-fast-whisper-with-video", {
        input: {
          audio: media_url,
          language: language,
          batch_size: 64
        }
      })

  - name: transcribe_with_timestamps
    given: URL –º–µ–¥–∏–∞—Ñ–∞–π–ª–∞
    when: –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è —Å —Ç–∞–π–º–∫–æ–¥–∞–º–∏
    then: –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–µ–≥–º–µ–Ω—Ç—ã —Å –≤—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –º–µ—Ç–∫–∞–º–∏

  - name: generate_subtitles
    given: URL –º–µ–¥–∏–∞—Ñ–∞–π–ª–∞ –∏ —Ñ–æ—Ä–º–∞—Ç
    when: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—É–±—Ç–∏—Ç—Ä–æ–≤
    then: –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ñ–∞–π–ª —Å—É–±—Ç–∏—Ç—Ä–æ–≤ (SRT/VTT)

  - name: detect_language
    given: URL –º–µ–¥–∏–∞—Ñ–∞–π–ª–∞
    when: –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —è–∑—ã–∫–∞
    then: –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–π —è–∑—ã–∫

  - name: calculate_cost
    given: –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤ –º–∏–Ω—É—Ç–∞—Ö
    when: –†–∞—Å—á—ë—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏
    then: –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç—å –≤ –∑–≤—ë–∑–¥–∞—Ö
    formula: max(1, ceil(duration_minutes)) * COST_STARS_PER_MINUTE

# UI Integration
menu_item:
  group: tools
  position: 3
  icon: "üìù"
  name:
    ru: "–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è –≤–∏–¥–µ–æ"
    en: "Video Transcription"
  description:
    ru: "–ü–µ—Ä–µ–≤–æ–¥ –≤–∏–¥–µ–æ/–∞—É–¥–∏–æ –≤ —Ç–µ–∫—Å—Ç"
    en: "Convert video/audio to text"
  cost_stars: "1‚≠ê/–º–∏–Ω"

# Wizard flow
wizard:
  steps:
    - name: upload_media
      prompt:
        ru: |
          üìù –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è –≤–∏–¥–µ–æ/–∞—É–¥–∏–æ
          
          –û—Ç–ø—Ä–∞–≤—å—Ç–µ –≤–∏–¥–µ–æ –∏–ª–∏ –∞—É–¥–∏–æ –¥–ª—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏.
          
          –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã:
          ‚Ä¢ –í–∏–¥–µ–æ: MP4, MOV, WebM
          ‚Ä¢ –ê—É–¥–∏–æ: MP3, WAV, M4A, OGG
          
          –ú–∞–∫—Å. –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: 2 —á–∞—Å–∞
          
          üíé –°—Ç–æ–∏–º–æ—Å—Ç—å: 1 ‚≠ê –∑–∞ –º–∏–Ω—É—Ç—É
        en: |
          üìù Video/Audio Transcription
          
          Send video or audio for transcription.
          
          Supported formats:
          ‚Ä¢ Video: MP4, MOV, WebM
          ‚Ä¢ Audio: MP3, WAV, M4A, OGG
          
          Max duration: 2 hours
          
          üíé Cost: 1 ‚≠ê per minute

    - name: select_language
      prompt:
        ru: "–í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫:"
        en: "Select language:"
      buttons:
        - text: "üîÑ –ê–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ"
          callback: "trans_auto"
        - text: "üá∑üá∫ –†—É—Å—Å–∫–∏–π"
          callback: "trans_ru"
        - text: "üá¨üáß English"
          callback: "trans_en"
        - text: "üá™üá∏ Espa√±ol"
          callback: "trans_es"
        - text: "üá©üá™ Deutsch"
          callback: "trans_de"

    - name: select_format
      prompt:
        ru: "–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ä–º–∞—Ç –≤—ã–≤–æ–¥–∞:"
        en: "Select output format:"
      buttons:
        - text: "üìÑ –¢–µ–∫—Å—Ç"
          callback: "trans_text"
        - text: "üé¨ –°—É–±—Ç–∏—Ç—Ä—ã SRT"
          callback: "trans_srt"
        - text: "üåê –°—É–±—Ç–∏—Ç—Ä—ã VTT"
          callback: "trans_vtt"

    - name: processing
      message:
        ru: "üìù –¢—Ä–∞–Ω—Å–∫—Ä–∏–±–∏—Ä—É—é... –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç"
        en: "üìù Transcribing... This may take a few minutes"

    - name: result
      message:
        ru: |
          ‚úÖ –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è –≥–æ—Ç–æ–≤–∞!
          
          üåç –Ø–∑—ã–∫: {language}
          ‚è± –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: {duration} –º–∏–Ω
          üìä –°–ª–æ–≤: {words}
          üíé –°—Ç–æ–∏–º–æ—Å—Ç—å: {cost} ‚≠ê
        en: |
          ‚úÖ Transcription ready!
          
          üåç Language: {language}
          ‚è± Duration: {duration} min
          üìä Words: {words}
          üíé Cost: {cost} ‚≠ê

# Use cases
use_cases:
  - name: "youtube_subtitles"
    description: "–°–æ–∑–¥–∞–Ω–∏–µ —Å—É–±—Ç–∏—Ç—Ä–æ–≤ –¥–ª—è YouTube"
  - name: "meeting_notes"
    description: "–ö–æ–Ω—Å–ø–µ–∫—Ç —Å–æ–≤–µ—â–∞–Ω–∏—è"
  - name: "podcast_transcript"
    description: "–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç –ø–æ–¥–∫–∞—Å—Ç–∞"
  - name: "lecture_notes"
    description: "–ö–æ–Ω—Å–ø–µ–∫—Ç –ª–µ–∫—Ü–∏–∏"
