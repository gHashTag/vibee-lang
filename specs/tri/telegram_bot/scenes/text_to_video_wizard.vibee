# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# TEXT TO VIDEO WIZARD - AI Video Generation Flow
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Complete step-by-step wizard for generating videos from text
# Ï†Â² + 1/Ï†Â² = 3 | PHOENIX = 999
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: text_to_video_wizard
version: "2.0.0"
language: zig
module: text_to_video_wizard

description: |
  Text-to-video wizard - complete flow for AI video generation.
  
  Steps:
  1. SELECT_MODEL - Choose video model (Runway, Kling, etc.)
  2. ENTER_PROMPT - Enter video description
  3. SELECT_ASPECT - Choose aspect ratio (16:9, 9:16, 1:1)
  4. SELECT_DURATION - Choose video length (5s, 10s)
  5. CONFIRM - Review and confirm
  6. PROCESSING - Wait for generation (longer than images)
  7. COMPLETE - Show result video

imports:
  - ../core/state_manager
  - ../core/telegram_client
  - ../core/replicate_client
  - ../menu/reply_keyboard
  - ../utils/language

types:
  VideoStep:
    description: "Video wizard step enum"
    variants:
      - SelectModel
      - EnterPrompt
      - SelectAspect
      - SelectDuration
      - Confirm
      - Processing
      - Complete
      - Cancelled

  VideoWizardState:
    description: "Complete video wizard state"
    fields:
      step: VideoStep
      model_id: Option<String>
      model_name: Option<String>
      prompt: Option<String>
      negative_prompt: Option<String>
      aspect_ratio: String
      duration_seconds: Int
      fps: Int
      cost_stars: Int
      job_id: Option<String>
      result_url: Option<String>
      thumbnail_url: Option<String>
      error: Option<String>
      started_at: Timestamp
      completed_at: Option<Timestamp>
      progress_percent: Int

  VideoModel:
    description: "Available video model"
    fields:
      id: String
      name: String
      description: String
      cost_per_second: Int
      max_duration: Int
      supports_aspect: List<String>
      generation_time_estimate: String

  AspectOption:
    description: "Video aspect ratio option"
    fields:
      id: String
      label: String
      width: Int
      height: Int
      use_case: String

  DurationOption:
    description: "Video duration option"
    fields:
      seconds: Int
      label: String
      cost_multiplier: Float

  VideoStepMessage:
    description: "Message for video step"
    fields:
      text: String
      keyboard: Option<String>
      parse_mode: String
      show_progress: Bool

  VideoStepResult:
    description: "Result of processing video step"
    fields:
      success: Bool
      next_step: Option<VideoStep>
      message: VideoStepMessage
      error: Option<String>

behaviors:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # WIZARD LIFECYCLE
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  - name: enter_wizard
    given: Chat ID and language
    when: User starts text-to-video
    then: |
      1. Create VideoWizardState with step=SelectModel
      2. Save to state_manager
      3. Return model selection message

  - name: exit_wizard
    given: Chat ID
    when: User cancels or completes
    then: |
      1. Clear wizard state
      2. Return to main menu

  - name: get_wizard_state
    given: Chat ID
    when: Processing input
    then: Return current VideoWizardState or null

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STEP 1: SELECT MODEL
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  - name: show_select_model
    given: Language
    when: Displaying model selection
    then: |
      RU: "ğŸ¬ Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ Ğ´Ğ»Ñ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ Ğ²Ğ¸Ğ´ĞµĞ¾:
      
      âš¡ Runway Gen-3 - Ğ’Ñ‹ÑĞ¾ĞºĞ¾Ğµ ĞºĞ°Ñ‡ĞµÑÑ‚Ğ²Ğ¾, 2-3 Ğ¼Ğ¸Ğ½
      ğŸ¥ Kling AI - Ğ‘Ñ‹ÑÑ‚Ñ€Ğ°Ñ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ, 1-2 Ğ¼Ğ¸Ğ½
      ğŸŒŠ Luma Dream - ĞŸĞ»Ğ°Ğ²Ğ½Ñ‹Ğµ Ğ´Ğ²Ğ¸Ğ¶ĞµĞ½Ğ¸Ñ, 2-4 Ğ¼Ğ¸Ğ½
      âœ¨ Minimax - Ğ­ĞºĞ¾Ğ½Ğ¾Ğ¼Ğ¸Ñ‡Ğ½Ñ‹Ğ¹ Ğ²Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚"
      
      EN: "ğŸ¬ Select a model for video generation:
      
      âš¡ Runway Gen-3 - High quality, 2-3 min
      ğŸ¥ Kling AI - Fast generation, 1-2 min
      ğŸŒŠ Luma Dream - Smooth motion, 2-4 min
      âœ¨ Minimax - Budget option"
      
      Keyboard:
      [âš¡ Runway Gen-3] [ğŸ¥ Kling AI]
      [ğŸŒŠ Luma Dream] [âœ¨ Minimax]
      [â—€ï¸ ĞĞ°Ğ·Ğ°Ğ´]

  - name: handle_select_model
    given: Chat ID and model button text
    when: User selects model
    then: |
      1. Parse model from button
      2. Validate model exists
      3. Update state: model_id, model_name
      4. Advance to EnterPrompt
      5. Return prompt input message

  - name: get_available_models
    given: Nothing
    when: Fetching video model list
    then: |
      Return:
        - runway_gen3: "âš¡ Runway Gen-3", 20 stars/sec
        - kling_ai: "ğŸ¥ Kling AI", 15 stars/sec
        - luma_dream: "ğŸŒŠ Luma Dream", 18 stars/sec
        - minimax: "âœ¨ Minimax", 10 stars/sec

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STEP 2: ENTER PROMPT
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  - name: show_enter_prompt
    given: Language and model_name
    when: Displaying prompt input
    then: |
      RU: "âœï¸ ĞĞ¿Ğ¸ÑˆĞ¸Ñ‚Ğµ Ğ²Ğ¸Ğ´ĞµĞ¾ Ğ´Ğ»Ñ {model_name}:
      
      Ğ¡Ğ¾Ğ²ĞµÑ‚Ñ‹ Ğ´Ğ»Ñ Ñ…Ğ¾Ñ€Ğ¾ÑˆĞµĞ³Ğ¾ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ°:
      â€¢ ĞĞ¿Ğ¸ÑˆĞ¸Ñ‚Ğµ Ğ´Ğ²Ğ¸Ğ¶ĞµĞ½Ğ¸Ğµ: 'ĞºĞ°Ğ¼ĞµÑ€Ğ° Ğ»ĞµÑ‚Ğ¸Ñ‚ Ğ½Ğ°Ğ´ Ğ³Ğ¾Ñ€Ğ¾Ğ´Ğ¾Ğ¼'
      â€¢ Ğ£ĞºĞ°Ğ¶Ğ¸Ñ‚Ğµ ÑÑ‚Ğ¸Ğ»ÑŒ: 'ĞºĞ¸Ğ½ĞµĞ¼Ğ°Ñ‚Ğ¾Ğ³Ñ€Ğ°Ñ„Ğ¸Ñ‡Ğ½Ñ‹Ğ¹, 4K'
      â€¢ Ğ”Ğ¾Ğ±Ğ°Ğ²ÑŒÑ‚Ğµ Ğ´ĞµÑ‚Ğ°Ğ»Ğ¸: 'Ğ·Ğ°ĞºĞ°Ñ‚, Ğ·Ğ¾Ğ»Ğ¾Ñ‚Ğ¾Ğ¹ Ñ‡Ğ°Ñ'
      
      ĞŸÑ€Ğ¸Ğ¼ĞµÑ€Ñ‹:
      â€¢ A drone shot flying over a futuristic city at sunset
      â€¢ A cat walking through a garden, slow motion
      â€¢ Ocean waves crashing on rocks, cinematic"
      
      EN: "âœï¸ Describe the video for {model_name}:
      
      Tips for good results:
      â€¢ Describe motion: 'camera flies over city'
      â€¢ Specify style: 'cinematic, 4K'
      â€¢ Add details: 'sunset, golden hour'
      
      Examples:
      â€¢ A drone shot flying over a futuristic city at sunset
      â€¢ A cat walking through a garden, slow motion
      â€¢ Ocean waves crashing on rocks, cinematic"
      
      Keyboard:
      [â—€ï¸ ĞĞ°Ğ·Ğ°Ğ´] [âŒ ĞÑ‚Ğ¼ĞµĞ½Ğ°]

  - name: handle_enter_prompt
    given: Chat ID and text
    when: User enters prompt
    then: |
      1. Validate prompt (15-1500 chars)
      2. Check for prohibited content
      3. Update state: prompt
      4. Advance to SelectAspect
      5. Return aspect selection message

  - name: validate_video_prompt
    given: Prompt text
    when: Validating video prompt
    then: |
      Checks:
        - Length >= 15 characters (videos need more detail)
        - Length <= 1500 characters
        - Contains motion/action words (recommended)
        - No prohibited content
      Return: {valid: bool, error: string, warnings: list}

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STEP 3: SELECT ASPECT RATIO
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  - name: show_select_aspect
    given: Language
    when: Displaying aspect selection
    then: |
      RU: "ğŸ“ Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚ Ğ²Ğ¸Ğ´ĞµĞ¾:
      
      ğŸ–¥ï¸ 16:9 - Ğ“Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ½Ñ‚Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ (YouTube, TV)
      ğŸ“± 9:16 - Ğ’ĞµÑ€Ñ‚Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ğ¾Ğµ (TikTok, Reels)
      ğŸ”² 1:1 - ĞšĞ²Ğ°Ğ´Ñ€Ğ°Ñ‚Ğ½Ğ¾Ğµ (Instagram)"
      
      EN: "ğŸ“ Select video format:
      
      ğŸ–¥ï¸ 16:9 - Horizontal (YouTube, TV)
      ğŸ“± 9:16 - Vertical (TikTok, Reels)
      ğŸ”² 1:1 - Square (Instagram)"
      
      Keyboard:
      [ğŸ–¥ï¸ 16:9 Ğ“Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ½Ñ‚] [ğŸ“± 9:16 Ğ’ĞµÑ€Ñ‚Ğ¸ĞºĞ°Ğ»ÑŒ]
      [ğŸ”² 1:1 ĞšĞ²Ğ°Ğ´Ñ€Ğ°Ñ‚]
      [â—€ï¸ ĞĞ°Ğ·Ğ°Ğ´] [âŒ ĞÑ‚Ğ¼ĞµĞ½Ğ°]

  - name: handle_select_aspect
    given: Chat ID and aspect button text
    when: User selects aspect
    then: |
      1. Parse aspect ratio from button
      2. Update state: aspect_ratio
      3. Advance to SelectDuration
      4. Return duration selection message

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STEP 4: SELECT DURATION
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  - name: show_select_duration
    given: Language and model_name
    when: Displaying duration selection
    then: |
      RU: "â±ï¸ Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ´Ğ»Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ Ğ²Ğ¸Ğ´ĞµĞ¾:
      
      ĞœĞ¾Ğ´ĞµĞ»ÑŒ: {model_name}
      Ğ¡Ñ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ: {cost_per_sec} â­/ÑĞµĞº"
      
      EN: "â±ï¸ Select video duration:
      
      Model: {model_name}
      Cost: {cost_per_sec} â­/sec"
      
      Keyboard:
      [5 ÑĞµĞº - {cost_5}â­] [10 ÑĞµĞº - {cost_10}â­]
      [â—€ï¸ ĞĞ°Ğ·Ğ°Ğ´] [âŒ ĞÑ‚Ğ¼ĞµĞ½Ğ°]

  - name: handle_select_duration
    given: Chat ID and duration button text
    when: User selects duration
    then: |
      1. Parse duration from button
      2. Calculate total cost
      3. Update state: duration_seconds, cost_stars
      4. Advance to Confirm
      5. Return confirmation message

  - name: calculate_video_cost
    given: Model ID and duration
    when: Calculating cost
    then: |
      cost = model.cost_per_second * duration
      Return cost in stars

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STEP 5: CONFIRM
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  - name: show_confirm
    given: Language and VideoWizardState
    when: Displaying confirmation
    then: |
      RU: "ğŸ“‹ ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸Ñ‚Ğµ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ Ğ²Ğ¸Ğ´ĞµĞ¾:
      
      ğŸ¬ ĞœĞ¾Ğ´ĞµĞ»ÑŒ: {model_name}
      âœï¸ ĞŸÑ€Ğ¾Ğ¼Ğ¿Ñ‚: {prompt}
      ğŸ“ Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚: {aspect_ratio}
      â±ï¸ Ğ”Ğ»Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ: {duration} ÑĞµĞº
      â­ Ğ¡Ñ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ: {cost_stars} Ğ·Ğ²Ñ‘Ğ·Ğ´
      
      â³ ĞŸÑ€Ğ¸Ğ¼ĞµÑ€Ğ½Ğ¾Ğµ Ğ²Ñ€ĞµĞ¼Ñ: 2-5 Ğ¼Ğ¸Ğ½ÑƒÑ‚
      
      Ğ’Ğ°Ñˆ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ: {balance} Ğ·Ğ²Ñ‘Ğ·Ğ´"
      
      EN: "ğŸ“‹ Confirm video generation:
      
      ğŸ¬ Model: {model_name}
      âœï¸ Prompt: {prompt}
      ğŸ“ Format: {aspect_ratio}
      â±ï¸ Duration: {duration} sec
      â­ Cost: {cost_stars} stars
      
      â³ Estimated time: 2-5 minutes
      
      Your balance: {balance} stars"
      
      Keyboard:
      [âœ… ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸Ñ‚ÑŒ] [âŒ ĞÑ‚Ğ¼ĞµĞ½Ğ°]
      [â—€ï¸ Ğ˜Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ]

  - name: handle_confirm
    given: Chat ID
    when: User confirms
    then: |
      1. Check user balance >= cost
      2. If insufficient -> show error
      3. Deduct balance
      4. Advance to Processing
      5. Start async video generation
      6. Return processing message with progress

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STEP 6: PROCESSING
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  - name: show_processing
    given: Language and progress_percent
    when: Generation in progress
    then: |
      RU: "â³ Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ Ğ²Ğ¸Ğ´ĞµĞ¾...
      
      ĞŸÑ€Ğ¾Ğ³Ñ€ĞµÑÑ: {progress}%
      [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘] 
      
      Ğ­Ñ‚Ğ¾ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ·Ğ°Ğ½ÑÑ‚ÑŒ 2-5 Ğ¼Ğ¸Ğ½ÑƒÑ‚.
      ĞœÑ‹ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ¼ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ ĞºĞ¾Ğ³Ğ´Ğ° Ğ±ÑƒĞ´ĞµÑ‚ Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ¾."
      
      EN: "â³ Generating video...
      
      Progress: {progress}%
      [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘]
      
      This may take 2-5 minutes.
      We'll notify you when it's ready."

  - name: start_video_generation
    given: VideoWizardState
    when: Starting video generation
    then: |
      1. Build API request for selected model
      2. Submit generation job
      3. Save job_id to state
      4. Start progress polling

  - name: poll_video_progress
    given: Job ID
    when: Checking generation progress
    then: |
      1. Call API get job status
      2. Update progress_percent
      3. If completed -> handle_complete
      4. If failed -> handle_error
      5. If processing -> update progress message

  - name: update_progress_message
    given: Chat ID and progress
    when: Progress changed
    then: |
      1. Edit existing message
      2. Update progress bar
      3. Show estimated time remaining

  - name: handle_video_complete
    given: Chat ID and result_url
    when: Generation succeeded
    then: |
      1. Update state: result_url, completed_at
      2. Advance to Complete
      3. Send video file
      4. Show completion message

  - name: handle_video_error
    given: Chat ID and error
    when: Generation failed
    then: |
      1. Refund user balance
      2. Update state: error
      3. Show error message with reason
      4. Offer retry or cancel

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STEP 7: COMPLETE
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  - name: show_complete
    given: Language and result
    when: Generation complete
    then: |
      RU: "âœ… Ğ’Ğ¸Ğ´ĞµĞ¾ Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ¾!
      
      ğŸ¬ ĞœĞ¾Ğ´ĞµĞ»ÑŒ: {model_name}
      â±ï¸ Ğ”Ğ»Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ: {duration} ÑĞµĞº
      â³ Ğ’Ñ€ĞµĞ¼Ñ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸: {gen_time}
      â­ Ğ¡Ğ¿Ğ¸ÑĞ°Ğ½Ğ¾: {cost} Ğ·Ğ²Ñ‘Ğ·Ğ´"
      
      EN: "âœ… Video ready!
      
      ğŸ¬ Model: {model_name}
      â±ï¸ Duration: {duration} sec
      â³ Generation time: {gen_time}
      â­ Charged: {cost} stars"
      
      Keyboard:
      [ğŸ”„ Ğ•Ñ‰Ñ‘ Ñ€Ğ°Ğ·] [ğŸ“‹ ĞœĞµĞ½Ñ]
      [ğŸ’¾ Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ¼Ğ¿Ñ‚]

  - name: handle_again
    given: Chat ID
    when: User wants another video
    then: |
      1. Keep model, aspect, duration
      2. Clear prompt
      3. Return to EnterPrompt step

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # NAVIGATION
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  - name: handle_back
    given: Chat ID and current step
    when: User presses back
    then: |
      SelectModel -> exit_wizard
      EnterPrompt -> SelectModel
      SelectAspect -> EnterPrompt
      SelectDuration -> SelectAspect
      Confirm -> SelectDuration

  - name: handle_cancel
    given: Chat ID
    when: User cancels
    then: |
      1. If Processing -> show warning (cannot cancel)
      2. Else -> exit_wizard, return to menu

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # MAIN ROUTER
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  - name: handle_input
    given: Chat ID and text
    when: Any input received
    then: |
      1. Get wizard state
      2. If no state -> ignore
      3. Check for navigation buttons
      4. Route to current step handler
      5. Return VideoStepResult

constants:
  WIZARD_ID: "text_to_video"
  DEFAULT_ASPECT_RATIO: "16:9"
  DEFAULT_DURATION: 5
  DEFAULT_FPS: 24
  MAX_PROMPT_LENGTH: 1500
  MIN_PROMPT_LENGTH: 15
  POLL_INTERVAL_MS: 5000
  MAX_POLL_ATTEMPTS: 120
  
  # Model costs in stars per second
  COST_RUNWAY_GEN3: 20
  COST_KLING_AI: 15
  COST_LUMA_DREAM: 18
  COST_MINIMAX: 10

  # Duration options
  DURATION_SHORT: 5
  DURATION_MEDIUM: 10

  # Replicate model versions
  MODEL_RUNWAY: "runway/gen-3"
  MODEL_KLING: "kling-ai/kling-video"
  MODEL_LUMA: "luma/dream-machine"
  MODEL_MINIMAX: "minimax/video-01"

test_cases:
  - name: test_enter_wizard
    input: {chat_id: 12345, lang: "ru"}
    expected: {step: "SelectModel", keyboard: true}

  - name: test_select_model_runway
    input: {button: "âš¡ Runway Gen-3"}
    expected: {model_id: "runway_gen3", next_step: "EnterPrompt"}

  - name: test_prompt_too_short
    input: {prompt: "a cat"}
    expected: {valid: false, error: "min_length"}

  - name: test_prompt_valid
    input: {prompt: "A drone flying over mountains at sunset, cinematic"}
    expected: {valid: true, next_step: "SelectAspect"}

  - name: test_select_aspect_vertical
    input: {button: "ğŸ“± 9:16 Ğ’ĞµÑ€Ñ‚Ğ¸ĞºĞ°Ğ»ÑŒ"}
    expected: {aspect_ratio: "9:16", next_step: "SelectDuration"}

  - name: test_select_duration_10s
    input: {button: "10 ÑĞµĞº", model: "runway_gen3"}
    expected: {duration: 10, cost: 200, next_step: "Confirm"}

  - name: test_confirm_insufficient_balance
    input: {balance: 50, cost: 200}
    expected: {success: false, error: "insufficient_balance"}

  - name: test_progress_update
    input: {progress: 45}
    expected: {message_updated: true, progress_bar: "â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘"}

  - name: test_cancel_during_processing
    input: {step: "Processing", button: "âŒ ĞÑ‚Ğ¼ĞµĞ½Ğ°"}
    expected: {success: false, error: "cannot_cancel_processing"}
