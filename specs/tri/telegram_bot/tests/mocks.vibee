name: mocks
version: "1.0.0"
language: zig
module: mocks

description: |
  Mocks and stubs for VIBEE Telegram bot testing.
  Provides mock implementations of external services.
  Supports behavior verification and call tracking.

# ═══════════════════════════════════════════════════════════════════════════════
# TYPES
# ═══════════════════════════════════════════════════════════════════════════════

types:
  MockRegistry:
    description: "Mock registry"
    fields:
      mocks: Object
      call_history: List<MockCall>

  MockCall:
    description: "Mock call record"
    fields:
      mock_name: String
      method: String
      args: Object
      result: Option<Object>
      error: Option<String>
      timestamp: Timestamp

  MockConfig:
    description: "Mock configuration"
    fields:
      default_delay_ms: Int
      fail_rate: Float
      record_calls: Bool

  MockResponse:
    description: "Mock response"
    fields:
      data: Option<Object>
      error: Option<MockError>
      delay_ms: Int

  MockError:
    description: "Mock error"
    fields:
      code: String
      message: String

  # ─────────────────────────────────────────────────────────────────────────────
  # TELEGRAM API MOCK
  # ─────────────────────────────────────────────────────────────────────────────

  TelegramMock:
    description: "Telegram API mock"
    fields:
      bot_info: Object
      sent_messages: List<Object>
      callbacks_answered: List<String>
      config: MockConfig

  MockMessage:
    description: "Mock sent message"
    fields:
      chat_id: Int
      text: Option<String>
      photo: Option<String>
      video: Option<String>
      reply_markup: Option<Object>
      parse_mode: Option<String>

  # ─────────────────────────────────────────────────────────────────────────────
  # REPLICATE API MOCK
  # ─────────────────────────────────────────────────────────────────────────────

  ReplicateMock:
    description: "Replicate API mock"
    fields:
      predictions: Object
      models: List<Object>
      config: MockConfig

  MockPrediction:
    description: "Mock prediction"
    fields:
      id: String
      status: String
      output: Option<List<String>>
      error: Option<String>
      created_at: Timestamp
      completed_at: Option<Timestamp>

  # ─────────────────────────────────────────────────────────────────────────────
  # OPENAI API MOCK
  # ─────────────────────────────────────────────────────────────────────────────

  OpenAIMock:
    description: "OpenAI API mock"
    fields:
      completions: List<Object>
      images: List<Object>
      config: MockConfig

  MockCompletion:
    description: "Mock completion"
    fields:
      id: String
      model: String
      content: String
      usage: Object

  MockImage:
    description: "Mock generated image"
    fields:
      url: String
      revised_prompt: Option<String>

  # ─────────────────────────────────────────────────────────────────────────────
  # DATABASE MOCK
  # ─────────────────────────────────────────────────────────────────────────────

  DatabaseMock:
    description: "Database mock"
    fields:
      tables: Object
      queries: List<Object>
      config: MockConfig

  MockQueryResult:
    description: "Mock query result"
    fields:
      rows: List<Object>
      affected_rows: Int
      last_insert_id: Option<Int>

  # ─────────────────────────────────────────────────────────────────────────────
  # CACHE MOCK
  # ─────────────────────────────────────────────────────────────────────────────

  CacheMock:
    description: "Cache mock"
    fields:
      data: Object
      operations: List<Object>
      config: MockConfig

  # ─────────────────────────────────────────────────────────────────────────────
  # PAYMENT MOCK
  # ─────────────────────────────────────────────────────────────────────────────

  PaymentMock:
    description: "Payment provider mock"
    fields:
      transactions: Object
      invoices: Object
      config: MockConfig

  MockTransaction:
    description: "Mock transaction"
    fields:
      id: String
      amount: Int
      status: String
      provider: String

  # ─────────────────────────────────────────────────────────────────────────────
  # HTTP MOCK
  # ─────────────────────────────────────────────────────────────────────────────

  HttpMock:
    description: "HTTP client mock"
    fields:
      responses: Object
      requests: List<MockRequest>
      config: MockConfig

  MockRequest:
    description: "Mock HTTP request"
    fields:
      method: String
      url: String
      headers: Object
      body: Option<Object>
      timestamp: Timestamp

  MockHttpResponse:
    description: "Mock HTTP response"
    fields:
      status: Int
      headers: Object
      body: Object

  # ─────────────────────────────────────────────────────────────────────────────
  # VERIFICATION
  # ─────────────────────────────────────────────────────────────────────────────

  Verification:
    description: "Call verification"
    fields:
      mock_name: String
      method: String
      times: VerificationTimes
      args_matcher: Option<Object>

  VerificationTimes:
    description: "Verification times"
    values:
      - never
      - once
      - twice
      - at_least_once
      - at_most_once
      - exactly
      - at_least
      - at_most

  VerificationResult:
    description: "Verification result"
    fields:
      passed: Bool
      expected: String
      actual: Int
      calls: List<MockCall>

# ═══════════════════════════════════════════════════════════════════════════════
# BEHAVIORS
# ═══════════════════════════════════════════════════════════════════════════════

behaviors:
  # ─────────────────────────────────────────────────────────────────────────────
  # REGISTRY
  # ─────────────────────────────────────────────────────────────────────────────

  - name: init_registry
    given: No parameters
    when: Initializing registry
    then: Return MockRegistry

  - name: reset_all
    given: No parameters
    when: Resetting all mocks
    then: Clear all state

  - name: get_call_history
    given: Mock name
    when: Getting history
    then: Return call list

  - name: clear_call_history
    given: No parameters
    when: Clearing history
    then: Clear all calls

  # ─────────────────────────────────────────────────────────────────────────────
  # TELEGRAM MOCK
  # ─────────────────────────────────────────────────────────────────────────────

  - name: create_telegram_mock
    given: MockConfig
    when: Creating mock
    then: Return TelegramMock

  - name: mock_send_message
    given: Response config
    when: Mocking sendMessage
    then: Configure response

  - name: mock_send_photo
    given: Response config
    when: Mocking sendPhoto
    then: Configure response

  - name: mock_answer_callback
    given: Response config
    when: Mocking answerCallback
    then: Configure response

  - name: get_sent_messages
    given: No parameters
    when: Getting sent messages
    then: Return message list

  - name: get_last_message
    given: No parameters
    when: Getting last message
    then: Return last MockMessage

  # ─────────────────────────────────────────────────────────────────────────────
  # REPLICATE MOCK
  # ─────────────────────────────────────────────────────────────────────────────

  - name: create_replicate_mock
    given: MockConfig
    when: Creating mock
    then: Return ReplicateMock

  - name: mock_create_prediction
    given: Model and response
    when: Mocking prediction
    then: Configure response

  - name: mock_get_prediction
    given: Prediction ID and status
    when: Mocking get
    then: Configure response

  - name: mock_prediction_success
    given: Output URLs
    when: Mocking success
    then: Return successful prediction

  - name: mock_prediction_failure
    given: Error message
    when: Mocking failure
    then: Return failed prediction

  - name: simulate_prediction_progress
    given: Prediction ID and steps
    when: Simulating progress
    then: Update status over time

  # ─────────────────────────────────────────────────────────────────────────────
  # OPENAI MOCK
  # ─────────────────────────────────────────────────────────────────────────────

  - name: create_openai_mock
    given: MockConfig
    when: Creating mock
    then: Return OpenAIMock

  - name: mock_chat_completion
    given: Response content
    when: Mocking chat
    then: Configure response

  - name: mock_image_generation
    given: Image URLs
    when: Mocking image gen
    then: Configure response

  - name: mock_moderation
    given: Flagged categories
    when: Mocking moderation
    then: Configure response

  # ─────────────────────────────────────────────────────────────────────────────
  # DATABASE MOCK
  # ─────────────────────────────────────────────────────────────────────────────

  - name: create_database_mock
    given: MockConfig
    when: Creating mock
    then: Return DatabaseMock

  - name: mock_query
    given: Query pattern and result
    when: Mocking query
    then: Configure response

  - name: mock_insert
    given: Table and result
    when: Mocking insert
    then: Configure response

  - name: mock_update
    given: Table and affected rows
    when: Mocking update
    then: Configure response

  - name: mock_delete
    given: Table and affected rows
    when: Mocking delete
    then: Configure response

  - name: seed_table
    given: Table and rows
    when: Seeding table
    then: Add mock data

  # ─────────────────────────────────────────────────────────────────────────────
  # CACHE MOCK
  # ─────────────────────────────────────────────────────────────────────────────

  - name: create_cache_mock
    given: MockConfig
    when: Creating mock
    then: Return CacheMock

  - name: mock_get
    given: Key and value
    when: Mocking get
    then: Configure response

  - name: mock_set
    given: Key
    when: Mocking set
    then: Configure response

  - name: seed_cache
    given: Key-value pairs
    when: Seeding cache
    then: Add mock data

  # ─────────────────────────────────────────────────────────────────────────────
  # PAYMENT MOCK
  # ─────────────────────────────────────────────────────────────────────────────

  - name: create_payment_mock
    given: MockConfig
    when: Creating mock
    then: Return PaymentMock

  - name: mock_create_invoice
    given: Invoice response
    when: Mocking invoice
    then: Configure response

  - name: mock_payment_success
    given: Transaction ID
    when: Mocking success
    then: Return successful payment

  - name: mock_payment_failure
    given: Error
    when: Mocking failure
    then: Return failed payment

  # ─────────────────────────────────────────────────────────────────────────────
  # HTTP MOCK
  # ─────────────────────────────────────────────────────────────────────────────

  - name: create_http_mock
    given: MockConfig
    when: Creating mock
    then: Return HttpMock

  - name: mock_request
    given: Method, URL, response
    when: Mocking request
    then: Configure response

  - name: mock_get
    given: URL and response
    when: Mocking GET
    then: Configure response

  - name: mock_post
    given: URL and response
    when: Mocking POST
    then: Configure response

  - name: get_requests
    given: URL pattern
    when: Getting requests
    then: Return matching requests

  # ─────────────────────────────────────────────────────────────────────────────
  # VERIFICATION
  # ─────────────────────────────────────────────────────────────────────────────

  - name: verify
    given: Verification
    when: Verifying calls
    then: Return VerificationResult

  - name: verify_called
    given: Mock and method
    when: Verifying called
    then: Return true if called

  - name: verify_called_once
    given: Mock and method
    when: Verifying once
    then: Return true if called once

  - name: verify_called_with
    given: Mock, method, args
    when: Verifying with args
    then: Return true if matched

  - name: verify_never_called
    given: Mock and method
    when: Verifying never
    then: Return true if never called

  - name: verify_call_order
    given: Expected order
    when: Verifying order
    then: Return true if in order

# ═══════════════════════════════════════════════════════════════════════════════
# CONSTANTS
# ═══════════════════════════════════════════════════════════════════════════════

constants:
  DEFAULT_DELAY_MS: 0
  DEFAULT_FAIL_RATE: 0.0

  MOCK_BOT_TOKEN: "123456:ABC-DEF"
  MOCK_BOT_ID: 123456
  MOCK_BOT_USERNAME: "test_bot"

  MOCK_REPLICATE_API_KEY: "r8_test_key"
  MOCK_OPENAI_API_KEY: "sk-test-key"

  MOCK_IMAGE_URL: "https://mock.example.com/image.jpg"
  MOCK_VIDEO_URL: "https://mock.example.com/video.mp4"
  MOCK_AUDIO_URL: "https://mock.example.com/audio.mp3"

  MOCK_PREDICTION_ID: "pred_test123"
  MOCK_GENERATION_ID: "gen_test123"
  MOCK_TRANSACTION_ID: "tx_test123"
