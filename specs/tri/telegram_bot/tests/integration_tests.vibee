name: integration_tests
version: "1.0.0"
language: zig
module: integration_tests

description: |
  Integration tests for VIBEE Telegram bot.
  Tests module interactions, API integrations, database operations.
  Validates cross-module functionality.

# ═══════════════════════════════════════════════════════════════════════════════
# TYPES
# ═══════════════════════════════════════════════════════════════════════════════

types:
  IntegrationTestRunner:
    description: "Integration test runner"
    fields:
      config: TestConfig
      suites: List<TestSuite>
      is_running: Bool

  TestConfig:
    description: "Test configuration"
    fields:
      database_url: String
      redis_url: Option<String>
      api_keys: Object
      timeout_ms: Int
      parallel: Bool
      cleanup_after: Bool

  TestSuite:
    description: "Test suite"
    fields:
      suite_id: String
      name: String
      description: String
      category: SuiteCategory
      tests: List<IntegrationTest>
      setup: Option<String>
      teardown: Option<String>

  SuiteCategory:
    description: "Suite category"
    values:
      - database
      - cache
      - api
      - payment
      - notification
      - ai_service
      - cross_module

  IntegrationTest:
    description: "Integration test"
    fields:
      test_id: String
      name: String
      description: String
      modules: List<String>
      setup: Option<String>
      teardown: Option<String>
      assertions: List<Assertion>
      timeout_ms: Int

  Assertion:
    description: "Test assertion"
    fields:
      assertion_type: AssertionType
      expected: Object
      actual_path: String
      message: String

  AssertionType:
    description: "Assertion type"
    values:
      - equals
      - not_equals
      - contains
      - not_contains
      - greater_than
      - less_than
      - is_null
      - is_not_null
      - is_true
      - is_false
      - matches_regex

  TestResult:
    description: "Test result"
    fields:
      test_id: String
      suite_id: String
      status: TestStatus
      duration_ms: Int
      assertions_passed: Int
      assertions_failed: Int
      error: Option<String>
      logs: List<String>

  TestStatus:
    description: "Test status"
    values:
      - passed
      - failed
      - skipped
      - error

  SuiteResult:
    description: "Suite result"
    fields:
      suite_id: String
      status: TestStatus
      duration_ms: Int
      tests_passed: Int
      tests_failed: Int
      tests_skipped: Int
      test_results: List<TestResult>

  IntegrationReport:
    description: "Integration report"
    fields:
      report_id: String
      started_at: Timestamp
      completed_at: Timestamp
      total_suites: Int
      total_tests: Int
      passed: Int
      failed: Int
      skipped: Int
      duration_ms: Int
      suite_results: List<SuiteResult>
      coverage: ModuleCoverage

  ModuleCoverage:
    description: "Module coverage"
    fields:
      modules_tested: List<String>
      modules_total: Int
      coverage_percent: Float
      untested_modules: List<String>

# ═══════════════════════════════════════════════════════════════════════════════
# BEHAVIORS
# ═══════════════════════════════════════════════════════════════════════════════

behaviors:
  # ─────────────────────────────────────────────────────────────────────────────
  # RUNNER
  # ─────────────────────────────────────────────────────────────────────────────

  - name: init_runner
    given: TestConfig
    when: Initializing runner
    then: Return IntegrationTestRunner

  - name: run_all_suites
    given: No parameters
    when: Running all suites
    then: Return IntegrationReport

  - name: run_suite
    given: Suite ID
    when: Running single suite
    then: Return SuiteResult

  - name: run_test
    given: Test ID
    when: Running single test
    then: Return TestResult

  - name: run_suites_by_category
    given: SuiteCategory
    when: Running category
    then: Return list of results

  # ─────────────────────────────────────────────────────────────────────────────
  # DATABASE INTEGRATION
  # ─────────────────────────────────────────────────────────────────────────────

  - name: test_user_repository_crud
    given: Test database
    when: Testing user CRUD
    then: Verify all operations

  - name: test_payment_repository_crud
    given: Test database
    when: Testing payment CRUD
    then: Verify all operations

  - name: test_generation_repository_crud
    given: Test database
    when: Testing generation CRUD
    then: Verify all operations

  - name: test_database_transactions
    given: Test database
    when: Testing transactions
    then: Verify commit and rollback

  - name: test_database_connection_pool
    given: Test database
    when: Testing pool
    then: Verify pool behavior

  # ─────────────────────────────────────────────────────────────────────────────
  # CACHE INTEGRATION
  # ─────────────────────────────────────────────────────────────────────────────

  - name: test_cache_user_state
    given: Cache instance
    when: Testing user state caching
    then: Verify cache operations

  - name: test_cache_session
    given: Cache instance
    when: Testing session caching
    then: Verify session operations

  - name: test_cache_rate_limit
    given: Cache instance
    when: Testing rate limit
    then: Verify rate limiting

  - name: test_cache_expiration
    given: Cache instance
    when: Testing TTL
    then: Verify expiration

  - name: test_cache_invalidation
    given: Cache instance
    when: Testing invalidation
    then: Verify cache cleared

  # ─────────────────────────────────────────────────────────────────────────────
  # API INTEGRATION
  # ─────────────────────────────────────────────────────────────────────────────

  - name: test_replicate_api_connection
    given: API key
    when: Testing connection
    then: Verify API accessible

  - name: test_replicate_model_list
    given: API key
    when: Listing models
    then: Verify models returned

  - name: test_openai_api_connection
    given: API key
    when: Testing connection
    then: Verify API accessible

  - name: test_openai_chat_completion
    given: API key
    when: Testing chat
    then: Verify response

  - name: test_telegram_api_connection
    given: Bot token
    when: Testing connection
    then: Verify bot info

  # ─────────────────────────────────────────────────────────────────────────────
  # PAYMENT INTEGRATION
  # ─────────────────────────────────────────────────────────────────────────────

  - name: test_wallet_balance_operations
    given: Test user
    when: Testing balance ops
    then: Verify credit and debit

  - name: test_wallet_transaction_history
    given: Test user
    when: Testing history
    then: Verify transactions recorded

  - name: test_subscription_activation
    given: Test user
    when: Activating subscription
    then: Verify subscription active

  - name: test_subscription_expiration
    given: Test user with expired sub
    when: Checking subscription
    then: Verify expired status

  - name: test_payment_webhook_processing
    given: Webhook payload
    when: Processing webhook
    then: Verify payment recorded

  # ─────────────────────────────────────────────────────────────────────────────
  # NOTIFICATION INTEGRATION
  # ─────────────────────────────────────────────────────────────────────────────

  - name: test_notification_send
    given: Test user
    when: Sending notification
    then: Verify notification sent

  - name: test_notification_preferences
    given: Test user
    when: Testing preferences
    then: Verify preferences applied

  - name: test_broadcast_send
    given: Test users
    when: Sending broadcast
    then: Verify all received

  - name: test_scheduled_notification
    given: Scheduled notification
    when: Time reached
    then: Verify notification sent

  # ─────────────────────────────────────────────────────────────────────────────
  # AI SERVICE INTEGRATION
  # ─────────────────────────────────────────────────────────────────────────────

  - name: test_ai_queue_submit
    given: Generation job
    when: Submitting job
    then: Verify job queued

  - name: test_ai_queue_processing
    given: Queued job
    when: Processing job
    then: Verify job processed

  - name: test_ai_queue_priority
    given: Multiple jobs
    when: Processing queue
    then: Verify priority order

  - name: test_model_registry_lookup
    given: Model ID
    when: Looking up model
    then: Verify model info

  # ─────────────────────────────────────────────────────────────────────────────
  # CROSS-MODULE INTEGRATION
  # ─────────────────────────────────────────────────────────────────────────────

  - name: test_generation_with_payment
    given: Test user
    when: Generating with payment
    then: Verify balance deducted

  - name: test_subscription_with_limits
    given: Test user with subscription
    when: Checking limits
    then: Verify limits applied

  - name: test_user_state_with_cache
    given: Test user
    when: Testing state
    then: Verify cache sync

  - name: test_notification_with_template
    given: Template and user
    when: Sending notification
    then: Verify template rendered

  - name: test_moderation_with_generation
    given: Generation with flagged content
    when: Processing generation
    then: Verify moderation applied

  # ─────────────────────────────────────────────────────────────────────────────
  # UTILITIES
  # ─────────────────────────────────────────────────────────────────────────────

  - name: setup_test_database
    given: Config
    when: Setting up
    then: Create test schema

  - name: teardown_test_database
    given: Config
    when: Tearing down
    then: Drop test schema

  - name: seed_test_data
    given: Seed config
    when: Seeding
    then: Insert test data

  - name: generate_report
    given: Results
    when: Generating report
    then: Return IntegrationReport

# ═══════════════════════════════════════════════════════════════════════════════
# CONSTANTS
# ═══════════════════════════════════════════════════════════════════════════════

constants:
  DEFAULT_TIMEOUT_MS: 10000
  DATABASE_TIMEOUT_MS: 5000
  API_TIMEOUT_MS: 30000

  TEST_DATABASE_PREFIX: "test_"
  TEST_USER_ID_BASE: 800000000

  SUITE_DATABASE: "database"
  SUITE_CACHE: "cache"
  SUITE_API: "api"
  SUITE_PAYMENT: "payment"
  SUITE_NOTIFICATION: "notification"
  SUITE_AI: "ai_service"
  SUITE_CROSS: "cross_module"
