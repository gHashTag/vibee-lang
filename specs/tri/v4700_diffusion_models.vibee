# v4700 - Diffusion Models
# =========================
# Генеративные модели нового поколения
# φ² + 1/φ² = 3 | PHOENIX = 999

name: diffusion_models
version: "4.7.0"
language: zig
module: diffusion_models

constants:
  PHI: 1.618033988749895
  NUM_TIMESTEPS: 1000
  BETA_START: 0.0001
  BETA_END: 0.02

types:
  DiffusionConfig:
    fields:
      num_timesteps: Int
      beta_schedule: String
      prediction_type: String
      
  NoiseSchedule:
    fields:
      betas: List
      alphas: List
      alphas_cumprod: List
      
  NoisyImage:
    fields:
      x_t: List
      noise: List
      timestep: Int
      
  DenoisingModel:
    fields:
      unet: Object
      time_embedding: Object
      
  SamplingConfig:
    fields:
      num_steps: Int
      guidance_scale: Float
      sampler: String
      
  GeneratedSample:
    fields:
      image: List
      trajectory: List
      
  ConditioningInfo:
    fields:
      text_embedding: List
      class_label: Int
      image_embedding: List
      
  DiffusionLoss:
    fields:
      loss: Float
      noise_pred: List
      target_noise: List

behaviors:
  - name: compute_noise_schedule
    given: Num timesteps и schedule type
    when: Вычисление betas/alphas
    then: Вернуть noise schedule
    
  - name: add_noise
    given: Clean image, noise, timestep
    when: Forward diffusion
    then: Вернуть noisy image
    
  - name: predict_noise
    given: Noisy image, timestep, model
    when: Noise prediction
    then: Вернуть predicted noise
    
  - name: denoise_step
    given: x_t, predicted noise, t
    when: Один шаг denoising
    then: Вернуть x_{t-1}
    
  - name: sample
    given: Model и sampling config
    when: Полная генерация
    then: Вернуть generated sample
    
  - name: compute_diffusion_loss
    given: Predicted и target noise
    when: Training loss
    then: Вернуть MSE loss
    
  - name: classifier_free_guidance
    given: Cond и uncond predictions
    when: CFG
    then: Вернуть guided prediction
    
  - name: ddim_step
    given: x_t, noise pred, t, eta
    when: DDIM sampling
    then: Вернуть x_{t-1}
