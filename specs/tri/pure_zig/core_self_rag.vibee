name: core_self_rag
version: "11.0.0"
language: zig
module: core_self_rag

# CORE: Self-RAG - Self-Reflective Retrieval-Augmented Generation
# Based on arXiv:2310.11511
# Adaptive retrieval + self-reflection tokens
# Outperforms ChatGPT on QA, reasoning, fact verification

types:
  RetrievalToken:
    fields:
      token_type: String
      value: String

  RetrievalDecision:
    fields:
      should_retrieve: Bool
      query: Option<String>
      confidence: Float

  Passage:
    fields:
      passage_id: String
      content: String
      relevance_score: Float
      source: String

  CritiqueToken:
    fields:
      is_supported: Bool
      is_useful: Bool
      reasoning: String

  GenerationSegment:
    fields:
      content: String
      retrieval_used: Bool
      passages_cited: List<String>
      critique: String

  SelfRAGConfig:
    fields:
      retrieval_threshold: Float
      max_passages: Int
      enable_critique: Bool
      citation_required: Bool

behaviors:
  - name: decide_retrieval
    given: Current context and query
    when: Deciding if retrieval needed
    then: Return RetrievalDecision

  - name: retrieve_passages
    given: Query and max_passages
    when: Fetching relevant passages
    then: Return list of Passages

  - name: generate_with_passages
    given: Context and Passages
    when: Generating response with citations
    then: Return GenerationSegment

  - name: critique_generation
    given: GenerationSegment and Passages
    when: Self-evaluating generation quality
    then: Return CritiqueToken

  - name: is_supported
    given: Claim and Passages
    when: Checking factual support
    then: Return support score

  - name: is_useful
    given: GenerationSegment and task
    when: Checking response utility
    then: Return utility score

  - name: generate_self_rag
    given: Query and SelfRAGConfig
    when: Running full Self-RAG pipeline
    then: Return final response with citations
