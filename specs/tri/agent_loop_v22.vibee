name: agent_loop_v22
version: "22.3.0"
language: zig
module: agent_loop_v22

types:
  LoopConfig:
    fields:
      max_steps: Int
      timeout_ms: Int
      retry_on_error: Bool
      max_retries: Int
      step_delay_ms: Int

  LoopState:
    fields:
      current_step: Int
      goal: String
      observation: String
      last_action: String
      is_complete: Bool
      error_count: Int

  StepResult:
    fields:
      step_num: Int
      observation: String
      reasoning: String
      action: String
      success: Bool
      duration_ms: Int

  LoopResult:
    fields:
      success: Bool
      steps_taken: Int
      final_answer: String
      trajectory: List<String>
      total_duration_ms: Int
      error_message: Option<String>

  AgentLoop:
    fields:
      config: Object
      state: Object
      cdp_client: Object
      llm_client: Object

behaviors:
  - name: create_loop
    given: LoopConfig
    when: Initialize loop
    then: AgentLoop instance

  - name: run
    given: AgentLoop and goal
    when: Execute full loop
    then: LoopResult

  - name: step
    given: AgentLoop
    when: Execute one step
    then: StepResult

  - name: observe
    given: AgentLoop
    when: Get page observation
    then: Observation string

  - name: think
    given: AgentLoop and observation
    when: Query LLM for action
    then: Action decision

  - name: act
    given: AgentLoop and action
    when: Execute action via CDP
    then: Action result

  - name: check_done
    given: AgentLoop
    when: Check if goal reached
    then: Completion status

  - name: get_state
    given: AgentLoop
    when: Get current state
    then: LoopState

  - name: reset
    given: AgentLoop
    when: Reset for new task
    then: Reset loop

  - name: abort
    given: AgentLoop
    when: Stop execution
    then: Aborted

  - name: get_trajectory
    given: AgentLoop
    when: Get action history
    then: Trajectory list
