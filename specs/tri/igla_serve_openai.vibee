# iGLA Serve OpenAI
# OpenAI-compatible API implementation
# φ² + 1/φ² = 3 | V = n × 3^k × π^m × φ^p

name: igla_serve_openai
version: "1.0.0"
language: zig
module: igla_serve_openai

sacred_constants:
  phi: 1.618033988749895
  trinity: 3.0
  phoenix: 999

types:
  OpenAICompletionRequest:
    fields:
      model: String
      prompt: String
      max_tokens: Int
      temperature: Float
      top_p: Float
      n: Int
      stream: Bool
      stop: String
      presence_penalty: Float
      frequency_penalty: Float

  OpenAICompletionResponse:
    fields:
      id: String
      object: String
      created: Int
      model: String
      choices: String
      usage: String

  OpenAIChatRequest:
    fields:
      model: String
      messages: String
      max_tokens: Int
      temperature: Float
      stream: Bool

  OpenAIChatMessage:
    fields:
      role: String
      content: String
      name: String

  OpenAIUsage:
    fields:
      prompt_tokens: Int
      completion_tokens: Int
      total_tokens: Int

  OpenAIModel:
    fields:
      id: String
      object: String
      created: Int
      owned_by: String

behaviors:
  - name: parse_completion_request
    given: "JSON body"
    when: "Parsing"
    then: "CompletionRequest parsed"

  - name: parse_chat_request
    given: "JSON body"
    when: "Parsing"
    then: "ChatRequest parsed"

  - name: format_completion_response
    given: "Generation result"
    when: "Formatting"
    then: "OpenAI format response"

  - name: format_chat_response
    given: "Generation result"
    when: "Formatting"
    then: "OpenAI chat format"

  - name: format_stream_chunk
    given: "Token"
    when: "Streaming"
    then: "SSE chunk formatted"

  - name: list_models
    given: "Models request"
    when: "GET /v1/models"
    then: "Models list returned"

  - name: validate_request
    given: "Request"
    when: "Validation"
    then: "Request validated"

  - name: calculate_usage
    given: "Tokens"
    when: "Usage calculation"
    then: "Usage object created"

  - name: generate_request_id
    given: "Request"
    when: "ID generation"
    then: "Unique ID generated"

  - name: phi_openai_harmony
    given: "OpenAI API"
    when: "Harmony"
    then: "φ-optimal compatibility"
