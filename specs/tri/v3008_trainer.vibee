# v3008 - Trainer Specification
# ==============================
# Complete training loop for CPU
# φ² + 1/φ² = 3 | PHOENIX = 999

name: trainer
version: "3.0.8"
language: zig
module: trainer

constants:
  PHI: 1.618033988749895
  PHOENIX: 999
  DEFAULT_STEPS: 1000
  LOG_INTERVAL: 100

types:
  TrainerConfig:
    fields:
      learning_rate: Float
      weight_decay: Float
      max_steps: Int
      log_interval: Int
      eval_interval: Int
      save_interval: Int
      seed: Int
      
  TrainerState:
    fields:
      global_step: Int
      epoch: Int
      best_loss: Float
      total_loss: Float
      
  DataGenerator:
    fields:
      vocab_size: Int
      seq_length: Int
      seed: Int
      
  TrainingLog:
    fields:
      step: Int
      loss: Float
      lr: Float
      throughput: Float
      
  EvalResult:
    fields:
      loss: Float
      perplexity: Float
      accuracy: Float

behaviors:
  - name: init_trainer
    given: Model, optimizer, and config
    when: Initializing trainer
    then: Return trainer state
    
  - name: train_step
    given: Model, batch, and optimizer
    when: Executing single training step
    then: Return loss and updated state
    
  - name: train_epoch
    given: Model, data, and config
    when: Training full epoch
    then: Return epoch metrics
    
  - name: train_loop
    given: Model, data, and config
    when: Running complete training
    then: Return final metrics and model
    
  - name: evaluate
    given: Model and eval data
    when: Evaluating model
    then: Return evaluation metrics
    
  - name: generate_batch
    given: Data generator
    when: Creating training batch
    then: Return input and target tensors
    
  - name: log_metrics
    given: Step and metrics
    when: Logging training progress
    then: Print formatted metrics
    
  - name: should_save
    given: Step and config
    when: Checking save interval
    then: Return true if should save
    
  - name: compute_throughput
    given: Batch size, seq_length, and time
    when: Computing tokens per second
    then: Return throughput value
