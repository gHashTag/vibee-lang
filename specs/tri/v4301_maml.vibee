# v4301 - MAML
# =============
# Model-Agnostic Meta-Learning
# φ² + 1/φ² = 3 | PHOENIX = 999

name: maml
version: "4.3.1"
language: zig
module: maml

constants:
  PHI: 1.618033988749895
  INNER_LR: 0.01
  OUTER_LR: 0.001
  INNER_STEPS: 5

types:
  MAMLConfig:
    fields:
      inner_lr: Float
      outer_lr: Float
      inner_steps: Int
      first_order: Bool
      
  MAMLState:
    fields:
      meta_params: List
      inner_optimizer: Object
      outer_optimizer: Object
      
  TaskGradients:
    fields:
      task_id: Int
      gradients: List
      loss: Float
      
  SecondOrderInfo:
    fields:
      hessian_vector_product: List
      computation_graph: Object
      
  FOMAMLState:
    fields:
      params: List
      first_order_grads: List
      
  ReptileState:
    fields:
      params: List
      task_params: List
      interpolation_rate: Float
      
  MAMLLoss:
    fields:
      inner_loss: Float
      outer_loss: Float
      regularization: Float
      
  AdaptationPath:
    fields:
      param_trajectory: List
      loss_trajectory: List

behaviors:
  - name: maml_inner_update
    given: Params, support set, inner_lr
    when: Task adaptation
    then: Return adapted params
    
  - name: maml_outer_update
    given: Meta params and task grads
    when: Meta update
    then: Return updated meta params
    
  - name: compute_second_order
    given: Inner and outer gradients
    when: Full MAML gradient
    then: Return second order info
    
  - name: fomaml_update
    given: Params and first order grads
    when: First-order approximation
    then: Return FOMAML state
    
  - name: reptile_update
    given: Meta params and task params
    when: Reptile interpolation
    then: Return reptile state
    
  - name: multi_step_adaptation
    given: Params and data
    when: Multiple inner steps
    then: Return adaptation path
    
  - name: compute_task_loss
    given: Adapted params and query
    when: Evaluating on query
    then: Return MAML loss
    
  - name: meta_batch_update
    given: State and task batch
    when: Batch meta-update
    then: Return updated state
