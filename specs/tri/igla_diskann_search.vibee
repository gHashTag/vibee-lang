# iGLA DiskANN Search
# Beam search with SSD I/O
# Scientific basis: Jayaram Subramanya et al. 2019
# φ² + 1/φ² = 3 | V = n × 3^k × π^m × φ^p

name: igla_diskann_search
version: "1.0.0"
language: zig
module: igla_diskann_search

sacred_constants:
  phi: 1.618033988749895
  trinity: 3.0
  phoenix: 999
  default_beam_width: 4

scientific_references:
  - "Jayaram Subramanya et al. 2019: DiskANN"
  - "Ren et al. 2020: HM-ANN"

types:
  SearchConfig:
    fields:
      L: Int
      beam_width: Int
      use_pq_rerank: Bool
      num_threads: Int

  BeamState:
    fields:
      candidates: String
      visited: String
      best_so_far: String

  SectorRead:
    fields:
      sector_id: Int
      data: String
      latency_us: Float

  SearchResult:
    fields:
      id: Int
      distance: Float
      from_pq: Bool

  IOStats:
    fields:
      sectors_read: Int
      bytes_read: Int
      io_latency_ms: Float

  CachedSector:
    fields:
      sector_id: Int
      data: String
      last_access: Int

behaviors:
  - name: beam_search
    given: "Query, L, beam_width"
    when: "Search"
    then: "K nearest neighbors"

  - name: load_sector
    given: "Sector_id"
    when: "Disk read"
    then: "Sector data loaded"

  - name: pq_distance
    given: "Query, PQ code"
    when: "Approximate distance"
    then: "PQ-based distance"

  - name: rerank_with_full
    given: "Candidates, full vectors"
    when: "Reranking"
    then: "Exact distances"

  - name: prefetch_sectors
    given: "Predicted sectors"
    when: "Prefetching"
    then: "Async sector loads"

  - name: cache_sector
    given: "Sector data"
    when: "Caching"
    then: "Sector in cache"

  - name: batch_search
    given: "Query batch"
    when: "Batch search"
    then: "Batched results"

  - name: phi_beam_width
    given: "Recall target"
    when: "Sacred tuning"
    then: "φ-optimal beam width"
