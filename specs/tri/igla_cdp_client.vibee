# VIBEE Specification - IGLA CDP Client
# Chrome DevTools Protocol Integration
# Browser Automation v4
# φ² + 1/φ² = 3 | PHOENIX = 999

name: igla_cdp_client
version: "4.0.0"
language: zig
module: igla_cdp_client

types:
  CDPClient:
    fields:
      id: String
      ws_url: String
      connected: Bool
      message_id: Int
      session_id: String
      target_id: String

  CDPConfig:
    fields:
      host: String
      port: Int
      secure: Bool
      timeout_ms: Int
      headless: Bool
      devtools: Bool

  CDPMessage:
    fields:
      id: Int
      method: String
      params: String
      session_id: String

  CDPResponse:
    fields:
      id: Int
      result: String
      error_code: Int
      error_message: String

  CDPEvent:
    fields:
      method: String
      params: String
      session_id: String
      timestamp: Int

  PageInfo:
    fields:
      url: String
      title: String
      frame_id: String
      loader_id: String

  DOMNode:
    fields:
      node_id: Int
      backend_node_id: Int
      node_type: Int
      node_name: String
      node_value: String
      child_count: Int

  NetworkRequest:
    fields:
      request_id: String
      url: String
      method: String
      headers: String
      post_data: String
      timestamp: Float

  NetworkResponse:
    fields:
      request_id: String
      url: String
      status: Int
      headers: String
      mime_type: String
      body_size: Int

  Screenshot:
    fields:
      data: String
      format: String
      width: Int
      height: Int
      quality: Int

  InputEvent:
    fields:
      event_type: String
      x: Int
      y: Int
      button: String
      modifiers: Int
      key: String
      text: String

  BrowserMetrics:
    fields:
      pages_loaded: Int
      requests_made: Int
      screenshots_taken: Int
      events_received: Int
      errors_count: Int
      uptime_ms: Int

behaviors:
  - name: connect
    given: CDP config with host and port
    when: Client connects to browser
    then: WebSocket connection established

  - name: disconnect
    given: Active CDP connection
    when: Client disconnects
    then: Connection closed cleanly

  - name: send_command
    given: Connected client
    when: CDP command sent
    then: Response received with result or error

  - name: navigate
    given: Connected client
    when: Page.navigate called with URL
    then: Page loads and returns frame info

  - name: get_document
    given: Page loaded
    when: DOM.getDocument called
    then: Root DOM node returned

  - name: query_selector
    given: DOM document
    when: DOM.querySelector called
    then: Matching node ID returned

  - name: query_selector_all
    given: DOM document
    when: DOM.querySelectorAll called
    then: Array of node IDs returned

  - name: get_outer_html
    given: Node ID
    when: DOM.getOuterHTML called
    then: HTML string returned

  - name: click_element
    given: Element coordinates
    when: Input.dispatchMouseEvent called
    then: Click event dispatched

  - name: type_text
    given: Target element
    when: Input.insertText called
    then: Text inserted into element

  - name: take_screenshot
    given: Page loaded
    when: Page.captureScreenshot called
    then: Base64 image data returned

  - name: intercept_network
    given: Network domain enabled
    when: Request made
    then: Request details captured

  - name: evaluate_script
    given: Runtime enabled
    when: Runtime.evaluate called
    then: Script result returned

  - name: wait_for_navigation
    given: Navigation started
    when: Page.loadEventFired received
    then: Navigation complete

  - name: handle_event
    given: Event subscription active
    when: CDP event received
    then: Event handler invoked

  - name: get_metrics
    given: Active session
    when: Metrics requested
    then: Browser metrics returned

test_cases:
  - name: test_config_default
    input: {}
    expected: { host: "localhost", port: 9222 }

  - name: test_message_format
    input: { method: "Page.navigate", params: "{\"url\":\"https://example.com\"}" }
    expected: { valid: true }

  - name: test_screenshot_format
    input: { format: "png", quality: 80 }
    expected: { valid: true }

  - name: test_input_click
    input: { x: 100, y: 200, button: "left" }
    expected: { dispatched: true }

  - name: test_dom_query
    input: { selector: "#main" }
    expected: { found: true }

  - name: test_network_intercept
    input: { url: "https://api.example.com" }
    expected: { intercepted: true }

  - name: test_evaluate_script
    input: { expression: "document.title" }
    expected: { result_type: "string" }

  - name: test_metrics_collection
    input: {}
    expected: { pages_loaded: 0, errors_count: 0 }
