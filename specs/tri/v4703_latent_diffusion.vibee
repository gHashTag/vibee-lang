# v4703 - Latent Diffusion
# =========================
# Stable Diffusion, DALL-E архитектура
# φ² + 1/φ² = 3 | PHOENIX = 999

name: latent_diffusion
version: "4.7.3"
language: zig
module: latent_diffusion

constants:
  PHI: 1.618033988749895
  LATENT_CHANNELS: 4
  DOWNSCALE_FACTOR: 8
  GUIDANCE_SCALE: 7.5

types:
  LDMConfig:
    fields:
      latent_channels: Int
      downscale_factor: Int
      use_ema: Bool
      
  VAEEncoder:
    fields:
      encoder: Object
      quant_conv: Object
      
  VAEDecoder:
    fields:
      decoder: Object
      post_quant_conv: Object
      
  LatentSpace:
    fields:
      mean: List
      logvar: List
      sample: List
      
  TextEncoder:
    fields:
      tokenizer: Object
      transformer: Object
      
  CrossAttention:
    fields:
      query_proj: Object
      key_proj: Object
      value_proj: Object
      
  UNetConditioned:
    fields:
      unet: Object
      cross_attention_dim: Int
      
  StableDiffusionPipeline:
    fields:
      vae: Object
      text_encoder: Object
      unet: Object
      scheduler: Object

behaviors:
  - name: encode_to_latent
    given: Image и VAE encoder
    when: Encoding to latent
    then: Вернуть latent representation
    
  - name: decode_from_latent
    given: Latent и VAE decoder
    when: Decoding to image
    then: Вернуть reconstructed image
    
  - name: encode_text_prompt
    given: Text и text encoder
    when: Text encoding
    then: Вернуть text embeddings
    
  - name: cross_attention_forward
    given: Query, context
    when: Cross-attention
    then: Вернуть attended features
    
  - name: conditioned_unet_forward
    given: Latent, timestep, context
    when: Conditioned denoising
    then: Вернуть noise prediction
    
  - name: ldm_training_step
    given: Image, text, model
    when: Training step
    then: Вернуть loss
    
  - name: text_to_image
    given: Prompt и pipeline
    when: Full generation
    then: Вернуть generated image
    
  - name: image_to_image
    given: Image, prompt, strength
    when: Img2img generation
    then: Вернуть edited image
