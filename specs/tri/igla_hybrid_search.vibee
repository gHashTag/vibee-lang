# iGLA Hybrid Search
# Combines BM25 (sparse) + Dense embeddings
# Scientific basis: Karpukhin et al. 2020 (DPR), Ma et al. 2021
# φ² + 1/φ² = 3 | V = n × 3^k × π^m × φ^p

name: igla_hybrid_search
version: "1.0.0"
language: zig
module: igla_hybrid_search

sacred_constants:
  phi: 1.618033988749895
  trinity: 3.0
  phoenix: 999
  alpha: 0.5

scientific_references:
  - "Karpukhin et al. 2020: Dense Passage Retrieval"
  - "Ma et al. 2021: A Replication Study of Dense Passage Retriever"
  - "Lin et al. 2021: Pyserini"
  - "Luan et al. 2021: Sparse, Dense, and Attentional Representations"

types:
  HybridConfig:
    fields:
      alpha: Float
      bm25_weight: Float
      dense_weight: Float
      fusion_method: String
      top_k: Int

  SparseScore:
    fields:
      doc_id: Int
      bm25_score: Float
      rank: Int

  DenseScore:
    fields:
      doc_id: Int
      cosine_score: Float
      rank: Int

  HybridScore:
    fields:
      doc_id: Int
      sparse_score: Float
      dense_score: Float
      fused_score: Float
      final_rank: Int

  FusionMethod:
    fields:
      name: String
      formula: String

  RetrievalResult:
    fields:
      doc_id: Int
      content: String
      score: Float
      source: String

behaviors:
  - name: search_sparse
    given: "Query"
    when: "BM25 search"
    then: "List of SparseScores"

  - name: search_dense
    given: "Query embedding"
    when: "Dense search"
    then: "List of DenseScores"

  - name: reciprocal_rank_fusion
    given: "Sparse results, Dense results, k=60"
    when: "RRF fusion"
    then: "Fused ranking by RRF"

  - name: linear_combination
    given: "Sparse scores, Dense scores, alpha"
    when: "Linear fusion"
    then: "Weighted combination scores"

  - name: normalize_scores
    given: "List of scores"
    when: "Normalization"
    then: "Min-max normalized scores"

  - name: hybrid_search
    given: "Query, top_k"
    when: "Hybrid retrieval"
    then: "Top-K by fused score"

  - name: adaptive_alpha
    given: "Query complexity"
    when: "Alpha tuning"
    then: "Optimal alpha for query type"

  - name: phi_fusion
    given: "Sparse, Dense scores"
    when: "Sacred fusion"
    then: "φ-weighted hybrid score"
