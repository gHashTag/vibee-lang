# multi_step_planning_v2350.vibee - Multi-step Planning for WebArena Agent
# Plan multiple actions before execution with rollback capability
# φ² + 1/φ² = 3 | PHOENIX = 999

name: multi_step_planning_v2350
version: "23.50.0"
language: zig
module: multi_step_planning_v2350

types:
  ActionStep:
    fields:
      step_id: String
      action_type: String
      target_selector: String
      parameters: Object
      expected_outcome: String
      preconditions: List
      postconditions: List

  ExecutionPlan:
    fields:
      plan_id: String
      goal: String
      steps: List
      current_step_index: Int
      status: String
      created_at: Timestamp

  StepResult:
    fields:
      step_id: String
      success: Bool
      actual_outcome: String
      error_message: Option
      execution_time_ms: Float
      state_snapshot: Object

  PlanExecution:
    fields:
      plan_id: String
      completed_steps: List
      failed_step: Option
      rollback_performed: Bool
      total_time_ms: Float

  RollbackAction:
    fields:
      step_id: String
      undo_action_type: String
      undo_parameters: Object
      state_to_restore: Object

  ReplanRequest:
    fields:
      original_plan_id: String
      failed_at_step: Int
      failure_reason: String
      current_state: Object

  PlanMetrics:
    fields:
      total_plans: Int
      successful_plans: Int
      failed_plans: Int
      avg_steps_per_plan: Float
      avg_execution_time_ms: Float
      rollback_count: Int

  PlannerConfig:
    fields:
      max_steps: Int
      enable_rollback: Bool
      enable_replan: Bool
      max_replan_attempts: Int
      step_timeout_ms: Int

behaviors:
  - name: create_plan
    given: Goal description and current DOM state
    when: Planning phase initiated
    then: Return ExecutionPlan with ordered ActionSteps

  - name: validate_plan
    given: ExecutionPlan
    when: Pre-execution validation
    then: Return validation result with any issues

  - name: execute_step
    given: ActionStep and current state
    when: Step execution
    then: Return StepResult with outcome

  - name: execute_plan
    given: ExecutionPlan
    when: Full plan execution
    then: Return PlanExecution with all results

  - name: check_preconditions
    given: ActionStep and current state
    when: Before step execution
    then: Return Bool indicating if preconditions met

  - name: verify_postconditions
    given: ActionStep and StepResult
    when: After step execution
    then: Return Bool indicating if postconditions satisfied

  - name: create_rollback
    given: ActionStep and state snapshot
    when: Rollback preparation
    then: Return RollbackAction

  - name: execute_rollback
    given: List of RollbackActions
    when: Plan failure detected
    then: Restore previous state

  - name: replan
    given: ReplanRequest
    when: Plan failed and replan enabled
    then: Return new ExecutionPlan avoiding previous failure

  - name: get_metrics
    given: Time range
    when: Metrics query
    then: Return PlanMetrics

sacred_constants:
  phi: 1.618033988749895
  phoenix: 999
  max_default_steps: 10
  default_step_timeout_ms: 5000
