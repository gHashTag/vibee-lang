# v4601 - Contrastive Learning
# =============================
# SimCLR, MoCo, InfoNCE - ядро SSL
# φ² + 1/φ² = 3 | PHOENIX = 999

name: contrastive_learning
version: "4.6.1"
language: zig
module: contrastive_learning

constants:
  PHI: 1.618033988749895
  TEMPERATURE: 0.07
  MOMENTUM: 0.999
  QUEUE_SIZE: 65536

types:
  ContrastiveConfig:
    fields:
      method: String
      temperature: Float
      use_momentum: Bool
      
  PositivePair:
    fields:
      anchor: List
      positive: List
      
  NegativeSamples:
    fields:
      negatives: List
      source: String
      
  InfoNCELoss:
    fields:
      loss: Float
      accuracy: Float
      
  MoCoQueue:
    fields:
      queue: List
      ptr: Int
      size: Int
      
  SimCLRBatch:
    fields:
      z_i: List
      z_j: List
      batch_size: Int
      
  NTXentLoss:
    fields:
      loss: Float
      positive_sim: Float
      negative_sim: Float
      
  HardNegative:
    fields:
      embedding: List
      hardness: Float
      source_idx: Int

behaviors:
  - name: compute_info_nce
    given: Anchor, positive, negatives
    when: InfoNCE loss
    then: Вернуть loss и accuracy
    
  - name: compute_nt_xent
    given: Batch embeddings
    when: NT-Xent loss (SimCLR)
    then: Вернуть loss
    
  - name: update_moco_queue
    given: Queue и новые keys
    when: Обновление очереди
    then: Вернуть обновлённую queue
    
  - name: momentum_update
    given: Query и key encoder
    when: EMA обновление
    then: Вернуть обновлённый key encoder
    
  - name: mine_hard_negatives
    given: Embeddings и стратегия
    when: Поиск hard negatives
    then: Вернуть hard negatives
    
  - name: compute_similarity_matrix
    given: Batch embeddings
    when: Вычисление сходства
    then: Вернуть матрицу сходства
    
  - name: supervised_contrastive
    given: Embeddings и labels
    when: SupCon loss
    then: Вернуть loss
    
  - name: debiased_contrastive
    given: Embeddings и tau_plus
    when: Debiased NCE
    then: Вернуть debiased loss
