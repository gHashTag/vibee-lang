# VIBEE Specification - IGLA Visual Diff
# Visual regression testing and comparison
# Browser Automation v4
# φ² + 1/φ² = 3 | PHOENIX = 999

name: igla_visual_diff
version: "4.0.0"
language: zig
module: igla_visual_diff

types:
  Image:
    fields:
      data: String
      width: Int
      height: Int
      format: String
      channels: Int

  BoundingBox:
    fields:
      x: Int
      y: Int
      width: Int
      height: Int

  DiffRegion:
    fields:
      box: String
      pixel_count: Int
      diff_percentage: Float
      severity: String

  DiffResult:
    fields:
      match: Bool
      diff_percentage: Float
      diff_regions: String
      diff_image: String
      baseline_hash: String
      actual_hash: String

  CompareOptions:
    fields:
      threshold: Float
      ignore_antialiasing: Bool
      ignore_colors: Bool
      ignore_regions: String
      match_threshold: Float

  Baseline:
    fields:
      id: String
      name: String
      image_hash: String
      created_at: Int
      viewport: String
      url: String

  BaselineStore:
    fields:
      baselines: String
      storage_path: String
      total_count: Int

  VisualTest:
    fields:
      id: String
      name: String
      baseline_id: String
      status: String
      diff_result: String
      timestamp: Int

  VisualReport:
    fields:
      total_tests: Int
      passed: Int
      failed: Int
      new_baselines: Int
      test_results: String

  PixelData:
    fields:
      r: Int
      g: Int
      b: Int
      a: Int

  Histogram:
    fields:
      red: String
      green: String
      blue: String
      luminance: String

  VisualMetrics:
    fields:
      comparisons_total: Int
      matches: Int
      mismatches: Int
      avg_diff_percentage: Float
      avg_compare_time_ms: Float

behaviors:
  - name: compare_images
    given: Two images
    when: Comparison requested
    then: Diff result returned

  - name: compute_diff
    given: Baseline and actual images
    when: Diff computed
    then: Diff image generated

  - name: find_diff_regions
    given: Diff image
    when: Region detection
    then: Diff regions identified

  - name: calculate_similarity
    given: Two images
    when: Similarity calculated
    then: Similarity score returned

  - name: create_baseline
    given: Screenshot image
    when: Baseline creation
    then: Baseline stored

  - name: update_baseline
    given: New image and baseline ID
    when: Update requested
    then: Baseline updated

  - name: delete_baseline
    given: Baseline ID
    when: Deletion requested
    then: Baseline removed

  - name: get_baseline
    given: Baseline ID
    when: Retrieval requested
    then: Baseline image returned

  - name: list_baselines
    given: Filter criteria
    when: List requested
    then: Matching baselines returned

  - name: run_visual_test
    given: Test configuration
    when: Test executed
    then: Test result returned

  - name: generate_report
    given: Test results
    when: Report requested
    then: Visual report generated

  - name: compute_hash
    given: Image data
    when: Hash computed
    then: Perceptual hash returned

  - name: compute_histogram
    given: Image data
    when: Histogram computed
    then: Color histogram returned

  - name: apply_ignore_mask
    given: Image and mask regions
    when: Mask applied
    then: Masked image returned

  - name: get_metrics
    given: Comparison history
    when: Metrics requested
    then: Visual metrics returned

test_cases:
  - name: test_compare_identical
    input: { image1: "same", image2: "same" }
    expected: { match: true, diff_percentage: 0.0 }

  - name: test_compare_different
    input: { image1: "a", image2: "b" }
    expected: { match: false }

  - name: test_create_baseline
    input: { name: "homepage", image: "data" }
    expected: { created: true }

  - name: test_compute_hash
    input: { image: "test_data" }
    expected: { hash_length: 64 }

  - name: test_find_regions
    input: { diff_image: "diff_data" }
    expected: { regions_found: true }

  - name: test_similarity
    input: { image1: "a", image2: "a" }
    expected: { similarity: 1.0 }

  - name: test_histogram
    input: { image: "test" }
    expected: { has_data: true }

  - name: test_metrics
    input: {}
    expected: { comparisons_total: 0 }
