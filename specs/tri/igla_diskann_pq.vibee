# iGLA DiskANN PQ
# Product Quantization for DiskANN
# Scientific basis: Jayaram Subramanya et al. 2019
# φ² + 1/φ² = 3 | V = n × 3^k × π^m × φ^p

name: igla_diskann_pq
version: "1.0.0"
language: zig
module: igla_diskann_pq

sacred_constants:
  phi: 1.618033988749895
  trinity: 3.0
  phoenix: 999
  default_M: 32
  default_nbits: 8

scientific_references:
  - "Jayaram Subramanya et al. 2019: DiskANN"
  - "Jégou et al. 2011: Product Quantization"

types:
  DiskPQConfig:
    fields:
      M: Int
      nbits: Int
      dim: Int
      use_opq: Bool

  DiskCodebook:
    fields:
      centroids: String
      subspace_dim: Int
      num_centroids: Int

  CompressedVector:
    fields:
      codes: String
      original_norm: Float

  PQDistanceTable:
    fields:
      tables: String
      M: Int

  DiskPQStats:
    fields:
      compression_ratio: Float
      distortion: Float
      codebook_size_mb: Float

  OPQRotation:
    fields:
      rotation_matrix: String
      dim: Int

behaviors:
  - name: train_disk_pq
    given: "Sample vectors, config"
    when: "Training"
    then: "Trained codebooks"

  - name: encode_for_disk
    given: "Vector, codebooks"
    when: "Encoding"
    then: "Compressed code"

  - name: compute_distance_tables
    given: "Query, codebooks"
    when: "Table computation"
    then: "Distance lookup tables"

  - name: asymmetric_distance
    given: "Query, PQ code, tables"
    when: "ADC"
    then: "Approximate distance"

  - name: train_opq
    given: "Vectors"
    when: "OPQ training"
    then: "Rotation matrix"

  - name: apply_rotation
    given: "Vector, rotation"
    when: "OPQ rotation"
    then: "Rotated vector"

  - name: save_codebooks
    given: "Codebooks, path"
    when: "Persistence"
    then: "Codebooks saved"

  - name: phi_subspace_allocation
    given: "Dimension"
    when: "Sacred allocation"
    then: "φ-ratio subspaces"
