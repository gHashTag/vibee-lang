# IGLA Experience Memory
# Episodic memory for storing and retrieving past experiences
# φ² + 1/φ² = 3 | PHOENIX = 999

name: igla_experience_memory
version: "1.0.0"
language: zig
module: igla_experience_memory

sacred_constants:
  phi: 1.618033988749895
  phoenix: 999
  trinity: 3

creation_pattern:
  source: Experience
  transformer: MemoryStore
  result: RetrievedExperience

types:
  ExperienceType:
    enum:
      - Success
      - Failure
      - PartialSuccess
      - Reflection

  Experience:
    fields:
      id: String
      instance_id: String
      experience_type: String
      problem: String
      solution: String
      reflection: String
      score: Float
      timestamp: Timestamp
      tags: List<String>

  MemoryConfig:
    fields:
      max_size: Int
      similarity_threshold: Float
      decay_rate: Float
      retrieval_count: Int

  SimilarityResult:
    fields:
      experience_id: String
      similarity_score: Float
      relevance_score: Float

  RetrievedExperience:
    fields:
      experiences: List<Experience>
      query: String
      retrieval_method: String

  MemoryStats:
    fields:
      total_experiences: Int
      success_count: Int
      failure_count: Int
      avg_score: Float
      most_common_tags: List<String>

  ExperienceEmbedding:
    fields:
      experience_id: String
      vector: List<Float>
      dimension: Int

behaviors:
  - name: store_experience
    given: "Experience"
    when: "Storage requested"
    then: "Stores experience and returns ID"

  - name: retrieve_similar
    given: "Query problem and config"
    when: "Similar retrieval requested"
    then: "Returns RetrievedExperience"

  - name: retrieve_by_tags
    given: "List of tags"
    when: "Tag-based retrieval requested"
    then: "Returns matching experiences"

  - name: retrieve_successes
    given: "Problem description"
    when: "Success retrieval requested"
    then: "Returns successful experiences for similar problems"

  - name: retrieve_failures
    given: "Problem description"
    when: "Failure retrieval requested"
    then: "Returns failed experiences to avoid"

  - name: calculate_similarity
    given: "Two experiences"
    when: "Similarity calculation requested"
    then: "Returns similarity score 0.0-1.0"

  - name: apply_decay
    given: "Memory and time delta"
    when: "Decay application requested"
    then: "Reduces scores of old experiences"

  - name: prune_memory
    given: "Memory and max_size"
    when: "Pruning requested"
    then: "Removes lowest-scored experiences"

  - name: get_stats
    given: "Memory"
    when: "Stats requested"
    then: "Returns MemoryStats"

  - name: export_memory
    given: "Memory"
    when: "Export requested"
    then: "Returns JSON string"

  - name: import_memory
    given: "JSON string"
    when: "Import requested"
    then: "Loads experiences into memory"

  - name: create_embedding
    given: "Experience"
    when: "Embedding creation requested"
    then: "Returns ExperienceEmbedding"

  - name: semantic_search
    given: "Query embedding and memory"
    when: "Semantic search requested"
    then: "Returns top-k similar experiences"

test_cases:
  - name: test_store_experience
    input:
      problem: "Fix bug in validator"
      solution: "diff --git"
    expected:
      stored: true

  - name: test_retrieve_similar
    input:
      query: "validator issue"
    expected:
      retrieved: true

  - name: test_retrieve_by_tags
    input:
      tags: ["django", "validator"]
    expected:
      matched: true

  - name: test_similarity_calculation
    input:
      exp1: "Fix validator"
      exp2: "Fix validation"
    expected:
      similarity_high: true

  - name: test_memory_pruning
    input:
      max_size: 100
      current_size: 150
    expected:
      pruned: true

  - name: test_export_import
    input:
      experiences: 10
    expected:
      roundtrip_success: true
