# VIBEE BitNet Benchmark Comparison Specification
# Священная Формула: V = n × 3^k × π^m × φ^p × e^q
# Золотое Тождество: φ² + 1/φ² = 3 | PHOENIX = 999

name: benchmark_comparison
version: "1.0.0"
language: python
module: comparison

description: |
  Модуль сравнения результатов бенчмарков BitNet.
  Определяет регрессии и улучшения производительности.

# ═══════════════════════════════════════════════════════════════════════════════
# Типы данных
# ═══════════════════════════════════════════════════════════════════════════════

types:
  ComparisonResult:
    description: "Результат сравнения двух метрик"
    fields:
      metric_name: String
      baseline_value: Float
      current_value: Float
      absolute_diff: Float
      percent_diff: Float
      status: ComparisonStatus

  ComparisonStatus:
    description: "Статус сравнения"
    enum:
      - improved      # Улучшение (зелёный)
      - regression    # Регрессия (красный)
      - unchanged     # Без изменений (серый)
      - new           # Новая метрика
      - removed       # Удалённая метрика

  RegressionReport:
    description: "Отчёт о регрессиях"
    fields:
      baseline_timestamp: String
      current_timestamp: String
      total_metrics: Int
      improved_count: Int
      regression_count: Int
      unchanged_count: Int
      comparisons: List<ComparisonResult>

  ThresholdConfig:
    description: "Пороги для определения регрессий"
    fields:
      latency_threshold_percent: Float    # default: 5%
      throughput_threshold_percent: Float # default: 5%
      memory_threshold_percent: Float     # default: 10%

# ═══════════════════════════════════════════════════════════════════════════════
# Поведения
# ═══════════════════════════════════════════════════════════════════════════════

behaviors:
  # --- Загрузка ---
  - name: load_baseline
    given: Путь к JSON файлу с baseline результатами
    when: Вызов load_baseline(path)
    then: BenchmarkSuite загружен из файла

  - name: load_current
    given: Путь к JSON файлу с текущими результатами
    when: Вызов load_current(path)
    then: BenchmarkSuite загружен из файла

  # --- Сравнение ---
  - name: compare_metrics
    given: Две метрики (baseline, current)
    when: Вызов compare_metrics(baseline, current)
    then: ComparisonResult с diff и status

  - name: compare_results
    given: Два BenchmarkResult
    when: Вызов compare_results(baseline, current)
    then: Список ComparisonResult для всех метрик

  - name: compare_suites
    given: Два BenchmarkSuite
    when: Вызов compare_suites(baseline, current)
    then: RegressionReport со всеми сравнениями

  # --- Regression Detection ---
  - name: detect_regression
    given: ComparisonResult и threshold
    when: percent_diff превышает threshold
    then: status = regression

  - name: detect_improvement
    given: ComparisonResult и threshold
    when: percent_diff отрицательный и превышает threshold
    then: status = improved

  # --- Отчёты ---
  - name: generate_report
    given: RegressionReport
    when: Вызов generate_report()
    then: Текстовый отчёт с таблицей сравнений

  - name: generate_markdown_report
    given: RegressionReport
    when: Вызов generate_markdown_report()
    then: Markdown отчёт для GitHub

  - name: generate_json_report
    given: RegressionReport
    when: Вызов generate_json_report()
    then: JSON отчёт для CI/CD

  # --- CI Integration ---
  - name: check_regressions
    given: RegressionReport и fail_on_regression flag
    when: Есть регрессии и fail_on_regression=True
    then: Exit code 1

  - name: save_baseline
    given: BenchmarkSuite
    when: Вызов save_baseline(path)
    then: Результаты сохранены как новый baseline

# ═══════════════════════════════════════════════════════════════════════════════
# Пороги по умолчанию
# ═══════════════════════════════════════════════════════════════════════════════

defaults:
  thresholds:
    latency_mean: 5.0       # 5% regression threshold
    latency_p95: 10.0       # 10% for tail latency
    latency_p99: 15.0       # 15% for worst case
    throughput: 5.0         # 5% throughput drop
    memory_bandwidth: 10.0  # 10% bandwidth drop

# ═══════════════════════════════════════════════════════════════════════════════
# Метаданные
# ═══════════════════════════════════════════════════════════════════════════════

metadata:
  author: "VIBEE Project"
  created: "2025-01-25"
