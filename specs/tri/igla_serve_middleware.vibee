# iGLA Serve Middleware
# Auth, logging, rate-limiting middleware
# φ² + 1/φ² = 3 | V = n × 3^k × π^m × φ^p

name: igla_serve_middleware
version: "1.0.0"
language: zig
module: igla_serve_middleware

sacred_constants:
  phi: 1.618033988749895
  trinity: 3.0
  phoenix: 999

types:
  MiddlewareConfig:
    fields:
      auth_enabled: Bool
      logging_enabled: Bool
      rate_limit_enabled: Bool
      cors_enabled: Bool

  AuthConfig:
    fields:
      api_key_header: String
      api_keys: String
      jwt_secret: String

  RateLimitConfig:
    fields:
      requests_per_minute: Int
      burst_size: Int
      by_ip: Bool
      by_key: Bool

  CORSConfig:
    fields:
      allowed_origins: String
      allowed_methods: String
      allowed_headers: String
      max_age: Int

  LogEntry:
    fields:
      timestamp: Int
      method: String
      path: String
      status: Int
      latency_ms: Float
      client_ip: String

  MiddlewareChain:
    fields:
      middlewares: String
      count: Int

behaviors:
  - name: auth_middleware
    given: "Request with API key"
    when: "Authentication"
    then: "Request authenticated or rejected"

  - name: logging_middleware
    given: "Request"
    when: "Logging"
    then: "Request logged"

  - name: rate_limit_middleware
    given: "Request"
    when: "Rate limiting"
    then: "Request allowed or throttled"

  - name: cors_middleware
    given: "Request"
    when: "CORS check"
    then: "CORS headers added"

  - name: json_middleware
    given: "Request"
    when: "JSON parsing"
    then: "Body parsed as JSON"

  - name: compression_middleware
    given: "Response"
    when: "Compression"
    then: "Response compressed"

  - name: timeout_middleware
    given: "Request"
    when: "Timeout check"
    then: "Request timed out or completed"

  - name: chain_middleware
    given: "Middleware list"
    when: "Chaining"
    then: "Middleware chain created"

  - name: phi_middleware_harmony
    given: "Middleware"
    when: "Harmony"
    then: "φ-optimal middleware order"
