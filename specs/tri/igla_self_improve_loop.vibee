# IGLA Self-Improvement Loop
# Reflexion-based iterative improvement for SWE Agent
# φ² + 1/φ² = 3 | PHOENIX = 999

name: igla_self_improve_loop
version: "1.0.0"
language: zig
module: igla_self_improve_loop

sacred_constants:
  phi: 1.618033988749895
  phoenix: 999
  trinity: 3

creation_pattern:
  source: FailedAttempt
  transformer: ReflexionLoop
  result: ImprovedAttempt

types:
  ImprovementStrategy:
    enum:
      - Reflexion
      - SelfRefine
      - IterativeRefinement
      - GeneticMutation

  LoopConfig:
    fields:
      max_iterations: Int
      improvement_threshold: Float
      strategy: String
      memory_size: Int
      early_stop: Bool

  Attempt:
    fields:
      iteration: Int
      patch: String
      test_result: Bool
      error_message: String
      reflection: String
      score: Float

  ReflexionMemory:
    fields:
      attempts: List<Attempt>
      best_attempt: Attempt
      total_iterations: Int
      improvement_history: List<Float>

  ImprovementResult:
    fields:
      success: Bool
      final_patch: String
      iterations_used: Int
      improvement_delta: Float
      reflections: List<String>

  LoopState:
    fields:
      current_iteration: Int
      best_score: Float
      should_continue: Bool
      reason: String

behaviors:
  - name: create_config
    given: "Strategy and parameters"
    when: "Config creation requested"
    then: "Returns LoopConfig with defaults"

  - name: initialize_loop
    given: "Initial attempt and config"
    when: "Loop initialization requested"
    then: "Returns initialized ReflexionMemory"

  - name: run_iteration
    given: "Current state and memory"
    when: "Single iteration requested"
    then: "Returns new Attempt with reflection"

  - name: generate_reflection
    given: "Failed attempt"
    when: "Reflection generation requested"
    then: "Returns verbal reflection on failure"

  - name: apply_reflection
    given: "Reflection and previous patch"
    when: "Improvement requested"
    then: "Returns improved patch"

  - name: evaluate_attempt
    given: "Attempt"
    when: "Evaluation requested"
    then: "Returns score 0.0-1.0"

  - name: should_continue
    given: "LoopState and config"
    when: "Continuation check requested"
    then: "Returns true if should continue iterating"

  - name: select_best
    given: "ReflexionMemory"
    when: "Best selection requested"
    then: "Returns best attempt from memory"

  - name: run_full_loop
    given: "Initial problem and config"
    when: "Full improvement loop requested"
    then: "Returns ImprovementResult"

  - name: calculate_improvement
    given: "Previous score and current score"
    when: "Improvement calculation requested"
    then: "Returns improvement delta"

  - name: early_stop_check
    given: "Improvement history"
    when: "Early stop check requested"
    then: "Returns true if no improvement for N iterations"

  - name: merge_reflections
    given: "List of reflections"
    when: "Merge requested"
    then: "Returns consolidated reflection"

test_cases:
  - name: test_config_creation
    input:
      strategy: "Reflexion"
      max_iterations: 5
    expected:
      valid: true

  - name: test_loop_initialization
    input:
      initial_patch: "diff --git"
    expected:
      initialized: true

  - name: test_reflection_generation
    input:
      error: "Test failed: assertion error"
    expected:
      reflection_generated: true

  - name: test_improvement_application
    input:
      reflection: "Need to handle edge case"
    expected:
      patch_improved: true

  - name: test_early_stop
    input:
      no_improvement_count: 3
    expected:
      should_stop: true

  - name: test_full_loop
    input:
      max_iterations: 3
    expected:
      completed: true
