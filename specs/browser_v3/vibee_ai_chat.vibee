# VIBEE AI Chat v1.1.0
# AI chat panel with streaming

name: vibee_ai_chat
version: "1.1.0"
language: zig
module: vibee_ai_chat

types:
  ChatMessage:
    fields:
      id: String
      role: String
      content: String
      timestamp: Timestamp
      tokens: Option<Int>

  Conversation:
    fields:
      id: String
      messages: List<ChatMessage>
      model: String
      total_tokens: Int

  StreamChunk:
    fields:
      content: String
      done: Bool
      finish_reason: Option<String>

  ChatContext:
    fields:
      page_url: Option<String>
      page_content: Option<String>
      selected_code: Option<String>
      editor_file: Option<String>

  ChatCommand:
    fields:
      name: String
      description: String
      pattern: String

behaviors:
  - name: send_message
    given: "User message"
    when: "Send"
    then: "Get AI response"

  - name: stream_response
    given: "Message"
    when: "Stream"
    then: "Yield response chunks"

  - name: add_context
    given: "Context type"
    when: "Add"
    then: "Include in next message"

  - name: get_page_context
    given: "Browser view"
    when: "Extract"
    then: "Return page content"

  - name: get_code_context
    given: "Editor"
    when: "Extract"
    then: "Return selected code"

  - name: parse_command
    given: "Message text"
    when: "Parse"
    then: "Extract command if present"

  - name: execute_command
    given: "Command"
    when: "Execute"
    then: "Run browser action"

  - name: clear_conversation
    given: "Conversation"
    when: "Clear"
    then: "Reset messages"

  - name: export_conversation
    given: "Conversation"
    when: "Export"
    then: "Return markdown"

  - name: render_message
    given: "Message"
    when: "Render"
    then: "Return HTML with markdown"

  - name: scroll_to_bottom
    given: "Chat container"
    when: "Scroll"
    then: "Show latest message"

test_cases:
  - name: test_send_message
    input: { message: "Hello" }
    expected: { response_received: true }

  - name: test_streaming
    input: { message: "Write code" }
    expected: { chunks_received: true }

  - name: test_context_page
    input: { url: "https://example.com" }
    expected: { context_added: true }

  - name: test_context_code
    input: { code: "const x = 1" }
    expected: { context_added: true }

  - name: test_command_parse
    input: { text: "/click #button" }
    expected: { command: "click" }

  - name: test_markdown_render
    input: { text: "**bold**" }
    expected: { html_contains: "<strong>" }
