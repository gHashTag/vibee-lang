# ═══════════════════════════════════════════════════════════════════════════════
# ANTIPATTERN DETECTOR v28 - INCREMENTAL ANALYSIS
# ═══════════════════════════════════════════════════════════════════════════════
# PAS PATTERNS: INC, HSH, D&C
# CONFIDENCE: 92%
# SPEEDUP: 10x with incremental
# ═══════════════════════════════════════════════════════════════════════════════

name: antipattern_detector_v28
version: "28.0.0"
language: zig
module: antipattern_detector

sacred_constants:
  phi: 1.618033988749895
  forbidden_extensions: [".html", ".css", ".js", ".ts", ".jsx", ".tsx"]
  allowed_html: "runtime/runtime.html"

creation_pattern:
  source: Codebase
  transformer: AntipatternDetector
  result: ViolationReport

pas_analysis:
  current_complexity: "O(f) files"
  theoretical_lower: "Ω(Δf) changed files"
  gap: "f/Δf×"
  patterns:
    - name: INC
      application: "Incremental analysis"
      confidence: 0.92
      speedup: "10x"
    - name: HSH
      application: "O(1) extension lookup"
      confidence: 0.95
      speedup: "10x"
    - name: D_and_C
      application: "Parallel directory scan"
      confidence: 0.90
      speedup: "4x"

antipatterns:
  architecture:
    - id: AP001
      name: "Direct Zig Creation"
      severity: CRITICAL
      description: "Creating .zig without .vibee spec"
      
    - id: AP002
      name: "Legacy Web Files"
      severity: CRITICAL
      description: "Creating .html/.css/.js files"
      
    - id: AP003
      name: "Spec-less Implementation"
      severity: HIGH
      description: "Implementation without specification"
      
  optimization:
    - id: AP010
      name: "No Quickening"
      severity: HIGH
      description: "Interpreter without quickening"
      
    - id: AP011
      name: "No Inline Cache"
      severity: HIGH
      description: "Missing inline caching"
      
    - id: AP012
      name: "No BBV"
      severity: MEDIUM
      description: "Missing basic block versioning"
      
  gc:
    - id: AP020
      name: "No Generational GC"
      severity: HIGH
      description: "Missing generational collection"
      
    - id: AP021
      name: "No Immix"
      severity: MEDIUM
      description: "Missing Immix collector"
      
  testing:
    - id: AP030
      name: "No Test Cases"
      severity: MEDIUM
      description: "Behavior without test cases"
      
    - id: AP031
      name: "Low Coverage"
      severity: LOW
      description: "Test coverage below 80%"

structures:
  Violation:
    fields:
      - name: id
        type: "[]const u8"
      - name: file
        type: "[]const u8"
      - name: line
        type: usize
      - name: severity
        type: Severity
      - name: message
        type: "[]const u8"
        
  Severity:
    type: enum
    values: [CRITICAL, HIGH, MEDIUM, LOW]
    
  FileHash:
    fields:
      - name: path
        type: "[]const u8"
      - name: hash
        type: u64
      - name: last_analyzed
        type: i64
        
  IncrementalDetector:
    fields:
      - name: file_hashes
        type: "std.AutoHashMap([]const u8, FileHash)"
      - name: cached_results
        type: "std.AutoHashMap(u64, []Violation)"
      - name: forbidden_set
        type: "std.AutoHashMap([]const u8, void)"
    methods:
      - name: init
        returns: IncrementalDetector
      - name: analyze
        params: ["path: []const u8"]
        returns: "[]Violation"
        complexity: "O(1) cached, O(n) uncached"
      - name: analyzeIncremental
        params: ["root: []const u8"]
        returns: "[]Violation"
        complexity: "O(Δf)"
      - name: isForbidden
        params: ["ext: []const u8"]
        returns: bool
        complexity: "O(1)"
        
  ParallelScanner:
    fields:
      - name: thread_pool
        type: "*std.Thread.Pool"
      - name: detector
        type: "*IncrementalDetector"
    methods:
      - name: scanParallel
        params: ["root: []const u8"]
        returns: "[]Violation"
        complexity: "O(f/p)"

behaviors:
  - name: forbidden_extension_check
    given: "File with .js extension"
    when: "isForbidden called"
    then: "Returns true in O(1)"
    test_cases:
      - name: check_js
        input:
          extension: ".js"
        expected:
          forbidden: true
          
  - name: incremental_analysis
    given: "File unchanged since last analysis"
    when: "analyze called"
    then: "Cached result returned in O(1)"
    test_cases:
      - name: cached_analysis
        input:
          file_changed: false
        expected:
          cache_hit: true
          
  - name: parallel_scan
    given: "Directory with 1000 files"
    when: "scanParallel called with 4 threads"
    then: "4x speedup achieved"
    test_cases:
      - name: parallel_1000
        input:
          files: 1000
          threads: 4
        expected:
          speedup: 4.0
          
  - name: violation_detection
    given: "File creating .html"
    when: "analyze called"
    then: "AP002 violation reported"
    test_cases:
      - name: detect_html
        input:
          file: "test.html"
        expected:
          violation_id: "AP002"
          severity: "CRITICAL"

codegen:
  targets:
    - format: zig
      output: "generated/antipattern_detector_v28.zig"
    - format: 999
      output: "generated/antipattern_detector_v28.999"
