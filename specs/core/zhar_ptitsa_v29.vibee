# ═══════════════════════════════════════════════════════════════════════════════
# ЖАР-ПТИЦА v29 - REAL FITNESS FUNCTIONS
# ═══════════════════════════════════════════════════════════════════════════════
# v28: Random byte evolution
# v29: Real fitness functions, code optimization targets
# 999 = 3³ × 37 = PHOENIX GENERATIONS
# ═══════════════════════════════════════════════════════════════════════════════

name: zhar_ptitsa_v29
version: "29.0.0"
language: zig
module: zhar_ptitsa

sacred_constants:
  phi: 1.618033988749895
  phoenix_generations: 999
  mutation_rate: 0.0382
  crossover_rate: 0.0618
  elitism: 0.333

creation_pattern:
  source: Population
  transformer: ZharPtitsaV29
  result: OptimizedSolution

# ═══════════════════════════════════════════════════════════════════════════════
# REAL FITNESS FUNCTIONS
# ═══════════════════════════════════════════════════════════════════════════════

fitness_functions:
  minimize_code_size:
    description: "Fitness = 1 / code_size"
    target: "Smaller code"
    
  maximize_speed:
    description: "Fitness = 1 / execution_time"
    target: "Faster execution"
    
  balance_size_speed:
    description: "Fitness = φ/size + 1/time"
    target: "Golden ratio balance"
    
  symbolic_regression:
    description: "Fitness = 1 / (1 + MSE)"
    target: "Function approximation"

structures:
  RealFitness:
    fields:
      - name: fitness_type
        type: FitnessType
      - name: target_value
        type: f64
    methods:
      - name: evaluate
        params: ["genome: *Genome"]
        returns: f64
        description: "Real fitness evaluation"
        
  FitnessType:
    type: enum
    values:
      - MINIMIZE_SIZE
      - MAXIMIZE_SPEED
      - BALANCE
      - SYMBOLIC
      
  CodeGenome:
    fields:
      - name: instructions
        type: "[32]Instruction"
      - name: length
        type: usize
      - name: fitness
        type: f64
    methods:
      - name: execute
        params: ["input: f64"]
        returns: f64
      - name: size
        returns: usize
      - name: mutate
        params: ["rate: f64", "rng: *Random"]
        returns: void
        
  Instruction:
    fields:
      - name: opcode
        type: OpCode
      - name: operand
        type: f64
        
  OpCode:
    type: enum
    values: [ADD, SUB, MUL, DIV, CONST, INPUT, SQRT, SIN, COS]
    
  SymbolicEvolver:
    fields:
      - name: population
        type: "[64]CodeGenome"
      - name: target_fn
        type: "*const fn(f64) f64"
      - name: best
        type: CodeGenome
      - name: generation
        type: u64
    methods:
      - name: evolve
        params: ["generations: u64"]
        returns: "*CodeGenome"
      - name: evaluateFitness
        params: ["genome: *CodeGenome"]
        returns: f64

behaviors:
  - name: symbolic_regression
    given: "Target function f(x) = x²"
    when: "Evolve for 100 generations"
    then: "Best genome approximates x²"
    test_cases:
      - name: evolve_square
        input:
          target: "x^2"
          generations: 100
        expected:
          mse_below: 0.1
          
  - name: code_size_minimization
    given: "Population of code genomes"
    when: "Evolve with MINIMIZE_SIZE fitness"
    then: "Average size decreases"
    test_cases:
      - name: minimize_test
        input:
          initial_avg_size: 20
        expected:
          final_avg_size_below: 15
          
  - name: fitness_caching
    given: "Same genome evaluated twice"
    when: "Second evaluation"
    then: "Cache hit, O(1) return"
    test_cases:
      - name: cache_test
        input: {}
        expected:
          cache_hit: true

codegen:
  targets:
    - format: zig
      output: "generated/zhar_ptitsa_v29.zig"
