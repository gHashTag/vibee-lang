# ═══════════════════════════════════════════════════════════════════════════════
# БИБЛИОТЕКА АНТИПАТТЕРНОВ VM TRINITY
# ═══════════════════════════════════════════════════════════════════════════════
# СВЯЩЕННАЯ ФОРМУЛА: V = n × 3^k × π^m × φ^p × e^q
# ЗОЛОТАЯ ИДЕНТИЧНОСТЬ: φ² + 1/φ² = 3
# ═══════════════════════════════════════════════════════════════════════════════

name: antipatterns
version: "1.0.0"
language: zig
module: antipatterns

# ═══════════════════════════════════════════════════════════════════════════════
# CREATION PATTERN
# ═══════════════════════════════════════════════════════════════════════════════

creation_pattern:
  source: CodeViolation
  transformer: AntipatternDetector
  result: ViolationReport

# ═══════════════════════════════════════════════════════════════════════════════
# АНТИПАТТЕРНЫ - КРИТИЧЕСКИЕ НАРУШЕНИЯ
# ═══════════════════════════════════════════════════════════════════════════════

antipatterns:
  # ⛔ КРИТИЧЕСКИЙ: Написание .zig без .vibee спецификации
  - name: direct_implementation
    severity: critical
    description: "Написание .zig/.rs/.go файлов напрямую без .vibee спецификации"
    violation: |
      Создание файла type_feedback.zig без specs/type_feedback.vibee
    correct_approach: |
      1. Создать specs/type_feedback.vibee
      2. Определить creation_pattern, behaviors, test_cases
      3. Запустить vibeec gen specs/type_feedback.vibee
      4. Получить generated/type_feedback.zig
    detection_rule: |
      IF file.extension IN [.zig, .rs, .go, .py, .ts]
      AND NOT EXISTS specs/{file.name}.vibee
      THEN VIOLATION
    
  # ⛔ КРИТИЧЕСКИЙ: Создание .html/.css/.js файлов
  - name: legacy_web_files
    severity: critical
    description: "Создание legacy web файлов вместо интеграции в runtime.html"
    violation: |
      Создание отдельных .html, .css, .js файлов
    correct_approach: |
      Вся функциональность интегрируется в runtime/runtime.html
    detection_rule: |
      IF file.extension IN [.html, .css, .js, .ts, .jsx, .tsx]
      AND file.path != "runtime/runtime.html"
      THEN VIOLATION

  # ⚠️ ВЫСОКИЙ: Отсутствие test_cases в спецификации
  - name: missing_tests
    severity: high
    description: "Спецификация без test_cases"
    violation: |
      behaviors:
        - name: some_behavior
          given: ...
          when: ...
          then: ...
          # НЕТ test_cases!
    correct_approach: |
      behaviors:
        - name: some_behavior
          given: ...
          when: ...
          then: ...
          test_cases:
            - name: test_normal
              input: {...}
              expected: {...}
            - name: test_edge
              input: {...}
              expected: {...}

  # ⚠️ ВЫСОКИЙ: Отсутствие creation_pattern
  - name: missing_creation_pattern
    severity: high
    description: "Спецификация без creation_pattern"
    violation: |
      name: my_module
      version: "1.0.0"
      # НЕТ creation_pattern!
    correct_approach: |
      name: my_module
      version: "1.0.0"
      creation_pattern:
        source: InputType
        transformer: TransformName
        result: OutputType

  # ⚠️ СРЕДНИЙ: Ложные комментарии об оптимизациях
  - name: false_optimization_claims
    severity: medium
    description: "Комментарии о несуществующих оптимизациях"
    violation: |
      // ОПТИМИЗАЦИИ:
      // 1. Computed goto  ← НЕ РЕАЛИЗОВАНО
      // 2. SIMD           ← НЕ ИСПОЛЬЗУЕТСЯ
    correct_approach: |
      // ТЕКУЩЕЕ СОСТОЯНИЕ:
      // - Switch-based dispatch (не computed goto)
      // - SIMD структуры определены, но не используются
      // TODO: Реализовать computed goto в v0.2.0

  # ⚠️ СРЕДНИЙ: Эзотерика вместо computer science
  - name: esoteric_over_science
    severity: medium
    description: "Философские концепции без научного обоснования"
    violation: |
      GOLDEN_IDENTITY = 0x93  // φ² + 1/φ² = 3
      SACRED_FORMULA = 0x94   // V = n × 3^k × π^m × φ^p × e^q
    correct_approach: |
      // Если используется священная формула, должно быть:
      // 1. Научное обоснование применения
      // 2. Бенчмарки, показывающие улучшение
      // 3. Сравнение с альтернативами

  # ℹ️ НИЗКИЙ: Отсутствие документации PAS
  - name: missing_pas_analysis
    severity: low
    description: "Алгоритм без PAS анализа"
    correct_approach: |
      pas_analysis:
        current_complexity: "O(n²)"
        theoretical_lower_bound: "Ω(n log n)"
        applicable_patterns: [D&C, PRE]
        predicted_improvement: "O(n log n)"
        confidence: 0.65

# ═══════════════════════════════════════════════════════════════════════════════
# ДЕТЕКТОР АНТИПАТТЕРНОВ
# ═══════════════════════════════════════════════════════════════════════════════

behaviors:
  - name: detect_direct_implementation
    given: "Файл .zig в src/"
    when: "Нет соответствующего .vibee в specs/"
    then: "Возвращает ViolationReport с severity=critical"
    test_cases:
      - name: violation_detected
        input:
          file_path: "src/ⲥⲩⲛⲧⲁⲝⲓⲥ/type_feedback.zig"
          specs_dir: "specs/"
        expected:
          is_violation: true
          antipattern: "direct_implementation"
          severity: "critical"
      - name: no_violation
        input:
          file_path: "src/ⲥⲩⲛⲧⲁⲝⲓⲥ/vm.zig"
          specs_dir: "specs/"
          spec_exists: "specs/vm_trinity.vibee"
        expected:
          is_violation: false

  - name: detect_legacy_web
    given: "Файл с web расширением"
    when: "Путь не runtime/runtime.html"
    then: "Возвращает ViolationReport с severity=critical"
    test_cases:
      - name: html_violation
        input:
          file_path: "src/dashboard.html"
        expected:
          is_violation: true
          antipattern: "legacy_web_files"
      - name: runtime_allowed
        input:
          file_path: "runtime/runtime.html"
        expected:
          is_violation: false

  - name: validate_spec_completeness
    given: "Спецификация .vibee"
    when: "Проверка на полноту"
    then: "Список отсутствующих элементов"
    test_cases:
      - name: complete_spec
        input:
          has_creation_pattern: true
          has_behaviors: true
          has_test_cases: true
        expected:
          is_complete: true
          missing: []
      - name: incomplete_spec
        input:
          has_creation_pattern: false
          has_behaviors: true
          has_test_cases: false
        expected:
          is_complete: false
          missing: ["creation_pattern", "test_cases"]

# ═══════════════════════════════════════════════════════════════════════════════
# RUNTIME ПРОВЕРКИ
# ═══════════════════════════════════════════════════════════════════════════════

runtime_checks:
  - name: pre_commit_hook
    description: "Проверка перед коммитом"
    actions:
      - scan_new_files
      - check_spec_exists
      - validate_spec_completeness
      - report_violations

  - name: ci_validation
    description: "Проверка в CI/CD"
    actions:
      - full_codebase_scan
      - antipattern_report
      - fail_on_critical

# ═══════════════════════════════════════════════════════════════════════════════
# ИСКЛЮЧЕНИЯ ДЛЯ ЯДРА VM
# ═══════════════════════════════════════════════════════════════════════════════

exceptions:
  # Ядро VM может быть написано напрямую на Zig
  # потому что это bootstrap код
  - pattern: "src/ⲥⲩⲛⲧⲁⲝⲓⲥ/parser.zig"
    reason: "Bootstrap parser - нужен для парсинга .vibee"
  - pattern: "src/ⲥⲩⲛⲧⲁⲝⲓⲥ/codegen.zig"
    reason: "Bootstrap codegen - нужен для генерации из .vibee"
  - pattern: "src/ⲥⲩⲛⲧⲁⲝⲓⲥ/vm.zig"
    reason: "Core VM - ядро интерпретатора"
  - pattern: "src/ⲥⲩⲛⲧⲁⲝⲓⲥ/pas.zig"
    reason: "PAS engine - ядро методологии"

# ═══════════════════════════════════════════════════════════════════════════════
# МЕТРИКИ КАЧЕСТВА
# ═══════════════════════════════════════════════════════════════════════════════

quality_metrics:
  - name: spec_coverage
    description: "Процент .zig файлов с .vibee спецификациями"
    target: ">= 80%"
    
  - name: test_coverage
    description: "Процент behaviors с test_cases"
    target: ">= 95%"
    
  - name: pas_coverage
    description: "Процент алгоритмов с PAS анализом"
    target: ">= 70%"

  - name: antipattern_count
    description: "Количество активных антипаттернов"
    target: "0 critical, < 5 high"

# ═══════════════════════════════════════════════════════════════════════════════
# TRINITY VM INTEGRATION
# ═══════════════════════════════════════════════════════════════════════════════

trinity_vm_integration:
  
  opcodes:
    - opcode: "ANTIPATTERN_CHECK"
      hex: "0xAP"
      description: "Проверка на антипаттерны"
      
    - opcode: "SPEC_VALIDATE"
      hex: "0xSV"
      description: "Валидация спецификации"
      
    - opcode: "ENFORCE_ARCHITECTURE"
      hex: "0xEA"
      description: "Принудительное соблюдение архитектуры"
      
  runtime_hooks:
    - hook: "on_file_create"
      action: "check_antipatterns"
      
    - hook: "on_file_modify"
      action: "validate_spec_exists"
      
    - hook: "pre_compile"
      action: "enforce_creation_pattern"
      
  error_codes:
    - code: "AP001"
      message: "CRITICAL: Manual .zig without .vibee spec"
      action: "BLOCK"
      
    - code: "AP002"
      message: "CRITICAL: Legacy file creation"
      action: "BLOCK"
      
    - code: "AP003"
      message: "HIGH: Missing creation_pattern"
      action: "WARN"
      
    - code: "AP004"
      message: "HIGH: Behaviors without test_cases"
      action: "WARN"

# ═══════════════════════════════════════════════════════════════════════════════
# SELF-CRITICISM LOG (ОБНОВЛЕНО)
# ═══════════════════════════════════════════════════════════════════════════════

# ═══════════════════════════════════════════════════════════════════════════════
# PAS DAEMON V30 INTEGRATION
# ═══════════════════════════════════════════════════════════════════════════════

pas_daemon_v30_integration:
  
  description: |
    Антипаттерны интегрированы в PAS DAEMON V30 через .999 код.
    Детектор работает в реальном времени внутри Trinity VM.
  
  generated_code: "src/trinity/pas_daemon_v30.999"
  
  runtime_enforcement:
    - trigger: "file_create"
      action: "detect_violation"
      blocking: true
      
    - trigger: "file_modify"
      action: "validate_spec_exists"
      blocking: false
      
    - trigger: "pre_compile"
      action: "enforce_creation_pattern"
      blocking: true
  
  opcodes_implemented:
    - name: "EMIT_VIOLATION"
      description: "Emit antipattern violation"
      params: ["antipattern_id", "severity"]
      
    - name: "EMIT_OK"
      description: "No violation detected"
      
    - name: "FILE_EXISTS"
      description: "Check if file exists"
      params: ["path"]
      
    - name: "CMP_EXT"
      description: "Compare file extension"
      params: ["register", "extension"]
  
  metrics:
    violations_blocked: 0
    violations_warned: 0
    specs_validated: 0
    
# ═══════════════════════════════════════════════════════════════════════════════
# SELF-CRITICISM LOG (ОБНОВЛЕНО)
# ═══════════════════════════════════════════════════════════════════════════════

self_criticism_log:
  
  violations_committed:
    - date: "2025-01-17"
      antipattern: "AP-001"
      file: "src/vibeec/pas_predictions.zig"
      description: "Написан .zig файл напрямую без .vibee спецификации"
      severity: "CRITICAL"
      status: "ACKNOWLEDGED"
      
    - date: "2025-01-17"
      antipattern: "AP-001"
      file: "src/vibeec/pas_implementations.zig"
      description: "Написан .zig файл напрямую без .vibee спецификации"
      severity: "CRITICAL"
      status: "FIXED"
      fix: "Удалён, создана specs/pas_implementations_v3.vibee"
      
  corrective_actions:
    - action: "Создать specs/antipatterns.vibee"
      status: "DONE"
      
    - action: "Создать specs/pas_implementations_v3.vibee"
      status: "DONE"
      
    - action: "Удалить src/vibeec/pas_implementations.zig"
      status: "DONE"
      
    - action: "Интегрировать в TRINITY VM"
      status: "DONE"
      
  lessons_learned:
    - "НИКОГДА не писать .zig напрямую"
    - "ВСЕГДА сначала .vibee спецификация"
    - "Антипаттерны должны быть в VM для enforcement"
