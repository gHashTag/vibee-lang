# ═══════════════════════════════════════════════════════════════
# META-SPECIFICATION: VIBEE Compiler Structure
# Describes the complete compiler architecture
# All .zig files MUST be generated from this specification
# ═══════════════════════════════════════════════════════════════

name: compiler_structure
version: "2.0.0"
language: zig
module: vibeec

# ═══════════════════════════════════════════════════════════════
# CREATION PATTERN
# ═══════════════════════════════════════════════════════════════

creation_pattern:
  source: VibeeSpecification
  transformer: CompilerPipeline
  result: GeneratedCode

# ═══════════════════════════════════════════════════════════════
# COMPILER COMPONENTS
# ═══════════════════════════════════════════════════════════════

components:
  # ─────────────────────────────────────────────────────────────
  # FRONTEND: Parsing and Analysis
  # ─────────────────────────────────────────────────────────────
  
  - name: parser
    source: specs/999/ⲥⲩⲛⲧⲁⲝⲓⲥ/parser.vibee
    output: src/ⲥⲩⲛⲧⲁⲝⲓⲥ/parser.zig
    description: "YAML parser for .vibee specifications"
    dependencies: []
    
  - name: simd_parser
    source: specs/999/ⲥⲩⲛⲧⲁⲝⲓⲥ/simd_lexer.vibee
    output: src/ⲥⲩⲛⲧⲁⲝⲓⲥ/simd_parser.zig
    description: "SIMD-accelerated parser with threshold"
    dependencies: [parser]
    scientific_basis: "simdjson (Langdale & Lemire, 2019)"
    
  - name: parallel_parser
    source: specs/999/ⲡⲁⲣⲁⲗⲗⲏⲗ/parallel.vibee
    output: src/ⲥⲩⲛⲧⲁⲝⲓⲥ/parallel_parser.zig
    description: "Parallel file parsing with work-stealing"
    dependencies: [parser, simd_parser]
    scientific_basis: "Blumofe & Leiserson, 1999"
    
  - name: incremental_types
    source: specs/999/ⲥⲩⲛⲧⲁⲝⲓⲥ/tipy.vibee
    output: src/ⲥⲩⲛⲧⲁⲝⲓⲥ/incremental_types.zig
    description: "Incremental type checking"
    dependencies: [parser]
    scientific_basis: "Salsa (Matsakis, 2018)"

  # ─────────────────────────────────────────────────────────────
  # MIDDLE-END: Optimization
  # ─────────────────────────────────────────────────────────────
  
  - name: egraph
    source: specs/999/ⲟⲡⲧⲓⲙⲁⲗ/superopt.vibee
    output: src/ⲥⲩⲛⲧⲁⲝⲓⲥ/egraph.zig
    description: "E-graph based optimization"
    dependencies: [parser]
    scientific_basis: "egg (Willsey et al., 2021)"
    
  - name: pas
    source: specs/999/ⲡⲁⲥ/CONCRETE_PAS_PREDICTIONS.vibee
    output: src/ⲥⲩⲛⲧⲁⲝⲓⲥ/pas.zig
    description: "Predictive Algorithmic Systematics"
    dependencies: []

  # ─────────────────────────────────────────────────────────────
  # BACKEND: Code Generation
  # ─────────────────────────────────────────────────────────────
  
  - name: codegen
    source: specs/999/ⲅⲉⲛⲉⲣⲁⲧⲟⲣ/code_generator.vibee
    output: src/ⲥⲩⲛⲧⲁⲝⲓⲥ/codegen.zig
    description: "Multi-target code generator"
    dependencies: [parser]
    
  - name: codegen_v2
    source: specs/999/ⲅⲉⲛⲉⲣⲁⲧⲟⲣ/code_generator.vibee
    output: src/ⲥⲩⲛⲧⲁⲝⲓⲥ/codegen_v2.zig
    description: "Full code generation with stencils"
    dependencies: [parser]
    scientific_basis: "Copy-and-Patch (Xu & Kjolstad, 2021)"
    
  - name: codegen_js
    source: specs/999/ⲉⲛⲱⲥⲓⲥ/bridge.vibee
    output: src/ⲥⲩⲛⲧⲁⲝⲓⲥ/codegen_js.zig
    description: "JavaScript module generator"
    dependencies: [codegen]

  # ─────────────────────────────────────────────────────────────
  # RUNTIME: Virtual Machine
  # ─────────────────────────────────────────────────────────────
  
  - name: interpreter999
    source: specs/999/ⲣⲁⲛⲧⲁⲓⲙ/runtime.vibee
    output: src/ⲥⲩⲛⲧⲁⲝⲓⲥ/interpreter999.zig
    description: "Stack-based interpreter for .999 code"
    dependencies: []
    
  - name: register_vm
    source: specs/999/ⲣⲁⲛⲧⲁⲓⲙ/runtime.vibee
    output: src/ⲥⲩⲛⲧⲁⲝⲓⲥ/register_vm.zig
    description: "Register-based VM"
    dependencies: []
    scientific_basis: "Lua 5.0 (Ierusalimschy et al., 2005)"
    
  - name: inline_cache
    source: specs/999/ⲟⲡⲧⲓⲙⲁⲗ/mlopt.vibee
    output: src/ⲥⲩⲛⲧⲁⲝⲓⲥ/inline_cache.zig
    description: "Polymorphic inline caches"
    dependencies: [register_vm]
    scientific_basis: "Hölzle et al., 1991"

  # ─────────────────────────────────────────────────────────────
  # INFRASTRUCTURE
  # ─────────────────────────────────────────────────────────────
  
  - name: bootstrap
    source: specs/meta/compiler_structure.vibee
    output: src/ⲥⲩⲛⲧⲁⲝⲓⲥ/bootstrap.zig
    description: "Self-hosting bootstrap compiler"
    dependencies: [parser, codegen_v2]
    
  - name: ci_validation
    source: specs/meta/compiler_structure.vibee
    output: src/ⲥⲩⲛⲧⲁⲝⲓⲥ/ci_validation.zig
    description: "CI validation for .vibee sources"
    dependencies: []
    
  - name: incremental_compiler
    source: specs/999/ⲥⲩⲛⲧⲁⲝⲓⲥ/inkrement.vibee
    output: src/ⲥⲩⲛⲧⲁⲝⲓⲥ/incremental_compiler.zig
    description: "Incremental compilation"
    dependencies: [parser, codegen]
    scientific_basis: "Salsa (Matsakis, 2018)"
    
  - name: benchmark
    source: specs/999/ⲉⲣⲅⲁⲗⲉⲓⲁ/bench.vibee
    output: src/ⲥⲩⲛⲧⲁⲝⲓⲥ/benchmark.zig
    description: "Performance benchmarks"
    dependencies: [parser, simd_parser, egraph]

# ═══════════════════════════════════════════════════════════════
# BEHAVIORS
# ═══════════════════════════════════════════════════════════════

behaviors:
  - name: all_zig_from_vibee
    given: A .zig file in src/
    when: CI validation runs
    then: File has corresponding .vibee source
    
  - name: bootstrap_self_hosting
    given: Stage 0 compiler
    when: Bootstrap process completes
    then: Stage 2 compiler can compile itself
    
  - name: codegen_complete
    given: A .vibee specification
    when: CodeGen V2 runs
    then: Complete .zig with structs, functions, tests, docs
    
  - name: incremental_fast
    given: Small change to .vibee file
    when: Incremental compilation runs
    then: 10-100x faster than full compilation

# ═══════════════════════════════════════════════════════════════
# SCIENTIFIC BASIS
# ═══════════════════════════════════════════════════════════════

scientific_references:
  - name: "Copy-and-Patch Compilation"
    authors: ["Xu", "Kjolstad"]
    year: 2021
    venue: "OOPSLA"
    speedup: "100x faster than LLVM -O0"
    
  - name: "The Implementation of Lua 5.0"
    authors: ["Ierusalimschy", "de Figueiredo", "Celes"]
    year: 2005
    venue: "Journal of Universal Computer Science"
    speedup: "1.5-2x vs stack-based"
    
  - name: "Polymorphic Inline Caches"
    authors: ["Hölzle", "Chambers", "Ungar"]
    year: 1991
    venue: "ECOOP"
    speedup: "2-5x for method dispatch"
    
  - name: "Salsa: Incremental Recomputation"
    authors: ["Matsakis"]
    year: 2018
    speedup: "10-100x for small changes"
    
  - name: "simdjson"
    authors: ["Langdale", "Lemire"]
    year: 2019
    venue: "VLDB"
    speedup: "2.5 GB/s parsing"

# ═══════════════════════════════════════════════════════════════
# VALIDATION RULES
# ═══════════════════════════════════════════════════════════════

validation:
  - rule: "Every .zig file MUST have a .vibee source"
    exceptions:
      - build.zig  # Zig build system
      - main.zig   # Entry point (generated from this meta-spec)
      
  - rule: "All speedup claims MUST be measured"
    measurement: "benchmark.zig"
    
  - rule: "Scientific basis MUST be cited"
    format: "Author et al., Year"

# ═══════════════════════════════════════════════════════════════
# BUILD ORDER
# ═══════════════════════════════════════════════════════════════

build_order:
  stage0:
    - parser
    - codegen
    - main
    
  stage1:
    - parser
    - simd_parser
    - parallel_parser
    - incremental_types
    - egraph
    - codegen
    - codegen_v2
    - interpreter999
    - register_vm
    - inline_cache
    - bootstrap
    - ci_validation
    - incremental_compiler
    - benchmark
    - main
    
  stage2:
    - "Same as stage1, compiled by stage1"
