# VIBEE Screen Compositor v4.0.0
# GPU-accelerated compositor with 8ms frame target
# KOSCHEI CYCLE: ЗАЯЦ (Hare) - Speed

name: vibee_screen_compositor
version: "4.0.0"
language: zig
module: vibee_screen_compositor

constants:
  PHI: 1.6180339887498948482
  PHOENIX: 999
  TARGET_FRAME_MS: 8
  TILE_SIZE: 256
  MAX_LAYERS: 100

types:
  Compositor:
    fields:
      id: String
      width: Int
      height: Int
      device_pixel_ratio: Float
      gpu_enabled: Bool

  Layer:
    fields:
      id: String
      bounds: Object
      transform: Object
      opacity: Float
      blend_mode: String
      content: Int

  Tile:
    fields:
      x: Int
      y: Int
      width: Int
      height: Int
      dirty: Bool
      texture_id: Int

  CompositeFrame:
    fields:
      frame_id: Int
      layers: List<Int>
      damage_rects: List<Object>
      timestamp: Timestamp

  RenderStats:
    fields:
      frame_time_ms: Float
      gpu_time_ms: Float
      tiles_rendered: Int
      layers_composited: Int

behaviors:
  - name: create_compositor
    given: Width and height
    when: Initialize
    then: Compositor ready

  - name: create_layer
    given: Bounds and content
    when: Create
    then: Layer created

  - name: update_layer
    given: Layer and changes
    when: Update
    then: Layer updated

  - name: remove_layer
    given: Layer ID
    when: Remove
    then: Layer removed

  - name: set_layer_transform
    given: Layer and transform
    when: Transform
    then: Transform applied

  - name: set_layer_opacity
    given: Layer and opacity
    when: Set opacity
    then: Opacity updated

  - name: composite_frame
    given: Nothing
    when: Composite
    then: Frame in <8ms

  - name: invalidate_rect
    given: Rectangle
    when: Invalidate
    then: Rect marked dirty

  - name: get_damage_rects
    given: Frame
    when: Query
    then: Damage list

  - name: enable_gpu
    given: Compositor
    when: Enable
    then: GPU acceleration on

  - name: get_stats
    given: Compositor
    when: Query
    then: RenderStats

  - name: resize
    given: New dimensions
    when: Resize
    then: Compositor resized

test_cases:
  - name: test_frame_time
    input:
      layers: 10
    expected:
      frame_time_ms_max: 8

  - name: test_gpu_enabled
    input:
      enable: true
    expected:
      gpu_enabled: true
