# VIBEE CDP DOM v4.0.0
# DOM manipulation via CDP with Ï†-optimized queries
# Target: 0.5ms DOM query (2x improvement)

name: vibee_cdp_dom
version: "4.0.0"
language: zig
module: vibee_cdp_dom

constants:
  PHI: 1.6180339887498948482
  PHOENIX: 999
  TARGET_QUERY_MS: 0.5
  MAX_DEPTH: 100
  CACHE_SIZE: 10000

types:
  DOMNode:
    fields:
      node_id: Int
      backend_node_id: Int
      node_type: Int
      node_name: String
      node_value: Option<String>
      children: List<Int>
      attributes: List<String>

  BoxModel:
    fields:
      content: List<Float>
      padding: List<Float>
      border: List<Float>
      margin: List<Float>
      width: Int
      height: Int

  Selector:
    fields:
      css: String
      xpath: Option<String>
      pierce: Bool

  QueryResult:
    fields:
      node_ids: List<Int>
      count: Int
      duration_ms: Float

  MutationRecord:
    fields:
      type: String
      target_id: Int
      added_nodes: List<Int>
      removed_nodes: List<Int>
      attribute_name: Option<String>

  DOMSnapshot:
    fields:
      documents: List<Object>
      strings: List<String>

behaviors:
  - name: get_document
    given: Page
    when: Get document root
    then: DOMNode returned

  - name: query_selector
    given: Selector
    when: Find single element
    then: Node ID or null

  - name: query_selector_all
    given: Selector
    when: Find all elements
    then: QueryResult

  - name: get_box_model
    given: Node ID
    when: Get element bounds
    then: BoxModel returned

  - name: get_outer_html
    given: Node ID
    when: Get HTML
    then: HTML string

  - name: set_outer_html
    given: Node ID and HTML
    when: Replace HTML
    then: Node updated

  - name: get_attributes
    given: Node ID
    when: Get attributes
    then: Attribute list

  - name: set_attribute
    given: Node ID, name, value
    when: Set attribute
    then: Attribute set

  - name: remove_attribute
    given: Node ID and name
    when: Remove attribute
    then: Attribute removed

  - name: focus
    given: Node ID
    when: Focus element
    then: Element focused

  - name: scroll_into_view
    given: Node ID
    when: Scroll to element
    then: Element visible

  - name: capture_snapshot
    given: Page
    when: Capture DOM state
    then: DOMSnapshot returned

  - name: observe_mutations
    given: Node ID and callback
    when: Watch for changes
    then: Observer registered

test_cases:
  - name: test_query_selector
    input:
      css: "body"
    expected:
      found: true
      duration_ms_max: 0.5

  - name: test_get_box_model
    input:
      node_id: 1
    expected:
      has_dimensions: true
