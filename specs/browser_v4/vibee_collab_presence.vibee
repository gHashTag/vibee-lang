# VIBEE Collab Presence v4.0.0
# User presence and awareness

name: vibee_collab_presence
version: "4.0.0"
language: zig
module: vibee_collab_presence

constants:
  PHI: 1.6180339887498948482
  PHOENIX: 999
  HEARTBEAT_INTERVAL_MS: 5000
  PRESENCE_TIMEOUT_MS: 15000

types:
  User:
    fields:
      id: String
      name: String
      color: String
      avatar: Option<String>

  Presence:
    fields:
      user: Object
      status: String
      last_seen: Timestamp
      location: Option<Object>

  UserLocation:
    fields:
      file: String
      line: Int
      column: Int
      selection: Option<Object>

  PresenceUpdate:
    fields:
      user_id: String
      type: String
      data: Object
      timestamp: Timestamp

  Room:
    fields:
      id: String
      users: List<String>
      created_at: Timestamp

behaviors:
  - name: join_room
    given: Room ID and user
    when: Join
    then: User added

  - name: leave_room
    given: Room ID and user
    when: Leave
    then: User removed

  - name: update_presence
    given: Presence data
    when: Update
    then: Presence broadcast

  - name: update_location
    given: UserLocation
    when: Update
    then: Location broadcast

  - name: get_users
    given: Room ID
    when: Query
    then: User list

  - name: get_presence
    given: User ID
    when: Query
    then: Presence data

  - name: on_user_join
    given: Callback
    when: Register
    then: Handler registered

  - name: on_user_leave
    given: Callback
    when: Register
    then: Handler registered

  - name: on_presence_update
    given: Callback
    when: Register
    then: Handler registered

  - name: send_heartbeat
    given: User ID
    when: Heartbeat
    then: Presence refreshed

  - name: check_timeout
    given: User ID
    when: Check
    then: Active or timed out

test_cases:
  - name: test_join_room
    input:
      room_id: "test"
      user_id: "user1"
    expected:
      joined: true

  - name: test_presence_timeout
    input:
      last_seen_ms_ago: 20000
    expected:
      timed_out: true
