# VIBEE Collab CRDT v4.0.0
# CRDT sync engine with 2ms target
# KOSCHEI CYCLE: СУНДУК (Chest) - Persistence

name: vibee_collab_crdt
version: "4.0.0"
language: zig
module: vibee_collab_crdt

constants:
  PHI: 1.6180339887498948482
  PHOENIX: 999
  TARGET_SYNC_MS: 2
  MAX_PENDING_OPS: 10000
  SNAPSHOT_INTERVAL: 1000

types:
  CRDTDocument:
    fields:
      id: String
      content: String
      version: Int
      clock: Object
      pending_ops: List<Object>

  CRDTOperation:
    fields:
      id: String
      type: String
      position: Int
      value: Option<String>
      origin: String
      timestamp: Int

  CRDTState:
    fields:
      document_id: String
      local_version: Int
      remote_version: Int
      synced: Bool

  SyncMessage:
    fields:
      type: String
      document_id: String
      operations: List<Object>
      state_vector: Object

  Snapshot:
    fields:
      document_id: String
      content: String
      version: Int
      timestamp: Timestamp

behaviors:
  - name: create_document
    given: Initial content
    when: Create
    then: CRDTDocument

  - name: insert
    given: Position and text
    when: Insert
    then: Operation created

  - name: delete
    given: Position and length
    when: Delete
    then: Operation created

  - name: apply_operation
    given: CRDTOperation
    when: Apply
    then: Document updated

  - name: merge_operations
    given: Remote operations
    when: Merge
    then: Merged in <2ms

  - name: get_state_vector
    given: Document
    when: Query
    then: State vector

  - name: sync_with_peer
    given: Peer state
    when: Sync
    then: SyncMessage

  - name: create_snapshot
    given: Document
    when: Snapshot
    then: Snapshot created

  - name: restore_snapshot
    given: Snapshot
    when: Restore
    then: Document restored

  - name: get_pending_ops
    given: Document
    when: Query
    then: Operation list

  - name: compact_history
    given: Document
    when: Compact
    then: History compacted

  - name: resolve_conflict
    given: Conflicting ops
    when: Resolve
    then: Resolved state

test_cases:
  - name: test_merge_speed
    input:
      operations: 100
    expected:
      duration_ms_max: 2

  - name: test_concurrent_insert
    input:
      op1: {"pos": 0, "text": "a"}
      op2: {"pos": 0, "text": "b"}
    expected:
      merged: true
