#!/usr/bin/env python3
"""
ГЕНЕРАТОР КНИГИ 999 v2.0 — С РЕАЛЬНЫМ НАУЧНЫМ КОНТЕНТОМ
999 = 37 × 3³ = 3 тома × 9 книг × 37 глав
"""

import os
from typing import Tuple

# База знаний для первых 3 книг (полная), остальные — шаблоны
КНИГИ_ПОЛНЫЕ = {
    1: {
        "название": "Начало Пути",
        "научное": """
**История троичных систем**

В 1958 году в МГУ под руководством Н.П. Брусенцова был создан компьютер «Сетунь» — 
первый серийный троичный компьютер. Выпущено ~50 машин.

Сетунь использовала сбалансированную троичную систему {-1, 0, +1}:
- Естественное представление отрицательных чисел
- Округление без смещения
- Меньше операций переноса

**Математика:** log₃(N) / log₂(N) ≈ 0.63 — троичная система на 37% эффективнее!
""",
        "код": '''ⲙⲟⲇⲩⲗⲉ ⲛⲁⲭⲁⲗⲟ;

ⲉⲛⲩⲙ Трит { Минус = -1, Ноль = 0, Плюс = 1 }

ⲫⲩⲛⲕ в_троичную(n: i32) -> []Трит {
    ⲃⲁⲣ результат: [20]Трит = undefined;
    ⲃⲁⲣ x = n;
    ⲃⲁⲣ i: usize = 0;
    ⲱⲏⲓⲗⲉ (x != 0) {
        ⲕⲟⲛⲥⲧ r = @mod(x, 3);
        результат[i] = if (r == 0) .Ноль else if (r == 1) .Плюс else .Минус;
        x = @divTrunc(x + (if (r == 2) 1 else 0), 3);
        i += 1;
    }
    ⲣⲉⲧⲩⲣⲛ результат[0..i];
}''',
        "история": "Иван нашёл книгу о Сетуни и понял: его путь только начинается.",
        "мудрость": "Путь в тысячу ли начинается с одного шага"
    },
    2: {
        "название": "Число Три",
        "научное": """
**Математические свойства числа 3**

1. Первое нечётное простое число
2. φ² + 1/φ² = 3 (точно!) — связь с золотым сечением
3. Теорема: ∀N ∃! (n,k): N = n × 3^k, где n ∤ 3

**Доказательство тождества:**
φ² = φ + 1 (определение)
1/φ² = 2 - φ
φ² + 1/φ² = (φ + 1) + (2 - φ) = 3 ✓
""",
        "код": '''ⲙⲟⲇⲩⲗⲉ ⲧⲣⲟⲓⲕⲁ;

ⲕⲟⲛⲥⲧ φ: f64 = 1.6180339887498948482;

ⲫⲩⲛⲕ золотое_тождество() -> f64 {
    ⲣⲉⲧⲩⲣⲛ φ * φ + 1.0 / (φ * φ);  // = 3.0 точно!
}

ⲫⲩⲛⲕ разложить(n: u32) -> struct { основа: u32, степень: u32 } {
    ⲃⲁⲣ x = n; ⲃⲁⲣ k: u32 = 0;
    ⲱⲏⲓⲗⲉ (x % 3 == 0) { x /= 3; k += 1; }
    ⲣⲉⲧⲩⲣⲛ .{ .основа = x, .степень = k };
}''',
        "история": "На распутье трёх дорог Иван увидел надпись: φ² + 1/φ² = 3",
        "мудрость": "Бог любит троицу"
    },
    3: {
        "название": "Константы Вселенной",
        "научное": """
**Священная Формула: V = n × 3^k × π^m × φ^p**

Связи между константами:
- φ² + 1/φ² = 3 (точно)
- φ = 2cos(π/5)
- e^(iπ) + 1 = 0 (тождество Эйлера)

**Примеры:**
- 999 = 37 × 3³ × π⁰ × φ⁰
- π ≈ 3.14159... ≈ 3 (с точностью 4.5%)
""",
        "код": '''ⲙⲟⲇⲩⲗⲉ ⲕⲟⲛⲥⲧⲁⲛⲧⲩ;

ⲕⲟⲛⲥⲧ π: f64 = 3.14159265358979323846;
ⲕⲟⲛⲥⲧ φ: f64 = 1.61803398874989484820;
ⲕⲟⲛⲥⲧ e: f64 = 2.71828182845904523536;

ⲫⲩⲛⲕ проверить() !void {
    ⲡⲣⲓⲛⲧ("φ² + 1/φ² = {d:.15}", φ*φ + 1/(φ*φ));
    ⲡⲣⲓⲛⲧ("2cos(π/5) = {d:.15}", 2*@cos(π/5));
}''',
        "история": "Звездочёт показал Ивану: звёзды подчиняются числам π, φ, e.",
        "мудрость": "Вселенная написана на языке математики"
    },
    10: {
        "название": "Trinity Sort",
        "научное": """
**Dual-Pivot QuickSort (Yaroslavskiy, 2009)**

Используется в Java 7+ для Arrays.sort(). Два pivot'а делят массив на 3 части.

**Сложность:** O(n log₃ n) ≈ O(0.63 n log₂ n)

На 20% быстрее классического QuickSort за счёт:
- Меньше сравнений: log₃(n) < log₂(n)
- Лучшая локальность кэша
- Естественная параллелизация на 3 потока
""",
        "код": '''ⲙⲟⲇⲩⲗⲉ ⲧⲣⲓⲛⲓⲧⲩ_ⲥⲟⲣⲧ;

ⲫⲩⲛⲕ trinity_sort(arr: []i32) void {
    ⲓⲫ (arr.len <= 1) ⲣⲉⲧⲩⲣⲛ;
    
    // Два pivot'а делят на 3 части
    ⲃⲁⲣ p1 = arr[arr.len / 3];
    ⲃⲁⲣ p2 = arr[2 * arr.len / 3];
    ⲓⲫ (p1 > p2) std.mem.swap(i32, &p1, &p2);
    
    // Разделение: < p1 | p1..p2 | > p2
    // ... рекурсия на 3 части
}''',
        "история": "На турнире алгоритмов TrinitySort победил QuickSort.",
        "мудрость": "Разделяй на три — и властвуй"
    },
    27: {
        "название": "OMEGA",
        "научное": """
**Полнота и завершение**

999 = 37 × 27 = 37 × 3³

Это число полноты:
- 3 тома × 9 книг × 37 глав = 999
- 37 — простое число (неделимая основа)
- 27 = 3³ — куб тройки

Круг замкнулся: от главы 1 до главы 999, от теории через практику к будущему.
""",
        "код": '''ⲙⲟⲇⲩⲗⲉ ⲟⲙⲉⲅⲁ;

ⲕⲟⲛⲥⲧ OMEGA = 999;
ⲕⲟⲛⲥⲧ ОСНОВА = 37;
ⲕⲟⲛⲥⲧ КУБ_ТРОЙКИ = 27;

ⲫⲩⲛⲕ main() !void {
    ⲡⲣⲓⲛⲧ("999 = {} × {} = {} × 3³", ОСНОВА, КУБ_ТРОЙКИ, ОСНОВА);
    ⲡⲣⲓⲛⲧ("Круг замкнулся. Конец — это начало.");
}''',
        "история": "Иван получил золотой ключ и вернулся домой другим человеком.",
        "мудрость": "Конец — это начало"
    }
}

# Названия всех 27 книг
НАЗВАНИЯ = [
    "Начало Пути", "Число Три", "Константы Вселенной", "Троичная Логика",
    "Структуры Данных", "Квантовые Кутриты", "Нейронные Сети", "Криптография", "Завершение Теории",
    "Trinity Sort", "Trinity Search", "Trinity Compress", "Язык VIBEE",
    "Компилятор 999", "Runtime HTML", "PAS Методология", "Бенчмарки", "Завершение Практики",
    "999 OS", "ЖАР-ПТИЦА", "50 Языков", "Квантовое Будущее",
    "Космическая Интеграция", "Сознание", "Эволюция", "Трансценденция", "OMEGA"
]

МУДРОСТИ = [
    "Путь в тысячу ли начинается с одного шага", "Бог любит троицу",
    "Вселенная написана на языке математики", "Не всё в мире чёрное или белое",
    "Порядок — основа мудрости", "Наблюдатель меняет наблюдаемое",
    "Мудрость — это связи между знаниями", "Тайна — сила того, кто её хранит",
    "Теория без практики мертва", "Разделяй на три — и властвуй",
    "Ищущий да обрящет", "Краткость — сестра таланта",
    "Язык определяет мышление", "Инструмент — продолжение руки мастера",
    "Один рантайм — одна истина", "Кто знает прошлое — предскажет будущее",
    "Что измеряешь — тем управляешь", "Практика без теории слепа",
    "Система — отражение создателя", "Эволюция — путь к совершенству",
    "Много языков — одна истина", "Будущее уже здесь",
    "Как вверху, так и внизу", "Познай себя",
    "Изменение — единственная константа", "Есть вещи, которые нельзя вычислить",
    "Конец — это начало"
]


def координаты(номер: int) -> Tuple[int, int, int]:
    том = (номер - 1) // 333 + 1
    книга = (номер - 1) // 37 + 1
    глава = (номер - 1) % 37 + 1
    return том, книга, глава


def священная_формула(n: int) -> Tuple[int, int]:
    k = 0
    while n % 3 == 0 and n > 0:
        n //= 3
        k += 1
    return n, k


def получить_данные_книги(книга: int) -> dict:
    if книга in КНИГИ_ПОЛНЫЕ:
        return КНИГИ_ПОЛНЫЕ[книга]
    return {
        "название": НАЗВАНИЯ[книга - 1] if книга <= 27 else f"Книга {книга}",
        "научное": f"Научное содержание книги {книга}: {НАЗВАНИЯ[книга - 1] if книга <= 27 else ''}",
        "код": f"ⲙⲟⲇⲩⲗⲉ ⲕⲛⲓⲅⲁ_{книга:02d};\n// Код для книги {книга}",
        "история": f"История главы из книги «{НАЗВАНИЯ[книга - 1] if книга <= 27 else ''}»",
        "мудрость": МУДРОСТИ[книга - 1] if книга <= 27 else "Мудрость"
    }


def сгенерировать_главу(номер: int) -> str:
    том, книга, глава = координаты(номер)
    данные = получить_данные_книги(книга)
    n, k = священная_формула(номер)
    царство = ["Медное", "Серебряное", "Золотое"][том - 1]
    
    return f"""# Глава {номер}: {данные['название']}

> **Том {том}: {царство} Царство** | **Книга {книга}** | **Глава {глава}/37**
>
> **Священная Формула:** V = {n} × 3^{k} = {номер}

---

## История

{данные['история']}

---

## Научное содержание

{данные['научное']}

---

## Код

```999
{данные['код']}
```

---

## Мудрость

> *«{данные['мудрость']}»*

---

*Глава {номер}/999 | V = {n} × 3^{k}*
"""


def main():
    print("╔═══════════════════════════════════════════════════════════════╗")
    print("║  ГЕНЕРАТОР КНИГИ 999 v2.0                                     ║")
    print("╚═══════════════════════════════════════════════════════════════╝")
    
    output = "/workspaces/vibee-lang/book/generated_v2"
    os.makedirs(output, exist_ok=True)
    
    тома = ["ⲧⲟⲙ_1_ⲙⲉⲇⲛⲟⲉ", "ⲧⲟⲙ_2_ⲥⲉⲣⲉⲃⲣⲟ", "ⲧⲟⲙ_3_ⲍⲟⲗⲟⲧⲟ"]
    
    for номер in range(1, 1000):
        том, книга, _ = координаты(номер)
        путь = f"{output}/{тома[том-1]}/ⲕⲛⲓⲅⲁ_{книга:02d}"
        os.makedirs(путь, exist_ok=True)
        
        with open(f"{путь}/ⲅⲗⲁⲃⲁ_{номер:03d}.md", 'w') as f:
            f.write(сгенерировать_главу(номер))
        
        if номер % 100 == 0:
            print(f"✓ {номер} глав...")
    
    print("\n✅ Сгенерировано 999 глав")


if __name__ == "__main__":
    main()
