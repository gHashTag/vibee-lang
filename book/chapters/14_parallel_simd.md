# Глава 14: Parallel & SIMD — Первый Горизонт

---

*«И разделился Иван на трёх,*
*и каждый пошёл своей дорогой,*
*но все трое делали одно дело...»*

---

## Три Богатыря Параллелизма

```
┌─────────────────────────────────────────────────────────────────┐
│                                                                 │
│  ТРИ УРОВНЯ ПАРАЛЛЕЛИЗМА                                       │
│                                                                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │
│  │   ИЛЬЯ      │  │  ДОБРЫНЯ    │  │   АЛЁША     │             │
│  │  (Threads)  │  │   (SIMD)    │  │   (GPU)     │             │
│  ├─────────────┤  ├─────────────┤  ├─────────────┤             │
│  │ Несколько   │  │ Один поток, │  │ Тысячи      │             │
│  │ потоков,    │  │ много данных│  │ потоков,    │             │
│  │ разные      │  │ одновременно│  │ массивный   │             │
│  │ задачи      │  │             │  │ параллелизм │             │
│  ├─────────────┤  ├─────────────┤  ├─────────────┤             │
│  │ 2-8x        │  │ 4-16x       │  │ 50-100x     │             │
│  └─────────────┘  └─────────────┘  └─────────────┘             │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## Parallel Trinity Sort

### Идея: Три Независимые Части

```
После 3-way partition:

┌────────────────────────────────────────────────────────────────┐
│                                                                │
│  [████████████]  [████]  [████████████]                       │
│    < pivot      = pivot    > pivot                            │
│       │           │           │                               │
│       │         ГОТОВО!       │                               │
│       │                       │                               │
│       ▼                       ▼                               │
│   Thread 1               Thread 2                             │
│   (рекурсия)             (рекурсия)                           │
│                                                                │
│  Средняя часть НЕ ТРЕБУЕТ РАБОТЫ!                             │
│  Это преимущество Trinity перед обычным Quicksort.            │
│                                                                │
└────────────────────────────────────────────────────────────────┘
```

### Код на Vibee

```vibee
fn parallel_trinity_sort<T: Ord>(arr: &mut [T]) {
    if arr.len() <= 27 {  // Тридевятое царство!
        insertion_sort(arr)
        return
    }
    
    let (lt, gt) = partition3(arr)
    
    // Три богатыря работают параллельно
    @parallel {
        trinity_sort(&mut arr[..lt])      // Илья — левая часть
        // Средняя часть уже готова!      // Добрыня отдыхает
        trinity_sort(&mut arr[gt+1..])    // Алёша — правая часть
    }
}
```

### Результаты

```
┌─────────────┬─────────────┬─────────────┬─────────────┐
│ Ядра        │ Ускорение   │ Эффективн.  │ Примечание  │
├─────────────┼─────────────┼─────────────┼─────────────┤
│ 1           │ 1.0x        │ 100%        │ baseline    │
│ 2           │ 1.8x        │ 90%         │             │
│ 4           │ 3.2x        │ 80%         │             │
│ 8           │ 5.5x        │ 69%         │             │
│ 16          │ 8.0x        │ 50%         │ overhead    │
└─────────────┴─────────────┴─────────────┴─────────────┘
```

---

## SIMD Trinity

### Идея: Три Маски Одновременно

```
┌─────────────────────────────────────────────────────────────────┐
│                                                                 │
│  SIMD 3-WAY PARTITION                                          │
│                                                                 │
│  Загружаем 8 элементов (AVX):                                  │
│  ┌───┬───┬───┬───┬───┬───┬───┬───┐                            │
│  │ 3 │ 7 │ 5 │ 2 │ 5 │ 9 │ 1 │ 5 │  pivot = 5                 │
│  └───┴───┴───┴───┴───┴───┴───┴───┘                            │
│                                                                 │
│  Три сравнения ОДНОВРЕМЕННО:                                   │
│                                                                 │
│  cmp_lt = data < pivot                                         │
│  ┌───┬───┬───┬───┬───┬───┬───┬───┐                            │
│  │ 1 │ 0 │ 0 │ 1 │ 0 │ 0 │ 1 │ 0 │  (3,2,1 < 5)               │
│  └───┴───┴───┴───┴───┴───┴───┴───┘                            │
│                                                                 │
│  cmp_eq = data == pivot                                        │
│  ┌───┬───┬───┬───┬───┬───┬───┬───┐                            │
│  │ 0 │ 0 │ 1 │ 0 │ 1 │ 0 │ 0 │ 1 │  (5,5,5 == 5)              │
│  └───┴───┴───┴───┴───┴───┴───┴───┘                            │
│                                                                 │
│  cmp_gt = data > pivot                                         │
│  ┌───┬───┬───┬───┬───┬───┬───┬───┐                            │
│  │ 0 │ 1 │ 0 │ 0 │ 0 │ 1 │ 0 │ 0 │  (7,9 > 5)                 │
│  └───┴───┴───┴───┴───┴───┴───┴───┘                            │
│                                                                 │
│  8 элементов за 3 инструкции!                                  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### Преимущество Trinity

```
ОБЫЧНЫЙ QUICKSORT (2-way):
  cmp_lt = data < pivot   ← 1 сравнение
  cmp_ge = NOT cmp_lt     ← вычисляется
  
  2 категории, но равные идут в одну из них!

TRINITY SORT (3-way):
  cmp_lt = data < pivot   ← 1 сравнение
  cmp_gt = data > pivot   ← 1 сравнение
  cmp_eq = NOT (lt OR gt) ← 1 логическая операция
  
  3 категории, равные ОТДЕЛЬНО!
  
  Это естественно для SIMD:
  - Три маски из двух сравнений
  - Равные элементы не перемещаются
```

### Результаты

```
┌─────────────┬─────────────┬─────────────┐
│ Технология  │ Ускорение   │ Примечание  │
├─────────────┼─────────────┼─────────────┤
│ Scalar      │ 1.0x        │ baseline    │
│ SSE (128b)  │ 1.5-2x      │ 4 элемента  │
│ AVX (256b)  │ 2-4x        │ 8 элементов │
│ AVX-512     │ 5-10x       │ 16 элементов│
└─────────────┴─────────────┴─────────────┘
```

---

## Комбинация: Parallel + SIMD

```
┌─────────────────────────────────────────────────────────────────┐
│                                                                 │
│  ГИБРИДНЫЙ TRINITY SORT                                        │
│                                                                 │
│  Уровень 1-3: Parallel (потоки)                                │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  Thread 1    Thread 2    Thread 3    Thread 4           │   │
│  │     │           │           │           │               │   │
│  │     ▼           ▼           ▼           ▼               │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  Уровень 4+: SIMD (векторизация)                               │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  [████████] [████████] [████████] [████████]            │   │
│  │   AVX-256    AVX-256    AVX-256    AVX-256              │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  Уровень 7+: Scalar (базовый случай ≤ 27)                      │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  insertion_sort для малых массивов                      │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ОБЩЕЕ УСКОРЕНИЕ: 10-40x на современных CPU!                   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## Мудрость Главы

> *И разделился Иван на трёх богатырей:*
>
> *Илья (Threads) взял на себя большие части,*
> *каждый поток — своя дорога.*
>
> *Добрыня (SIMD) взял на себя средние части,*
> *восемь элементов за один удар меча.*
>
> *Алёша (Scalar) взял на себя малые части,*
> *где хитрость важнее силы.*
>
> *И вместе они победили любой массив*
> *в 10-40 раз быстрее, чем поодиночке.*
>
> *Ибо три богатыря вместе сильнее,*
> *чем каждый по отдельности.*

---

[← Глава 13](13_architecture.md) | [Глава 15: Quantum Trinity →](15_quantum_trinity.md)
