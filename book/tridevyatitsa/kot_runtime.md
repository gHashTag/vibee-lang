# 🐱 Кот Учёный — Runtime Тридевятицы

> *И днём и ночью кот учёный*
> *Всё ходит по цепи кругом;*
> *Идёт направо — сказку говорит,*
> *Налево — песнь заводит.*

## Обзор

**Кот Учёный** — это интерпретатор языка Тридевятица. Он "ходит по златой цепи" (event loop) и исполняет код, разделяя чистые вычисления (сказки) и побочные эффекты (песни).

```
┌─────────────────────────────────────────────────────────┐
│                    🐱 КОТ УЧЁНЫЙ                        │
│                   ══════════════                        │
│                                                         │
│    ┌─────────────┐         ┌─────────────┐             │
│    │   НАПРАВО   │         │   НАЛЕВО    │             │
│    │   ───────→  │         │  ←───────   │             │
│    │             │         │             │             │
│    │  📖 СКАЗКА  │         │  🎵 ПЕСНЬ   │             │
│    │   (Pure)    │         │  (Effects)  │             │
│    │             │         │             │             │
│    │ • Вычисления│         │ • I/O       │             │
│    │ • Без мутаций│        │ • Мутации   │             │
│    │ • Детерминизм│        │ • Время     │             │
│    │ • Кэшируемо │         │ • Сеть      │             │
│    └─────────────┘         └─────────────┘             │
│                                                         │
│                    ⛓️ ЦЕПЬ                              │
│              (Event Loop / Scheduler)                   │
└─────────────────────────────────────────────────────────┘
```

---

## 🔄 Цикл исполнения

Кот ходит по цепи — это **главный цикл** интерпретатора:

```python
class КотУчёный:
    """Интерпретатор языка Тридевятица"""
    
    def __init__(self, дуб):
        self.дуб = дуб          # Память (Дуб)
        self.цепь = []          # Очередь задач
        self.направление = None  # Текущее направление
        
    def ходить_кругом(self):
        """Главный цикл — кот ходит по цепи"""
        while self.цепь:
            задача = self.цепь.pop(0)
            
            if задача.тип == "сказка":
                self.направление = "направо"
                результат = self.сказку_говорить(задача)
            else:
                self.направление = "налево"
                self.песнь_заводить(задача)
                результат = None
                
            if задача.продолжение:
                self.цепь.append(задача.продолжение)
                
        return результат
```

---

## 📖 Направо — Сказку говорит (Pure Functions)

Когда кот идёт **направо**, он выполняет **чистые вычисления**:

### Свойства сказок

| Свойство | Описание |
|----------|----------|
| **Детерминизм** | Одинаковый вход → одинаковый выход |
| **Без побочных эффектов** | Не меняет внешний мир |
| **Референциальная прозрачность** | Можно заменить вызов результатом |
| **Кэшируемость** | Результат можно запомнить |

### Синтаксис

```tridevyatitsa
// Объявление сказки (чистой функции)
сказка название(параметры):
    // только вычисления
    вернуть результат

// Вызов сказки
результат = направо название(аргументы)
```

### Примеры

```tridevyatitsa
// Арифметика — всегда сказка
сказка сложить(а, б):
    вернуть а + б

сказка факториал(n):
    если n <= 1:
        вернуть 1
    иначе:
        вернуть n * направо факториал(n - 1)

// Преобразование данных
сказка удвоить_все(список):
    вернуть [x * 2 для x в список]

// Использование
сумма = направо сложить(3, 4)        // 7
факт = направо факториал(5)          // 120
числа = направо удвоить_все([1,2,3]) // [2,4,6]
```

### Мемоизация (Кот запоминает сказки)

```tridevyatitsa
// Кот запоминает результаты сказок
@запомнить
сказка фибоначчи(n):
    если n <= 1:
        вернуть n
    вернуть направо фибоначчи(n-1) + направо фибоначчи(n-2)

// Первый вызов — вычисляет
фиб_10 = направо фибоначчи(10)  // вычисляет

// Второй вызов — берёт из памяти
фиб_10_снова = направо фибоначчи(10)  // мгновенно!
```

---

## 🎵 Налево — Песнь заводит (Side Effects)

Когда кот идёт **налево**, он производит **побочные эффекты**:

### Типы песен

| Песнь | Эффект |
|-------|--------|
| `молвить` | Вывод на экран |
| `внимать` | Ввод с клавиатуры |
| `начертать` | Запись в файл |
| `прочесть` | Чтение из файла |
| `послать` | Сетевой запрос |
| `изменить` | Мутация объекта |

### Синтаксис

```tridevyatitsa
// Объявление песни (функции с эффектами)
песнь название(параметры):
    // эффекты разрешены
    молвить "что-то"

// Вызов песни
налево название(аргументы)
```

### Примеры

```tridevyatitsa
// Вывод — песнь
песнь приветствие(имя):
    молвить "Здравствуй, " + имя + "!"
    молвить "Добро пожаловать в Тридевятое царство!"

// Ввод — песнь
песнь спросить_имя():
    молвить "Как тебя зовут, добрый молодец?"
    имя = внимать()
    вернуть имя

// Файловые операции — песни
песнь сохранить_игру(герой, путь):
    данные = направо сериализовать(герой)
    начертать(путь, данные)
    молвить "Игра сохранена!"

// Использование
налево приветствие("Иван")
имя = налево спросить_имя()
налево сохранить_игру(герой, "сохранение.tri")
```

---

## 🔄 Кругом — Комбинирование

**Кругом** — когда нужны и вычисления, и эффекты:

```tridevyatitsa
// Полный цикл обработки
кругом обработать_заказ(заказ):
    // Направо — вычисляем
    сумма = направо посчитать_сумму(заказ)
    скидка = направо применить_скидку(сумма, заказ.клиент)
    итого = направо вычесть(сумма, скидка)
    
    // Налево — эффекты
    налево сохранить_в_базу(заказ, итого)
    налево отправить_чек(заказ.клиент, итого)
    налево молвить("Заказ обработан: " + итого)
    
    вернуть итого
```

### Диаграмма потока

```
        КРУГОМ
           │
    ┌──────┴──────┐
    │             │
    ▼             ▼
 НАПРАВО       НАЛЕВО
 (сказки)      (песни)
    │             │
    │  результат  │
    └──────┬──────┘
           │
           ▼
        ИТОГ
```

---

## ⚡ Система эффектов

Кот отслеживает, какие эффекты разрешены:

```tridevyatitsa
// Объявление разрешённых эффектов
песнь<молвить, начертать> логировать(сообщение, файл):
    молвить сообщение           // ✓ разрешено
    начертать(файл, сообщение)  // ✓ разрешено
    // послать(...)             // ✗ не разрешено!

// Чистая функция не может вызывать песни
сказка вычислить(x):
    // налево молвить(x)  // ✗ ОШИБКА! Сказка не поёт!
    вернуть x * 2
```

### Иерархия эффектов

```
                    ⚡ ВСЕ ЭФФЕКТЫ
                         │
         ┌───────────────┼───────────────┐
         │               │               │
    📺 КОНСОЛЬ      📁 ФАЙЛЫ       🌐 СЕТЬ
    │               │               │
    ├─ молвить      ├─ прочесть     ├─ послать
    └─ внимать      └─ начертать    └─ принять
    
                         │
                    🔄 МУТАЦИИ
                    │
                    └─ изменить
```

---

## 🎭 Режимы работы Кота

### 1. Строгий режим (по умолчанию)

```tridevyatitsa
@строгий
кругом программа():
    // Все эффекты должны быть явными
    результат = направо вычислить(данные)  // ✓
    налево показать(результат)              // ✓
```

### 2. Ленивый режим

```tridevyatitsa
@ленивый
сказка бесконечный_список():
    // Вычисляется только при обращении
    вернуть [n для n в натуральные()]

список = направо бесконечный_список()
первые_5 = направо взять(5, список)  // [1,2,3,4,5]
```

### 3. Параллельный режим

```tridevyatitsa
@параллельно
кругом обработать_много(задачи):
    // Кот раздваивается!
    результаты = [направо обработать(з) для з в задачи]
    вернуть результаты
```

---

## 🐱 Состояния Кота

```
┌─────────────────────────────────────────────┐
│            СОСТОЯНИЯ КОТА                    │
├─────────────────────────────────────────────┤
│                                              │
│   😺 БОДРСТВУЕТ — выполняет код             │
│        │                                     │
│        ▼                                     │
│   😸 НАПРАВО — говорит сказку (pure)        │
│        │                                     │
│        ▼                                     │
│   😹 НАЛЕВО — заводит песнь (effects)       │
│        │                                     │
│        ▼                                     │
│   😻 МУРЛЫЧЕТ — ожидает I/O                 │
│        │                                     │
│        ▼                                     │
│   😴 ДРЕМЛЕТ — нет задач                    │
│        │                                     │
│        ▼                                     │
│   🙀 ШИПИТ — ошибка!                        │
│                                              │
└─────────────────────────────────────────────┘
```

---

## 🔧 Реализация на Zig

```zig
const std = @import("std");

const Направление = enum {
    направо,  // Pure
    налево,   // Effects
    кругом,   // Both
};

const СостояниеКота = enum {
    бодрствует,
    говорит_сказку,
    поёт_песнь,
    мурлычет,
    дремлет,
    шипит,
};

const КотУчёный = struct {
    дуб: *Дуб,
    цепь: std.ArrayList(Задача),
    состояние: СостояниеКота,
    направление: ?Направление,
    
    pub fn ходитьКругом(self: *КотУчёный) !?Значение {
        while (self.цепь.items.len > 0) {
            const задача = self.цепь.orderedRemove(0);
            
            self.направление = задача.направление;
            self.состояние = switch (задача.направление) {
                .направо => .говорит_сказку,
                .налево => .поёт_песнь,
                .кругом => .бодрствует,
            };
            
            const результат = try self.исполнить(задача);
            
            if (задача.продолжение) |прод| {
                try self.цепь.append(прод);
            }
            
            if (self.цепь.items.len == 0) {
                self.состояние = .дремлет;
                return результат;
            }
        }
        
        self.состояние = .дремлет;
        return null;
    }
    
    fn исполнить(self: *КотУчёный, задача: Задача) !?Значение {
        return switch (задача.тип) {
            .сказка => self.сказкуГоворить(задача),
            .песнь => {
                try self.песньЗаводить(задача);
                return null;
            },
        };
    }
    
    fn сказкуГоворить(self: *КотУчёный, задача: Задача) !Значение {
        // Чистое вычисление — только читаем из Дуба
        return self.дуб.вычислить(задача.выражение);
    }
    
    fn песньЗаводить(self: *КотУчёный, задача: Задача) !void {
        // Эффекты — можем менять мир
        switch (задача.эффект) {
            .молвить => |текст| std.debug.print("{s}\n", .{текст}),
            .начертать => |данные| try std.fs.cwd().writeFile(данные.путь, данные.содержимое),
            .изменить => |мутация| self.дуб.изменить(мутация),
        }
    }
};
```

---

## 📊 Сравнение с другими подходами

| Концепция | Тридевятица | Haskell | JavaScript |
|-----------|-------------|---------|------------|
| Чистые функции | `сказка` | pure function | - |
| Эффекты | `песнь` | IO Monad | любая функция |
| Разделение | `направо/налево` | do-notation | - |
| Event Loop | Златая Цепь | - | Event Loop |
| Ленивость | Русалка | по умолчанию | - |

---

## 🎯 Пример: Игровой цикл

```tridevyatitsa
// Главный игровой цикл на языке Тридевятица

корень ВЫХОД = ложь

лист игрок = Ⲯ {
    имя: "Иван",
    здоровье: 100,
    позиция: [0, 0]
}

сказка обновить_физику(игрок, время):
    новая_позиция = [
        игрок.позиция[0] + игрок.скорость[0] * время,
        игрок.позиция[1] + игрок.скорость[1] * время
    ]
    вернуть {...игрок, позиция: новая_позиция}

песнь отрисовать(игрок):
    очистить_экран()
    нарисовать_спрайт(игрок.спрайт, игрок.позиция)
    показать_здоровье(игрок.здоровье)

песнь обработать_ввод():
    клавиша = получить_нажатие()
    если клавиша == "ВЫХОД":
        ВЫХОД = истина
    вернуть клавиша

кругом игровой_цикл():
    пока не ВЫХОД:
        // Налево — читаем ввод
        ввод = налево обработать_ввод()
        
        // Направо — обновляем состояние
        игрок = направо обновить_физику(игрок, 0.016)
        игрок = направо обработать_ввод_игрока(игрок, ввод)
        
        // Налево — рисуем
        налево отрисовать(игрок)
        
        // Кот отдыхает до следующего кадра
        налево ждать(16)  // ~60 FPS

// Запуск
кругом игровой_цикл()
```

---

*Так Кот Учёный ходит по цепи — направо сказки говорит (чистые вычисления), налево песни заводит (побочные эффекты), а кругом — полный цикл программы.* 🐱⛓️🌳
