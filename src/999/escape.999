// ============================================
// ESCAPE ANALYSIS И STACK ALLOCATION
// ============================================

Ⲩ arifmetika

// Состояние побега
Ⲉ ⲈⲤⲥⲧⲁⲧⲉ:
  НЕ_УБЕГАЕТ      // Можно на стек
  УБЕГАЕТ_ЛОКАЛЬНО // Убегает в вызываемую функцию
  УБЕГАЕТ_ГЛОБАЛЬНО // Убегает в кучу/глобальные

// Информация об аллокации
Ⲏ ⲈⲤⲁⲗⲗⲟⲥ:
  id: Ⲋ
  тип: Ⲥ
  размер: Ⲋ
  состояние: Ⲉ ⲈⲤⲥⲧⲁⲧⲉ
  причина: Ⲥ?

// Граф потока данных
Ⲏ ⲈⲤⲅⲣⲁⲫ:
  узлы: [ⲈⲤⲁⲗⲗⲟⲥ]
  рёбра: [(Ⲋ, Ⲋ)]  // (от, к)

// Анализ побега
Ⲫ анализ_побега(функция: Ⲥ) -> [ⲈⲤⲁⲗⲗⲟⲥ]:
  Ⲙ аллокации = найти_аллокации(функция)
  Ⲙ граф = построить_граф_потока(функция, аллокации)
  
  // Распространение состояний
  Ⲙ изменилось = Ⲁ
  Ⲯ изменилось:
    изменилось = Ⲃ
    Ⲯ (от, к) граф.рёбра:
      Ⲙ источник = граф.узлы[от]
      Ⲙ цель = граф.узлы[к]
      Ⲝ источник.состояние > цель.состояние:
        цель.состояние = источник.состояние
        изменилось = Ⲁ
  
  Ⲣ граф.узлы

// Проверка побега через возврат
Ⲫ убегает_через_возврат(аллок: ⲈⲤⲁⲗⲗⲟⲥ, функция: Ⲥ) -> Ⲃ:
  Ⲙ возвраты = найти_возвраты(функция)
  Ⲯ возврат возвраты:
    Ⲝ использует(возврат, аллок.id):
      Ⲣ Ⲁ
  Ⲣ Ⲃ

// Проверка побега через присваивание глобальной
Ⲫ убегает_в_глобальную(аллок: ⲈⲤⲁⲗⲗⲟⲥ, функция: Ⲥ) -> Ⲃ:
  Ⲙ присваивания = найти_присваивания(функция)
  Ⲯ присв присваивания:
    Ⲝ глобальная(присв.цель) && использует(присв.значение, аллок.id):
      Ⲣ Ⲁ
  Ⲣ Ⲃ

// Оптимизация: куча → стек
Ⲫ оптимизировать_аллокации(функция: Ⲥ) -> Ⲥ:
  Ⲙ аллокации = анализ_побега(функция)
  Ⲙ результат = функция
  
  Ⲯ аллок аллокации:
    Ⲝ аллок.состояние == НЕ_УБЕГАЕТ:
      // Заменяем heap на stack
      результат = заменить_аллокацию(результат, аллок.id, "стек")
  
  Ⲣ результат

// Пример трансформации:
// До:  Ⲙ x = new Point(1, 2)
// После: Ⲙ x = Point { x: 1, y: 2 }  // на стеке

Ⲫ пример_escape():
  // Не убегает - можно на стек
  Ⲙ локальный = new Point(1, 2)
  печать(локальный.x)
  
  // Убегает - остаётся в куче
  Ⲙ убегающий = new Point(3, 4)
  глобальная_переменная = убегающий
