name: autofix
version: "1.0.0"
language: gleam
module: honeycomb/dogfooding/autofix
description: Automatic violation fixing for VIBEE spec enforcement

behaviors:
  - name: fix_violation
    given: Violation detected by scanner
    when: Auto-fix is requested
    then: Violation is automatically fixed if possible
    test_cases:
      - name: fix_manual_code_violation
        input:
          violation: {rule: "NoManualCode", file: "honeycomb/test.gleam"}
          spec_exists: true
        expected: {fixed: true, action: "regenerated_from_spec"}
      - name: fix_missing_spec_violation
        input:
          violation: {rule: "MissingSpec", file: "honeycomb/new.gleam"}
          spec_exists: false
        expected: {fixed: false, reason: "requires_manual_spec_creation"}
      - name: fix_outdated_code_violation
        input:
          violation: {rule: "OutdatedCode", file: "honeycomb/old.gleam"}
          spec_exists: true
        expected: {fixed: true, action: "regenerated_from_spec"}

  - name: regenerate_from_spec
    given: Gleam file and its spec
    when: Regeneration is triggered
    then: File is regenerated using vibeec
    test_cases:
      - name: regenerate_valid_spec
        input:
          gleam_file: "honeycomb/agent/core.gleam"
          spec_file: "specs/agent_core.vibee"
        expected: {success: true, backup_created: true}
      - name: regenerate_invalid_spec
        input:
          gleam_file: "honeycomb/test.gleam"
          spec_file: "specs/invalid.vibee"
        expected: {success: false, error: "spec_validation_failed"}

  - name: create_backup
    given: File to be modified
    when: Backup is created before modification
    then: Original file is saved with timestamp
    test_cases:
      - name: create_backup_success
        input: {file: "honeycomb/test.gleam"}
        expected: 
          backup_path: "honeycomb/test.gleam.backup.1704067200"
          success: true
      - name: create_backup_readonly
        input: {file: "/readonly/test.gleam"}
        expected: {success: false, error: "permission_denied"}

  - name: validate_fix
    given: Fixed file
    when: Validation is performed
    then: File is checked for correctness
    test_cases:
      - name: validate_successful_fix
        input:
          file: "honeycomb/test.gleam"
          original_violations: [{rule: "NoManualCode"}]
        expected: {valid: true, remaining_violations: []}
      - name: validate_failed_fix
        input:
          file: "honeycomb/test.gleam"
          original_violations: [{rule: "NoManualCode"}]
        expected: {valid: false, remaining_violations: [{rule: "NoManualCode"}]}

  - name: rollback_fix
    given: Failed fix with backup
    when: Rollback is triggered
    then: Original file is restored from backup
    test_cases:
      - name: rollback_success
        input:
          file: "honeycomb/test.gleam"
          backup: "honeycomb/test.gleam.backup.1704067200"
        expected: {success: true, restored: true}
      - name: rollback_no_backup
        input:
          file: "honeycomb/test.gleam"
          backup: null
        expected: {success: false, error: "no_backup_found"}

types:
  FixResult:
    violation: Violation
    fixed: Bool
    action: FixAction
    backup_path: Option(String)
    error: Option(String)

  FixAction:
    variants:
      - RegeneratedFromSpec
      - CreatedSpec
      - ManualFixRequired
      - NoActionNeeded

  BackupInfo:
    original_path: String
    backup_path: String
    timestamp: Int

  ValidationResult:
    valid: Bool
    remaining_violations: List(Violation)
    new_violations: List(Violation)

  FixConfig:
    create_backups: Bool
    validate_after_fix: Bool
    rollback_on_failure: Bool
    max_retries: Int

functions:
  - name: fix_violation
    params: {violation: Violation, config: FixConfig}
    returns: Result(FixResult, String)
    description: Attempt to automatically fix a violation

  - name: fix_all_violations
    params: {violations: List(Violation), config: FixConfig}
    returns: List(FixResult)
    description: Fix multiple violations in batch

  - name: regenerate_from_spec
    params: {gleam_file: String, spec_file: String}
    returns: Result(Nil, String)
    description: Regenerate Gleam file from spec using vibeec

  - name: create_backup
    params: {file_path: String}
    returns: Result(BackupInfo, String)
    description: Create timestamped backup of file

  - name: restore_backup
    params: {backup_info: BackupInfo}
    returns: Result(Nil, String)
    description: Restore file from backup

  - name: validate_fix
    params: {file_path: String, original_violations: List(Violation)}
    returns: ValidationResult
    description: Validate that fix resolved violations

  - name: run_vibeec_gen
    params: {spec_path: String, output_path: String}
    returns: Result(String, String)
    description: Execute vibeec gen command

  - name: can_auto_fix
    params: {violation: Violation}
    returns: Bool
    description: Check if violation can be automatically fixed

  - name: get_spec_for_file
    params: {gleam_file: String}
    returns: Option(String)
    description: Find corresponding spec file

  - name: default_fix_config
    params: {}
    returns: FixConfig
    description: Create default fix configuration

  - name: cleanup_backups
    params: {directory: String, keep_count: Int}
    returns: Result(Int, String)
    description: Remove old backup files, keeping most recent N

types:
  VibeecGenResult:
    success: Bool
    output: String
    error: Option(String)
    exit_code: Int

imports:
  - gleam/dict
  - gleam/list
  - gleam/string
  - gleam/result
  - gleam/option
  - simplifile
  - shellout

fix_strategies: |
  1. NoManualCode Violation:
     - Find corresponding .vibee spec
     - Create backup of current file
     - Run: vibeec gen --spec specs/X.vibee --output honeycomb/X.gleam
     - Validate: Re-scan for violations
     - If validation fails: Restore backup
  
  2. OutdatedCode Violation:
     - Same as NoManualCode (regenerate from spec)
  
  3. MissingSpec Violation:
     - Cannot auto-fix (requires human to write spec)
     - Suggest: vibeec init --from honeycomb/X.gleam --output specs/X.vibee
     - This would reverse-engineer a spec from existing code
  
  4. InvalidGeneration Violation:
     - Regenerate from spec
     - If spec is invalid: Report error, cannot fix

backup_strategy: |
  - Backup naming: {original}.backup.{unix_timestamp}
  - Keep last 5 backups per file
  - Cleanup old backups after successful fix
  - Store backups in same directory as original
  - Alternative: Store in .vibee/backups/ directory

validation_strategy: |
  1. After fix, re-run scanner on fixed file
  2. Check that original violation is gone
  3. Check that no new violations were introduced
  4. If validation fails:
     - Restore backup
     - Report error with details
     - Suggest manual intervention

error_handling: |
  - vibeec gen fails: Restore backup, report error
  - Backup creation fails: Abort fix, report error
  - Validation fails: Restore backup, report error
  - Spec not found: Cannot fix, report error
  - Permission denied: Cannot fix, report error

performance_notes: |
  - Batch fixes: Process multiple files in parallel
  - Backup compression: Use gzip for large files
  - Incremental validation: Only re-scan fixed files
  - Cache spec lookups: Build file->spec mapping once
  - Cleanup backups: Run async after successful fixes
