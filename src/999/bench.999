// ============================================
// 999BENCH - –ë–ï–ù–ß–ú–ê–†–ö –§–†–ï–ô–ú–í–û–†–ö
// ============================================
//
// –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:
//   - –ú–∏–∫—Ä–æ–±–µ–Ω—á–º–∞—Ä–∫–∏
//   - –°—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑
//   - –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–π
//   - –ü—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏
//   - Flamegraph –≥–µ–Ω–µ—Ä–∞—Ü–∏—è
//   - CI –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
//
// ============================================

‚≤® arifmetika

// ============================================
// –°–¢–†–£–ö–¢–£–†–´
// ============================================

‚≤é ‚≤Ç‚≤â‚≤õ‚≤•‚≤è‚≤ò‚≤Å‚≤£‚≤ï:
  –∏–º—è: ‚≤§
  –≥—Ä—É–ø–ø–∞: ‚≤§?
  —Ñ—É–Ω–∫—Ü–∏—è: ‚≤™()
  setup: ‚≤™()?
  teardown: ‚≤™()?
  –∏—Ç–µ—Ä–∞—Ü–∏–π: ‚≤ä?

‚≤é ‚≤Ç‚≤â‚≤õ‚≤•‚≤è‚≤¢‚≤â‚≤•‚≤©‚≤ó‚≤ß:
  –∏–º—è: ‚≤§
  –∏—Ç–µ—Ä–∞—Ü–∏–π: ‚≤ä
  –æ–±—â–µ–µ_–≤—Ä–µ–º—è: ‚≤ä      // –Ω—Å
  —Å—Ä–µ–¥–Ω–µ–µ: ‚≤ä          // –Ω—Å/–∏—Ç–µ—Ä–∞—Ü–∏—è
  –º–µ–¥–∏–∞–Ω–∞: ‚≤ä
  –º–∏–Ω: ‚≤ä
  –º–∞–∫—Å: ‚≤ä
  std_dev: ‚≤ä
  throughput: ‚≤ä?      // ops/sec
  –ø–∞–º—è—Ç—å: ‚≤Ç‚≤â‚≤õ‚≤•‚≤è‚≤ò‚≤â‚≤ô?

‚≤é ‚≤Ç‚≤â‚≤õ‚≤•‚≤è‚≤ò‚≤â‚≤ô:
  –≤—ã–¥–µ–ª–µ–Ω–æ: ‚≤ä         // –±–∞–π—Ç
  –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–æ: ‚≤ä
  –ø–∏–∫: ‚≤ä
  –∞–ª–ª–æ–∫–∞—Ü–∏–π: ‚≤ä

‚≤é ‚≤Ç‚≤â‚≤õ‚≤•‚≤è‚≤§‚≤©‚≤ì‚≤ß‚≤â:
  –∏–º—è: ‚≤§
  –±–µ–Ω—á–º–∞—Ä–∫–∏: [‚≤Ç‚≤â‚≤õ‚≤•‚≤è‚≤ò‚≤Å‚≤£‚≤ï]
  —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã: [‚≤Ç‚≤â‚≤õ‚≤•‚≤è‚≤¢‚≤â‚≤•‚≤©‚≤ó‚≤ß]

‚≤é ‚≤Ç‚≤â‚≤õ‚≤•‚≤è‚≤¢‚≤©‚≤õ‚≤õ‚≤â‚≤£:
  suites: [‚≤Ç‚≤â‚≤õ‚≤•‚≤è‚≤§‚≤©‚≤ì‚≤ß‚≤â]
  warmup_–∏—Ç–µ—Ä–∞—Ü–∏–π: ‚≤ä
  –∏–∑–º–µ—Ä–µ–Ω–∏–µ_–∏—Ç–µ—Ä–∞—Ü–∏–π: ‚≤ä
  –∏–∑–º–µ—Ä–µ–Ω–∏–µ_–≤—Ä–µ–º—è: ‚≤ä   // –º—Å
  –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞—Ç—å_–ø–∞–º—è—Ç—å: ‚≤Ç
  baseline: ‚≤§?         // –ø—É—Ç—å –∫ baseline

// ============================================
// –ò–ó–ú–ï–†–ï–ù–ò–ï
// ============================================

/// –ò–∑–º–µ—Ä–∏—Ç—å –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
‚≤™ –∏–∑–º–µ—Ä–∏—Ç—å(—Ñ—É–Ω–∫—Ü–∏—è: ‚≤™(), –∏—Ç–µ—Ä–∞—Ü–∏–π: ‚≤ä) -> [‚≤ä]:
  ‚≤ò –≤—Ä–µ–º–µ–Ω–∞: [‚≤ä] = []
  
  ‚≤Æ i 0..–∏—Ç–µ—Ä–∞—Ü–∏–π:
    ‚≤ò –Ω–∞—á–∞–ª–æ = –≤—Ä–µ–º—è_–Ω—Å()
    —Ñ—É–Ω–∫—Ü–∏—è()
    ‚≤ò –∫–æ–Ω–µ—Ü = –≤—Ä–µ–º—è_–Ω—Å()
    –≤—Ä–µ–º–µ–Ω–∞ += (–∫–æ–Ω–µ—Ü - –Ω–∞—á–∞–ª–æ)
  
  ‚≤¢ –≤—Ä–µ–º–µ–Ω–∞

/// –ò–∑–º–µ—Ä–∏—Ç—å —Å warmup
‚≤™ –∏–∑–º–µ—Ä–∏—Ç—å_—Å_warmup(–±–µ–Ω—á: ‚≤Ç‚≤â‚≤õ‚≤•‚≤è‚≤ò‚≤Å‚≤£‚≤ï, runner: ‚≤Ç‚≤â‚≤õ‚≤•‚≤è‚≤¢‚≤©‚≤õ‚≤õ‚≤â‚≤£) -> ‚≤Ç‚≤â‚≤õ‚≤•‚≤è‚≤¢‚≤â‚≤•‚≤©‚≤ó‚≤ß:
  // Setup
  ‚≤ú –±–µ–Ω—á.setup != None:
    –±–µ–Ω—á.setup()
  
  // Warmup
  ‚≤Æ i 0..runner.warmup_–∏—Ç–µ—Ä–∞—Ü–∏–π:
    –±–µ–Ω—á.—Ñ—É–Ω–∫—Ü–∏—è()
  
  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏—Ç–µ—Ä–∞—Ü–∏–π
  ‚≤ò –∏—Ç–µ—Ä–∞—Ü–∏–π = –±–µ–Ω—á.–∏—Ç–µ—Ä–∞—Ü–∏–π
  ‚≤ú –∏—Ç–µ—Ä–∞—Ü–∏–π == None:
    –∏—Ç–µ—Ä–∞—Ü–∏–π = –∫–∞–ª–∏–±—Ä–æ–≤–∞—Ç—å_–∏—Ç–µ—Ä–∞—Ü–∏–∏(–±–µ–Ω—á.—Ñ—É–Ω–∫—Ü–∏—è, runner.–∏–∑–º–µ—Ä–µ–Ω–∏–µ_–≤—Ä–µ–º—è)
  
  // –ò–∑–º–µ—Ä–µ–Ω–∏–µ
  ‚≤ò –≤—Ä–µ–º–µ–Ω–∞ = –∏–∑–º–µ—Ä–∏—Ç—å(–±–µ–Ω—á.—Ñ—É–Ω–∫—Ü–∏—è, –∏—Ç–µ—Ä–∞—Ü–∏–π)
  
  // –ü–∞–º—è—Ç—å
  ‚≤ò –ø–∞–º—è—Ç—å: ‚≤Ç‚≤â‚≤õ‚≤•‚≤è‚≤ò‚≤â‚≤ô? = None
  ‚≤ú runner.–ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞—Ç—å_–ø–∞–º—è—Ç—å:
    –ø–∞–º—è—Ç—å = –∏–∑–º–µ—Ä–∏—Ç—å_–ø–∞–º—è—Ç—å(–±–µ–Ω—á.—Ñ—É–Ω–∫—Ü–∏—è)
  
  // Teardown
  ‚≤ú –±–µ–Ω—á.teardown != None:
    –±–µ–Ω—á.teardown()
  
  // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
  ‚≤¢ –≤—ã—á–∏—Å–ª–∏—Ç—å_—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É(–±–µ–Ω—á.–∏–º—è, –≤—Ä–µ–º–µ–Ω–∞, –ø–∞–º—è—Ç—å)

/// –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ –∏—Ç–µ—Ä–∞—Ü–∏–π –¥–ª—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Ü–µ–ª–µ–≤–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
‚≤™ –∫–∞–ª–∏–±—Ä–æ–≤–∞—Ç—å_–∏—Ç–µ—Ä–∞—Ü–∏–∏(—Ñ—É–Ω–∫—Ü–∏—è: ‚≤™(), —Ü–µ–ª–µ–≤–æ–µ_–≤—Ä–µ–º—è_–º—Å: ‚≤ä) -> ‚≤ä:
  // –ü—Ä–æ–±–Ω—ã–π –∑–∞–ø—É—Å–∫
  ‚≤ò –Ω–∞—á–∞–ª–æ = –≤—Ä–µ–º—è_–Ω—Å()
  ‚≤Æ i 0..10:
    —Ñ—É–Ω–∫—Ü–∏—è()
  ‚≤ò –≤—Ä–µ–º—è_10 = –≤—Ä–µ–º—è_–Ω—Å() - –Ω–∞—á–∞–ª–æ
  
  ‚≤ò –≤—Ä–µ–º—è_–æ–¥–Ω–æ–π = –≤—Ä–µ–º—è_10 / 10
  ‚≤ò —Ü–µ–ª–µ–≤–æ–µ_–Ω—Å = —Ü–µ–ª–µ–≤–æ–µ_–≤—Ä–µ–º—è_–º—Å * 1000000
  
  ‚≤ò –∏—Ç–µ—Ä–∞—Ü–∏–π = —Ü–µ–ª–µ–≤–æ–µ_–Ω—Å / –≤—Ä–µ–º—è_–æ–¥–Ω–æ–π
  ‚≤¢ –º–∞–∫—Å(100, –º–∏–Ω(–∏—Ç–µ—Ä–∞—Ü–∏–π, 10000000))

// ============================================
// –°–¢–ê–¢–ò–°–¢–ò–ö–ê
// ============================================

‚≤™ –≤—ã—á–∏—Å–ª–∏—Ç—å_—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É(–∏–º—è: ‚≤§, –≤—Ä–µ–º–µ–Ω–∞: [‚≤ä], –ø–∞–º—è—Ç—å: ‚≤Ç‚≤â‚≤õ‚≤•‚≤è‚≤ò‚≤â‚≤ô?) -> ‚≤Ç‚≤â‚≤õ‚≤•‚≤è‚≤¢‚≤â‚≤•‚≤©‚≤ó‚≤ß:
  ‚≤ò –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ = –≤—Ä–µ–º–µ–Ω–∞.sorted()
  ‚≤ò n = –¥–ª–∏–Ω–∞(–≤—Ä–µ–º–µ–Ω–∞)
  
  ‚≤ò —Å—É–º–º–∞ = 0
  ‚≤Æ t –≤—Ä–µ–º–µ–Ω–∞:
    —Å—É–º–º–∞ += t
  ‚≤ò —Å—Ä–µ–¥–Ω–µ–µ = —Å—É–º–º–∞ / n
  
  ‚≤ò –º–µ–¥–∏–∞–Ω–∞ = –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ[n / 2]
  ‚≤ò –º–∏–Ω = –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ[0]
  ‚≤ò –º–∞–∫—Å = –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ[n - 1]
  
  // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ
  ‚≤ò —Å—É–º–º–∞_–∫–≤–∞–¥—Ä–∞—Ç–æ–≤ = 0
  ‚≤Æ t –≤—Ä–µ–º–µ–Ω–∞:
    —Å—É–º–º–∞_–∫–≤–∞–¥—Ä–∞—Ç–æ–≤ += (t - —Å—Ä–µ–¥–Ω–µ–µ) * (t - —Å—Ä–µ–¥–Ω–µ–µ)
  ‚≤ò std_dev = sqrt(—Å—É–º–º–∞_–∫–≤–∞–¥—Ä–∞—Ç–æ–≤ / n)
  
  // Throughput
  ‚≤ò throughput = 1000000000 / —Å—Ä–µ–¥–Ω–µ–µ  // ops/sec
  
  ‚≤¢ ‚≤Ç‚≤â‚≤õ‚≤•‚≤è‚≤¢‚≤â‚≤•‚≤©‚≤ó‚≤ß {
    –∏–º—è: –∏–º—è,
    –∏—Ç–µ—Ä–∞—Ü–∏–π: n,
    –æ–±—â–µ–µ_–≤—Ä–µ–º—è: —Å—É–º–º–∞,
    —Å—Ä–µ–¥–Ω–µ–µ: —Å—Ä–µ–¥–Ω–µ–µ,
    –º–µ–¥–∏–∞–Ω–∞: –º–µ–¥–∏–∞–Ω–∞,
    –º–∏–Ω: –º–∏–Ω,
    –º–∞–∫—Å: –º–∞–∫—Å,
    std_dev: std_dev,
    throughput: throughput,
    –ø–∞–º—è—Ç—å: –ø–∞–º—è—Ç—å
  }

// ============================================
// –°–†–ê–í–ù–ï–ù–ò–ï
// ============================================

‚≤é ‚≤Ç‚≤â‚≤õ‚≤•‚≤è‚≤î‚≤ü‚≤ô‚≤°‚≤Å‚≤£‚≤â:
  –∏–º—è: ‚≤§
  baseline: ‚≤Ç‚≤â‚≤õ‚≤•‚≤è‚≤¢‚≤â‚≤•‚≤©‚≤ó‚≤ß
  —Ç–µ–∫—É—â–∏–π: ‚≤Ç‚≤â‚≤õ‚≤•‚≤è‚≤¢‚≤â‚≤•‚≤©‚≤ó‚≤ß
  –∏–∑–º–µ–Ω–µ–Ω–∏–µ: ‚≤ä         // –ø—Ä–æ—Ü–µ–Ω—Ç
  —Ä–µ–≥—Ä–µ—Å—Å–∏—è: ‚≤Ç

‚≤™ —Å—Ä–∞–≤–Ω–∏—Ç—å_—Å_baseline(—Ç–µ–∫—É—â–∏–µ: [‚≤Ç‚≤â‚≤õ‚≤•‚≤è‚≤¢‚≤â‚≤•‚≤©‚≤ó‚≤ß], baseline_–ø—É—Ç—å: ‚≤§) -> [‚≤Ç‚≤â‚≤õ‚≤•‚≤è‚≤î‚≤ü‚≤ô‚≤°‚≤Å‚≤£‚≤â]:
  ‚≤ò baseline = –∑–∞–≥—Ä—É–∑–∏—Ç—å_baseline(baseline_–ø—É—Ç—å)
  ‚≤ò —Å—Ä–∞–≤–Ω–µ–Ω–∏—è: [‚≤Ç‚≤â‚≤õ‚≤•‚≤è‚≤î‚≤ü‚≤ô‚≤°‚≤Å‚≤£‚≤â] = []
  
  ‚≤Æ —Ç–µ–∫—É—â–∏–π —Ç–µ–∫—É—â–∏–µ:
    ‚≤ò base = baseline.filter(b -> b.–∏–º—è == —Ç–µ–∫—É—â–∏–π.–∏–º—è).first()
    ‚≤ú base != None:
      ‚≤ò –∏–∑–º–µ–Ω–µ–Ω–∏–µ = ((—Ç–µ–∫—É—â–∏–π.—Å—Ä–µ–¥–Ω–µ–µ - base.—Å—Ä–µ–¥–Ω–µ–µ) / base.—Å—Ä–µ–¥–Ω–µ–µ) * 100
      —Å—Ä–∞–≤–Ω–µ–Ω–∏—è += ‚≤Ç‚≤â‚≤õ‚≤•‚≤è‚≤î‚≤ü‚≤ô‚≤°‚≤Å‚≤£‚≤â {
        –∏–º—è: —Ç–µ–∫—É—â–∏–π.–∏–º—è,
        baseline: base,
        —Ç–µ–∫—É—â–∏–π: —Ç–µ–∫—É—â–∏–π,
        –∏–∑–º–µ–Ω–µ–Ω–∏–µ: –∏–∑–º–µ–Ω–µ–Ω–∏–µ,
        —Ä–µ–≥—Ä–µ—Å—Å–∏—è: –∏–∑–º–µ–Ω–µ–Ω–∏–µ > 5  // >5% –∑–∞–º–µ–¥–ª–µ–Ω–∏–µ = —Ä–µ–≥—Ä–µ—Å—Å–∏—è
      }
  
  ‚≤¢ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è

// ============================================
// –í–´–í–û–î
// ============================================

‚≤™ –ø–µ—á–∞—Ç–∞—Ç—å_—Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã(—Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã: [‚≤Ç‚≤â‚≤õ‚≤•‚≤è‚≤¢‚≤â‚≤•‚≤©‚≤ó‚≤ß]):
  –ø–µ—á–∞—Ç—å("\n" + "‚ïê".repeat(80))
  –ø–µ—á–∞—Ç—å(—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å_–∑–∞–≥–æ–ª–æ–≤–æ–∫())
  –ø–µ—á–∞—Ç—å("‚îÄ".repeat(80))
  
  ‚≤Æ —Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:
    –ø–µ—á–∞—Ç—å(—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å_—Ä–µ–∑—É–ª—å—Ç–∞—Ç(—Ä))
  
  –ø–µ—á–∞—Ç—å("‚ïê".repeat(80))

‚≤™ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å_–∑–∞–≥–æ–ª–æ–≤–æ–∫() -> ‚≤§:
  ‚≤¢ –ø–∞–¥–¥–∏–Ω–≥("Benchmark", 30) + 
     –ø–∞–¥–¥–∏–Ω–≥("Time/op", 15) + 
     –ø–∞–¥–¥–∏–Ω–≥("Ops/sec", 15) + 
     –ø–∞–¥–¥–∏–Ω–≥("¬±%", 10)

‚≤™ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å_—Ä–µ–∑—É–ª—å—Ç–∞—Ç(—Ä: ‚≤Ç‚≤â‚≤õ‚≤•‚≤è‚≤¢‚≤â‚≤•‚≤©‚≤ó‚≤ß) -> ‚≤§:
  ‚≤ò –≤—Ä–µ–º—è = —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å_–≤—Ä–µ–º—è(—Ä.—Å—Ä–µ–¥–Ω–µ–µ)
  ‚≤ò ops = —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å_—á–∏—Å–ª–æ(—Ä.throughput)
  ‚≤ò –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ = —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å_–ø—Ä–æ—Ü–µ–Ω—Ç(—Ä.std_dev / —Ä.—Å—Ä–µ–¥–Ω–µ–µ * 100)
  
  ‚≤¢ –ø–∞–¥–¥–∏–Ω–≥(—Ä.–∏–º—è, 30) + 
     –ø–∞–¥–¥–∏–Ω–≥(–≤—Ä–µ–º—è, 15) + 
     –ø–∞–¥–¥–∏–Ω–≥(ops, 15) + 
     –ø–∞–¥–¥–∏–Ω–≥(–æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ, 10)

‚≤™ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å_–≤—Ä–µ–º—è(–Ω—Å: ‚≤ä) -> ‚≤§:
  ‚≤ú –Ω—Å < 1000:
    ‚≤¢ —Å—Ç—Ä–æ–∫–∞(–Ω—Å) + " ns"
  ‚≤ú –Ω—Å < 1000000:
    ‚≤¢ —Å—Ç—Ä–æ–∫–∞(–Ω—Å / 1000) + " ¬µs"
  ‚≤ú –Ω—Å < 1000000000:
    ‚≤¢ —Å—Ç—Ä–æ–∫–∞(–Ω—Å / 1000000) + " ms"
  ‚≤¢ —Å—Ç—Ä–æ–∫–∞(–Ω—Å / 1000000000) + " s"

‚≤™ –ø–µ—á–∞—Ç–∞—Ç—å_—Å—Ä–∞–≤–Ω–µ–Ω–∏–µ(—Å—Ä–∞–≤–Ω–µ–Ω–∏—è: [‚≤Ç‚≤â‚≤õ‚≤•‚≤è‚≤î‚≤ü‚≤ô‚≤°‚≤Å‚≤£‚≤â]):
  –ø–µ—á–∞—Ç—å("\nüìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å baseline:\n")
  
  ‚≤Æ —Å —Å—Ä–∞–≤–Ω–µ–Ω–∏—è:
    ‚≤ò —Å–∏–º–≤–æ–ª = ‚≤ú —Å.–∏–∑–º–µ–Ω–µ–Ω–∏–µ < -5: "üöÄ" ‚≤ú —Å.–∏–∑–º–µ–Ω–µ–Ω–∏–µ > 5: "üêå" ‚≤Ç: "‚û°Ô∏è"
    ‚≤ò —Ü–≤–µ—Ç = ‚≤ú —Å.–∏–∑–º–µ–Ω–µ–Ω–∏–µ < 0: "–∑–µ–ª—ë–Ω—ã–π" ‚≤ú —Å.–∏–∑–º–µ–Ω–µ–Ω–∏–µ > 5: "–∫—Ä–∞—Å–Ω—ã–π" ‚≤Ç: "–∂—ë–ª—Ç—ã–π"
    
    –ø–µ—á–∞—Ç—å(—Å–∏–º–≤–æ–ª + " " + —Å.–∏–º—è + ": " + —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å_–ø—Ä–æ—Ü–µ–Ω—Ç(—Å.–∏–∑–º–µ–Ω–µ–Ω–∏–µ))

// ============================================
// JSON –í–´–í–û–î
// ============================================

‚≤™ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å_json(—Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã: [‚≤Ç‚≤â‚≤õ‚≤•‚≤è‚≤¢‚≤â‚≤•‚≤©‚≤ó‚≤ß]) -> ‚≤§:
  ‚≤ò json = "{\n  \"benchmarks\": [\n"
  
  ‚≤Æ i 0..–¥–ª–∏–Ω–∞(—Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã):
    ‚≤ò —Ä = —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã[i]
    json += "    {\n"
    json += "      \"name\": \"" + —Ä.–∏–º—è + "\",\n"
    json += "      \"iterations\": " + —Å—Ç—Ä–æ–∫–∞(—Ä.–∏—Ç–µ—Ä–∞—Ü–∏–π) + ",\n"
    json += "      \"mean_ns\": " + —Å—Ç—Ä–æ–∫–∞(—Ä.—Å—Ä–µ–¥–Ω–µ–µ) + ",\n"
    json += "      \"median_ns\": " + —Å—Ç—Ä–æ–∫–∞(—Ä.–º–µ–¥–∏–∞–Ω–∞) + ",\n"
    json += "      \"min_ns\": " + —Å—Ç—Ä–æ–∫–∞(—Ä.–º–∏–Ω) + ",\n"
    json += "      \"max_ns\": " + —Å—Ç—Ä–æ–∫–∞(—Ä.–º–∞–∫—Å) + ",\n"
    json += "      \"std_dev\": " + —Å—Ç—Ä–æ–∫–∞(—Ä.std_dev) + ",\n"
    json += "      \"throughput\": " + —Å—Ç—Ä–æ–∫–∞(—Ä.throughput) + "\n"
    json += "    }" + (‚≤ú i < –¥–ª–∏–Ω–∞(—Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã) - 1: "," ‚≤Ç: "") + "\n"
  
  json += "  ]\n}"
  ‚≤¢ json

// ============================================
// RUNNER
// ============================================

‚≤™ —Å–æ–∑–¥–∞—Ç—å_runner() -> ‚≤Ç‚≤â‚≤õ‚≤•‚≤è‚≤¢‚≤©‚≤õ‚≤õ‚≤â‚≤£:
  ‚≤¢ ‚≤Ç‚≤â‚≤õ‚≤•‚≤è‚≤¢‚≤©‚≤õ‚≤õ‚≤â‚≤£ {
    suites: [],
    warmup_–∏—Ç–µ—Ä–∞—Ü–∏–π: 100,
    –∏–∑–º–µ—Ä–µ–Ω–∏–µ_–∏—Ç–µ—Ä–∞—Ü–∏–π: 0,  // –∞–≤—Ç–æ
    –∏–∑–º–µ—Ä–µ–Ω–∏–µ_–≤—Ä–µ–º—è: 1000,  // 1 —Å–µ–∫—É–Ω–¥–∞
    –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞—Ç—å_–ø–∞–º—è—Ç—å: ‚≤Ç,
    baseline: None
  }

‚≤™ –∑–∞–ø—É—Å—Ç–∏—Ç—å_–±–µ–Ω—á–º–∞—Ä–∫–∏(runner: ‚≤Ç‚≤â‚≤õ‚≤•‚≤è‚≤¢‚≤©‚≤õ‚≤õ‚≤â‚≤£) -> [‚≤Ç‚≤â‚≤õ‚≤•‚≤è‚≤¢‚≤â‚≤•‚≤©‚≤ó‚≤ß]:
  ‚≤ò –≤—Å–µ_—Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã: [‚≤Ç‚≤â‚≤õ‚≤•‚≤è‚≤¢‚≤â‚≤•‚≤©‚≤ó‚≤ß] = []
  
  ‚≤Æ suite runner.suites:
    –ø–µ—á–∞—Ç—å("\nüì¶ " + suite.–∏–º—è + "\n")
    
    ‚≤Æ –±–µ–Ω—á suite.–±–µ–Ω—á–º–∞—Ä–∫–∏:
      –ø–µ—á–∞—Ç—å("  ‚è±Ô∏è  " + –±–µ–Ω—á.–∏–º—è + "...")
      ‚≤ò —Ä–µ–∑—É–ª—å—Ç–∞—Ç = –∏–∑–º–µ—Ä–∏—Ç—å_—Å_warmup(–±–µ–Ω—á, runner)
      suite.—Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã += —Ä–µ–∑—É–ª—å—Ç–∞—Ç
      –≤—Å–µ_—Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã += —Ä–µ–∑—É–ª—å—Ç–∞—Ç
      –ø–µ—á–∞—Ç—å("  ‚úì " + —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å_–≤—Ä–µ–º—è(—Ä–µ–∑—É–ª—å—Ç–∞—Ç.—Å—Ä–µ–¥–Ω–µ–µ) + "/op")
  
  ‚≤¢ –≤—Å–µ_—Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

// ============================================
// CLI
// ============================================

‚≤™ main(–∞—Ä–≥—É–º–µ–Ω—Ç—ã: [‚≤§]) -> ‚≤ä:
  ‚≤ò runner = —Å–æ–∑–¥–∞—Ç—å_runner()
  ‚≤ò –ø—É—Ç—å = "benches"
  ‚≤ò json_–≤—ã—Ö–æ–¥: ‚≤§? = None
  ‚≤ò —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å_baseline = ‚≤Ç
  
  // –ü–∞—Ä—Å–∏–Ω–≥ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤
  ‚≤Æ i 1..–¥–ª–∏–Ω–∞(–∞—Ä–≥—É–º–µ–Ω—Ç—ã):
    ‚≤ò –∞—Ä–≥ = –∞—Ä–≥—É–º–µ–Ω—Ç—ã[i]
    ‚≤ú –∞—Ä–≥ == "--memory": runner.–ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞—Ç—å_–ø–∞–º—è—Ç—å = ‚≤Ä
    ‚≤ú –∞—Ä–≥ == "--json" && i + 1 < –¥–ª–∏–Ω–∞(–∞—Ä–≥—É–º–µ–Ω—Ç—ã):
      json_–≤—ã—Ö–æ–¥ = –∞—Ä–≥—É–º–µ–Ω—Ç—ã[i + 1]
    ‚≤ú –∞—Ä–≥ == "--baseline" && i + 1 < –¥–ª–∏–Ω–∞(–∞—Ä–≥—É–º–µ–Ω—Ç—ã):
      runner.baseline = –∞—Ä–≥—É–º–µ–Ω—Ç—ã[i + 1]
    ‚≤ú –∞—Ä–≥ == "--save-baseline":
      —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å_baseline = ‚≤Ä
    ‚≤ú –∞—Ä–≥ == "--warmup" && i + 1 < –¥–ª–∏–Ω–∞(–∞—Ä–≥—É–º–µ–Ω—Ç—ã):
      runner.warmup_–∏—Ç–µ—Ä–∞—Ü–∏–π = —á–∏—Å–ª–æ(–∞—Ä–≥—É–º–µ–Ω—Ç—ã[i + 1])
    ‚≤ú !–∞—Ä–≥.starts_with("-"):
      –ø—É—Ç—å = –∞—Ä–≥
  
  –ø–µ—á–∞—Ç—å("‚ö° 999bench - –ë–µ–Ω—á–º–∞—Ä–∫ —Ñ—Ä–µ–π–º–≤–æ—Ä–∫\n")
  
  // –ù–∞—Ö–æ–¥–∏–º –±–µ–Ω—á–º–∞—Ä–∫–∏
  ‚≤ò —Ñ–∞–π–ª—ã = –Ω–∞–π—Ç–∏_—Ñ–∞–π–ª—ã(–ø—É—Ç—å, "*_bench.999")
  ‚≤Æ —Ñ–∞–π–ª —Ñ–∞–π–ª—ã:
    ‚≤ò suite = –∑–∞–≥—Ä—É–∑–∏—Ç—å_bench_suite(—Ñ–∞–π–ª)
    runner.suites += suite
  
  // –ó–∞–ø—É—Å–∫–∞–µ–º
  ‚≤ò —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã = –∑–∞–ø—É—Å—Ç–∏—Ç—å_–±–µ–Ω—á–º–∞—Ä–∫–∏(runner)
  
  // –í—ã–≤–æ–¥
  –ø–µ—á–∞—Ç–∞—Ç—å_—Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã(—Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã)
  
  // –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å baseline
  ‚≤ú runner.baseline != None:
    ‚≤ò —Å—Ä–∞–≤–Ω–µ–Ω–∏—è = —Å—Ä–∞–≤–Ω–∏—Ç—å_—Å_baseline(—Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã, runner.baseline)
    –ø–µ—á–∞—Ç–∞—Ç—å_—Å—Ä–∞–≤–Ω–µ–Ω–∏–µ(—Å—Ä–∞–≤–Ω–µ–Ω–∏—è)
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–≥—Ä–µ—Å—Å–∏–∏
    ‚≤ò —Ä–µ–≥—Ä–µ—Å—Å–∏–∏ = —Å—Ä–∞–≤–Ω–µ–Ω–∏—è.filter(—Å -> —Å.—Ä–µ–≥—Ä–µ—Å—Å–∏—è)
    ‚≤ú –¥–ª–∏–Ω–∞(—Ä–µ–≥—Ä–µ—Å—Å–∏–∏) > 0:
      –ø–µ—á–∞—Ç—å("\n‚ö†Ô∏è  –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã —Ä–µ–≥—Ä–µ—Å—Å–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏!")
      ‚≤¢ 1
  
  // JSON –≤—ã–≤–æ–¥
  ‚≤ú json_–≤—ã—Ö–æ–¥ != None:
    ‚≤ò json = —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å_json(—Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã)
    –∑–∞–ø–∏—Å–∞—Ç—å_—Ñ–∞–π–ª(json_–≤—ã—Ö–æ–¥, json)
    –ø–µ—á–∞—Ç—å("\nüìÑ JSON —Å–æ—Ö—Ä–∞–Ω—ë–Ω: " + json_–≤—ã—Ö–æ–¥)
  
  // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ baseline
  ‚≤ú —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å_baseline:
    ‚≤ò json = —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å_json(—Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã)
    –∑–∞–ø–∏—Å–∞—Ç—å_—Ñ–∞–π–ª(".999/baseline.json", json)
    –ø–µ—á–∞—Ç—å("\nüìå Baseline —Å–æ—Ö—Ä–∞–Ω—ë–Ω")
  
  ‚≤¢ 0
