# Anti-Duplication Rules for VIBEE Plugins
# Enforces unique logic across plugin ecosystem

[general]
# Enable duplication checking
enabled = true

# Enforcement level: "warning" | "error" | "strict"
# - warning: Log only, don't block
# - error: Block commits with >threshold similarity
# - strict: Block any similarity >70%, no overrides
enforcement_level = "error"

# Scan paths
scan_paths = [
  "honeycomb/*/src/**/*.vibee",
  "honeycomb/*/src/**/*.gleam",
]

# Exclude paths
exclude_paths = [
  "honeycomb/*/test/**",
  "honeycomb/*/docs/**",
  "honeycomb/*/.archive/**",
  "honeycomb/*/examples/**",
]

[similarity]
# Token-based similarity threshold (0.0 - 1.0)
# Files with >threshold similarity are flagged
token_threshold = 0.80

# AST-based similarity threshold
ast_threshold = 0.75

# Function signature similarity
signature_threshold = 0.90

# Minimum lines to check (ignore small functions)
min_lines = 10

# Normalize before comparison
normalize_whitespace = true
normalize_comments = true
normalize_variable_names = false  # Keep var names for accuracy

[exports]
# Prevent duplicate exports across plugins
unique_exports = true

# Allow re-exports (import X; pub use X)
allow_reexports = true

# Check export signatures, not just names
check_signatures = true

# Exceptions for common names
common_export_names = [
  "init",
  "start",
  "stop",
  "main",
  "run",
]

[imports]
# Detect circular dependencies
detect_circular = true

# Max import depth (prevent deep chains)
max_import_depth = 5

# Warn on unused imports
warn_unused = true

# Detect shadowed imports
detect_shadowing = true

[patterns]
# Blacklist file patterns (block these)
blacklist = [
  "*_legacy*",
  "*_old*",
  "*_backup*",
  "*_copy*",
  "*_v1*",
  "*_v2*",
  "*.bak",
  "*.tmp",
]

# Whitelist patterns (always allow)
whitelist = [
  "*/test_helpers.vibee",
  "*/test_utils.vibee",
  "*/common/*.vibee",
  "*/shared/*.vibee",
]

[categories]
# Allow same function names in different categories
allow_same_name_different_category = true

# Category definitions
[categories.telegram]
path = "honeycomb/telegram/**"
allowed_duplicates = []

[categories.ai]
path = "honeycomb/ai/**"
allowed_duplicates = ["generate"]  # AI plugins can have generate()

[categories.mcp]
path = "honeycomb/mcp/**"
allowed_duplicates = []

[categories.payment]
path = "honeycomb/payment/**"
allowed_duplicates = ["process", "validate"]

[reporting]
# Report format: "text" | "json" | "markdown"
format = "markdown"

# Output file
output_file = "honeycomb/.dedup_report.md"

# Include similarity scores in report
include_scores = true

# Include code snippets
include_snippets = true

# Max snippets per duplicate
max_snippets = 3

# Snippet context lines
snippet_context = 2

[ci]
# Fail CI on duplicates
fail_on_duplicates = true

# Comment on PRs
comment_on_pr = true

# Create GitHub issue for duplicates
create_issue = false

# Assignees for issues
issue_assignees = ["team_lead"]

# Labels for issues
issue_labels = ["code-quality", "duplication"]

[metrics]
# Track metrics over time
enabled = true

# Metrics file
metrics_file = "honeycomb/.dedup_metrics.json"

# Metrics to track
track = [
  "total_plugins",
  "total_files",
  "duplicates_found",
  "avg_similarity",
  "max_similarity",
  "whitelist_usage",
]

[auto_fix]
# Attempt to auto-fix duplicates
enabled = false  # Disabled by default (dangerous)

# Auto-fix strategies
strategies = [
  "extract_common",    # Extract to common module
  "remove_duplicate",  # Remove exact duplicates
  "suggest_refactor",  # Suggest refactoring
]

# Require approval for auto-fixes
require_approval = true

[notifications]
# Notify on duplicates found
enabled = true

# Notification channels
channels = [
  "slack",
  "email",
]

# Slack webhook
slack_webhook = "${SLACK_WEBHOOK_URL}"

# Email recipients
email_recipients = [
  "dev-team@vibee.dev",
]

# Notification threshold (only notify if >threshold)
threshold = 0.85

[exceptions]
# Manual exceptions (intentional duplicates)
# Format: [[exceptions.item]]
#         file1 = "path/to/file1.vibee"
#         file2 = "path/to/file2.vibee"
#         reason = "Explanation"
#         approved_by = "username"
#         expires = "2026-12-31"

[[exceptions.item]]
file1 = "honeycomb/telegram/telegram_bot/src/core/types.vibee"
file2 = "honeycomb/telegram/telegram_bot/src/handlers/types.vibee"
reason = "Different type domains (core vs handlers)"
approved_by = "system"
expires = "2026-06-01"

[[exceptions.item]]
pattern = "*/test/*"
reason = "Test utilities can duplicate"
approved_by = "auto"
expires = "never"

[[exceptions.item]]
pattern = "*/examples/*"
reason = "Examples can duplicate for clarity"
approved_by = "auto"
expires = "never"

[advanced]
# Use ML-based semantic similarity
use_ml_similarity = false  # Requires model download

# ML model path
ml_model_path = "models/codebert"

# ML similarity threshold
ml_threshold = 0.85

# Use graph-based analysis
use_graph_analysis = true

# Graph similarity threshold
graph_threshold = 0.80

# Cache analysis results
cache_enabled = true
cache_ttl = 3600  # seconds

# Parallel processing
parallel = true
max_workers = 4
