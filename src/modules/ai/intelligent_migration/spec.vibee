name: ai_intelligent_migration
version: 1.0.0
description: Умная миграция кода V1→V2 с помощью AI - понимает контекст и семантику

metadata:
  author: VIBEE Team
  category: ai_migration
  tags: [ai, migration, semantic-analysis, context-aware]
  created: 2024-01-10

types:
  MigrationContext:
    file_path: string
    v1_code: string
    dependencies: list<string>
    usage_patterns: list<UsagePattern>
    business_logic: string
    
  UsagePattern:
    pattern_type: string
    frequency: number
    locations: list<Location>
    
  Location:
    file: string
    line: number
    
  MigrationStrategy:
    strategy_id: string
    name: string
    description: string
    confidence: number
    steps: list<MigrationStep>
    estimated_time: number
    risk_level: string
    
  MigrationStep:
    step_id: string
    action: string
    code_before: string
    code_after: string
    explanation: string
    
  MigrationResult:
    success: boolean
    v2_code: string
    changes_made: list<Change>
    warnings: list<string>
    metrics: MigrationMetrics
    
  Change:
    type: string
    location: Location
    description: string
    impact: string
    
  MigrationMetrics:
    lines_reduced: number
    complexity_reduced: number
    readability_improved: number
    performance_impact: number

constants:
  MIGRATION_STRATEGIES:
    conservative:
      description: "Минимальные изменения, максимальная безопасность"
      confidence_threshold: 0.95
      risk_level: "low"
      auto_apply: true
      
    balanced:
      description: "Баланс между улучшениями и безопасностью"
      confidence_threshold: 0.85
      risk_level: "medium"
      auto_apply: false
      
    aggressive:
      description: "Максимальные улучшения, требует review"
      confidence_threshold: 0.75
      risk_level: "high"
      auto_apply: false

  AI_PROMPTS:
    analyze_code: |
      Ты - эксперт по миграции VIBEE кода с V1 на V2.
      
      Код V1:
      ```vibee
      {v1_code}
      ```
      
      Контекст:
      - Файл: {file_path}
      - Зависимости: {dependencies}
      - Бизнес-логика: {business_logic}
      
      Задача: Проанализируй код и предложи стратегию миграции.
      
      Учитывай:
      1. Семантику кода (что он делает)
      2. Паттерны использования
      3. Зависимости между модулями
      4. Бизнес-логику
      5. Риски изменений
      
      Формат ответа:
      Стратегия: <conservative/balanced/aggressive>
      Уверенность: <0-1>
      Шаги:
      1. <описание шага>
         До: <код>
         После: <код>
         Объяснение: <почему>
      
      Риски: <список рисков>
      Метрики: <ожидаемые улучшения>
      
    semantic_migration: |
      Ты - эксперт по семантическому анализу кода.
      
      Задача: Мигрировать код, сохраняя семантику.
      
      Код V1:
      ```vibee
      {v1_code}
      ```
      
      Требования:
      - Сохранить точную семантику
      - Использовать V2 синтаксис
      - Улучшить читаемость
      - Оптимизировать производительность
      
      Проверь:
      - Все edge cases обработаны
      - Типы корректны
      - Ошибки обрабатываются
      - Тесты пройдут
      
      Формат ответа:
      ```vibee
      <мигрированный код V2>
      ```
      
      Изменения:
      - <список изменений>
      
      Гарантии:
      - Семантика: <сохранена/изменена>
      - Тесты: <пройдут/требуют обновления>
      - Производительность: <улучшена/без изменений>
      
    context_aware_migration: |
      Ты - эксперт по контекстно-зависимой миграции.
      
      Целевой код:
      ```vibee
      {target_code}
      ```
      
      Контекст использования:
      {usage_context}
      
      Зависимые модули:
      {dependent_modules}
      
      Задача: Мигрировать с учетом всего контекста.
      
      Учитывай:
      - Как код используется в других местах
      - Какие модули зависят от него
      - Какие изменения потребуются в зависимых модулях
      - Порядок миграции модулей
      
      Формат ответа:
      План миграции:
      1. Модуль: <имя>
         Изменения: <описание>
         Зависимости: <список>
      
      Порядок выполнения: <последовательность>
      Риски: <анализ рисков>

behaviors:
  analyze_migration:
    input:
      context: MigrationContext
      strategy_preference: string
    output:
      strategy: MigrationStrategy
    description: Анализ кода и выбор стратегии миграции
    steps:
      - Проанализировать код с помощью AI
      - Определить паттерны использования
      - Оценить риски
      - Выбрать стратегию
      - Сгенерировать план миграции
      - Вернуть стратегию
      
  migrate_with_ai:
    input:
      context: MigrationContext
      strategy: MigrationStrategy
    output: MigrationResult
    description: Умная миграция с AI
    steps:
      - Отправить код на анализ AI
      - Получить мигрированный код
      - Валидировать семантику
      - Проверить синтаксис
      - Запустить тесты
      - Собрать метрики
      - Вернуть результат
      
  validate_semantics:
    input:
      v1_code: string
      v2_code: string
      test_cases: list<TestCase>
    output:
      equivalent: boolean
      differences: list<string>
    description: Проверка семантической эквивалентности
    steps:
      - Скомпилировать обе версии
      - Запустить тесты на обеих
      - Сравнить результаты
      - Проверить edge cases
      - Вернуть результат
      
  migrate_module:
    input:
      module_path: string
      dependencies: list<string>
    output:
      migrated_modules: list<MigrationResult>
    description: Миграция модуля с зависимостями
    steps:
      - Построить граф зависимостей
      - Определить порядок миграции
      - Мигрировать каждый модуль
      - Обновить зависимости
      - Валидировать интеграцию
      - Вернуть результаты
      
  suggest_improvements:
    input:
      migrated_code: string
    output:
      improvements: list<Suggestion>
    description: Предложения по улучшению после миграции
    steps:
      - Проанализировать мигрированный код
      - Найти возможности для улучшения
      - Сгенерировать suggestions
      - Оценить impact
      - Вернуть improvements

functions:
  - name: build_dependency_graph
    params:
      module_path: string
    returns: DependencyGraph
    description: Построение графа зависимостей
    
  - name: analyze_usage_patterns
    params:
      code: string
      codebase: string
    returns: list<UsagePattern>
    description: Анализ паттернов использования
    
  - name: estimate_migration_time
    params:
      strategy: MigrationStrategy
      code_size: number
    returns: number
    description: Оценка времени миграции
    
  - name: calculate_risk_score
    params:
      changes: list<Change>
      dependencies: list<string>
    returns: number
    description: Расчет риска изменений

tests:
  - name: analyze_simple_function
    behavior: analyze_migration
    input:
      context:
        v1_code: "pub fn add(a: Int, b: Int) -> Int { a + b }"
        dependencies: []
      strategy_preference: "balanced"
    expected:
      strategy.confidence: > 0.9
      strategy.risk_level: "low"
      strategy.steps: length > 0
      
  - name: migrate_with_context
    behavior: migrate_with_ai
    input:
      context:
        v1_code: |
          pub fn process(data: String) -> Result(String, String) {
            case validate(data) {
              Ok(valid) -> Ok(transform(valid))
              Error(e) -> Error(e)
            }
          }
        business_logic: "Validates and transforms user input"
      strategy:
        strategy_id: "balanced"
    expected:
      success: true
      v2_code: contains("validate(data)? |> transform")
      metrics.lines_reduced: > 0
      
  - name: validate_semantic_equivalence
    behavior: validate_semantics
    input:
      v1_code: "case x { Some(v) -> v None -> 0 }"
      v2_code: "x ?? 0"
      test_cases: [
        { input: "Some(5)", expected: "5" },
        { input: "None", expected: "0" }
      ]
    expected:
      equivalent: true
      differences: []
      
  - name: migrate_module_with_deps
    behavior: migrate_module
    input:
      module_path: "src/user.vibee"
      dependencies: ["src/validation.vibee", "src/database.vibee"]
    expected:
      migrated_modules: length == 3
      migrated_modules: all_match(success == true)

examples:
  - name: "Умная миграция функции"
    description: "AI понимает бизнес-логику и мигрирует соответственно"
    input:
      v1_code: |
        pub fn calculate_discount(price: Float, user_type: String) -> Float {
          case user_type {
            "premium" -> price * 0.8
            "regular" -> price * 0.9
            _ -> price
          }
        }
      business_logic: "Calculates discount based on user type"
    output:
      v2_code: |
        pub calculate_discount(price, user_type): Float = {
          user_type match {
            "premium" => price * 0.8
            "regular" => price * 0.9
            _ => price
          }
        }
      explanation: "Сохранена бизнес-логика, улучшен синтаксис"
      
  - name: "Контекстная миграция"
    description: "AI учитывает как функция используется"
    input:
      code: "pub fn get_user(id: Int) -> Result(User, String)"
      usage_context: "Вызывается из 15 мест, всегда с error handling"
    output:
      strategy: "conservative"
      explanation: "Много мест использования - безопасная миграция"
      v2_code: "pub get_user(id): Result<User, String> = !impl"
      
  - name: "Миграция с зависимостями"
    description: "AI определяет порядок миграции модулей"
    input:
      module: "user_service"
      dependencies: ["database", "validation", "auth"]
    output:
      migration_order: ["database", "validation", "auth", "user_service"]
      explanation: "Сначала зависимости, потом основной модуль"

ai_capabilities:
  semantic_understanding:
    - "Понимание бизнес-логики"
    - "Анализ паттернов использования"
    - "Определение критичных участков"
    - "Оценка рисков изменений"
    
  context_awareness:
    - "Анализ зависимостей"
    - "Понимание архитектуры"
    - "Учет паттернов проекта"
    - "Соблюдение стиля кода"
    
  intelligent_decisions:
    - "Выбор оптимальной стратегии"
    - "Определение порядка миграции"
    - "Балансировка риск/улучшение"
    - "Адаптация под проект"

metrics:
  migration_accuracy: "> 95%"
  semantic_preservation: "100%"
  auto_migration_rate: "> 80%"
  manual_review_needed: "< 20%"
  average_improvement: "> 60%"
