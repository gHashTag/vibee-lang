name: ai_code_suggestions
version: 1.0.0
description: AI-powered code suggestions для VIBEE - умные подсказки в реальном времени

metadata:
  author: VIBEE Team
  category: ai_integration
  tags: [ai, llm, code-completion, suggestions, openrouter]
  created: 2024-01-10

types:
  CodeContext:
    file_path: string
    cursor_position: Position
    current_line: string
    previous_lines: list<string>
    next_lines: list<string>
    imports: list<string>
    functions: list<string>
    types: list<string>
    
  Position:
    line: number
    column: number
    
  Suggestion:
    id: string
    text: string
    type: string  # completion, refactoring, fix, optimization
    confidence: number
    explanation: string
    code_snippet: string
    apply_automatically: boolean
    
  AIModel:
    provider: string  # openrouter, anthropic, openai
    model: string
    temperature: number
    max_tokens: number
    
  SuggestionRequest:
    context: CodeContext
    trigger: string  # typing, save, request
    preferences: UserPreferences
    
  UserPreferences:
    auto_apply_high_confidence: boolean
    show_explanations: boolean
    preferred_style: string
    max_suggestions: number

constants:
  AI_MODELS:
    - provider: "openrouter"
      model: "anthropic/claude-3.5-sonnet"
      temperature: 0.3
      max_tokens: 2000
      use_case: "code_completion"
      
    - provider: "openrouter"
      model: "anthropic/claude-3-opus"
      temperature: 0.2
      max_tokens: 4000
      use_case: "refactoring"
      
    - provider: "openrouter"
      model: "google/gemini-pro-1.5"
      temperature: 0.1
      max_tokens: 1000
      use_case: "quick_fixes"

  SUGGESTION_TYPES:
    completion:
      description: "Автодополнение кода"
      confidence_threshold: 0.7
      auto_apply: true
      
    refactoring:
      description: "Предложения по рефакторингу"
      confidence_threshold: 0.8
      auto_apply: false
      
    fix:
      description: "Исправление ошибок"
      confidence_threshold: 0.9
      auto_apply: false
      
    optimization:
      description: "Оптимизация производительности"
      confidence_threshold: 0.85
      auto_apply: false
      
    security:
      description: "Исправление уязвимостей"
      confidence_threshold: 0.95
      auto_apply: false

  PROMPTS:
    code_completion: |
      Ты - эксперт по языку программирования VIBEE.
      
      Контекст:
      - Файл: {file_path}
      - Текущая строка: {current_line}
      - Предыдущие строки:
      {previous_lines}
      
      Задача: Предложи автодополнение для текущей строки.
      
      Требования:
      - Используй VIBEE V2 синтаксис (concise, modern)
      - Следуй best practices
      - Учитывай контекст кода
      - Будь кратким и точным
      
      Формат ответа:
      ```vibee
      <твое предложение>
      ```
      
      Объяснение: <краткое объяснение>
      
    refactoring: |
      Ты - эксперт по рефакторингу VIBEE кода.
      
      Код для анализа:
      ```vibee
      {code_snippet}
      ```
      
      Задача: Предложи улучшения кода.
      
      Проверь на:
      - Anti-patterns (10 известных паттернов)
      - Code smells
      - Performance issues
      - Readability
      - VIBEE V2 best practices
      
      Формат ответа:
      Проблема: <описание>
      Решение:
      ```vibee
      <улучшенный код>
      ```
      Улучшение: <метрики>
      
    quick_fix: |
      Ты - эксперт по исправлению ошибок в VIBEE.
      
      Ошибка:
      {error_message}
      
      Код:
      ```vibee
      {code_snippet}
      ```
      
      Задача: Предложи быстрое исправление.
      
      Формат ответа:
      Причина: <объяснение ошибки>
      Исправление:
      ```vibee
      <исправленный код>
      ```

behaviors:
  get_suggestions:
    input:
      request: SuggestionRequest
    output:
      suggestions: list<Suggestion>
    description: Получить AI-подсказки для кода
    steps:
      - Проанализировать контекст кода
      - Определить тип подсказки
      - Выбрать подходящую AI модель
      - Сформировать промпт
      - Отправить запрос к AI
      - Парсить ответ
      - Оценить confidence
      - Вернуть suggestions
      
  apply_suggestion:
    input:
      suggestion: Suggestion
      context: CodeContext
    output:
      new_code: string
      success: boolean
    description: Применить AI-подсказку к коду
    steps:
      - Валидировать suggestion
      - Применить изменения
      - Проверить синтаксис
      - Запустить тесты
      - Вернуть результат
      
  analyze_code:
    input:
      code: string
      analysis_type: string
    output:
      issues: list<Issue>
      suggestions: list<Suggestion>
    description: Анализ кода с помощью AI
    steps:
      - Парсить код в AST
      - Отправить на анализ AI
      - Получить список проблем
      - Сгенерировать suggestions
      - Вернуть результаты
      
  optimize_code:
    input:
      code: string
      optimization_goal: string
    output:
      optimized_code: string
      improvement_metrics: map<string, number>
    description: Оптимизация кода с помощью AI
    steps:
      - Проанализировать текущий код
      - Определить узкие места
      - Сгенерировать оптимизации
      - Измерить улучшения
      - Вернуть оптимизированный код
      
  explain_code:
    input:
      code: string
      detail_level: string
    output:
      explanation: string
      complexity: number
    description: Объяснение кода с помощью AI
    steps:
      - Проанализировать код
      - Сгенерировать объяснение
      - Оценить сложность
      - Вернуть объяснение

functions:
  - name: call_ai_model
    params:
      model: AIModel
      prompt: string
      context: map<string, any>
    returns: string
    description: Вызов AI модели через OpenRouter
    
  - name: parse_ai_response
    params:
      response: string
      expected_format: string
    returns: Suggestion
    description: Парсинг ответа от AI
    
  - name: calculate_confidence
    params:
      suggestion: Suggestion
      context: CodeContext
    returns: number
    description: Расчет уверенности в suggestion
    
  - name: validate_suggestion
    params:
      suggestion: Suggestion
      code: string
    returns: boolean
    description: Валидация suggestion перед применением

tests:
  - name: suggest_function_completion
    behavior: get_suggestions
    input:
      request:
        context:
          current_line: "pub add(a, b) = "
          previous_lines: ["// Calculator module"]
        trigger: "typing"
    expected:
      suggestions: length > 0
      suggestions[0].type: "completion"
      suggestions[0].text: contains("a + b")
      suggestions[0].confidence: > 0.7
      
  - name: suggest_v2_syntax
    behavior: get_suggestions
    input:
      request:
        context:
          current_line: "pub fn example() → Result(String, String) {"
        trigger: "save"
    expected:
      suggestions: length > 0
      suggestions[0].type: "refactoring"
      suggestions[0].text: contains("pub example: Result<String, String> = !impl")
      
  - name: fix_syntax_error
    behavior: get_suggestions
    input:
      request:
        context:
          current_line: "pub add(a b) = a + b"
        trigger: "request"
    expected:
      suggestions: length > 0
      suggestions[0].type: "fix"
      suggestions[0].text: contains("pub add(a, b)")
      
  - name: optimize_performance
    behavior: optimize_code
    input:
      code: |
        list
          |> list.filter(fn(x) { x > 0 })
          |> list.map(fn(x) { x * 2 })
      optimization_goal: "readability"
    expected:
      optimized_code: contains("[x * 2 for x in list if x > 0]")
      improvement_metrics.readability: > 0
      
  - name: explain_complex_code
    behavior: explain_code
    input:
      code: "result? |> continue_with"
      detail_level: "beginner"
    expected:
      explanation: contains("error propagation")
      complexity: < 5

examples:
  - name: "Автодополнение функции"
    description: "AI предлагает завершение функции"
    input:
      current_line: "pub calculate_total(items) = "
      context: "// Shopping cart module"
    output:
      suggestion: "items |> list.map(fn(i) { i.price }) |> list.fold(0, fn(a, b) { a + b })"
      confidence: 0.85
      explanation: "Суммирование цен всех items в корзине"
      
  - name: "Рефакторинг в V2 синтаксис"
    description: "AI предлагает миграцию на V2"
    input:
      code: |
        pub fn process(data: String) -> Result(String, String) {
          case validate(data) {
            Ok(valid) -> Ok(transform(valid))
            Error(e) -> Error(e)
          }
        }
    output:
      suggestion: |
        pub process(data): Result<String, String> = {
          validate(data)? |> transform
        }
      improvement: "75% меньше кода, читаемость +40%"
      
  - name: "Исправление ошибки"
    description: "AI находит и исправляет ошибку"
    input:
      code: "let result = divide(10, 0)"
      error: "Division by zero"
    output:
      suggestion: |
        let result = divide(10, 0) ?? Error("Cannot divide by zero")
      explanation: "Добавлена обработка деления на ноль"

integration:
  openrouter:
    api_url: "https://openrouter.ai/api/v1/chat/completions"
    auth: "Bearer ${OPENROUTER_API_KEY}"
    models:
      - "anthropic/claude-3.5-sonnet"
      - "anthropic/claude-3-opus"
      - "google/gemini-pro-1.5"
      - "openai/gpt-4-turbo"
    rate_limits:
      requests_per_minute: 60
      tokens_per_minute: 100000

metrics:
  suggestion_accuracy: "> 85%"
  response_time: "< 500ms"
  user_acceptance_rate: "> 70%"
  false_positive_rate: "< 10%"
  
performance:
  cache_suggestions: true
  cache_ttl_seconds: 300
  batch_requests: true
  max_batch_size: 10
  
privacy:
  send_only_context: true
  anonymize_data: true
  no_sensitive_info: true
  user_consent_required: true
