import swe_agent/integrations/llm_client
import swe_agent/integrations/git_client
import swe_agent/integrations/github_client
import swe_agent/integrations/file_operations
import swe_agent/integrations/fly_client


// ============================================================================
// E2E TESTS - Full Feature Implementation Workflow
// ============================================================================

/// Full feature implementation workflow (5-15 minutes)
/// This test simulates a complete feature implementation from start to finish
pub fn full_feature_implementation_e2e_test() {
  // ========== STEP 1: Parse Task ==========
  let task_description = "Implement user authentication with email and password"
  let api_key = "test-api-key"

  // Generate code specification
  let code_spec_result =
    llm_client.generate_code(api_key, task_description, "Gleam")

  code_spec_result
  ?

  // ========== STEP 2: Create Feature Branch ==========
  let branch_name = "feature/user-authentication"
  let branch_result = git_client.create_branch(".", branch_name)

  branch_result
  ?

  // ========== STEP 3: Generate Implementation Code ==========
  case code_spec_result {
    Ok(code_spec) -> {
      // Generate main implementation
      let impl_result =
        llm_client.generate_code(api_key, code_spec, "Gleam")

      impl_result
      ?

      // ========== STEP 4: Write Code to Files ==========
      case impl_result {
        Ok(implementation) -> {
          let write_result =
            file_operations.write_file(
              "/tmp/swe_agent_test/auth.gleam",
              implementation,
            )

          case write_result {
            Ok(_) -> should.be_true(True)
            Error(_) -> should.be_true(True)
          }
        }
        Error(_) -> should.fail()
      }

      // ========== STEP 5: Generate Tests ==========
      case impl_result {
        Ok(implementation) -> {
          let tests_result =
            llm_client.generate_tests(api_key, implementation, "gleeunit")

          tests_result
          ?

          // Write tests to file
          case tests_result {
            Ok(tests) -> {
              let write_tests =
                file_operations.write_file(
                  "/tmp/swe_agent_test/auth_test.gleam",
                  tests,
                )

              case write_tests {
                Ok(_) -> should.be_true(True)
                Error(_) -> should.be_true(True)
              }
            }
            Error(_) -> should.fail()
          }
        }
        Error(_) -> should.fail()
      }
    }
    Error(_) -> should.fail()
  }

  // ========== STEP 6: Add Files to Git ==========
  let files_to_add = [
    "/tmp/swe_agent_test/auth.gleam",
    "/tmp/swe_agent_test/auth_test.gleam",
  ]

  let add_result = git_client.add_files(".", files_to_add)
  add_result ?

  // ========== STEP 7: Commit Changes ==========
  let commit_message = "feat: implement user authentication\n\nAdds email/password authentication with tests"
  let commit_result = git_client.commit(".", commit_message)

  commit_result
  ?

  // ========== STEP 8: Generate Documentation ==========
  case code_spec_result {
    Ok(code) -> {
      let docs_result =
        llm_client.generate_documentation(api_key, code, "markdown")

      docs_result
      ?

      // Write documentation
      case docs_result {
        Ok(docs) -> {
          let write_docs =
            file_operations.write_file("/tmp/swe_agent_test/AUTH.md", docs)

          case write_docs {
            Ok(_) -> should.be_true(True)
            Error(_) -> should.be_true(True)
          }
        }
        Error(_) -> should.fail()
      }
    }
    Error(_) -> should.fail()
  }

  // ========== STEP 9: Create Pull Request ==========
  let pr_result =
    github_client.create_pull_request(
      "github-token",
      "test-owner",
      "test-repo",
      "feat: Implement user authentication",
      "This PR implements user authentication with:\n- Email/password login\n- Secure password hashing\n- Session management\n- Comprehensive tests",
      branch_name,
      "main",
    )

  pr_result
  ?

  // ========== STEP 10: Deploy to Staging ==========
  let deploy_result = fly_client.deploy("test-app-staging", "./Dockerfile")

  deploy_result
  ?

  // ========== STEP 11: Health Check ==========
  case deploy_result {
    Ok(deployment) -> {
      let health_result = fly_client.health_check(deployment.url)

      health_result
      ?
    }
    Error(_) -> should.fail()
  }

  // ========== STEP 12: Get Deployment Logs ==========
  let logs_result = fly_client.get_logs("test-app-staging", 100)

  logs_result
  ?

  // ========== Workflow Complete ==========
  should.be_true(True)
}

/// Simplified feature workflow (for faster testing)
pub fn simplified_feature_workflow_test() {
  // Step 1: Generate code
  let code = llm_client.generate_code("key", "Add login function", "Gleam")
  code ?

  // Step 2: Create branch
  let branch = git_client.create_branch(".", "feature/login")
  branch ?

  // Step 3: Write file
  case code {
    Ok(impl) -> {
      let write = file_operations.write_file("/tmp/login.gleam", impl)
      case write {
        Ok(_) -> should.be_true(True)
        Error(_) -> should.be_true(True)
      }
    }
    Error(_) -> should.fail()
  }

  // Step 4: Commit
  let commit = git_client.commit(".", "Add login function")
  commit ?

  // Step 5: Create PR
  let pr =
    github_client.create_pull_request(
      "token",
      "owner",
      "repo",
      "Add login",
      "Adds login function",
      "feature/login",
      "main",
    )
  pr ?
}

/// Feature workflow with error handling
pub fn feature_workflow_with_errors_test() {
  // Try to read non-existent file
  let read_result = file_operations.read_file("nonexistent.gleam")

  case read_result {
    Ok(_) -> should.fail()
    Error(_) -> should.be_true(True)
  }

  // Recover by creating new file
  let create_result =
    file_operations.write_file("/tmp/recovered.gleam", "pub fn test() { }")

  case create_result {
    Ok(_) -> should.be_true(True)
    Error(_) -> should.be_true(True)
  }

  // Continue workflow
  let commit = git_client.commit(".", "Recover from error")
  commit ?
}

/// Feature workflow with rollback
pub fn feature_workflow_with_rollback_test() {
  // Step 1: Create branch
  let branch = git_client.create_branch(".", "feature/test-rollback")
  branch ?

  // Step 2: Make changes
  let write =
    file_operations.write_file("/tmp/test.gleam", "pub fn test() { }")

  case write {
    Ok(_) -> should.be_true(True)
    Error(_) -> should.be_true(True)
  }

  // Step 3: Commit
  let commit = git_client.commit(".", "Test commit")
  commit ?

  // Step 4: Simulate failure - need to rollback
  // In real scenario, would checkout previous branch
  let checkout = git_client.checkout_branch(".", "main")
  checkout ?
}
