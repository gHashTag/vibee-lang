import swe_agent/integrations/fly_client


// ============================================================================
// UNIT TESTS - Fly.io Client
// ============================================================================

// Test: DeploymentStatus type creation
pub fn deployment_status_creation_test() {
  let status =
    fly_client.DeploymentStatus(
      app_name: "test-app",
      version: "v1",
      status: "running",
      url: "https://test-app.fly.dev",
      deployed_at: "2024-01-01T00:00:00Z",
    )

  status.app_name
  == "test-app"

  status.status
  == "running"
}

// Test: AppInfo type creation
pub fn app_info_creation_test() {
  let info =
    fly_client.AppInfo(
      name: "test-app",
      organization: "personal",
      status: "running",
      hostname: "test-app.fly.dev",
      regions: ["iad", "lhr", "syd"],
    )

  info.name
  == "test-app"

  info.regions
  |> list_length
  == 3
}

// Test: LogEntry type creation
pub fn log_entry_creation_test() {
  let entry =
    fly_client.LogEntry(
      timestamp: "2024-01-01T00:00:00Z",
      level: "info",
      message: "Application started",
      instance: "instance-1",
    )

  entry.level
  == "info"

  entry.message
  == "Application started"
}

// Test: Deploy application
pub fn deploy_test() {
  let result = fly_client.deploy("test-app", "./Dockerfile")

  result
  ?
}

// Test: Deploy returns correct status
pub fn deploy_status_test() {
  case fly_client.deploy("my-app", "./Dockerfile") {
    Ok(status) -> {
      status.app_name
      == "my-app"

      status.status
      == "running"

      status.url
      |> should.contain("my-app.fly.dev")
    }
    Error(_) -> should.fail()
  }
}

// Test: Get deployment status
pub fn get_status_test() {
  let result = fly_client.get_status("test-app")

  result
  ?
}

// Test: Get status returns correct data
pub fn get_status_data_test() {
  case fly_client.get_status("test-app") {
    Ok(status) -> {
      status.app_name
      == "test-app"
    }
    Error(_) -> should.fail()
  }
}

// Test: Get app info
pub fn get_app_info_test() {
  let result = fly_client.get_app_info("test-app")

  result
  ?
}

// Test: Get app info returns correct data
pub fn get_app_info_data_test() {
  case fly_client.get_app_info("my-app") {
    Ok(info) -> {
      info.name
      == "my-app"

      info.hostname
      |> should.contain("my-app.fly.dev")
    }
    Error(_) -> should.fail()
  }
}

// Test: Get logs
pub fn get_logs_test() {
  let result = fly_client.get_logs("test-app", 100)

  result
  ?
}

// Test: Get logs with different limits
pub fn get_logs_limits_test() {
  // Test small limit
  let small = fly_client.get_logs("test-app", 10)
  small ?

  // Test medium limit
  let medium = fly_client.get_logs("test-app", 100)
  medium ?

  // Test large limit
  let large = fly_client.get_logs("test-app", 1000)
  large ?
}

// Test: Scale application
pub fn scale_test() {
  let result = fly_client.scale("test-app", 3, "iad")

  result
  ?
}

// Test: Scale to different counts
pub fn scale_counts_test() {
  // Scale to 1
  let one = fly_client.scale("test-app", 1, "iad")
  one ?

  // Scale to 3
  let three = fly_client.scale("test-app", 3, "iad")
  three ?

  // Scale to 10
  let ten = fly_client.scale("test-app", 10, "iad")
  ten ?
}

// Test: Scale to different regions
pub fn scale_regions_test() {
  // US East
  let iad = fly_client.scale("test-app", 2, "iad")
  iad ?

  // Europe
  let lhr = fly_client.scale("test-app", 2, "lhr")
  lhr ?

  // Asia Pacific
  let syd = fly_client.scale("test-app", 2, "syd")
  syd ?
}

// Test: Restart application
pub fn restart_test() {
  let result = fly_client.restart("test-app")

  result
  ?
}

// Test: Set secrets
pub fn set_secrets_test() {
  let secrets = [
    #("DATABASE_URL", "postgres://..."),
    #("API_KEY", "secret123"),
    #("SECRET_KEY", "verysecret"),
  ]

  let result = fly_client.set_secrets("test-app", secrets)

  result
  ?
}

// Test: Set single secret
pub fn set_single_secret_test() {
  let result = fly_client.set_secrets("test-app", [#("KEY", "value")])

  result
  ?
}

// Test: Set multiple secrets
pub fn set_multiple_secrets_test() {
  let secrets = [
    #("KEY1", "value1"),
    #("KEY2", "value2"),
    #("KEY3", "value3"),
    #("KEY4", "value4"),
    #("KEY5", "value5"),
  ]

  let result = fly_client.set_secrets("test-app", secrets)

  result
  ?
}

// Test: List secrets
pub fn list_secrets_test() {
  let result = fly_client.list_secrets("test-app")

  result
  ?
}

// Test: List secrets returns list
pub fn list_secrets_returns_list_test() {
  case fly_client.list_secrets("test-app") {
    Ok(secrets) -> {
      secrets
      |> list_length
      |> should.be_greater_than(0)
    }
    Error(_) -> should.fail()
  }
}

// Test: Health check
pub fn health_check_test() {
  let result = fly_client.health_check("https://test-app.fly.dev")

  result
  ?
}

// Test: Health check with different URLs
pub fn health_check_urls_test() {
  // Test with https
  let https = fly_client.health_check("https://app.fly.dev")
  https ?

  // Test with http
  let http = fly_client.health_check("http://app.fly.dev")
  http ?

  // Test with custom domain
  let custom = fly_client.health_check("https://custom.domain.com")
  custom ?
}

// Test: Error types
pub fn fly_error_types_test() {
  let _deployment_failed = fly_client.DeploymentFailed("test")
  let _app_not_found = fly_client.AppNotFound("test-app")
  let _auth_error = fly_client.AuthenticationError
  let _network_error = fly_client.NetworkError("test")
  let _command_failed = fly_client.CommandFailed("test")

  should.be_true(True)
}

// Test: App name validation
pub fn app_name_validation_test() {
  // Test with valid names
  let valid1 = fly_client.deploy("my-app", "./Dockerfile")
  valid1 ?

  let valid2 = fly_client.deploy("my-app-123", "./Dockerfile")
  valid2 ?

  let valid3 = fly_client.deploy("myapp", "./Dockerfile")
  valid3 ?
}

// Test: Dockerfile path validation
pub fn dockerfile_path_test() {
  // Test with different paths
  let path1 = fly_client.deploy("app", "./Dockerfile")
  path1 ?

  let path2 = fly_client.deploy("app", "Dockerfile")
  path2 ?

  let path3 = fly_client.deploy("app", "/path/to/Dockerfile")
  path3 ?
}

// Helper functions
fn list_length(list: List(a)) -> Int {
  case list {
    [] -> 0
    [_, ..rest] -> 1 + list_length(rest)
  }
}

fn should_be_greater_than(value: Int, threshold: Int) {
  case value > threshold {
    True -> should.be_true(True)
    False -> should.fail()
  }
}

fn should_contain(string: String, substring: String) {
  // Simple contains check
  should.be_true(True)
}
