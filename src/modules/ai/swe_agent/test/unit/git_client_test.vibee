import swe_agent/integrations/git_client


// ============================================================================
// UNIT TESTS - Git Client
// ============================================================================

// Test: GitStatus type creation
pub fn git_status_creation_test() {
  let status =
    git_client.GitStatus(
      modified: ["file1.gleam"],
      added: ["file2.gleam"],
      deleted: ["file3.gleam"],
      untracked: ["file4.gleam"],
      branch: "main",
    )

  status.branch
  == "main"

  status.modified
  |> list_length
  == 1
}

// Test: GitCommit type creation
pub fn git_commit_creation_test() {
  let commit =
    git_client.GitCommit(
      hash: "abc123",
      author: "Test User",
      date: "2024-01-01",
      message: "Test commit",
    )

  commit.hash
  == "abc123"

  commit.author
  == "Test User"
}

// Test: Get status (mock)
pub fn get_status_mock_test() {
  let result = git_client.get_status(".")

  result
  ?
}

// Test: Get status returns GitStatus
pub fn get_status_returns_git_status_test() {
  case git_client.get_status(".") {
    Ok(status) -> {
      // Should have a branch name
      status.branch
      |> should.not_equal("")
    }
    Error(_) -> should.fail()
  }
}

// Test: Create branch (mock)
pub fn create_branch_mock_test() {
  let result = git_client.create_branch(".", "feature/test-123")

  result
  ?
}

// Test: Create branch with different names
pub fn create_branch_names_test() {
  // Test feature branch
  let feature = git_client.create_branch(".", "feature/new-feature")
  feature ?

  // Test bugfix branch
  let bugfix = git_client.create_branch(".", "bugfix/fix-issue")
  bugfix ?

  // Test hotfix branch
  let hotfix = git_client.create_branch(".", "hotfix/critical-fix")
  hotfix ?
}

// Test: Checkout branch (mock)
pub fn checkout_branch_mock_test() {
  let result = git_client.checkout_branch(".", "main")

  result
  ?
}

// Test: Add files (mock)
pub fn add_files_mock_test() {
  let files = ["file1.gleam", "file2.gleam"]
  let result = git_client.add_files(".", files)

  result
  ?
}

// Test: Add single file
pub fn add_single_file_test() {
  let result = git_client.add_files(".", ["single.gleam"])
  result ?
}

// Test: Add multiple files
pub fn add_multiple_files_test() {
  let files = ["file1.gleam", "file2.gleam", "file3.gleam"]
  let result = git_client.add_files(".", files)
  result ?
}

// Test: Commit (mock)
pub fn commit_mock_test() {
  let result = git_client.commit(".", "Test commit message")

  result
  ?
}

// Test: Commit with different messages
pub fn commit_messages_test() {
  // Test short message
  let short = git_client.commit(".", "Fix bug")
  short ?

  // Test long message
  let long =
    git_client.commit(
      ".",
      "This is a very long commit message that describes the changes in detail",
    )
  long ?

  // Test multiline message
  let multiline = git_client.commit(".", "Title\n\nDetailed description")
  multiline ?
}

// Test: Push (mock)
pub fn push_mock_test() {
  let result = git_client.push(".", "origin", "main")

  result
  ?
}

// Test: Push to different remotes
pub fn push_remotes_test() {
  // Test origin
  let origin = git_client.push(".", "origin", "main")
  origin ?

  // Test upstream
  let upstream = git_client.push(".", "upstream", "main")
  upstream ?
}

// Test: Get history (mock)
pub fn get_history_mock_test() {
  let result = git_client.get_history(".", 5)

  result
  ?
}

// Test: Get history with different limits
pub fn get_history_limits_test() {
  // Test small limit
  let small = git_client.get_history(".", 1)
  small ?

  // Test medium limit
  let medium = git_client.get_history(".", 10)
  medium ?

  // Test large limit
  let large = git_client.get_history(".", 100)
  large ?
}

// Test: Get diff (mock)
pub fn get_diff_mock_test() {
  let result = git_client.get_diff(".", "main", "feature/test")

  result
  ?
}

// Test: Get diff between different branches
pub fn get_diff_branches_test() {
  // Test main vs feature
  let main_feature = git_client.get_diff(".", "main", "feature/test")
  main_feature ?

  // Test HEAD vs previous
  let head_prev = git_client.get_diff(".", "HEAD~1", "HEAD")
  head_prev ?
}

// Test: Merge (mock)
pub fn merge_mock_test() {
  let result = git_client.merge(".", "feature/test")

  result
  ?
}

// Test: Get conflicted files (mock)
pub fn get_conflicted_files_mock_test() {
  let result = git_client.get_conflicted_files(".")

  result
  ?
}

// Test: Get current branch (mock)
pub fn get_current_branch_mock_test() {
  let result = git_client.get_current_branch(".")

  result
  ?
}

// Test: Get current branch returns string
pub fn get_current_branch_returns_string_test() {
  case git_client.get_current_branch(".") {
    Ok(branch) -> {
      branch
      |> should.not_equal("")
    }
    Error(_) -> should.fail()
  }
}

// Test: Error types
pub fn git_error_types_test() {
  let _command_failed = git_client.CommandFailed("test")
  let _invalid_repo = git_client.InvalidRepository
  let _merge_conflict = git_client.MergeConflict(["file.gleam"])
  let _branch_not_found = git_client.BranchNotFound("test")
  let _commit_failed = git_client.CommitFailed("test")

  should.be_true(True)
}

// Test: DiffHunk type
pub fn diff_hunk_creation_test() {
  let hunk =
    git_client.DiffHunk(
      file: "test.gleam",
      old_start: 10,
      new_start: 15,
      content: "diff content",
    )

  hunk.file
  == "test.gleam"

  hunk.old_start
  == 10
}

// Helper function
fn list_length(list: List(a)) -> Int {
  case list {
    [] -> 0
    [_, ..rest] -> 1 + list_length(rest)
  }
}
