import swe_agent/integrations/github_client


// ============================================================================
// UNIT TESTS - GitHub Client
// ============================================================================

// Test: PullRequest type creation
pub fn pull_request_creation_test() {
  let pr =
    github_client.PullRequest(
      number: 1,
      title: "Test PR",
      body: "Test body",
      state: "open",
      head_branch: "feature/test",
      base_branch: "main",
      url: "https://github.com/owner/repo/pull/1",
      created_at: "2024-01-01T00:00:00Z",
    )

  pr.number
  == 1

  pr.state
  == "open"
}

// Test: Issue type creation
pub fn issue_creation_test() {
  let issue =
    github_client.Issue(
      number: 1,
      title: "Test Issue",
      body: "Test body",
      state: "open",
      labels: ["bug", "high-priority"],
      created_at: "2024-01-01T00:00:00Z",
    )

  issue.number
  == 1

  issue.labels
  |> list_length
  == 2
}

// Test: Repository type creation
pub fn repository_creation_test() {
  let repo =
    github_client.Repository(
      owner: "test-owner",
      name: "test-repo",
      full_name: "test-owner/test-repo",
      description: "Test repository",
      default_branch: "main",
    )

  repo.owner
  == "test-owner"

  repo.default_branch
  == "main"
}

// Test: Create pull request
pub fn create_pull_request_test() {
  let result =
    github_client.create_pull_request(
      "token",
      "owner",
      "repo",
      "Add feature",
      "This PR adds a new feature",
      "feature/test",
      "main",
    )

  result
  ?
}

// Test: Create pull request returns correct data
pub fn create_pull_request_data_test() {
  case
    github_client.create_pull_request(
      "token",
      "owner",
      "repo",
      "Test PR",
      "Test body",
      "feature/test",
      "main",
    )
  {
    Ok(pr) -> {
      pr.title
      == "Test PR"

      pr.head_branch
      == "feature/test"

      pr.base_branch
      == "main"
    }
    Error(_) -> should.fail()
  }
}

// Test: Get pull request
pub fn get_pull_request_test() {
  let result = github_client.get_pull_request("token", "owner", "repo", 1)

  result
  ?
}

// Test: Get pull request returns correct number
pub fn get_pull_request_number_test() {
  case github_client.get_pull_request("token", "owner", "repo", 42) {
    Ok(pr) -> {
      pr.number
      == 42
    }
    Error(_) -> should.fail()
  }
}

// Test: List pull requests
pub fn list_pull_requests_test() {
  let result = github_client.list_pull_requests("token", "owner", "repo", "open")

  result
  ?
}

// Test: List pull requests with different states
pub fn list_pull_requests_states_test() {
  // Test open PRs
  let open_prs = github_client.list_pull_requests("token", "owner", "repo", "open")
  open_prs ?

  // Test closed PRs
  let closed_prs =
    github_client.list_pull_requests("token", "owner", "repo", "closed")
  closed_prs ?

  // Test all PRs
  let all_prs = github_client.list_pull_requests("token", "owner", "repo", "all")
  all_prs ?
}

// Test: Merge pull request
pub fn merge_pull_request_test() {
  let result =
    github_client.merge_pull_request("token", "owner", "repo", 1, "merge")

  result
  ?
}

// Test: Merge pull request with different methods
pub fn merge_pull_request_methods_test() {
  // Test merge
  let merge = github_client.merge_pull_request("token", "owner", "repo", 1, "merge")
  merge ?

  // Test squash
  let squash =
    github_client.merge_pull_request("token", "owner", "repo", 1, "squash")
  squash ?

  // Test rebase
  let rebase =
    github_client.merge_pull_request("token", "owner", "repo", 1, "rebase")
  rebase ?
}

// Test: Create issue
pub fn create_issue_test() {
  let result =
    github_client.create_issue(
      "token",
      "owner",
      "repo",
      "Bug report",
      "Found a bug",
      ["bug"],
    )

  result
  ?
}

// Test: Create issue with multiple labels
pub fn create_issue_labels_test() {
  case
    github_client.create_issue(
      "token",
      "owner",
      "repo",
      "Issue",
      "Body",
      ["bug", "high-priority", "needs-review"],
    )
  {
    Ok(issue) -> {
      issue.labels
      |> list_length
      == 3
    }
    Error(_) -> should.fail()
  }
}

// Test: Get issue
pub fn get_issue_test() {
  let result = github_client.get_issue("token", "owner", "repo", 1)

  result
  ?
}

// Test: Get repository
pub fn get_repository_test() {
  let result = github_client.get_repository("token", "owner", "repo")

  result
  ?
}

// Test: Get repository returns correct data
pub fn get_repository_data_test() {
  case github_client.get_repository("token", "test-owner", "test-repo") {
    Ok(repo) -> {
      repo.owner
      == "test-owner"

      repo.name
      == "test-repo"

      repo.full_name
      == "test-owner/test-repo"
    }
    Error(_) -> should.fail()
  }
}

// Test: Error types
pub fn github_error_types_test() {
  let _api_error = github_client.APIError("test")
  let _auth_error = github_client.AuthenticationError
  let _not_found = github_client.NotFound("resource")
  let _rate_limit = github_client.RateLimitExceeded
  let _network_error = github_client.NetworkError("test")

  should.be_true(True)
}

// Test: Empty token handling
pub fn empty_token_test() {
  let result = github_client.get_repository("", "owner", "repo")

  // Should still work (mock implementation)
  result
  ?
}

// Test: Special characters in names
pub fn special_characters_test() {
  let result =
    github_client.create_pull_request(
      "token",
      "owner-with-dash",
      "repo_with_underscore",
      "Title with spaces",
      "Body with\nnewlines",
      "feature/test-123",
      "main",
    )

  result
  ?
}

// Helper function
fn list_length(list: List(a)) -> Int {
  case list {
    [] -> 0
    [_, ..rest] -> 1 + list_length(rest)
  }
}
