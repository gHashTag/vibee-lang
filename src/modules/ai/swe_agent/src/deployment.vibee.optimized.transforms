# Transformation Guide for deployment.vibee

## Pattern 1: Nested CASE in build (lines 88-120)

### Current (33 lines):
```vibee
CASE config.project_type OF
  "gleam":
    CASE run_build_command("gleam build " ++ config.optimization_level) OF
      Ok(output):
        artifacts = artifacts.append("build/gleam.out")
      Error(msg):
        errors = errors.append(msg)
  "typescript":
    CASE run_build_command("npm run build") OF
      Ok(output):
        artifacts = artifacts.append("dist/")
      Error(msg):
        errors = errors.append(msg)
  ...
```

### Optimized (15 lines):
```vibee
let build_cmd = match config.project_type {
  "gleam" -> "gleam build " ++ config.optimization_level,
  "typescript" -> "npm run build",
  "python" -> "python -m build",
  _ -> return Error("Unknown project type")
}

run_build_command(build_cmd)
  |> result.map(fn(output) {
    artifacts.append(get_artifact_path(config.project_type))
  })
  |> result.map_error(fn(msg) {
    errors.append(msg)
  })
```

**Savings**: 18 lines (55% reduction)

## Pattern 2: Nested CASE chain in deploy_to_fly_io (lines 215-260)

### Current (45 lines):
```vibee
CASE authenticate_fly_io() OF
  Ok(_):
    CASE run_deploy_command("flyctl " ++ set_env_cmd) OF
      Ok(output):
        logs = logs.append(output)
        CASE run_deploy_command("flyctl deploy " ++ app_name) OF
          Ok(output):
            logs = logs.append(output)
            CASE check_application_health(config) OF
              Ok(health):
                IF health.healthy THEN
                  RETURN Ok(result)
                ELSE
                  ...
              Error(err):
                RETURN Error(err)
          Error(err):
            RETURN Error(err)
      Error(err):
        RETURN Error(err)
  Error(err):
    RETURN Error(err)
```

### Optimized (12 lines):
```vibee
authenticate_fly_io()?
  |> run_deploy_command("flyctl " ++ set_env_cmd)?
  |> tap(fn(output) { logs.append(output) })
  |> run_deploy_command("flyctl deploy " ++ app_name)?
  |> tap(fn(output) { logs.append(output) })
  |> sleep_ms(5000)
  |> check_application_health(config)?
  |> validate_health(config)
  |> create_deployment_result(deployment_id, logs)
```

**Savings**: 33 lines (73% reduction)

## Pattern 3: Multiple IF-ELSE chains (lines 140-180)

### Current (40 lines):
```vibee
IF config.run_tests THEN
  CASE run_tests() OF
    Ok(test_results):
      IF test_results.passed THEN
        // continue
      ELSE
        IF config.fail_on_test_failure THEN
          RETURN Error("Tests failed")
        ELSE
          logs.append("Tests failed but continuing")
    Error(err):
      RETURN Error(err)
ELSE
  // skip tests
```

### Optimized (8 lines):
```vibee
let test_result = config.run_tests
  ? run_tests()?.validate_passed(config.fail_on_test_failure)?
  : Ok(TestSkipped)

test_result
  |> log_test_result(logs)
```

**Savings**: 32 lines (80% reduction)

## Summary

Total potential savings: ~83 lines (18% additional reduction)
Current: 467 lines
Target: 384 lines
Final: 30% total reduction (from original 509)

