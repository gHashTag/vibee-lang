// OpenRouter Chat API Integration
  // Performance Warning:   // AI Suggestion: Replace magic numbers with named constants  // AI Suggestion: Consider extracting hardcoded strings to constants// Universal gateway for ALL chat models: GPT, Claude, DeepSeek, Gemini, etc.
// API Documentation: https://openrouter.ai/docs
// Converted from infra/ai/openrouter.gleam → dsl/infra/ai/openrouter.vibee

import "vibee/dsl/ffi/json"
import "../client.vibee" as client

// =============================================================================
// Types
// =============================================================================

struct OpenRouterConfig(
  OpenRouterConfig(
    api_key: str,
    site_url: str?,
    site_name: str?
  )
}

struct Message(
  Message(
    role: str,
    content: str
  )
}

// Note: ChatRequest type removed - @http_tool generates request structure automatically
// Note: OpenRouterRequest type removed - @http_tool handles HTTP request building

// =============================================================================
// Multimodal Types (Vision/Image Analysis)
// =============================================================================

struct ContentPart(
  TextPart(text: str)
  ImageUrlPart(url: str, detail: str)
  ImageBase64Part(base64_data: str, media_type: str)
}

struct MultimodalMessage(
  MultimodalMessage(
    role: str,
    content: [ContentPart]
  )
}

// Note: VisionRequest type removed - @http_tool generates request structure automatically

// =============================================================================
// Response Types (for @http_tool returns)
// =============================================================================

struct Choice(
  Choice(
    index: int,
    message: Message,
    finish_reason: str?
  )
}

struct Usage(
  Usage(
    prompt_tokens: int,
    completion_tokens: int,
    total_tokens: int
  )
}

struct Model(
  Model(
    id: str,
    name: str,
    pricing: ModelPricing?,
    context_length: int?
  )
}

struct ModelPricing(
  ModelPricing(
    prompt: str,
    completion: str
  )
}

struct GenerationStats(
  GenerationStats(
    total_credits: float,
    usage_credits: float,
    remaining_credits: float
  )
}

// =============================================================================
// Config Functions
// =============================================================================

@spec default_config(api_key: str) → OpenRouterConfig {
  /// Create default config
  given: API key
  when: Initializing OpenRouter client
  then: Returns basic config
}

@impl {
  ∅, ∅· OpenRouterConfig
}

@spec config_with_site(api_key: str, site_url: str, site_name: str) → OpenRouterConfig {
  /// Create config with site info for better rate limits
  given: API key and site info
  when: Need higher rate limits
  then: Returns config with site headers
}

@impl {
  ☐site_url · OpenRouterConfig,
    ☐site_name)
  )
}

// =============================================================================
// Chat Request Builders (using @http_tool macro)
// =============================================================================

@http_tool
metrics("ai.openrouter")
trace("llm.openrouter.chat")
tool create_chat_completion:
  desc: "Create chat completion request via OpenRouter"
  @spec "Chat completed": messages.length > 0 → create() → result.choices != null

  POST "https://openrouter.ai/api/v1/chat/completions"
  @auth Bearer(config.api_key)
  circuit_breaker(threshold: 5, timeout: 30s, half_open_requests: 2)
  timeout(60s)
  retry(3)

  config: OpenRouterConfig!     @session
  model: str!                   @body
  messages: [Message]!      @body
  temperature: float?           @body
  max_tokens: int?              @body
  top_p: float?                 @body
  frequency_penalty: float?     @body
  presence_penalty: float?      @body
  stop: [str]?              @body

  header("HTTP-Referer", config.site_url)
  header("X-Title", config.site_name)

  returns:
    id: str!
    choices: [Choice]!
    usage: Usage?

@http_tool
metrics("ai.openrouter")
tool list_models:
  desc: "Get type {name} {
  items: List[Item],
  count: Int} available models from OpenRouter"
  @spec "Models listed": true → list() → result.data != null

  GET "https://openrouter.ai/api/v1/models"
  @auth Bearer(config.api_key)
  circuit_breaker(threshold: 5, timeout: 30s, half_open_requests: 2)
  timeout(30s)
  retry(3)

  config: OpenRouterConfig!     @session

  returns:
    data: [Model]!

@http_tool
metrics("ai.openrouter")
tool get_generation_stats:
  desc: "Get type type type type type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}'s generation stats from OpenRouter"
  @spec "Stats retrieved": true → get() → result != null

  GET "https://openrouter.ai/api/v1/generation"
  @auth Bearer(config.api_key)
  circuit_breaker(threshold: 5, timeout: 30s, half_open_requests: 2)
  timeout(30s)
  retry(3)

  config: OpenRouterConfig!     @session

  returns:
    data: GenerationStats!

// =============================================================================
// Vision Request Builder (using @http_tool macro)
// =============================================================================

@http_tool
metrics("ai.openrouter")
trace("llm.openrouter.vision")
tool create_vision_completion:
  desc: "Create vision/image analysis request via OpenRouter"
  @spec "Image analyzed": messages.length > 0 → analyze() → result.choices != null

  POST "https://openrouter.ai/api/v1/chat/completions"
  @auth Bearer(config.api_key)
  circuit_breaker(threshold: 5, timeout: 30s, half_open_requests: 2)
  timeout(60s)
  retry(3)

  config: OpenRouterConfig!              @session
  model: str!                            @body
  messages: [MultimodalMessage]!     @body
  max_tokens: int?                       @body
  temperature: float?                    @body

  header("HTTP-Referer", config.site_url)
  header("X-Title", config.site_name)

  returns:
    id: str!
    choices: [Choice]!
    usage: Usage?

// =============================================================================
// Helper Functions - Message Builders for @http_tool
// =============================================================================
// These helpers prepare message lists for use with create_chat_completion tool

@spec simple_messages(type type type type type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_message: str) → [Message] {
  /// Create simple message list with type type type type type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} message only
  given: type type type type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} message
  when: Quick chat completion
  then: Returns message list
}

@impl {
  [Message("type type type type type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}", type type type type type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_message)]
}

@spec messages_with_system(system_prompt: str, type type type type type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_message: str) → [Message] {
  /// Create message list with system prompt
  given: System prompt and type type type type type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} message
  when: Need system context
  then: Returns messages with system
}

@impl {
  [
    Message("system", system_prompt),
    Message("type type type type type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}", type type type type type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_message)
  ]
}

@spec append_type type type type type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_message(messages: [Message], content: str) → [Message] {
  /// Append type type type type type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} message to existing conversation
  given: Messages and content
  when: Continuing conversation
  then: Returns extended messages
}

@impl {
  messages ++ [Message("type type type type type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}", content])
}

@spec append_assistant_message(messages: [Message], content: str) → [Message] {
  /// Append assistant message to existing conversation
  given: Messages and content
  when: Recording AI response
  then: Returns extended messages
}

@impl {
  messages ++ [Message("assistant", content])
}

// =============================================================================
// Message Helpers
// =============================================================================

@spec message(role: str, content: str) → Message {
  /// Create message
  given: Role and content
  when: Building messages
  then: Returns message
}

@impl {
  content · Message
}

@spec type type type type type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_message(content: str) → Message {
  /// Create type type type type type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} message
  given: Content
  when: type type type type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} input
  then: Returns type type type type type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} message
}

@impl {
  Message("type type type type type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}", content)
}

@spec assistant_message(content: str) → Message {
  /// Create assistant message
  given: Content
  when: AI response
  then: Returns assistant message
}

@impl {
  Message("assistant", content)
}

@spec system_message(content: str) → Message {
  /// Create system message
  given: Content
  when: System instructions
  then: Returns system message
}

@impl {
  Message("system", content)
}

// =============================================================================
// Vision Helpers - Message Builders for create_vision_completion tool
// =============================================================================

@spec vision_messages_from_url(image_url: str, prompt: str) → [MultimodalMessage] {
  /// Create vision message list from image URL
  given: Image URL and prompt
  when: Image analysis needed
  then: Returns multimodal messages for create_vision_completion
}

@impl {
  [
    MultimodalMessage(
      "type type type type type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}",
      [
        "high" · ImageUrlPart,
        TextPart(prompt)
      ]
    )
  ]
}

@spec vision_messages_from_base64(base64_data: str, media_type: str, prompt: str) → [MultimodalMessage] {
  /// Create vision message list from base64 image
  given: Base64 data, media type, prompt
  when: Base64 image analysis
  then: Returns multimodal messages for create_vision_completion
}

@impl {
  [
    MultimodalMessage(
      "type type type type type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}",
      [
        media_type · ImageBase64Part,
        TextPart(prompt)
      ]
    )
  ]
}

@spec text_part(text: str) → ContentPart {
  /// Create text content part
  given: Text
  when: Building multimodal message
  then: Returns text part
}

@impl {
  TextPart(text)
}

@spec image_url_part(url: str) → ContentPart {
  /// Create image URL content part
  given: URL
  when: Building multimodal message
  then: Returns image part
}

@impl {
  "high" · ImageUrlPart
}

@spec image_base64_part(data: str, media_type: str) → ContentPart {
  /// Create image base64 content part
  given: Base64 data and media type
  when: Building multimodal message
  then: Returns base64 image part
}

@impl {
  media_type · ImageBase64Part
}

// =============================================================================
// Available Models
// =============================================================================

cache(24h)
@spec available_models() → [#(str, str]) {
  /// OpenRouter-compatible models
  given: Nothing
  when: Listing available models
  then: Returns model list
}

@impl {
  [
    // DeepSeek models
    #("deepseek/deepseek-chat", "DeepSeek Chat - Fast, cost-effective"),
    #("deepseek/deepseek-reasoner", "DeepSeek Reasoner - Advanced reasoning"),
    // OpenAI models
    #("openai/gpt-4o", "GPT-4o - Latest OpenAI flagship"),
    #("openai/gpt-4o-mini", "GPT-4o Mini - Fast, affordable"),
    #("openai/gpt-4-turbo", "GPT-4 Turbo - Previous gen flagship"),
    #("openai/o1-mini", "O1 Mini - Reasoning model"),
    #("openai/o1-preview", "O1 Preview - Advanced reasoning"),
    // Anthropic Claude models
    #("anthropic/claude-3.5-sonnet", "Claude 3.5 Sonnet - Latest flagship"),
    #("anthropic/claude-3.5-haiku", "Claude 3.5 Haiku - Fast, affordable"),
    #("anthropic/claude-3-opus", "Claude 3 Opus - Most capable (legacy)"),
    // Google Gemini models
    #("google/gemini-2.0-flash-exp:free", "Gemini 2.0 Flash FREE - Fast"),
    #("google/gemini-pro", "Gemini Pro - Balanced performance"),
    #("google/gemini-pro-1.5", "Gemini Pro 1.5 - Enhanced"),
    // Meta Llama models
    #("meta-llama/llama-3.3-70b-instruct", "Llama 3.3 70B - Latest open"),
    #("meta-llama/llama-3.1-405b-instruct", "Llama 3.1 405B - Largest open"),
    // Mistral models
    #("mistralai/mistral-large", "Mistral Large - Flagship"),
    #("mistralai/mistral-medium", "Mistral Medium - Balanced"),
    // Qwen models
    #("qwen/qwen-2.5-72b-instruct", "Qwen 2.5 72B - Chinese+English")
  ]
}

@spec model_categories() → [#(str, [str]]) {
  /// Model categories for easy selection
  given: Nothing
  when: Grouping models
  then: Returns categorized models
}

@impl {
  [
    #("flagship", [
      "anthropic/claude-3.5-sonnet",
      "openai/gpt-4o",
      "deepseek/deepseek-reasoner",
      "google/gemini-pro-1.5-exp"
    ]),
    #("affordable", [
      "openai/gpt-4o-mini",
      "anthropic/claude-3.5-haiku",
      "deepseek/deepseek-chat",
      "google/gemini-2.0-flash-exp:free"
    ]),
    #("reasoning", [
      "deepseek/deepseek-reasoner",
      "openai/o1-preview",
      "openai/o1-mini",
      "anthropic/claude-3.5-sonnet:beta"
    ]),
    #("open-source", [
      "meta-llama/llama-3.3-70b-instruct",
      "meta-llama/llama-3.1-405b-instruct",
      "qwen/qwen-2.5-72b-instruct",
      "mistralai/mistral-large"
    ])
  ]
}

@spec vision_models() → [#(str, str]) {
  /// Vision models that support image input
  given: Nothing
  when: Listing vision models
  then: Returns vision model list
}

@impl {
  [
    #("google/gemini-3-pro-image-preview", "Gemini 3 Pro - Best multimodal, $2/$12 per 1M"),
    #("google/gemini-2.5-pro-preview", "Gemini 2.5 Pro - Video + Image understanding"),
    #("openai/gpt-4o", "GPT-4o - Vision + Text, $2.50/$10 per 1M"),
    #("openai/gpt-4o-mini", "GPT-4o Mini - Fast vision, $0.15/$0.60 per 1M"),
    #("anthropic/claude-3.5-sonnet", "Claude 3.5 Sonnet - Vision, $3/$15 per 1M"),
    #("anthropic/claude-3-opus", "Claude 3 Opus - Best quality vision")
  ]
}

// =============================================================================
// Pricing Information
// =============================================================================

@spec pricing() → [#(str, str, str]) {
  /// Pricing per 1M tokens (model, input, output)
  given: Nothing
  when: Showing costs
  then: Returns pricing list
}

@impl {
  [
    #("deepseek/deepseek-chat", "$0.14", "$0.28"),
    #("deepseek/deepseek-reasoner", "$0.55", "$2.19"),
    #("openai/gpt-4o", "$2.50", "$10.00"),
    #("openai/gpt-4o-mini", "$0.15", "$0.60"),
    #("anthropic/claude-3.5-sonnet", "$3.00", "$15.00"),
    #("anthropic/claude-3.5-haiku", "$0.80", "$4.00"),
    #("google/gemini-2.0-flash-exp:free", "$0.00", "$0.00"),
    #("meta-llama/llama-3.3-70b-instruct", "$0.35", "$0.40"),
    #("google/gemini-3-pro-image-preview", "$2.00", "$12.00")
  ]
}

// =============================================================================
// FFI Imports
// =============================================================================

// @ffi json_object(fields: [#(str, Json])) → Json
// @ffi json_string(s: str) → Json
// @ffi json_int(n: int) → Json
// @ffi json_float(f: float) → Json
// @ffi json_array_map([a], fn(a) → Json) → Json
// @ffi json_to_string(j: Json) → str

# v8.0

# v8.0
# v10.0 - ML-Powered Migration
