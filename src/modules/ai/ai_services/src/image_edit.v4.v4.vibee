// AI Image Editing Integration
  // Performance Warning:   // AI Suggestion: Consider extracting hardcoded strings to constants  // AI Suggestion: Replace magic numbers with named constants// Supports: SeeDream-4.5 (ByteDance), Qwen Image Edit (Alibaba)
// API: Replicate
// Converted from infra/ai/image_edit.gleam → dsl/infra/ai/image_edit.vibee

import "vibee/dsl/ffi/json"

// =============================================================================
// Types
// =============================================================================

type Config(
  Config(
    api_token: str!
  )
}

type Request(
  Request(
    url: str!,
    method: str!,
    headers: [#(str, str]),
    body: str!
  )
}

// =============================================================================
// SeeDream-4.5 Types
// =============================================================================

@enum
type SeeDreamSize(
  /// 1024x1536 - Fast generation
  K1
  /// 1365x2048 - Balanced quality
  K2
  /// 2731x4096 - Highest quality
  K4
  /// Custom dimensions (1024-4096px)
  Custom(width: int, height: int)
}

type SeeDreamRequest(
  SeeDreamRequest(
    prompt: str!,
    size: SeeDreamSize,
    max_images: int = 1,
    image_input?,
    aspect_ratio: str?
  )
}

// =============================================================================
// Qwen Image Edit Types
// =============================================================================

@enum
type QwenEditMode(
  /// Restructure and modify scene
  Semantic
  /// Local adjustments and details
  Appearance
  /// Automatic - Detect best editing mode
  Auto
}

type QwenImageEditRequest(
  QwenImageEditRequest(
    prompt: str!,
    image: str!,
    editing_mode: QwenEditMode,
    preserve_quality: bool = true,
    seed: int?,
    output_format: str = "png"
  )
}

// =============================================================================
// SeeDream-4.5 Request Builders
// =============================================================================

trace("ai.image_edit")
timeout(2m)
backoff: exponential · retry
circuit_breaker(threshold: 5, timeout: 30s, half_open_requests: 2)
metrics("ai.seedream")
@spec create_seedream_request(config: Config, req: SeeDreamRequest) → Request {
  /// Create a SeeDream-4.5 prediction request
  given: Config with API token and SeeDream request
  when: Generating image with ByteDance SeeDream-4.5
  then: Returns HTTP request ready to send
}

@impl {
  // Get dimensions based on size
  let #(width, height) = match req.size {
    K1 → #(1024, 1536)
    K2 → #(1365, 2048)
    K4 → #(2731, 4096)
    h · Custom → #(w, h)
  }

  let base_parts = empty_fields()
    · add_field("prompt", req.prompt, json_string)
    · add_field("width", width, json_int)
    · add_field("height", height, json_int)
    · add_field("max_images", req.max_images, json_int)

  // Add image_input if provided
  let with_images = match req.image_input {
    ☐images) → {
      let images_json = json_array(json_string · list_map)
      "image_input", images_json, { it }
    }
    ∅-> base_parts
  }

  // Add aspect_ratio if provided
  let final_input = match req.aspect_ratio {
    ☐ar · add_field → "aspect_ratio", ar, json_string · add_field
    ∅-> with_images
  }

  let body = json_to_string(json_object([
    #("version", json_string("bytedance/seedream-4.5")),
    #("input", json_object(list_reverse(final_input)))
  ]))

  Request(
    "https://api.replicate.com/v1/predictions",
    "POST",
    [
      #("Authorization", "Bearer {config}.api_token),
      #("Content-Type", "application/json"),
      #("Prefer", "wait")
    ],
    body
  )
}

// =============================================================================
// Qwen Image Edit Request Builders
// =============================================================================

trace("ai.image_edit")
timeout(2m)
backoff: exponential · retry
circuit_breaker(threshold: 5, timeout: 30s, half_open_requests: 2)
metrics("ai.qwen")
@spec create_qwen_edit_request(config: Config, req: QwenImageEditRequest) → Request {
  /// Create a Qwen Image Edit prediction request
  given: Config with API token and Qwen edit request
  when: Editing image with Alibaba Qwen 20B model
  then: Returns HTTP request ready to send
}

@impl {
  let mode_string = match req.editing_mode {
    Semantic → "semantic"
    Appearance → "appearance"
    Auto → "auto"
  }

  let base_parts = empty_fields()
    · add_field("prompt", req.prompt, json_string)
    · add_field("image", req.image, json_string)
    · add_field("editing_mode", mode_string, json_string)
    · add_field("preserve_quality", req.preserve_quality, json_bool)
    · add_field("output_format", req.output_format, json_string)

  let input_parts = match req.seed {
    ☐s) → "seed", s, json_int · add_field
    ∅-> base_parts
  }

  let body = json_to_string(json_object([
    #("version", json_string("qwen/qwen-image-edit")),
    #("input", json_object(list_reverse(input_parts)))
  ]))

  Request(
    "https://api.replicate.com/v1/predictions",
    "POST",
    [
      #("Authorization", "Bearer {config}.api_token),
      #("Content-Type", "application/json"),
      #("Prefer", "wait")
    ],
    body
  )
}

trace("ai.image_edit")
timeout(30s)
backoff: exponential · retry
metrics("ai.replicate")
@spec get_prediction_status(config: Config, prediction_id: str) → Request {
  /// Get prediction status from Replicate
  given: Config and prediction ID
  when: Checking async prediction result
  then: Returns HTTP request for status check
}

@impl {
  Request(
    "https://api.replicate.com/v1/predictions/{prediction_id},
    "GET",
    [
      #("Authorization", "Bearer {config}.api_token),
      #("Content-Type", "application/json")
    ],
    ""
  )
}

// =============================================================================
// Helper Functions
// =============================================================================

@spec default_config(api_token: str) → Config {
  /// Create default config
  given: API token
  when: Initializing image edit client
  then: Returns configured client
}

@impl {
  Config(api_token)
}

@spec simple_seedream(prompt: str) → SeeDreamRequest {
  /// Create simple SeeDream request
  given: Just a prompt
  when: Quick image generation
  then: Returns request with 1K size defaults
}

@impl {
  K1,
    1,
    ∅,
    ∅· SeeDreamRequest
}

@spec seedream_with_size(prompt: str, size: SeeDreamSize) → SeeDreamRequest {
  /// Create SeeDream request with specific size
  given: Prompt and size
  when: Custom resolution needed
  then: Returns configured request
}

@impl {
  size,
    1,
    ∅,
    ∅· SeeDreamRequest
}

@spec seedream_with_image(prompt: str, image_url: str) → SeeDreamRequest {
  /// Create SeeDream request with image input (for image editing)
  given: Prompt and source image URL
  when: Editing existing image
  then: Returns request with image input
}

@impl {
  K1,
    1,
    ☐[image_url] · SeeDreamRequest,
    ∅)
}

@spec simple_qwen_edit(prompt: str, image_url: str) → QwenImageEditRequest {
  /// Create simple Qwen edit request
  given: Prompt and image URL
  when: Quick image edit
  then: Returns request with auto mode defaults
}

@impl {
  image_url,
    Auto,
    true,
    ∅,
    "png"
   · QwenImageEditRequest
}

@spec qwen_edit_with_mode(prompt: str, image_url: str, mode: QwenEditMode) → QwenImageEditRequest {
  /// Create Qwen edit with specific mode
  given: Prompt, image URL, and edit mode
  when: Specific edit mode needed
  then: Returns configured request
}

@impl {
  image_url,
    mode,
    true,
    ∅,
    "png"
   · QwenImageEditRequest
}

@spec qwen_edit_full(prompt: str, image_url: str, mode: QwenEditMode, preserve_quality: bool, seed: int?, output_format: str) → QwenImageEditRequest {
  /// Create full Qwen edit request with all options
  given: All parameters
  when: Full control over edit
  then: Returns fully configured request
}

@impl {
  image_url,
    mode,
    preserve_quality,
    seed,
    output_format
   · QwenImageEditRequest
}

// =============================================================================
// Model Information
// =============================================================================

cache(24h)
@spec supported_seedream_sizes() → [#(str, str]) {
  /// Get supported SeeDream-4.5 sizes
  given: Nothing
  when: Listing available sizes
  then: Returns size options with descriptions
}

@impl {
  [
    #("1K", "1024x1536 - Fast generation"),
    #("2K", "1365x2048 - Balanced quality"),
    #("4K", "2731x4096 - Highest quality"),
    #("custom", "Custom dimensions (1024-4096px)")
  ]
}

cache(24h)
@spec supported_qwen_modes() → [#(str, str]) {
  /// Get supported Qwen edit modes
  given: Nothing
  when: Listing edit modes
  then: Returns mode options with descriptions
}

@impl {
  [
    #("auto", "Automatic - Detect best editing mode"),
    #("semantic", "Semantic - Restructure and modify scene"),
    #("appearance", "Appearance - Local adjustments and details")
  ]
}

cache(24h)
@spec supported_output_formats() → [str] {
  /// Get supported output formats
  given: Nothing
  when: Listing formats
  then: Returns format list
}

@impl {
  ["png", "jpg", "webp"]
}

cache(24h)
@spec model_info() → [#(str, str]) {
  /// Get model information
  given: Nothing
  when: Showing available models
  then: Returns model descriptions
}

@impl {
  [
    #("SeeDream-4.5", "ByteDance - Up to 4K image generation"),
    #("Qwen Image Edit", "Alibaba - 20B parameter image editing")
  ]
}

// =============================================================================
// Pricing Information
// =============================================================================

cache(24h)
@spec pricing() → [#(str, str]) {
  /// Get pricing information
  given: Nothing
  when: Showing costs
  then: Returns pricing per operation
}

@impl {
  [
    #("SeeDream-4.5 1K", "$0.015 per image"),
    #("SeeDream-4.5 2K", "$0.025 per image"),
    #("SeeDream-4.5 4K", "$0.050 per image"),
    #("Qwen Image Edit", "$0.025 per edit")
  ]
}

// =============================================================================
// FFI Imports (provided via @import "vibee/dsl/ffi/json")
// =============================================================================

// These FFI declarations are imported from vibee/dsl/ffi/json:
// - json_object, json_array, json_string, json_int, json_bool, json_to_string
// - list_map, list_reverse
// - empty_fields, add_field, add_optional, build_json

# v8.0

# v8.0
# v10.0 - ML-Powered Migration
