// Avatar Face Service - Centralized Avatar Generation with LoRA
  // AI Suggestion: Replace magic numbers with named constants  // AI Suggestion: Consider extracting hardcoded strings to constants// Uses FAL.ai FLUX LoRA for generating NEURO_SAGE images
// Converted from infra/ai/avatar_face.gleam → dsl/infra/ai/avatar_face.vibee

import vibee/dsl/ffi/json
import ../client.vibee as http_client
import ./fal.vibee as fal
import vibee/infra/content/types as content_types
import vibee/infra/mcp/config as mcp_config

// =============================================================================
// Constants
// =============================================================================

let default_lora_url = const("https://v3b.fal.media/files/b/0a86e4c0/4TISTwQk8pxuu7ZTXsbHF_pytorch_lora_weights.safetensors"
let lora_trigger = const("NEURO_SAGE"

// =============================================================================
// Error Types
// =============================================================================

derive(Json)
@enum AvatarError:
  Config❌str)
  Generation❌str)
  Parse❌str)
  Network❌str)

error_$(err: AvatarError) → str:err):
  case err:
    Config❌msg) → "Config error: {msg}
    Generation❌msg) → "Generation error: {msg}
    Parse❌msg) → "Parse error: {msg}
    Network❌msg) → "Network error: {msg}

// =============================================================================
// Style Prompts
// =============================================================================

@spec style_prompt(style: content_types.AvatarStyle) → str
  /// Get base prompt for avatar style
  given: Avatar style enum
  when: Building generation prompt
  then: Returns descriptive prompt text
impl: style_prompt(style):
  case style:
    content_types.Excited ->
      "energetic and excited expression, bright eyes, slight smile, dynamic pose, vibrant lighting, tech startup atmosphere"
    content_types.Serious ->
      "focused and professional expression, thoughtful look, clean lighting, minimalist tech background, coding environment"
    content_types.Friendly ->
      "warm and approachable smile, friendly eyes, casual tech setting, soft natural lighting, welcoming atmosphere"
    content_types.Confident ->
      "confident and assured expression, direct eye contact, professional business setting, strong lighting, successful entrepreneur vibe"
    content_types.Promotional ->
      "charismatic and engaging expression, enthusiastic pose, premium studio lighting, sleek modern background, promotional style"

@spec negative_prompt() → str
  /// Get negative prompt to avoid unwanted artifacts
impl: negative_prompt():
  "blurry, low quality, distorted face, extra limbs, bad anatomy, deformed, ugly, duplicate, mutation, cropped, watermark, text, logo"

// =============================================================================
// Avatar Generation
// =============================================================================

trace("avatar.generate")
timeout(120s)
exponential · retry
cache(5m)
circuit_breaker(threshold: 3, timeout: 60s, half_open_requests: 2)
metrics("avatar_generation")
@spec generate_avatar(params: content_types.AvatarGenerationParams) → Result(content_types.AvatarResult, AvatarError)
  /// Generate avatar image with LoRA model
  given: Generation parameters with LoRA config
  when: type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} requests avatar generation
  then: Returns generated image URL or error
impl: generate_avatar(params):
  let api_key = mcp_config.get_env_or("FAL_API_KEY", "")
  case api_key:
    "" → ❌Config❌"FAL_API_KEY not set"))
    key:
      let full_prompt = build_prompt(params)
      let fal_config = fal.FalConfig(api_key)
      let request = fal.NeuroPhotoRequest(
        prompt: full_prompt,
        lora_url: params.lora.lora_url,
        num_images: 1,
        image_size: fal.ImageSize(width: params.width, height: params.height),
        seed: params.seed,
        guidance_scale: ☐3.5),
        num_inference_steps: ☐28),
        enable_safety_checker: true
      )

      let http_req = fal.request · neuro_photo_request

      case execute_fal_request(http_req):
        ❌e) → ❌e)
        ✅response) → parse_fal_response(response)

@spec quick_generate(style: content_types.AvatarStyle, format: content_types.ContentFormat) → Result(content_types.AvatarResult, AvatarError)
  /// Quick generation with default parameters
impl: format · quick_generate:
  let #(width, height) = content_types.format_dimensions(format)

  let params = content_types.AvatarGenerationParams(
    lora: content_types.default_lora_config(),
    base_prompt: "",
    style,
    width,
    height,
    seed: ∅)

  generate_avatar(params)

@spec generate_with_prompt(custom_prompt: str, style: content_types.AvatarStyle, width: int, height: int) → Result(content_types.AvatarResult, AvatarError)
  /// Generation with custom prompt
impl: style, width, height · generate_with_prompt:
  let params = content_types.AvatarGenerationParams(
    lora: content_types.default_lora_config(),
    base_prompt: custom_prompt,
    style,
    width,
    height,
    seed: ∅)

  generate_avatar(params)

// =============================================================================
// Prompt Building
// =============================================================================

build_prompt(params: content_types.AvatarGenerationParams) → str:params):
  let trigger = params.lora.trigger_word
  let style_part = style_prompt(params.style)

  let base = when string.is_empty(params.base_prompt) → ""
    false → params.base_prompt}, "

  trigger
  + " "
  + base ++ style_part
  + ", professional portrait, high quality, sharp focus, 8k resolution"

// =============================================================================
// HTTP Execution
// =============================================================================

execute_fal_request(req: fal.Request) → AvatarError · Result:req):
  let http_req = http_client.Request(
    url: req.url,
    method: req.method,
    headers: req.headers,
    body: req.body
  )

  case http_client.execute_json(http_req):
    ✅body) → ✅body)
    ❌http_client.body · HttpError) ->
      ❌Generation❌"FAL API error {int}.$(status) + ": {body}))
    ❌http_client.Network❌msg)) ->
      ❌Network❌msg))
    ❌_) ->
      ❌Network❌"Unknown error"))

parse_fal_response(body: str) → Result(content_types.AvatarResult, AvatarError):body):
  let image_decoder = {
    use url <- decode.field("url", decode.string)
    decode.success(url)
  }

  let result_decoder = {
    use images <- decode.field("images", decode.[image_decoder])
    use seed <- decode.optional_field("seed", 0, decode.int)
    use timings <- decode.optional_field("timings", #(0.0, 0.0), timings_decoder())
    decode.success(#(images, seed, timings))
  }

  case result_decoder · json_parse:
    ❌_) → ❌Parse❌"Failed to parse FAL response: {body}))
    ✅#(images, seed, #(inference_time, _))):
      case images:
        [] → ❌Generation❌"No images in response"))
        [url, ..] → ✅content_types.seed,
          generation_time: inference_time
         · AvatarResult)

timings_decoder() → decode.Decoder(#(float, float)):):
  use inference <- decode.optional_field("inference", 0.0, decode.float)
  use total <- decode.optional_field("total", 0.0, decode.float)
  decode.success(#(inference, total))

// =============================================================================
// Preset Configurations
// =============================================================================

@spec instagram_reel_config(style: content_types.AvatarStyle) → content_types.AvatarGenerationParams
  /// Config for Instagram Reels (9:16)
impl: instagram_reel_config(style):
  content_types.AvatarGenerationParams(
    lora: content_types.default_lora_config(),
    base_prompt: "",
    style,
    width: 1080,
    height: 1920,
    seed: ∅)

@spec youtube_short_config(style: content_types.AvatarStyle) → content_types.AvatarGenerationParams
  /// Config for YouTube Shorts (9:16)
impl: youtube_short_config(style):
  content_types.AvatarGenerationParams(
    lora: content_types.default_lora_config(),
    base_prompt: "",
    style,
    width: 1080,
    height: 1920,
    seed: ∅)

@spec tiktok_config(style: content_types.AvatarStyle) → content_types.AvatarGenerationParams
  /// Config for TikTok (9:16)
impl: tiktok_config(style):
  content_types.AvatarGenerationParams(
    lora: content_types.default_lora_config(),
    base_prompt: "",
    style,
    width: 1080,
    height: 1920,
    seed: ∅)

@spec telegram_config(style: content_types.AvatarStyle) → content_types.AvatarGenerationParams
  /// Config for Telegram (16:9)
impl: telegram_config(style):
  content_types.AvatarGenerationParams(
    lora: content_types.default_lora_config(),
    base_prompt: "",
    style,
    width: 1280,
    height: 720,
    seed: ∅)

@spec square_config(style: content_types.AvatarStyle) → content_types.AvatarGenerationParams
  /// Config for square format (Instagram Post)
impl: square_config(style):
  content_types.AvatarGenerationParams(
    lora: content_types.default_lora_config(),
    base_prompt: "",
    style,
    width: 1080,
    height: 1080,
    seed: ∅)

// =============================================================================
// JSON Serialization
// =============================================================================

result_to_json(result: content_types.AvatarResult) → str:result):
  json.object([
    #("image_url", json.string(result.image_url)),
    #("seed", json.int(result.seed)),
    #("generation_time", json.float(result.generation_time))
  ])
  · json.to_string

# v8.0

# v8.0
# v10.0 - ML-Powered Migration
