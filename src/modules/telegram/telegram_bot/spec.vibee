name: telegram_bot
version: 2.0.0
description: VIBEE Telegram Bot - AI content creation platform with 45+ features
type: otp_application
platform: telegram

# ============================================================================
# CORE BEHAVIORS (15 key scenarios)
# ============================================================================

behaviors:
  # 1. BOT LIFECYCLE
  - name: bot_startup
    given: Bot application starts with valid config
    when: Actor supervisor starts telegram_bot_actor
    then: Bot is online and responding to commands
    test_cases:
      - name: successful_startup
        input: {token: "valid_token", mode: "webhook"}
        expected: {status: "online", webhook_set: true}
      - name: startup_invalid_token
        input: {token: "invalid"}
        expected: {error: "AuthError", retry: true}
      - name: startup_polling_mode
        input: {token: "valid", mode: "polling"}
        expected: {status: "online", polling: true}
      - name: startup_db_unavailable
        input: {token: "valid", db: "down"}
        expected: {error: "DBError", retry: true}

  # 2. USER ONBOARDING
  - name: user_first_start
    given: New user sends /start command
    when: Create user record and show welcome
    then: User created, language selection shown
    test_cases:
      - name: new_user_no_ref
        input: {user_id: 123, username: "john"}
        expected: {created: true, scene: "welcome", bonus: 0}
      - name: new_user_with_ref
        input: {user_id: 123, ref: 456}
        expected: {created: true, referrer: 456, bonus: 100, scene: "welcome"}
      - name: existing_user_start
        input: {user_id: 123, exists: true}
        expected: {created: false, scene: "main_menu"}
      - name: new_user_invalid_ref
        input: {user_id: 123, ref: 999}
        expected: {created: true, referrer: null, bonus: 0}
      - name: new_user_self_ref
        input: {user_id: 123, ref: 123}
        expected: {created: true, referrer: null, bonus: 0, error: "self_ref"}

  - name: language_selection
    given: User in welcome scene
    when: User selects language
    then: Language saved, interface updated
    test_cases:
      - name: select_english
        input: {user_id: 123, lang: "en"}
        expected: {saved: "en", scene: "onboarding", msg_lang: "en"}
      - name: select_russian
        input: {user_id: 123, lang: "ru"}
        expected: {saved: "ru", scene: "onboarding", msg_lang: "ru"}
      - name: select_unsupported_lang
        input: {user_id: 123, lang: "fr"}
        expected: {saved: "en", scene: "onboarding", fallback: true}
      - name: change_language_later
        input: {user_id: 123, lang: "ru", current: "en"}
        expected: {saved: "ru", scene: "settings", updated: true}

  # 3. MAIN MENU (NEW 3-CATEGORY STRUCTURE)
  - name: show_main_menu
    given: User authenticated
    when: User requests main menu
    then: 3-category menu displayed with balance
    test_cases:
      - name: main_menu_normal_balance
        input: {user_id: 123, balance: 500}
        expected: {categories: 3, balance_shown: true, warning: false}
      - name: main_menu_low_balance
        input: {user_id: 123, balance: 10}
        expected: {categories: 3, warning: "low_balance", buy_highlighted: true}
      - name: main_menu_zero_balance
        input: {user_id: 123, balance: 0}
        expected: {categories: 3, warning: "no_credits", buy_highlighted: true}
      - name: main_menu_high_balance
        input: {user_id: 123, balance: 10000}
        expected: {categories: 3, balance_shown: true, vip_badge: true}
      - name: main_menu_with_recent
        input: {user_id: 123, balance: 500, recent: ["NeuroPhoto", "Reels"]}
        expected: {categories: 3, quick_actions: 2}

  - name: navigate_ai_create
    given: User in main menu
    when: User clicks "AI Create"
    then: AI features menu with Popular section shown
    test_cases:
      - name: show_ai_create_menu
        input: {user_id: 123}
        expected: {sections: ["Popular", "Images", "Videos", "Audio", "Avatars"], popular_count: 5}
      - name: ai_create_with_favorites
        input: {user_id: 123, favorites: ["NeuroPhoto"]}
        expected: {sections: 5, favorites_section: true}
      - name: ai_create_first_time
        input: {user_id: 123, first_time: true}
        expected: {sections: 5, tutorial_shown: true}

  - name: search_features
    given: User wants to find feature
    when: User types /search or uses search button
    then: Matching features displayed
    test_cases:
      - name: search_by_name
        input: {user_id: 123, query: "photo"}
        expected: {results: 7, top: "NeuroPhoto"}
      - name: search_by_description
        input: {user_id: 123, query: "generate video"}
        expected: {results: 4, top: "Reels Creator"}
      - name: search_no_results
        input: {user_id: 123, query: "xyz123"}
        expected: {results: 0, suggestions: true, popular_shown: true}
      - name: search_empty_query
        input: {user_id: 123, query: ""}
        expected: {error: "empty_query", popular_shown: true}
      - name: search_partial_match
        input: {user_id: 123, query: "neu"}
        expected: {results: 2, fuzzy: true}

  # 4. IMAGE GENERATION (NeuroPhoto)
  - name: neurophoto_generate
    given: User selected model and entered prompt
    when: Deduct credits and send to AI service
    then: Image generated and sent to user
    test_cases:
      - name: generate_nano_banana
        input: {user_id: 123, model: "nano", prompt: "sunset", balance: 100}
        expected: {deducted: 5, balance: 95, job: true, eta: 10}
      - name: generate_flux_lora
        input: {user_id: 123, model: "flux", prompt: "cyberpunk city", balance: 100}
        expected: {deducted: 15, balance: 85, job: true, eta: 30}
      - name: generate_insufficient_credits
        input: {user_id: 123, model: "flux", prompt: "test", balance: 10}
        expected: {error: "insufficient", required: 15, scene: "buy_credits"}
      - name: generate_empty_prompt
        input: {user_id: 123, model: "nano", prompt: ""}
        expected: {error: "empty_prompt", deducted: 0}
      - name: generate_nsfw_prompt
        input: {user_id: 123, model: "nano", prompt: "nsfw content"}
        expected: {error: "nsfw_detected", deducted: 0}
      - name: generate_success
        input: {job_id: "j1", status: "completed", url: "img.jpg"}
        expected: {image_sent: true, buttons: ["Regenerate", "Favorite", "Share"]}
      - name: generate_failed
        input: {job_id: "j1", status: "failed", error: "timeout"}
        expected: {error_shown: true, refunded: 5}

  # 5. VIDEO GENERATION (Reels Creator)
  - name: reels_creator_generate
    given: User selected template and niche
    when: Process video with template
    then: Reel generated and sent
    test_cases:
      - name: generate_business_reel
        input: {user_id: 123, template: "split", niche: "business", images: 2, balance: 200}
        expected: {deducted: 50, balance: 150, job: true, eta: 60}
      - name: generate_with_music
        input: {user_id: 123, template: "fullscreen", niche: "lifestyle", music: true, balance: 200}
        expected: {deducted: 60, music_applied: true}
      - name: generate_insufficient_credits
        input: {user_id: 123, template: "split", balance: 30}
        expected: {error: "insufficient", required: 50}
      - name: generate_no_images
        input: {user_id: 123, template: "split", images: 0}
        expected: {error: "no_images", deducted: 0}
      - name: generate_success
        input: {job_id: "j2", status: "completed", url: "video.mp4"}
        expected: {video_sent: true, buttons: ["Regenerate", "Share"]}

  # 6. AUDIO GENERATION (Voice Clone)
  - name: voice_clone_train
    given: User uploaded audio sample
    when: Validate and start training
    then: Voice model created
    test_cases:
      - name: train_valid_sample
        input: {user_id: 123, duration: 60, quality: "good", balance: 500}
        expected: {deducted: 200, balance: 300, training: true, eta: 300}
      - name: train_too_short
        input: {user_id: 123, duration: 15}
        expected: {error: "too_short", min: 30, deducted: 0}
      - name: train_too_long
        input: {user_id: 123, duration: 400}
        expected: {error: "too_long", max: 300, deducted: 0}
      - name: train_noisy_audio
        input: {user_id: 123, duration: 60, quality: "poor"}
        expected: {error: "poor_quality", deducted: 0}
      - name: train_insufficient_credits
        input: {user_id: 123, duration: 60, balance: 100}
        expected: {error: "insufficient", required: 200}
      - name: train_success
        input: {job_id: "j3", status: "completed", model_id: "vm_123"}
        expected: {model_saved: true, notification_sent: true}

  # 7. CONTENT MANAGEMENT
  - name: view_history
    given: User has created content
    when: User opens My Content
    then: Recent 10 items displayed
    test_cases:
      - name: history_with_content
        input: {user_id: 123, count: 15}
        expected: {shown: 10, has_more: true, types: ["image", "video"]}
      - name: history_empty
        input: {user_id: 123, count: 0}
        expected: {shown: 0, cta: "create", message: "No content yet"}
      - name: history_single_type
        input: {user_id: 123, count: 5, type: "image"}
        expected: {shown: 5, filtered: true}
      - name: history_pagination
        input: {user_id: 123, count: 25, page: 2}
        expected: {shown: 10, page: 2, total_pages: 3}

  - name: add_to_favorites
    given: User viewing content
    when: User clicks Add to Favorites
    then: Content added to favorites list
    test_cases:
      - name: add_new_favorite
        input: {user_id: 123, content_id: "c1"}
        expected: {added: true, count: 1, message: "Added to favorites"}
      - name: add_duplicate_favorite
        input: {user_id: 123, content_id: "c1", exists: true}
        expected: {added: false, error: "Already in favorites"}
      - name: remove_favorite
        input: {user_id: 123, content_id: "c1", action: "remove"}
        expected: {removed: true, count: 0}
      - name: view_favorites
        input: {user_id: 123}
        expected: {count: 5, items_shown: 5}

  # 8. PAYMENTS
  - name: buy_credits_stars
    given: User selected Telegram Stars payment
    when: Create invoice and send to Telegram
    then: Invoice sent, credits added on payment
    test_cases:
      - name: create_stars_invoice
        input: {user_id: 123, package: "starter", stars: 50, credits: 100}
        expected: {invoice: true, scene: "payment_pending"}
      - name: payment_successful
        input: {user_id: 123, payment_id: "p1", success: true, credits: 100}
        expected: {credits_added: 100, notification: true, scene: "payment_success"}
      - name: payment_failed
        input: {user_id: 123, payment_id: "p1", success: false}
        expected: {credits_added: 0, error_shown: true, scene: "payment_method"}
      - name: payment_cancelled
        input: {user_id: 123, payment_id: "p1", cancelled: true}
        expected: {credits_added: 0, scene: "buy_credits"}

  - name: buy_credits_card
    given: User selected card payment
    when: Create Robokassa payment link
    then: User redirected to payment page
    test_cases:
      - name: create_card_payment
        input: {user_id: 123, package: "pro", rub: 500, credits: 500}
        expected: {link: true, redirect_url: "https://robokassa.ru/..."}
      - name: card_payment_success
        input: {user_id: 123, payment_id: "p2", success: true}
        expected: {credits_added: 500, notification: true}
      - name: card_payment_failed
        input: {user_id: 123, payment_id: "p2", error: "declined"}
        expected: {credits_added: 0, error_shown: true}

  # 9. ERROR HANDLING
  - name: handle_api_error
    given: AI service returns error
    when: Detect error and refund credits
    then: User notified, credits refunded
    test_cases:
      - name: api_timeout
        input: {user_id: 123, job_id: "j1", error: "timeout", deducted: 15}
        expected: {refunded: 15, error_shown: true, retry_button: true}
      - name: api_rate_limit
        input: {user_id: 123, error: "rate_limit"}
        expected: {retry_after: 60, message: "Please try again in 1 minute"}
      - name: api_nsfw_detected
        input: {user_id: 123, job_id: "j1", error: "nsfw", deducted: 15}
        expected: {refunded: 15, warning_shown: true}
      - name: api_service_down
        input: {user_id: 123, error: "service_unavailable"}
        expected: {error_shown: true, alternative_suggested: true}
      - name: insufficient_credits_during_job
        input: {user_id: 123, job_id: "j1", error: "insufficient"}
        expected: {job_cancelled: true, scene: "buy_credits"}

  # 10. ANALYTICS
  - name: track_feature_usage
    given: User uses a feature
    when: Log event and update stats
    then: Analytics recorded
    test_cases:
      - name: track_neurophoto_usage
        input: {user_id: 123, feature: "neurophoto", model: "flux", credits: 15}
        expected: {logged: true, stats_updated: true}
      - name: track_payment
        input: {user_id: 123, event: "payment", method: "stars", amount: 100}
        expected: {logged: true, revenue_tracked: true}
      - name: track_referral
        input: {user_id: 123, event: "referral", referred: 456}
        expected: {logged: true, referral_counted: true}
      - name: view_user_stats
        input: {user_id: 123, period: "month"}
        expected: {total_credits: 500, content_created: 50, most_used: "NeuroPhoto"}

# ============================================================================
# TYPES
# ============================================================================

types:
  User:
    id: int
    telegram_id: int
    username: str?
    language: str
    balance: int
    created_at: timestamp
    
  Scene:
    name: str
    state: map<str, any>
    previous: str?
    
  Job:
    id: str
    user_id: int
    type: str
    status: str
    credits_used: int
    
  Content:
    id: str
    user_id: int
    type: str
    url: str
    is_favorite: bool

# ============================================================================
# FUNCTIONS
# ============================================================================

functions:
  - name: create_user
    params: {telegram_id: int, username: str?, language: str}
    returns: User
    
  - name: update_balance
    params: {user_id: int, amount: int, description: str}
    returns: Transaction
    
  - name: enter_scene
    params: {user_id: int, scene: str, state: map?}
    returns: Scene
    
  - name: create_job
    params: {user_id: int, type: str, input: map, credits: int}
    returns: Job
    
  - name: save_content
    params: {user_id: int, type: str, url: str, metadata: map}
    returns: Content

# ============================================================================
# COMPLETENESS
# ============================================================================

completeness:
  required_behaviors: 15
  required_test_cases: 75
  test_coverage: 100%
  all_behaviors_implemented: true
  edge_cases_covered: true
  error_scenarios_covered: true
