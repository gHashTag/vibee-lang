// ux_improvements.gleam - UX enhancements and Quick Wins
import gleam/option.{type Option, None, Some}
import gleam/int

// Quick Win #1: Balance display everywhere
pub type BalanceDisplay {
  BalanceDisplay(
    amount: Int,
    show_warning: Bool,
    warning_threshold: Int,
  )
}

pub fn format_balance(balance: Int) -> String {
  let emoji = case balance {
    b if b >= 1000 -> "ğŸ’"
    b if b >= 100 -> "ğŸ’°"
    b if b >= 50 -> "ğŸ’µ"
    _ -> "âš ï¸"
  }
  
  emoji <> "{ }int".to_string(balance) <> " credits"
}

pub fn should_show_warning(balance: Int) -> Bool {
  balance < 50
}

// Quick Win #2: Back buttons everywhere
pub type BackButton {
  BackButton(
    text: String,
    destination: String,
    show_home: Bool,
  )
}

pub fn create_back_button(previous_scene: Option(String)) -> List(String) {
  case previous_scene {
    Some(scene) -> ["â—€ï¸ Back", "ğŸ  Main Menu"]
    None -> ["ğŸ  Main Menu"]
  }
}

// Quick Win #3: Help links in every menu
pub fn add_help_button(buttons: List(List(String))) -> List(List(String)) {
  list.append(buttons, [["â“ Help"]])
}

// Quick Win #4: Popular features section
pub type PopularFeature {
  PopularFeature(
    id: String,
    name: String,
    icon: String,
    usage_count: Int,
    avg_rating: Float,
  )
}

pub fn get_popular_features(limit: Int) -> List(PopularFeature) {
  [
    PopularFeature(
      id: "neurophoto",
      name: "NeuroPhoto",
      icon: "ğŸ¨",
      usage_count: 15420,
      avg_rating: 4.8,
    ),
    PopularFeature(
      id: "reels_creator",
      name: "Reels Creator",
      icon: "ğŸ¬",
      usage_count: 8930,
      avg_rating: 4.7,
    ),
    PopularFeature(
      id: "voice_clone",
      name: "Voice Clone",
      icon: "ğŸ¤",
      usage_count: 6540,
      avg_rating: 4.9,
    ),
    PopularFeature(
      id: "talking_photo",
      name: "Talking Photo",
      icon: "ğŸ—£ï¸",
      usage_count: 5210,
      avg_rating: 4.6,
    ),
    PopularFeature(
      id: "text_to_image",
      name: "Text to Image",
      icon: "ğŸ–¼ï¸",
      usage_count: 4890,
      avg_rating: 4.5,
    ),
  ]
  |> list.take(limit)
}

// Quick Win #5: Search command
pub type SearchSuggestion {
  SearchSuggestion(
    query: String,
    category: String,
    relevance: Float,
  )
}

pub fn get_search_suggestions() -> List(String) {
  [
    "photo",
    "video",
    "voice",
    "avatar",
    "image",
    "reels",
    "clone",
    "generate",
  ]
}

// Progressive disclosure - show features based on user level
pub type UserLevel {
  Beginner
  Intermediate
  Advanced
  Expert
}

pub fn determine_user_level(total_usage: Int) -> UserLevel {
  case total_usage {
    u if u >= 100 -> Expert
    u if u >= 50 -> Advanced
    u if u >= 10 -> Intermediate
    _ -> Beginner
  }
}

pub fn get_recommended_features(level: UserLevel) -> List(String) {
  case level {
    Beginner -> [
      "neurophoto",
      "text_to_image",
      "text_to_speech",
    ]
    Intermediate -> [
      "reels_creator",
      "talking_photo",
      "image_enhancement",
    ]
    Advanced -> [
      "voice_clone",
      "image_to_video",
      "digital_avatar",
    ]
    Expert -> [
      "3d_avatar",
      "music_generation",
      "advanced_editing",
    ]
  }
}

// Contextual help - show tips based on current scene
pub type ContextualTip {
  ContextualTip(
    scene: String,
    tip: String,
    show_once: Bool,
  )
}

pub fn get_contextual_tip(scene: String) -> Option(String) {
  case scene {
    "neurophoto_prompt" -> Some(
      "ğŸ’¡ Tip: Be specific in your prompt for better results. Example: 'A sunset over mountains, golden hour, cinematic'"
    )
    "reels_template" -> Some(
      "ğŸ’¡ Tip: Split template works best for before/after content. Fullscreen is great for quotes."
    )
    "voice_clone_upload" -> Some(
      "ğŸ’¡ Tip: Use clear audio with minimal background noise for best voice cloning results."
    )
    "buy_credits" -> Some(
      "ğŸ’¡ Tip: Larger packages offer better value. Pro package saves you 20%!"
    )
    _ -> None
  }
}

// Quick actions - frequently used actions
pub type QuickAction {
  QuickAction(
    id: String,
    label: String,
    icon: String,
    scene: String,
  )
}

pub fn get_quick_actions(recent_features: List(String)) -> List(QuickAction) {
  // Show quick actions for recently used features
  list.map(recent_features, fn(feature_id) {
    case feature_id {
      "neurophoto" -> QuickAction(
        id: "neurophoto_quick",
        label: "Generate Image",
        icon: "ğŸ¨",
        scene: "neurophoto",
      )
      "reels_creator" -> QuickAction(
        id: "reels_quick",
        label: "Create Reel",
        icon: "ğŸ¬",
        scene: "reels_creator",
      )
      _ -> QuickAction(
        id: "{\1}_quick",
        label: "Quick Access",
        icon: "âš¡",
        scene: feature_id,
      )
    }
  })
  |> list.take(3)
}

// Onboarding improvements
pub type OnboardingStep {
  OnboardingStep(
    number: Int,
    title: String,
    description: String,
    image_url: Option(String),
    cta: String,
  )
}

pub fn get_onboarding_steps() -> List(OnboardingStep) {
  [
    OnboardingStep(
      number: 1,
      title: "ğŸ¨ Create Amazing Content",
      description: "Generate images, videos, audio, and avatars with AI. Over 45 tools at your fingertips!",
      image_url: Some("https://cdn.vibee.dev/onboarding/step1.jpg"),
      cta: "Next",
    ),
    OnboardingStep(
      number: 2,
      title: "ğŸ’° Simple Credit System",
      description: "Pay only for what you use. Start with 100 free credits. No subscriptions!",
      image_url: Some("https://cdn.vibee.dev/onboarding/step2.jpg"),
      cta: "Next",
    ),
    OnboardingStep(
      number: 3,
      title: "ğŸš€ Get Started Now",
      description: "Try NeuroPhoto - our most popular feature. Generate your first AI image!",
      image_url: Some("https://cdn.vibee.dev/onboarding/step3.jpg"),
      cta: "Start Creating",
    ),
  ]
}

// Error recovery suggestions
pub type ErrorRecovery {
  ErrorRecovery(
    error_type: String,
    suggestion: String,
    action: String,
    action_scene: String,
  )
}

pub fn get_error_recovery(error_type: String) -> Option(ErrorRecovery) {
  case error_type {
    "insufficient_credits" -> Some(ErrorRecovery(
      error_type: "insufficient_credits",
      suggestion: "You need more credits to use this feature",
      action: "Buy Credits",
      action_scene: "buy_credits",
    ))
    "api_timeout" -> Some(ErrorRecovery(
      error_type: "api_timeout",
      suggestion: "The service is busy. Your credits have been refunded",
      action: "Try Again",
      action_scene: "retry",
    ))
    "nsfw_detected" -> Some(ErrorRecovery(
      error_type: "nsfw_detected",
      suggestion: "Please use appropriate content",
      action: "Learn More",
      action_scene: "content_policy",
    ))
    _ -> None
  }
}

// Feature discovery - suggest features user hasn't tried
pub fn get_undiscovered_features(used_features: List(String)) -> List(String) {
  let all_features = [
    "neurophoto",
    "reels_creator",
    "voice_clone",
    "talking_photo",
    "text_to_image",
    "image_to_video",
    "text_to_speech",
    "digital_avatar",
    "3d_avatar",
    "music_generation",
  ]
  
  list.filter(all_features, fn(feature) {
    !list.contains(used_features, feature)
  })
  |> list.take(3)
}

// Smart defaults based on user preferences
pub type UserPreferences {
  UserPreferences(
    favorite_model: Option(String),
    preferred_quality: String,
    auto_save: Bool,
    notification_enabled: Bool,
  )
}

pub fn get_smart_defaults(prefs: UserPreferences, feature: String) -> List(#(String, String)) {
  case feature {
    "neurophoto" -> [
      #("model", prefs.favorite_model |> option.unwrap("nano_banana")),
      #("quality", prefs.preferred_quality),
    ]
    "reels_creator" -> [
      #("quality", prefs.preferred_quality),
      #("auto_save", case prefs.auto_save { True -> "yes" False -> "no" }),
    ]
    _ -> []
  }
}

// Feedback collection
pub type FeedbackPrompt {
  FeedbackPrompt(
    trigger: String,
    question: String,
    options: List(String),
  )
}

pub fn should_show_feedback(usage_count: Int) -> Bool {
  // Show feedback after 5, 20, 50 uses
  usage_count == 5 || usage_count == 20 || usage_count == 50
}

pub fn get_feedback_prompt(feature: String) -> FeedbackPrompt {
  FeedbackPrompt(
    trigger: "after_generation",
    question: "How was your experience with {feature}?",
    options: ["ğŸ˜ Amazing", "ğŸ‘ Good", "ğŸ˜ Okay", "ğŸ‘ Poor"],
  )
}
