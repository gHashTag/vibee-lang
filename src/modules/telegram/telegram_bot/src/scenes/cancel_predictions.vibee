// Cancel Predictions Wizard
  // AI Suggestion: Code is deeply nested, consider refactoring  // AI Suggestion: Consider extracting hardcoded strings to constants  // AI Suggestion: Replace magic numbers with named constants// Manage and cancel pending AI generation jobs
  // Performance Warning: // Based on 999-multibots-telegraf cancelPredictionsWizard

import ../i18n/scenes_i18n.vibee as i18n

scene CancelPredictions:,
  desc: "Cancel pending generation jobs and manage queue"

  @Jobs listed: type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} views ‚Üí sees pending jobs
  @Job cancelled: type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} cancels ‚Üí refund processed

  on Main:
    enter:
      ‚Üí lang = get_type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_language(type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id)
      ‚Üí pending_jobs = get_pending_jobs(type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id)
      ‚Üí case pending_jobs:
           [] ‚Üí {
             ‚Üí send(case lang: "en" ‚Üí "‚úÖ You have no active generations" _ ‚Üí "‚úÖ –£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –≥–µ–Ω–µ—Ä–∞—Ü–∏–π")
             ‚Üí kb([
                  btn("common", "menu" ¬∑ t, "menu")
                ])
           }
           jobs ‚Üí {
             ‚Üí send(case lang:
                  "en" ‚Üí "‚è≥ <b>Active generations</b>\n\n {format_jobs_list}"(jobs, lang) + "\n\nSelect generation to cancel:"
                  _ ‚Üí "‚è≥ <b>–ê–∫—Ç–∏–≤–Ω—ã–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏</b>\n\n {format_jobs_list}"(jobs, lang) + "\n\n–í—ã–±–µ—Ä–∏—Ç–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –¥–ª—è –æ—Ç–º–µ–Ω—ã:")
             ‚Üí buttons = jobs
                  ¬∑ map{ j btn(j." {j}{type_icon}".short_desc, "job:{j}".ID) }
             ‚Üí kb(buttons  + [
                  btn(case lang: "en" ‚Üí "‚ùå Cancel all" _ ‚Üí "‚ùå –û—Ç–º–µ–Ω–∏—Ç—å –≤—Å–µ", "cancel_all"),
                  btn("common", "menu" ¬∑ t, "menu")
                ])
           }

    callback /^job:(.+)$/:
      ‚Üí job_id = extract_id(callback_data)
      ‚Üí goto ConfirmCancel(job_id)

    @cancel_all ‚Üí goto ConfirmCancelAll
    @menu ‚Üí exit(Idle)

  on ConfirmCancel(job_id):
    enter:
      ‚Üí lang = get_type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_language(type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id)
      ‚Üí job = get_job(job_id)
      ‚Üí refund_amount = calculate_refund(job)
      ‚Üí send(case lang:
           "en" ‚Üí "‚ùì <b>Cancel generation?</b>\n\n {job}"." {job}{type_icon}"."\nüìä Status: {job}{description}"."\n‚è±Ô∏è In queue: {job}{status_label}"."\n\nüí∞ Refund: {to_string}{queue_time}"(refund_amount) + " ‚≠ê"
           _ ‚Üí "‚ùì <b>–û—Ç–º–µ–Ω–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é?</b>\n\n {job}"." {job}{type_icon}"."\nüìä –°—Ç–∞—Ç—É—Å: {job}{description}"."\n‚è±Ô∏è –í –æ—á–µ—Ä–µ–¥–∏: {job}{status_label}"."\n\nüí∞ –í–æ–∑–≤—Ä–∞—Ç: {to_string}{queue_time}"(refund_amount) + " ‚≠ê")
      ‚Üí kb([
           btn(case lang: "en" ‚Üí "‚úÖ Yes, cancel" _ ‚Üí "‚úÖ –î–∞, –æ—Ç–º–µ–Ω–∏—Ç—å", "confirm"),
           btn("common", "back" ¬∑ t, "back")
         ])

    @confirm:
      ‚Üí lang = get_type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_language(type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id)
      ‚Üí job = get_job(job_id)
      ‚Üí case cancel_job(job_id):
           ‚úÖrefund) ‚Üí {
             ‚Üí send(case lang: "en" ‚Üí "‚úÖ Generation cancelled. Refunded " _ ‚Üí "‚úÖ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞. –í–æ–∑–≤—Ä–∞—â–µ–Ω–æ {to_string}"(refund) + " ‚≠ê")
             ‚Üí goto Main
           }
           ‚ùå"already_processing") ‚Üí {
             ‚Üí send(case lang: "en" ‚Üí "‚ö†Ô∏è Generation already in progress, cannot cancel" _ ‚Üí "‚ö†Ô∏è –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–∂–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è, –æ—Ç–º–µ–Ω–∞ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–∞")
             ‚Üí goto Main
           }
           ‚ùåmsg) ‚Üí {
             ‚Üí send("‚ùå {msg}")
             ‚Üí goto Main
           }

    @back ‚Üí goto Main

  on ConfirmCancelAll:
    enter:
      ‚Üí jobs = get_pending_jobs(type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id)
      ‚Üí total_refund = jobs ¬∑ map(calculate_refund) ¬∑ sum
      ‚Üí cancellable = jobs |filter( it.status == "pending" }
      ‚Üí send("""
        ‚ùì <b>–û—Ç–º–µ–Ω–∏—Ç—å –≤—Å–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏?</b>

        –ë—É–¥–µ—Ç –æ—Ç–º–µ–Ω–µ–Ω–æ: #{len(cancellable)} –∏–∑ #{len(jobs)}
        üí∞ –û–±—â–∏–π –≤–æ–∑–≤—Ä–∞—Ç: #{total_refund} ‚≠ê

        ‚ö†Ô∏è –ì–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –Ω–µ –±—É–¥—É—Ç –æ—Ç–º–µ–Ω–µ–Ω—ã.
        """)
      ‚Üí kb([
           btn("‚úÖ –û—Ç–º–µ–Ω–∏—Ç—å –≤—Å–µ", "confirm"),
           btn("üîô –ù–∞–∑–∞–¥", "back")
         ])

    @confirm:
      ‚Üí result = cancel_all_pending_jobs(type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id)
      ‚Üí send("""
        ‚úÖ <b>–û—Ç–º–µ–Ω–µ–Ω–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–π:</b> #{result.cancelled}
        üí∞ <b>–í–æ–∑–≤—Ä–∞—â–µ–Ω–æ:</b> #{result.refunded} ‚≠ê

        #{when result.skipped > 0 ‚Üí "‚ö†Ô∏è –ü—Ä–æ–ø—É—â–µ–Ω–æ (–≤ –ø—Ä–æ—Ü–µ—Å—Å–µ): {to_string}"(result.skipped)
            false ‚Üí ""
          }
        """)
      ‚Üí goto Main

    @back ‚Üí goto Main

// =============================================================================
// JOB STATUS MONITOR
// =============================================================================

scene JobStatus:,
  desc: "Monitor status of a specific generation job"

  @Status shown: job id ‚Üí current status displayed

  on Monitor(job_id):
    enter:
      ‚Üí job = get_job(job_id)
      ‚Üí case job:
           ‚àÖ-> {
             ‚Üí send("‚ùå –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
             ‚Üí exit(Idle)
           }
           job ‚Üí {
             ‚Üí send(format_job_status(job))
             ‚Üí kb([
                  btn("üîÑ –û–±–Ω–æ–≤–∏—Ç—å", "refresh"),
                  btn("‚ùå –û—Ç–º–µ–Ω–∏—Ç—å", "cancel") ¬∑ if_visible(job.status == "pending"),
                  btn("üè† –í –º–µ–Ω—é", "menu")
                ])
           }

    @refresh ‚Üí enter
    @cancel ‚Üí goto ConfirmCancel(job_id)
    @menu ‚Üí exit(Idle)

    // Auto-update when job completes
    @event job_completed(result):
      ‚Üí send("‚úÖ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!")
      ‚Üí send_result(result)
      ‚Üí exit(Idle)

    @event job_failed(error):
      ‚Üí send("‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: {error}")
      ‚Üí refund = process_failure_refund(job_id)
      ‚Üí send("üí∞ –í–æ–∑–≤—Ä–∞—â–µ–Ω–æ: {to_string}"(refund) + " ‚≠ê")
      ‚Üí exit(Idle)

// =============================================================================
// CONSTANTS
// =============================================================================

let JOB_TYPE_ICONS = const({
  "neuro_photo": "üñºÔ∏è",
  "text_to_video": "üé¨",
  "image_to_video": "üìπ",
  "voice_clone": "üé§",
  "avatar_video": "üé≠",
  "reels": "üì±",
  "lipsync": "üëÑ"
}

let JOB_STATUS_LABELS = const({
  "pending": "‚è≥ –í –æ—á–µ—Ä–µ–¥–∏",
  "processing": "üîÑ –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è",
  "completed": "‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ",
  "failed": "‚ùå –û—à–∏–±–∫–∞",
  "cancelled": "üö´ –û—Ç–º–µ–Ω–µ–Ω–æ"
}

// =============================================================================
// HELPER FUNCTIONS
// =============================================================================

get_pending_jobs(type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id):
  db_query("SELECT * FROM jobs WHERE type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id = ? AND status in ('pending', 'processing') ORDER BY created_at", [type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id])

get_job(job_id):
  db_query_one("SELECT * FROM jobs WHERE id = ?", [job_id])

format_jobs_list(jobs):
  jobs
    ¬∑ map{ j
         icon = JOB_TYPE_ICONS[j.type] ?? "üì¶"
         status = JOB_STATUS_LABELS[j.status] ?? j.status
         "#{icon} #{j.short_desc} ‚Äî #{status}"
       }
    |join("\n")

format_job_status(job):
  icon = JOB_TYPE_ICONS[job.type] ?? "üì¶"
  status = JOB_STATUS_LABELS[job.status] ?? job.status
  progress = case job.progress:
    ‚àÖ-> ""
    p ‚Üí "\nüìä –ü—Ä–æ–≥—Ä–µ—Å—Å: {to_string}"(p) + "%"

  """
  #{icon} <b>#{job.description}</b>

  üìã –¢–∏–ø: #{job.type_label}
  üìä –°—Ç–∞—Ç—É—Å: #{status}#{progress}
  ‚è±Ô∏è –°–æ–∑–¥–∞–Ω–æ: #{job.created_at}
  üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å: #{job.cost} ‚≠ê
  """

calculate_refund(job):
  case job.status:
    "pending" ‚Üí job.cost  // Full refund
    "processing" ‚Üí job.cost / 2  // Partial refund
    _ ‚Üí 0

cancel_job(job_id):
  job = get_job(job_id)
  case job.status:
    "pending" ‚Üí {
      "cancelled" ¬∑ update_job_status
      refund = job.cost
      add_balance(job.type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id, refund)
      ‚úÖrefund)
    }
    "processing" ‚Üí ‚ùå"already_processing")
    _ ‚Üí ‚ùå"cannot_cancel")

cancel_all_pending_jobs(type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id):
  jobs = get_pending_jobs(type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id)
  cancellable = jobs |filter( it.status == "pending" }

  cancelled = 0
  refunded = 0

  cancellable ¬∑ each{ j
    case cancel_job(j.ID):
      ‚úÖrefund) ‚Üí {
        cancelled = cancelled + 1
        refunded = refunded + refund
      }
      _ ‚Üí _
  }

  { cancelled, refunded, skipped: len(jobs) - cancelled }

# v8.0

# v10.0 - ML-Powered Migration
