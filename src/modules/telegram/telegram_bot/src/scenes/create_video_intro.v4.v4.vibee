// Create Video Intro Scene
  // Performance Warning:   // AI Suggestion: Code is deeply nested, consider refactoring  // AI Suggestion: Consider extracting hardcoded strings to constants  // AI Suggestion: Replace magic numbers with named constants// Create professional video intros with templates
// Based on 999-multibots-telegraf createVideoIntroScene

import "../i18n/scenes_i18n.vibee" as i18n

scene CreateVideoIntro:
  desc: "Create professional video intros using templates"

  @spec "Intro created": template selected â†’ customized â†’ rendered
  @spec "Template previewed": type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} browses â†’ preview shown

  on Main:
    enter:
      â†’ lang = get_type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_language(type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id)
      â†’ reply(case lang:
           "en" â†’ """
             ğŸ¬ <b>Video Intro Creator</b>

             Create professional intros for your videos!

             â€¢ Ready templates
             â€¢ Text and color customization
             â€¢ Logo support
             â€¢ High quality render
             """
           _ â†’ """
             ğŸ¬ <b>Video Intro Creator</b>

             Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ¹Ñ‚Ğµ Ğ¿Ñ€Ğ¾Ñ„ĞµÑÑĞ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ¸Ğ½Ñ‚Ñ€Ğ¾ Ğ´Ğ»Ñ Ğ²Ğ°ÑˆĞµĞ³Ğ¾ Ğ²Ğ¸Ğ´ĞµĞ¾!

             â€¢ Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ñ‹Ğµ ÑˆĞ°Ğ±Ğ»Ğ¾Ğ½Ñ‹
             â€¢ ĞšĞ°ÑÑ‚Ğ¾Ğ¼Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ñ‚ĞµĞºÑÑ‚Ğ° Ğ¸ Ñ†Ğ²ĞµÑ‚Ğ¾Ğ²
             â€¢ Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ»Ğ¾Ğ³Ğ¾Ñ‚Ğ¸Ğ¿Ğ°
             â€¢ Ğ ĞµĞ½Ğ´ĞµÑ€ Ğ² Ğ²Ñ‹ÑĞ¾ĞºĞ¾Ğ¼ ĞºĞ°Ñ‡ĞµÑÑ‚Ğ²Ğµ
             """)
      â†’ show_keyboard([
           button(case lang: "en" â†’ "ğŸ¨ Select template" _ â†’ "ğŸ¨ Ğ’Ñ‹Ğ±Ñ€Ğ°Ñ‚ÑŒ ÑˆĞ°Ğ±Ğ»Ğ¾Ğ½", "templates"),
           button(case lang: "en" â†’ "ğŸ“‹ My intros" _ â†’ "ğŸ“‹ ĞœĞ¾Ğ¸ Ğ¸Ğ½Ñ‚Ñ€Ğ¾", "my_intros"),
           button(case lang: "en" â†’ "â“ Examples" _ â†’ "â“ ĞŸÑ€Ğ¸Ğ¼ĞµÑ€Ñ‹", "examples"),
           button("common", "menu" Â· t, "menu")
         ])

    callback "templates" â†’ transition SelectCategory
    callback "my_intros" â†’ transition MyIntros
    callback "examples" â†’ transition ShowExamples
    callback "menu" â†’ exit(Idle)

  on ShowExamples:
    enter:
      â†’ lang = get_type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_language(type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id)
      â†’ examples = get_intro_examples()
      â†’ reply(case lang:
           "en" â†’ """
             ğŸ¥ <b>Intro examples</b>

             See what you can create:
             """
           _ â†’ """
             ğŸ¥ <b>ĞŸÑ€Ğ¸Ğ¼ĞµÑ€Ñ‹ Ğ¸Ğ½Ñ‚Ñ€Ğ¾</b>

             ĞŸĞ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ¸Ñ‚Ğµ Ñ‡Ñ‚Ğ¾ Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ ÑĞ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ:
             """)
      â†’ example_buttons = examples
           Â· take(6)
           Â· map(fn(e) { button(e." {e}{emoji}".name, "example:{e}".id) }
      â†’ show_keyboard(example_buttons  + [
           button("common", "back" Â· t, "back")
         ])
      â†’ stay(examples)

    callback /^example:(.+)$/:
      â†’ example_id = extract_id(callback_data)
      â†’ example = examples Â· find({ it.id == example_id }
      â†’ send_video(example.video_url, caption: "ğŸ¬ {example}".name)

    callback "back" â†’ transition Main

  on SelectCategory:
    enter:
      â†’ lang = get_type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_language(type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id)
      â†’ categories = get_intro_categories()
      â†’ reply(case lang:
           "en" â†’ """
             ğŸ“ <b>Template categories</b>

             Select intro style:
             """
           _ â†’ """
             ğŸ“ <b>ĞšĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ğ¸ ÑˆĞ°Ğ±Ğ»Ğ¾Ğ½Ğ¾Ğ²</b>

             Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ ÑÑ‚Ğ¸Ğ»ÑŒ Ğ¸Ğ½Ñ‚Ñ€Ğ¾:
             """)
      â†’ show_keyboard([
           button("ğŸ® Gaming", "cat:gaming"),
           button("ğŸ’¼ Business", "cat:business"),
           button("ğŸµ Music", "cat:music"),
           button("ğŸ“± Social Media", "cat:social"),
           button("ğŸ¥ Vlog", "cat:vlog"),
           button("ğŸ”¥ Trending", "cat:trending"),
           button("common", "back" Â· t, "back")
         ])

    callback /^cat:(.+)$/:
      â†’ category = extract_id(callback_data)
      â†’ transition BrowseTemplates(category)

    callback "back" â†’ transition Main

  on BrowseTemplates(category):
    enter:
      â†’ templates = get_templates_by_category(category)
      â†’ reply("""
        ğŸ¬ <b>Ğ¨Ğ°Ğ±Ğ»Ğ¾Ğ½Ñ‹: #{category_label(category)}</b>

        ĞĞ°Ğ¹Ğ´ĞµĞ½Ğ¾: #{length(templates)} ÑˆĞ°Ğ±Ğ»Ğ¾Ğ½Ğ¾Ğ²
        """)
      â†’ template_buttons = templates
           Â· take(8)
           Â· map(fn(t) { button(t." ({to_string}{name}"(t.duration) + "Ñ)", "tpl:{t}".id) }
      â†’ show_keyboard(template_buttons  + [
           button("ğŸ” ĞŸĞ¾Ğ¸ÑĞº", "search"),
           button("ğŸ”™ ĞšĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ğ¸", "back")
         ])
      â†’ page: 0 Â· stay

    callback /^tpl:(.+)$/:
      â†’ template_id = extract_id(callback_data)
      â†’ template = templates Â· find({ it.id == template_id }
      â†’ transition TemplatePreview(template)

    callback "search" â†’ transition SearchTemplates(category)
    callback "back" â†’ transition SelectCategory

  on SearchTemplates(category):
    enter:
      â†’ reply("""
        ğŸ” <b>ĞŸĞ¾Ğ¸ÑĞº ÑˆĞ°Ğ±Ğ»Ğ¾Ğ½Ğ¾Ğ²</b>

        Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¸Ğ»Ğ¸ ĞºĞ»ÑÑ‡ĞµĞ²Ñ‹Ğµ ÑĞ»Ğ¾Ğ²Ğ°:
        """)
      â†’ show_keyboard([
           button("ğŸ”™ ĞÑ‚Ğ¼ĞµĞ½Ğ°", "cancel")
         ])

    message TextMessage(query):
      â†’ results = query Â· search_templates
      â†’ case results:
           [] â†’ reply("âŒ ĞĞ¸Ñ‡ĞµĞ³Ğ¾ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾") && stay
           list â†’ {
             â†’ reply("ğŸ” ĞĞ°Ğ¹Ğ´ĞµĞ½Ğ¾: #{length(list)} ÑˆĞ°Ğ±Ğ»Ğ¾Ğ½Ğ¾Ğ²")
             â†’ buttons = list
                  Â· take(8)
                  Â· map(fn(t) { button(t.name, "tpl:{t}".id) }
             â†’ show_keyboard(buttons  + [
                  button("ğŸ”™ ĞĞ°Ğ·Ğ°Ğ´", "back")
                ])
             â†’ stay(templates: list)
           }

    callback /^tpl:(.+)$/:
      â†’ template_id = extract_id(callback_data)
      â†’ template = templates Â· find({ it.id == template_id }
      â†’ transition TemplatePreview(template)

    callback "cancel" â†’ transition BrowseTemplates(category)
    callback "back" â†’ transition BrowseTemplates(category)

  on TemplatePreview(template):
    enter:
      â†’ send_video(template.preview_url, caption: "ğŸ¬ {template}".name)
      â†’ reply("""
        ğŸ¬ <b>#{template.name}</b>

        â±ï¸ Ğ”Ğ»Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ: #{template.duration} ÑĞµĞº
        ğŸ¨ Ğ¡Ñ‚Ğ¸Ğ»ÑŒ: #{template.style}
        ğŸ’° Ğ¡Ñ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ: #{template.cost} â­

        <b>ĞĞ°ÑÑ‚Ñ€Ğ°Ğ¸Ğ²Ğ°ĞµĞ¼Ñ‹Ğµ ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚Ñ‹:</b>
        #{format_customizable_elements(template.elements)}
        """)
      â†’ show_keyboard([
           button("âœ… Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ", "use"),
           button("â–¶ï¸ ĞŸĞ¾Ğ»Ğ½Ğ¾Ğµ Ğ¿Ñ€ĞµĞ²ÑŒÑ", "full_preview"),
           button("ğŸ”™ Ğš ÑˆĞ°Ğ±Ğ»Ğ¾Ğ½Ğ°Ğ¼", "back")
         ])

    callback "use" â†’ transition CustomizeIntro(template)
    callback "full_preview":
      â†’ send_video(template.full_preview_url, caption: "ğŸ¬ ĞŸĞ¾Ğ»Ğ½Ğ¾Ğµ Ğ¿Ñ€ĞµĞ²ÑŒÑ")
    callback "back" â†’ transition SelectCategory

  on CustomizeIntro(template):
    enter:
      â†’ reply("""
        âœï¸ <b>ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Ğ¸Ğ½Ñ‚Ñ€Ğ¾</b>

        Ğ¨Ğ°Ğ±Ğ»Ğ¾Ğ½: #{template.name}

        Ğ—Ğ°Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚Ğµ Ğ¿Ğ¾Ğ»Ñ Ğ´Ğ»Ñ ĞºĞ°ÑÑ‚Ğ¾Ğ¼Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸:
        """)
      â†’ show_keyboard([
           button("ğŸ“ Ğ¢ĞµĞºÑÑ‚", "edit_text"),
           button("ğŸ¨ Ğ¦Ğ²ĞµÑ‚Ğ°", "edit_colors"),
           button("ğŸ–¼ï¸ Ğ›Ğ¾Ğ³Ğ¾Ñ‚Ğ¸Ğ¿", "edit_logo"),
           button("ğŸµ ĞœÑƒĞ·Ñ‹ĞºĞ°", "edit_music"),
           button("âœ… Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ¾", "done"),
           button("ğŸ”™ ĞÑ‚Ğ¼ĞµĞ½Ğ°", "cancel")
         ])
      â†’ stay(customizations: default_customizations(template))

    callback "edit_text" â†’ transition customizations Â· EditText
    callback "edit_colors" â†’ transition customizations Â· EditColors
    callback "edit_logo" â†’ transition customizations Â· EditLogo
    callback "edit_music" â†’ transition customizations Â· EditMusic
    callback "done" â†’ transition customizations Â· PreviewCustomized
    callback "cancel" â†’ transition TemplatePreview(template)

  on customizations Â· EditText:
    enter:
      â†’ text_fields = template.elements Â· filter({ it.type == "text" }
      â†’ reply("""
        ğŸ“ <b>Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ‚ĞµĞºÑÑ‚Ğ°</b>

        #{customizations Â· format_text_fields}

        Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ½Ğ¾Ğ¼ĞµÑ€ Ğ¿Ğ¾Ğ»Ñ Ğ¸ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ñ‚ĞµĞºÑÑ‚:
        <code>1: Ğ’Ğ°Ñˆ Ñ‚ĞµĞºÑÑ‚</code>
        """)
      â†’ show_keyboard([
           button("âœ… Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ¾", "done")
         ])
      â†’ stay(text_fields)

    message TextMessage(input):
      â†’ case parse_field_input(input):
           âœ…#(field_num, text)) â†’ {
             â†’ new_customizations = field_num, text Â· update_text_field
             â†’ reply("âœ… ĞŸĞ¾Ğ»Ğµ #{field_num} Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¾")
             â†’ stay(customizations: new_customizations)
           }
           âŒmsg) â†’ reply("âŒ {msg}") && stay

    callback "done" â†’ transition CustomizeIntro(template)

  on customizations Â· EditColors:
    enter:
      â†’ reply("""
        ğŸ¨ <b>Ğ¦Ğ²ĞµÑ‚Ğ¾Ğ²Ğ°Ñ ÑÑ…ĞµĞ¼Ğ°</b>

        Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹ Ñ†Ğ²ĞµÑ‚:
        """)
      â†’ show_keyboard([
           button("ğŸ”´ ĞšÑ€Ğ°ÑĞ½Ñ‹Ğ¹", "color:red"),
           button("ğŸŸ  ĞÑ€Ğ°Ğ½Ğ¶ĞµĞ²Ñ‹Ğ¹", "color:orange"),
           button("ğŸŸ¡ Ğ–Ñ‘Ğ»Ñ‚Ñ‹Ğ¹", "color:yellow"),
           button("ğŸŸ¢ Ğ—ĞµĞ»Ñ‘Ğ½Ñ‹Ğ¹", "color:green"),
           button("ğŸ”µ Ğ¡Ğ¸Ğ½Ğ¸Ğ¹", "color:blue"),
           button("ğŸŸ£ Ğ¤Ğ¸Ğ¾Ğ»ĞµÑ‚Ğ¾Ğ²Ñ‹Ğ¹", "color:purple"),
           button("âš« Ğ§Ñ‘Ñ€Ğ½Ñ‹Ğ¹", "color:black"),
           button("âšª Ğ‘ĞµĞ»Ñ‹Ğ¹", "color:white"),
           button("ğŸ”™ ĞĞ°Ğ·Ğ°Ğ´", "back")
         ])

    callback /^color:(.+)$/:
      â†’ color = extract_id(callback_data)
      â†’ new_customizations = { ...customizations, primary_color }
      â†’ reply("âœ… Ğ¦Ğ²ĞµÑ‚: {color_label}"(color))
      â†’ transition CustomizeIntro(template) with customizations: new_customizations

    callback "back" â†’ transition CustomizeIntro(template)

  on customizations Â· EditLogo:
    enter:
      â†’ reply("""
        ğŸ–¼ï¸ <b>Ğ›Ğ¾Ğ³Ğ¾Ñ‚Ğ¸Ğ¿</b>

        ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ÑŒÑ‚Ğµ Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğµ Ğ»Ğ¾Ğ³Ğ¾Ñ‚Ğ¸Ğ¿Ğ°:
        â€¢ PNG Ñ Ğ¿Ñ€Ğ¾Ğ·Ñ€Ğ°Ñ‡Ğ½Ñ‹Ğ¼ Ñ„Ğ¾Ğ½Ğ¾Ğ¼ (Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒĞµÑ‚ÑÑ)
        â€¢ JPG
        â€¢ ĞšĞ²Ğ°Ğ´Ñ€Ğ°Ñ‚Ğ½Ñ‹Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚

        Ğ˜Ğ»Ğ¸ Ğ²Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ¸Ğ· Ğ±Ğ¸Ğ±Ğ»Ğ¸Ğ¾Ñ‚ĞµĞºĞ¸:
        """)
      â†’ show_keyboard([
           button("ğŸ“š Ğ‘Ğ¸Ğ±Ğ»Ğ¸Ğ¾Ñ‚ĞµĞºĞ° Ğ»Ğ¾Ğ³Ğ¾Ñ‚Ğ¸Ğ¿Ğ¾Ğ²", "library"),
           button("ğŸš« Ğ‘ĞµĞ· Ğ»Ğ¾Ğ³Ğ¾Ñ‚Ğ¸Ğ¿Ğ°", "no_logo"),
           button("ğŸ”™ ĞĞ°Ğ·Ğ°Ğ´", "back")
         ])

    message PhotoMessage(photo_url):
      â†’ reply("â³ Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°Ñ Ğ»Ğ¾Ğ³Ğ¾Ñ‚Ğ¸Ğ¿...")
      â†’ result = validate_logo(photo_url)
      â†’ case result:
           âœ…_) â†’ {
             â†’ new_customizations = {customizations..., logo_url: photo_url }
             â†’ reply("âœ… Ğ›Ğ¾Ğ³Ğ¾Ñ‚Ğ¸Ğ¿ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½")
             â†’ transition CustomizeIntro(template) with customizations: new_customizations
           }
           âŒmsg) â†’ reply("âŒ {msg}") && stay

    callback "library" â†’ transition customizations Â· LogoLibrary
    callback "no_logo":
      â†’ new_customizations = {customizations..., logo_url: âˆ…}
      â†’ transition CustomizeIntro(template) with customizations: new_customizations
    callback "back" â†’ transition CustomizeIntro(template)

  on customizations Â· LogoLibrary:
    enter:
      â†’ logos = get_logo_library()
      â†’ reply("ğŸ“š <b>Ğ‘Ğ¸Ğ±Ğ»Ğ¸Ğ¾Ñ‚ĞµĞºĞ° Ğ»Ğ¾Ğ³Ğ¾Ñ‚Ğ¸Ğ¿Ğ¾Ğ²</b>")
      â†’ logo_buttons = logos
           Â· take(8)
           Â· map({ button(it.name, "logo:{it}".id) }
      â†’ show_keyboard(logo_buttons  + [
           button("ğŸ”™ ĞĞ°Ğ·Ğ°Ğ´", "back")
         ])
      â†’ stay(logos)

    callback /^logo:(.+)$/:
      â†’ logo_id = extract_id(callback_data)
      â†’ logo = logos Â· find({ it.id == logo_id }
      â†’ new_customizations = {customizations..., logo_url: logo.url }
      â†’ reply("âœ… Ğ›Ğ¾Ğ³Ğ¾Ñ‚Ğ¸Ğ¿ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½: {logo}".name)
      â†’ transition CustomizeIntro(template) with customizations: new_customizations

    callback "back" â†’ transition customizations Â· EditLogo

  on customizations Â· EditMusic:
    enter:
      â†’ music_tracks = get_available_music(template.style)
      â†’ reply("""
        ğŸµ <b>ĞœÑƒĞ·Ñ‹ĞºĞ°</b>

        Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ¼ÑƒĞ·Ñ‹ĞºĞ°Ğ»ÑŒĞ½Ğ¾Ğµ ÑĞ¾Ğ¿Ñ€Ğ¾Ğ²Ğ¾Ğ¶Ğ´ĞµĞ½Ğ¸Ğµ:
        """)
      â†’ track_buttons = music_tracks
           Â· take(6)
           Â· map(fn(t) { button("ğŸµ {t}".name, "track:{t}".id) }
      â†’ show_keyboard(track_buttons  + [
           button("ğŸ“ Ğ—Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ ÑĞ²Ğ¾Ñ", "upload"),
           button("ğŸ”‡ Ğ‘ĞµĞ· Ğ¼ÑƒĞ·Ñ‹ĞºĞ¸", "no_music"),
           button("ğŸ”™ ĞĞ°Ğ·Ğ°Ğ´", "back")
         ])
      â†’ stay(music_tracks)

    callback /^track:(.+)$/:
      â†’ track_id = extract_id(callback_data)
      â†’ track = music_tracks Â· find({ it.id == track_id }
      â†’ send_audio(track.preview_url, caption: "ğŸµ {track}".name)
      â†’ new_customizations = {customizations..., music_id: track_id }
      â†’ reply("âœ… Ğ¢Ñ€ĞµĞº Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½")
      â†’ transition CustomizeIntro(template) with customizations: new_customizations

    callback "upload":
      â†’ reply("ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ÑŒÑ‚Ğµ Ğ°ÑƒĞ´Ğ¸Ğ¾Ñ„Ğ°Ğ¹Ğ» (MP3, Ğ´Ğ¾ 30 ÑĞµĞº):")
      â†’ stay(waiting_upload: true)

    message AudioMessage(audio_url) when waiting_upload:
      â†’ new_customizations = {customizations..., custom_music_url: audio_url }
      â†’ reply("âœ… ĞœÑƒĞ·Ñ‹ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ğ°")
      â†’ transition CustomizeIntro(template) with customizations: new_customizations

    callback "no_music":
      â†’ new_customizations = {customizations..., music_id: âˆ…}
      â†’ transition CustomizeIntro(template) with customizations: new_customizations

    callback "back" â†’ transition CustomizeIntro(template)

  on customizations Â· PreviewCustomized:
    enter:
      â†’ reply("â³ Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒÑ Ğ¿Ñ€ĞµĞ²ÑŒÑ...")
      â†’ preview_result = customizations Â· generate_intro_preview
      â†’ case preview_result:
           âœ…preview) â†’ {
             â†’ send_video(preview.url, caption: "ğŸ¬ ĞŸÑ€ĞµĞ²ÑŒÑ Ğ²Ğ°ÑˆĞµĞ³Ğ¾ Ğ¸Ğ½Ñ‚Ñ€Ğ¾")
             â†’ reply("""
               âœ… <b>ĞŸÑ€ĞµĞ²ÑŒÑ Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ¾!</b>

               Ğ•ÑĞ»Ğ¸ Ğ²ÑÑ‘ ÑƒÑÑ‚Ñ€Ğ°Ğ¸Ğ²Ğ°ĞµÑ‚, Ğ½Ğ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ "Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ" Ğ´Ğ»Ñ Ñ€ĞµĞ½Ğ´ĞµÑ€Ğ° Ğ² Ğ¿Ğ¾Ğ»Ğ½Ğ¾Ğ¼ ĞºĞ°Ñ‡ĞµÑÑ‚Ğ²Ğµ.

               ğŸ’° Ğ¡Ñ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ: #{template.cost} â­
               """)
             â†’ show_keyboard([
                  button("âœ… Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ", "render"),
                  button("âœï¸ Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ", "edit"),
                  button("ğŸ”™ ĞÑ‚Ğ¼ĞµĞ½Ğ°", "cancel")
                ])
           }
           âŒmsg) â†’ {
             â†’ reply("âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸: {msg}")
             â†’ transition CustomizeIntro(template)
           }

    callback "render" â†’ transition customizations Â· RenderIntro
    callback "edit" â†’ transition CustomizeIntro(template)
    callback "cancel" â†’ transition Main

  on customizations Â· RenderIntro:
    enter:
      â†’ balance = get_balance(type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id)
      â†’ case balance >= template.cost:
           true â†’ {
             â†’ deduct_balance(type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id, template.cost)
             â†’ reply("â³ Ğ ĞµĞ½Ğ´ĞµÑ€Ñ Ğ¸Ğ½Ñ‚Ñ€Ğ¾ Ğ² Ğ²Ñ‹ÑĞ¾ĞºĞ¾Ğ¼ ĞºĞ°Ñ‡ĞµÑÑ‚Ğ²Ğµ...")
             â†’ job_id = start_intro_render(type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id, template, customizations)
             â†’ transition template.cost Â· RenderProgress
           }
           false â†’ {
             â†’ reply("""
               âŒ ĞĞµĞ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ ÑÑ€ĞµĞ´ÑÑ‚Ğ²

               ğŸ’° Ğ¡Ñ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ: #{template.cost} â­
               ğŸ’³ Ğ’Ğ°Ñˆ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ: #{balance} â­
               """)
             â†’ show_keyboard([
                  button("ğŸ’³ ĞŸĞ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ÑŒ", "topup"),
                  button("ğŸ”™ ĞĞ°Ğ·Ğ°Ğ´", "back")
                ])
           }

    callback "topup" â†’ exit_to(TopUp)
    callback "back" â†’ transition customizations Â· PreviewCustomized

  on cost Â· RenderProgress:
    enter:
      â†’ status = get_job_status(job_id)
      â†’ reply("""
        â³ <b>Ğ ĞµĞ½Ğ´ĞµÑ€Ğ¸Ğ½Ğ³ Ğ¸Ğ½Ñ‚Ñ€Ğ¾</b>

        ğŸ“Š ĞŸÑ€Ğ¾Ğ³Ñ€ĞµÑÑ: #{status.progress}%
        #{format_render_stage(status.stage)}
        """)
      â†’ show_keyboard([
           button("ğŸ”„ ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ", "refresh"),
           button("âŒ ĞÑ‚Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ", "cancel")
         ])

    callback "refresh":
      â†’ status = get_job_status(job_id)
      â†’ case status.state:
           "completed" â†’ transition RenderComplete(status.result)
           "failed" â†’ {
             â†’ reply("âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ñ€ĞµĞ½Ğ´ĞµÑ€Ğ¸Ğ½Ğ³Ğ°: {status}".error)
             â†’ refund_balance(type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id, cost)
             â†’ transition Main
           }
           _ â†’ enter

    callback "cancel":
      â†’ cancel_job(job_id)
      â†’ refund_balance(type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id, cost / 2)
      â†’ reply("âŒ Ğ ĞµĞ½Ğ´ĞµÑ€Ğ¸Ğ½Ğ³ Ğ¾Ñ‚Ğ¼ĞµĞ½Ñ‘Ğ½. Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰ĞµĞ½Ğ¾ 50%.")
      â†’ transition Main

    @event job_completed(result):
      â†’ transition RenderComplete(result)

  on RenderComplete(result):
    enter:
      â†’ send_video(result.video_url, caption: "ğŸ¬ Ğ’Ğ°ÑˆĞµ Ğ¸Ğ½Ñ‚Ñ€Ğ¾ Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ¾!")
      â†’ save_intro(type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id, result)
      â†’ reply("""
        âœ… <b>Ğ˜Ğ½Ñ‚Ñ€Ğ¾ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¾!</b>

        ğŸ“ Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚: MP4 (1080p)
        â±ï¸ Ğ”Ğ»Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ: #{result.duration} ÑĞµĞº

        Ğ˜Ğ½Ñ‚Ñ€Ğ¾ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¾ Ğ² Ğ²Ğ°ÑˆĞµĞ¹ ĞºĞ¾Ğ»Ğ»ĞµĞºÑ†Ğ¸Ğ¸.
        """)
      â†’ show_keyboard([
           button("â• Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ ĞµÑ‰Ñ‘", "create"),
           button("ğŸ“‹ ĞœĞ¾Ğ¸ Ğ¸Ğ½Ñ‚Ñ€Ğ¾", "my_intros"),
           button("ğŸ“¤ Ğ¡ĞºĞ°Ñ‡Ğ°Ñ‚ÑŒ", "download"),
           button("ğŸ  Ğ’ Ğ¼ĞµĞ½Ñ", "menu")
         ])

    callback "create" â†’ transition SelectCategory
    callback "my_intros" â†’ transition MyIntros
    callback "download":
      â†’ reply("ğŸ“¥ Ğ¡ÑÑ‹Ğ»ĞºĞ° Ğ´Ğ»Ñ ÑĞºĞ°Ñ‡Ğ¸Ğ²Ğ°Ğ½Ğ¸Ñ:\n {result}".download_url)
    callback "menu" â†’ exit(Idle)

  on MyIntros:
    enter:
      â†’ lang = get_type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_language(type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id)
      â†’ intros = get_type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_intros(type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id)
      â†’ case intros:
           [] â†’ {
             â†’ reply(case lang: "en" â†’ "ğŸ“­ You have no intros created" _ â†’ "ğŸ“­ Ğ£ Ğ²Ğ°Ñ Ğ½ĞµÑ‚ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¸Ğ½Ñ‚Ñ€Ğ¾")
             â†’ show_keyboard([
                  button(case lang: "en" â†’ "â• Create intro" _ â†’ "â• Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ¸Ğ½Ñ‚Ñ€Ğ¾", "create"),
                  button("common", "back" Â· t, "back")
                ])
           }
           list â†’ {
             â†’ reply(case lang:
                  "en" â†’ """
                    ğŸ“‹ <b>Your intros</b>

                    Total: #{length(list)}
                    """
                  _ â†’ """
                    ğŸ“‹ <b>Ğ’Ğ°ÑˆĞ¸ Ğ¸Ğ½Ñ‚Ñ€Ğ¾</b>

                    Ğ’ÑĞµĞ³Ğ¾: #{length(list)}
                    """)
             â†’ buttons = list
                  Â· take(10)
                  Â· map(fn(i) { button("ğŸ¬ {i}".name, "intro:{i}".id) }
             â†’ show_keyboard(buttons  + [
                  button(case lang: "en" â†’ "â• Create new" _ â†’ "â• Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ½Ğ¾Ğ²Ğ¾Ğµ", "create"),
                  button("common", "back" Â· t, "back")
                ])
             â†’ stay(intros: list)
           }

    callback /^intro:(.+)$/:
      â†’ intro_id = extract_id(callback_data)
      â†’ intro = intros Â· find(fn(i) { i.id == intro_id }
      â†’ transition IntroDetails(intro)

    callback "create" â†’ transition SelectCategory
    callback "back" â†’ transition Main

  on IntroDetails(intro):
    enter:
      â†’ send_video(intro.video_url, caption: "ğŸ¬ {intro}".name)
      â†’ reply("""
        ğŸ¬ <b>#{intro.name}</b>

        ğŸ“… Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¾: #{intro.created_at}
        â±ï¸ Ğ”Ğ»Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ: #{intro.duration} ÑĞµĞº
        ğŸ¨ Ğ¨Ğ°Ğ±Ğ»Ğ¾Ğ½: #{intro.template_name}
        """)
      â†’ show_keyboard([
           button("ğŸ“¥ Ğ¡ĞºĞ°Ñ‡Ğ°Ñ‚ÑŒ", "download"),
           button("ğŸ”„ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ¿Ğ¾Ñ…Ğ¾Ğ¶ĞµĞµ", "recreate"),
           button("ğŸ—‘ï¸ Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ", "delete"),
           button("ğŸ”™ ĞĞ°Ğ·Ğ°Ğ´", "back")
         ])

    callback "download":
      â†’ reply("ğŸ“¥ Ğ¡ÑÑ‹Ğ»ĞºĞ°:\n {intro}".download_url)

    callback "recreate":
      â†’ template = get_template(intro.template_id)
      â†’ transition CustomizeIntro(template)

    callback "delete" â†’ transition ConfirmDeleteIntro(intro.id)

    callback "back" â†’ transition MyIntros

  on ConfirmDeleteIntro(intro_id):
    enter:
      â†’ intro = get_intro(intro_id)
      â†’ reply("""
        âš ï¸ <b>Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ¸Ğ½Ñ‚Ñ€Ğ¾?</b>

        ğŸ¬ #{intro.name}

        Ğ­Ñ‚Ğ¾ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ Ğ½ĞµĞ»ÑŒĞ·Ñ Ğ¾Ñ‚Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ!
        """)
      â†’ show_keyboard([
           button("ğŸ—‘ï¸ Ğ”Ğ°, ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ", "confirm"),
           button("ğŸ”™ ĞÑ‚Ğ¼ĞµĞ½Ğ°", "cancel")
         ])

    callback "confirm":
      â†’ delete_intro(intro_id)
      â†’ reply("âœ… Ğ˜Ğ½Ñ‚Ñ€Ğ¾ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¾")
      â†’ transition MyIntros

    callback "cancel" â†’ transition MyIntros

// =============================================================================
// HELPER FUNCTIONS
// =============================================================================

cache(5m)
category_label(category):
  case category:
    "gaming" â†’ "Gaming"
    "business" â†’ "Business"
    "music" â†’ "Music"
    "social" â†’ "Social Media"
    "vlog" â†’ "Vlog"
    "trending" â†’ "Trending"
    _ â†’ category

format_customizable_elements(elements):
  elements
    Â· map(fn(e) { "â€¢ {e}"." ({e}{label}"."){type}" }
    Â· join("\n")

customizations Â· format_text_fields:
  fields
    Â· map_with_index(i Â· fn {
         current = customizations.texts[i] ?? f.default
         to_string(i + 1) + ". {f}".": {current}{label}"
       }
    Â· join("\n")

cache(5m)
color_label(color):
  case color:
    "red" â†’ "ğŸ”´ ĞšÑ€Ğ°ÑĞ½Ñ‹Ğ¹"
    "orange" â†’ "ğŸŸ  ĞÑ€Ğ°Ğ½Ğ¶ĞµĞ²Ñ‹Ğ¹"
    "yellow" â†’ "ğŸŸ¡ Ğ–Ñ‘Ğ»Ñ‚Ñ‹Ğ¹"
    "green" â†’ "ğŸŸ¢ Ğ—ĞµĞ»Ñ‘Ğ½Ñ‹Ğ¹"
    "blue" â†’ "ğŸ”µ Ğ¡Ğ¸Ğ½Ğ¸Ğ¹"
    "purple" â†’ "ğŸŸ£ Ğ¤Ğ¸Ğ¾Ğ»ĞµÑ‚Ğ¾Ğ²Ñ‹Ğ¹"
    "black" â†’ "âš« Ğ§Ñ‘Ñ€Ğ½Ñ‹Ğ¹"
    "white" â†’ "âšª Ğ‘ĞµĞ»Ñ‹Ğ¹"
    _ â†’ color

cache(5m)
format_render_stage(stage):
  case stage:
    "preparing" â†’ "ğŸ“¦ ĞŸĞ¾Ğ´Ğ³Ğ¾Ñ‚Ğ¾Ğ²ĞºĞ°..."
    "rendering" â†’ "ğŸ¬ Ğ ĞµĞ½Ğ´ĞµÑ€Ğ¸Ğ½Ğ³ Ğ²Ğ¸Ğ´ĞµĞ¾..."
    "encoding" â†’ "ğŸ’¾ ĞšĞ¾Ğ´Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ..."
    "uploading" â†’ "â˜ï¸ Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°..."
    _ â†’ "â³ ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ°..."

parse_field_input(input):
  case string.":" Â· split:
    [num_str, ...text_parts] â†’ {
      case int.parse(string.trim(num_str)):
        âœ…num) â†’ âœ…#(num, string.":" Â· join Â· string.trim))
        âŒ_) â†’ âŒ"ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚. Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ: 1: Ñ‚ĞµĞºÑÑ‚")
    }
    _ â†’ âŒ"ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚. Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ: 1: Ñ‚ĞµĞºÑÑ‚")

default_customizations(template):
  {
    texts: template.elements
      Â· filter({ it.type == "text" }
      Â· map({ it.default },
    primary_color: template.default_color,
    logo_url: âˆ…,
    music_id: template.default_music_id
  }

# v8.0

# v10.0 - ML-Powered Migration
