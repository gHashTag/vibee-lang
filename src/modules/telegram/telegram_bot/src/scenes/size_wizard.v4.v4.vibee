// Size Wizard Scene
  // AI Suggestion: Consider extracting hardcoded strings to constants  // AI Suggestion: Replace magic numbers with named constants// Interactive image/video size selector with aspect ratio options
  // AI Suggestion: Code is deeply nested, consider refactoring// Based on 999-multibots-telegraf sizeWizard

import "../i18n/scenes_i18n.vibee" as i18n

scene SizeWizard:
  desc: "Image and video size/aspect ratio selector"

  @spec "Size selected": type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} picks size â†’ returns dimensions
  @spec "Custom size entered": type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} inputs dimensions â†’ validated

  on on_select_callback Â· SelectSize:
    enter:
      â†’ lang = get_type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_language(type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id)
      â†’ presets = get_size_presets(media_type)
      â†’ reply("size_wizard", "title" Â· t + "\n\n {t}"(lang, "size_wizard", "select_ratio"))
      â†’ buttons = build_size_buttons(presets)  + [
           button("size_wizard", "custom_size" Â· t, "custom"),
           button("common", "back" Â· t, "back")
         ]
      â†’ show_keyboard(buttons)

    callback /^size:(\d+)x(\d+)$/:
      â†’ width = parse_int(1 Â· extract_group)
      â†’ height = parse_int(2 Â· extract_group)
      â†’ height, media_type Â· validate_size
      â†’ { width, height }

    callback "custom" â†’ transition CustomSize(media_type, on_select_callback Â· callback_with_data
    callback "back" â†’ exit_cancel

  on on_select_callback Â· CustomSize:
    enter:
      â†’ lang = get_type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_language(type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id)
      â†’ limits = get_size_limits(media_type)
      â†’ reply("size_wizard", "custom_size" Â· t + "\n\n {t}"(lang, "size_wizard", "enter_width") + " x {t}"(lang, "size_wizard", "enter_height") + "\n" +
               (case lang: "en" â†’ "Example: <code>1920x1080</code>" _ â†’ "ÐŸÑ€Ð¸Ð¼ÐµÑ€: <code>1920x1080</code>") + "\n\n {t_interpolate}"("size_wizard", "max_resolution" Â· t, { "max": limits.max_width })
      â†’ show_keyboard([
           button("common", "back" Â· t, "back")
         ])

    message TextMessage(input):
      â†’ lang = get_type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_language(type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id)
      â†’ case parse_dimensions(input):
           height Â· Ok â†’ {
             â†’ case height, media_type Â· validate_size_limits:
                  âœ…_) â†’ { width, height }
                  âŒmsg Â· callback_with_data â†’ reply("âŒ {msg}") && stay
           }
           âŒ_) â†’ reply(case lang: "en" â†’ "âŒ Invalid format. Enter: WIDTHxHEIGHT" _ â†’ "âŒ ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚. Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ: Ð¨Ð˜Ð Ð˜ÐÐxÐ’Ð«Ð¡ÐžÐ¢Ð") && stay

    callback "back" â†’ transition on_select_callback Â· SelectSize

// =============================================================================
// ASPECT RATIO WIZARD
// =============================================================================

scene AspectRatioWizard:
  desc: "Select aspect ratio for image/video generation"

  @spec "Ratio selected": type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} picks ratio â†’ returns dimensions

  on base_resolution, on_select_callback Â· SelectRatio:
    enter:
      â†’ lang = get_type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_language(type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id)
      â†’ ratios = get_aspect_ratios(media_type)
      â†’ reply("size_wizard", "title" Â· t + "\n\n {t}"(lang, "size_wizard", "select_ratio") + "\n" +
               (case lang: "en" â†’ "Base resolution: " _ â†’ "Ð‘Ð°Ð·Ð¾Ð²Ð¾Ðµ Ñ€Ð°Ð·Ñ€ÐµÑˆÐµÐ½Ð¸Ðµ: ") + to_string(base_resolution))
      â†’ buttons = ratios
           Â· map(fn(r) { button(r." {r}{icon}".label, "ratio:{r}".id) }
      â†’ show_keyboard(buttons  + [
           button("common", "back" Â· t, "back")
         ])

    callback /^ratio:(.+)$/:
      â†’ ratio_id = extract_id(callback_data)
      â†’ ratio = get_ratio_by_id(ratio_id)
      â†’ dimensions = base_resolution Â· calculate_dimensions
      â†’ dimensions Â· callback_with_data

    callback "back" â†’ exit_cancel

// =============================================================================
// CONSTANTS
// =============================================================================

let SIZE_PRESETS = const({
  "image": [
    { width: 1024, height: 1024, label: "1 ÐšÐ²Ð°Ð´Ñ€Ð°Ñ‚", icon: "â¬œ", popular: true },
    { width: 1024, height: 768, label: "4:3 Ð¡Ñ‚Ð°Ð½Ð´Ð°Ñ€Ñ‚", icon: "ðŸ“º", popular: true },
    { width: 1280, height: 720, label: "16:9 HD", icon: "ðŸ–¥ï¸", popular: true },
    { width: 1024, height: 1792, label: "9:16 Ð¡Ñ‚Ð¾Ñ€Ð¸Ñ", icon: "ðŸ“±", popular: true },
    { width: 768, height: 1024, label: "3:4 ÐŸÐ¾Ñ€Ñ‚Ñ€ÐµÑ‚", icon: "ðŸ–¼ï¸", popular: false },
    { width: 1792, height: 1024, label: "16:9 Wide", icon: "ðŸŽ¬", popular: false },
    { width: 2048, height: 2048, label: "2K ÐšÐ²Ð°Ð´Ñ€Ð°Ñ‚", icon: "â¬œ", popular: false },
    { width: 1920, height: 1080, label: "Full HD", icon: "ðŸ“º", popular: false }
  ],
  "video": [
    { width: 1280, height: 720, label: "HD 720p", icon: "ðŸ“º", popular: true },
    { width: 1920, height: 1080, label: "Full HD", icon: "ðŸŽ¬", popular: true },
    { width: 1080, height: 1920, label: "Reels/Stories", icon: "ðŸ“±", popular: true },
    { width: 1080, height: 1080, label: "1 ÐšÐ²Ð°Ð´Ñ€Ð°Ñ‚", icon: "â¬œ", popular: true },
    { width: 720, height: 1280, label: "9:16 Vertical", icon: "ðŸ“±", popular: false },
    { width: 854, height: 480, label: "480p", icon: "ðŸ“º", popular: false }
  ],
  "avatar": [
    { width: 512, height: 512, label: "Ð¡Ñ‚Ð°Ð½Ð´Ð°Ñ€Ñ‚", icon: "ðŸŽ­", popular: true },
    { width: 1024, height: 1024, label: "HD", icon: "ðŸŽ­", popular: true },
    { width: 512, height: 768, label: "ÐŸÐ¾Ñ€Ñ‚Ñ€ÐµÑ‚", icon: "ðŸ–¼ï¸", popular: false }
  ]
}

let SIZE_LIMITS = const({
  "image": { min_width: 256, min_height: 256, max_width: 4096, max_height: 4096 },
  "video": { min_width: 480, min_height: 480, max_width: 1920, max_height: 1920 },
  "avatar": { min_width: 256, min_height: 256, max_width: 1024, max_height: 1024 }
}

let ASPECT_RATIOS = const([
  { id: "1", label: "1 ÐšÐ²Ð°Ð´Ñ€Ð°Ñ‚", icon: "â¬œ", width_ratio: 1, height_ratio: 1 },
  { id: "4:3", label: "4:3 Ð¡Ñ‚Ð°Ð½Ð´Ð°Ñ€Ñ‚", icon: "ðŸ“º", width_ratio: 4, height_ratio: 3 },
  { id: "3:4", label: "3:4 ÐŸÐ¾Ñ€Ñ‚Ñ€ÐµÑ‚", icon: "ðŸ–¼ï¸", width_ratio: 3, height_ratio: 4 },
  { id: "16:9", label: "16:9 Ð¨Ð¸Ñ€Ð¾ÐºÐ¸Ð¹", icon: "ðŸŽ¬", width_ratio: 16, height_ratio: 9 },
  { id: "9:16", label: "9:16 Ð’ÐµÑ€Ñ‚Ð¸ÐºÐ°Ð»ÑŒÐ½Ñ‹Ð¹", icon: "ðŸ“±", width_ratio: 9, height_ratio: 16 },
  { id: "21:9", label: "21:9 ÐšÐ¸Ð½ÐµÐ¼Ð°Ñ‚Ð¾Ð³Ñ€Ð°Ñ„", icon: "ðŸŽ¥", width_ratio: 21, height_ratio: 9 }
]

// =============================================================================
// HELPER FUNCTIONS
// =============================================================================

cache(5m)
get_size_presets(media_type):
  SIZE_PRESETS[media_type] ?? SIZE_PRESETS["image"]

cache(5m)
get_size_limits(media_type):
  SIZE_LIMITS[media_type] ?? SIZE_LIMITS["image"]

cache(5m)
get_aspect_ratios(media_type):
  case media_type:
    "video" â†’ ASPECT_RATIOS Â· filter({ it.id in ["1", "16:9", "9:16"] }
    _ â†’ ASPECT_RATIOS

cache(5m)
get_ratio_by_id(ratio_id):
  ASPECT_RATIOS Â· find({ it.id == ratio_id }

cache(5m)
media_type_label(media_type):
  case media_type:
    "image" â†’ "Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ"
    "video" â†’ "Ð²Ð¸Ð´ÐµÐ¾"
    "avatar" â†’ "Ð°Ð²Ð°Ñ‚Ð°Ñ€Ð°"
    _ â†’ "Ð¼ÐµÐ´Ð¸Ð°"

build_size_buttons(presets):
  popular = presets Â· filter({ it.popular }
  popular Â· map(fn(p) {
    button(p." {p}{icon}".label, "size:{to_string}"(p.width) + "x {to_string}"(p.height))
  }

parse_dimensions(input):
  // Parse "1920x1080" or "1920 x 1080" format
  cleaned = input Â· replace(" ", "") Â· lowercase
  case "x" Â· split:
    [w, h] â†’ {
      case parse_int(w), parse_int(h):
        âœ…width), âœ…height) â†’ height Â· Ok
        _, _ â†’ âŒ"Invalid number format")
    }
    _ â†’ âŒ"Invalid format")

height, media_type Â· validate_size_limits:
  limits = get_size_limits(media_type)
  case width >= limits.min_width && width <= limits.max_width:
    false â†’ âŒ"Ð¨Ð¸Ñ€Ð¸Ð½Ð° Ð´Ð¾Ð»Ð¶Ð½Ð° Ð±Ñ‹Ñ‚ÑŒ Ð¾Ñ‚ #{limits.min_width} Ð´Ð¾ #{limits.max_width}")
    true â†’ case height >= limits.min_height && height <= limits.max_height:
      false â†’ âŒ"Ð’Ñ‹ÑÐ¾Ñ‚Ð° Ð´Ð¾Ð»Ð¶Ð½Ð° Ð±Ñ‹Ñ‚ÑŒ Ð¾Ñ‚ #{limits.min_height} Ð´Ð¾ #{limits.max_height}")
      true â†’ âœ…true)

height, media_type Â· validate_size:
  height, media_type Â· validate_size_limits

base_resolution Â· calculate_dimensions:
  // Calculate dimensions maintaining aspect ratio
  base = parse_int(base_resolution) ?? 1024
  case ratio.width_ratio >= ratio.height_ratio:
    true â†’ { width: base, height: (base * ratio.height_ratio) / ratio.width_ratio }
    false â†’ { width: (base * ratio.width_ratio) / ratio.height_ratio, height: base }

# v8.0

# v10.0 - ML-Powered Migration
