// Training RVC Scene
  // AI Suggestion: Consider extracting hardcoded strings to constants  // AI Suggestion: Replace magic numbers with named constants// Train custom RVC (Retrieval-based Voice Conversion) models
  // Performance Warning:   // AI Suggestion: Code is deeply nested, consider refactoring// Based on 999-multibots-telegraf trainingRVCScene

import "../i18n/scenes_i18n.vibee" as i18n

scene TrainingRVC:
  desc: "Train custom voice models using RVC technology"

  @spec "Model trained": type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} uploads samples ‚Üí RVC model created
  @spec "Training monitored": job started ‚Üí progress tracked

  on Main:
    enter:
      ‚Üí lang = get_type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_language(type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id)
      ‚Üí models = get_type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_rvc_models(type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id)
      ‚Üí reply(case lang:
           "en" ‚Üí "üé§ <b>Voice Training (RVC)</b>\n\nCreate a unique voice model for:\n‚Ä¢ AI Cover\n‚Ä¢ Voiceover\n‚Ä¢ Voice messages\n\nYour models: {to_string}"(length(models))
           _ ‚Üí "üé§ <b>–û–±—É—á–µ–Ω–∏–µ –≥–æ–ª–æ—Å–∞ (RVC)</b>\n\n–°–æ–∑–¥–∞–π—Ç–µ —É–Ω–∏–∫–∞–ª—å–Ω—É—é –≥–æ–ª–æ—Å–æ–≤—É—é –º–æ–¥–µ–ª—å –¥–ª—è:\n‚Ä¢ AI Cover\n‚Ä¢ –û–∑–≤—É—á–∫–∏\n‚Ä¢ –ì–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π\n\n–í–∞—à–∏ –º–æ–¥–µ–ª–∏: {to_string}"(length(models)))
      ‚Üí show_keyboard([
           button(case lang: "en" ‚Üí "‚ûï Train new model" _ ‚Üí "‚ûï –û–±—É—á–∏—Ç—å –Ω–æ–≤—É—é –º–æ–¥–µ–ª—å", "train"),
           button(case lang: "en" ‚Üí "üìã My models" _ ‚Üí "üìã –ú–æ–∏ –º–æ–¥–µ–ª–∏", "my_models"),
           button(case lang: "en" ‚Üí "üìö How it works" _ ‚Üí "üìö –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç", "how_it_works"),
           button("common", "menu" ¬∑ t, "menu")
         ])

    callback "train" ‚Üí transition TrainingIntro
    callback "my_models" ‚Üí transition MyModels
    callback "how_it_works" ‚Üí transition HowItWorks
    callback "menu" ‚Üí exit(Idle)

  on HowItWorks:
    enter:
      ‚Üí reply("""
        üìö <b>–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç RVC</b>

        <b>RVC (Retrieval-based Voice Conversion)</b> ‚Äî —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –≥–æ–ª–æ—Å–∞ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –∏–Ω—Ç–æ–Ω–∞—Ü–∏–∏.

        <b>–ü—Ä–æ—Ü–µ—Å—Å –æ–±—É—á–µ–Ω–∏—è:</b>
        1Ô∏è‚É£ –ó–∞–≥—Ä—É–∑–∏—Ç–µ 5-15 –º–∏–Ω—É—Ç —á–∏—Å—Ç–æ–≥–æ –≤–æ–∫–∞–ª–∞
        2Ô∏è‚É£ AI –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ç–µ–º–±—Ä –∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏
        3Ô∏è‚É£ –°–æ–∑–¥–∞—ë—Ç—Å—è —É–Ω–∏–∫–∞–ª—å–Ω–∞—è –º–æ–¥–µ–ª—å –≥–æ–ª–æ—Å–∞
        4Ô∏è‚É£ –ú–æ–¥–µ–ª—å –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é

        <b>–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –∞—É–¥–∏–æ:</b>
        ‚Ä¢ –ß–∏—Å—Ç—ã–π –≤–æ–∫–∞–ª –±–µ–∑ –º—É–∑—ã–∫–∏
        ‚Ä¢ –ú–∏–Ω–∏–º—É–º —à—É–º–∞ –∏ —ç—Ö–∞
        ‚Ä¢ –§–æ—Ä–º–∞—Ç: MP3, WAV, FLAC
        ‚Ä¢ –û–±—â–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: 5-15 –º–∏–Ω—É—Ç

        <b>–í—Ä–µ–º—è –æ–±—É—á–µ–Ω–∏—è:</b> 15-30 –º–∏–Ω—É—Ç
        <b>–°—Ç–æ–∏–º–æ—Å—Ç—å:</b> 500 ‚≠ê
        """)
      ‚Üí show_keyboard([
           button("‚ûï –ù–∞—á–∞—Ç—å –æ–±—É—á–µ–Ω–∏–µ", "train"),
           button("üîô –ù–∞–∑–∞–¥", "back")
         ])

    callback "train" ‚Üí transition TrainingIntro
    callback "back" ‚Üí transition Main

  on TrainingIntro:
    enter:
      ‚Üí balance = get_balance(type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id)
      ‚Üí cost = 500
      ‚Üí reply("""
        ‚ûï <b>–û–±—É—á–µ–Ω–∏–µ –Ω–æ–≤–æ–π –º–æ–¥–µ–ª–∏</b>

        üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å: #{cost} ‚≠ê
        üí≥ –í–∞—à –±–∞–ª–∞–Ω—Å: #{balance} ‚≠ê

        –í–∞–º –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è:
        ‚Ä¢ 5-15 –º–∏–Ω—É—Ç —á–∏—Å—Ç–æ–≥–æ –≤–æ–∫–∞–ª–∞
        ‚Ä¢ –ñ–µ–ª–∞—Ç–µ–ª—å–Ω–æ –æ–¥–Ω–æ–≥–æ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è
        ‚Ä¢ –ë–µ–∑ –º—É–∑—ã–∫–∏ –∏ –ø–æ—Å—Ç–æ—Ä–æ–Ω–Ω–∏—Ö –∑–≤—É–∫–æ–≤
        """)
      ‚Üí case balance >= cost:
           true ‚Üí show_keyboard([
             button("‚ñ∂Ô∏è –ù–∞—á–∞—Ç—å", "start"),
             button("‚ùì –ü–æ–¥—Ä–æ–±–Ω–µ–µ", "how_it_works"),
             button("üîô –ù–∞–∑–∞–¥", "back")
           ])
           false ‚Üí show_keyboard([
             button("üí≥ –ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å", "topup"),
             button("üîô –ù–∞–∑–∞–¥", "back")
           ])

    callback "start" ‚Üí transition NameModel
    callback "how_it_works" ‚Üí transition HowItWorks
    callback "topup" ‚Üí exit_to(TopUp)
    callback "back" ‚Üí transition Main

  on NameModel:
    enter:
      ‚Üí reply("""
        ‚úèÔ∏è <b>–ù–∞–∑–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏</b>

        –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è –≥–æ–ª–æ—Å–æ–≤–æ–π –º–æ–¥–µ–ª–∏:

        <i>–ù–∞–ø—Ä–∏–º–µ—Ä: "–ú–æ–π –≥–æ–ª–æ—Å", "–ü–∞–ø–∞", "Taylor Swift"</i>
        """)
      ‚Üí show_keyboard([
           button("üîô –û—Ç–º–µ–Ω–∞", "cancel")
         ])

    message TextMessage(name):
      ‚Üí case validate_model_name(name):
           ‚úÖ_) ‚Üí transition UploadSamples(name)
           ‚ùåmsg) ‚Üí reply("‚ùå {msg}") && stay

    callback "cancel" ‚Üí transition Main

  on UploadSamples(model_name):
    enter:
      ‚Üí reply("""
        üì§ <b>–ó–∞–≥—Ä—É–∑–∫–∞ –æ–±—Ä–∞–∑—Ü–æ–≤</b>

        –ú–æ–¥–µ–ª—å: <b>#{model_name}</b>

        –û—Ç–ø—Ä–∞–≤—å—Ç–µ –∞—É–¥–∏–æ—Ñ–∞–π–ª—ã —Å –≥–æ–ª–æ—Å–æ–º:
        ‚Ä¢ –ú–∏–Ω–∏–º—É–º 5 –º–∏–Ω—É—Ç —Å—É–º–º–∞—Ä–Ω–æ
        ‚Ä¢ –ú–∞–∫—Å–∏–º—É–º 15 –º–∏–Ω—É—Ç
        ‚Ä¢ –ú–æ–∂–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ñ–∞–π–ª–æ–≤

        –ó–∞–≥—Ä—É–∂–µ–Ω–æ: #{format_duration(total_duration ?? 0)} / –º–∏–Ω. 5:00
        """)
      ‚Üí show_keyboard([
           button("‚úÖ –ì–æ—Ç–æ–≤–æ ({format_duration}"(total_duration ?? 0) + ")", "done") ¬∑ if_enabled((total_duration ?? 0) >= 300),
           button("üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å", "clear") ¬∑ if_visible((total_duration ?? 0) > 0),
           button("üîô –û—Ç–º–µ–Ω–∞", "cancel")
         ])
      ‚Üí stay(samples ?? [], total_duration ?? 0)

    message AudioMessage(audio_url):
      ‚Üí reply("‚è≥ –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –∞—É–¥–∏–æ...")
      ‚Üí result = analyze_audio_sample(audio_url)
      ‚Üí case result:
           ‚úÖinfo) ‚Üí {
             ‚Üí new_samples = [...samples, { url: audio_url, duration: info.duration, quality: info.quality }]
             ‚Üí new_total = total_duration + info.duration
             ‚Üí case new_total > 900:
                  true ‚Üí reply("‚ö†Ô∏è –ú–∞–∫—Å–∏–º—É–º 15 –º–∏–Ω—É—Ç. –≠—Ç–æ—Ç —Ñ–∞–π–ª –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω.")
                  false ‚Üí {
                    ‚Üí reply("‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ: {format_duration}"(info.duration) + "\nüìä –ö–∞—á–µ—Å—Ç–≤–æ: {quality_label}"(info.quality))
                    ‚Üí stay(samples: new_samples, total_duration: new_total)
                    ‚Üí enter
                  }
           }
           ‚ùåmsg) ‚Üí reply("‚ùå {msg}") && stay

    message VoiceMessage(voice_url):
      ‚Üí reply("‚è≥ –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –≥–æ–ª–æ—Å–æ–≤–æ–µ...")
      ‚Üí result = analyze_audio_sample(voice_url)
      ‚Üí case result:
           ‚úÖinfo) ‚Üí {
             ‚Üí new_samples = [...samples, { url: voice_url, duration: info.duration, quality: info.quality }]
             ‚Üí new_total = total_duration + info.duration
             ‚Üí reply("‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ: {format_duration}"(info.duration))
             ‚Üí stay(samples: new_samples, total_duration: new_total)
             ‚Üí enter
           }
           ‚ùåmsg) ‚Üí reply("‚ùå {msg}") && stay

    callback "done":
      ‚Üí case total_duration >= 300:
           true ‚Üí transition samples, total_duration ¬∑ ConfirmTraining
           false ‚Üí reply("‚ùå –ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 5 –º–∏–Ω—É—Ç –∞—É–¥–∏–æ")

    callback "clear":
      ‚Üí stay(samples: [], total_duration: 0)
      ‚Üí enter

    callback "cancel" ‚Üí transition Main

  on samples, total_duration ¬∑ ConfirmTraining:
    enter:
      ‚Üí cost = 500
      ‚Üí estimated_time = estimate_training_time(total_duration)
      ‚Üí reply("""
        ‚úÖ <b>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ–±—É—á–µ–Ω–∏—è</b>

        üé§ –ú–æ–¥–µ–ª—å: #{model_name}
        üìÅ –§–∞–π–ª–æ–≤: #{length(samples)}
        ‚è±Ô∏è –ê—É–¥–∏–æ: #{format_duration(total_duration)}

        üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å: #{cost} ‚≠ê
        ‚è≥ –í—Ä–µ–º—è –æ–±—É—á–µ–Ω–∏—è: ~#{estimated_time} –º–∏–Ω—É—Ç

        –ù–∞—á–∞—Ç—å –æ–±—É—á–µ–Ω–∏–µ?
        """)
      ‚Üí show_keyboard([
           button("‚úÖ –î–∞, –Ω–∞—á–∞—Ç—å", "confirm"),
           button("üì§ –î–æ–±–∞–≤–∏—Ç—å –µ—â—ë", "add_more"),
           button("üîô –û—Ç–º–µ–Ω–∞", "cancel")
         ])

    callback "confirm":
      ‚Üí deduct_balance(type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id, 500)
      ‚Üí job_id = start_rvc_training(type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id, model_name, samples)
      ‚Üí transition model_name ¬∑ TrainingProgress

    callback "add_more" ‚Üí transition UploadSamples(model_name)
    callback "cancel" ‚Üí transition Main

  on model_name ¬∑ TrainingProgress:
    enter:
      ‚Üí status = get_job_status(job_id)
      ‚Üí reply("""
        üîÑ <b>–û–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏</b>

        üé§ #{model_name}
        üìä –°—Ç–∞—Ç—É—Å: #{status.state_label}
        ‚è≥ –ü—Ä–æ–≥—Ä–µ—Å—Å: #{status.progress}%

        #{format_training_stage(status.stage)}
        """)
      ‚Üí show_keyboard([
           button("üîÑ –û–±–Ω–æ–≤–∏—Ç—å", "refresh"),
           button("‚ùå –û—Ç–º–µ–Ω–∏—Ç—å", "cancel")
         ])

    callback "refresh":
      ‚Üí status = get_job_status(job_id)
      ‚Üí case status.state:
           "completed" ‚Üí transition TrainingComplete(status.result)
           "failed" ‚Üí {
             ‚Üí reply("‚ùå –û—à–∏–±–∫–∞ –æ–±—É—á–µ–Ω–∏—è: {status}".error)
             ‚Üí refund_balance(type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id, 500)
             ‚Üí transition Main
           }
           _ ‚Üí enter

    callback "cancel":
      ‚Üí cancel_job(job_id)
      ‚Üí refund_balance(type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id, 250)  // Partial refund
      ‚Üí reply("‚ùå –û–±—É—á–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ. –í–æ–∑–≤—Ä–∞—â–µ–Ω–æ 250 ‚≠ê")
      ‚Üí transition Main

    @event job_progress(progress):
      ‚Üí reply("‚è≥ –ü—Ä–æ–≥—Ä–µ—Å—Å: {to_string}"(progress) + "%")

    @event job_completed(result):
      ‚Üí transition TrainingComplete(result)

    @event job_failed(error):
      ‚Üí reply("‚ùå –û—à–∏–±–∫–∞: {error}")
      ‚Üí refund_balance(type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id, 500)
      ‚Üí transition Main

  on TrainingComplete(result):
    enter:
      ‚Üí lang = get_type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_language(type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id)
      ‚Üí reply(case lang:
           "en" ‚Üí "‚úÖ <b>Model is ready!</b>\n\nüé§ {result}"."\nüìä Quality: {quality_label}{model_name}"(result.quality_score) + "\n‚è±Ô∏è Training time: {to_string}"(result.training_time) + " min\n\nModel is available in AI Cover and voiceover."
           _ ‚Üí "‚úÖ <b>–ú–æ–¥–µ–ª—å –≥–æ—Ç–æ–≤–∞!</b>\n\nüé§ {result}"."\nüìä –ö–∞—á–µ—Å—Ç–≤–æ: {quality_label}{model_name}"(result.quality_score) + "\n‚è±Ô∏è –í—Ä–µ–º—è –æ–±—É—á–µ–Ω–∏—è: {to_string}"(result.training_time) + " –º–∏–Ω\n\n–ú–æ–¥–µ–ª—å –¥–æ—Å—Ç—É–ø–Ω–∞ –≤ AI Cover –∏ –æ–∑–≤—É—á–∫–µ.")
      ‚Üí send_audio(result.sample_url, caption: case lang: "en" ‚Üí "üé§ Voice sample" _ ‚Üí "üé§ –ü—Ä–∏–º–µ—Ä –≥–æ–ª–æ—Å–∞")
      ‚Üí show_keyboard([
           button(case lang: "en" ‚Üí "üéµ Try in AI Cover" _ ‚Üí "üéµ –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –≤ AI Cover", "try_cover"),
           button(case lang: "en" ‚Üí "üìã My models" _ ‚Üí "üìã –ú–æ–∏ –º–æ–¥–µ–ª–∏", "my_models"),
           button("common", "menu" ¬∑ t, "menu")
         ])

    callback "try_cover" ‚Üí exit_to(AICover)
    callback "my_models" ‚Üí transition MyModels
    callback "menu" ‚Üí exit(Idle)

  on MyModels:
    enter:
      ‚Üí models = get_type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_rvc_models(type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id)
      ‚Üí case models:
           [] ‚Üí {
             ‚Üí reply("üì≠ –£ –≤–∞—Å –Ω–µ—Ç –≥–æ–ª–æ—Å–æ–≤—ã—Ö –º–æ–¥–µ–ª–µ–π")
             ‚Üí show_keyboard([
                  button("‚ûï –û–±—É—á–∏—Ç—å –º–æ–¥–µ–ª—å", "train"),
                  button("üîô –ù–∞–∑–∞–¥", "back")
                ])
           }
           list ‚Üí {
             ‚Üí reply("""
               üìã <b>–í–∞—à–∏ –≥–æ–ª–æ—Å–æ–≤—ã–µ –º–æ–¥–µ–ª–∏</b>

               #{format_models_list(list)}
               """)
             ‚Üí buttons = list
                  ¬∑ map(fn(m) { button("üé§ {m}".name, "model:{m}".id) }
             ‚Üí show_keyboard(buttons  + [
                  button("‚ûï –û–±—É—á–∏—Ç—å –Ω–æ–≤—É—é", "train"),
                  button("üîô –ù–∞–∑–∞–¥", "back")
                ])
           }

    callback /^model:(.+)$/:
      ‚Üí model_id = extract_id(callback_data)
      ‚Üí transition ModelDetails(model_id)

    callback "train" ‚Üí transition TrainingIntro
    callback "back" ‚Üí transition Main

  on ModelDetails(model_id):
    enter:
      ‚Üí model = get_rvc_model(model_id)
      ‚Üí reply("""
        üé§ <b>#{model.name}</b>

        üìÖ –°–æ–∑–¥–∞–Ω–∞: #{model.created_at}
        üìä –ö–∞—á–µ—Å—Ç–≤–æ: #{quality_label(model.quality_score)}
        üéµ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π: #{model.usage_count}
        """)
      ‚Üí send_audio(model.sample_url, caption: "üé§ –ü—Ä–∏–º–µ—Ä")
      ‚Üí show_keyboard([
           button("üéµ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å", "use"),
           button("‚úèÔ∏è –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å", "rename"),
           button("üóëÔ∏è –£–¥–∞–ª–∏—Ç—å", "delete"),
           button("üîô –ù–∞–∑–∞–¥", "back")
         ])

    callback "use" ‚Üí exit_to(AICover)

    callback "rename" ‚Üí transition RenameModel(model_id)

    callback "delete" ‚Üí transition ConfirmDelete(model_id)

    callback "back" ‚Üí transition MyModels

  on RenameModel(model_id):
    enter:
      ‚Üí model = get_rvc_model(model_id)
      ‚Üí reply("""
        ‚úèÔ∏è <b>–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å –º–æ–¥–µ–ª—å</b>

        –¢–µ–∫—É—â–µ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ: #{model.name}

        –í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ:
        """)
      ‚Üí show_keyboard([
           button("üîô –û—Ç–º–µ–Ω–∞", "cancel")
         ])

    message TextMessage(new_name):
      ‚Üí case validate_model_name(new_name):
           ‚úÖ_) ‚Üí {
             ‚Üí new_name ¬∑ rename_rvc_model
             ‚Üí reply("‚úÖ –ú–æ–¥–µ–ª—å –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∞ –≤ <b>#{new_name}</b>")
             ‚Üí transition ModelDetails(model_id)
           }
           ‚ùåmsg) ‚Üí reply("‚ùå {msg}") && stay

    callback "cancel" ‚Üí transition ModelDetails(model_id)

  on ConfirmDelete(model_id):
    enter:
      ‚Üí model = get_rvc_model(model_id)
      ‚Üí reply("""
        ‚ö†Ô∏è <b>–£–¥–∞–ª–∏—Ç—å –º–æ–¥–µ–ª—å?</b>

        üé§ #{model.name}

        –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ!
        """)
      ‚Üí show_keyboard([
           button("üóëÔ∏è –î–∞, —É–¥–∞–ª–∏—Ç—å", "confirm"),
           button("üîô –û—Ç–º–µ–Ω–∞", "cancel")
         ])

    callback "confirm":
      ‚Üí delete_rvc_model(model_id)
      ‚Üí reply("‚úÖ –ú–æ–¥–µ–ª—å —É–¥–∞–ª–µ–Ω–∞")
      ‚Üí transition MyModels

    callback "cancel" ‚Üí transition ModelDetails(model_id)

// =============================================================================
// HELPER FUNCTIONS
// =============================================================================

validate_model_name(name):
  case string.length(name):
    l if l < 2 ‚Üí ‚ùå"–ù–∞–∑–≤–∞–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–æ–µ")
    l if l > 50 ‚Üí ‚ùå"–ù–∞–∑–≤–∞–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ")
    _ ‚Üí ‚úÖstring.trim(name))

format_duration(seconds):
  minutes = seconds / 60
  secs = seconds % 60
  to_string(minutes) + ":{pad_left}"(to_string(secs), 2, "0")

cache(24h)
quality_label(score):
  case score:
    s if s >= 90 ‚Üí "üåü –û—Ç–ª–∏—á–Ω–æ"
    s if s >= 70 ‚Üí "‚úÖ –•–æ—Ä–æ—à–æ"
    s if s >= 50 ‚Üí "‚ö†Ô∏è –£–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω–æ"
    _ ‚Üí "‚ùå –ù–∏–∑–∫–æ–µ"

estimate_training_time(duration_seconds):
  // Roughly 2 minutes training per minute of audio
  (duration_seconds / 60) * 2

format_training_stage(stage):
  case stage:
    "preprocessing" ‚Üí "üì• –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∞—É–¥–∏–æ..."
    "feature_extraction" ‚Üí "üîç –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫..."
    "training" ‚Üí "üß† –û–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏..."
    "optimization" ‚Üí "‚ö° –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è..."
    "finalizing" ‚Üí "‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ..."
    _ ‚Üí "‚è≥ –û–±—Ä–∞–±–æ—Ç–∫–∞..."

format_models_list(models):
  models
    ¬∑ map(fn(m) {
         "üé§ {m}"." ({quality_label}{name}"(m.quality_score) + ")"
       }
    ¬∑ join("\n")

# v8.0

# v10.0 - ML-Powered Migration
