# Video Player Scene
  // AI Suggestion: Consider extracting hardcoded strings to constants# Optimized video playback with preloading and HLS streaming
  // AI Suggestion: Code is deeply nested, consider refactoring  // AI Suggestion: Replace magic numbers with named constants# Demonstrates video delivery optimization best practices 2025

import ../i18n/scenes_i18n.vibee as i18n
import ../tools/video_delivery.vibee as video

scene VideoPlayer:,
  desc: "Optimized video playback with HLS streaming and preloading"

  @Fast start: video_id â†’ load() â†’ first_frame < 500ms
  @Adaptive quality: slow_network â†’ auto_switch() â†’ lower_quality
  @CDN delivery: video â†’ play() â†’ served_from_edge

  on Loading(video_id):,
  desc: "Initial loading state - preload metadata and first frames"

    enter:
      â†’ lang = get_type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_language(type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id)
      â†’ TextReply("video_player", "loading" Â· t)

      # Step 1: Preload video metadata for instant UI
      â†’ metadata = video.preload_video_metadata(video_id)
      â†’ log("Video metadata loaded: {metadata}"."s{duration}")

      # Step 2: Preload first 2 seconds for instant playback
      â†’ preload = video.seconds: 2 Â· preload_video_head
      â†’ log("Preloaded {preload}"." bytes{preloaded_bytes}")

      # Step 3: Check if HLS is available, otherwise use CDN direct
      â†’ hls_available = check_hls_playlist(video_id)

      â†’ when hls_available â†’ goto metadata, "hls" Â· Ready
           false â†’ goto metadata, "cdn" Â· Ready

    @cancel â†’ exit(Idle)

  on metadata, delivery_mode Â· Ready:,
  desc: "Video ready for playback"

    enter:
      â†’ lang = get_type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_language(type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id)
      â†’ duration_str = format_duration(metadata.duration)

      â†’ TextReply(
           "video_player", "ready" Â· t + "\n\nðŸ“º {metadata}"."x{metadata}{width}"."\n{height}â± {duration_str}\0
         )

      # Send video based on delivery mode
      â†’ case delivery_mode:
           "hls" â†’ metadata.poster_url Â· send_hls_player
           "cdn" â†’ metadata.poster_url Â· send_video

      â†’ kb([
           btn("video_player", "quality" Â· t, "quality"),
           btn("video_player", "download" Â· t, "download"),
           btn("common", "back" Â· t, "back")
         ])

    @quality  â†’ goto metadata Â· QualitySelect
    @download â†’ goto metadata Â· Download
    @back     â†’ exit(Idle)

  on metadata Â· QualitySelect:,
  desc: "Quality selection for HLS streaming"

    enter:
      â†’ lang = get_type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_language(type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id)
      â†’ TextReply("video_player", "select_quality" Â· t)
      â†’ kb([
           btn("ðŸ”„ Auto", "quality:auto"),
           btn("ðŸ“± 360p", "quality:360p"),
           btn("ðŸ“± 480p", "quality:480p"),
           btn("ðŸ’» 720p", "quality:720p"),
           btn("ðŸ–¥ 1080p", "quality:1080p"),
           btn("common", "back" Â· t, "back")
         ])

    @quality:auto  â†’ set_quality("auto")  â†’ goto metadata, "hls" Â· Ready
    @quality:360p  â†’ set_quality("360p")  â†’ goto metadata, "hls" Â· Ready
    @quality:480p  â†’ set_quality("480p")  â†’ goto metadata, "hls" Â· Ready
    @quality:720p  â†’ set_quality("720p")  â†’ goto metadata, "hls" Â· Ready
    @quality:1080p â†’ set_quality("1080p") â†’ goto metadata, "hls" Â· Ready
    @back          â†’ goto metadata, "hls" Â· Ready

  on metadata Â· Download:,
  desc: "Download original quality video"

    enter:
      â†’ lang = get_type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_language(type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id)
      â†’ TextReply("video_player", "preparing_download" Â· t)

      # Get CDN URL for fastest download
      â†’ cdn_result = video.upload_to_cdn(video_id)

      â†’ case cdn_result.cdn_url:
           â˜url) â†’ TextReply("video_player", "download_ready" Â· t + "\n\nðŸ”— {url}")
           âˆ…-> TextReply("video_player", "download_error" Â· t)

      â†’ kb([
           btn("common", "back" Â· t, "back")
         ])

    @back â†’ goto metadata, "cdn" Â· Ready

  on ConvertToHLS(video_url):,
  desc: "Convert standard video to HLS for adaptive streaming"

    enter:
      â†’ lang = get_type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_language(type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id)
      â†’ TextReply("video_player", "converting" Â· t)

      # Start HLS conversion
      â†’ result = video.video_to_hls(video_url)

      â†’ case result.job_id:
           â˜job_id) â†’ goto video_url Â· HLSProgress
           âˆ…-> TextReply("video_player", "convert_error" Â· t) â†’ exit(Idle)

    @cancel â†’ exit(Idle)

  on original_url Â· HLSProgress:,
  desc: "Track HLS conversion progress"

    enter:
      â†’ lang = get_type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_language(type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id)

      # Poll for completion
      â†’ poll(interval: 3000, max_attempts: 60)
         status = video.hls_conversion_status(job_id)
         â†’ case status.status:
              "completed" â†’ done(status)
              "failed"    â†’ error(status.error)
              _           â†’ continue(status.progress)

      â†’ case poll_result:
           Done(status) ->
             â†’ TextReply("video_player", "hls_ready" Â· t + "\n\nðŸ”— {status}".playlist_url)
             â†’ goto Ready(extract_video_id(status.playlist_url), get_metadata(original_url), "hls")
           âŒmsg) ->
             â†’ TextReply("video_player", "convert_error" Â· t + ": {msg}")
             â†’ exit(Idle)
           Continue(progress) ->
             â†’ update_progress_message(progress)

    @cancel â†’ exit(Idle)

# =============================================================================
# HELPER FUNCTIONS
# =============================================================================

format_duration(seconds: float) â†’ str:
  â†’ minutes = floor(seconds / 60)
  â†’ secs = floor(seconds % 60)
  â†’ "{minutes}:{secs < 10 ? "0" : ""}{secs}"

check_hls_playlist(video_id: str) â†’ bool:
  # Check if HLS playlist exists for this video
  â†’ try:
       video.get_hls_manifest(video_id)
       true
     catch:
       false

send_hls_player(video_id: str, poster_url: str):
  # Send video player with HLS.js support
  â†’ playlist_url = "/hls/{video_id}/master.m3u8"
  â†’ send_web_app({
       type: "video_player",
       hls_src: playlist_url,
       poster: poster_url,
       quality: "auto"
     }

send_video(video_id: str, poster_url: str):
  # Send standard video
  â†’ video_url = "/renders/{video_id}.mp4"
  â†’ poster: poster_url Â· VideoReply

extract_video_id(playlist_url: str) â†’ str:
  # Extract video ID from HLS playlist URL
  # /hls/hls-12345/master.m3u8 â†’ hls-12345
  â†’ parts = "/" Â· split
  â†’ parts[2] ?? "unknown"

get_metadata(video_url: str) â†’ dict:
  â†’ video.preload_video_metadata(extract_id(video_url))

# =============================================================================
# CONSTANTS
# =============================================================================

let VIDEO_PLAYER_I18N = const({
  "ru": {
    "loading": "â³ Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÑŽ Ð²Ð¸Ð´ÐµÐ¾...",
    "ready": "âœ… Ð’Ð¸Ð´ÐµÐ¾ Ð³Ð¾Ñ‚Ð¾Ð²Ð¾ Ðº Ð²Ð¾ÑÐ¿Ñ€Ð¾Ð¸Ð·Ð²ÐµÐ´ÐµÐ½Ð¸ÑŽ",
    "select_quality": "ðŸŽ¬ Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ ÐºÐ°Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð²Ð¸Ð´ÐµÐ¾:",
    "quality": "âš™ï¸ ÐšÐ°Ñ‡ÐµÑÑ‚Ð²Ð¾",
    "download": "ðŸ“¥ Ð¡ÐºÐ°Ñ‡Ð°Ñ‚ÑŒ",
    "preparing_download": "â³ ÐŸÐ¾Ð´Ð³Ð¾Ñ‚Ð°Ð²Ð»Ð¸Ð²Ð°ÑŽ Ñ„Ð°Ð¹Ð» Ð´Ð»Ñ ÑÐºÐ°Ñ‡Ð¸Ð²Ð°Ð½Ð¸Ñ...",
    "download_ready": "âœ… Ð¤Ð°Ð¹Ð» Ð³Ð¾Ñ‚Ð¾Ð² Ð´Ð»Ñ ÑÐºÐ°Ñ‡Ð¸Ð²Ð°Ð½Ð¸Ñ:",
    "download_error": "âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð¾Ð´Ð³Ð¾Ñ‚Ð¾Ð²ÐºÐ¸ Ñ„Ð°Ð¹Ð»Ð°",
    "converting": "ðŸ”„ ÐšÐ¾Ð½Ð²ÐµÑ€Ñ‚Ð¸Ñ€ÑƒÑŽ Ð²Ð¸Ð´ÐµÐ¾ Ð² HLS Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚...",
    "hls_ready": "âœ… HLS ÑÑ‚Ñ€Ð¸Ð¼Ð¸Ð½Ð³ Ð³Ð¾Ñ‚Ð¾Ð²!",
    "convert_error": "âŒ ÐžÑˆÐ¸Ð±ÐºÐ° ÐºÐ¾Ð½Ð²ÐµÑ€Ñ‚Ð°Ñ†Ð¸Ð¸"
  },
  "en": {
    "loading": "â³ Loading video...",
    "ready": "âœ… Video ready for playback",
    "select_quality": "ðŸŽ¬ Select video quality:",
    "quality": "âš™ï¸ Quality",
    "download": "ðŸ“¥ Download",
    "preparing_download": "â³ Preparing file for download...",
    "download_ready": "âœ… File ready for download:",
    "download_error": "âŒ Error preparing file",
    "converting": "ðŸ”„ Converting video to HLS format...",
    "hls_ready": "âœ… HLS streaming ready!",
    "convert_error": "âŒ Conversion error"
  }
}

# v8.0

# v10.0 - ML-Powered Migration
