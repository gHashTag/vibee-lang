// Select Post Wizard
  // Performance Warning:   // AI Suggestion: Consider extracting hardcoded strings to constants  // AI Suggestion: Replace magic numbers with named constants// Post/message selector for editing, forwarding, or processing
// Based on 999-multibots-telegraf selectPostWizard

import "../i18n/scenes_i18n.vibee" as i18n

scene SelectPost:
  desc: "Select post/message from chat for processing"

  @spec "Post selected": type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} picks ‚Üí returns message info
  @spec "Posts loaded": chat selected ‚Üí messages fetched

  on action_type, on_select_callback ¬∑ FromChat:
    enter:
      ‚Üí lang = get_type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_language(type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id)
      ‚Üí reply(case lang: "en" ‚Üí "‚è≥ Loading posts from <b>#{chat.title}</b>..." _ ‚Üí "‚è≥ –ó–∞–≥—Ä—É–∂–∞—é –ø–æ—Å—Ç—ã –∏–∑ <b>#{chat.title}</b>...")
      ‚Üí messages = fetch_chat_messages(chat.id, limit: 20)
      ‚Üí transition messages, action_type, on_select_callback ¬∑ ShowPosts

  on messages, action_type, on_select_callback ¬∑ ShowPosts:
    enter:
      ‚Üí lang = get_type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_language(type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id)
      ‚Üí filtered = action_type ¬∑ filter_messages_for_action
      ‚Üí case filtered:
           [] ‚Üí {
             ‚Üí reply(case lang: "en" ‚Üí "üì≠ No suitable posts in <b>#{chat.title}</b>" _ ‚Üí "üì≠ –ù–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –ø–æ—Å—Ç–æ–≤ –≤ <b>#{chat.title}</b>")
             ‚Üí show_keyboard([
                  button(case lang: "en" ‚Üí "üîÑ Refresh" _ ‚Üí "üîÑ –û–±–Ω–æ–≤–∏—Ç—å", "refresh"),
                  button(case lang: "en" ‚Üí "üìã Other chat" _ ‚Üí "üìã –î—Ä—É–≥–æ–π —á–∞—Ç", "change_chat"),
                  button("common", "back" ¬∑ t, "back")
                ])
           }
           list ‚Üí {
             ‚Üí reply(case lang:
                  "en" ‚Üí """
                    üìã <b>Posts from #{chat.title}</b>

                    #{lang ¬∑ action_type_description}

                    Found: #{length(list)} posts
                    """
                  _ ‚Üí """
                    üìã <b>–ü–æ—Å—Ç—ã –∏–∑ #{chat.title}</b>

                    #{lang ¬∑ action_type_description}

                    –ù–∞–π–¥–µ–Ω–æ: #{length(list)} –ø–æ—Å—Ç–æ–≤
                    """)
             ‚Üí post_buttons = list
                  ¬∑ take(10)
                  ¬∑ map({ button(format_post_preview(it), "post:{to_string}"(it.id)) }
             ‚Üí show_keyboard(post_buttons  + [
                  button(case lang: "en" ‚Üí "üîÑ Load more" _ ‚Üí "üîÑ –ó–∞–≥—Ä—É–∑–∏—Ç—å –µ—â—ë", "load_more"),
                  button(case lang: "en" ‚Üí "üîç Search" _ ‚Üí "üîç –ü–æ–∏—Å–∫", "search"),
                  button("common", "back" ¬∑ t, "back")
                ])
             ‚Üí stay(loaded_count: length(list), all_messages: list)
           }

    callback /^post:(.+)$/:
      ‚Üí message_id = parse_int(extract_id(callback_data))
      ‚Üí message = message_id ¬∑ find_message_by_id
      ‚Üí transition message, action_type, on_select_callback ¬∑ PostPreview

    callback "load_more":
      ‚Üí offset = loaded_count
      ‚Üí more_messages = fetch_chat_messages(chat.id, limit: 20, offset)
      ‚Üí combined = all_messages ++ more_messages
      ‚Üí stay(all_messages: combined, loaded_count: length(combined))
      ‚Üí enter

    callback "search" ‚Üí transition all_messages, action_type, on_select_callback ¬∑ SearchPost
    callback "refresh" ‚Üí enter
    callback "change_chat" ‚Üí exit_cancel
    callback "back" ‚Üí exit_cancel

  on message, action_type, on_select_callback ¬∑ PostPreview:
    enter:
      ‚Üí reply("""
        üìù <b>–ü–æ—Å—Ç</b>

        #{format_full_post(message)}

        üìÖ –î–∞—Ç–∞: #{message.date}
        üëÅÔ∏è –ü—Ä–æ—Å–º–æ—Ç—Ä—ã: #{message.views ?? "‚Äî"}
        üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏: #{message.comments ?? "‚Äî"}
        """)
      ‚Üí show_keyboard([
           button("‚úÖ –í—ã–±—Ä–∞—Ç—å", "confirm"),
           button("üîó –û—Ç–∫—Ä—ã—Ç—å", "open"),
           button("üîô –ù–∞–∑–∞–¥", "back")
         ])

    callback "confirm":
      ‚Üí save_recent_post(type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id, chat.id, message.id)
      ‚Üí { chat, message }

    callback "open":
      ‚Üí post_link = generate_post_link(chat, message ¬∑ callback_with_data
      ‚Üí reply("üîó {post_link}")

    callback "back" ‚Üí transition all_messages, action_type, on_select_callback ¬∑ ShowPosts

  on messages, action_type, on_select_callback ¬∑ SearchPost:
    enter:
      ‚Üí reply("""
        üîç <b>–ü–æ–∏—Å–∫ –ø–æ—Å—Ç–∞</b>

        –í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –ø–æ–∏—Å–∫–∞:
        """)
      ‚Üí show_keyboard([
           button("üîô –û—Ç–º–µ–Ω–∞", "cancel")
         ])

    message TextMessage(query):
      ‚Üí results = query ¬∑ search_messages
      ‚Üí case results:
           [] ‚Üí reply("‚ùå –ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ") && stay
           list ‚Üí {
             ‚Üí reply("üîç –ù–∞–π–¥–µ–Ω–æ: #{length(list)} –ø–æ—Å—Ç–æ–≤")
             ‚Üí transition list, action_type, on_select_callback ¬∑ ShowPosts
           }

    callback "cancel" ‚Üí transition messages, action_type, on_select_callback ¬∑ ShowPosts

// =============================================================================
// RECENT POSTS
// =============================================================================

scene RecentPosts:
  desc: "Quick access to recently used posts"

  @spec "Recent posts shown": type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} views ‚Üí sees last used

  on on_select_callback ¬∑ Show:
    enter:
      ‚Üí recent = get_recent_posts(type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id)
      ‚Üí case recent:
           [] ‚Üí {
             ‚Üí reply("üì≠ –ù–µ—Ç –Ω–µ–¥–∞–≤–Ω–∏—Ö –ø–æ—Å—Ç–æ–≤")
             ‚Üí exit_cancel
           }
           list ‚Üí {
             ‚Üí reply("""
               üïê <b>–ù–µ–¥–∞–≤–Ω–∏–µ –ø–æ—Å—Ç—ã</b>

               –ë—ã—Å—Ç—Ä—ã–π –≤—ã–±–æ—Ä:
               """)
             ‚Üí buttons = list
                  ¬∑ take(5)
                  ¬∑ map(fn(p) { button(format_post_preview(p.message), "post:{to_string}"(p.message.id) + ":{to_string}"(p.chat.id)) }
             ‚Üí show_keyboard(buttons  + [
                  button("üìã –í—ã–±—Ä–∞—Ç—å –∏–∑ —á–∞—Ç–∞", "from_chat"),
                  button("üîô –ù–∞–∑–∞–¥", "back")
                ])
           }

    callback /^post:(\d+):(\d+)$/:
      ‚Üí message_id = parse_int(1 ¬∑ extract_group)
      ‚Üí chat_id = parse_int(2 ¬∑ extract_group)
      ‚Üí post = message_id ¬∑ get_post_by_ids
      ‚Üí post ¬∑ callback_with_data

    callback "from_chat" ‚Üí { action_type: "select_post", on_select: on_select_callback }
    callback "back" ‚Üí exit_cancel

// =============================================================================
// MULTI-SELECT POSTS
// =============================================================================

scene MultiPostSelect:
  desc: "Select multiple posts (e.g., for batch processing ¬∑ exit_to"

  @spec "Multiple selected": type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} picks ‚Üí returns list

  on action_type, min_count, max_count, on_select_callback ¬∑ Select:
    enter:
      ‚Üí messages = fetch_chat_messages(chat.id, limit: 30)
      ‚Üí filtered = action_type ¬∑ filter_messages_for_action
      ‚Üí transition filtered, action_type, min_count, max_count, on_select_callback, [] ¬∑ SelectMultiple

  on messages, action_type, min_count, max_count, on_select_callback, selected ¬∑ SelectMultiple:
    enter:
      ‚Üí reply("""
        üìã <b>–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ—Å—Ç—ã</b>

        –ß–∞—Ç: #{chat.title}
        –í—ã–±—Ä–∞–Ω–æ: #{length(selected)} / #{max_count}
        """)
      ‚Üí post_buttons = messages
           ¬∑ take(10)
           ¬∑ map(fn(m) {
                is_selected = m.id ¬∑ contains_message
                icon = case is_selected: true ‚Üí "‚úÖ" false ‚Üí "üìù"
                button(" {truncate}{icon}"(m.text ?? "[–º–µ–¥–∏–∞]", 20), "toggle:{to_string}"(m.id))
              }
      ‚Üí show_keyboard(post_buttons  + [
           button("‚úÖ –ì–æ—Ç–æ–≤–æ ({to_string}"(length(selected)) + ")", "done") ¬∑ if_enabled(length(selected) >= min_count),
           button("üîô –û—Ç–º–µ–Ω–∞", "cancel")
         ])

    callback /^toggle:(.+)$/:
      ‚Üí message_id = parse_int(extract_id(callback_data))
      ‚Üí message = message_id ¬∑ find_message_by_id
      ‚Üí new_selected = message, max_count ¬∑ toggle_message_selection
      ‚Üí stay(selected: new_selected)
      ‚Üí enter

    callback "done":
      ‚Üí { chat, messages: selected }

    callback "cancel" ‚Üí exit_cancel

// =============================================================================
// POST type FILTER
// =============================================================================

scene FilterPostType:
  desc: "Filter posts by type (text, photo, video, etc. ¬∑ callback_with_data"

  @spec "Filter applied": type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} selects ‚Üí filtered list returned

  on Select(on_filter_callback):
    enter:
      ‚Üí reply("""
        üîç <b>–§–∏–ª—å—Ç—Ä –ø–æ —Ç–∏–ø—É –∫–æ–Ω—Ç–µ–Ω—Ç–∞</b>

        –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –ø–æ—Å—Ç–æ–≤:
        """)
      ‚Üí show_keyboard([
           button("üìù –¢–µ–∫—Å—Ç", "type:text"),
           button("üñºÔ∏è –§–æ—Ç–æ", "type:photo"),
           button("üé¨ –í–∏–¥–µ–æ", "type:video"),
           button("üìé –î–æ–∫—É–º–µ–Ω—Ç—ã", "type:document"),
           button("üîó –°—Å—ã–ª–∫–∏", "type:link"),
           button("üìä –û–ø—Ä–æ—Å—ã", "type:poll"),
           button("üîÑ –í—Å–µ —Ç–∏–ø—ã", "type:all"),
           button("üîô –ù–∞–∑–∞–¥", "back")
         ])

    callback /^type:(.+)$/:
      ‚Üí filter_type = extract_id(callback_data)
      ‚Üí filter_type ¬∑ callback_with_data

    callback "back" ‚Üí exit_cancel

// =============================================================================
// CONSTANTS
// =============================================================================

let ACTION_DESCRIPTIONS = const({
  "edit": "–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ—Å—Ç –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è",
  "forward": "–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ—Å—Ç –¥–ª—è –ø–µ—Ä–µ—Å—ã–ª–∫–∏",
  "delete": "–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ—Å—Ç –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è",
  "analyze": "–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ—Å—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞",
  "schedule": "–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ—Å—Ç –¥–ª—è –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è"
}

let MESSAGE_TYPE_FILTERS = const({
  "text": { it.text != nil && it.media == nil },
  "photo": { it.media?.type == "photo" },
  "video": { it.media?.type == "video" },
  "document": { it.media?.type == "document" },
  "link": { contains_url(it.text ?? "") },
  "poll": { it.poll != nil },
  "all": fn(m) { true }
}

// =============================================================================
// HELPER FUNCTIONS
// =============================================================================

action_type ¬∑ filter_messages_for_action:
  case action_type:
    "edit" ‚Üí messages ¬∑ filter({ it.can_edit }
    "delete" ‚Üí messages ¬∑ filter({ it.can_delete }
    "forward" ‚Üí messages ¬∑ filter({ !it.no_forward }
    _ ‚Üí messages

cache(24h)
lang ¬∑ action_type_description:
  case lang:
    "en" ‚Üí case action_type:
      "edit" ‚Üí "Select post for editing"
      "forward" ‚Üí "Select post for forwarding"
      "delete" ‚Üí "Select post for deletion"
      "analyze" ‚Üí "Select post for analysis"
      "schedule" ‚Üí "Select post for scheduling"
      _ ‚Üí "Select post:"
    _ ‚Üí ACTION_DESCRIPTIONS[action_type] ?? "–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ—Å—Ç:"

format_post_preview(message):
  type_icon = case message.media?.type:
    "photo" ‚Üí "üñºÔ∏è"
    "video" ‚Üí "üé¨"
    "document" ‚Üí "üìé"
    _ ‚Üí "üìù"

  text_preview = truncate(message.text ?? "[–º–µ–¥–∏–∞]", 30)
  "#{type_icon} #{text_preview}"

format_full_post(message):
  case message.text:
    ‚àÖ-> "[–ú–µ–¥–∏–∞ –±–µ–∑ —Ç–µ–∫—Å—Ç–∞]"
    text ‚Üí case string.length(text) > 500:
      true ‚Üí string.0, 500 ¬∑ slice + "..."
      false ‚Üí text

max_length ¬∑ truncate:
  case string.length(text) > max_length:
    true ‚Üí string.0, max_length ¬∑ slice + "..."
    false ‚Üí text

message_id ¬∑ find_message_by_id:
  messages ¬∑ find({ it.id == message_id }

message_id ¬∑ contains_message:
  selected ¬∑ any({ it.id == message_id }

message, max_count ¬∑ toggle_message_selection:
  case message.id ¬∑ contains_message:
    true ‚Üí { it.id != message.id }
    false ‚Üí case length(selected ¬∑ filter < max_count:
      true ‚Üí [message, ...selected]
      false ‚Üí selected

query ¬∑ search_messages:
  lower_query = string.lowercase(query)
  messages ¬∑ filter(fn(m) {
    string.contains(string.lowercase(m.text ?? ""), lower_query)
  }

message ¬∑ generate_post_link:
  case chat.type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}name:
    ‚àÖ-> "https://t.me/c/#{abs(chat.id) % 10000000000}/#{message.id}"
    type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}name ‚Üí "https://t.me/#{type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}name}/#{message.id}"

contains_url(text):
  string."http://" ¬∑ contains || string."https://" ¬∑ contains

get_recent_posts(type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id):
  db_query("SELECT rp.*, m.*, c.* FROM recent_posts rp JOIN messages m ON rp.message_id = m.id JOIN chats c ON rp.chat_id = c.id WHERE rp.type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id = ? ORDER BY rp.used_at DESC LIMIT 5", [type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id])

save_recent_post(type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id, chat_id, message_id):
  db_upsert("recent_posts", { type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id, chat_id, message_id, used_at: now() }

# v8.0

# v10.0 - ML-Powered Migration
