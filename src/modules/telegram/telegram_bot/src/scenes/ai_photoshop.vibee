# AI Photoshop Scene
  // AI Suggestion: Code is deeply nested, consider refactoring  // AI Suggestion: Consider extracting hardcoded strings to constants  // AI Suggestion: Replace magic numbers with named constants# Comprehensive AI-powered photo editing
  // Performance Warning: # Based on 999-multibots-telegraf aiPhotoshopScene

import ../i18n/scenes_i18n.vibee as i18n

scene AIPhotoshop:,
  desc: "AI-powered photo editing with multiple tools"

  @Photo edited: image uploaded ‚Üí tool applied ‚Üí result returned
  @Style transferred: source + style ‚Üí stylized image

  on Main:
    enter:
      ‚Üí lang = get_type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_language(type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id)
      ‚Üí send(case lang:
           "en" ‚Üí """
             üé® <b>AI Photoshop</b>

             Edit photos with AI:

             ‚Ä¢ üñºÔ∏è Quality enhancement
             ‚Ä¢ üé≠ Background replacement
             ‚Ä¢ ‚ú® Object removal
             ‚Ä¢ üé® Stylization
             ‚Ä¢ üë§ Face editing
             ‚Ä¢ üåà Color correction

             Send a photo to edit or select a tool:
             """
           _ ‚Üí """
             üé® <b>AI Photoshop</b>

             –†–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ —Ñ–æ—Ç–æ —Å –ø–æ–º–æ—â—å—é AI:

             ‚Ä¢ üñºÔ∏è –£–ª—É—á—à–µ–Ω–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞
             ‚Ä¢ üé≠ –ó–∞–º–µ–Ω–∞ —Ñ–æ–Ω–∞
             ‚Ä¢ ‚ú® –£–¥–∞–ª–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–æ–≤
             ‚Ä¢ üé® –°—Ç–∏–ª–∏–∑–∞—Ü–∏—è
             ‚Ä¢ üë§ –†–∞–±–æ—Ç–∞ —Å –ª–∏—Ü–∞–º–∏
             ‚Ä¢ üåà –¶–≤–µ—Ç–æ–∫–æ—Ä—Ä–µ–∫—Ü–∏—è

             –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç:
             """)
      ‚Üí kb([
           btn(case lang: "en" ‚Üí "üñºÔ∏è Enhance quality" _ ‚Üí "üñºÔ∏è –£–ª—É—á—à–∏—Ç—å –∫–∞—á–µ—Å—Ç–≤–æ", "enhance"),
           btn(case lang: "en" ‚Üí "üé≠ Replace background" _ ‚Üí "üé≠ –ó–∞–º–µ–Ω–∏—Ç—å —Ñ–æ–Ω", "background"),
           btn(case lang: "en" ‚Üí "‚ú® Remove object" _ ‚Üí "‚ú® –£–¥–∞–ª–∏—Ç—å –æ–±—ä–µ–∫—Ç", "remove"),
           btn(case lang: "en" ‚Üí "üé® Stylization" _ ‚Üí "üé® –°—Ç–∏–ª–∏–∑–∞—Ü–∏—è", "style"),
           btn(case lang: "en" ‚Üí "üë§ Faces" _ ‚Üí "üë§ –õ–∏—Ü–∞", "face"),
           btn(case lang: "en" ‚Üí "üåà Color correction" _ ‚Üí "üåà –¶–≤–µ—Ç–æ–∫–æ—Ä—Ä–µ–∫—Ü–∏—è", "color"),
           btn(case lang: "en" ‚Üí "üìã History" _ ‚Üí "üìã –ò—Å—Ç–æ—Ä–∏—è", "history"),
           btn("common", "menu" ¬∑ t, "menu")
         ])

    message PhotoMessage(photo_url):
      ‚Üí goto SelectTool(photo_url)

    @enhance ‚Üí goto UploadForTool("enhance")
    @background ‚Üí goto UploadForTool("background")
    @remove ‚Üí goto UploadForTool("remove")
    @style ‚Üí goto UploadForTool("style")
    @face ‚Üí goto UploadForTool("face")
    @color ‚Üí goto UploadForTool("color")
    @history ‚Üí goto EditHistory
    @menu ‚Üí exit(Idle)

  on UploadForTool(tool):
    enter:
      ‚Üí lang = get_type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_language(type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id)
      ‚Üí send(case lang:
           "en" ‚Üí """
             üì∏ <b>Upload photo</b>

             Send a photo for tool: #{tool_label(tool)}
             """
           _ ‚Üí """
             üì∏ <b>–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ</b>

             –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ –¥–ª—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞: #{tool_label(tool)}
             """)
      ‚Üí kb([
           btn("common", "back" ¬∑ t, "back")
         ])

    message PhotoMessage(photo_url):
      ‚Üí case tool:
           "enhance" ‚Üí goto EnhancePhoto(photo_url)
           "background" ‚Üí goto BackgroundTool(photo_url)
           "remove" ‚Üí goto RemoveObject(photo_url)
           "style" ‚Üí goto StyleTransfer(photo_url)
           "face" ‚Üí goto FaceTools(photo_url)
           "color" ‚Üí goto ColorCorrection(photo_url)

    @back ‚Üí goto Main

  on SelectTool(photo_url):
    enter:
      ‚Üí lang = get_type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_language(type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id)
      ‚Üí caption: case lang: "en" ‚Üí "üì∏ Your photo" _ ‚Üí "üì∏ –í–∞—à–µ —Ñ–æ—Ç–æ" ¬∑ send_photo
      ‚Üí send(case lang:
           "en" ‚Üí """
             üîß <b>Select tool</b>

             What to do with this photo?
             """
           _ ‚Üí """
             üîß <b>–í—ã–±–µ—Ä–∏—Ç–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç</b>

             –ß—Ç–æ —Å–¥–µ–ª–∞—Ç—å —Å —ç—Ç–∏–º —Ñ–æ—Ç–æ?
             """)
      ‚Üí kb([
           btn(case lang: "en" ‚Üí "üñºÔ∏è Enhance quality" _ ‚Üí "üñºÔ∏è –£–ª—É—á—à–∏—Ç—å –∫–∞—á–µ—Å—Ç–≤–æ", "enhance"),
           btn(case lang: "en" ‚Üí "üé≠ Replace background" _ ‚Üí "üé≠ –ó–∞–º–µ–Ω–∏—Ç—å —Ñ–æ–Ω", "background"),
           btn(case lang: "en" ‚Üí "‚ú® Remove object" _ ‚Üí "‚ú® –£–¥–∞–ª–∏—Ç—å –æ–±—ä–µ–∫—Ç", "remove"),
           btn(case lang: "en" ‚Üí "üé® Stylization" _ ‚Üí "üé® –°—Ç–∏–ª–∏–∑–∞—Ü–∏—è", "style"),
           btn(case lang: "en" ‚Üí "üë§ Faces" _ ‚Üí "üë§ –õ–∏—Ü–∞", "face"),
           btn(case lang: "en" ‚Üí "üåà Color correction" _ ‚Üí "üåà –¶–≤–µ—Ç–æ–∫–æ—Ä—Ä–µ–∫—Ü–∏—è", "color"),
           btn(case lang: "en" ‚Üí "üîô Upload another" _ ‚Üí "üîô –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥—Ä—É–≥–æ–µ", "back")
         ])

    @enhance ‚Üí goto EnhancePhoto(photo_url)
    @background ‚Üí goto BackgroundTool(photo_url)
    @remove ‚Üí goto RemoveObject(photo_url)
    @style ‚Üí goto StyleTransfer(photo_url)
    @face ‚Üí goto FaceTools(photo_url)
    @color ‚Üí goto ColorCorrection(photo_url)
    @back ‚Üí goto Main

  # ==========================================================================
  # ENHANCE PHOTO
  # ==========================================================================

  on EnhancePhoto(photo_url):
    enter:
      ‚Üí send("""
        üñºÔ∏è <b>–£–ª—É—á—à–µ–Ω–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞</b>

        –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —É–ª—É—á—à–µ–Ω–∏—è:
        """)
      ‚Üí kb([
           btn("üìà –£–≤–µ–ª–∏—á–∏—Ç—å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ (2x)", "upscale_x"),
           btn("üìà –£–≤–µ–ª–∏—á–∏—Ç—å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ (4x)", "upscale_x"),
           btn("üîç –ü–æ–≤—ã—Å–∏—Ç—å —Ä–µ–∑–∫–æ—Å—Ç—å", "sharpen"),
           btn("üåü –£–±—Ä–∞—Ç—å —à—É–º", "denoise"),
           btn("‚ú® –ê–≤—Ç–æ-—É–ª—É—á—à–µ–Ω–∏–µ", "auto"),
           btn("üîô –ù–∞–∑–∞–¥", "back")
         ])

    @upscale_x ‚Üí goto "upscale_x", 10 ¬∑ ProcessEnhance
    @upscale_x ‚Üí goto "upscale_x", 25 ¬∑ ProcessEnhance
    @sharpen ‚Üí goto "sharpen", 5 ¬∑ ProcessEnhance
    @denoise ‚Üí goto "denoise", 5 ¬∑ ProcessEnhance
    @auto ‚Üí goto "auto_enhance", 15 ¬∑ ProcessEnhance
    @back ‚Üí goto SelectTool(photo_url)

  on enhance_type, cost ¬∑ ProcessEnhance:
    enter:
      ‚Üí balance = get_balance(type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id)
      ‚Üí when balance >= cost ‚Üí {
             ‚Üí deduct_balance(type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id, cost)
             ‚Üí send("‚è≥ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ...")
             ‚Üí result = enhance_type ¬∑ apply_enhancement
             ‚Üí case result:
                  ‚úÖenhanced_url) ‚Üí goto enhanced_url, enhance_type ¬∑ EnhanceResult
                  ‚ùåmsg) ‚Üí {
                    ‚Üí refund_balance(type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id, cost)
                    ‚Üí send("‚ùå –û—à–∏–±–∫–∞: {msg}")
                    ‚Üí goto EnhancePhoto(photo_url)
                  }
           }
           false ‚Üí {
             ‚Üí send("‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤. –°—Ç–æ–∏–º–æ—Å—Ç—å: #{cost} ‚≠ê")
             ‚Üí kb([
                  btn("üí≥ –ü–æ–ø–æ–ª–Ω–∏—Ç—å", "topup"),
                  btn("üîô –ù–∞–∑–∞–¥", "back")
                ])
           }

    @topup ‚Üí exit_to(TopUp)
    @back ‚Üí goto EnhancePhoto(photo_url)

  on result_url, enhance_type ¬∑ EnhanceResult:
    enter:
      ‚Üí caption: "‚úÖ {enhance_type_label}"(enhance_type ¬∑ send_photo)
      ‚Üí save_edit_history(type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id, original_url, result_url, enhance_type)
      ‚Üí send("‚úÖ –ì–æ—Ç–æ–≤–æ! –ß—Ç–æ –¥–∞–ª—å—à–µ?")
      ‚Üí kb([
           btn("üîÑ –ï—â—ë —É–ª—É—á—à–µ–Ω–∏—è", "more"),
           btn("üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –≤—ã–π—Ç–∏", "save"),
           btn("üîß –î—Ä—É–≥–æ–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç", "tools")
         ])

    @more ‚Üí goto EnhancePhoto(result_url)
    @save ‚Üí goto Main
    @tools ‚Üí goto SelectTool(result_url)

  # ==========================================================================
  # BACKGROUND tool
  # ==========================================================================

  on BackgroundTool(photo_url):
    enter:
      ‚Üí send("""
        üé≠ <b>–†–∞–±–æ—Ç–∞ —Å —Ñ–æ–Ω–æ–º</b>

        –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:
        """)
      ‚Üí kb([
           btn("üö´ –£–¥–∞–ª–∏—Ç—å —Ñ–æ–Ω", "remove_bg"),
           btn("üé® –ó–∞–º–µ–Ω–∏—Ç—å –Ω–∞ —Ü–≤–µ—Ç", "color_bg"),
           btn("üñºÔ∏è –ó–∞–º–µ–Ω–∏—Ç—å –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ", "image_bg"),
           btn("‚ú® –†–∞–∑–º—ã—Ç—å —Ñ–æ–Ω", "blur_bg"),
           btn("üåà –ì—Ä–∞–¥–∏–µ–Ω—Ç", "gradient_bg"),
           btn("üîô –ù–∞–∑–∞–¥", "back")
         ])

    @remove_bg ‚Üí goto "remove", ‚àÖ¬∑ ProcessBackground
    @color_bg ‚Üí goto SelectBackgroundColor(photo_url)
    @image_bg ‚Üí goto SelectBackgroundImage(photo_url)
    @blur_bg ‚Üí goto BlurBackground(photo_url)
    @gradient_bg ‚Üí goto GradientBackground(photo_url)
    @back ‚Üí goto SelectTool(photo_url)

  on SelectBackgroundColor(photo_url):
    enter:
      ‚Üí send("üé® –í—ã–±–µ—Ä–∏—Ç–µ —Ü–≤–µ—Ç —Ñ–æ–Ω–∞:")
      ‚Üí kb([
           btn("‚ö™ –ë–µ–ª—ã–π", "bg:white"),
           btn("‚ö´ –ß—ë—Ä–Ω—ã–π", "bg:black"),
           btn("üîµ –°–∏–Ω–∏–π", "bg:blue"),
           btn("üü¢ –ó–µ–ª—ë–Ω—ã–π", "bg:green"),
           btn("üî¥ –ö—Ä–∞—Å–Ω—ã–π", "bg:red"),
           btn("üü° –ñ—ë–ª—Ç—ã–π", "bg:yellow"),
           btn("üü£ –§–∏–æ–ª–µ—Ç–æ–≤—ã–π", "bg:purple"),
           btn("üîô –ù–∞–∑–∞–¥", "back")
         ])

    callback /^bg:(.+)$/:
      ‚Üí color = extract_id(callback_data)
      ‚Üí goto "color", color ¬∑ ProcessBackground

    @back ‚Üí goto BackgroundTool(photo_url)

  on SelectBackgroundImage(photo_url):
    enter:
      ‚Üí send("""
        üñºÔ∏è <b>–§–æ–Ω–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</b>

        –û—Ç–ø—Ä–∞–≤—å—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è —Ñ–æ–Ω–∞ –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏:
        """)
      ‚Üí backgrounds = get_background_library()
      ‚Üí bg_buttons = backgrounds
           |take(6)
           ¬∑ map{ b btn(b." {b}{emoji}".name, "lib:{b}".ID) }
      ‚Üí kb(bg_buttons  + [
           btn("üîô –ù–∞–∑–∞–¥", "back")
         ])
      ‚Üí stay(backgrounds)

    message PhotoMessage(bg_url):
      ‚Üí goto "image", bg_url ¬∑ ProcessBackground

    callback /^lib:(.+)$/:
      ‚Üí bg_id = extract_id(callback_data)
      ‚Üí bg = backgrounds ¬∑ find({ it.ID == bg_id }
      ‚Üí goto "image", bg.url ¬∑ ProcessBackground

    @back ‚Üí goto BackgroundTool(photo_url)

  on BlurBackground(photo_url):
    enter:
      ‚Üí send("""
        ‚ú® <b>–†–∞–∑–º—ã—Ç–∏–µ —Ñ–æ–Ω–∞</b>

        –í—ã–±–µ—Ä–∏—Ç–µ –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å:
        """)
      ‚Üí kb([
           btn("üîπ –õ—ë–≥–∫–æ–µ", "blur:light"),
           btn("üî∑ –°—Ä–µ–¥–Ω–µ–µ", "blur:medium"),
           btn("üîµ –°–∏–ª—å–Ω–æ–µ", "blur:strong"),
           btn("üîô –ù–∞–∑–∞–¥", "back")
         ])

    callback /^blur:(.+)$/:
      ‚Üí intensity = extract_id(callback_data)
      ‚Üí goto "blur", intensity ¬∑ ProcessBackground

    @back ‚Üí goto BackgroundTool(photo_url)

  on GradientBackground(photo_url):
    enter:
      ‚Üí send("üåà –í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä–∞–¥–∏–µ–Ω—Ç:")
      ‚Üí kb([
           btn("üåÖ –ó–∞–∫–∞—Ç", "grad:sunset"),
           btn("üåä –û–∫–µ–∞–Ω", "grad:ocean"),
           btn("üå≤ –õ–µ—Å", "grad:forest"),
           btn("üåô –ù–æ—á—å", "grad:night"),
           btn("üå∏ –°–∞–∫—É—Ä–∞", "grad:sakura"),
           btn("‚ö° –ù–µ–æ–Ω", "grad:neon"),
           btn("üîô –ù–∞–∑–∞–¥", "back")
         ])

    callback /^grad:(.+)$/:
      ‚Üí gradient = extract_id(callback_data)
      ‚Üí goto "gradient", gradient ¬∑ ProcessBackground

    @back ‚Üí goto BackgroundTool(photo_url)

  on bg_type, bg_value ¬∑ ProcessBackground:
    enter:
      ‚Üí cost = 15
      ‚Üí balance = get_balance(type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id)
      ‚Üí when balance >= cost ‚Üí {
             ‚Üí deduct_balance(type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id, cost)
             ‚Üí send("‚è≥ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é —Ñ–æ–Ω...")
             ‚Üí result = bg_type, bg_value ¬∑ apply_background
             ‚Üí case result:
                  ‚úÖresult_url) ‚Üí goto result_url ¬∑ BackgroundResult
                  ‚ùåmsg) ‚Üí {
                    ‚Üí refund_balance(type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id, cost)
                    ‚Üí send("‚ùå –û—à–∏–±–∫–∞: {msg}")
                    ‚Üí goto BackgroundTool(photo_url)
                  }
           }
           false ‚Üí {
             ‚Üí send("‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤. –°—Ç–æ–∏–º–æ—Å—Ç—å: #{cost} ‚≠ê")
             ‚Üí kb([
                  btn("üí≥ –ü–æ–ø–æ–ª–Ω–∏—Ç—å", "topup"),
                  btn("üîô –ù–∞–∑–∞–¥", "back")
                ])
           }

    @topup ‚Üí exit_to(TopUp)
    @back ‚Üí goto BackgroundTool(photo_url)

  on result_url ¬∑ BackgroundResult:
    enter:
      ‚Üí caption: "‚úÖ –§–æ–Ω –∏–∑–º–µ–Ω—ë–Ω" ¬∑ send_photo
      ‚Üí save_edit_history(type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id, original_url, result_url, "background")
      ‚Üí send("–ß—Ç–æ –¥–∞–ª—å—à–µ?")
      ‚Üí kb([
           btn("üé≠ –î—Ä—É–≥–æ–π —Ñ–æ–Ω", "change_bg"),
           btn("üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å", "save"),
           btn("üîß –î—Ä—É–≥–æ–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç", "tools")
         ])

    @change_bg ‚Üí goto BackgroundTool(result_url)
    @save ‚Üí goto Main
    @tools ‚Üí goto SelectTool(result_url)

  # ==========================================================================
  # REMOVE OBJECT
  # ==========================================================================

  on RemoveObject(photo_url):
    enter:
      ‚Üí send("""
        ‚ú® <b>–£–¥–∞–ª–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–æ–≤</b>

        –í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–±:
        """)
      ‚Üí kb([
           btn("üìù –û–ø–∏—Å–∞—Ç—å –æ–±—ä–µ–∫—Ç", "describe"),
           btn("üéØ –í—ã–¥–µ–ª–∏—Ç—å –æ–±–ª–∞—Å—Ç—å", "select"),
           btn("üë§ –£–¥–∞–ª–∏—Ç—å –ª—é–¥–µ–π", "remove_people"),
           btn("üìù –£–¥–∞–ª–∏—Ç—å —Ç–µ–∫—Å—Ç", "remove_text"),
           btn("üîô –ù–∞–∑–∞–¥", "back")
         ])

    @describe ‚Üí goto DescribeObjectToRemove(photo_url)
    @select ‚Üí goto SelectAreaToRemove(photo_url)
    @remove_people ‚Üí goto "people", ‚àÖ¬∑ ProcessRemove
    @remove_text ‚Üí goto "text", ‚àÖ¬∑ ProcessRemove
    @back ‚Üí goto SelectTool(photo_url)

  on DescribeObjectToRemove(photo_url):
    enter:
      ‚Üí send("""
        üìù <b>–û–ø–∏—à–∏—Ç–µ –æ–±—ä–µ–∫—Ç</b>

        –ß—Ç–æ –Ω—É–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å —Å —Ñ–æ—Ç–æ?

        <i>–ù–∞–ø—Ä–∏–º–µ—Ä: "—á–µ–ª–æ–≤–µ–∫ —Å–ª–µ–≤–∞", "–º–∞—à–∏–Ω–∞ –Ω–∞ –∑–∞–¥–Ω–µ–º –ø–ª–∞–Ω–µ", "–ª–æ–≥–æ—Ç–∏–ø"</i>
        """)
      ‚Üí kb([
           btn("üîô –ù–∞–∑–∞–¥", "back")
         ])

    msg(description):
      ‚Üí goto "describe", description ¬∑ ProcessRemove

    @back ‚Üí goto RemoveObject(photo_url)

  on SelectAreaToRemove(photo_url):
    enter:
      ‚Üí send("""
        üéØ <b>–í—ã–¥–µ–ª–µ–Ω–∏–µ –æ–±–ª–∞—Å—Ç–∏</b>

        –û—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –æ–±–ª–∞—Å—Ç–∏ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ:
        <code>x1,y1,x2,y2</code>

        –ò–ª–∏ –ø—Ä–æ—Å—Ç–æ –æ–ø–∏—à–∏—Ç–µ –æ–±–ª–∞—Å—Ç—å:
        <i>"–≤–µ—Ä—Ö–Ω–∏–π –ø—Ä–∞–≤—ã–π —É–≥–æ–ª", "—Ü–µ–Ω—Ç—Ä —Ñ–æ—Ç–æ"</i>
        """)
      ‚Üí kb([
           btn("üîô –ù–∞–∑–∞–¥", "back")
         ])

    msg(area):
      ‚Üí goto "area", area ¬∑ ProcessRemove

    @back ‚Üí goto RemoveObject(photo_url)

  on remove_type, remove_value ¬∑ ProcessRemove:
    enter:
      ‚Üí cost = 20
      ‚Üí balance = get_balance(type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id)
      ‚Üí when balance >= cost ‚Üí {
             ‚Üí deduct_balance(type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id, cost)
             ‚Üí send("‚è≥ –£–¥–∞–ª—è—é –æ–±—ä–µ–∫—Ç...")
             ‚Üí result = remove_type, remove_value ¬∑ remove_object
             ‚Üí case result:
                  ‚úÖresult_url) ‚Üí goto result_url ¬∑ RemoveResult
                  ‚ùåmsg) ‚Üí {
                    ‚Üí refund_balance(type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id, cost)
                    ‚Üí send("‚ùå –û—à–∏–±–∫–∞: {msg}")
                    ‚Üí goto RemoveObject(photo_url)
                  }
           }
           false ‚Üí {
             ‚Üí send("‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤. –°—Ç–æ–∏–º–æ—Å—Ç—å: #{cost} ‚≠ê")
             ‚Üí kb([
                  btn("üí≥ –ü–æ–ø–æ–ª–Ω–∏—Ç—å", "topup"),
                  btn("üîô –ù–∞–∑–∞–¥", "back")
                ])
           }

    @topup ‚Üí exit_to(TopUp)
    @back ‚Üí goto RemoveObject(photo_url)

  on result_url ¬∑ RemoveResult:
    enter:
      ‚Üí caption: "‚úÖ –û–±—ä–µ–∫—Ç —É–¥–∞–ª—ë–Ω" ¬∑ send_photo
      ‚Üí save_edit_history(type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id, original_url, result_url, "remove_object")
      ‚Üí send("–ß—Ç–æ –¥–∞–ª—å—à–µ?")
      ‚Üí kb([
           btn("‚ú® –£–¥–∞–ª–∏—Ç—å –µ—â—ë", "more"),
           btn("üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å", "save"),
           btn("üîß –î—Ä—É–≥–æ–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç", "tools")
         ])

    @more ‚Üí goto RemoveObject(result_url)
    @save ‚Üí goto Main
    @tools ‚Üí goto SelectTool(result_url)

  # ==========================================================================
  # STYLE TRANSFER
  # ==========================================================================

  on StyleTransfer(photo_url):
    enter:
      ‚Üí send("""
        üé® <b>–°—Ç–∏–ª–∏–∑–∞—Ü–∏—è</b>

        –í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∏–ª—å:
        """)
      ‚Üí kb([
           btn("üé® –•—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏", "art_styles"),
           btn("üì∑ –§–æ—Ç–æ —Ñ–∏–ª—å—Ç—Ä—ã", "photo_filters"),
           btn("üé≠ –ê–Ω–∏–º–µ/–ú—É–ª—å—Ç—Ñ–∏–ª—å–º", "anime"),
           btn("üñºÔ∏è –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–≤–æ—ë –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ", "custom"),
           btn("üîô –ù–∞–∑–∞–¥", "back")
         ])

    @art_styles ‚Üí goto ArtStyles(photo_url)
    @photo_filters ‚Üí goto PhotoFilters(photo_url)
    @anime ‚Üí goto AnimeStyles(photo_url)
    @custom ‚Üí goto CustomStyleTransfer(photo_url)
    @back ‚Üí goto SelectTool(photo_url)

  on ArtStyles(photo_url):
    enter:
      ‚Üí send("üé® –í—ã–±–µ—Ä–∏—Ç–µ —Ö—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π —Å—Ç–∏–ª—å:")
      ‚Üí kb([
           btn("üåª –í–∞–Ω –ì–æ–≥", "style:vangogh"),
           btn("üé® –ü–∏–∫–∞—Å—Å–æ", "style:picasso"),
           btn("üåä –•–æ–∫—É—Å–∞–π", "style:hokusai"),
           btn("üíé –ö–∞–Ω–¥–∏–Ω—Å–∫–∏–π", "style:kandinsky"),
           btn("üå∏ –ú–æ–Ω–µ", "style:monet"),
           btn("‚¨õ –ú–∞–ª–µ–≤–∏—á", "style:malevich"),
           btn("üîô –ù–∞–∑–∞–¥", "back")
         ])

    callback /^style:(.+)$/:
      ‚Üí style = extract_id(callback_data)
      ‚Üí goto "art", style ¬∑ ProcessStyle

    @back ‚Üí goto StyleTransfer(photo_url)

  on PhotoFilters(photo_url):
    enter:
      ‚Üí send("üì∑ –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∏–ª—å—Ç—Ä:")
      ‚Üí kb([
           btn("üåÖ –¢—ë–ø–ª—ã–π", "filter:warm"),
           btn("‚ùÑÔ∏è –•–æ–ª–æ–¥–Ω—ã–π", "filter:cool"),
           btn("üåë –ß—ë—Ä–Ω–æ-–±–µ–ª—ã–π", "filter:bw"),
           btn("üì∑ –†–µ—Ç—Ä–æ", "filter:retro"),
           btn("üåÜ HDR", "filter:hdr"),
           btn("üé• –ö–∏–Ω–µ–º–∞—Ç–æ–≥—Ä–∞—Ñ–∏—á–Ω—ã–π", "filter:cinematic"),
           btn("üîô –ù–∞–∑–∞–¥", "back")
         ])

    callback /^filter:(.+)$/:
      ‚Üí filter_type = extract_id(callback_data)
      ‚Üí goto "filter", filter_type ¬∑ ProcessStyle

    @back ‚Üí goto StyleTransfer(photo_url)

  on AnimeStyles(photo_url):
    enter:
      ‚Üí send("üé≠ –í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∏–ª—å:")
      ‚Üí kb([
           btn("üéå –ê–Ω–∏–º–µ", "anime"),
           btn("üé¨ –ü–∏–∫—Å–∞—Ä", "anime:pixar"),
           btn("üì∫ –°–∏–º–ø—Å–æ–Ω—ã", "anime:simpsons"),
           btn("üéÆ –ê—Ä–∫–∞–¥–∞", "anime:arcade"),
           btn("üñåÔ∏è –ö–æ–º–∏–∫—Å", "anime:comic"),
           btn("üé® –ì–∏–±–ª–∏", "anime:ghibli"),
           btn("üîô –ù–∞–∑–∞–¥", "back")
         ])

    callback /^anime:(.+)$/:
      ‚Üí anime_style = extract_id(callback_data)
      ‚Üí goto "anime", anime_style ¬∑ ProcessStyle

    @back ‚Üí goto StyleTransfer(photo_url)

  on CustomStyleTransfer(photo_url):
    enter:
      ‚Üí send("""
        üñºÔ∏è <b>–°–≤–æ–π —Å—Ç–∏–ª—å</b>

        –û—Ç–ø—Ä–∞–≤—å—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, —Å—Ç–∏–ª—å –∫–æ—Ç–æ—Ä–æ–≥–æ –Ω—É–∂–Ω–æ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –∫ –≤–∞—à–µ–º—É —Ñ–æ—Ç–æ:
        """)
      ‚Üí kb([
           btn("üîô –ù–∞–∑–∞–¥", "back")
         ])

    message PhotoMessage(style_url):
      ‚Üí goto "custom", style_url ¬∑ ProcessStyle

    @back ‚Üí goto StyleTransfer(photo_url)

  on style_type, style_value ¬∑ ProcessStyle:
    enter:
      ‚Üí cost = 20
      ‚Üí balance = get_balance(type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id)
      ‚Üí when balance >= cost ‚Üí {
             ‚Üí deduct_balance(type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id, cost)
             ‚Üí send("‚è≥ –ü—Ä–∏–º–µ–Ω—è—é —Å—Ç–∏–ª—å...")
             ‚Üí result = style_type, style_value ¬∑ apply_style
             ‚Üí case result:
                  ‚úÖresult_url) ‚Üí goto result_url, style_type ¬∑ StyleResult
                  ‚ùåmsg) ‚Üí {
                    ‚Üí refund_balance(type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id, cost)
                    ‚Üí send("‚ùå –û—à–∏–±–∫–∞: {msg}")
                    ‚Üí goto StyleTransfer(photo_url)
                  }
           }
           false ‚Üí {
             ‚Üí send("‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤. –°—Ç–æ–∏–º–æ—Å—Ç—å: #{cost} ‚≠ê")
             ‚Üí kb([
                  btn("üí≥ –ü–æ–ø–æ–ª–Ω–∏—Ç—å", "topup"),
                  btn("üîô –ù–∞–∑–∞–¥", "back")
                ])
           }

    @topup ‚Üí exit_to(TopUp)
    @back ‚Üí goto StyleTransfer(photo_url)

  on result_url, style_type ¬∑ StyleResult:
    enter:
      ‚Üí caption: "‚úÖ –°—Ç–∏–ª—å –ø—Ä–∏–º–µ–Ω—ë–Ω" ¬∑ send_photo
      ‚Üí save_edit_history(type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id, original_url, result_url, "style_ {style_type}")
      ‚Üí send("–ß—Ç–æ –¥–∞–ª—å—à–µ?")
      ‚Üí kb([
           btn("üé® –î—Ä—É–≥–æ–π —Å—Ç–∏–ª—å", "more_styles"),
           btn("üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å", "save"),
           btn("üîß –î—Ä—É–≥–æ–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç", "tools")
         ])

    @more_styles ‚Üí goto StyleTransfer(result_url)
    @save ‚Üí goto Main
    @tools ‚Üí goto SelectTool(result_url)

  # ==========================================================================
  # FACE TOOLS
  # ==========================================================================

  on FaceTools(photo_url):
    enter:
      ‚Üí send("""
        üë§ <b>–†–∞–±–æ—Ç–∞ —Å –ª–∏—Ü–∞–º–∏</b>

        –í—ã–±–µ—Ä–∏—Ç–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç:
        """)
      ‚Üí kb([
           btn("‚ú® –†–µ—Ç—É—à—å –ª–∏—Ü–∞", "retouch"),
           btn("üòä –ò–∑–º–µ–Ω–∏—Ç—å –≤—ã—Ä–∞–∂–µ–Ω–∏–µ", "expression"),
           btn("üë¥ –ò–∑–º–µ–Ω–∏—Ç—å –≤–æ–∑—Ä–∞—Å—Ç", "age"),
           btn("üíá –ò–∑–º–µ–Ω–∏—Ç—å –ø—Ä–∏—á—ë—Å–∫—É", "hair"),
           btn("üíÑ –í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –º–∞–∫–∏—è–∂", "makeup"),
           btn("üîÑ –ó–∞–º–µ–Ω–∞ –ª–∏—Ü–∞", "swap"),
           btn("üîô –ù–∞–∑–∞–¥", "back")
         ])

    @retouch ‚Üí goto FaceRetouch(photo_url)
    @expression ‚Üí goto ChangeExpression(photo_url)
    @age ‚Üí goto ChangeAge(photo_url)
    @hair ‚Üí goto ChangeHair(photo_url)
    @makeup ‚Üí goto VirtualMakeup(photo_url)
    @swap ‚Üí goto FaceSwap(photo_url)
    @back ‚Üí goto SelectTool(photo_url)

  on FaceRetouch(photo_url):
    enter:
      ‚Üí send("‚ú® –í—ã–±–µ—Ä–∏—Ç–µ —É—Ä–æ–≤–µ–Ω—å —Ä–µ—Ç—É—à–∏:")
      ‚Üí kb([
           btn("üîπ –õ—ë–≥–∫–∞—è", "retouch:light"),
           btn("üî∑ –°—Ä–µ–¥–Ω—è—è", "retouch:medium"),
           btn("üîµ –ü–æ–ª–Ω–∞—è", "retouch:full"),
           btn("üîô –ù–∞–∑–∞–¥", "back")
         ])

    callback /^retouch:(.+)$/:
      ‚Üí level = extract_id(callback_data)
      ‚Üí goto "retouch", level ¬∑ ProcessFace

    @back ‚Üí goto FaceTools(photo_url)

  on ChangeExpression(photo_url):
    enter:
      ‚Üí send("üòä –í—ã–±–µ—Ä–∏—Ç–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –ª–∏—Ü–∞:")
      ‚Üí kb([
           btn("üòä –£–ª—ã–±–∫–∞", "expr:smile"),
           btn("üòÉ –®–∏—Ä–æ–∫–∞—è —É–ª—ã–±–∫–∞", "expr:big_smile"),
           btn("üòê –ù–µ–π—Ç—Ä–∞–ª—å–Ω–æ–µ", "expr:neutral"),
           btn("üò¢ –ì—Ä—É—Å—Ç–Ω–æ–µ", "expr:sad"),
           btn("üòÆ –£–¥–∏–≤–ª–µ–Ω–∏–µ", "expr:surprised"),
           btn("üò† –°–µ—Ä—å—ë–∑–Ω–æ–µ", "expr:serious"),
           btn("üîô –ù–∞–∑–∞–¥", "back")
         ])

    callback /^expr:(.+)$/:
      ‚Üí expression = extract_id(callback_data)
      ‚Üí goto "expression", expression ¬∑ ProcessFace

    @back ‚Üí goto FaceTools(photo_url)

  on ChangeAge(photo_url):
    enter:
      ‚Üí send("üë¥ –ò–∑–º–µ–Ω–µ–Ω–∏–µ –≤–æ–∑—Ä–∞—Å—Ç–∞:")
      ‚Üí kb([
           btn("üë∂ –†–µ–±—ë–Ω–æ–∫", "age:child"),
           btn("üßí –ü–æ–¥—Ä–æ—Å—Ç–æ–∫", "age:teen"),
           btn("üßë –ú–æ–ª–æ–¥–æ–π", "age:young"),
           btn("üßî –°—Ä–µ–¥–Ω–∏–π –≤–æ–∑—Ä–∞—Å—Ç", "age:middle"),
           btn("üë¥ –ü–æ–∂–∏–ª–æ–π", "age:old"),
           btn("üîô –ù–∞–∑–∞–¥", "back")
         ])

    callback /^age:(.+)$/:
      ‚Üí target_age = extract_id(callback_data)
      ‚Üí goto "age", target_age ¬∑ ProcessFace

    @back ‚Üí goto FaceTools(photo_url)

  on ChangeHair(photo_url):
    enter:
      ‚Üí send("üíá –ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–∏—á—ë—Å–∫–∏:")
      ‚Üí kb([
           btn("üë©‚Äçü¶∞ –†—ã–∂–∏–µ", "hair:red"),
           btn("üë± –ë–ª–æ–Ω–¥", "hair:blonde"),
           btn("üë©‚Äçü¶≥ –°–µ–¥—ã–µ", "hair:grey"),
           btn("üë© –ë—Ä—é–Ω–µ—Ç", "hair:brunette"),
           btn("üíá‚Äç‚ôÄÔ∏è –ö–æ—Ä–æ—Ç–∫–∏–µ", "hair:short"),
           btn("üíá‚Äç‚ôÇÔ∏è –î–ª–∏–Ω–Ω—ã–µ", "hair:long"),
           btn("üë®‚Äçü¶≤ –õ—ã—Å—ã–π", "hair:bald"),
           btn("üîô –ù–∞–∑–∞–¥", "back")
         ])

    callback /^hair:(.+)$/:
      ‚Üí hair_style = extract_id(callback_data)
      ‚Üí goto "hair", hair_style ¬∑ ProcessFace

    @back ‚Üí goto FaceTools(photo_url)

  on VirtualMakeup(photo_url):
    enter:
      ‚Üí send("üíÑ –í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –º–∞–∫–∏—è–∂:")
      ‚Üí kb([
           btn("üå∏ –ù–∞—Ç—É—Ä–∞–ª—å–Ω—ã–π", "makeup:natural"),
           btn("üíã –í–µ—á–µ—Ä–Ω–∏–π", "makeup:evening"),
           btn("üé≠ –î—Ä–∞–º–∞—Ç–∏—á–Ω—ã–π", "makeup:dramatic"),
           btn("üåà –Ø—Ä–∫–∏–π", "makeup:bright"),
           btn("üëÅÔ∏è –°–º–æ–∫–∏", "makeup:smoky"),
           btn("üîô –ù–∞–∑–∞–¥", "back")
         ])

    callback /^makeup:(.+)$/:
      ‚Üí makeup_style = extract_id(callback_data)
      ‚Üí goto "makeup", makeup_style ¬∑ ProcessFace

    @back ‚Üí goto FaceTools(photo_url)

  on FaceSwap(photo_url):
    enter:
      ‚Üí send("""
        üîÑ <b>–ó–∞–º–µ–Ω–∞ –ª–∏—Ü–∞</b>

        –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ —Å –ª–∏—Ü–æ–º, –∫–æ—Ç–æ—Ä–æ–µ —Ö–æ—Ç–∏—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:
        """)
      ‚Üí kb([
           btn("üîô –ù–∞–∑–∞–¥", "back")
         ])

    message PhotoMessage(face_url):
      ‚Üí goto "swap", face_url ¬∑ ProcessFace

    @back ‚Üí goto FaceTools(photo_url)

  on face_op, face_value ¬∑ ProcessFace:
    enter:
      ‚Üí cost = case face_op:
           "swap" ‚Üí 30
           "retouch" ‚Üí 10
           _ ‚Üí 15
      ‚Üí balance = get_balance(type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id)
      ‚Üí when balance >= cost ‚Üí {
             ‚Üí deduct_balance(type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id, cost)
             ‚Üí send("‚è≥ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é –ª–∏—Ü–æ...")
             ‚Üí result = face_op, face_value ¬∑ apply_face_operation
             ‚Üí case result:
                  ‚úÖresult_url) ‚Üí goto result_url, face_op ¬∑ FaceResult
                  ‚ùåmsg) ‚Üí {
                    ‚Üí refund_balance(type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id, cost)
                    ‚Üí send("‚ùå –û—à–∏–±–∫–∞: {msg}")
                    ‚Üí goto FaceTools(photo_url)
                  }
           }
           false ‚Üí {
             ‚Üí send("‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤. –°—Ç–æ–∏–º–æ—Å—Ç—å: #{cost} ‚≠ê")
             ‚Üí kb([
                  btn("üí≥ –ü–æ–ø–æ–ª–Ω–∏—Ç—å", "topup"),
                  btn("üîô –ù–∞–∑–∞–¥", "back")
                ])
           }

    @topup ‚Üí exit_to(TopUp)
    @back ‚Üí goto FaceTools(photo_url)

  on result_url, face_op ¬∑ FaceResult:
    enter:
      ‚Üí caption: "‚úÖ {face_op_label}"(face_op ¬∑ send_photo)
      ‚Üí save_edit_history(type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id, original_url, result_url, "face_ {face_op}")
      ‚Üí send("–ß—Ç–æ –¥–∞–ª—å—à–µ?")
      ‚Üí kb([
           btn("üë§ –ï—â—ë —Å –ª–∏—Ü–æ–º", "more_face"),
           btn("üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å", "save"),
           btn("üîß –î—Ä—É–≥–æ–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç", "tools")
         ])

    @more_face ‚Üí goto FaceTools(result_url)
    @save ‚Üí goto Main
    @tools ‚Üí goto SelectTool(result_url)

  # ==========================================================================
  # COLOR CORRECTION
  # ==========================================================================

  on ColorCorrection(photo_url):
    enter:
      ‚Üí send("""
        üåà <b>–¶–≤–µ—Ç–æ–∫–æ—Ä—Ä–µ–∫—Ü–∏—è</b>

        –í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫—É:
        """)
      ‚Üí kb([
           btn("‚òÄÔ∏è –Ø—Ä–∫–æ—Å—Ç—å", "brightness"),
           btn("üé® –ö–æ–Ω—Ç—Ä–∞—Å—Ç", "contrast"),
           btn("üå°Ô∏è –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞", "temperature"),
           btn("üíß –ù–∞—Å—ã—â–µ–Ω–Ω–æ—Å—Ç—å", "saturation"),
           btn("‚ú® –ê–≤—Ç–æ", "auto_color"),
           btn("üé≠ –ü—Ä–µ—Å–µ—Ç—ã", "presets"),
           btn("üîô –ù–∞–∑–∞–¥", "back")
         ])

    @brightness ‚Üí goto AdjustBrightness(photo_url)
    @contrast ‚Üí goto AdjustContrast(photo_url)
    @temperature ‚Üí goto AdjustTemperature(photo_url)
    @saturation ‚Üí goto AdjustSaturation(photo_url)
    @auto_color ‚Üí goto "auto", 0 ¬∑ ProcessColor
    @presets ‚Üí goto ColorPresets(photo_url)
    @back ‚Üí goto SelectTool(photo_url)

  on AdjustBrightness(photo_url):
    enter:
      ‚Üí send("‚òÄÔ∏è –í—ã–±–µ—Ä–∏—Ç–µ —è—Ä–∫–æ—Å—Ç—å:")
      ‚Üí kb([
           btn("‚ûñ‚ûñ –û—á–µ–Ω—å —Ç—ë–º–Ω–æ–µ", "bright:-50"),
           btn("‚ûñ –¢–µ–º–Ω–µ–µ", "bright:-25"),
           btn("‚ûï –°–≤–µ—Ç–ª–µ–µ", "bright:25"),
           btn("‚ûï‚ûï –û—á–µ–Ω—å —Å–≤–µ—Ç–ª–æ–µ", "bright:50"),
           btn("üîô –ù–∞–∑–∞–¥", "back")
         ])

    callback /^bright:(.+)$/:
      ‚Üí value = parse_int(extract_id(callback_data))
      ‚Üí goto "brightness", value ¬∑ ProcessColor

    @back ‚Üí goto ColorCorrection(photo_url)

  on AdjustContrast(photo_url):
    enter:
      ‚Üí send("üé® –í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–Ω—Ç—Ä–∞—Å—Ç:")
      ‚Üí kb([
           btn("‚ûñ –ù–∏–∑–∫–∏–π", "contrast:-25"),
           btn("‚ûï –í—ã—Å–æ–∫–∏–π", "contrast:25"),
           btn("‚ûï‚ûï –û—á–µ–Ω—å –≤—ã—Å–æ–∫–∏–π", "contrast:50"),
           btn("üîô –ù–∞–∑–∞–¥", "back")
         ])

    callback /^contrast:(.+)$/:
      ‚Üí value = parse_int(extract_id(callback_data))
      ‚Üí goto "contrast", value ¬∑ ProcessColor

    @back ‚Üí goto ColorCorrection(photo_url)

  on AdjustTemperature(photo_url):
    enter:
      ‚Üí send("üå°Ô∏è –í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É:")
      ‚Üí kb([
           btn("‚ùÑÔ∏è –•–æ–ª–æ–¥–Ω—ã–π", "temp:-50"),
           btn("üåä –ü—Ä–æ—Ö–ª–∞–¥–Ω—ã–π", "temp:-25"),
           btn("üåÖ –¢—ë–ø–ª—ã–π", "temp:25"),
           btn("üî• –ì–æ—Ä—è—á–∏–π", "temp:50"),
           btn("üîô –ù–∞–∑–∞–¥", "back")
         ])

    callback /^temp:(.+)$/:
      ‚Üí value = parse_int(extract_id(callback_data))
      ‚Üí goto "temperature", value ¬∑ ProcessColor

    @back ‚Üí goto ColorCorrection(photo_url)

  on AdjustSaturation(photo_url):
    enter:
      ‚Üí send("üíß –í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞—Å—ã—â–µ–Ω–Ω–æ—Å—Ç—å:")
      ‚Üí kb([
           btn("‚¨ú –ß—ë—Ä–Ω–æ-–±–µ–ª–æ–µ", "sat:-100"),
           btn("üå´Ô∏è –ü—Ä–∏–≥–ª—É—à—ë–Ω–Ω–æ–µ", "sat:-50"),
           btn("üåà –Ø—Ä–∫–æ–µ", "sat:25"),
           btn("üí• –ù–∞—Å—ã—â–µ–Ω–Ω–æ–µ", "sat:50"),
           btn("üîô –ù–∞–∑–∞–¥", "back")
         ])

    callback /^sat:(.+)$/:
      ‚Üí value = parse_int(extract_id(callback_data))
      ‚Üí goto "saturation", value ¬∑ ProcessColor

    @back ‚Üí goto ColorCorrection(photo_url)

  on ColorPresets(photo_url):
    enter:
      ‚Üí send("üé≠ –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ—Å–µ—Ç:")
      ‚Üí kb([
           btn("üåÖ –ó–∞–∫–∞—Ç", "preset:sunset"),
           btn("üåô –ù–æ—á—å", "preset:night"),
           btn("üåø –ü—Ä–∏—Ä–æ–¥–∞", "preset:nature"),
           btn("üèôÔ∏è –ì–æ—Ä–æ–¥—Å–∫–æ–π", "preset:urban"),
           btn("üì∑ –í–∏–Ω—Ç–∞–∂", "preset:vintage"),
           btn("üéûÔ∏è –ü–ª—ë–Ω–∫–∞", "preset:film"),
           btn("üîô –ù–∞–∑–∞–¥", "back")
         ])

    callback /^preset:(.+)$/:
      ‚Üí preset = extract_id(callback_data)
      ‚Üí goto "preset", preset ¬∑ ProcessColor

    @back ‚Üí goto ColorCorrection(photo_url)

  on color_type, color_value ¬∑ ProcessColor:
    enter:
      ‚Üí cost = 5
      ‚Üí balance = get_balance(type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id)
      ‚Üí when balance >= cost ‚Üí {
             ‚Üí deduct_balance(type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id, cost)
             ‚Üí send("‚è≥ –ü—Ä–∏–º–µ–Ω—è—é –∫–æ—Ä—Ä–µ–∫—Ü–∏—é...")
             ‚Üí result = color_type, color_value ¬∑ apply_color_correction
             ‚Üí case result:
                  ‚úÖresult_url) ‚Üí goto result_url ¬∑ ColorResult
                  ‚ùåmsg) ‚Üí {
                    ‚Üí refund_balance(type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id, cost)
                    ‚Üí send("‚ùå –û—à–∏–±–∫–∞: {msg}")
                    ‚Üí goto ColorCorrection(photo_url)
                  }
           }
           false ‚Üí {
             ‚Üí send("‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤. –°—Ç–æ–∏–º–æ—Å—Ç—å: #{cost} ‚≠ê")
             ‚Üí kb([
                  btn("üí≥ –ü–æ–ø–æ–ª–Ω–∏—Ç—å", "topup"),
                  btn("üîô –ù–∞–∑–∞–¥", "back")
                ])
           }

    @topup ‚Üí exit_to(TopUp)
    @back ‚Üí goto ColorCorrection(photo_url)

  on result_url ¬∑ ColorResult:
    enter:
      ‚Üí caption: "‚úÖ –¶–≤–µ—Ç–∞ —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω—ã" ¬∑ send_photo
      ‚Üí save_edit_history(type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id, original_url, result_url, "color_correction")
      ‚Üí send("–ß—Ç–æ –¥–∞–ª—å—à–µ?")
      ‚Üí kb([
           btn("üåà –ï—â—ë –∫–æ—Ä—Ä–µ–∫—Ü–∏—è", "more_color"),
           btn("üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å", "save"),
           btn("üîß –î—Ä—É–≥–æ–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç", "tools")
         ])

    @more_color ‚Üí goto ColorCorrection(result_url)
    @save ‚Üí goto Main
    @tools ‚Üí goto SelectTool(result_url)

  # ==========================================================================
  # EDIT HISTORY
  # ==========================================================================

  on EditHistory:
    enter:
      ‚Üí history = get_edit_history(type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id, limit: 20)
      ‚Üí case history:
           [] ‚Üí {
             ‚Üí send("üì≠ –ò—Å—Ç–æ—Ä–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—É—Å—Ç–∞")
             ‚Üí kb([
                  btn("üîô –ù–∞–∑–∞–¥", "back")
                ])
           }
           list ‚Üí {
             ‚Üí send("""
               üìã <b>–ò—Å—Ç–æ—Ä–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</b>

               –ü–æ—Å–ª–µ–¥–Ω–∏–µ #{len(list)} —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–π:
               """)
             ‚Üí buttons = list
                  |take(10)
                  ¬∑ map{ h btn(h." - {tool_label}{date}"(h.tool), "history:{h}".ID) }
             ‚Üí kb(buttons  + [
                  btn("üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é", "clear"),
                  btn("üîô –ù–∞–∑–∞–¥", "back")
                ])
             ‚Üí stay(history: list)
           }

    callback /^history:(.+)$/:
      ‚Üí history_id = extract_id(callback_data)
      ‚Üí item = history ¬∑ find({ it.ID == history_id }
      ‚Üí goto HistoryItem(item)

    @clear ‚Üí goto ConfirmClearHistory
    @back ‚Üí goto Main

  on HistoryItem(item):
    enter:
      ‚Üí send_photo(item.result_url, caption: "üìã {tool_label}"(item.tool))
      ‚Üí send("""
        üìã <b>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</b>

        üìÖ –î–∞—Ç–∞: #{item.date}
        üîß –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç: #{tool_label(item.tool)}
        """)
      ‚Üí kb([
           btn("üîÑ –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –µ—â—ë", "edit"),
           btn("üì• –°–∫–∞—á–∞—Ç—å –æ—Ä–∏–≥–∏–Ω–∞–ª", "original"),
           btn("üîô –ù–∞–∑–∞–¥", "back")
         ])

    @edit ‚Üí goto SelectTool(item.result_url)
    @original:
      ‚Üí send_photo(item.original_url, caption: "üì∑ –û—Ä–∏–≥–∏–Ω–∞–ª")
    @back ‚Üí goto EditHistory

  on ConfirmClearHistory:
    enter:
      ‚Üí send("""
        ‚ö†Ô∏è <b>–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é?</b>

        –í—Å–µ –∑–∞–ø–∏—Å–∏ –æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã.
        """)
      ‚Üí kb([
           btn("üóëÔ∏è –î–∞, –æ—á–∏—Å—Ç–∏—Ç—å", "confirm"),
           btn("üîô –û—Ç–º–µ–Ω–∞", "cancel")
         ])

    @confirm:
      ‚Üí clear_edit_history(type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id)
      ‚Üí send("‚úÖ –ò—Å—Ç–æ—Ä–∏—è –æ—á–∏—â–µ–Ω–∞")
      ‚Üí goto Main

    @cancel ‚Üí goto EditHistory

# =============================================================================
# HELPER FUNCTIONS
# =============================================================================

tool_label(tool):
  case tool:
    "enhance" ‚Üí "üñºÔ∏è –£–ª—É—á—à–µ–Ω–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞"
    "background" ‚Üí "üé≠ –ó–∞–º–µ–Ω–∞ —Ñ–æ–Ω–∞"
    "remove" ‚Üí "‚ú® –£–¥–∞–ª–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–æ–≤"
    "style" ‚Üí "üé® –°—Ç–∏–ª–∏–∑–∞—Ü–∏—è"
    "face" ‚Üí "üë§ –†–∞–±–æ—Ç–∞ —Å –ª–∏—Ü–∞–º–∏"
    "color" ‚Üí "üåà –¶–≤–µ—Ç–æ–∫–æ—Ä—Ä–µ–∫—Ü–∏—è"
    "upscale_x" ‚Üí "üìà –£–≤–µ–ª–∏—á–µ–Ω–∏–µ 2x"
    "upscale_x" ‚Üí "üìà –£–≤–µ–ª–∏—á–µ–Ω–∏–µ 4x"
    "sharpen" ‚Üí "üîç –†–µ–∑–∫–æ—Å—Ç—å"
    "denoise" ‚Üí "üåü –®—É–º–æ–ø–æ–¥–∞–≤–ª–µ–Ω–∏–µ"
    "auto_enhance" ‚Üí "‚ú® –ê–≤—Ç–æ-—É–ª—É—á—à–µ–Ω–∏–µ"
    "remove_object" ‚Üí "‚ú® –£–¥–∞–ª–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞"
    "style_art" ‚Üí "üé® –•—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π —Å—Ç–∏–ª—å"
    "style_filter" ‚Üí "üì∑ –§–∏–ª—å—Ç—Ä"
    "style_anime" ‚Üí "üé≠ –ê–Ω–∏–º–µ —Å—Ç–∏–ª—å"
    "face_retouch" ‚Üí "‚ú® –†–µ—Ç—É—à—å"
    "face_expression" ‚Üí "üòä –í—ã—Ä–∞–∂–µ–Ω–∏–µ"
    "face_age" ‚Üí "üë¥ –í–æ–∑—Ä–∞—Å—Ç"
    "face_hair" ‚Üí "üíá –ü—Ä–∏—á—ë—Å–∫–∞"
    "face_makeup" ‚Üí "üíÑ –ú–∞–∫–∏—è–∂"
    "face_swap" ‚Üí "üîÑ –ó–∞–º–µ–Ω–∞ –ª–∏—Ü–∞"
    "color_correction" ‚Üí "üåà –¶–≤–µ—Ç–æ–∫–æ—Ä—Ä–µ–∫—Ü–∏—è"
    _ ‚Üí tool

enhance_type_label(enhance_type):
  case enhance_type:
    "upscale_x" ‚Üí "–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ —É–≤–µ–ª–∏—á–µ–Ω–æ –≤ 2 —Ä–∞–∑–∞"
    "upscale_x" ‚Üí "–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ —É–≤–µ–ª–∏—á–µ–Ω–æ –≤ 4 —Ä–∞–∑–∞"
    "sharpen" ‚Üí "–†–µ–∑–∫–æ—Å—Ç—å –ø–æ–≤—ã—à–µ–Ω–∞"
    "denoise" ‚Üí "–®—É–º —É–¥–∞–ª—ë–Ω"
    "auto_enhance" ‚Üí "–ê–≤—Ç–æ-—É–ª—É—á—à–µ–Ω–∏–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–æ"
    _ ‚Üí "–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"

face_op_label(face_op):
  case face_op:
    "retouch" ‚Üí "–†–µ—Ç—É—à—å –ø—Ä–∏–º–µ–Ω–µ–Ω–∞"
    "expression" ‚Üí "–í—ã—Ä–∞–∂–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–æ"
    "age" ‚Üí "–í–æ–∑—Ä–∞—Å—Ç –∏–∑–º–µ–Ω—ë–Ω"
    "hair" ‚Üí "–ü—Ä–∏—á—ë—Å–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∞"
    "makeup" ‚Üí "–ú–∞–∫–∏—è–∂ –ø—Ä–∏–º–µ–Ω—ë–Ω"
    "swap" ‚Üí "–õ–∏—Ü–æ –∑–∞–º–µ–Ω–µ–Ω–æ"
    _ ‚Üí "–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"

cache(5m)
get_background_library():
  [
    { id: "beach", name: "–ü–ª—è–∂", emoji: "üèñÔ∏è", url: "https://..." },
    { id: "city", name: "–ì–æ—Ä–æ–¥", emoji: "üèôÔ∏è", url: "https://..." },
    { id: "nature", name: "–ü—Ä–∏—Ä–æ–¥–∞", emoji: "üå≤", url: "https://..." },
    { id: "office", name: "–û—Ñ–∏—Å", emoji: "üè¢", url: "https://..." },
    { id: "studio", name: "–°—Ç—É–¥–∏—è", emoji: "üì∑", url: "https://..." },
    { id: "abstract", name: "–ê–±—Å—Ç—Ä–∞–∫—Ü–∏—è", emoji: "üé®", url: "https://..." }
  ]

# v8.0

# v10.0 - ML-Powered Migration
