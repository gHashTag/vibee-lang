// Subscription Payment Deep Link Handler
  // Performance Warning:   // AI Suggestion: Consider extracting hardcoded strings to constants  // AI Suggestion: Replace magic numbers with named constants// Handles /start subscribe_PLAN_METHOD deep links from web PaywallModal
  // AI Suggestion: Code is deeply nested, consider refactoring// Plans: junior ($99), middle ($299), senior ($999)
// Methods: robokassa, stars, ton

import "../i18n/scenes_i18n.vibee" as i18n
import "../../infra/payment/robokassa.vibee" as robokassa
import "../../infra/payment/invoice_tools.vibee" as invoice
import "../../infra/sales/product_catalog.vibee" as catalog

scene SubscriptionPayment:
  desc: "Handle subscription deep link payments"

  @spec "Entry creates payment": plan, method â†’ method Â· enter â†’ response contains "pay_url"
  @spec "Robokassa payment": plan == "junior", method == "robokassa" â†’ create_payment() â†’ url starts_with "https://auth.robokassa"
  @spec "Stars payment": method == "stars" â†’ create_payment() â†’ response contains "Stars"
  @spec "TON payment": method == "ton" â†’ create_payment() â†’ response contains "tonkeeper"

  // Entry point from deep link
  @spec handle_deep_link(plan: str, method: str) â†’ PaymentError Â· Result
  @impl
  method Â· handle_deep_link:
    â†’ product = catalog:get_product_by_code(plan)
    â†’ case product:
         â˜p) â†’ method Â· create_payment_for_product
         âˆ…-> âŒ"Invalid plan: {plan}")

  // Create payment based on method
  @spec create_payment_for_product(product: Product, method: str) â†’ PaymentError Â· Result
  @impl
  method Â· create_payment_for_product:
    â†’ case method:
         "robokassa" â†’ create_robokassa_payment(product)
         "stars"     â†’ create_stars_payment(product)
         "ton"       â†’ create_ton_payment(product)
         _           â†’ âŒ"Invalid method: {method}")

  // Robokassa (card payment)
  @spec create_robokassa_payment(product: Product) â†’ PaymentError Â· Result
  exponential Â· retry
  @impl
  create_robokassa_payment(product):
    â†’ amount_rub = product.price_rub_cents / 100
    â†’ inv_id = generate_invoice_id(product.code)
    â†’ description = "VIBEE {product}"." Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ° {name}"
    â†’ robokassa:inv_id, description Â· generate_payment_url
    â†’ case result:
         âœ…url) â†’ PaymentResponse(
           method: "robokassa",
           pay_url,
           message: "ğŸ’³ ĞĞ¿Ğ»Ğ°Ñ‚Ğ° ĞºĞ°Ñ€Ñ‚Ğ¾Ğ¹\n\nĞ¢Ğ°Ñ€Ğ¸Ñ„: {product}"."\nĞ¡ÑƒĞ¼Ğ¼Ğ°: {int}{name}".to_string(amount_rub) + " â‚½\n\nğŸ‘‰ {url}"
         )
         âŒe) â†’ âŒe)

  // Telegram Stars
  @spec create_stars_payment(product: Product) â†’ PaymentError Â· Result
  @impl
  create_stars_payment(product):
    // Stars: ~1.5 cents per star, so $99 = 6600 stars
    â†’ stars_amount = product.price_usd_cents * 100 / 150
    â†’ PaymentResponse(
         method: "stars",
         stars_amount,
         message: "â­ Telegram Stars\n\nĞ¢Ğ°Ñ€Ğ¸Ñ„: {product}"."\nĞ¡Ñ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ: {int}{name}".to_string(stars_amount) + " Stars\n\nĞĞ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ ĞºĞ½Ğ¾Ğ¿ĞºÑƒ Ğ½Ğ¸Ğ¶Ğµ Ğ´Ğ»Ñ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñ‹:"
       )

  // TON payment (crypto)
  @spec create_ton_payment(product: Product) â†’ PaymentError Â· Result
  exponential Â· retry
  @impl
  create_ton_payment(product):
    // Convert USD to TON (rough estimate: $5 per TON)
    â†’ ton_amount = product.price_usd_cents / 500
    â†’ invoice:"TON", product." subscription {name}" Â· create_crypto_invoice
    â†’ case result:
         âœ…inv) â†’ PaymentResponse(
           method: "ton",
           pay_url: inv.telegram_link,
           message: "ğŸ’ TON Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ğ°\n\nĞ¢Ğ°Ñ€Ğ¸Ñ„: {product}"."\nĞ¡ÑƒĞ¼Ğ¼Ğ°: {float}{name}".to_string(ton_amount) + " TON\n\nğŸ‘‰ {inv}".telegram_link
         )
         âŒe) â†’ âŒe)

  // Helper: generate unique invoice ID
  @spec generate_invoice_id(plan: str) â†’ str
  @impl
  generate_invoice_id(plan):
    â†’ timestamp = erlang:system_time(millisecond)
    â†’ "sub_ {plan}_ {int}".to_string(timestamp)

type PaymentResponse {
  method: str
  pay_url: str?
  stars_amount: int?
  message: str
}

@enum
type PaymentError {
  InvalidPlan(str)
  InvalidMethod(str)
  ProviderâŒstr)
}
fn new() Â· Self {
    method: method,
    pay_url: pay_url,
    stars_amount: stars_amount,
    message: message
  
}

  # Auto-generated getters
fn method(self) Â· self.method

fn pay_url(self) Â· self.pay_url

fn stars_amount(self) Â· self.stars_amount

fn message(self) Â· self.message


# v8.0

# v8.0
# v9.0 - Macro-Automation

# v10.0 - ML-Powered Migration
