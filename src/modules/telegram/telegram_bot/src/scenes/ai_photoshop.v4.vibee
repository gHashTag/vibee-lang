# AI Photoshop Scene
  // AI Suggestion: Consider extracting hardcoded strings to constants  // AI Suggestion: Replace magic numbers with named constants# Comprehensive AI-powered photo editing
  // Performance Warning:   // AI Suggestion: Code is deeply nested, consider refactoring# Based on 999-multibots-telegraf aiPhotoshopScene

import "../i18n/scenes_i18n.vibee" as i18n

scene AIPhotoshop:
  desc: "AI-powered photo editing with multiple tools"

  @spec "Photo edited": image uploaded ‚Üí tool applied ‚Üí result returned
  @spec "Style transferred": source + style ‚Üí stylized image

  on Main:
    enter:
      ‚Üí lang = get_type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_language(type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id)
      ‚Üí reply(case lang:
           "en" ‚Üí """
             üé® <b>AI Photoshop</b>

             Edit photos with AI:

             ‚Ä¢ üñºÔ∏è Quality enhancement
             ‚Ä¢ üé≠ Background replacement
             ‚Ä¢ ‚ú® Object removal
             ‚Ä¢ üé® Stylization
             ‚Ä¢ üë§ Face editing
             ‚Ä¢ üåà Color correction

             Send a photo to edit or select a tool:
             """
           _ ‚Üí """
             üé® <b>AI Photoshop</b>

             –†–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ —Ñ–æ—Ç–æ —Å –ø–æ–º–æ—â—å—é AI:

             ‚Ä¢ üñºÔ∏è –£–ª—É—á—à–µ–Ω–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞
             ‚Ä¢ üé≠ –ó–∞–º–µ–Ω–∞ —Ñ–æ–Ω–∞
             ‚Ä¢ ‚ú® –£–¥–∞–ª–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–æ–≤
             ‚Ä¢ üé® –°—Ç–∏–ª–∏–∑–∞—Ü–∏—è
             ‚Ä¢ üë§ –†–∞–±–æ—Ç–∞ —Å –ª–∏—Ü–∞–º–∏
             ‚Ä¢ üåà –¶–≤–µ—Ç–æ–∫–æ—Ä—Ä–µ–∫—Ü–∏—è

             –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç:
             """)
      ‚Üí show_keyboard([
           button(case lang: "en" ‚Üí "üñºÔ∏è Enhance quality" _ ‚Üí "üñºÔ∏è –£–ª—É—á—à–∏—Ç—å –∫–∞—á–µ—Å—Ç–≤–æ", "enhance"),
           button(case lang: "en" ‚Üí "üé≠ Replace background" _ ‚Üí "üé≠ –ó–∞–º–µ–Ω–∏—Ç—å —Ñ–æ–Ω", "background"),
           button(case lang: "en" ‚Üí "‚ú® Remove object" _ ‚Üí "‚ú® –£–¥–∞–ª–∏—Ç—å –æ–±—ä–µ–∫—Ç", "remove"),
           button(case lang: "en" ‚Üí "üé® Stylization" _ ‚Üí "üé® –°—Ç–∏–ª–∏–∑–∞—Ü–∏—è", "style"),
           button(case lang: "en" ‚Üí "üë§ Faces" _ ‚Üí "üë§ –õ–∏—Ü–∞", "face"),
           button(case lang: "en" ‚Üí "üåà Color correction" _ ‚Üí "üåà –¶–≤–µ—Ç–æ–∫–æ—Ä—Ä–µ–∫—Ü–∏—è", "color"),
           button(case lang: "en" ‚Üí "üìã History" _ ‚Üí "üìã –ò—Å—Ç–æ—Ä–∏—è", "history"),
           button("common", "menu" ¬∑ t, "menu")
         ])

    message PhotoMessage(photo_url):
      ‚Üí transition SelectTool(photo_url)

    callback "enhance" ‚Üí transition UploadForTool("enhance")
    callback "background" ‚Üí transition UploadForTool("background")
    callback "remove" ‚Üí transition UploadForTool("remove")
    callback "style" ‚Üí transition UploadForTool("style")
    callback "face" ‚Üí transition UploadForTool("face")
    callback "color" ‚Üí transition UploadForTool("color")
    callback "history" ‚Üí transition EditHistory
    callback "menu" ‚Üí exit(Idle)

  on UploadForTool(tool):
    enter:
      ‚Üí lang = get_type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_language(type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id)
      ‚Üí reply(case lang:
           "en" ‚Üí """
             üì∏ <b>Upload photo</b>

             Send a photo for tool: #{tool_label(tool)}
             """
           _ ‚Üí """
             üì∏ <b>–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ</b>

             –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ –¥–ª—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞: #{tool_label(tool)}
             """)
      ‚Üí show_keyboard([
           button("common", "back" ¬∑ t, "back")
         ])

    message PhotoMessage(photo_url):
      ‚Üí case tool:
           "enhance" ‚Üí transition EnhancePhoto(photo_url)
           "background" ‚Üí transition BackgroundTool(photo_url)
           "remove" ‚Üí transition RemoveObject(photo_url)
           "style" ‚Üí transition StyleTransfer(photo_url)
           "face" ‚Üí transition FaceTools(photo_url)
           "color" ‚Üí transition ColorCorrection(photo_url)

    callback "back" ‚Üí transition Main

  on SelectTool(photo_url):
    enter:
      ‚Üí lang = get_type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_language(type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id)
      ‚Üí caption: case lang: "en" ‚Üí "üì∏ Your photo" _ ‚Üí "üì∏ –í–∞—à–µ —Ñ–æ—Ç–æ" ¬∑ send_photo
      ‚Üí reply(case lang:
           "en" ‚Üí """
             üîß <b>Select tool</b>

             What to do with this photo?
             """
           _ ‚Üí """
             üîß <b>–í—ã–±–µ—Ä–∏—Ç–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç</b>

             –ß—Ç–æ —Å–¥–µ–ª–∞—Ç—å —Å —ç—Ç–∏–º —Ñ–æ—Ç–æ?
             """)
      ‚Üí show_keyboard([
           button(case lang: "en" ‚Üí "üñºÔ∏è Enhance quality" _ ‚Üí "üñºÔ∏è –£–ª—É—á—à–∏—Ç—å –∫–∞—á–µ—Å—Ç–≤–æ", "enhance"),
           button(case lang: "en" ‚Üí "üé≠ Replace background" _ ‚Üí "üé≠ –ó–∞–º–µ–Ω–∏—Ç—å —Ñ–æ–Ω", "background"),
           button(case lang: "en" ‚Üí "‚ú® Remove object" _ ‚Üí "‚ú® –£–¥–∞–ª–∏—Ç—å –æ–±—ä–µ–∫—Ç", "remove"),
           button(case lang: "en" ‚Üí "üé® Stylization" _ ‚Üí "üé® –°—Ç–∏–ª–∏–∑–∞—Ü–∏—è", "style"),
           button(case lang: "en" ‚Üí "üë§ Faces" _ ‚Üí "üë§ –õ–∏—Ü–∞", "face"),
           button(case lang: "en" ‚Üí "üåà Color correction" _ ‚Üí "üåà –¶–≤–µ—Ç–æ–∫–æ—Ä—Ä–µ–∫—Ü–∏—è", "color"),
           button(case lang: "en" ‚Üí "üîô Upload another" _ ‚Üí "üîô –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥—Ä—É–≥–æ–µ", "back")
         ])

    callback "enhance" ‚Üí transition EnhancePhoto(photo_url)
    callback "background" ‚Üí transition BackgroundTool(photo_url)
    callback "remove" ‚Üí transition RemoveObject(photo_url)
    callback "style" ‚Üí transition StyleTransfer(photo_url)
    callback "face" ‚Üí transition FaceTools(photo_url)
    callback "color" ‚Üí transition ColorCorrection(photo_url)
    callback "back" ‚Üí transition Main

  # ==========================================================================
  # ENHANCE PHOTO
  # ==========================================================================

  on EnhancePhoto(photo_url):
    enter:
      ‚Üí reply("""
        üñºÔ∏è <b>–£–ª—É—á—à–µ–Ω–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞</b>

        –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —É–ª—É—á—à–µ–Ω–∏—è:
        """)
      ‚Üí show_keyboard([
           button("üìà –£–≤–µ–ª–∏—á–∏—Ç—å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ (2x)", "upscale_x"),
           button("üìà –£–≤–µ–ª–∏—á–∏—Ç—å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ (4x)", "upscale_x"),
           button("üîç –ü–æ–≤—ã—Å–∏—Ç—å —Ä–µ–∑–∫–æ—Å—Ç—å", "sharpen"),
           button("üåü –£–±—Ä–∞—Ç—å —à—É–º", "denoise"),
           button("‚ú® –ê–≤—Ç–æ-—É–ª—É—á—à–µ–Ω–∏–µ", "auto"),
           button("üîô –ù–∞–∑–∞–¥", "back")
         ])

    callback "upscale_x" ‚Üí transition "upscale_x", 10 ¬∑ ProcessEnhance
    callback "upscale_x" ‚Üí transition "upscale_x", 25 ¬∑ ProcessEnhance
    callback "sharpen" ‚Üí transition "sharpen", 5 ¬∑ ProcessEnhance
    callback "denoise" ‚Üí transition "denoise", 5 ¬∑ ProcessEnhance
    callback "auto" ‚Üí transition "auto_enhance", 15 ¬∑ ProcessEnhance
    callback "back" ‚Üí transition SelectTool(photo_url)

  on enhance_type, cost ¬∑ ProcessEnhance:
    enter:
      ‚Üí balance = get_balance(type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id)
      ‚Üí case balance >= cost:
           true ‚Üí {
             ‚Üí deduct_balance(type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id, cost)
             ‚Üí reply("‚è≥ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ...")
             ‚Üí result = enhance_type ¬∑ apply_enhancement
             ‚Üí case result:
                  ‚úÖenhanced_url) ‚Üí transition enhanced_url, enhance_type ¬∑ EnhanceResult
                  ‚ùåmsg) ‚Üí {
                    ‚Üí refund_balance(type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id, cost)
                    ‚Üí reply("‚ùå –û—à–∏–±–∫–∞: {msg}")
                    ‚Üí transition EnhancePhoto(photo_url)
                  }
           }
           false ‚Üí {
             ‚Üí reply("‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤. –°—Ç–æ–∏–º–æ—Å—Ç—å: #{cost} ‚≠ê")
             ‚Üí show_keyboard([
                  button("üí≥ –ü–æ–ø–æ–ª–Ω–∏—Ç—å", "topup"),
                  button("üîô –ù–∞–∑–∞–¥", "back")
                ])
           }

    callback "topup" ‚Üí exit_to(TopUp)
    callback "back" ‚Üí transition EnhancePhoto(photo_url)

  on result_url, enhance_type ¬∑ EnhanceResult:
    enter:
      ‚Üí caption: "‚úÖ {enhance_type_label}"(enhance_type ¬∑ send_photo)
      ‚Üí save_edit_history(type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id, original_url, result_url, enhance_type)
      ‚Üí reply("‚úÖ –ì–æ—Ç–æ–≤–æ! –ß—Ç–æ –¥–∞–ª—å—à–µ?")
      ‚Üí show_keyboard([
           button("üîÑ –ï—â—ë —É–ª—É—á—à–µ–Ω–∏—è", "more"),
           button("üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –≤—ã–π—Ç–∏", "save"),
           button("üîß –î—Ä—É–≥–æ–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç", "tools")
         ])

    callback "more" ‚Üí transition EnhancePhoto(result_url)
    callback "save" ‚Üí transition Main
    callback "tools" ‚Üí transition SelectTool(result_url)

  # ==========================================================================
  # BACKGROUND tool
  # ==========================================================================

  on BackgroundTool(photo_url):
    enter:
      ‚Üí reply("""
        üé≠ <b>–†–∞–±–æ—Ç–∞ —Å —Ñ–æ–Ω–æ–º</b>

        –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:
        """)
      ‚Üí show_keyboard([
           button("üö´ –£–¥–∞–ª–∏—Ç—å —Ñ–æ–Ω", "remove_bg"),
           button("üé® –ó–∞–º–µ–Ω–∏—Ç—å –Ω–∞ —Ü–≤–µ—Ç", "color_bg"),
           button("üñºÔ∏è –ó–∞–º–µ–Ω–∏—Ç—å –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ", "image_bg"),
           button("‚ú® –†–∞–∑–º—ã—Ç—å —Ñ–æ–Ω", "blur_bg"),
           button("üåà –ì—Ä–∞–¥–∏–µ–Ω—Ç", "gradient_bg"),
           button("üîô –ù–∞–∑–∞–¥", "back")
         ])

    callback "remove_bg" ‚Üí transition "remove", ‚àÖ¬∑ ProcessBackground
    callback "color_bg" ‚Üí transition SelectBackgroundColor(photo_url)
    callback "image_bg" ‚Üí transition SelectBackgroundImage(photo_url)
    callback "blur_bg" ‚Üí transition BlurBackground(photo_url)
    callback "gradient_bg" ‚Üí transition GradientBackground(photo_url)
    callback "back" ‚Üí transition SelectTool(photo_url)

  on SelectBackgroundColor(photo_url):
    enter:
      ‚Üí reply("üé® –í—ã–±–µ—Ä–∏—Ç–µ —Ü–≤–µ—Ç —Ñ–æ–Ω–∞:")
      ‚Üí show_keyboard([
           button("‚ö™ –ë–µ–ª—ã–π", "bg:white"),
           button("‚ö´ –ß—ë—Ä–Ω—ã–π", "bg:black"),
           button("üîµ –°–∏–Ω–∏–π", "bg:blue"),
           button("üü¢ –ó–µ–ª—ë–Ω—ã–π", "bg:green"),
           button("üî¥ –ö—Ä–∞—Å–Ω—ã–π", "bg:red"),
           button("üü° –ñ—ë–ª—Ç—ã–π", "bg:yellow"),
           button("üü£ –§–∏–æ–ª–µ—Ç–æ–≤—ã–π", "bg:purple"),
           button("üîô –ù–∞–∑–∞–¥", "back")
         ])

    callback /^bg:(.+)$/:
      ‚Üí color = extract_id(callback_data)
      ‚Üí transition "color", color ¬∑ ProcessBackground

    callback "back" ‚Üí transition BackgroundTool(photo_url)

  on SelectBackgroundImage(photo_url):
    enter:
      ‚Üí reply("""
        üñºÔ∏è <b>–§–æ–Ω–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</b>

        –û—Ç–ø—Ä–∞–≤—å—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è —Ñ–æ–Ω–∞ –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏:
        """)
      ‚Üí backgrounds = get_background_library()
      ‚Üí bg_buttons = backgrounds
           ¬∑ take(6)
           ¬∑ map(fn(b) { button(b." {b}{emoji}".name, "lib:{b}".id) }
      ‚Üí show_keyboard(bg_buttons  + [
           button("üîô –ù–∞–∑–∞–¥", "back")
         ])
      ‚Üí stay(backgrounds)

    message PhotoMessage(bg_url):
      ‚Üí transition "image", bg_url ¬∑ ProcessBackground

    callback /^lib:(.+)$/:
      ‚Üí bg_id = extract_id(callback_data)
      ‚Üí bg = backgrounds ¬∑ find({ it.id == bg_id }
      ‚Üí transition "image", bg.url ¬∑ ProcessBackground

    callback "back" ‚Üí transition BackgroundTool(photo_url)

  on BlurBackground(photo_url):
    enter:
      ‚Üí reply("""
        ‚ú® <b>–†–∞–∑–º—ã—Ç–∏–µ —Ñ–æ–Ω–∞</b>

        –í—ã–±–µ—Ä–∏—Ç–µ –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å:
        """)
      ‚Üí show_keyboard([
           button("üîπ –õ—ë–≥–∫–æ–µ", "blur:light"),
           button("üî∑ –°—Ä–µ–¥–Ω–µ–µ", "blur:medium"),
           button("üîµ –°–∏–ª—å–Ω–æ–µ", "blur:strong"),
           button("üîô –ù–∞–∑–∞–¥", "back")
         ])

    callback /^blur:(.+)$/:
      ‚Üí intensity = extract_id(callback_data)
      ‚Üí transition "blur", intensity ¬∑ ProcessBackground

    callback "back" ‚Üí transition BackgroundTool(photo_url)

  on GradientBackground(photo_url):
    enter:
      ‚Üí reply("üåà –í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä–∞–¥–∏–µ–Ω—Ç:")
      ‚Üí show_keyboard([
           button("üåÖ –ó–∞–∫–∞—Ç", "grad:sunset"),
           button("üåä –û–∫–µ–∞–Ω", "grad:ocean"),
           button("üå≤ –õ–µ—Å", "grad:forest"),
           button("üåô –ù–æ—á—å", "grad:night"),
           button("üå∏ –°–∞–∫—É—Ä–∞", "grad:sakura"),
           button("‚ö° –ù–µ–æ–Ω", "grad:neon"),
           button("üîô –ù–∞–∑–∞–¥", "back")
         ])

    callback /^grad:(.+)$/:
      ‚Üí gradient = extract_id(callback_data)
      ‚Üí transition "gradient", gradient ¬∑ ProcessBackground

    callback "back" ‚Üí transition BackgroundTool(photo_url)

  on bg_type, bg_value ¬∑ ProcessBackground:
    enter:
      ‚Üí cost = 15
      ‚Üí balance = get_balance(type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id)
      ‚Üí case balance >= cost:
           true ‚Üí {
             ‚Üí deduct_balance(type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id, cost)
             ‚Üí reply("‚è≥ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é —Ñ–æ–Ω...")
             ‚Üí result = bg_type, bg_value ¬∑ apply_background
             ‚Üí case result:
                  ‚úÖresult_url) ‚Üí transition result_url ¬∑ BackgroundResult
                  ‚ùåmsg) ‚Üí {
                    ‚Üí refund_balance(type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id, cost)
                    ‚Üí reply("‚ùå –û—à–∏–±–∫–∞: {msg}")
                    ‚Üí transition BackgroundTool(photo_url)
                  }
           }
           false ‚Üí {
             ‚Üí reply("‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤. –°—Ç–æ–∏–º–æ—Å—Ç—å: #{cost} ‚≠ê")
             ‚Üí show_keyboard([
                  button("üí≥ –ü–æ–ø–æ–ª–Ω–∏—Ç—å", "topup"),
                  button("üîô –ù–∞–∑–∞–¥", "back")
                ])
           }

    callback "topup" ‚Üí exit_to(TopUp)
    callback "back" ‚Üí transition BackgroundTool(photo_url)

  on result_url ¬∑ BackgroundResult:
    enter:
      ‚Üí caption: "‚úÖ –§–æ–Ω –∏–∑–º–µ–Ω—ë–Ω" ¬∑ send_photo
      ‚Üí save_edit_history(type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id, original_url, result_url, "background")
      ‚Üí reply("–ß—Ç–æ –¥–∞–ª—å—à–µ?")
      ‚Üí show_keyboard([
           button("üé≠ –î—Ä—É–≥–æ–π —Ñ–æ–Ω", "change_bg"),
           button("üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å", "save"),
           button("üîß –î—Ä—É–≥–æ–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç", "tools")
         ])

    callback "change_bg" ‚Üí transition BackgroundTool(result_url)
    callback "save" ‚Üí transition Main
    callback "tools" ‚Üí transition SelectTool(result_url)

  # ==========================================================================
  # REMOVE OBJECT
  # ==========================================================================

  on RemoveObject(photo_url):
    enter:
      ‚Üí reply("""
        ‚ú® <b>–£–¥–∞–ª–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–æ–≤</b>

        –í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–±:
        """)
      ‚Üí show_keyboard([
           button("üìù –û–ø–∏—Å–∞—Ç—å –æ–±—ä–µ–∫—Ç", "describe"),
           button("üéØ –í—ã–¥–µ–ª–∏—Ç—å –æ–±–ª–∞—Å—Ç—å", "select"),
           button("üë§ –£–¥–∞–ª–∏—Ç—å –ª—é–¥–µ–π", "remove_people"),
           button("üìù –£–¥–∞–ª–∏—Ç—å —Ç–µ–∫—Å—Ç", "remove_text"),
           button("üîô –ù–∞–∑–∞–¥", "back")
         ])

    callback "describe" ‚Üí transition DescribeObjectToRemove(photo_url)
    callback "select" ‚Üí transition SelectAreaToRemove(photo_url)
    callback "remove_people" ‚Üí transition "people", ‚àÖ¬∑ ProcessRemove
    callback "remove_text" ‚Üí transition "text", ‚àÖ¬∑ ProcessRemove
    callback "back" ‚Üí transition SelectTool(photo_url)

  on DescribeObjectToRemove(photo_url):
    enter:
      ‚Üí reply("""
        üìù <b>–û–ø–∏—à–∏—Ç–µ –æ–±—ä–µ–∫—Ç</b>

        –ß—Ç–æ –Ω—É–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å —Å —Ñ–æ—Ç–æ?

        <i>–ù–∞–ø—Ä–∏–º–µ—Ä: "—á–µ–ª–æ–≤–µ–∫ —Å–ª–µ–≤–∞", "–º–∞—à–∏–Ω–∞ –Ω–∞ –∑–∞–¥–Ω–µ–º –ø–ª–∞–Ω–µ", "–ª–æ–≥–æ—Ç–∏–ø"</i>
        """)
      ‚Üí show_keyboard([
           button("üîô –ù–∞–∑–∞–¥", "back")
         ])

    message TextMessage(description):
      ‚Üí transition "describe", description ¬∑ ProcessRemove

    callback "back" ‚Üí transition RemoveObject(photo_url)

  on SelectAreaToRemove(photo_url):
    enter:
      ‚Üí reply("""
        üéØ <b>–í—ã–¥–µ–ª–µ–Ω–∏–µ –æ–±–ª–∞—Å—Ç–∏</b>

        –û—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –æ–±–ª–∞—Å—Ç–∏ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ:
        <code>x1,y1,x2,y2</code>

        –ò–ª–∏ –ø—Ä–æ—Å—Ç–æ –æ–ø–∏—à–∏—Ç–µ –æ–±–ª–∞—Å—Ç—å:
        <i>"–≤–µ—Ä—Ö–Ω–∏–π –ø—Ä–∞–≤—ã–π —É–≥–æ–ª", "—Ü–µ–Ω—Ç—Ä —Ñ–æ—Ç–æ"</i>
        """)
      ‚Üí show_keyboard([
           button("üîô –ù–∞–∑–∞–¥", "back")
         ])

    message TextMessage(area):
      ‚Üí transition "area", area ¬∑ ProcessRemove

    callback "back" ‚Üí transition RemoveObject(photo_url)

  on remove_type, remove_value ¬∑ ProcessRemove:
    enter:
      ‚Üí cost = 20
      ‚Üí balance = get_balance(type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id)
      ‚Üí case balance >= cost:
           true ‚Üí {
             ‚Üí deduct_balance(type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id, cost)
             ‚Üí reply("‚è≥ –£–¥–∞–ª—è—é –æ–±—ä–µ–∫—Ç...")
             ‚Üí result = remove_type, remove_value ¬∑ remove_object
             ‚Üí case result:
                  ‚úÖresult_url) ‚Üí transition result_url ¬∑ RemoveResult
                  ‚ùåmsg) ‚Üí {
                    ‚Üí refund_balance(type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id, cost)
                    ‚Üí reply("‚ùå –û—à–∏–±–∫–∞: {msg}")
                    ‚Üí transition RemoveObject(photo_url)
                  }
           }
           false ‚Üí {
             ‚Üí reply("‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤. –°—Ç–æ–∏–º–æ—Å—Ç—å: #{cost} ‚≠ê")
             ‚Üí show_keyboard([
                  button("üí≥ –ü–æ–ø–æ–ª–Ω–∏—Ç—å", "topup"),
                  button("üîô –ù–∞–∑–∞–¥", "back")
                ])
           }

    callback "topup" ‚Üí exit_to(TopUp)
    callback "back" ‚Üí transition RemoveObject(photo_url)

  on result_url ¬∑ RemoveResult:
    enter:
      ‚Üí caption: "‚úÖ –û–±—ä–µ–∫—Ç —É–¥–∞–ª—ë–Ω" ¬∑ send_photo
      ‚Üí save_edit_history(type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id, original_url, result_url, "remove_object")
      ‚Üí reply("–ß—Ç–æ –¥–∞–ª—å—à–µ?")
      ‚Üí show_keyboard([
           button("‚ú® –£–¥–∞–ª–∏—Ç—å –µ—â—ë", "more"),
           button("üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å", "save"),
           button("üîß –î—Ä—É–≥–æ–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç", "tools")
         ])

    callback "more" ‚Üí transition RemoveObject(result_url)
    callback "save" ‚Üí transition Main
    callback "tools" ‚Üí transition SelectTool(result_url)

  # ==========================================================================
  # STYLE TRANSFER
  # ==========================================================================

  on StyleTransfer(photo_url):
    enter:
      ‚Üí reply("""
        üé® <b>–°—Ç–∏–ª–∏–∑–∞—Ü–∏—è</b>

        –í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∏–ª—å:
        """)
      ‚Üí show_keyboard([
           button("üé® –•—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏", "art_styles"),
           button("üì∑ –§–æ—Ç–æ —Ñ–∏–ª—å—Ç—Ä—ã", "photo_filters"),
           button("üé≠ –ê–Ω–∏–º–µ/–ú—É–ª—å—Ç—Ñ–∏–ª—å–º", "anime"),
           button("üñºÔ∏è –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–≤–æ—ë –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ", "custom"),
           button("üîô –ù–∞–∑–∞–¥", "back")
         ])

    callback "art_styles" ‚Üí transition ArtStyles(photo_url)
    callback "photo_filters" ‚Üí transition PhotoFilters(photo_url)
    callback "anime" ‚Üí transition AnimeStyles(photo_url)
    callback "custom" ‚Üí transition CustomStyleTransfer(photo_url)
    callback "back" ‚Üí transition SelectTool(photo_url)

  on ArtStyles(photo_url):
    enter:
      ‚Üí reply("üé® –í—ã–±–µ—Ä–∏—Ç–µ —Ö—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π —Å—Ç–∏–ª—å:")
      ‚Üí show_keyboard([
           button("üåª –í–∞–Ω –ì–æ–≥", "style:vangogh"),
           button("üé® –ü–∏–∫–∞—Å—Å–æ", "style:picasso"),
           button("üåä –•–æ–∫—É—Å–∞–π", "style:hokusai"),
           button("üíé –ö–∞–Ω–¥–∏–Ω—Å–∫–∏–π", "style:kandinsky"),
           button("üå∏ –ú–æ–Ω–µ", "style:monet"),
           button("‚¨õ –ú–∞–ª–µ–≤–∏—á", "style:malevich"),
           button("üîô –ù–∞–∑–∞–¥", "back")
         ])

    callback /^style:(.+)$/:
      ‚Üí style = extract_id(callback_data)
      ‚Üí transition "art", style ¬∑ ProcessStyle

    callback "back" ‚Üí transition StyleTransfer(photo_url)

  on PhotoFilters(photo_url):
    enter:
      ‚Üí reply("üì∑ –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∏–ª—å—Ç—Ä:")
      ‚Üí show_keyboard([
           button("üåÖ –¢—ë–ø–ª—ã–π", "filter:warm"),
           button("‚ùÑÔ∏è –•–æ–ª–æ–¥–Ω—ã–π", "filter:cool"),
           button("üåë –ß—ë—Ä–Ω–æ-–±–µ–ª—ã–π", "filter:bw"),
           button("üì∑ –†–µ—Ç—Ä–æ", "filter:retro"),
           button("üåÜ HDR", "filter:hdr"),
           button("üé• –ö–∏–Ω–µ–º–∞—Ç–æ–≥—Ä–∞—Ñ–∏—á–Ω—ã–π", "filter:cinematic"),
           button("üîô –ù–∞–∑–∞–¥", "back")
         ])

    callback /^filter:(.+)$/:
      ‚Üí filter_type = extract_id(callback_data)
      ‚Üí transition "filter", filter_type ¬∑ ProcessStyle

    callback "back" ‚Üí transition StyleTransfer(photo_url)

  on AnimeStyles(photo_url):
    enter:
      ‚Üí reply("üé≠ –í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∏–ª—å:")
      ‚Üí show_keyboard([
           button("üéå –ê–Ω–∏–º–µ", "anime"),
           button("üé¨ –ü–∏–∫—Å–∞—Ä", "anime:pixar"),
           button("üì∫ –°–∏–º–ø—Å–æ–Ω—ã", "anime:simpsons"),
           button("üéÆ –ê—Ä–∫–∞–¥–∞", "anime:arcade"),
           button("üñåÔ∏è –ö–æ–º–∏–∫—Å", "anime:comic"),
           button("üé® –ì–∏–±–ª–∏", "anime:ghibli"),
           button("üîô –ù–∞–∑–∞–¥", "back")
         ])

    callback /^anime:(.+)$/:
      ‚Üí anime_style = extract_id(callback_data)
      ‚Üí transition "anime", anime_style ¬∑ ProcessStyle

    callback "back" ‚Üí transition StyleTransfer(photo_url)

  on CustomStyleTransfer(photo_url):
    enter:
      ‚Üí reply("""
        üñºÔ∏è <b>–°–≤–æ–π —Å—Ç–∏–ª—å</b>

        –û—Ç–ø—Ä–∞–≤—å—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, —Å—Ç–∏–ª—å –∫–æ—Ç–æ—Ä–æ–≥–æ –Ω—É–∂–Ω–æ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –∫ –≤–∞—à–µ–º—É —Ñ–æ—Ç–æ:
        """)
      ‚Üí show_keyboard([
           button("üîô –ù–∞–∑–∞–¥", "back")
         ])

    message PhotoMessage(style_url):
      ‚Üí transition "custom", style_url ¬∑ ProcessStyle

    callback "back" ‚Üí transition StyleTransfer(photo_url)

  on style_type, style_value ¬∑ ProcessStyle:
    enter:
      ‚Üí cost = 20
      ‚Üí balance = get_balance(type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id)
      ‚Üí case balance >= cost:
           true ‚Üí {
             ‚Üí deduct_balance(type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id, cost)
             ‚Üí reply("‚è≥ –ü—Ä–∏–º–µ–Ω—è—é —Å—Ç–∏–ª—å...")
             ‚Üí result = style_type, style_value ¬∑ apply_style
             ‚Üí case result:
                  ‚úÖresult_url) ‚Üí transition result_url, style_type ¬∑ StyleResult
                  ‚ùåmsg) ‚Üí {
                    ‚Üí refund_balance(type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id, cost)
                    ‚Üí reply("‚ùå –û—à–∏–±–∫–∞: {msg}")
                    ‚Üí transition StyleTransfer(photo_url)
                  }
           }
           false ‚Üí {
             ‚Üí reply("‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤. –°—Ç–æ–∏–º–æ—Å—Ç—å: #{cost} ‚≠ê")
             ‚Üí show_keyboard([
                  button("üí≥ –ü–æ–ø–æ–ª–Ω–∏—Ç—å", "topup"),
                  button("üîô –ù–∞–∑–∞–¥", "back")
                ])
           }

    callback "topup" ‚Üí exit_to(TopUp)
    callback "back" ‚Üí transition StyleTransfer(photo_url)

  on result_url, style_type ¬∑ StyleResult:
    enter:
      ‚Üí caption: "‚úÖ –°—Ç–∏–ª—å –ø—Ä–∏–º–µ–Ω—ë–Ω" ¬∑ send_photo
      ‚Üí save_edit_history(type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id, original_url, result_url, "style_ {style_type}")
      ‚Üí reply("–ß—Ç–æ –¥–∞–ª—å—à–µ?")
      ‚Üí show_keyboard([
           button("üé® –î—Ä—É–≥–æ–π —Å—Ç–∏–ª—å", "more_styles"),
           button("üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å", "save"),
           button("üîß –î—Ä—É–≥–æ–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç", "tools")
         ])

    callback "more_styles" ‚Üí transition StyleTransfer(result_url)
    callback "save" ‚Üí transition Main
    callback "tools" ‚Üí transition SelectTool(result_url)

  # ==========================================================================
  # FACE TOOLS
  # ==========================================================================

  on FaceTools(photo_url):
    enter:
      ‚Üí reply("""
        üë§ <b>–†–∞–±–æ—Ç–∞ —Å –ª–∏—Ü–∞–º–∏</b>

        –í—ã–±–µ—Ä–∏—Ç–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç:
        """)
      ‚Üí show_keyboard([
           button("‚ú® –†–µ—Ç—É—à—å –ª–∏—Ü–∞", "retouch"),
           button("üòä –ò–∑–º–µ–Ω–∏—Ç—å –≤—ã—Ä–∞–∂–µ–Ω–∏–µ", "expression"),
           button("üë¥ –ò–∑–º–µ–Ω–∏—Ç—å –≤–æ–∑—Ä–∞—Å—Ç", "age"),
           button("üíá –ò–∑–º–µ–Ω–∏—Ç—å –ø—Ä–∏—á—ë—Å–∫—É", "hair"),
           button("üíÑ –í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –º–∞–∫–∏—è–∂", "makeup"),
           button("üîÑ –ó–∞–º–µ–Ω–∞ –ª–∏—Ü–∞", "swap"),
           button("üîô –ù–∞–∑–∞–¥", "back")
         ])

    callback "retouch" ‚Üí transition FaceRetouch(photo_url)
    callback "expression" ‚Üí transition ChangeExpression(photo_url)
    callback "age" ‚Üí transition ChangeAge(photo_url)
    callback "hair" ‚Üí transition ChangeHair(photo_url)
    callback "makeup" ‚Üí transition VirtualMakeup(photo_url)
    callback "swap" ‚Üí transition FaceSwap(photo_url)
    callback "back" ‚Üí transition SelectTool(photo_url)

  on FaceRetouch(photo_url):
    enter:
      ‚Üí reply("‚ú® –í—ã–±–µ—Ä–∏—Ç–µ —É—Ä–æ–≤–µ–Ω—å —Ä–µ—Ç—É—à–∏:")
      ‚Üí show_keyboard([
           button("üîπ –õ—ë–≥–∫–∞—è", "retouch:light"),
           button("üî∑ –°—Ä–µ–¥–Ω—è—è", "retouch:medium"),
           button("üîµ –ü–æ–ª–Ω–∞—è", "retouch:full"),
           button("üîô –ù–∞–∑–∞–¥", "back")
         ])

    callback /^retouch:(.+)$/:
      ‚Üí level = extract_id(callback_data)
      ‚Üí transition "retouch", level ¬∑ ProcessFace

    callback "back" ‚Üí transition FaceTools(photo_url)

  on ChangeExpression(photo_url):
    enter:
      ‚Üí reply("üòä –í—ã–±–µ—Ä–∏—Ç–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –ª–∏—Ü–∞:")
      ‚Üí show_keyboard([
           button("üòä –£–ª—ã–±–∫–∞", "expr:smile"),
           button("üòÉ –®–∏—Ä–æ–∫–∞—è —É–ª—ã–±–∫–∞", "expr:big_smile"),
           button("üòê –ù–µ–π—Ç—Ä–∞–ª—å–Ω–æ–µ", "expr:neutral"),
           button("üò¢ –ì—Ä—É—Å—Ç–Ω–æ–µ", "expr:sad"),
           button("üòÆ –£–¥–∏–≤–ª–µ–Ω–∏–µ", "expr:surprised"),
           button("üò† –°–µ—Ä—å—ë–∑–Ω–æ–µ", "expr:serious"),
           button("üîô –ù–∞–∑–∞–¥", "back")
         ])

    callback /^expr:(.+)$/:
      ‚Üí expression = extract_id(callback_data)
      ‚Üí transition "expression", expression ¬∑ ProcessFace

    callback "back" ‚Üí transition FaceTools(photo_url)

  on ChangeAge(photo_url):
    enter:
      ‚Üí reply("üë¥ –ò–∑–º–µ–Ω–µ–Ω–∏–µ –≤–æ–∑—Ä–∞—Å—Ç–∞:")
      ‚Üí show_keyboard([
           button("üë∂ –†–µ–±—ë–Ω–æ–∫", "age:child"),
           button("üßí –ü–æ–¥—Ä–æ—Å—Ç–æ–∫", "age:teen"),
           button("üßë –ú–æ–ª–æ–¥–æ–π", "age:young"),
           button("üßî –°—Ä–µ–¥–Ω–∏–π –≤–æ–∑—Ä–∞—Å—Ç", "age:middle"),
           button("üë¥ –ü–æ–∂–∏–ª–æ–π", "age:old"),
           button("üîô –ù–∞–∑–∞–¥", "back")
         ])

    callback /^age:(.+)$/:
      ‚Üí target_age = extract_id(callback_data)
      ‚Üí transition "age", target_age ¬∑ ProcessFace

    callback "back" ‚Üí transition FaceTools(photo_url)

  on ChangeHair(photo_url):
    enter:
      ‚Üí reply("üíá –ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–∏—á—ë—Å–∫–∏:")
      ‚Üí show_keyboard([
           button("üë©‚Äçü¶∞ –†—ã–∂–∏–µ", "hair:red"),
           button("üë± –ë–ª–æ–Ω–¥", "hair:blonde"),
           button("üë©‚Äçü¶≥ –°–µ–¥—ã–µ", "hair:grey"),
           button("üë© –ë—Ä—é–Ω–µ—Ç", "hair:brunette"),
           button("üíá‚Äç‚ôÄÔ∏è –ö–æ—Ä–æ—Ç–∫–∏–µ", "hair:short"),
           button("üíá‚Äç‚ôÇÔ∏è –î–ª–∏–Ω–Ω—ã–µ", "hair:long"),
           button("üë®‚Äçü¶≤ –õ—ã—Å—ã–π", "hair:bald"),
           button("üîô –ù–∞–∑–∞–¥", "back")
         ])

    callback /^hair:(.+)$/:
      ‚Üí hair_style = extract_id(callback_data)
      ‚Üí transition "hair", hair_style ¬∑ ProcessFace

    callback "back" ‚Üí transition FaceTools(photo_url)

  on VirtualMakeup(photo_url):
    enter:
      ‚Üí reply("üíÑ –í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –º–∞–∫–∏—è–∂:")
      ‚Üí show_keyboard([
           button("üå∏ –ù–∞—Ç—É—Ä–∞–ª—å–Ω—ã–π", "makeup:natural"),
           button("üíã –í–µ—á–µ—Ä–Ω–∏–π", "makeup:evening"),
           button("üé≠ –î—Ä–∞–º–∞—Ç–∏—á–Ω—ã–π", "makeup:dramatic"),
           button("üåà –Ø—Ä–∫–∏–π", "makeup:bright"),
           button("üëÅÔ∏è –°–º–æ–∫–∏", "makeup:smoky"),
           button("üîô –ù–∞–∑–∞–¥", "back")
         ])

    callback /^makeup:(.+)$/:
      ‚Üí makeup_style = extract_id(callback_data)
      ‚Üí transition "makeup", makeup_style ¬∑ ProcessFace

    callback "back" ‚Üí transition FaceTools(photo_url)

  on FaceSwap(photo_url):
    enter:
      ‚Üí reply("""
        üîÑ <b>–ó–∞–º–µ–Ω–∞ –ª–∏—Ü–∞</b>

        –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ —Å –ª–∏—Ü–æ–º, –∫–æ—Ç–æ—Ä–æ–µ —Ö–æ—Ç–∏—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:
        """)
      ‚Üí show_keyboard([
           button("üîô –ù–∞–∑–∞–¥", "back")
         ])

    message PhotoMessage(face_url):
      ‚Üí transition "swap", face_url ¬∑ ProcessFace

    callback "back" ‚Üí transition FaceTools(photo_url)

  on face_op, face_value ¬∑ ProcessFace:
    enter:
      ‚Üí cost = case face_op:
           "swap" ‚Üí 30
           "retouch" ‚Üí 10
           _ ‚Üí 15
      ‚Üí balance = get_balance(type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id)
      ‚Üí case balance >= cost:
           true ‚Üí {
             ‚Üí deduct_balance(type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id, cost)
             ‚Üí reply("‚è≥ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é –ª–∏—Ü–æ...")
             ‚Üí result = face_op, face_value ¬∑ apply_face_operation
             ‚Üí case result:
                  ‚úÖresult_url) ‚Üí transition result_url, face_op ¬∑ FaceResult
                  ‚ùåmsg) ‚Üí {
                    ‚Üí refund_balance(type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id, cost)
                    ‚Üí reply("‚ùå –û—à–∏–±–∫–∞: {msg}")
                    ‚Üí transition FaceTools(photo_url)
                  }
           }
           false ‚Üí {
             ‚Üí reply("‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤. –°—Ç–æ–∏–º–æ—Å—Ç—å: #{cost} ‚≠ê")
             ‚Üí show_keyboard([
                  button("üí≥ –ü–æ–ø–æ–ª–Ω–∏—Ç—å", "topup"),
                  button("üîô –ù–∞–∑–∞–¥", "back")
                ])
           }

    callback "topup" ‚Üí exit_to(TopUp)
    callback "back" ‚Üí transition FaceTools(photo_url)

  on result_url, face_op ¬∑ FaceResult:
    enter:
      ‚Üí caption: "‚úÖ {face_op_label}"(face_op ¬∑ send_photo)
      ‚Üí save_edit_history(type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id, original_url, result_url, "face_ {face_op}")
      ‚Üí reply("–ß—Ç–æ –¥–∞–ª—å—à–µ?")
      ‚Üí show_keyboard([
           button("üë§ –ï—â—ë —Å –ª–∏—Ü–æ–º", "more_face"),
           button("üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å", "save"),
           button("üîß –î—Ä—É–≥–æ–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç", "tools")
         ])

    callback "more_face" ‚Üí transition FaceTools(result_url)
    callback "save" ‚Üí transition Main
    callback "tools" ‚Üí transition SelectTool(result_url)

  # ==========================================================================
  # COLOR CORRECTION
  # ==========================================================================

  on ColorCorrection(photo_url):
    enter:
      ‚Üí reply("""
        üåà <b>–¶–≤–µ—Ç–æ–∫–æ—Ä—Ä–µ–∫—Ü–∏—è</b>

        –í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫—É:
        """)
      ‚Üí show_keyboard([
           button("‚òÄÔ∏è –Ø—Ä–∫–æ—Å—Ç—å", "brightness"),
           button("üé® –ö–æ–Ω—Ç—Ä–∞—Å—Ç", "contrast"),
           button("üå°Ô∏è –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞", "temperature"),
           button("üíß –ù–∞—Å—ã—â–µ–Ω–Ω–æ—Å—Ç—å", "saturation"),
           button("‚ú® –ê–≤—Ç–æ", "auto_color"),
           button("üé≠ –ü—Ä–µ—Å–µ—Ç—ã", "presets"),
           button("üîô –ù–∞–∑–∞–¥", "back")
         ])

    callback "brightness" ‚Üí transition AdjustBrightness(photo_url)
    callback "contrast" ‚Üí transition AdjustContrast(photo_url)
    callback "temperature" ‚Üí transition AdjustTemperature(photo_url)
    callback "saturation" ‚Üí transition AdjustSaturation(photo_url)
    callback "auto_color" ‚Üí transition "auto", 0 ¬∑ ProcessColor
    callback "presets" ‚Üí transition ColorPresets(photo_url)
    callback "back" ‚Üí transition SelectTool(photo_url)

  on AdjustBrightness(photo_url):
    enter:
      ‚Üí reply("‚òÄÔ∏è –í—ã–±–µ—Ä–∏—Ç–µ —è—Ä–∫–æ—Å—Ç—å:")
      ‚Üí show_keyboard([
           button("‚ûñ‚ûñ –û—á–µ–Ω—å —Ç—ë–º–Ω–æ–µ", "bright:-50"),
           button("‚ûñ –¢–µ–º–Ω–µ–µ", "bright:-25"),
           button("‚ûï –°–≤–µ—Ç–ª–µ–µ", "bright:25"),
           button("‚ûï‚ûï –û—á–µ–Ω—å —Å–≤–µ—Ç–ª–æ–µ", "bright:50"),
           button("üîô –ù–∞–∑–∞–¥", "back")
         ])

    callback /^bright:(.+)$/:
      ‚Üí value = parse_int(extract_id(callback_data))
      ‚Üí transition "brightness", value ¬∑ ProcessColor

    callback "back" ‚Üí transition ColorCorrection(photo_url)

  on AdjustContrast(photo_url):
    enter:
      ‚Üí reply("üé® –í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–Ω—Ç—Ä–∞—Å—Ç:")
      ‚Üí show_keyboard([
           button("‚ûñ –ù–∏–∑–∫–∏–π", "contrast:-25"),
           button("‚ûï –í—ã—Å–æ–∫–∏–π", "contrast:25"),
           button("‚ûï‚ûï –û—á–µ–Ω—å –≤—ã—Å–æ–∫–∏–π", "contrast:50"),
           button("üîô –ù–∞–∑–∞–¥", "back")
         ])

    callback /^contrast:(.+)$/:
      ‚Üí value = parse_int(extract_id(callback_data))
      ‚Üí transition "contrast", value ¬∑ ProcessColor

    callback "back" ‚Üí transition ColorCorrection(photo_url)

  on AdjustTemperature(photo_url):
    enter:
      ‚Üí reply("üå°Ô∏è –í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É:")
      ‚Üí show_keyboard([
           button("‚ùÑÔ∏è –•–æ–ª–æ–¥–Ω—ã–π", "temp:-50"),
           button("üåä –ü—Ä–æ—Ö–ª–∞–¥–Ω—ã–π", "temp:-25"),
           button("üåÖ –¢—ë–ø–ª—ã–π", "temp:25"),
           button("üî• –ì–æ—Ä—è—á–∏–π", "temp:50"),
           button("üîô –ù–∞–∑–∞–¥", "back")
         ])

    callback /^temp:(.+)$/:
      ‚Üí value = parse_int(extract_id(callback_data))
      ‚Üí transition "temperature", value ¬∑ ProcessColor

    callback "back" ‚Üí transition ColorCorrection(photo_url)

  on AdjustSaturation(photo_url):
    enter:
      ‚Üí reply("üíß –í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞—Å—ã—â–µ–Ω–Ω–æ—Å—Ç—å:")
      ‚Üí show_keyboard([
           button("‚¨ú –ß—ë—Ä–Ω–æ-–±–µ–ª–æ–µ", "sat:-100"),
           button("üå´Ô∏è –ü—Ä–∏–≥–ª—É—à—ë–Ω–Ω–æ–µ", "sat:-50"),
           button("üåà –Ø—Ä–∫–æ–µ", "sat:25"),
           button("üí• –ù–∞—Å—ã—â–µ–Ω–Ω–æ–µ", "sat:50"),
           button("üîô –ù–∞–∑–∞–¥", "back")
         ])

    callback /^sat:(.+)$/:
      ‚Üí value = parse_int(extract_id(callback_data))
      ‚Üí transition "saturation", value ¬∑ ProcessColor

    callback "back" ‚Üí transition ColorCorrection(photo_url)

  on ColorPresets(photo_url):
    enter:
      ‚Üí reply("üé≠ –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ—Å–µ—Ç:")
      ‚Üí show_keyboard([
           button("üåÖ –ó–∞–∫–∞—Ç", "preset:sunset"),
           button("üåô –ù–æ—á—å", "preset:night"),
           button("üåø –ü—Ä–∏—Ä–æ–¥–∞", "preset:nature"),
           button("üèôÔ∏è –ì–æ—Ä–æ–¥—Å–∫–æ–π", "preset:urban"),
           button("üì∑ –í–∏–Ω—Ç–∞–∂", "preset:vintage"),
           button("üéûÔ∏è –ü–ª—ë–Ω–∫–∞", "preset:film"),
           button("üîô –ù–∞–∑–∞–¥", "back")
         ])

    callback /^preset:(.+)$/:
      ‚Üí preset = extract_id(callback_data)
      ‚Üí transition "preset", preset ¬∑ ProcessColor

    callback "back" ‚Üí transition ColorCorrection(photo_url)

  on color_type, color_value ¬∑ ProcessColor:
    enter:
      ‚Üí cost = 5
      ‚Üí balance = get_balance(type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id)
      ‚Üí case balance >= cost:
           true ‚Üí {
             ‚Üí deduct_balance(type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id, cost)
             ‚Üí reply("‚è≥ –ü—Ä–∏–º–µ–Ω—è—é –∫–æ—Ä—Ä–µ–∫—Ü–∏—é...")
             ‚Üí result = color_type, color_value ¬∑ apply_color_correction
             ‚Üí case result:
                  ‚úÖresult_url) ‚Üí transition result_url ¬∑ ColorResult
                  ‚ùåmsg) ‚Üí {
                    ‚Üí refund_balance(type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id, cost)
                    ‚Üí reply("‚ùå –û—à–∏–±–∫–∞: {msg}")
                    ‚Üí transition ColorCorrection(photo_url)
                  }
           }
           false ‚Üí {
             ‚Üí reply("‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤. –°—Ç–æ–∏–º–æ—Å—Ç—å: #{cost} ‚≠ê")
             ‚Üí show_keyboard([
                  button("üí≥ –ü–æ–ø–æ–ª–Ω–∏—Ç—å", "topup"),
                  button("üîô –ù–∞–∑–∞–¥", "back")
                ])
           }

    callback "topup" ‚Üí exit_to(TopUp)
    callback "back" ‚Üí transition ColorCorrection(photo_url)

  on result_url ¬∑ ColorResult:
    enter:
      ‚Üí caption: "‚úÖ –¶–≤–µ—Ç–∞ —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω—ã" ¬∑ send_photo
      ‚Üí save_edit_history(type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id, original_url, result_url, "color_correction")
      ‚Üí reply("–ß—Ç–æ –¥–∞–ª—å—à–µ?")
      ‚Üí show_keyboard([
           button("üåà –ï—â—ë –∫–æ—Ä—Ä–µ–∫—Ü–∏—è", "more_color"),
           button("üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å", "save"),
           button("üîß –î—Ä—É–≥–æ–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç", "tools")
         ])

    callback "more_color" ‚Üí transition ColorCorrection(result_url)
    callback "save" ‚Üí transition Main
    callback "tools" ‚Üí transition SelectTool(result_url)

  # ==========================================================================
  # EDIT HISTORY
  # ==========================================================================

  on EditHistory:
    enter:
      ‚Üí history = get_edit_history(type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id, limit: 20)
      ‚Üí case history:
           [] ‚Üí {
             ‚Üí reply("üì≠ –ò—Å—Ç–æ—Ä–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—É—Å—Ç–∞")
             ‚Üí show_keyboard([
                  button("üîô –ù–∞–∑–∞–¥", "back")
                ])
           }
           list ‚Üí {
             ‚Üí reply("""
               üìã <b>–ò—Å—Ç–æ—Ä–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</b>

               –ü–æ—Å–ª–µ–¥–Ω–∏–µ #{length(list)} —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–π:
               """)
             ‚Üí buttons = list
                  ¬∑ take(10)
                  ¬∑ map(fn(h) { button(h." - {tool_label}{date}"(h.tool), "history:{h}".id) }
             ‚Üí show_keyboard(buttons  + [
                  button("üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é", "clear"),
                  button("üîô –ù–∞–∑–∞–¥", "back")
                ])
             ‚Üí stay(history: list)
           }

    callback /^history:(.+)$/:
      ‚Üí history_id = extract_id(callback_data)
      ‚Üí item = history ¬∑ find({ it.id == history_id }
      ‚Üí transition HistoryItem(item)

    callback "clear" ‚Üí transition ConfirmClearHistory
    callback "back" ‚Üí transition Main

  on HistoryItem(item):
    enter:
      ‚Üí send_photo(item.result_url, caption: "üìã {tool_label}"(item.tool))
      ‚Üí reply("""
        üìã <b>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</b>

        üìÖ –î–∞—Ç–∞: #{item.date}
        üîß –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç: #{tool_label(item.tool)}
        """)
      ‚Üí show_keyboard([
           button("üîÑ –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –µ—â—ë", "edit"),
           button("üì• –°–∫–∞—á–∞—Ç—å –æ—Ä–∏–≥–∏–Ω–∞–ª", "original"),
           button("üîô –ù–∞–∑–∞–¥", "back")
         ])

    callback "edit" ‚Üí transition SelectTool(item.result_url)
    callback "original":
      ‚Üí send_photo(item.original_url, caption: "üì∑ –û—Ä–∏–≥–∏–Ω–∞–ª")
    callback "back" ‚Üí transition EditHistory

  on ConfirmClearHistory:
    enter:
      ‚Üí reply("""
        ‚ö†Ô∏è <b>–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é?</b>

        –í—Å–µ –∑–∞–ø–∏—Å–∏ –æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã.
        """)
      ‚Üí show_keyboard([
           button("üóëÔ∏è –î–∞, –æ—á–∏—Å—Ç–∏—Ç—å", "confirm"),
           button("üîô –û—Ç–º–µ–Ω–∞", "cancel")
         ])

    callback "confirm":
      ‚Üí clear_edit_history(type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id)
      ‚Üí reply("‚úÖ –ò—Å—Ç–æ—Ä–∏—è –æ—á–∏—â–µ–Ω–∞")
      ‚Üí transition Main

    callback "cancel" ‚Üí transition EditHistory

# =============================================================================
# HELPER FUNCTIONS
# =============================================================================

tool_label(tool):
  case tool:
    "enhance" ‚Üí "üñºÔ∏è –£–ª—É—á—à–µ–Ω–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞"
    "background" ‚Üí "üé≠ –ó–∞–º–µ–Ω–∞ —Ñ–æ–Ω–∞"
    "remove" ‚Üí "‚ú® –£–¥–∞–ª–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–æ–≤"
    "style" ‚Üí "üé® –°—Ç–∏–ª–∏–∑–∞—Ü–∏—è"
    "face" ‚Üí "üë§ –†–∞–±–æ—Ç–∞ —Å –ª–∏—Ü–∞–º–∏"
    "color" ‚Üí "üåà –¶–≤–µ—Ç–æ–∫–æ—Ä—Ä–µ–∫—Ü–∏—è"
    "upscale_x" ‚Üí "üìà –£–≤–µ–ª–∏—á–µ–Ω–∏–µ 2x"
    "upscale_x" ‚Üí "üìà –£–≤–µ–ª–∏—á–µ–Ω–∏–µ 4x"
    "sharpen" ‚Üí "üîç –†–µ–∑–∫–æ—Å—Ç—å"
    "denoise" ‚Üí "üåü –®—É–º–æ–ø–æ–¥–∞–≤–ª–µ–Ω–∏–µ"
    "auto_enhance" ‚Üí "‚ú® –ê–≤—Ç–æ-—É–ª—É—á—à–µ–Ω–∏–µ"
    "remove_object" ‚Üí "‚ú® –£–¥–∞–ª–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞"
    "style_art" ‚Üí "üé® –•—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π —Å—Ç–∏–ª—å"
    "style_filter" ‚Üí "üì∑ –§–∏–ª—å—Ç—Ä"
    "style_anime" ‚Üí "üé≠ –ê–Ω–∏–º–µ —Å—Ç–∏–ª—å"
    "face_retouch" ‚Üí "‚ú® –†–µ—Ç—É—à—å"
    "face_expression" ‚Üí "üòä –í—ã—Ä–∞–∂–µ–Ω–∏–µ"
    "face_age" ‚Üí "üë¥ –í–æ–∑—Ä–∞—Å—Ç"
    "face_hair" ‚Üí "üíá –ü—Ä–∏—á—ë—Å–∫–∞"
    "face_makeup" ‚Üí "üíÑ –ú–∞–∫–∏—è–∂"
    "face_swap" ‚Üí "üîÑ –ó–∞–º–µ–Ω–∞ –ª–∏—Ü–∞"
    "color_correction" ‚Üí "üåà –¶–≤–µ—Ç–æ–∫–æ—Ä—Ä–µ–∫—Ü–∏—è"
    _ ‚Üí tool

enhance_type_label(enhance_type):
  case enhance_type:
    "upscale_x" ‚Üí "–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ —É–≤–µ–ª–∏—á–µ–Ω–æ –≤ 2 —Ä–∞–∑–∞"
    "upscale_x" ‚Üí "–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ —É–≤–µ–ª–∏—á–µ–Ω–æ –≤ 4 —Ä–∞–∑–∞"
    "sharpen" ‚Üí "–†–µ–∑–∫–æ—Å—Ç—å –ø–æ–≤—ã—à–µ–Ω–∞"
    "denoise" ‚Üí "–®—É–º —É–¥–∞–ª—ë–Ω"
    "auto_enhance" ‚Üí "–ê–≤—Ç–æ-—É–ª—É—á—à–µ–Ω–∏–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–æ"
    _ ‚Üí "–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"

face_op_label(face_op):
  case face_op:
    "retouch" ‚Üí "–†–µ—Ç—É—à—å –ø—Ä–∏–º–µ–Ω–µ–Ω–∞"
    "expression" ‚Üí "–í—ã—Ä–∞–∂–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–æ"
    "age" ‚Üí "–í–æ–∑—Ä–∞—Å—Ç –∏–∑–º–µ–Ω—ë–Ω"
    "hair" ‚Üí "–ü—Ä–∏—á—ë—Å–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∞"
    "makeup" ‚Üí "–ú–∞–∫–∏—è–∂ –ø—Ä–∏–º–µ–Ω—ë–Ω"
    "swap" ‚Üí "–õ–∏—Ü–æ –∑–∞–º–µ–Ω–µ–Ω–æ"
    _ ‚Üí "–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"

cache(5m)
get_background_library():
  [
    { id: "beach", name: "–ü–ª—è–∂", emoji: "üèñÔ∏è", url: "https://..." },
    { id: "city", name: "–ì–æ—Ä–æ–¥", emoji: "üèôÔ∏è", url: "https://..." },
    { id: "nature", name: "–ü—Ä–∏—Ä–æ–¥–∞", emoji: "üå≤", url: "https://..." },
    { id: "office", name: "–û—Ñ–∏—Å", emoji: "üè¢", url: "https://..." },
    { id: "studio", name: "–°—Ç—É–¥–∏—è", emoji: "üì∑", url: "https://..." },
    { id: "abstract", name: "–ê–±—Å—Ç—Ä–∞–∫—Ü–∏—è", emoji: "üé®", url: "https://..." }
  ]

# v8.0

# v10.0 - ML-Powered Migration
