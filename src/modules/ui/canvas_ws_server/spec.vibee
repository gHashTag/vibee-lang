name: canvas_ws_server
plugin:
  name: canvas_ws_server
  version: 1.0.0
  category: ui
  description: WebSocket server for real-time BEAM â†” Browser communication in Canvas UI

behaviors:
  - name: websocket_connection
    given: Browser connects to WebSocket endpoint
    when: Connection is established
    then: Server sends initial state and starts listening for messages

  - name: layout_update
    given: YogaLayout calculates new coordinates
    when: Layout changes
    then: Server broadcasts update to all connected clients

  - name: pixel_update
    given: Pixel Grid processes update
    when: Pixel state changes
    then: Server sends delta update to browser

  - name: diffusion_frame
    given: BEAM Pixel Diffusion generates new frame
    when: Frame is ready
    then: Server streams frame data to browser

  - name: browser_event
    given: Browser sends user interaction
    when: Click, hover, or keyboard event occurs
    then: Server routes event to appropriate handler

functions:
  - name: start_server
    signature: "start_server(port: Int) -> Result(Subject(Message), String)"
    description: Start WebSocket server on specified port

  - name: broadcast_layout
    signature: "broadcast_layout(layout: Layout) -> Nil"
    description: Broadcast layout update to all connected clients

  - name: send_pixel_delta
    signature: "send_pixel_delta(client: Client, delta: PixelDelta) -> Nil"
    description: Send pixel state delta to specific client

  - name: stream_frame
    signature: "stream_frame(frame: Frame) -> Nil"
    description: Stream diffusion frame to all clients

  - name: handle_browser_event
    signature: "handle_browser_event(event: BrowserEvent) -> Result(Nil, String)"
    description: Handle incoming browser event

types:
  - name: Message
    description: WebSocket server messages
    fields:
      - name: Connect
        type: "Client"
      - name: Disconnect
        type: "Client"
      - name: BrowserEvent
        type: "BrowserEvent"
      - name: BroadcastLayout
        type: "Layout"
      - name: SendPixelDelta
        type: "#(Client, PixelDelta)"
      - name: StreamFrame
        type: "Frame"

  - name: Client
    description: Connected browser client
    fields:
      - name: id
        type: String
      - name: subject
        type: "Subject(String)"
      - name: viewport
        type: "Viewport"

  - name: BrowserEvent
    description: Event from browser
    fields:
      - name: type
        type: String
      - name: x
        type: Int
      - name: y
        type: Int
      - name: data
        type: "Dict(String, String)"

  - name: Layout
    description: YogaLayout result
    fields:
      - name: nodes
        type: "List(LayoutNode)"
      - name: timestamp
        type: Int

  - name: LayoutNode
    description: Single layout node
    fields:
      - name: id
        type: String
      - name: x
        type: Float
      - name: y
        type: Float
      - name: width
        type: Float
      - name: height
        type: Float

  - name: PixelDelta
    description: Pixel state change
    fields:
      - name: x
        type: Int
      - name: y
        type: Int
      - name: color
        type: "Color"

  - name: Frame
    description: Diffusion frame
    fields:
      - name: pixels
        type: "List(PixelDelta)"
      - name: timestamp
        type: Int

  - name: Viewport
    description: Browser viewport
    fields:
      - name: width
        type: Int
      - name: height
        type: Int

  - name: Color
    description: RGB color
    fields:
      - name: r
        type: Int
      - name: g
        type: Int
      - name: b
        type: Int
