name: shell
# Shell Page - Единая страница-оболочка для всех плагинов

module: honeycomb/ui/shell
version: 1.0.0
description: Главная страница с Canvas, sidebar плагинов, документацией и настройками

functions:
  # Генерация HTML страницы
  shell_page:
    params: []
    returns: String
    description: Возвращает HTML единой страницы-оболочки
    implementation: |
      "<!DOCTYPE html>
      <html lang=\"en\">
      <head>
        <meta charset=\"UTF-8\">
        <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">
        <title>VIBEE Plugin Shell</title>
        <link rel=\"preconnect\" href=\"https://fonts.googleapis.com\">
        <link rel=\"preconnect\" href=\"https://fonts.gstatic.com\" crossorigin>
        <link href=\"https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800;900&display=swap\" rel=\"stylesheet\">
        <style>
          * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Montserrat', -apple-system, BlinkMacSystemFont, sans-serif;
          }
          
          body {
            display: flex;
            height: 100vh;
            background: #000;
            color: #fff;
            overflow: hidden;
          }
          
          /* Sidebar */
          #sidebar {
            width: 300px;
            background: linear-gradient(180deg, #111 0%, #0a0a0a 100%);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
          }
          
          #sidebar header {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
          }
          
          #sidebar h1 {
            font-size: 24px;
            font-weight: 700;
            background: linear-gradient(135deg, #6366f1, #a855f7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 15px;
          }
          
          #search {
            width: 100%;
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: #fff;
            font-size: 14px;
            outline: none;
            transition: all 0.3s;
          }
          
          #search:focus {
            background: rgba(255, 255, 255, 0.08);
            border-color: #6366f1;
          }
          
          #categories {
            padding: 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
          }
          
          #categories button {
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            color: #fff;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
          }
          
          #categories button:hover,
          #categories button.active {
            background: #6366f1;
            border-color: #6366f1;
          }
          
          #plugin-list {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
          }
          
          .plugin-item {
            padding: 15px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
          }
          
          .plugin-item:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: #6366f1;
            transform: translateX(5px);
          }
          
          .plugin-item.active {
            background: rgba(99, 102, 241, 0.1);
            border-color: #6366f1;
          }
          
          .plugin-item h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 5px;
          }
          
          .plugin-item p {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 10px;
          }
          
          .plugin-item .buttons {
            display: flex;
            gap: 8px;
          }
          
          .plugin-item button {
            padding: 5px 10px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            color: #fff;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.3s;
          }
          
          .plugin-item button:hover {
            background: #6366f1;
            border-color: #6366f1;
          }
          
          .plugin-status {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            margin-left: 8px;
          }
          
          .plugin-status.loaded {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
          }
          
          .plugin-status.not-loaded {
            background: rgba(156, 163, 175, 0.2);
            color: #9ca3af;
          }
          
          /* Canvas Container */
          #canvas-container {
            flex: 1;
            position: relative;
            overflow: hidden;
          }
          
          canvas {
            width: 100%;
            height: 100%;
            display: block;
          }
          
          /* Controls */
          #controls {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 10;
          }
          
          #controls button {
            width: 40px;
            height: 40px;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: #fff;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s;
          }
          
          #controls button:hover {
            background: #6366f1;
            border-color: #6366f1;
            transform: scale(1.1);
          }
          
          /* Documentation Panel */
          #docs-panel {
            position: absolute;
            top: 0;
            right: 0;
            width: 500px;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(20px);
            border-left: 1px solid rgba(255, 255, 255, 0.1);
            transform: translateX(100%);
            transition: transform 0.3s;
            z-index: 20;
            display: flex;
            flex-direction: column;
          }
          
          #docs-panel.visible {
            transform: translateX(0);
          }
          
          #docs-panel header {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
          }
          
          #docs-panel h2 {
            font-size: 20px;
            font-weight: 600;
          }
          
          #close-docs {
            width: 30px;
            height: 30px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 6px;
            color: #fff;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s;
          }
          
          #close-docs:hover {
            background: rgba(239, 68, 68, 0.8);
          }
          
          #docs-nav {
            padding: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
          }
          
          #docs-nav a {
            padding: 5px 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
            color: #6366f1;
            text-decoration: none;
            font-size: 12px;
            transition: all 0.3s;
          }
          
          #docs-nav a:hover {
            background: rgba(99, 102, 241, 0.2);
          }
          
          #docs-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            line-height: 1.6;
          }
          
          #docs-content h1 { font-size: 28px; margin: 20px 0 10px; }
          #docs-content h2 { font-size: 24px; margin: 18px 0 8px; }
          #docs-content h3 { font-size: 20px; margin: 16px 0 6px; }
          #docs-content p { margin: 10px 0; color: rgba(255, 255, 255, 0.8); }
          #docs-content code {
            padding: 2px 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
          }
          #docs-content pre {
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            overflow-x: auto;
            margin: 15px 0;
          }
          #docs-content pre code {
            padding: 0;
            background: none;
          }
          
          /* Settings Panel */
          #settings-panel {
            position: absolute;
            top: 0;
            right: 0;
            width: 400px;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(20px);
            border-left: 1px solid rgba(255, 255, 255, 0.1);
            transform: translateX(100%);
            transition: transform 0.3s;
            z-index: 20;
            display: flex;
            flex-direction: column;
          }
          
          #settings-panel.visible {
            transform: translateX(0);
          }
          
          #settings-panel header {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
          }
          
          #settings-form {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
          }
          
          #settings-form label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            font-weight: 500;
          }
          
          #settings-form input,
          #settings-form select,
          #settings-form textarea {
            width: 100%;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            color: #fff;
            font-size: 14px;
            margin-bottom: 15px;
            outline: none;
          }
          
          #settings-form input:focus,
          #settings-form select:focus,
          #settings-form textarea:focus {
            border-color: #6366f1;
          }
          
          #settings-panel footer {
            padding: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            gap: 10px;
          }
          
          #settings-panel footer button {
            flex: 1;
            padding: 10px;
            background: #6366f1;
            border: none;
            border-radius: 6px;
            color: #fff;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
          }
          
          #settings-panel footer button:hover {
            background: #4f46e5;
          }
          
          #settings-panel footer button:last-child {
            background: rgba(255, 255, 255, 0.1);
          }
          
          #settings-panel footer button:last-child:hover {
            background: rgba(255, 255, 255, 0.15);
          }
          
          /* Scrollbar */
          ::-webkit-scrollbar {
            width: 8px;
          }
          
          ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
          }
          
          ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
          }
          
          ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
          }
          
          .hidden {
            display: none !important;
          }
        </style>
      </head>
      <body>
        <!-- Sidebar -->
        <aside id=\"sidebar\">
          <header>
            <h1>VIBEE Plugins</h1>
            <input type=\"search\" id=\"search\" placeholder=\"Search plugins...\">
          </header>
          
          <nav id=\"categories\">
            <button class=\"active\" data-category=\"all\">All</button>
            <button data-category=\"visualization\">Visualization</button>
            <button data-category=\"communication\">Communication</button>
            <button data-category=\"ai\">AI</button>
            <button data-category=\"payment\">Payment</button>
            <button data-category=\"analytics\">Analytics</button>
            <button data-category=\"development\">Development</button>
            <button data-category=\"utility\">Utility</button>
          </nav>
          
          <div id=\"plugin-list\"></div>
        </aside>
        
        <!-- Main Canvas Area -->
        <main id=\"canvas-container\">
          <canvas id=\"canvas\"></canvas>
          
          <!-- Overlay controls -->
          <div id=\"controls\">
            <button id=\"zoom-in\" title=\"Zoom In\">+</button>
            <button id=\"zoom-out\" title=\"Zoom Out\">−</button>
            <button id=\"reset-view\" title=\"Reset View\">⟲</button>
            <button id=\"toggle-grid\" title=\"Toggle Grid\">⊞</button>
          </div>
        </main>
        
        <!-- Documentation Panel -->
        <aside id=\"docs-panel\" class=\"hidden\">
          <header>
            <h2 id=\"docs-title\">Documentation</h2>
            <button id=\"close-docs\">×</button>
          </header>
          <nav id=\"docs-nav\"></nav>
          <article id=\"docs-content\"></article>
        </aside>
        
        <!-- Settings Panel -->
        <aside id=\"settings-panel\" class=\"hidden\">
          <header>
            <h2 id=\"settings-title\">Settings</h2>
            <button id=\"close-settings\">×</button>
          </header>
          <form id=\"settings-form\"></form>
          <footer>
            <button id=\"save-settings\">Save</button>
            <button id=\"reset-settings\">Reset</button>
          </footer>
        </aside>
        
        <script src=\"/assets/shell.js\"></script>
      </body>
      </html>"
  
  # JavaScript для Shell
  shell_js:
    params: []
    returns: String
    description: Возвращает JavaScript код для Shell
    implementation: |
      "// VIBEE Plugin Shell - Client-side JavaScript
      
      const canvas = document.getElementById('canvas');
      const ctx = canvas.getContext('2d');
      let width, height, scale;
      let plugins = [];
      let activePlugin = null;
      let zoom = 1.0;
      let panX = 0, panY = 0;
      let showGrid = false;
      
      // WebSocket connection to BEAM
      const ws = new WebSocket('ws://' + window.location.host + '/ws');
      
      ws.onopen = () => {
        console.log('Connected to BEAM');
        loadPlugins();
      };
      
      ws.onmessage = (event) => {
        const msg = JSON.parse(event.data);
        handleMessage(msg);
      };
      
      ws.onerror = (error) => {
        console.error('WebSocket error:', error);
      };
      
      // Resize canvas
      function resize() {
        scale = window.devicePixelRatio || 1;
        width = canvas.clientWidth;
        height = canvas.clientHeight;
        
        canvas.width = width * scale;
        canvas.height = height * scale;
        
        ctx.setTransform(1, 0, 0, 1, 0, 0);
        ctx.scale(scale, scale);
        
        render();
      }
      
      window.addEventListener('resize', resize);
      resize();
      
      // Load plugins from server
      async function loadPlugins() {
        const res = await fetch('/api/plugins');
        plugins = await res.json();
        renderPluginList(plugins);
        requestLayout();
      }
      
      // Render plugin list in sidebar
      function renderPluginList(pluginList) {
        const list = document.getElementById('plugin-list');
        list.innerHTML = pluginList.map(p => `
          <div class=\"plugin-item\" data-id=\"${p.manifest.id}\">
            <h3>
              ${p.manifest.name}
              <span class=\"plugin-status ${p.status === 'Loaded' ? 'loaded' : 'not-loaded'}\">
                ${p.status}
              </span>
            </h3>
            <p>${p.manifest.description}</p>
            <div class=\"buttons\">
              <button onclick=\"showDocs('${p.manifest.id}')\">Docs</button>
              <button onclick=\"showSettings('${p.manifest.id}')\">Settings</button>
              <button onclick=\"togglePlugin('${p.manifest.id}')\">
                ${p.status === 'Loaded' ? 'Unload' : 'Load'}
              </button>
            </div>
          </div>
        `).join('');
      }
      
      // Request layout calculation from BEAM
      function requestLayout() {
        ws.send(JSON.stringify({
          type: 'calculate_layout',
          viewport: { width, height, scale },
        }));
      }
      
      // Handle messages from BEAM
      function handleMessage(msg) {
        switch(msg.type) {
          case 'layout_update':
            renderLayout(msg.layout);
            break;
          case 'pixel_update':
            updatePixels(msg.pixels);
            break;
          case 'plugin_loaded':
            console.log('Plugin loaded:', msg.plugin_id);
            loadPlugins();
            break;
          case 'plugin_unloaded':
            console.log('Plugin unloaded:', msg.plugin_id);
            loadPlugins();
            break;
        }
      }
      
      // Render layout on canvas
      function renderLayout(layout) {
        ctx.clearRect(0, 0, width, height);
        
        // Apply zoom and pan
        ctx.save();
        ctx.translate(panX, panY);
        ctx.scale(zoom, zoom);
        
        // Draw grid if enabled
        if (showGrid) {
          drawGrid();
        }
        
        // Render each plugin widget
        layout.nodes.forEach(node => {
          const plugin = plugins.find(p => p.manifest.id === node.plugin_id);
          if (plugin && plugin.status === 'Loaded') {
            renderPlugin(plugin, node);
          }
        });
        
        ctx.restore();
      }
      
      // Draw grid
      function drawGrid() {
        ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
        ctx.lineWidth = 1;
        
        const gridSize = 50;
        
        for (let x = 0; x < width; x += gridSize) {
          ctx.beginPath();
          ctx.moveTo(x, 0);
          ctx.lineTo(x, height);
          ctx.stroke();
        }
        
        for (let y = 0; y < height; y += gridSize) {
          ctx.beginPath();
          ctx.moveTo(0, y);
          ctx.lineTo(width, y);
          ctx.stroke();
        }
      }
      
      // Render plugin widget
      function renderPlugin(plugin, node) {
        // Request render commands from BEAM
        ws.send(JSON.stringify({
          type: 'render_plugin',
          plugin_id: plugin.manifest.id,
          context: {
            x: node.x,
            y: node.y,
            width: node.width,
            height: node.height,
            scale,
            time: Date.now() / 1000,
            viewport: { width, height, scale },
            focused: activePlugin === plugin.manifest.id,
            hovered: false,
          },
        }));
      }
      
      // Show documentation
      async function showDocs(pluginId) {
        const plugin = plugins.find(p => p.manifest.id === pluginId);
        if (!plugin) return;
        
        const res = await fetch(`/api/plugins/${pluginId}/docs`);
        const html = await res.text();
        
        document.getElementById('docs-title').textContent = plugin.manifest.name;
        document.getElementById('docs-content').innerHTML = html;
        document.getElementById('docs-panel').classList.remove('hidden');
        document.getElementById('settings-panel').classList.add('hidden');
      }
      
      // Show settings
      async function showSettings(pluginId) {
        const plugin = plugins.find(p => p.manifest.id === pluginId);
        if (!plugin) return;
        
        document.getElementById('settings-title').textContent = plugin.manifest.name + ' Settings';
        
        // TODO: Generate form from config schema
        document.getElementById('settings-form').innerHTML = `
          <label>Example Setting</label>
          <input type=\"text\" value=\"Example value\">
        `;
        
        document.getElementById('settings-panel').classList.remove('hidden');
        document.getElementById('docs-panel').classList.add('hidden');
      }
      
      // Toggle plugin load/unload
      async function togglePlugin(pluginId) {
        const plugin = plugins.find(p => p.manifest.id === pluginId);
        if (!plugin) return;
        
        const action = plugin.status === 'Loaded' ? 'unload' : 'load';
        
        const res = await fetch(`/api/plugins/${pluginId}/${action}`, {
          method: 'POST',
        });
        
        if (res.ok) {
          loadPlugins();
        }
      }
      
      // Search plugins
      document.getElementById('search').addEventListener('input', (e) => {
        const query = e.target.value.toLowerCase();
        const filtered = plugins.filter(p => 
          p.manifest.name.toLowerCase().includes(query) ||
          p.manifest.description.toLowerCase().includes(query) ||
          p.manifest.tags.some(t => t.toLowerCase().includes(query))
        );
        renderPluginList(filtered);
      });
      
      // Category filter
      document.querySelectorAll('#categories button').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('#categories button').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          
          const category = btn.dataset.category;
          const filtered = category === 'all' 
            ? plugins 
            : plugins.filter(p => p.manifest.category.toLowerCase() === category);
          
          renderPluginList(filtered);
        });
      });
      
      // Controls
      document.getElementById('zoom-in').addEventListener('click', () => {
        zoom *= 1.2;
        render();
      });
      
      document.getElementById('zoom-out').addEventListener('click', () => {
        zoom /= 1.2;
        render();
      });
      
      document.getElementById('reset-view').addEventListener('click', () => {
        zoom = 1.0;
        panX = 0;
        panY = 0;
        render();
      });
      
      document.getElementById('toggle-grid').addEventListener('click', () => {
        showGrid = !showGrid;
        render();
      });
      
      // Close panels
      document.getElementById('close-docs').addEventListener('click', () => {
        document.getElementById('docs-panel').classList.add('hidden');
      });
      
      document.getElementById('close-settings').addEventListener('click', () => {
        document.getElementById('settings-panel').classList.add('hidden');
      });
      
      // Canvas events
      canvas.addEventListener('click', (e) => {
        const rect = canvas.getBoundingClientRect();
        const x = (e.clientX - rect.left - panX) / zoom;
        const y = (e.clientY - rect.top - panY) / zoom;
        
        ws.send(JSON.stringify({
          type: 'canvas_click',
          x, y,
        }));
      });
      
      canvas.addEventListener('mousemove', (e) => {
        const rect = canvas.getBoundingClientRect();
        const x = (e.clientX - rect.left - panX) / zoom;
        const y = (e.clientY - rect.top - panY) / zoom;
        
        ws.send(JSON.stringify({
          type: 'canvas_mousemove',
          x, y,
        }));
      });
      
      // Render loop
      function render() {
        requestLayout();
      }
      
      // Start render loop
      setInterval(render, 1000 / 60);  // 60 FPS
      "

dependencies:
  - gleam_stdlib

imports:
  - gleam/string

tests:
  - name: generate_shell_page
    description: Генерация HTML страницы
    test: |
      let html = shell_page()
      string.contains(html, "VIBEE Plugin Shell")
  
  - name: generate_shell_js
    description: Генерация JavaScript
    test: |
      let js = shell_js()
      string.contains(js, "WebSocket")
