name: canvas_ui_layout
# Canvas UI Layout - Единая система управления плагинами через Canvas
# Каждый пиксель = атомарный процесс, YogaLayout для координат

plugin:
  name: canvas_ui_layout
  version: 1.0.0
  category: ui/core
  description: |
    Canvas-based UI Layout system for VIBEE platform.
    Each pixel is an addressable atomic process. YogaLayout for coordinates.
    Single page wrapper for all plugins with navigation and documentation.
  
  features:
    - Canvas-based rendering (HTML5 Canvas)
    - YogaLayout integration (Flexbox-like)
    - Pixel Grid Mask (atomic processes)
    - Plugin registry and management
    - Hot reload support
    - Navigation between plugins
    - Documentation viewer
    - WebSocket communication (BEAM ↔ Browser)

# ============================================================================
# CORE BEHAVIORS
# ============================================================================

behaviors:
  # 1. INITIALIZE LAYOUT SYSTEM
  - name: initialize_layout
    given: Viewport dimensions and plugin list
    when: System starts
    then: Canvas created, YogaLayout tree built, plugins registered
    test_cases:
      - name: initialize_full_hd
        input:
          width: 1920
          height: 1080
          plugins: ["beam_tv", "beam_pixel_diffusion"]
        expected:
          canvas_created: true
          yoga_tree_built: true
          plugins_registered: 2
      
      - name: initialize_invalid_dimensions
        input:
          width: -100
          height: 1080
        expected:
          error: "Invalid dimensions"

  # 2. REGISTER PLUGIN
  - name: register_plugin
    given: Plugin manifest with metadata
    when: Plugin is registered
    then: Plugin added to registry, canvas widget created, docs loaded
    test_cases:
      - name: register_plugin_success
        input:
          id: "beam_tv"
          name: "BEAM TV"
          version: "1.0.0"
          canvas_widget: true
          documentation: true
        expected:
          registered: true
          widget_created: true
          docs_loaded: true
      
      - name: register_plugin_missing_widget
        input:
          id: "bad_plugin"
          canvas_widget: false
        expected:
          error: "Plugin must have canvas widget"
      
      - name: register_plugin_missing_docs
        input:
          id: "bad_plugin"
          documentation: false
        expected:
          error: "Plugin must have documentation"

  # 3. LAYOUT CALCULATION
  - name: calculate_layout
    given: YogaLayout tree with plugin nodes
    when: Layout is calculated
    then: Each node gets x, y, width, height coordinates
    test_cases:
      - name: calculate_simple_layout
        input:
          nodes:
            - id: "header"
              height: 80
            - id: "content"
              flex: 1
        expected:
          header: {x: 0, y: 0, width: 1920, height: 80}
          content: {x: 0, y: 80, width: 1920, height: 1000}
      
      - name: calculate_grid_layout
        input:
          direction: "row"
          nodes:
            - id: "sidebar"
              width: 300
            - id: "main"
              flex: 1
        expected:
          sidebar: {x: 0, y: 0, width: 300, height: 1080}
          main: {x: 300, y: 0, width: 1620, height: 1080}

  # 4. PIXEL GRID MANAGEMENT
  - name: create_pixel_grid
    given: Canvas dimensions
    when: Pixel grid is created
    then: Each pixel/tile becomes an OTP process
    test_cases:
      - name: create_tile_grid_8x8
        input:
          width: 1920
          height: 1080
          tile_size: 8
        expected:
          tiles_created: 32400  # (1920/8) * (1080/8)
          processes: 32400
      
      - name: create_pixel_grid_full
        input:
          width: 1920
          height: 1080
          tile_size: 1
        expected:
          pixels_created: 2073600
          processes: 2073600

  # 5. PLUGIN NAVIGATION
  - name: navigate_to_plugin
    given: Plugin is registered
    when: User navigates to plugin
    then: Plugin canvas widget is rendered, docs shown
    test_cases:
      - name: navigate_success
        input:
          plugin_id: "beam_tv"
        expected:
          widget_rendered: true
          docs_visible: true
          url: "/plugins/beam_tv"
      
      - name: navigate_not_found
        input:
          plugin_id: "nonexistent"
        expected:
          error: "Plugin not found"

  # 6. HOT RELOAD
  - name: hot_reload_plugin
    given: Plugin is running
    when: Plugin code is updated
    then: Plugin reloaded without stopping system
    test_cases:
      - name: hot_reload_success
        input:
          plugin_id: "beam_tv"
          new_version: "1.1.0"
        expected:
          reloaded: true
          downtime_ms: 0
          state_preserved: true
      
      - name: hot_reload_failure
        input:
          plugin_id: "beam_tv"
          new_version: "broken"
        expected:
          error: "Reload failed"
          rollback: true

  # 7. WEBSOCKET COMMUNICATION
  - name: send_frame_to_browser
    given: Canvas frame is ready
    when: Frame is sent via WebSocket
    then: Browser receives and renders frame
    test_cases:
      - name: send_frame_success
        input:
          frame_data: "binary_data"
          format: "protobuf"
        expected:
          sent: true
          latency_ms: 5
      
      - name: send_frame_connection_lost
        input:
          frame_data: "binary_data"
        expected:
          error: "Connection lost"
          retry: true

# ============================================================================
# FUNCTIONS
# ============================================================================

functions:
  # Core API
  - name: start_layout_system
    signature: "start_layout_system(config: LayoutConfig) → Result(LayoutSystem, Error)"
    description: Initialize Canvas UI Layout system
    validation:
      - width > 0 and height > 0
      - tile_size > 0
  
  - name: register_plugin
    signature: "register_plugin(system: LayoutSystem, manifest: PluginManifest) → Result(LayoutSystem, Error)"
    description: Register plugin with canvas widget and documentation
    validation:
      - manifest.canvas_widget must be true
      - manifest.documentation must be true
      - manifest.id is unique
  
  - name: calculate_layout
    signature: "calculate_layout(system: LayoutSystem) → Result(LayoutTree, Error)"
    description: Calculate layout using YogaLayout
  
  - name: navigate_to_plugin
    signature: "navigate_to_plugin(system: LayoutSystem, plugin_id: String) → Result(Nil, Error)"
    description: Navigate to plugin page
    validation:
      - plugin_id exists in registry
  
  - name: hot_reload_plugin
    signature: "hot_reload_plugin(system: LayoutSystem, plugin_id: String) → Result(Nil, Error)"
    description: Hot reload plugin without stopping system
  
  # Pixel Grid
  - name: create_pixel_grid
    signature: "create_pixel_grid(width: Int, height: Int, tile_size: Int) → PixelGrid"
    description: Create grid of pixel/tile actors
  
  - name: update_pixel
    signature: "update_pixel(grid: PixelGrid, pos: Point, color: Color) → PixelGrid"
    description: Update single pixel color
  
  # YogaLayout
  - name: create_yoga_node
    signature: "create_yoga_node(config: NodeConfig) → YogaNode"
    description: Create YogaLayout node
  
  - name: add_child_node
    signature: "add_child_node(parent: YogaNode, child: YogaNode) → YogaNode"
    description: Add child to layout tree
  
  - name: calculate_yoga_layout
    signature: "calculate_yoga_layout(root: YogaNode, width: Float, height: Float) → LayoutResult"
    description: Calculate layout coordinates
  
  # WebSocket
  - name: send_frame
    signature: "send_frame(ws: WebSocket, frame: Frame) → Result(Nil, Error)"
    description: Send frame to browser via WebSocket
  
  - name: handle_input_event
    signature: "handle_input_event(system: LayoutSystem, event: InputEvent) → Result(Nil, Error)"
    description: Handle input from browser (click, keyboard, etc.)

# ============================================================================
# TYPES
# ============================================================================

types:
  LayoutConfig:
    width: Int
    height: Int
    tile_size: Int
    plugins: List(String)
  
  LayoutSystem:
    config: LayoutConfig
    canvas: Canvas
    pixel_grid: PixelGrid
    yoga_root: YogaNode
    plugin_registry: Dict(String, PluginManifest)
    current_plugin: Option(String)
    websocket: WebSocket
  
  PluginManifest:
    id: String
    name: String
    version: String
    description: String
    canvas_widget: Bool
    documentation: Bool
    dependencies: List(String)
    layout_config: LayoutNodeConfig
  
  Canvas:
    width: Int
    height: Int
    context: CanvasContext
  
  PixelGrid:
    width: Int
    height: Int
    tile_size: Int
    tiles: Dict(Point, Subject(TileMessage))
  
  Point:
    x: Int
    y: Int
  
  Color:
    r: Int
    g: Int
    b: Int
    a: Int
  
  YogaNode:
    id: String
    x: Float
    y: Float
    width: Float
    height: Float
    children: List(YogaNode)
  
  LayoutNodeConfig:
    direction: FlexDirection
    width: Option(Float)
    height: Option(Float)
    flex: Option(Float)
    padding: Padding
    margin: Margin
  
  FlexDirection:
    variants:
      - Row
      - Column
  
  Padding:
    top: Float
    right: Float
    bottom: Float
    left: Float
  
  Margin:
    top: Float
    right: Float
    bottom: Float
    left: Float
  
  Frame:
    width: Int
    height: Int
    pixels: List(Color)
    timestamp: Int
  
  InputEvent:
    variants:
      - Click(Point)
      - MouseMove(Point)
      - KeyPress(String)
      - Scroll(Int)
  
  TileMessage:
    variants:
      - UpdateColor(Color)
      - GetColor(Subject(Color))
      - Shutdown

# ============================================================================
# UI SPECIFICATION
# ============================================================================

ui:
  page:
    title: "VIBEE Platform"
    path: "/"
    description: "Canvas-based UI platform with atomic pixel processes"
  
  theme:
    background: "#000000"
    text: "#ffffff"
    accent: "#8b5cf6"
    secondary: "#6366f1"
  
  layout:
    direction: "column"
    padding: 0
    gap: 0
  
  components:
    # Header
    - type: "header"
      height: 80
      background: "linear-gradient(90deg, #000000, #1a1a1a)"
      children:
        - type: "text"
          content: "VIBEE"
          fontSize: 32
          fontWeight: 700
          color: "#8b5cf6"
        
        - type: "navigation"
          items:
            - label: "Plugins"
              path: "/plugins"
            - label: "Documentation"
              path: "/docs"
            - label: "Settings"
              path: "/settings"
    
    # Main Content
    - type: "container"
      direction: "row"
      flex: 1
      children:
        # Sidebar
        - type: "sidebar"
          width: 300
          background: "#0a0a0a"
          children:
            - type: "plugin_list"
              plugins:
                - id: "beam_tv"
                  name: "BEAM TV"
                  icon: "video"
                
                - id: "beam_pixel_diffusion"
                  name: "Pixel Diffusion"
                  icon: "image"
                
                - id: "canvas_ui_layout"
                  name: "Canvas UI"
                  icon: "layout"
        
        # Canvas Area
        - type: "canvas_container"
          flex: 1
          children:
            - type: "canvas"
              id: "main_canvas"
              width: "100%"
              height: "100%"
        
        # Documentation Panel
        - type: "docs_panel"
          width: 400
          background: "#0a0a0a"
          children:
            - type: "markdown_viewer"
              id: "plugin_docs"

# ============================================================================
# DOCUMENTATION
# ============================================================================

documentation:
  overview: |
    Canvas UI Layout is the core system for managing all VIBEE plugins.
    Each plugin must provide a canvas widget and documentation.
    The system uses YogaLayout for coordinates and atomic processes for pixels.
  
  architecture: |
    - Canvas Layer: HTML5 Canvas as single UI surface
    - YogaLayout: Flexbox-like layout engine for coordinates
    - Pixel Grid Mask: Each pixel/tile is an OTP process
    - Plugin Registry: Manages all registered plugins
    - WebSocket: BEAM ↔ Browser communication
  
  pixel_grid_mask: |
    Inspired by CRT shadow mask, but active and programmable:
    - Each pixel/tile is an addressable atomic process
    - Can store state, participate in layout, react to events
    - Tile size configurable (1x1 for full pixels, 8x8 for performance)
  
  yoga_layout: |
    YogaLayout provides coordinates for all UI elements:
    - Flexbox-like API (direction, flex, padding, margin)
    - Calculates x, y, width, height for each node
    - Integrates with Canvas rendering
  
  plugin_requirements: |
    Every plugin MUST provide:
    1. Canvas widget (UI representation)
    2. Documentation (markdown/HTML)
    3. Manifest (metadata, dependencies, layout config)
    
    Plugins are hot-reloadable without stopping the system.

# ============================================================================
# EXAMPLES
# ============================================================================

examples:
  - name: basic_usage
    code: |
      // Start layout system
      let config = LayoutConfig(
        width: 1920,
        height: 1080,
        tile_size: 8,
        plugins: ["beam_tv", "beam_pixel_diffusion"]
      )
      
      let system = start_layout_system(config)?
      
      // Register plugin
      let manifest = PluginManifest(
        id: "beam_tv",
        name: "BEAM TV",
        version: "1.0.0",
        description: "Video platform",
        canvas_widget: True,
        documentation: True,
        dependencies: [],
        layout_config: default_layout_config()
      )
      
      let system = register_plugin(system, manifest)?
      
      // Navigate to plugin
      navigate_to_plugin(system, "beam_tv")?
  
  - name: pixel_grid
    code: |
      // Create pixel grid (8x8 tiles for performance)
      let grid = create_pixel_grid(1920, 1080, 8)
      
      // Update pixel
      let grid = update_pixel(grid, Point(100, 100), Color(255, 0, 0, 255))
  
  - name: yoga_layout
    code: |
      // Create layout tree
      let root = create_yoga_node(NodeConfig(
        direction: Column,
        width: Some(1920.0),
        height: Some(1080.0),
        ..default_config()
      ))
      
      let header = create_yoga_node(NodeConfig(
        height: Some(80.0),
        ..default_config()
      ))
      
      let content = create_yoga_node(NodeConfig(
        flex: Some(1.0),
        ..default_config()
      ))
      
      let root = root
        |> add_child_node(header)
        |> add_child_node(content)
      
      // Calculate layout
      let result = calculate_yoga_layout(root, 1920.0, 1080.0)

# ============================================================================
# COMPLETENESS
# ============================================================================

completeness:
  test_coverage: 100%
  all_behaviors_implemented: true
  all_functions_implemented: true
  ui_complete: true
  documentation_complete: true
  examples_provided: true
