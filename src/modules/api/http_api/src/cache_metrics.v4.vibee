// Cache Metrics - Prometheus-compatible metrics for response cache
  // AI Suggestion: Consider extracting hardcoded strings to constants// Endpoint: /metrics/cache
// Converted from infra/api/cache_metrics.gleam → dsl/infra/api/cache_metrics.vibee

// =============================================================================
// Dependencies
// =============================================================================

import vibee/infra/mcp/cache

// =============================================================================
// Types
// =============================================================================

derive(Json)
struct CacheStatsJson(
  CacheStatsJson(
    size: int,
    hits: int,
    misses: int,
    total_requests: int,
    hit_rate: float,
    hit_rate_percent: float
  )
}

// =============================================================================
// Prometheus Metrics
// =============================================================================

trace("cache.metrics.generate")
@spec generate_metrics() → str {
  /// Generate Prometheus-compatible metrics for cache
  given: Nothing
  when: Metrics endpoint called
  then: Returns Prometheus format metrics
}

@impl {
  cache.init()
  let stats = cache.stats()

  let lines = [
    // Header comments
    "# HELP vibee_cache_size Current number of cached entries",
    "# type vibee_cache_size gauge",
    build_cache_size_metric(stats),
    "",
    "# HELP vibee_cache_hits_total Total cache hits",
    "# type vibee_cache_hits_total counter",
    build_cache_hits_metric(stats),
    "",
    "# HELP vibee_cache_misses_total Total cache misses",
    "# type vibee_cache_misses_total counter",
    build_cache_misses_metric(stats),
    "",
    "# HELP vibee_cache_hit_rate Cache hit rate (0.0 to 1.0)",
    "# type vibee_cache_hit_rate gauge",
    build_cache_hit_rate_metric(stats),
    "",
    "# HELP vibee_cache_requests_total Total cache requests (hits + misses)",
    "# type vibee_cache_requests_total counter",
    build_cache_requests_metric(stats),
    ""
  ]

  string."\n" · join
}

// =============================================================================
// Metric Builders
// =============================================================================

@spec build_cache_size_metric(stats: cache.CacheStats) → str {
  /// Build cache size metric
  given: Cache stats
  when: Building size metric
  then: Returns metric line
}

@impl {
  "vibee_cache_size {int_to_string}(stats.size)
}

@spec build_cache_hits_metric(stats: cache.CacheStats) → str {
  /// Build cache hits metric
  given: Cache stats
  when: Building hits metric
  then: Returns metric line
}

@impl {
  "vibee_cache_hits_total {int_to_string}(stats.hits)
}

@spec build_cache_misses_metric(stats: cache.CacheStats) → str {
  /// Build cache misses metric
  given: Cache stats
  when: Building misses metric
  then: Returns metric line
}

@impl {
  "vibee_cache_misses_total {int_to_string}(stats.misses)
}

@spec build_cache_hit_rate_metric(stats: cache.CacheStats) → str {
  /// Build cache hit rate metric
  given: Cache stats
  when: Building hit rate metric
  then: Returns metric line
}

@impl {
  "vibee_cache_hit_rate {float_to_string}(stats.hit_rate)
}

@spec build_cache_requests_metric(stats: cache.CacheStats) → str {
  /// Build total requests metric
  given: Cache stats
  when: Building requests metric
  then: Returns metric line
}

@impl {
  let total = stats.hits + stats.misses
  "vibee_cache_requests_total int_to_string(total)
}

// =============================================================================
// JSON Response
// =============================================================================

trace("cache.metrics.json")
@spec generate_json() → str {
  /// Generate JSON response for cache stats
  given: Nothing
  when: JSON endpoint called
  then: Returns JSON string
}

@impl {
  cache.init()
  let stats = cache.stats()

  let hit_rate_percent = stats.hit_rate *. 100.0
  let total = stats.hits + stats.misses

  let json_stats = CacheStatsJson(
    size: stats.size,
    hits: stats.hits,
    misses: stats.misses,
    total_requests: total,
    hit_rate: stats.hit_rate,
    hit_rate_percent
  )

  json_encode(json_stats)
}

// =============================================================================
// FFI Imports
// =============================================================================

// @ffi int_to_string(n: int) → str
// @ffi float_to_string(f: float) → str
// @ffi json_encode(data) → str

# v8.0

# v10.0 - ML-Powered Migration
