name: vibee_cicd
version: "1.0.0"
language: zig
module: cicd
description: VIBEE CI/CD Pipeline - Automated testing, building, and deployment

behaviors:
  - name: run_ci_pipeline
    given: Code pushed to repository
    when: CI pipeline triggered
    then: Tests run, code built, artifacts created
    test_cases:
      - name: successful_ci_run
        input: {commit: "abc123", branch: "main"}
        expected: {tests_passed: true, build_success: true, artifacts: 3}

  - name: run_tests_in_ci
    given: Test suite in repository
    when: CI runs tests
    then: All tests executed and results reported
    test_cases:
      - name: all_tests_pass
        input: {tests: 100}
        expected: {passed: 100, failed: 0, duration_ms: 5000}

  - name: build_release_artifacts
    given: Release tag created
    when: Release build triggered
    then: Binaries built for all platforms
    test_cases:
      - name: build_multi_platform
        input: {platforms: ["linux-x64", "macos-arm64", "windows-x64"]}
        expected: {built: 3, failed: 0}

  - name: publish_release
    given: Release artifacts built
    when: Publish triggered
    then: Release published to GitHub
    test_cases:
      - name: publish_v1_0_0
        input: {version: "1.0.0", artifacts: 3}
        expected: {published: true, url: "https://github.com/vibee-lang/vibee/releases/tag/v1.0.0"}

  - name: deploy_documentation
    given: Documentation updated
    when: Deploy docs triggered
    then: Docs deployed to website
    test_cases:
      - name: deploy_to_website
        input: {docs_dir: "docs/", target: "https://vibee-lang.org"}
        expected: {deployed: true, pages: 50}

  - name: run_benchmarks
    given: Performance benchmarks defined
    when: Benchmark CI runs
    then: Performance metrics collected
    test_cases:
      - name: measure_compile_speed
        input: {benchmark: "compile_hello_world"}
        expected: {time_ms: 54, passed: true}

  - name: check_code_quality
    given: Code in repository
    when: Quality checks run
    then: Linting and formatting verified
    test_cases:
      - name: lint_and_format
        input: {files: 100}
        expected: {lint_issues: 0, format_issues: 0}

  - name: security_scan
    given: Dependencies in project
    when: Security scan runs
    then: Vulnerabilities reported
    test_cases:
      - name: scan_dependencies
        input: {dependencies: 20}
        expected: {vulnerabilities: 0, severity: "none"}

types:
  CiPipeline:
    fields:
      name: string
      stages: array_CiStage
      triggers: array_CiTrigger
      environment: HashMap_string_string

  CiStage:
    fields:
      name: string
      jobs: array_CiJob
      depends_on: array_string

  CiJob:
    fields:
      name: string
      steps: array_CiStep
      platform: Platform
      timeout_minutes: usize

  CiStep:
    fields:
      name: string
      command: string
      working_dir: Option_string
      env: HashMap_string_string

  CiTrigger:
    variants:
      - Push: PushTrigger
      - PullRequest: PrTrigger
      - Schedule: ScheduleTrigger
      - Manual

  PushTrigger:
    fields:
      branches: array_string
      tags: array_string

  PrTrigger:
    fields:
      branches: array_string

  ScheduleTrigger:
    fields:
      cron: string

  Platform:
    variants:
      - LinuxX64
      - LinuxArm64
      - MacosX64
      - MacosArm64
      - WindowsX64

  CiResult:
    fields:
      success: bool
      duration_ms: i64
      tests_passed: usize
      tests_failed: usize
      artifacts: array_Artifact

  Artifact:
    fields:
      name: string
      path: string
      size_bytes: usize
      checksum: string

  Release:
    fields:
      version: string
      tag: string
      artifacts: array_Artifact
      changelog: string
      published_at: u64

  BenchmarkResult:
    fields:
      name: string
      time_ms: i64
      memory_mb: usize
      passed: bool
      baseline: Option_i64

functions:
  - name: create_pipeline
    params: {name: string, stages: array_CiStage}
    returns: Result_CiPipeline_Error
    description: Create CI/CD pipeline
    
  - name: run_pipeline
    params: {pipeline: CiPipeline, trigger: CiTrigger}
    returns: Result_CiResult_Error
    description: Execute CI/CD pipeline
    
  - name: run_tests
    params: {test_dir: string, parallel: bool}
    returns: Result_TestResult_Error
    description: Run test suite
    
  - name: build_release
    params: {version: string, platforms: array_Platform}
    returns: Result_array_Artifact_Error
    description: Build release artifacts
    
  - name: publish_release
    params: {release: Release, token: string}
    returns: Result_string_Error
    description: Publish release to GitHub
    
  - name: deploy_docs
    params: {docs_dir: string, target_url: string}
    returns: Result_void_Error
    description: Deploy documentation
    
  - name: run_benchmarks
    params: {benchmark_dir: string}
    returns: Result_array_BenchmarkResult_Error
    description: Run performance benchmarks
    
  - name: check_code_quality
    params: {source_dir: string}
    returns: Result_QualityReport_Error
    description: Check code quality
    
  - name: security_scan
    params: {project_dir: string}
    returns: Result_SecurityReport_Error
    description: Scan for security vulnerabilities
    
  - name: create_artifact
    params: {name: string, path: string}
    returns: Result_Artifact_Error
    description: Create build artifact
    
  - name: upload_artifact
    params: {artifact: Artifact, destination: string}
    returns: Result_void_Error
    description: Upload artifact to storage
    
  - name: download_artifact
    params: {name: string, version: string}
    returns: Result_Artifact_Error
    description: Download artifact from storage
    
  - name: generate_changelog
    params: {from_tag: string, to_tag: string}
    returns: Result_string_Error
    description: Generate changelog from git history
    
  - name: notify_status
    params: {status: CiStatus, webhook_url: string}
    returns: Result_void_Error
    description: Send CI status notification

pipeline_stages:
  - stage: test
    jobs:
      - name: unit_tests
        command: vibee test
        
      - name: integration_tests
        command: vibee test --integration
        
  - stage: build
    depends_on: [test]
    jobs:
      - name: build_linux
        platform: LinuxX64
        command: vibee build --release
        
      - name: build_macos
        platform: MacosArm64
        command: vibee build --release
        
      - name: build_windows
        platform: WindowsX64
        command: vibee build --release
        
  - stage: benchmark
    depends_on: [build]
    jobs:
      - name: performance_benchmarks
        command: vibee bench
        
  - stage: deploy
    depends_on: [build, benchmark]
    jobs:
      - name: publish_release
        command: vibee publish
        
      - name: deploy_docs
        command: vibee docs deploy

github_actions_config: |
  name: CI
  
  on:
    push:
      branches: [main]
    pull_request:
      branches: [main]
    release:
      types: [created]
  
  jobs:
    test:
      runs-on: ubuntu-latest
      steps:
        - uses: actions/checkout@v3
        - name: Install VIBEE
          run: curl -sSf https://vibee-lang.org/install.sh | sh
        - name: Run tests
          run: vibee test
          
    build:
      needs: test
      strategy:
        matrix:
          os: [ubuntu-latest, macos-latest, windows-latest]
      runs-on: ${{ matrix.os }}
      steps:
        - uses: actions/checkout@v3
        - name: Install VIBEE
          run: curl -sSf https://vibee-lang.org/install.sh | sh
        - name: Build release
          run: vibee build --release
        - name: Upload artifact
          uses: actions/upload-artifact@v3
          with:
            name: vibee-${{ matrix.os }}
            path: target/release/vibee*
            
    benchmark:
      needs: build
      runs-on: ubuntu-latest
      steps:
        - uses: actions/checkout@v3
        - name: Install VIBEE
          run: curl -sSf https://vibee-lang.org/install.sh | sh
        - name: Run benchmarks
          run: vibee bench
        - name: Compare with baseline
          run: vibee bench --compare baseline.json
          
    release:
      if: github.event_name == 'release'
      needs: [test, build, benchmark]
      runs-on: ubuntu-latest
      steps:
        - uses: actions/checkout@v3
        - name: Download artifacts
          uses: actions/download-artifact@v3
        - name: Publish release
          env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          run: |
            gh release upload ${{ github.ref_name }} \
              vibee-ubuntu-latest/* \
              vibee-macos-latest/* \
              vibee-windows-latest/*

imports:
  - std
  - core
  - collections
  - io
