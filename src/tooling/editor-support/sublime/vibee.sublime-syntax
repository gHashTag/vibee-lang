%YAML 1.2
---
# Sublime Text syntax definition for VIBEE DSL
# Install: Copy to ~/Library/Application Support/Sublime Text/Packages/User/
name: VIBEE
file_extensions:
  - vibee
  - vib
scope: source.vibee

variables:
  identifier: '[a-zA-Z_][a-zA-Z0-9_]*'

contexts:
  main:
    - include: comments
    - include: decorators
    - include: keywords
    - include: strings
    - include: numbers
    - include: operators
    - include: types
    - include: constants
    - include: functions

  comments:
    - match: '#.*$'
      scope: comment.line.number-sign.vibee
      captures:
        0: punctuation.definition.comment.vibee

  decorators:
    - match: '@(desc|spec|const|import|llm|fallback_models|retry|timeout|budget|ffi|one_of|range)\b'
      scope: storage.type.annotation.vibee
    - match: '@{{identifier}}'
      scope: entity.name.function.decorator.vibee
    - match: '@'
      scope: punctuation.definition.annotation.vibee

  keywords:
    # Definition keywords
    - match: '\b(tool|scene|fn|struct|agent|machine)\b'
      scope: storage.type.vibee
    # State machine keywords
    - match: '\b(on|enter|exit|callback|message|stay|transition|reply)\b'
      scope: keyword.control.vibee
    # Control flow
    - match: '\b(case|if|else|match)\b'
      scope: keyword.control.conditional.vibee
    # Import
    - match: '\b(as)\b'
      scope: keyword.control.import.vibee
    # Result types
    - match: '\b(Ok|Error|Some|None)\b'
      scope: support.type.vibee

  strings:
    # Multi-line strings
    - match: '"""'
      scope: punctuation.definition.string.begin.vibee
      push:
        - meta_scope: string.quoted.triple.vibee
        - match: '"""'
          scope: punctuation.definition.string.end.vibee
          pop: true
    # Regular strings
    - match: '"'
      scope: punctuation.definition.string.begin.vibee
      push:
        - meta_scope: string.quoted.double.vibee
        - match: '\\[nrt\\"'']'
          scope: constant.character.escape.vibee
        - match: '\$\{'
          scope: punctuation.section.interpolation.begin.vibee
          push:
            - meta_scope: meta.interpolation.vibee
            - match: '\}'
              scope: punctuation.section.interpolation.end.vibee
              pop: true
            - include: main
        - match: '"'
          scope: punctuation.definition.string.end.vibee
          pop: true

  numbers:
    - match: '\b\d+\.\d+\b'
      scope: constant.numeric.float.vibee
    - match: '\b\d+\b'
      scope: constant.numeric.integer.vibee

  operators:
    - match: '->'
      scope: keyword.operator.arrow.vibee
    - match: '\|>'
      scope: keyword.operator.pipe.vibee
    - match: '<>'
      scope: keyword.operator.concat.vibee
    - match: '==|!=|<=|>=|<|>'
      scope: keyword.operator.comparison.vibee
    - match: '&&|\|\|'
      scope: keyword.operator.logical.vibee
    - match: '[+\-*/%]'
      scope: keyword.operator.arithmetic.vibee
    - match: '='
      scope: keyword.operator.assignment.vibee
    - match: '!'
      scope: keyword.operator.logical.vibee

  types:
    - match: '\b(str|int|float|bool|list|map|any|nil|void)\b'
      scope: storage.type.primitive.vibee
    - match: '[!?]'
      scope: storage.modifier.vibee

  constants:
    - match: '\b(true|false)\b'
      scope: constant.language.boolean.vibee
    - match: '\bnil\b'
      scope: constant.language.null.vibee

  functions:
    # Built-in functions
    - match: '\b(print|read_line|length|to_string|parse_int|lowercase|uppercase)\b'
      scope: support.function.builtin.vibee
    - match: '\b(map|filter|reduce|each|enumerate|first|last|reverse|join|split)\b'
      scope: support.function.builtin.vibee
    - match: '\b(contains|starts_with|ends_with|replace|trim)\b'
      scope: support.function.builtin.vibee
    - match: '\b(now|sleep|random|generate_id)\b'
      scope: support.function.builtin.vibee
    # Function calls
    - match: '({{identifier}})\s*\('
      captures:
        1: entity.name.function.vibee
