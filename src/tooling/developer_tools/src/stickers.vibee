// Telegram Sticker Tools
  // Performance Warning:   // AI Suggestion: Use pipeline operator for better readability  // AI Suggestion: Consider extracting hardcoded strings to constants// Analyze, convert, and manage stickers
  // AI Suggestion: Replace magic numbers with named constants// Migrated to compact syntax with @policy references

// =============================================================================
// STICKER ANALYSIS & CONVERSION
// =============================================================================

tool sticker_analyze:
  desc: "Analyze a Telegram sticker"
  @Sticker analyzed: sticker valid → analyze() → result.info != null

  file_id: str!

  → sticker_info = telegram_get_file(file_id)
     case sticker_info.is_animated, sticker_info.is_video:
       true, _ → { type: "animated", format: "tgs", emoji: sticker_info.emoji }
       _, true → { type: "video", format: "webm", emoji: sticker_info.emoji }
       _, _ → { type: "static", format: "webp", emoji: sticker_info.emoji }

tool sticker_to_image:
  desc: "Convert sticker to PNG/JPG image"
  @Sticker converted: sticker valid → convert() → result.image_url != null

  file_id: str!
  format: str = "png"  // png, jpg

  → file_url = telegram_get_file_url(file_id)
     converted = format · convert_webp_to_image
     { image_url: converted.url, format }

tool sticker_to_gif:
  desc: "Convert animated/video sticker to GIF"
  @Sticker to GIF: animated sticker → convert() → result.gif_url != null

  file_id: str!

  → file_url = telegram_get_file_url(file_id)
     sticker_info = telegram_get_file(file_id)
     when sticker_info.is_animated → convert_tgs_to_gif(file_url)
       false → when sticker_info.is_video → convert_webm_to_gif(file_url)
         false → error(i18n:stickers.static_no_gif)

// =============================================================================
// STICKER SET OPERATIONS
// =============================================================================

tool sticker_set_info:
  desc: "Get information about a sticker set"
  @Set info retrieved: set_name valid → get_info() → result != null

  set_name: str!

  → telegram_get_sticker_set(set_name)

tool sticker_set_download:
  desc: "Download all stickers from a set"
  @Set downloaded: set_name valid → download_all() → result.files != null

  set_name: str!
  format: str = "original"  // original, png, gif

  → set_info = telegram_get_sticker_set(set_name)
     files = set_info.stickers
       · map{ sticker
            case format:
              "original" → telegram_get_file_url(sticker.file_id)
              "png" → sticker_to_image(sticker.file_id, "png").image_url
              "gif" → sticker_to_gif(sticker.file_id).gif_url
          }
     { set_name: set_info.name, title: set_info.title, count: len(files), files }

// =============================================================================
// STICKER CREATION
// =============================================================================

tool create_sticker_set:
  desc: "Create a new sticker set"
  @Set created: params valid → create() → result.set_name != null

  type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id: int!
  name: str!           // Must end with "_by_<bot_type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}name>"
  title: str!
  stickers: list!      // type {name} {
  items: List[Item],
  count: Int} { emoji, file_id } or { emoji, png_url }
  sticker_type: str = "regular"  // regular, mask, custom_emoji

  → first_sticker = stickers[0]
     telegram_create_new_sticker_set(type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id, name, title, stickers: [first_sticker], sticker_type)
     rest_stickers = tail(stickers)
     for sticker in rest_stickers: telegram_add_sticker_to_set(type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id, name, sticker)
     { set_name, title, count: len(stickers) }

tool add_sticker_to_set:
  desc: "Add a sticker to existing set"
  @Sticker added: params valid → add() → success

  type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id: int!
  set_name: str!
  emoji: str!
  sticker_file: str!  // file_id or URL

  → telegram_add_sticker_to_set(type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id, name: set_name, sticker: { emoji, sticker: sticker_file }

// =============================================================================
// IMAGE TO STICKER
// =============================================================================

tool image_to_sticker:
  desc: "Convert image to sticker format (512x512 WebP)"
  @Image converted: image valid → resize() → webp ready

  image_url: str!
  remove_background: bool = true

  → processed = when remove_background → remove_bg(image_url)
       false → image_url
     resized = max_size: 512 · resize_image
     webp = quality: 100 · convert_to_webp
     { sticker_url: webp.url, size: webp.size }

POST @SLOW https://queue.fal.run/fal-ai/birefnet "Remove background from image"
  @Background removed: image valid → remove() → result.image_url != null
  @auth Bearer(FAL_KEY)

  image_url: str!  @body

  → { image: { url: str! }! }

// =============================================================================
// STICKER SCENE
// =============================================================================

scene StickerTools:
  desc: "Analyze, convert, and manage Telegram stickers"
  @Tool selected: type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} selects → action performed
  @Result delivered: action complete → result sent

  on SelectAction:
    enter:
      → send(i18n:stickers.title)
      → kb([
           btn(i18n:stickers.analyze, "action:analyze"),
           btn(i18n:stickers.to_image, "action:to_image"),
           btn(i18n:stickers.to_gif, "action:to_gif"),
           btn(i18n:stickers.download_set, "action:download_set"),
           btn(i18n:stickers.from_image, "action:from_image"),
           btn(i18n:stickers.create_set, "action:create_set"),
           btn(i18n:common.menu, "menu")
         ])

    @action:analyze → goto AwaitSticker("analyze")
    @action:to_image → goto AwaitSticker("to_image")
    @action:to_gif → goto AwaitSticker("to_gif")
    @action:download_set → goto EnterSetName
    @action:from_image → goto AwaitImage
    @action:create_set → goto CreateSetStart
    @menu → exit(Idle)

  on AwaitSticker(action):
    enter:
      → send(i18n:stickers.send_sticker)

    message StickerMessage(sticker):
      → case action:
           "analyze" → goto AnalyzeResult(sticker)
           "to_image" → goto ConvertToImage(sticker)
           "to_gif" → goto ConvertToGif(sticker)

    @back → goto SelectAction

  on AnalyzeResult(sticker):
    enter:
      → info = sticker_analyze(file_id: sticker.file_id)
      → send(info · format_sticker_info)
      → kb([
           btn(i18n:stickers.convert, "convert"),
           btn(i18n:stickers.full_set, "set"),
           btn(i18n:common.back, "back")
         ])

    @convert → goto ConvertToImage(sticker)
    @set → goto DownloadSet(sticker.set_name)
    @back → goto SelectAction

  on ConvertToImage(sticker):
    enter:
      → send(i18n:stickers.converting_png)
      → result = sticker_to_image(file_id: sticker.file_id, format: "png")
      → send_photo(result.image_url, caption: i18n:stickers.png_ready)
      → goto SelectAction

  on ConvertToGif(sticker):
    enter:
      → when sticker.is_animated || sticker.is_video ->
             send(i18n:stickers.converting_gif)
             result = sticker_to_gif(file_id: sticker.file_id)
             send_animation(result.gif_url, caption: i18n:stickers.gif_ready)
             goto SelectAction
           false ->
             send(i18n:stickers.static_no_gif)
             goto SelectAction

  on EnterSetName:
    enter:
      → send(i18n:stickers.download_set_prompt)

    message StickerMessage(sticker):
      → goto DownloadSet(sticker.set_name)

    msg(text):
      → goto DownloadSet(text)

    @back → goto SelectAction

  on DownloadSet(set_name):
    enter:
      → send(i18n:stickers.loading_set)
      → set_info = sticker_set_info(set_name)
      → send(format_set_info(set_info))
      → kb([
           btn(i18n:stickers.download_png, "download:png"),
           btn(i18n:stickers.download_gif, "download:gif"),
           btn(i18n:stickers.download_original, "download:original"),
           btn(i18n:common.back, "back")
         ])

    @download:png:
      → send(i18n:stickers.converting_count(set_info.count))
      → result = format: "png" · sticker_set_download
      → send_files_as_album(result.files)
      → send(i18n:stickers.download_complete)

    @download:gif:
      → send(i18n:stickers.converting_gif_set)
      → result = format: "gif" · sticker_set_download
      → send_files_as_album(result.files)
      → send(i18n:stickers.download_complete)

    @download:original:
      → result = format: "original" · sticker_set_download
      → create_zip(result.files)
      → caption: set_name · send_document

    @back → goto SelectAction

  on AwaitImage:
    enter:
      → send(i18n:stickers.image_to_sticker_prompt)

    message PhotoMessage(file_id):
      → goto ProcessImage(file_id)

    @back → goto SelectAction

  on ProcessImage(file_id):
    enter:
      → send(i18n:stickers.processing_image)
      → image_url = upload_photo(file_id)
      → result = remove_background: true · image_to_sticker
      → send_document(result.sticker_url, caption: i18n:stickers.webp_ready)
      → send(i18n:stickers.add_to_set_hint)
      → goto SelectAction

  on CreateSetStart:
    enter:
      → send(i18n:stickers.create_set_intro)

    msg(text):
      → name = validate_set_name(text)
      → case name:
           ✅valid_name) → goto CreateSetTitle(valid_name)
           ❌err) → send(i18n:common.error(err)) && stay

    @back → goto SelectAction

  on CreateSetTitle(name):
    enter:
      → send(i18n:stickers.enter_title)

    msg(title):
      → validate title.length >= 1, i18n:stickers.title_empty
      → validate title.length <= 64, i18n:stickers.title_too_long
      → goto title, [] · CreateSetCollect

    @back → goto CreateSetStart

  on title, stickers · CreateSetCollect:
    enter:
      → count = len(stickers)
      → send(i18n:stickers.stickers_added(count))
      → kb([
           btn(i18n:stickers.create_now, "create") if count >= 1,
           btn(i18n:common.back, "back")
         ])

    message StickerMessage(sticker):
      → new_stickers = stickers  + [{ emoji: sticker.emoji, file_id: sticker.file_id }]
      → goto title, new_stickers · CreateSetCollect

    message PhotoMessage(file_id):
      → send(i18n:stickers.processing_image)
      → image_url = upload_photo(file_id)
      → result = image_to_sticker(image_url)
      → new_stickers = stickers  + [{ emoji: "happy", sticker_url: result.sticker_url }]
      → goto title, new_stickers · CreateSetCollect

    @create:
      → goto title, stickers · CreateSetFinish

    @back → goto CreateSetTitle(name)

  on title, stickers · CreateSetFinish:
    enter:
      → send(i18n:stickers.creating_set)
      → result = create_sticker_set(type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id, name + "_by_vibee_bot", title, stickers)
      → send(i18n:stickers.set_created(result.set_name))
      → goto SelectAction

// =============================================================================
// HELPER FUNCTIONS
// =============================================================================

info · format_sticker_info:
  type_label = case info.type:
    "animated" → i18n:stickers.type_animated
    "video" → i18n:stickers.type_video
    "static" → i18n:stickers.type_static
  i18n:stickers.info.emoji, sticker.set_name, sticker.width, sticker.height · info_format

format_set_info(set_info):
  type_label = case set_info.sticker_type:
    "regular" → i18n:stickers.set_regular
    "mask" → i18n:stickers.set_mask
    "custom_emoji" → i18n:stickers.set_emoji
  i18n:stickers.set_format(set_info.title, set_info.name, type_label, len(set_info.stickers))

validate_set_name(name):
  clean = name · string.lowercase() · string.replace(" ", "_")
  when regex."^[a-z][a-z0-9_]{2,30}$" · match → ✅clean)
    false → ❌i18n:stickers.invalid_set_name)

# v8.0

# v10.0 - ML-Powered Migration
