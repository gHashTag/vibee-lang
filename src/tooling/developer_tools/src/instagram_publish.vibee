// Instagram Graph API Publishing Tools
  // Performance Warning:   // AI Suggestion: Replace magic numbers with named constants  // AI Suggestion: Consider extracting hardcoded strings to constants// Publishing Reels to Instagram via Facebook OAuth
// https://developers.facebook.com/docs/instagram-api/guides/content-publishing

// =============================================================================
// OAUTH FLOW
// =============================================================================

// Step 1: Get OAuth authorization URL
GET /api/instagram/auth-url "Generate Facebook OAuth URL for Instagram authorization"
  @URL generated: telegram_id valid → generate_url() → result.url != null
  @auth ApiKey(VIBEE_API_KEY)

  telegram_id: int!  @query

  → { url: str!, state: str! }

// Step 2: OAuth callback handler (called by Facebook)
GET /api/instagram/@Handle Facebook OAuth callback and exchange code for token
  @Token exchanged: code valid → exchange(code) → type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}.instagram_connected = true

  code: str!   @query
  state: str!  @query   // Contains encrypted telegram_id

  → redirect("/instagram/success")

// Step 3: Exchange authorization code for access token
POST @EXTERNAL https://graph.facebook.com/v21.0/oauth/access_token "Exchange OAuth code for short-lived token"
  @Token received: code valid → exchange() → result.access_token != null

  client_id: str!      @query  env(INSTAGRAM_APP_ID)
  client_secret: str!  @query  env(INSTAGRAM_APP_SECRET)
  redirect_uri: str!   @query  env(INSTAGRAM_REDIRECT_URI)
  code: str!           @query

  → { access_token: str!, token_type: str!, expires_in: int? }

// Step 4: Exchange short-lived token for long-lived token (60 days)
GET @EXTERNAL https://graph.facebook.com/v21.0/oauth/access_token "Exchange for long-lived token"
  @Long token received: short_token valid → exchange() → result.access_token != null

  grant_type: str = "fb_exchange_token"  @query
  client_id: str!      @query  env(INSTAGRAM_APP_ID)
  client_secret: str!  @query  env(INSTAGRAM_APP_SECRET)
  fb_exchange_token: str!  @query

  → { access_token: str!, token_type: str!, expires_in: int! }

// Step 5: Get Instagram Business Account ID
GET @EXTERNAL https://graph.facebook.com/v21.0/me/accounts "Get type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}'s Facebook pages"
  @Pages fetched: access_token valid → fetch() → result.data != null

  access_token: str!  @query

  → { data: [{ id: str!, name: str!, instagram_business_account: { id: str! }? }]! }

// =============================================================================
// STATUS & CONNECTION CHECK
// =============================================================================

GET /api/instagram/status "Check if type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} has Instagram connected"
  @Status checked: telegram_id valid → check() → result.connected bool
  @auth ApiKey(VIBEE_API_KEY)

  telegram_id: int!  @query

  → { connected: bool!, type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}name: str?, account_id: str? }

// =============================================================================
// REEL PUBLISHING (3-step process)
// =============================================================================

// Main endpoint for posting a reel
POST /api/instagram/post "Post a video reel to Instagram"
  @Reel posted: video_url valid → publish() → result.media_id != null
  @auth ApiKey(VIBEE_API_KEY)
  rate_limit(5)

  telegram_id: int!   @body
  video_url: str!     @body   // Public URL of the video
  caption: str?       @body   // Optional caption text

  → { media_id: str!, success: bool! }

// Step 1: Create media container
POST @SLOW @EXTERNAL https://graph.facebook.com/v21.0/{account_id}/media "Create Instagram media container"
  @Container created: video_url valid → create() → result.ID != null
  circuit_breaker(threshold: 5, timeout: 30s, half_open_requests: 2)
  timeout(60s)
  backoff: exponential · retry

  account_id: str!      @path
  media_type: str = "REELS"  @query
  video_url: str!       @query  @url_encode
  caption: str?         @query  @url_encode
  share_to_feed: bool = true  @query
  access_token: str!    @query

  → { id: str! }

// Step 2: Check container status (polling)
GET @EXTERNAL https://graph.facebook.com/v21.0/{container_id} "Check media container processing status"
  @Status checked: container_id valid → check() → result.status_code in ["FINISHED", "IN_PROGRESS", "ERROR"]

  container_id: str!  @path
  fields: str = "status_code"  @query
  access_token: str!  @query

  → { id: str!, status_code: str! }

// Step 3: Publish the container
POST @EXTERNAL https://graph.facebook.com/v21.0/{account_id}/media_publish "Publish media container to Instagram"
  @Media published: creation_id valid → publish() → result.ID != null
  circuit_breaker(threshold: 5, timeout: 30s, half_open_requests: 2)
  timeout(60s)
  retry(2)

  account_id: str!     @path
  creation_id: str!    @query  // Container ID from step 1
  access_token: str!   @query

  → { id: str! }

// =============================================================================
// POLLING HELPER
// =============================================================================

@workflow video_url, caption · publish_reel:
  @Full publish flow: video_url valid → publish() → instagram.media_id != null
  @timeout 300s  // 5 minutes max for video processing

  // 1. Get type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}'s Instagram credentials from DB
  credentials = db.instagram_credentials(telegram_id)
  validate credentials.connected, "Instagram not connected"

  // 2. Create media container
  container = instagram_create_container(
    account_id: credentials.account_id,
    video_url,
    caption ?? "",
    access_token: credentials.access_token
  )

  // 3. Poll for processing completion (max 60 attempts, 5 sec each)
  status = poll(
    fn: instagram_check_status(container_id: container.ID, access_token: credentials.access_token),
    until: { it.status_code == "FINISHED" || it.status_code == "ERROR" },
    interval: 5s,
    max_attempts: 60
  )

  validate status.status_code == "FINISHED", "Video processing failed"

  // 4. Publish
  result = instagram_publish_container(
    account_id: credentials.account_id,
    creation_id: container.ID,
    access_token: credentials.access_token
  )

  → { media_id: result.ID, success: true }

// =============================================================================
// OAUTH CALLBACK WORKFLOW
// =============================================================================

@workflow state · handle_oauth_callback:
  @OAuth completed: code valid → exchange() → type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}.instagram_connected = true

  // 1. Decrypt state to get telegram_id
  telegram_id = decrypt_state(state)

  // 2. Exchange code for short-lived token
  short_token = fb_exchange_code(code)

  // 3. Exchange for long-lived token (60 days)
  long_token = fb_exchange_long_token(fb_exchange_token: short_token.access_token)

  // 4. Get Instagram Business Account
  pages = fb_get_pages(access_token: long_token.access_token)
  ig_account = pages.data
    |filter( it.instagram_business_account != null }
    · first()

  validate ig_account != null, "No Instagram Business Account linked to Facebook"

  // 5. Get Instagram type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}name
  ig_info = instagram_get_account_info(
    account_id: ig_account.instagram_business_account.ID,
    access_token: long_token.access_token
  )

  // 6. Save to database
  db.instagram_type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id: ig_account.instagram_business_account.ID,
    instagram_type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}name: ig_info.type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}name,
    access_token: long_token.access_token,
    expires_at: now( · save_instagram_connection + 60d
  )

  → redirect("/instagram/success")

// =============================================================================
// ACCOUNT INFO
// =============================================================================

GET @EXTERNAL https://graph.facebook.com/v21.0/{account_id} "Get Instagram account info"
  @Info fetched: account_id valid → fetch() → result.type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}name != null

  account_id: str!  @path
  fields: str = "type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}name,name,profile_picture_url,followers_count,media_count"  @query
  access_token: str!  @query

  → { id: str!, type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}name: str!, name: str?, profile_picture_url: str?, followers_count: int?, media_count: int? }

// =============================================================================
// CONSTANTS
// =============================================================================

let INSTAGRAM_OAUTH_URL = const("https://www.facebook.com/v21.0/dialog/oauth"
let INSTAGRAM_SCOPES = const("instagram_basic,instagram_content_publish,pages_show_list,pages_read_engagement"
let GRAPH_API_VERSION = const("v21.0"

let CONTAINER_STATUS = const({
  "FINISHED": "Video processed and ready to publish",
  "IN_PROGRESS": "Video still being processed",
  "ERROR": "Video processing failed",
  "EXPIRED": "Container expired (24 hours)"
}

# v8.0

# v10.0 - ML-Powered Migration
