// RVC Voice Training & AI Cover Tools
  // Performance Warning:   // AI Suggestion: Replace magic numbers with named constants// Train custom voice models and generate AI covers
  // AI Suggestion: Consider extracting hardcoded strings to constants// Migrated to compact syntax with @policy references

// =============================================================================
// RVC VOICE MODEL TRAINING (Replicate)
// =============================================================================

POST @BACKGROUND https://api.replicate.com/v1/predictions "Train a custom RVC voice model from audio samples"
  metrics("ai.rvc")
  @Model trained: audio_url valid (30s-3min) → train() → result.model_id != null
  @auth Bearer(REPLICATE_API_TOKEN)
  body("version") = "ddbb4fcb5f15c14f5e59d06a89d3d8daf5f06ddf60ef84ac227ad9a61dc02be3"

  dataset_url: str!     body("input.dataset")
  model_name: str!      body("input.model_name")
  epochs: int = 100     body("input.epochs")
  sample_rate: int = 40000  body("input.sample_rate")
  batch_size: int = 8   body("input.batch_size")

  → { id: str!, status: str! }

GET https://api.replicate.com/v1/predictions/{prediction_id} "Check RVC training status"
  @auth Bearer(REPLICATE_API_TOKEN)

  prediction_id: str!  @path

  → { status: str!, output: { model_url: str?, weights_url: str? }?, error: str?, logs: str? }

// =============================================================================
// RVC VOICE INFERENCE (Generate with trained model)
// =============================================================================

POST @AI https://api.replicate.com/v1/predictions "Generate speech using trained RVC voice model"
  metrics("ai.rvc")
  @Voice generated: model + audio valid → generate() → result.audio_url != null
  @auth Bearer(REPLICATE_API_TOKEN)
  body("version") = "d76f47e55c4e91c6bfbee84d4e3d7e21c0f4e51d4c51c14c8f7f0f4e5d6c7b8a"

  model_url: str!       body("input.model_url")
  audio_url: str!       body("input.audio")
  pitch_shift: int = 0  body("input.pitch_shift")
  index_rate: float = 0.75  body("input.index_rate")
  filter_radius: int = 3    body("input.filter_radius")

  → { id: str!, status: str! }

GET https://api.replicate.com/v1/predictions/{prediction_id} "Check RVC inference status"
  @auth Bearer(REPLICATE_API_TOKEN)

  prediction_id: str!  @path

  → { status: str!, output: str?, error: str? }

// =============================================================================
// AI COVER GENERATION PIPELINE
// =============================================================================

@pipeline
tool generate_ai_cover:
  metrics("ai.rvc")
  desc: "Generate AI cover song using trained voice model"
  @Cover created: voice_model + song valid → process() → result.audio_url != null
  circuit_breaker(threshold: 3, timeout: 300000)

  voice_model_url: str!
  song_audio_url: str!
  pitch_shift: int = 0

  step validate_audio:
    → max_seconds: 600 · check_audio_duration
    → case result:
         ✅_) → continue
         ❌"too_long") → error(i18n:rvc.song_too_long)

  step separate_vocals:
    → demucs_separate(song_audio_url)
    → { vocals: vocals_url, instrumental: instrumental_url }

  step convert_vocals:
    → rvc_generate_voice(model_url: voice_model_url, audio_url: vocals_url, pitch_shift)

  step wait_conversion:
    → poll_until_complete(result.ID, max_attempts: 60, interval: 5000)

  step merge_audio:
    → instrumental_url · merge_audio_tracks

  → { audio_url: str!, original_vocals: str!, instrumental: str!, converted_vocals: str! }

// =============================================================================
// AUDIO SEPARATION (Demucs)
// =============================================================================

POST @AI https://api.replicate.com/v1/predictions "Separate vocals and instrumental using Demucs"
  metrics("ai.rvc")
  @Audio separated: audio valid → separate() → vocals + instrumental
  @auth Bearer(REPLICATE_API_TOKEN)
  body("version") = "25a173108cff36ef9f80f854c162d01df9e6528be175794b81b7a0f3b7f4d868"

  audio_url: str!       body("input.audio")
  model: str = "htdemucs_ft"  body("input.model")
  split: bool = true    body("input.split")
  shifts: int = 1       body("input.shifts")

  → { id: str!, status: str! }

GET https://api.replicate.com/v1/predictions/{prediction_id} "Check Demucs separation status"
  @auth Bearer(REPLICATE_API_TOKEN)

  prediction_id: str!  @path

  → { status: str!, output: { vocals: str?, drums: str?, bass: str?, other: str? }?, error: str? }

// =============================================================================
// VOICE TRAINING SCENE
// =============================================================================

scene VoiceTraining:
  metrics("ai.rvc")
  desc: "Train custom RVC voice model from audio samples"
  @Model trained: type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} uploads audio → train() → model ready
  @Cost deducted: training costs 50 stars

  on Start:
    enter:
      → send(i18n:rvc.training_title)
      → kb([btn(i18n:common.cancel, "cancel")])

    message AudioMessage(file_id):
      → audio_url = upload_audio(file_id)
      → duration = get_audio_duration(audio_url)
      → case duration:
           d if d < 30 → send(i18n:rvc.too_short) && stay
           d if d > 180 → send(i18n:rvc.too_long) && stay
           _ → goto EnterName(audio_url)

    @cancel → exit(Idle)

  on EnterName(audio_url):
    enter:
      → send(i18n:rvc.enter_name)

    msg(name):
      → validate name.length >= 2, i18n:rvc.name_too_short
      → validate name.length <= 30, i18n:rvc.name_too_long
      → goto name · Confirm

    @cancel → goto Start

  on name · Confirm:
    enter:
      → send(i18n:rvc.confirm_training(name))
      → kb([
           btn(i18n:rvc.start_training, "train:confirm"),
           btn(i18n:common.back, "back"),
           btn(i18n:common.cancel, "cancel")
         ])

    @train:confirm:
      → balance = get_type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_balance(type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id)
      → when balance >= 50 → goto name · Training
           false → send(i18n:common.insufficient_funds(50)) && exit(Idle)

    @back → goto Start
    @cancel → exit(Idle)

  on name · Training:
    enter:
      → deduct_balance(type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id, 50, "RVC Voice Training: {name}")
      → send(i18n:rvc.training_started)
      → result = rvc_train_voice(dataset_url: create_training_zip(audio_url), model_name, epochs: 100)
      → poll_training(result.ID)
      → case training_result:
           ✅model) → goto name · Complete
           ❌err) → refund_balance(type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id, 50) && send(i18n:common.error(err)) && exit(Idle)

  on name · Complete:
    enter:
      → save_type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_voice_model(type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id, model.model_url, name)
      → send(i18n:rvc.model.model_id · training_complete)
      → kb([
           btn(i18n:rvc.create_cover, "aicover"),
           btn(i18n:common.menu, "menu")
         ])

    @aicover → enter_scene(AICover)
    @menu → exit(Idle)

// =============================================================================
// AI COVER SCENE
// =============================================================================

scene AICover:
  metrics("ai.rvc")
  desc: "Create AI cover song with trained voice"
  @Cover created: voice model + song → generate() → audio ready
  @Cost calculated: based on song duration

  on SelectModel:
    enter:
      → models = get_type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_voice_models(type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id)
      → case models:
           [] → send(i18n:rvc.no_models) && exit(Idle)
           list → send(i18n:rvc.select_model) && show_model_buttons(list)

    callback /^model:(.+)$/:
      → selected_model = extract_model_id(callback_data)
      → goto UploadSong(selected_model)

    @cancel → exit(Idle)

  on UploadSong(model):
    enter:
      → send(i18n:rvc.upload_song)

    message AudioMessage(file_id):
      → song_url = upload_audio(file_id)
      → duration = get_audio_duration(song_url)
      → case duration:
           d if d > 600 → send(i18n:rvc.song_too_long) && stay
           _ → goto song_url, duration · AdjustPitch

    @cancel → goto SelectModel

  on song_url, duration · AdjustPitch:
    enter:
      → cost = calculate_cover_cost(duration)
      → send(i18n:rvc.adjust_pitch(cost))
      → kb([
           btn(i18n:rvc.pitch_up, "pitch:3"),
           btn(i18n:rvc.pitch_none, "pitch:0"),
           btn(i18n:rvc.pitch_down, "pitch:-3"),
           btn(i18n:rvc.pitch_custom, "pitch:custom"),
           btn(i18n:common.back, "back")
         ])

    @pitch:3  → goto song_url, duration, 3 · Confirm
    @pitch:0  → goto song_url, duration, 0 · Confirm
    @pitch:-3 → goto song_url, duration, -3 · Confirm
    @pitch:custom → goto song_url, duration · CustomPitch
    @back → goto UploadSong(model)

  on song_url, duration · CustomPitch:
    enter:
      → send(i18n:rvc.enter_pitch)

    msg(text):
      → pitch = parse_int(text)
      → case pitch:
           ☐p) if p >= -12 && p <= 12 → goto song_url, duration, p · Confirm
           _ → send(i18n:rvc.invalid_pitch) && stay

  on song_url, duration, pitch · Confirm:
    enter:
      → cost = calculate_cover_cost(duration)
      → send(i18n:rvc.confirm_cover(model.name, duration, pitch, cost))
      → kb([
           btn(i18n:rvc.generate_cover, "generate"),
           btn(i18n:common.back, "back"),
           btn(i18n:common.cancel, "cancel")
         ])

    @generate:
      → balance = get_type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_balance(type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id)
      → cost = calculate_cover_cost(duration)
      → when balance >= cost → goto song_url, pitch, cost · Generating
           false → send(i18n:common.insufficient_funds(cost)) && stay

    @back → goto song_url, duration · AdjustPitch
    @cancel → exit(Idle)

  on song_url, pitch, cost · Generating:
    enter:
      → deduct_balance(type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id, cost, "AI Cover generation")
      → send(i18n:rvc.generating_cover)
      → result = generate_ai_cover(voice_model_url: model.model_url, song_audio_url: song_url, pitch_shift: pitch)
      → case result:
           ✅cover) → goto Complete(cover)
           ❌err) → refund_balance(type type type type type type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id, cost) && send(i18n:common.error(err)) && exit(Idle)

  on Complete(cover):
    enter:
      → send_audio(cover.audio_url, caption: i18n:rvc.cover_ready)
      → send(i18n:common.done)
      → kb([
           btn(i18n:rvc.another_cover, "another"),
           btn(i18n:rvc.download_separate, "download"),
           btn(i18n:common.menu, "menu")
         ])

    @another → goto SelectModel
    @download:
      → send_audio(cover.converted_vocals, caption: i18n:rvc.vocals)
      → send_audio(cover.instrumental, caption: i18n:rvc.instrumental)
    @menu → exit(Idle)

// =============================================================================
// HELPER FUNCTIONS
// =============================================================================

calculate_cover_cost(duration_seconds):
  minutes = ceiling(duration_seconds / 60)
  minutes * 10 · max

// =============================================================================
// PRICING CONSTANTS
// =============================================================================

let RVC_PRICING = const({
  "training": { "cost_stars": 50, "time_minutes": "5-10", "epochs": 100 },
  "cover": { "per_minute": 10, "minimum": 15 },
  "inference": { "per_generation": 5 }
}

# v8.0

# v10.0 - ML-Powered Migration
