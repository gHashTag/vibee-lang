// Image Upscaling & Enhancement Tools
  // AI Suggestion: Replace magic numbers with named constants// Upscale, enhance, and restore images
  // Performance Warning:   // AI Suggestion: Consider extracting hardcoded strings to constants// Migrated to compact syntax with @policy references

// =============================================================================
// REAL-ESRGAN (Standard Upscaling)
// =============================================================================

POST @SLOW https://queue.fal.run/fal-ai/real-esrgan "Upscale image using Real-ESRGAN"
  metrics("ai.upscale")
  @Image upscaled: image valid → upscale() → result.image_url != null
  @auth Bearer(FAL_KEY)

  image_url: str!        @body
  scale: int = 4         @body  // 2 or 4
  face_enhance: bool = false  @body

  → { image: { url: str!, width: int!, height: int! }! }

// =============================================================================
// CREATIVE UPSCALER (AI Enhancement)
// =============================================================================

POST @AI https://queue.fal.run/fal-ai/creative-upscaler "Upscale with AI enhancement and detail generation"
  metrics("ai.upscale")
  @Image enhanced: image valid → upscale() → result.image_url != null
  @auth Bearer(FAL_KEY)

  image_url: str!        @body
  scale: float = 2.0     @body  // 1.0 to 4.0
  creativity: float = 0.35  @body  // 0.0 to 1.0
  detail: float = 1.0    @body  // 0.0 to 1.0
  resemblance: float = 0.6  @body  // 0.0 to 1.0
  prompt: str?           @body  // Optional guidance

  → { image: { url: str!, width: int!, height: int! }! }

// =============================================================================
// CLARITY UPSCALER (Photo Restoration)
// =============================================================================

POST @AI https://queue.fal.run/fal-ai/clarity-upscaler "Upscale with focus on clarity and sharpness"
  metrics("ai.upscale")
  @Image clarified: image valid → upscale() → result.image_url != null
  @auth Bearer(FAL_KEY)

  image_url: str!        @body
  scale: float = 2.0     @body
  prompt: str?           @body
  negative_prompt: str?  @body
  creativity: float = 0.3  @body
  guidance_scale: float = 4.0  @body

  → { image: { url: str!, width: int!, height: int! }! }

// =============================================================================
// AURA SR (Fast Upscaling)
// =============================================================================

POST @FAST https://queue.fal.run/fal-ai/aura-sr "Fast 4x upscaling using Aura SR"
  metrics("ai.upscale")
  @Image upscaled: image valid → upscale() → result.image_url != null
  @auth Bearer(FAL_KEY)

  image_url: str!        @body
  upscaling_factor: int = 4  @body  // 4 only

  → { image: { url: str!, width: int!, height: int! }! }

// =============================================================================
// GFPGAN (Face Restoration)
// =============================================================================

POST @SLOW https://api.replicate.com/v1/predictions "Restore and enhance faces in image"
  metrics("ai.upscale")
  @Face restored: image valid → restore() → result.image_url != null
  @auth Bearer(REPLICATE_API_TOKEN)
  body("version") = "9283608cc6b7be6b65a8e44983db012355fde4132009bf99d976b2f0896856a3"

  img: str!              body("input.img")
  version: str = "v1.4"  body("input.version")
  scale: float = 2.0     body("input.scale")

  → { id: str!, status: str! }

GET https://api.replicate.com/v1/predictions/{prediction_id} "Check GFPGAN restoration status"
  @auth Bearer(REPLICATE_API_TOKEN)

  prediction_id: str!  @path

  → { status: str!, output: str?, error: str? }

// =============================================================================
// CODEFORMER (Advanced Face Restoration)
// =============================================================================

POST @AI https://api.replicate.com/v1/predictions "Advanced face restoration using CodeFormer"
  metrics("ai.upscale")
  @Face restored: image valid → restore() → result.image_url != null
  @auth Bearer(REPLICATE_API_TOKEN)
  body("version") = "7de2ea26c616d5bf2245ad0d5e24f0ff9a6204578a5c876db53142edd9d2cd56"

  image: str!            body("input.image")
  upscale: int = 2       body("input.upscale")
  face_upsample: bool = true  body("input.face_upsample")
  background_enhance: bool = true  body("input.background_enhance")
  codeformer_fidelity: float = 0.5  body("input.codeformer_fidelity")

  → { id: str!, status: str! }

// =============================================================================
// SUPIR (Ultra High Quality)
// =============================================================================

POST @BACKGROUND https://queue.fal.run/fal-ai/supir "Ultra high quality upscaling with SUPIR"
  metrics("ai.upscale")
  @Image upscaled: image valid → upscale() → result.image_url != null
  @auth Bearer(FAL_KEY)

  image_url: str!        @body
  upscale: int = 2       @body  // 1, 2, 3, 4
  s_cfg: float = 7.5     @body  // Guidance scale
  s_churn: float = 5.0   @body
  seed: int?             @body

  → { image: { url: str!, width: int!, height: int! }! }

// =============================================================================
// IMAGE-TO-PROMPT (Reverse Engineering)
// =============================================================================

POST @FAST https://queue.fal.run/fal-ai/image-to-prompt "Generate prompt description from image"
  metrics("ai.upscale")
  @Prompt extracted: image valid → analyze() → result.prompt != null
  @auth Bearer(FAL_KEY)

  image_url: str!        @body
  detail: str = "auto"   @body  // auto, low, high

  → { prompt: str! }

POST @FAST https://queue.fal.run/fal-ai/llava-next "Describe image using LLaVA model"
  metrics("ai.upscale")
  @Description generated: image valid → describe() → result.text != null
  @auth Bearer(FAL_KEY)

  image_url: str!        @body
  prompt: str = "Describe this image in detail for recreating it with AI image generation."  @body

  → { output: str! }

// =============================================================================
// UNIFIED UPSCALE PIPELINE
// =============================================================================

@pipeline
tool upscale_image:
  desc: "Upscale image using best available method"
  metrics("ai.upscale")
  @Auto upscale: selects method based on content type
  circuit_breaker(threshold: 3, timeout: 60000)

  image_url: str!
  scale: int = 2        // 2 or 4
  mode: str = "auto"    // auto, fast, quality, face, creative

  step detect_content:
    → analyze_image(image_url)
    → { has_faces: bool, is_photo: bool, is_illustration: bool }

  step select_method:
    → case mode, content:
         "fast", _ → "aura"
         "face", _ → "codeformer"
         "creative", _ → "creative"
         "quality", _ → "supir"
         "auto", { has_faces: true, .. } → "codeformer"
         "auto", { is_illustration: true, .. } → "realesrgan"
         "auto", _ → "clarity"

  step upscale:
    → case selected_method:
         "aura" → upscaling_factor: 4 · aura_sr
         "realesrgan" → scale · realesrgan
         "creative" → scale: float(scale · creative_upscaler)
         "clarity" → scale: float(scale · clarity_upscaler)
         "codeformer" → codeformer_restore(image: image_url, upscale)
         "supir" → upscale · supir_upscale
         _ → scale · realesrgan

  → { image_url: str!, method: str!, original_size: { width: int, height: int }, new_size: { width: int, height: int } }

// =============================================================================
// IMAGE UPSCALE SCENE
// =============================================================================

scene ImageUpscale:
  desc: "Upscale and enhance images"
  metrics("ai.upscale")
  @Image upscaled: image → upscale() → result ready
  @Cost calculated: based on method and scale

  on Start:
    enter:
      → send(i18n:upscale.title)
      → kb([btn(i18n:common.cancel, "cancel")])

    message PhotoMessage(file_id):
      → image_url = upload_photo(file_id)
      → goto SelectMethod(image_url)

    @cancel → exit(Idle)

  on SelectMethod(image_url):
    enter:
      → send(i18n:upscale.select_method)
      → kb([
           btn(i18n:upscale.fast, "method:fast"),
           btn(i18n:upscale.creative, "method:creative"),
           btn(i18n:upscale.face, "method:face"),
           btn(i18n:upscale.quality, "method:quality"),
           btn(i18n:common.back, "back")
         ])

    @method:fast → goto "fast", 5 · SelectScale
    @method:creative → goto "creative", 15 · SelectScale
    @method:face → goto "face", 10 · SelectScale
    @method:quality → goto "quality", 25 · SelectScale
    @back → goto Start

  on method, base_cost · SelectScale:
    enter:
      → send(i18n:upscale.select_scale)
      → kb([
           btn("2x ({$(base_cost)} ⭐)", "scale:2"),
           btn("4x ({to_stringbase_cost * 2} ⭐)", "scale:4"),
           btn(i18n:common.back, "back")
         ])

    @scale:2 → goto method, 2, base_cost · Confirm
    @scale:4 → goto method, 4, base_cost * 2 · Confirm
    @back → goto SelectMethod(image_url)

  on method, scale, cost · Confirm:
    enter:
      → send(scale, cost · format_confirm_message)
      → kb([
           btn(i18n:upscale.confirm(cost), "upscale"),
           btn(i18n:common.back, "back"),
           btn(i18n:common.cancel, "cancel")
         ])

    @upscale:
      → balance = get_type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_balance(type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id)
      → when balance >= cost → goto method, scale, cost · Processing
           false → send(i18n:common.insufficient_funds(cost)) && stay

    @back → goto method, cost · SelectScale
    @cancel → exit(Idle)

  on method, scale, cost · Processing:
    enter:
      → deduct_balance(type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id, cost, "Image Upscale")
      → send(i18n:upscale.processing)
      → result = scale, mode: method · upscale_image
      → case result:
           ✅output) → goto Complete(output)
           ❌err) → refund_balance(type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id, cost) && send(i18n:common.error(err)) && exit(Idle)

  on Complete(output):
    enter:
      → send_photo(output.image_url, caption: format_result_caption(output))
      → send(i18n:common.done)
      → kb([
           btn(i18n:upscale.another, "another"),
           btn(i18n:upscale.get_prompt, "prompt"),
           btn(i18n:common.menu, "menu")
         ])

    @another → goto Start
    @prompt:
      → prompt = image_to_prompt(image_url: output.image_url)
      → send(i18n:upscale.prompt_result(prompt.prompt))
    @menu → exit(Idle)

// =============================================================================
// HELPER FUNCTIONS
// =============================================================================

scale, cost · format_confirm_message:
  method_label = case method:
    "fast" → i18n:upscale.fast
    "creative" → i18n:upscale.creative
    "face" → i18n:upscale.face
    "quality" → i18n:upscale.quality
    _ → method
  i18n:upscale.scale, cost · confirm_message

format_result_caption(output):
  i18n:upscale.result_caption(output.original_size.width, output.original_size.height, output.new_size.width, output.new_size.height, output.method)

// =============================================================================
// PRICING CONSTANTS
// =============================================================================

let UPSCALE_PRICING = const({
  "fast": { "2x": 5, "4x": 10, "description": "Real-ESRGAN / Aura SR" },
  "creative": { "2x": 15, "4x": 30, "description": "AI-enhanced upscaling" },
  "face": { "2x": 10, "4x": 20, "description": "CodeFormer face restoration" },
  "quality": { "2x": 25, "4x": 50, "description": "SUPIR ultra quality" }
}

# v8.0

# v10.0 - ML-Powered Migration
