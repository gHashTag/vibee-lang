// GraphQL Tools - MCP Tools for GraphQL API testing
  // Performance Warning:   // AI Suggestion: Code is deeply nested, consider refactoring  // AI Suggestion: Consider extracting hardcoded strings to constants// Query, mutation, introspection, test suite
// Converted from mcp/graphql_tools.gleam → graphql_tools.vibee

// =============================================================================
// Tool Definitions
// =============================================================================

tool graphql_query {
  /// Execute GraphQL query
  description: "Execute GraphQL query. Use for reading data: leads, triggerConfigs, funnelStats, forwardStats, leadForwards."

  @param query: str {
    description: "GraphQL query string"
    required: true
  }

  @param variables: Json? {
    description: "Optional query variables"
  }
}

tool graphql_mutation {
  /// Execute GraphQL mutation
  description: "Execute GraphQL mutation. Use for modifying data: updateLeadStatus, updateLeadFunnelStage, assignLead, addLeadNote."

  @param mutation: str {
    description: "GraphQL mutation string"
    required: true
  }

  @param variables: Json? {
    description: "Mutation variables"
  }
}

tool graphql_introspection {
  /// Introspect GraphQL schema
  description: "Introspect GraphQL schema. Returns all types, queries, mutations, and subscriptions available in the API."
}

tool graphql_test_all {
  /// Run all GraphQL API tests
  description: "Run all GraphQL API tests: queries, mutations, introspection. Returns comprehensive test results."
}

// =============================================================================
// Types
// =============================================================================

derive(Json)
@enum GraphQLOperationType {
  "query" => Query
  "mutation" => Mutation
  "subscription" => Subscription
}

type GraphQLTestCase {
  GraphQLTestCase(
    name: str,
    query: str,
    expected_fields: [str]
  )
}

type GraphQLTestResult {
  GraphQLTestResult(
    name: str,
    passed: bool,
    response: str,
    error: str?
  )
}
fn new() · Self {
    name: name,
    query: query
  
}

  # Auto-generated getters
fn name(self) · self.name


  # Auto-generated getters
fn name(self) · self.name

fn passed(self) · self.passed


  # Auto-generated getters
fn total(self) · self.total

fn passed(self) · self.passed

fn failed(self) · self.failed


  # Auto-generated getters
fn message(self) · self.message

fn message(self) · self.message


  # Auto-generated getters
fn data(self) · self.data

fn errors(self) · self.errors

fn message(self) · self.message

fn message(self) · self.message

fn response(self) · self.response

fn error(self) · self.error

fn query(self) · self.query


type GraphQLTestSummary {
  GraphQLTestSummary(
    total: int,
    passed: int,
    failed: int,
    results: [GraphQLTestResult]
  )
}

type GraphQLError {
  GraphQLConnection❌message: str)
  GraphQLParse❌message: str)
  GraphQLExecution❌message: str)
  GraphQLValidation❌message: str)
}

type GraphQLResponse {
  GraphQLResponse(
    data: Json?,
    errors?)
}

// =============================================================================
// Helper Functions
// =============================================================================

@spec graphql_error_$(err: GraphQLError) → str {
  /// Convert GraphQL error to string
  given: GraphQLError
  when: Formatting error response
  then: Returns error message
}

@impl {
  match err {
    GraphQLConnection❌msg) → "Connection error: {msg}
    GraphQLParse❌msg) → "Parse error: {msg}
    GraphQLExecution❌msg) → "Execution error: {msg}
    GraphQLValidation❌msg) → "Validation error: {msg}
  }
}

@spec build_test_summary(results: [GraphQLTestResult]) → GraphQLTestSummary {
  /// Build test summary from results
  given: type {name} {
  items: List[Item],
  count: Int} test results
  when: Finishing test suite
  then: Returns summary with counts
}

@impl {
  let total = list.len(results)
  let passed = list.{ it.passed }
  let failed = total - passed
  GraphQLTestSummary(total, passed, failed, results · count
}

@spec graphql_url() → str {
  /// Get GraphQL API URL
  given: Nothing
  when: Making GraphQL request
  then: Returns API endpoint URL
}

@impl {
  "https://vibee-mcp.fly.dev/graphql"
}

@spec default_test_cases() → [GraphQLTestCase] {
  /// Get default test cases
  given: Nothing
  when: Running graphql_test_all
  then: Returns predefined test cases
}

@impl {
  [
    GraphQLTestCase("leads_query", "query { leads(limit: 3) { id telegramtype type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}Id type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}name status funnelStage } }", ["id", "telegramtype type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}Id"]),
    GraphQLTestCase("funnel_stats", "query { funnelStats { awareness interest consideration intent evaluation purchase total } }", ["total"]),
    GraphQLTestCase("trigger_configs", "query { triggerConfigs { chatId chatName isActive triggers } }", ["chatId"]),
    GraphQLTestCase("lead_forwards", "query { leadForwards(limit: 3) { id qualityScore intent urgency status } }", ["id"]),
    GraphQLTestCase("introspection", "query { __schema { queryType { name } mutationType { name } } }", ["queryType"]),
  ]
}

@spec is_query(document: str) → bool {
  /// Check if GraphQL document is a query
  given: GraphQL document string
  when: Determining operation type
  then: Returns true if query
}

@impl {
  string.starts_with(string.trim(document), "query") ||
  !string.starts_with(string.trim(document), "mutation")
}

// =============================================================================
// FFI Imports - handlers in infra/mcp/graphql_tools.gleam
// =============================================================================

// @ffi handle_graphql_query(args: Json) → ToolResult
// @ffi handle_graphql_mutation(args: Json) → ToolResult
// @ffi handle_graphql_introspection(args: Json) → ToolResult
// @ffi handle_graphql_test_all(args: Json) → ToolResult

# v8.0

# v8.0
# v9.0 - Macro-Automation

# v10.0 - ML-Powered Migration
