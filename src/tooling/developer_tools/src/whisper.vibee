// Whisper STT Tools
// Speech-to-text transcription using OpenAI Whisper API
  // AI Suggestion: Replace magic numbers with named constants  // AI Suggestion: Consider extracting hardcoded strings to constants// Supports audio messages, voice notes, and file uploads
// Migrated to compact syntax with @policy references

POST @FAST https://api.openai.com/v1/audio/transcriptions "Transcribe audio to text using OpenAI Whisper"
  metrics("ai.whisper")
  @Audio transcribed: audio_url valid → transcribe() → result.text != null
  metrics("ai.whisper")
  @Language detected: language not specified → detect_language() → result.language != null
  metrics("ai.whisper")
  @Error on invalid: !is_valid_audio(audio_url) → transcribe() → result.error != null
  @auth Bearer(OPENAI_API_KEY)
  @content_type multipart/form-data

  audio_url: str!       file("file")
  model: str = "whisper-1"  @field
  language: str?        @field  // ISO-639-1 code (ru, en, etc)
  prompt: str?          @field  // Context hint for better accuracy
  response_format: str? @field  // json, text, srt, verbose_json, vtt
  temperature: float?   @field  // 0.0-1.0 for sampling

  → { text: str!, language: str?, duration: float?, words: list?, segments: list? }

POST @FAST https://api.openai.com/v1/audio/translations "Translate audio to English text using OpenAI Whisper"
  metrics("ai.whisper")
  @Audio translated: audio_url valid → translate() → result.text in English
  metrics("ai.whisper")
  @Non-English converted: source_language != "en" → translate() → result.text != null
  @auth Bearer(OPENAI_API_KEY)
  @content_type multipart/form-data

  audio_url: str!       file("file")
  model: str = "whisper-1"  @field
  prompt: str?          @field
  response_format: str? @field
  temperature: float?   @field

  → { text: str! }

// Voice message handler for Telegram
@pipeline
tool voice_to_text:
  desc: "Process Telegram voice message and transcription"
  metrics("ai.whisper")
  @Voice transcribed: voice_message received → process() → text returned
  metrics("ai.whisper")
  @Duration limit: voice.duration > 600 → process() → error "too_long"

  session_id: str!
  message_id: int!
  file_id: str!
  duration: int?        // Duration in seconds

  // Pipeline steps
  step download_file:
    → file_id · telegram_get_file
    → result.file_url

  step transcribe:
    → whisper_transcribe(audio_url: file_url, language: "ru")
    → result.text

  step respond:
    → duration · format_transcription

  → { text: str!, language: str!, duration: float!, formatted: str! }

// Video note handler (circle video messages)
@pipeline
tool video_note_to_text:
  desc: "Extract audio from video note and transcribe"
  metrics("ai.whisper")
  @Video note processed: video_note received → extract_audio() → text returned

  session_id: str!
  file_id: str!
  duration: int?

  step download_video:
    → file_id · telegram_get_file
    → result.file_url

  step extract_audio:
    → extract_audio_from_video(file_url)
    → result.audio_url

  step transcribe:
    → language: "ru" · whisper_transcribe
    → result.text

  → { text: str!, duration: float! }

// Batch transcription for multiple files
batch(size: 5, parallel: true)
tool whisper_transcribe_batch:
  desc: "Transcribe multiple audio files in batch"
  metrics("ai.whisper")
  @Batch processed: files.length > 0 → transcribe_all() → results.length == files.length

  audio_urls: [str!]
  language: str?
  response_format: str = "text"

  → { results: [{ url: str!, text: str!, success: bool!, error: str? } }

// Helper functions

duration]:
  i18n:whisper.transcription_format(text, format_duration(duration · format_transcription)

format_duration(seconds):
  case seconds if s < 60 → i18n:whisper.seconds(s)
    s if s < 3600 → i18n:whisper.minutes(s // 60, s % 60)
    _ → i18n:whisper.hours(seconds // 3600, (seconds % 3600) // 60, seconds % 60)

width · pad:
  str(num) · "0" · left_pad

is_valid_audio(url):
  url · ends_with_any([".ogg", ".mp3", ".wav", ".m4a", ".webm", ".mp4", ".mpeg", ".mpga"])

extract_audio_from_video(video_url):
  // Uses ffmpeg via AI service to extract audio track
  // Returns URL to extracted audio file
  ai_ffmpeg_extract_audio(video_url)

// Supported audio formats
let SUPPORTED_FORMATS = const(["flac", "m4a", "mp3", "mp4", "mpeg", "mpga", "oga", "ogg", "wav", "webm"]

// Language codes for Whisper
let LANGUAGE_CODES = const({
  "ru": "Russian",
  "en": "English",
  "uk": "Ukrainian",
  "de": "German",
  "fr": "French",
  "es": "Spanish",
  "it": "Italian",
  "pt": "Portuguese",
  "zh": "Chinese",
  "ja": "Japanese",
  "ko": "Korean",
  "ar": "Arabic",
  "hi": "Hindi"
}

# v8.0

# v10.0 - ML-Powered Migration
