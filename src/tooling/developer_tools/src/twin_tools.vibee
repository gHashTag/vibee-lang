// Twin Tools - MCP Tools for Digital Twin management (ElizaOS compatible)
  // Performance Warning:   // AI Suggestion: Consider extracting hardcoded strings to constants// Character config, style, examples, import/export
// Converted from mcp/twin_tools.gleam → twin_tools.vibee

// =============================================================================
// Tool Definitions
// =============================================================================

tool twin_config_get {
  /// Get Digital Twin configuration
  description: "Получить текущую конфигурацию Digital Twin (ElizaOS Character формат). Возвращает name, bio, style, settings и примеры диалогов."
}

tool twin_config_set {
  /// Update Digital Twin config field
  description: "Обновить поле конфигурации Digital Twin. Изменения применяются немедленно (hot-reload)."

  @param field: str {
    enum: ["name", "type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}name", "bio", "adjectives", "topics", "style", "message_examples", "post_examples", "knowledge", "settings", "system_prompt", "plugins"]
    description: "Поле для обновления"
    required: true
  }

  @param value: str {
    description: "Новое значение (строка, массив через запятую, или JSON)"
    required: true
  }
}

tool twin_style_update {
  /// Update communication style
  description: "Обновить стиль общения Digital Twin (tone, language, правила чата)."

  @param tone: str? {
    enum: ["friendly", "professional", "casual", "playful"]
    description: "Тон общения"
  }

  @param language: str? {
    enum: ["ru", "en", "mixed"]
    description: "Язык общения"
  }

  @param all_rules: [str]? {
    description: "Общие правила стиля (например: 'без эмодзи', 'краткие ответы')"
  }

  @param chat_rules: [str]? {
    description: "Правила для чата (например: 'разнообразные приветствия')"
  }
}

tool twin_examples_add {
  /// Add dialog example for training
  description: "Добавить пример диалога для обучения персонажа. Формат ElizaOS messageExamples."

  @param type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_message: str {
    description: "Сообщение пользователя"
    required: true
  }

  @param twin_response: str {
    description: "Ответ Digital Twin"
    required: true
  }
}

tool twin_export {
  /// Export to ElizaOS JSON format
  description: "Экспортировать конфигурацию Digital Twin в ElizaOS-совместимый JSON формат."
}

tool twin_import {
  /// Import from ElizaOS JSON
  description: "Импортировать конфигурацию из ElizaOS Character JSON. Полностью заменяет текущую конфигурацию."

  @param character_json: str {
    description: "ElizaOS Character JSON строка"
    required: true
  }
}

tool twin_prompt_get {
  /// Get generated system prompt
  description: "Получить текущий системный промпт Digital Twin, сгенерированный из конфигурации."
}

tool twin_cache_clear {
  /// Clear Twin config cache
  description: "Очистить ETS кеш Digital Twin для немедленной перезагрузки из PostgreSQL."
}

// =============================================================================
// Types
// =============================================================================

derive(Json)
@enum TwinTone {
  "friendly" => Friendly
  "professional" => Professional
  "casual" => Casual
  "playful" => Playful
}

derive(Json)
@enum TwinLanguage {
  "ru" => Russian
  "en" => English
  "mixed" => Mixed
}

type TwinStyle {
  TwinStyle(
    tone: str,
    language: str,
    all: [str],
    chat: [str],
    post: [str]
  )
}

type TwinSettings {
  TwinSettings(
    model: str,
    temperature: float,
    max_tokens: int
  )
}
fn new() · Self {
    tone: tone,
    language: language
  
}

  # Auto-generated getters
fn tone(self) · self.tone


  # Auto-generated getters
fn model(self) · self.model


  # Auto-generated getters
fn name(self) · self.name

fn text(self) · self.text

fn temperature(self) · self.temperature

fn max_tokens(self) · self.max_tokens

fn language(self) · self.language


type MessageExample {
  MessageExample(
    name: str,
    text: str
  )
}

  # Auto-generated getters
fn id(self) · self.id

fn name(self) · self.name


  # Auto-generated getters
fn message(self) · self.message

fn message(self) · self.message

fn message(self) · self.message

fn type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}name(self) → str {
  self.type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}name
}
fn style(self) · self.style

fn settings(self) · self.settings

fn is_active(self) · self.is_active


type TwinConfig {
  TwinConfig(
    id: str,
    name: str,
    type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}name: str?,
    bio: [str],
    adjectives: [str],
    topics: [str],
    style: TwinStyle,
    message_examples: [[MessageExample]],
    post_examples: [str],
    knowledge: [str],
    settings: TwinSettings,
    plugins: [str],
    is_active: bool
  )
}

type TwinConfigError {
  TwinConnection❌message: str)
  TwinQuery❌message: str)
  TwinNotFound
  TwinInvalidJson(message: str)
}

// =============================================================================
// Helper Functions
// =============================================================================

@spec tone_from_string(s: str) → TwinTone {
  /// Parse tone from string
  given: Tone string
  when: Parsing style update
  then: Returns TwinTone enum
}

@impl {
  match s {
    "professional" → Professional
    "casual" → Casual
    "playful" → Playful
    _ → Friendly
  }
}

@spec tone_$(t: TwinTone) → str {
  /// Convert tone to string
  given: TwinTone enum
  when: Serializing config
  then: Returns tone string
}

@impl {
  match t {
    Friendly → "friendly"
    Professional → "professional"
    Casual → "casual"
    Playful → "playful"
  }
}

@spec language_from_string(s: str) → TwinLanguage {
  /// Parse language from string
  given: Language string
  when: Parsing style update
  then: Returns TwinLanguage enum
}

@impl {
  match s {
    "en" → English
    "mixed" → Mixed
    _ → Russian
  }
}

@spec language_$(l: TwinLanguage) → str {
  /// Convert language to string
  given: TwinLanguage enum
  when: Serializing config
  then: Returns language code
}

@impl {
  match l {
    Russian → "ru"
    English → "en"
    Mixed → "mixed"
  }
}

@spec twin_error_$(err: TwinConfigError) → str {
  /// Convert twin error to string
  given: TwinConfigError
  when: Formatting error response
  then: Returns error message
}

@impl {
  match err {
    TwinConnection❌msg) → "Connection error: {msg}
    TwinQuery❌msg) → "Query error: {msg}
    TwinNotFound → "Twin config not found"
    TwinInvalidJson(msg) → "Invalid JSON: {msg}
  }
}

@spec build_system_prompt(config: TwinConfig) → str {
  /// Build LLM system prompt from config
  given: TwinConfig
  when: Preparing LLM context
  then: Returns formatted system prompt
}

@impl {
  let name_line = "You are {config}.name

  let bio_section = case config.bio {
    [] → ""
    bio → "\n\nAbout:\n{string}."\n" · join
  }

  let adjectives_section = case config.adjectives {
    [] → ""
    adj → "\n\nPersonality: {string}.", " · join
  }

  let topics_section = case config.topics {
    [] → ""
    topics → "\n\nTopics of expertise: {string}.", " · join
  }

  let style_section = "\n\nCommunication style:\n" +
    "- Tone: {config}.style.tone}\n" +
    "- Language: {config}.style.language

  let rules_section = case config.style.all {
    [] → ""
    rules → "\n\nRules:\n{string}.join(list.{ "- {it} }, "\n" · map
  }

  name_line}{bio_section} + adjectives_section}{topics_section} + style_section}{rules_section}
}

// =============================================================================
// FFI Imports - handlers in infra/mcp/twin_tools.gleam
// =============================================================================

// @ffi handle_twin_config_get(args: Json) → ToolResult
// @ffi handle_twin_config_set(args: Json) → ToolResult
// @ffi handle_twin_style_update(args: Json) → ToolResult
// @ffi handle_twin_examples_add(args: Json) → ToolResult
// @ffi handle_twin_export(args: Json) → ToolResult
// @ffi handle_twin_import(args: Json) → ToolResult
// @ffi handle_twin_prompt_get(args: Json) → ToolResult
// @ffi handle_twin_cache_clear(args: Json) → ToolResult

# v8.0

# v8.0
# v9.0 - Macro-Automation

# v10.0 - ML-Powered Migration
