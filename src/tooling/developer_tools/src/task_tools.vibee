// Task Tools - MCP Tools for task management
  // Performance Warning:   // AI Suggestion: Replace magic numbers with named constants  // AI Suggestion: Consider extracting hardcoded strings to constants// Converted from mcp/task_tools.gleam â†’ task_tools.vibee
// Note: DB operations remain in infra/mcp/task_tools.gleam

// =============================================================================
// Types
// =============================================================================

derive(Json)
enum(mapping: {
  Pending: "pending"
  InProgress: "in_progress"
  Waiting: "waiting"
  Completed: "completed"
  Cancelled: "cancelled"
})
struct TaskStatus {
  Pending
  InProgress
  Waiting
  Completed
  Cancelled
}

derive(Json)
enum(mapping: {
  Conversation: "conversation"
  Meeting: "meeting"
  Project: "project"
  Promise: "promise"
  Other: "other"
})
struct TaskCategory {
  Conversation   // Chat/discussion task
  Meeting        // Scheduled meeting
  Project        // Project-related
  Promise        // Commitment made
  Other          // Uncategorized
}

derive(Json)
enum(mapping: {
  High: "high"
  Medium: "medium"
  Low: "low"
})
struct TaskPriority {
  High    // Priority 1
  Medium  // Priority 2
  Low     // Priority 3
}

derive(Json)
enum(mapping: {
  Owner: "owner"
  Contact: "contact"
  Both: "both"
})
struct TaskResponsibility {
  Owner   // Task owner responsible
  Contact // Contact responsible
  Both    // Shared responsibility
}

// =============================================================================
// Tool Definitions
// =============================================================================

tool task_create {
  /// Create a new task with Telegram contact link
  description: "Create a task linked to a Telegram contact. Contacts from telegram_dialogs."

  @param title: str {
    description: "Task title"
    required: true
  }

  @param description: str? {
    description: "Task description (optional)"
  }

  @param contact_id: int? {
    description: "Contact ID from telegram_dialogs (optional)"
  }

  @param category: str? {
    enum: ["conversation", "meeting", "project", "promise", "other"]
    description: "Category: conversation=chat, meeting=call, project=work, promise=commitment"
  }

  @param priority: int? {
    enum: [1, 2, 3]
    description: "Priority: 1=high, 2=medium, 3=low"
  }

  @param responsibility: str? {
    enum: ["owner", "contact", "both"]
    description: "Responsibility: owner=me, contact=them, both=shared"
  }

  @param due_date: str? {
    description: "Deadline in ISO 8601 format (e.g.: 2024-12-31T18:00:00Z)"
  }

  @param owner_telegram_id: int? {
    description: "Telegram ID of owner (optional, from session)"
  }
}

tool task_list {
  /// list tasks with filters
  description: "Get task list with filters"

  @param status: str? {
    enum: ["pending", "in_progress", "waiting", "completed", "cancelled"]
    description: "Filter by status"
  }

  @param contact_id: int? {
    description: "Filter by contact"
  }

  @param priority: int? {
    enum: [1, 2, 3]
    description: "Filter by priority"
  }

  @param category: str? {
    enum: ["conversation", "meeting", "project", "promise", "other"]
    description: "Filter by category"
  }

  @param overdue: bool? {
    description: "Show only overdue tasks"
  }

  @param include_archived: bool? {
    description: "Include archived tasks"
  }

  @param owner_telegram_id: int? {
    description: "Telegram ID of owner"
  }
}

tool task_get {
  /// Get task details by ID
  description: "Get task details by ID"

  @param task_id: int {
    description: "Task ID"
    required: true
  }
}

tool task_update {
  /// Update task fields
  description: "Update task fields"

  @param task_id: int {
    description: "Task ID"
    required: true
  }

  @param title: str? {
    description: "New title"
  }

  @param description: str? {
    description: "New description"
  }

  @param category: str? {
    enum: ["conversation", "meeting", "project", "promise", "other"]
  }

  @param priority: int? {
    enum: [1, 2, 3]
  }

  @param responsibility: str? {
    enum: ["owner", "contact", "both"]
  }

  @param due_date: str? {
    description: "New deadline (ISO 8601)"
  }
}

tool task_status {
  /// Change task status with logging
  description: "Change task status with logging"

  @param task_id: int {
    description: "Task ID"
    required: true
  }

  @param status: str {
    enum: ["pending", "in_progress", "waiting", "completed", "cancelled"]
    description: "New status"
    required: true
  }

  @param comment: str? {
    description: "Comment on status change"
  }
}

tool task_comment {
  /// Add comment to task
  description: "Add comment to task"

  @param task_id: int {
    description: "Task ID"
    required: true
  }

  @param comment: str {
    description: "Comment text"
    required: true
  }

  @param author_telegram_id: int? {
    description: "Telegram ID of author"
  }
}

tool task_archive {
  /// Archive task (soft delete)
  description: "Archive task (soft delete)"

  @param task_id: int {
    description: "Task ID"
    required: true
  }
}

tool task_remind {
  /// Set task reminder
  description: "Set task reminder"

  @param task_id: int {
    description: "Task ID"
    required: true
  }

  @param remind_at: str? {
    description: "Reminder time (ISO 8601)"
  }

  @param preset: str? {
    enum: ["30min", "3hours", "1day", "3days"]
    description: "Preset: 30 min/3 hours/1 day/3 days before deadline"
  }
}

tool task_stats {
  /// Get task statistics
  description: "Get task statistics"

  @param owner_telegram_id: int? {
    description: "Telegram ID of owner"
  }
}

tool task_today {
  /// Get tasks for today
  description: "Get tasks for today"

  @param owner_telegram_id: int? {
    description: "Telegram ID of owner"
  }
}

tool task_overdue {
  /// Get overdue tasks
  description: "Get overdue tasks"

  @param owner_telegram_id: int? {
    description: "Telegram ID of owner"
  }
}

tool task_by_contact {
  /// Get tasks for specific contact
  description: "Get tasks with specific contact"

  @param contact_id: int {
    description: "Contact ID from telegram_dialogs"
    required: true
  }

  @param owner_telegram_id: int? {
    description: "Telegram ID of owner"
  }
}

tool task_history {
  /// Get task status history
  description: "Get task status change history"

  @param task_id: int {
    description: "Task ID"
    required: true
  }
}

// =============================================================================
// AI Task Extraction Tools
// =============================================================================

tool telegram_extract_tasks {
  /// Extract tasks from dialog using AI
  description: "Analyze Telegram dialog and extract tasks, promises, commitments using AI. Auto-creates tasks with confidence > 0.7."

  @param dialog_id: int {
    description: "Telegram dialog ID to analyze"
    required: true
  }

  @param limit: int? {
    description: "Number of messages to analyze (default: 100)"
  }

  @param auto_create: bool? {
    description: "Auto-create tasks with high confidence (default: true)"
  }

  @param owner_telegram_id: int {
    description: "Owner's Telegram ID for task assignment"
    required: true
  }
}

tool telegram_scan_all_for_tasks {
  /// Scan all personal dialogs for tasks
  description: "Scan all personal Telegram dialogs and extract tasks from each. Creates tasks automatically."

  @param limit_per_dialog: int? {
    description: "Messages to analyze per dialog (default: 50)"
  }

  @param owner_telegram_id: int {
    description: "Owner's Telegram ID for task assignment"
    required: true
  }
}

tool onboarding_status {
  /// Check automatic task extraction status
  description: "Check status of automatic task extraction for type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}. Shows progress, dialogs parsed, tasks extracted, costs."

  @param type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_telegram_id: int {
    description: "Telegram type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} ID to check status for"
    required: true
  }
}

tool task_assistant {
  /// AI assistant for task management
  description: "AI-powered task assistant. Helps manage tasks, suggests priorities, identifies overdue items, provides daily planning."

  @param action: str {
    enum: ["daily_summary", "suggest_priorities", "find_overdue", "plan_today"]
    description: "Assistant action to perform"
    required: true
  }

  @param type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_telegram_id: int {
    description: "type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}'s Telegram ID"
    required: true
  }
}

// =============================================================================
// Helper Functions
// =============================================================================

metrics("tools.task")
@spec status_from_string(s: str) â†’ TaskStatus {
  /// Parse status from string
  given: Status string
  when: Parsing type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} input
  then: Returns TaskStatus enum
}

@impl {
  match s {
    "pending" â†’ Pending
    "in_progress" â†’ InProgress
    "waiting" â†’ Waiting
    "completed" â†’ Completed
    "cancelled" â†’ Cancelled
    _ â†’ Pending
  }
}

metrics("tools.task")
@spec status_$(status: TaskStatus) â†’ str {
  /// Convert status to string
  given: TaskStatus enum
  when: Serializing response
  then: Returns status string
}

@impl {
  match status {
    Pending â†’ "pending"
    InProgress â†’ "in_progress"
    Waiting â†’ "waiting"
    Completed â†’ "completed"
    Cancelled â†’ "cancelled"
  }
}

metrics("tools.task")
@spec category_from_string(s: str) â†’ TaskCategory {
  /// Parse category from string
  given: Category string
  when: Parsing type type type type type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} input
  then: Returns TaskCategory enum
}

@impl {
  match s {
    "conversation" â†’ Conversation
    "meeting" â†’ Meeting
    "project" â†’ Project
    "promise" â†’ Promise
    "other" â†’ Other
    _ â†’ Other
  }
}

metrics("tools.task")
@spec category_$(category: TaskCategory) â†’ str {
  /// Convert category to string
  given: TaskCategory enum
  when: Serializing response
  then: Returns category string
}

@impl {
  match category {
    Conversation â†’ "conversation"
    Meeting â†’ "meeting"
    Project â†’ "project"
    Promise â†’ "promise"
    Other â†’ "other"
  }
}

metrics("tools.task")
@spec priority_emoji(p: int) â†’ str {
  /// Get emoji for priority level
  given: Priority number (1-3)
  when: Displaying priority
  then: Returns colored emoji
}

@impl {
  match p {
    1 â†’ "ğŸ”´"
    2 â†’ "ğŸŸ¡"
    3 â†’ "ğŸŸ¢"
    _ â†’ "âšª"
  }
}

metrics("tools.task")
@spec status_emoji(s: TaskStatus) â†’ str {
  /// Get emoji for status
  given: TaskStatus
  when: Displaying status
  then: Returns status emoji
}

@impl {
  match s {
    Pending â†’ "ğŸ“‹"
    InProgress â†’ "ğŸ”„"
    Waiting â†’ "â³"
    Completed â†’ "âœ…"
    Cancelled â†’ "âŒ"
  }
}

metrics("tools.task")
@spec category_emoji(c: TaskCategory) â†’ str {
  /// Get emoji for category
  given: TaskCategory
  when: Displaying category
  then: Returns category emoji
}

@impl {
  match c {
    Conversation â†’ "ğŸ’¬"
    Meeting â†’ "ğŸ“"
    Project â†’ "ğŸ‘¥"
    Promise â†’ "âœ…"
    Other â†’ "ğŸ“‹"
  }
}

// =============================================================================
// FFI Imports - DB operations in infra/mcp/task_tools.gleam
// =============================================================================

// @ffi handle_task_create(args: Json) â†’ ToolResult
// @ffi handle_task_list(args: Json) â†’ ToolResult
// @ffi handle_task_get(args: Json) â†’ ToolResult
// @ffi handle_task_update(args: Json) â†’ ToolResult
// @ffi handle_task_status(args: Json) â†’ ToolResult
// @ffi handle_task_comment(args: Json) â†’ ToolResult
// @ffi handle_task_archive(args: Json) â†’ ToolResult
// @ffi handle_task_remind(args: Json) â†’ ToolResult
// @ffi handle_task_stats(args: Json) â†’ ToolResult
// @ffi handle_task_today(args: Json) â†’ ToolResult
// @ffi handle_task_overdue(args: Json) â†’ ToolResult
// @ffi handle_task_by_contact(args: Json) â†’ ToolResult
// @ffi handle_task_history(args: Json) â†’ ToolResult

# v8.0

# v8.0
# v10.0 - ML-Powered Migration
