// Face Swap Tools
  // AI Suggestion: Replace magic numbers with named constants// Swap faces in images and videos
  // AI Suggestion: Consider extracting hardcoded strings to constants// Migrated to compact syntax with @policy references
// Based on 999-multibots-telegraf faceSwapWizard

// =============================================================================
// FACE SWAP IMAGE (Replicate)
// =============================================================================

POST @SLOW https://api.replicate.com/v1/predictions "Swap face in image using AI"
  metrics("ai.faceswap")
  @Face swapped: source + target valid → swap() → result.image_url != null
  @auth Bearer(REPLICATE_API_TOKEN)
  body("version") = "65a2e8e9a61b84f8e6c7e8a9e0f1d2c3b4a5b6c7d8e9f0a1b2c3d4e5f6a7b8c9"

  source_image: str!    body("input.source_image")  // Face to use
  target_image: str!    body("input.target_image")  // Image to swap face in
  face_restore: bool = true  body("input.face_restore")

  → { id: str!, status: str! }

GET https://api.replicate.com/v1/predictions/{prediction_id} "Check face swap status"
  @auth Bearer(REPLICATE_API_TOKEN)

  prediction_id: str!  @path

  → { status: str!, output: str?, error: str? }

// =============================================================================
// FACE SWAP VIDEO (FAL.AI)
// =============================================================================

POST @AI https://queue.fal.run/fal-ai/face-swap "Swap face in video using AI"
  metrics("ai.faceswap")
  @Face swapped: source + video valid → swap() → result.video_url != null
  @auth Bearer(FAL_KEY)

  source_image_url: str!   body("source_face")
  target_video_url: str!   body("target_video")
  enhance_face: bool = true  @body

  → { request_id: str!, status: str! }

GET https://queue.fal.run/fal-ai/face-swap/requests/{request_id} "Check face swap video status"
  @auth Bearer(FAL_KEY)

  request_id: str!  @path

  → { status: str!, video: { url: str? }?, error: str? }

// =============================================================================
// INSIGHTFACE (Alternative provider)
// =============================================================================

POST @SLOW https://api.replicate.com/v1/predictions "Swap face using InsightFace model"
  metrics("ai.faceswap")
  @Face swapped: source + target valid → swap() → result != null
  @auth Bearer(REPLICATE_API_TOKEN)
  body("version") = "c3c61d8d5f76a4f0c0e7f8b9d1e2f3a4b5c6d7e8f9a0b1c2d3e4f5a6b7c8d9e0"

  source_face: str!     body("input.source_face")
  target_image: str!    body("input.target_image")
  det_thresh: float = 0.5  body("input.det_thresh")

  → { id: str!, status: str! }

// =============================================================================
// ROOP FACE SWAP (Deepfake alternative)
// =============================================================================

POST @AI https://api.replicate.com/v1/predictions "Swap face using Roop model (high quality)"
  metrics("ai.faceswap")
  @Face swapped: source + target valid → swap() → result != null
  @auth Bearer(REPLICATE_API_TOKEN)
  body("version") = "a519cc0cfebaaeade068b23899165a11ec76aaa1a2dc5c435e35a7d3f315e331"

  source_image: str!    body("input.source")
  target_image: str!    body("input.target")
  face_restoration: str = "codeformer"  body("input.face_restoration")
  similarity_threshold: float = 0.6  body("input.similarity_threshold")

  → { id: str!, status: str! }

// =============================================================================
// FACE DETECTION
// =============================================================================

POST @FAST https://queue.fal.run/fal-ai/face-detection "Detect faces in image"
  metrics("ai.faceswap")
  @Faces detected: image valid → detect() → result.faces != null
  @auth Bearer(FAL_KEY)

  image_url: str!  @body

  → { faces: list!, count: int! }

// =============================================================================
// FACE SWAP SCENE
// =============================================================================

scene FaceSwap:
  desc: "Swap faces in images and videos"
  metrics("ai.faceswap")
  @Face swapped: source + target → swap() → result ready
  metrics("ai.faceswap")
  @Cost calculated: 15 stars per swap

  on SelectType:
    enter:
      → send(i18n:faceswap.title)
      → kb([
           btn(i18n:faceswap.type_image, "type:image"),
           btn(i18n:faceswap.type_video, "type:video"),
           btn(i18n:common.cancel, "cancel")
         ])

    @type:image → goto UploadSource("image")
    @type:video → goto UploadSource("video")
    @cancel → exit(Idle)

  on UploadSource(media_type):
    enter:
      → send(i18n:faceswap.upload_source)

    message PhotoMessage(file_id):
      → source_url = upload_photo(file_id)
      → faces = detect_faces(image_url: source_url)
      → case faces.count:
           0 → send(i18n:faceswap.no_face) && stay
           1 → goto source_url · UploadTarget
           n → send(i18n:faceswap.multiple_faces(n)) && goto source_url · UploadTarget

    @cancel → goto SelectType

  on source_url · UploadTarget:
    enter:
      → target_text = case media_type:
           "image" → i18n:common.photo
           "video" → i18n:common.video
      → send(i18n:faceswap.upload_target(target_text))

    message PhotoMessage(file_id) if media_type == "image":
      → target_url = upload_photo(file_id)
      → goto source_url, target_url · Confirm

    message VideoMessage(file_id) if media_type == "video":
      → target_url = upload_video(file_id)
      → duration = get_video_duration(target_url)
      → when duration > 60 → send(i18n:faceswap.video_too_long) && stay
           false → goto source_url, target_url · Confirm

    @back → goto UploadSource(media_type)
    @cancel → goto SelectType

  on source_url, target_url · Confirm:
    enter:
      → cost = match media_type { "image" → 15, "video" → 30 }
      → send(cost · format_confirm_message)
      → kb([
           btn(i18n:faceswap.confirm_swap(cost), "swap"),
           btn(i18n:common.back, "back"),
           btn(i18n:common.cancel, "cancel")
         ])

    @swap:
      → cost = match media_type { "image" → 15, "video" → 30 }
      → balance = get_type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_balance(type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id)
      → when balance >= cost → goto source_url, target_url, cost · Processing
           false → send(i18n:common.insufficient_funds(cost)) && stay

    @back → goto source_url · UploadTarget
    @cancel → exit(Idle)

  on source_url, target_url, cost · Processing:
    enter:
      → deduct_balance(type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id, cost, "Face Swap")
      → time_estimate = match media_type { "image" → "30s", "video" → "2-3min" }
      → send(i18n:faceswap.processing(time_estimate))
      → result = case media_type:
           "image" → faceswap_image(source_image: source_url, target_image: target_url)
           "video" → faceswap_video(source_image_url: source_url, target_video_url: target_url)
      → poll_swap(result)
      → case swap_result:
           ✅output) → goto output · Complete
           ❌err) → refund_balance(type type type type type User {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int} {
  name: String,
  email: String,
  id: Int}_id, cost) && send(i18n:common.error(err)) && exit(Idle)

  on output · Complete:
    enter:
      → case media_type:
           "image" → send_photo(output.url, caption: i18n:faceswap.complete)
           "video" → send_video(output.url, caption: i18n:faceswap.complete)
      → send(i18n:common.done)
      → kb([
           btn(i18n:faceswap.another, "another"),
           btn(i18n:common.menu, "menu")
         ])

    @another → goto SelectType
    @menu → exit(Idle)

// =============================================================================
// HELPER FUNCTIONS
// =============================================================================

cost · format_confirm_message:
  type_label = match media_type { "image" → i18n:common.photo, "video" → i18n:common.video }
  i18n:faceswap.cost · confirm_message

// =============================================================================
// PRICING CONSTANTS
// =============================================================================

let FACESWAP_PRICING = const({
  "image": { "cost_stars": 15, "time_seconds": 30, "description": "Face swap on photo" },
  "video": { "cost_stars": 30, "time_seconds": 180, "max_duration": 60, "description": "Face swap on video (up to 1 min)" }
}

# v8.0

# v10.0 - ML-Powered Migration
