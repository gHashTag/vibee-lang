// Lip-Sync Tools
// Multiple lip-sync providers: Veed Fabric, LatentSync, SyncLabs, Kling
  // Performance Warning:   // AI Suggestion: Replace magic numbers with named constants  // AI Suggestion: Consider extracting hardcoded strings to constants// Migrated to compact syntax with @policy references

// =============================================================================
// VEED FABRIC (KIE.AI) - Primary lip-sync provider
// =============================================================================

POST @AI https://api.kie.ai/api/v1/lipsync "Create lip-sync video using Veed Fabric AI via KIE.AI"
  metrics("ai.lipsync")
  @Video created: photo + audio → lipsync() → result.video_url != null
  @Pricing: duration * 0.216 per second (720p)
  @auth Bearer(KIE_AI_API_KEY)

  image_url: str!    body("source_image")
  audio_url: str!    body("driven_audio")
  resolution: str = "720p"  @body

  → { task_id: str!, status: str! }

GET https://api.kie.ai/api/v1/lipsync/{task_id} "Check Veed Fabric job status"
  @auth Bearer(KIE_AI_API_KEY)

  task_id: str!  @path

  → { status: str!, video_url: str?, duration: float?, error: str? }

// =============================================================================
// FAL.AI VEED FABRIC 1.0 FAST
// =============================================================================

POST @AI https://queue.fal.run/fal-ai/veed/fabric-1.0-fast "Create lip-sync video using FAL.AI Veed Fabric Fast"
  metrics("ai.lipsync")
  @Fast lipsync: photo + audio → generate() → video in 30-60s
  @auth Bearer(FAL_KEY)

  image_url: str!        body("source_image")
  audio_url: str!        body("driven_audio")
  video_codec: str = "h264"  @body
  output_format: str = "mp4" @body

  → { request_id: str!, status: str! }

// =============================================================================
// LATENTSYNC (ByteDance) - Budget option
// =============================================================================

POST @AI https://queue.fal.run/fal-ai/latentsync "Create lip-sync video using LatentSync (ByteDance) - budget option $0.005/sec"
  metrics("ai.lipsync")
  @Budget lipsync: photo + audio → generate() → video_url
  @auth Bearer(FAL_KEY)

  image_url: str!    body("source_image")
  audio_url: str!    body("audio_url")

  → { request_id: str!, video_url: str?, status: str! }

// =============================================================================
// SYNCLABS - Premium synchronization
// =============================================================================

POST @BACKGROUND https://api.synclabs.so/video "Create lip-sync video using SyncLabs - premium quality"
  metrics("ai.lipsync")
  @Premium sync: video + audio → sync() → result.video_url
  @auth Bearer(SYNC_LABS_API_KEY)

  video_url: str!    body("videoUrl")
  audio_url: str!    body("audioUrl")
  model: str = "sync-1.6.0"  @body
  synergize: bool = true     @body

  → { id: str!, status: str! }

GET https://api.synclabs.so/video/{video_id} "Check SyncLabs job status"
  @auth Bearer(SYNC_LABS_API_KEY)

  video_id: str!  @path

  → { id: str!, status: str!, url: str?, error: str? }

// =============================================================================
// KLING LIP-SYNC (Replicate) - Disabled in original, keeping for reference
// =============================================================================

POST @AI https://api.replicate.com/v1/predictions "Create lip-sync video using Kling via Replicate (currently disabled)"
  metrics("ai.lipsync")
  @Kling sync: photo + audio → generate() → video
  @auth Bearer(REPLICATE_API_TOKEN)
  body("version") = "a519cc0cfebaaeade068b23899165a11ec76aaa1a2dc5c435e35a7d3f315e331"

  source_image: str!  body("input.source_image")
  driven_audio: str!  body("input.driven_audio")

  → { id: str!, status: str! }

// =============================================================================
// HUMMINGBIRD-0 (Tavus) - Premium option
// =============================================================================

POST @AI https://queue.fal.run/fal-ai/hummingbird-0 "Create lip-sync video using Hummingbird-0 (Tavus) - premium $0.035/sec"
  metrics("ai.lipsync")
  @Premium avatar: photo + audio → generate() → high_quality_video
  @auth Bearer(FAL_KEY)

  image_url: str!    body("source_image")
  audio_url: str!    body("audio_url")
  resolution: str = "720p"  @body

  → { request_id: str!, video_url: str?, status: str! }

// =============================================================================
// UNIFIED LIP-SYNC PIPELINE
// =============================================================================

@pipeline
tool create_lipsync_video:
  desc: "Create lip-sync video using best available provider"
  metrics("ai.lipsync")
  @Auto provider: selects best provider based on quality/price
  circuit_breaker(threshold: 3, timeout: 60000)

  source_image: str!
  audio_url: str!
  quality: str = "standard"  // budget, standard, premium
  provider: str?             // Force specific provider

  step select_provider:
    → let ☐p) = provider
  p
         ∅-> case quality:
           "budget"   → "latentsync"
           "standard" → "veed_fabric"
           "premium"  → "hummingbird"

  step generate:
    → case selected_provider:
         "latentsync"   → audio_url · latentsync_lipsync
         "veed_fabric"  → audio_url · veed_fabric_lipsync
         "fal_veed"     → audio_url · fal_veed_fabric
         "hummingbird"  → audio_url · hummingbird_lipsync
         "synclabs"     → audio_url · synclabs_lipsync
         _ → audio_url · veed_fabric_lipsync

  step wait_completion:
    → poll_until_complete(result.task_id ?? result.request_id, max_attempts: 60, interval: 5000)

  → { video_url: str!, provider: str!, duration: float? }

// =============================================================================
// PRICING CONSTANTS
// =============================================================================

let LIPSYNC_PRICING = const({
  "latentsync": { "base": 0.20, "per_second": 0.005, "description": "Budget option, good quality" },
  "veed_fabric": { "per_second_p": 0.10, "per_second_p": 0.216, "per_second_p": 0.35, "description": "Standard quality, reliable" },
  "fal_veed_fast": { "per_second": 0.15, "description": "Fast processing, good quality" },
  "hummingbird": { "per_second": 0.035, "description": "Premium quality, Tavus technology" },
  "synclabs": { "per_second": 0.05, "description": "Premium sync quality" },
  "kling": { "per_second": 0.014, "description": "Disabled - use alternatives" }
}

let ACTIVE_PROVIDERS = const(["veed_fabric", "fal_veed", "latentsync", "hummingbird"]

# v8.0

# v10.0 - ML-Powered Migration
