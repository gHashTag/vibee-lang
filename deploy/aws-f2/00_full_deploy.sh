#!/bin/bash
# ═══════════════════════════════════════════════════════════════════════════════
# TRINITY FPGA - ПОЛНЫЙ АВТОДЕПЛОЙ
# ═══════════════════════════════════════════════════════════════════════════════
# Запускает все шаги последовательно
# φ² + 1/φ² = 3 | PHOENIX = 999
# ═══════════════════════════════════════════════════════════════════════════════

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

echo "═══════════════════════════════════════════════════════════════════════════════"
echo "                    TRINITY FPGA - ПОЛНЫЙ АВТОДЕПЛОЙ"
echo "                    φ² + 1/φ² = 3 | PHOENIX = 999"
echo "═══════════════════════════════════════════════════════════════════════════════"
echo ""
echo "⚠️  ВНИМАНИЕ:"
echo "   - Общее время: 2-3 часа"
echo "   - Стоимость: ~\$5-10"
echo "   - Требуется одобренный лимит F2!"
echo ""
read -p "Продолжить? (y/n): " -n 1 -r
echo ""

if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "Отменено."
    exit 0
fi

echo ""
echo "═══════════════════════════════════════════════════════════════════════════════"
echo "                    ШАГ 1/5: ЗАПУСК F2 ИНСТАНСА"
echo "═══════════════════════════════════════════════════════════════════════════════"
$SCRIPT_DIR/01_launch_f2.sh

echo ""
echo "═══════════════════════════════════════════════════════════════════════════════"
echo "                    ШАГ 2/5: НАСТРОЙКА ОКРУЖЕНИЯ"
echo "═══════════════════════════════════════════════════════════════════════════════"
sleep 60  # Ждём полной инициализации
$SCRIPT_DIR/02_setup_fpga.sh

echo ""
echo "═══════════════════════════════════════════════════════════════════════════════"
echo "                    ШАГ 3/5: СБОРКА AFI"
echo "═══════════════════════════════════════════════════════════════════════════════"
echo "⚠️  Это займёт 1-2 часа!"
$SCRIPT_DIR/03_build_afi.sh

echo ""
echo "═══════════════════════════════════════════════════════════════════════════════"
echo "                    ⏳ ОЖИДАНИЕ СБОРКИ AFI"
echo "═══════════════════════════════════════════════════════════════════════════════"
echo ""
echo "Сборка запущена в фоне."
echo "Проверяй статус вручную:"
echo ""
PUBLIC_IP=$(cat /tmp/trinity_public_ip)
echo "  ssh -i ~/.ssh/trinity-fpga-key.pem centos@$PUBLIC_IP 'tail -f ~/build.log'"
echo ""
echo "Когда сборка завершится, выполни:"
echo "  $SCRIPT_DIR/04_test_trinity.sh"
echo ""
echo "После тестов НЕ ЗАБУДЬ:"
echo "  $SCRIPT_DIR/05_stop_instance.sh"
echo ""
echo "═══════════════════════════════════════════════════════════════════════════════"
echo "                    φ² + 1/φ² = 3 | TRINITY DEPLOYING..."
echo "═══════════════════════════════════════════════════════════════════════════════"
