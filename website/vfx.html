<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VibeeVFX - Live Code Visual Effects</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Fira Code', monospace; background: #0a0a0a; color: #fff; overflow: hidden; }
        #canvas { position: fixed; top: 0; left: 0; z-index: 0; }
        .ui { position: fixed; z-index: 10; }
        .editor-panel {
            bottom: 0; left: 0; right: 0;
            background: rgba(20, 20, 30, 0.95);
            border-top: 2px solid #6366f1;
            transition: transform 0.3s;
        }
        .editor-panel.collapsed { transform: translateY(calc(100% - 40px)); }
        .panel-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 20px; background: rgba(99, 102, 241, 0.2); cursor: pointer;
        }
        .panel-header h2 { font-size: 14px; color: #22d3ee; }
        .controls { display: flex; gap: 10px; }
        .btn {
            padding: 8px 16px; border: none; border-radius: 5px;
            font-family: inherit; font-size: 12px; cursor: pointer; transition: all 0.2s;
        }
        .btn-run { background: #10b981; color: #fff; }
        .btn-run:hover { background: #059669; }
        .btn-stop { background: #ef4444; color: #fff; }
        .btn-examples { background: #6366f1; color: #fff; }
        .editor-content { display: flex; height: 250px; }
        #code {
            flex: 1; background: transparent; border: none; color: #e2e8f0;
            font-family: 'Fira Code', monospace; font-size: 14px;
            padding: 15px; resize: none; outline: none;
        }
        .output {
            width: 300px; background: rgba(0,0,0,0.3);
            padding: 15px; overflow-y: auto; font-size: 12px; color: #94a3b8;
            border-left: 1px solid rgba(255,255,255,0.1);
        }
        .output .success { color: #10b981; }
        .output .error { color: #ef4444; }
        .examples-panel {
            top: 60px; right: 20px; width: 280px;
            background: rgba(20, 20, 30, 0.95); border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.1); display: none;
        }
        .examples-panel.show { display: block; }
        .examples-panel h3 { padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); color: #22d3ee; }
        .example-item {
            padding: 12px 15px; cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.05);
            transition: background 0.2s;
        }
        .example-item:hover { background: rgba(99, 102, 241, 0.2); }
        .example-item h4 { font-size: 13px; margin-bottom: 4px; }
        .example-item p { font-size: 11px; color: #94a3b8; }
        .stats {
            top: 20px; left: 20px; background: rgba(0,0,0,0.5);
            padding: 10px 15px; border-radius: 8px; font-size: 12px;
        }
        .stats span { color: #22d3ee; }
        .logo { top: 20px; right: 20px; font-size: 24px; font-weight: bold; }
        .logo span { color: #6366f1; }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>
    
    <div class="ui stats">
        FPS: <span id="fps">60</span> | Particles: <span id="particles">0</span> | Time: <span id="time">0.0</span>s
    </div>
    
    <div class="ui logo">Vibee<span>VFX</span></div>
    
    <div class="ui examples-panel" id="examples">
        <h3>Examples</h3>
        <div class="example-item" onclick="loadExample('particles')">
            <h4>ðŸŒŸ Particle Storm</h4>
            <p>Colorful particle explosion</p>
        </div>
        <div class="example-item" onclick="loadExample('waves')">
            <h4>ðŸŒŠ Audio Waves</h4>
            <p>Reactive sound visualization</p>
        </div>
        <div class="example-item" onclick="loadExample('matrix')">
            <h4>ðŸ’š Matrix Rain</h4>
            <p>Digital rain effect</p>
        </div>
        <div class="example-item" onclick="loadExample('fractal')">
            <h4>ðŸ”® Fractal Tree</h4>
            <p>Recursive branching</p>
        </div>
        <div class="example-item" onclick="loadExample('audio')">
            <h4>ðŸŽµ Synth + Visuals</h4>
            <p>Sound reactive graphics</p>
        </div>
        <div class="example-item" onclick="loadExample('galaxy')">
            <h4>ðŸŒŒ Galaxy Spiral</h4>
            <p>Cosmic star field</p>
        </div>
    </div>
    
    <div class="ui editor-panel" id="panel">
        <div class="panel-header" onclick="togglePanel()">
            <h2>// Live Code Editor - Press Ctrl+Enter to run</h2>
            <div class="controls">
                <button class="btn btn-examples" onclick="event.stopPropagation(); toggleExamples()">Examples</button>
                <button class="btn btn-run" onclick="event.stopPropagation(); runCode()">â–¶ Run</button>
                <button class="btn btn-stop" onclick="event.stopPropagation(); stopCode()">â–  Stop</button>
            </div>
        </div>
        <div class="editor-content">
            <textarea id="code">// Welcome to VibeeVFX!
// Live code visual effects with Vibee syntax

// Create particles
loop 100 {
    spawn particle {
        x: random(width),
        y: random(height),
        color: hsb(time * 50, 80, 100),
        size: random(2, 8),
        vx: random(-2, 2),
        vy: random(-2, 2)
    }
}

// Update particles
on_frame {
    clear(0, 0, 0, 0.1)
    
    for p in particles {
        p.x += p.vx
        p.y += p.vy
        p.vy += 0.05  // gravity
        
        // Bounce
        if p.y > height { p.vy *= -0.8 }
        if p.x < 0 or p.x > width { p.vx *= -1 }
        
        draw_circle(p.x, p.y, p.size, p.color)
    }
}</textarea>
            <div class="output" id="output">Ready to code visuals...<br></div>
        </div>
    </div>

    <script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const output = document.getElementById('output');

let width, height, particles = [], running = false, startTime = 0, animId;
let audioCtx, analyser, dataArray;

function resize() {
    width = canvas.width = window.innerWidth;
    height = canvas.height = window.innerHeight;
}
resize();
window.addEventListener('resize', resize);

// Audio setup
function initAudio() {
    if (audioCtx) return;
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 256;
    dataArray = new Uint8Array(analyser.frequencyBinCount);
}

function playNote(freq, duration = 0.3, type = 'sine') {
    initAudio();
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = type;
    osc.frequency.value = freq;
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    gain.connect(analyser);
    gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
    osc.start();
    osc.stop(audioCtx.currentTime + duration);
}

// VFX Engine
const vfx = {
    time: 0,
    width: () => width,
    height: () => height,
    random: (a, b) => b ? a + Math.random() * (b - a) : Math.random() * a,
    hsb: (h, s, b) => `hsl(${h % 360}, ${s}%, ${b}%)`,
    rgb: (r, g, b, a = 1) => `rgba(${r}, ${g}, ${b}, ${a})`,
    clear: (r = 0, g = 0, b = 0, a = 1) => {
        ctx.fillStyle = `rgba(${r}, ${g}, ${b}, ${a})`;
        ctx.fillRect(0, 0, width, height);
    },
    draw_circle: (x, y, r, color) => {
        ctx.beginPath();
        ctx.arc(x, y, r, 0, Math.PI * 2);
        ctx.fillStyle = color;
        ctx.fill();
    },
    draw_rect: (x, y, w, h, color) => {
        ctx.fillStyle = color;
        ctx.fillRect(x, y, w, h);
    },
    draw_line: (x1, y1, x2, y2, color, w = 1) => {
        ctx.strokeStyle = color;
        ctx.lineWidth = w;
        ctx.beginPath();
        ctx.moveTo(x1, y1);
        ctx.lineTo(x2, y2);
        ctx.stroke();
    },
    draw_text: (text, x, y, color, size = 16) => {
        ctx.fillStyle = color;
        ctx.font = `${size}px monospace`;
        ctx.fillText(text, x, y);
    },
    sin: Math.sin, cos: Math.cos, abs: Math.abs,
    noise: (x) => Math.sin(x * 12.9898) * 43758.5453 % 1,
    lerp: (a, b, t) => a + (b - a) * t,
    map: (v, a, b, c, d) => c + (v - a) / (b - a) * (d - c),
    audio_level: () => {
        if (!analyser) return 0;
        analyser.getByteFrequencyData(dataArray);
        return dataArray.reduce((a, b) => a + b) / dataArray.length / 255;
    },
    play: playNote,
    spawn_particle: (opts) => particles.push({...opts, life: opts.life || 100}),
};

function log(msg, type = '') {
    output.innerHTML += `<span class="${type}">${msg}</span><br>`;
    output.scrollTop = output.scrollHeight;
}

function parseCode(code) {
    let initCode = '', frameCode = '';
    const lines = code.split('\n');
    let inFrame = false, braceCount = 0;
    
    for (let line of lines) {
        if (line.includes('on_frame')) { inFrame = true; braceCount = 0; continue; }
        if (inFrame) {
            braceCount += (line.match(/{/g) || []).length - (line.match(/}/g) || []).length;
            if (braceCount <= 0 && line.includes('}')) { inFrame = false; continue; }
            frameCode += line + '\n';
        } else {
            initCode += line + '\n';
        }
    }
    return { initCode, frameCode };
}

function transpile(code) {
    return code
        .replace(/loop\s+(\d+)\s*{/g, 'for(let i=0;i<$1;i++){')
        .replace(/spawn\s+particle\s*{/g, 'vfx.spawn_particle({')
        .replace(/for\s+(\w+)\s+in\s+(\w+)\s*{/g, 'for(let $1 of $2){')
        .replace(/(\w+):\s*([^,}]+)/g, '$1: $2')
        .replace(/random\(/g, 'vfx.random(')
        .replace(/hsb\(/g, 'vfx.hsb(')
        .replace(/rgb\(/g, 'vfx.rgb(')
        .replace(/clear\(/g, 'vfx.clear(')
        .replace(/draw_circle\(/g, 'vfx.draw_circle(')
        .replace(/draw_rect\(/g, 'vfx.draw_rect(')
        .replace(/draw_line\(/g, 'vfx.draw_line(')
        .replace(/draw_text\(/g, 'vfx.draw_text(')
        .replace(/\bwidth\b/g, 'vfx.width()')
        .replace(/\bheight\b/g, 'vfx.height()')
        .replace(/\btime\b/g, 'vfx.time')
        .replace(/\bsin\(/g, 'vfx.sin(')
        .replace(/\bcos\(/g, 'vfx.cos(')
        .replace(/\babs\(/g, 'vfx.abs(')
        .replace(/\baudio_level\(/g, 'vfx.audio_level(')
        .replace(/\bplay\(/g, 'vfx.play(')
        .replace(/\bor\b/g, '||')
        .replace(/\band\b/g, '&&');
}

let frameFunc = null;

function runCode() {
    try {
        stopCode();
        particles = [];
        const code = document.getElementById('code').value;
        const { initCode, frameCode } = parseCode(code);
        
        const jsInit = transpile(initCode);
        const jsFrame = transpile(frameCode);
        
        eval(jsInit);
        frameFunc = new Function('particles', 'vfx', jsFrame);
        
        running = true;
        startTime = performance.now();
        log('âœ“ Running...', 'success');
        animate();
    } catch (e) {
        log('âœ— ' + e.message, 'error');
    }
}

function stopCode() {
    running = false;
    if (animId) cancelAnimationFrame(animId);
    frameFunc = null;
}

function animate() {
    if (!running) return;
    vfx.time = (performance.now() - startTime) / 1000;
    
    if (frameFunc) {
        try { frameFunc(particles, vfx); } catch(e) { log('âœ— ' + e.message, 'error'); stopCode(); }
    }
    
    particles = particles.filter(p => (p.life === undefined || --p.life > 0));
    
    document.getElementById('fps').textContent = Math.round(1000 / 16);
    document.getElementById('particles').textContent = particles.length;
    document.getElementById('time').textContent = vfx.time.toFixed(1);
    
    animId = requestAnimationFrame(animate);
}

function togglePanel() {
    document.getElementById('panel').classList.toggle('collapsed');
}

function toggleExamples() {
    document.getElementById('examples').classList.toggle('show');
}

const examples = {
    particles: `// Particle Storm
loop 200 {
    spawn particle {
        x: random(width), y: random(height),
        color: hsb(random(360), 80, 100),
        size: random(2, 6),
        vx: random(-3, 3), vy: random(-3, 3)
    }
}

on_frame {
    clear(0, 0, 0, 0.05)
    for p in particles {
        p.x += p.vx
        p.y += p.vy
        if p.x < 0 or p.x > width { p.vx *= -1 }
        if p.y < 0 or p.y > height { p.vy *= -1 }
        p.color = hsb(time * 100 + p.x * 0.5, 80, 100)
        draw_circle(p.x, p.y, p.size, p.color)
    }
}`,
    waves: `// Audio Reactive Waves
on_frame {
    clear(0, 0, 20, 0.1)
    let bars = 64
    let w = width / bars
    
    for i in range(bars) {
        let h = sin(time * 3 + i * 0.2) * 100 + 150
        let hue = i * 5 + time * 50
        draw_rect(i * w, height/2 - h/2, w - 2, h, hsb(hue, 70, 80))
    }
}

// Click to add sound
loop 1 {
    play(440, 0.5)
}`,
    matrix: `// Matrix Rain
loop 50 {
    spawn particle {
        x: random(width),
        y: random(-500, 0),
        speed: random(5, 15),
        char: String.fromCharCode(0x30A0 + random(96))
    }
}

on_frame {
    clear(0, 10, 0, 0.05)
    for p in particles {
        p.y += p.speed
        if p.y > height { p.y = -20; p.x = random(width) }
        let alpha = 1 - p.y / height
        draw_text(p.char, p.x, p.y, rgb(0, 255, 70, alpha), 16)
    }
}`,
    fractal: `// Fractal Tree
on_frame {
    clear(0, 0, 0, 1)
    
    function branch(x, y, len, angle, depth) {
        if (depth <= 0 || len < 2) return
        let x2 = x + cos(angle) * len
        let y2 = y + sin(angle) * len
        let hue = depth * 30 + time * 50
        draw_line(x, y, x2, y2, hsb(hue, 70, 80), depth)
        let sway = sin(time * 2 + depth) * 0.1
        branch(x2, y2, len * 0.7, angle - 0.5 + sway, depth - 1)
        branch(x2, y2, len * 0.7, angle + 0.5 + sway, depth - 1)
    }
    
    branch(width/2, height, 120, -1.57, 10)
}`,
    audio: `// Synth + Visuals
loop 1 {
    play(261, 0.3)
    play(329, 0.3)
    play(392, 0.3)
}

loop 100 {
    spawn particle {
        x: width/2, y: height/2,
        angle: random(6.28),
        speed: random(1, 5),
        hue: random(360)
    }
}

on_frame {
    clear(10, 10, 20, 0.1)
    let level = audio_level() * 3 + 0.5
    
    for p in particles {
        p.x += cos(p.angle) * p.speed * level
        p.y += sin(p.angle) * p.speed * level
        let dist = abs(p.x - width/2) + abs(p.y - height/2)
        if dist > 500 { p.x = width/2; p.y = height/2 }
        draw_circle(p.x, p.y, 3 * level, hsb(p.hue + time * 100, 80, 90))
    }
    
    // Center pulse
    let r = 50 + level * 100
    draw_circle(width/2, height/2, r, hsb(time * 100, 60, 50))
}`,
    galaxy: `// Galaxy Spiral
loop 500 {
    let angle = random(6.28)
    let dist = random(50, 300)
    spawn particle {
        angle: angle,
        dist: dist,
        speed: 0.002 + random(0.001),
        size: random(1, 3),
        hue: dist
    }
}

on_frame {
    clear(0, 0, 10, 0.05)
    let cx = width / 2
    let cy = height / 2
    
    for p in particles {
        p.angle += p.speed
        let x = cx + cos(p.angle + p.dist * 0.01) * p.dist
        let y = cy + sin(p.angle + p.dist * 0.01) * p.dist * 0.6
        draw_circle(x, y, p.size, hsb(p.hue + time * 20, 70, 90))
    }
    
    // Center glow
    for i in range(5) {
        draw_circle(cx, cy, 30 - i * 5, hsb(time * 50, 50, 100 - i * 15))
    }
}`
};

function loadExample(name) {
    document.getElementById('code').value = examples[name];
    toggleExamples();
    runCode();
}

// Keyboard shortcut
document.addEventListener('keydown', (e) => {
    if (e.ctrlKey && e.key === 'Enter') { e.preventDefault(); runCode(); }
    if (e.key === 'Escape') stopCode();
});

// Range helper
window.range = (n) => [...Array(n).keys()];

// Auto-run on load
setTimeout(runCode, 500);
    </script>
</body>
</html>
