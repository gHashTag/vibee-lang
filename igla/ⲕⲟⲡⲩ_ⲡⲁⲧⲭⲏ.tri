// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â²”â²â² â²¨-â²€â²šâ²†-â² â²€â²¦â²¬â² JIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â²¤â²€â²”â²¢â²€ â²ªâ²â²¢â²˜â²¨â²–â²€: V = n Ã— 3^k Ã— Ï€^m Ã— Ï†^p Ã— e^q
// â²Œâ²â²–â²â²¦â²€â²’â²€ â²’â²†â²ˆâ²šâ²¦â²’â²¬â²šâ²â²¤â²¦â²’: Ï†Â² + 1/Ï†Â² = 3
// SOURCE: arXiv:2011.13127 (Xu & Kjolstad, OOPSLA 2021)
// RESULT: 100-1000x faster compile vs LLVM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â²§â²£â²“â²›â²“â²§â²“ â²•â²Ÿâ²¡â²©_â²¡â²â²§â²­â² {
    â²Ÿâ²›â²Ÿâ²™â²: "Copy-and-Patch JIT"
    â²ƒâ²‰â²£â²¥â²“â²: "1.0.0"
    â²¡â²â²§â²§â²‰â²£â²›: "PRE"
    â²•â²Ÿâ²›â²«â²“â²‡â²‰â²›â²•â²‰: 0.85
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // CORE CONCEPT
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    â²•â²Ÿâ²›â²•â²‰â²¡â²§: """
    Copy-and-Patch JIT uses pre-compiled binary code templates (stencils)
    instead of generating code from scratch. Each stencil contains "holes"
    that are filled (patched) with runtime values.
    
    Why it's fast:
    1. No parsing/analysis - code is already compiled
    2. No register allocation - already done
    3. No instruction selection - already done
    4. Just memcpy + patch holes
    
    Results from paper:
    - 100-1000x faster compile vs LLVM -O0
    - Runtime performance within 15% of LLVM -O2
    - Used in CPython 3.13 JIT
    """
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // STENCIL STRUCTURE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    â²¥â²§â²‰â²›â²•â²“â²— {
        â²«â²“â²‰â²—â²‡â²¥: [
            { â²Ÿâ²›â²Ÿâ²™â²: "code", â²§â²©â²¡â²‰: "[64]u8", â²‡â²‰â²¥â²•â²£â²“â²¡â²§â²“â²Ÿ: "Pre-compiled machine code" },
            { â²Ÿâ²›â²Ÿâ²™â²: "size", â²§â²©â²¡â²‰: "usize", â²‡â²‰â²¥â²•â²£â²“â²¡â²§â²“â²Ÿ: "Code size in bytes" },
            { â²Ÿâ²›â²Ÿâ²™â²: "holes", â²§â²©â²¡â²‰: "[4]Hole", â²‡â²‰â²¥â²•â²£â²“â²¡â²§â²“â²Ÿ: "Holes for patching" },
            { â²Ÿâ²›â²Ÿâ²™â²: "hole_count", â²§â²©â²¡â²‰: "usize" }
        ]
        
        â²â²Ÿâ²—â²‰: {
            â²«â²“â²‰â²—â²‡â²¥: [
                { â²Ÿâ²›â²Ÿâ²™â²: "offset", â²§â²©â²¡â²‰: "usize", â²‡â²‰â²¥â²•â²£â²“â²¡â²§â²“â²Ÿ: "Offset in code" },
                { â²Ÿâ²›â²Ÿâ²™â²: "size", â²§â²©â²¡â²‰: "usize", â²‡â²‰â²¥â²•â²£â²“â²¡â²§â²“â²Ÿ: "4 for i32, 8 for i64" },
                { â²Ÿâ²›â²Ÿâ²™â²: "kind", â²§â²©â²¡â²‰: "HoleKind" }
            ]
        }
        
        â²â²Ÿâ²—â²‰_â²•â²“â²›â²‡: [
            { â²•â²Ÿâ²‡â²‰: 0, â²Ÿâ²›â²Ÿâ²™â²: "immediate", â²‡â²‰â²¥â²•â²£â²“â²¡â²§â²“â²Ÿ: "Direct value" },
            { â²•â²Ÿâ²‡â²‰: 1, â²Ÿâ²›â²Ÿâ²™â²: "pc_relative", â²‡â²‰â²¥â²•â²£â²“â²¡â²§â²“â²Ÿ: "PC-relative address" },
            { â²•â²Ÿâ²‡â²‰: 2, â²Ÿâ²›â²Ÿâ²™â²: "absolute", â²‡â²‰â²¥â²•â²£â²“â²¡â²§â²“â²Ÿ: "Absolute address" }
        ]
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // STENCIL LIBRARY (x86-64)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    â²¥â²§â²‰â²›â²•â²“â²—_â²—â²“â²ƒâ²£â²â²£â²© {
        // Arithmetic (rax = rax op rdi)
        â²â²‡â²‡: { â²•â²Ÿâ²‡â²‰: [0x48, 0x01, 0xF8], â²¥â²“â²â²‰: 3, â²â²Ÿâ²—â²‰â²¥: 0 }  // add rax, rdi
        â²¥â²©â²ƒ: { â²•â²Ÿâ²‡â²‰: [0x48, 0x29, 0xF8], â²¥â²“â²â²‰: 3, â²â²Ÿâ²—â²‰â²¥: 0 }  // sub rax, rdi
        â²™â²©â²—: { â²•â²Ÿâ²‡â²‰: [0x48, 0x0F, 0xAF, 0xC7], â²¥â²“â²â²‰: 4, â²â²Ÿâ²—â²‰â²¥: 0 }  // imul rax, rdi
        
        // Load immediate (rax = imm64)
        â²™â²Ÿâ²ƒ_â²“â²™â²™: { 
            â²•â²Ÿâ²‡â²‰: [0x48, 0xB8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00], 
            â²¥â²“â²â²‰: 10, 
            â²â²Ÿâ²—â²‰â²¥: [{ â²Ÿâ²«â²«â²¥â²‰â²§: 2, â²¥â²“â²â²‰: 8, â²•â²“â²›â²‡: "immediate" }]
        }  // movabs rax, imm64
        
        // Control flow
        â²£â²‰â²§: { â²•â²Ÿâ²‡â²‰: [0xC3], â²¥â²“â²â²‰: 1, â²â²Ÿâ²—â²‰â²¥: 0 }  // ret
        â²“â²™â²¡: { 
            â²•â²Ÿâ²‡â²‰: [0xE9, 0x00, 0x00, 0x00, 0x00], 
            â²¥â²“â²â²‰: 5, 
            â²â²Ÿâ²—â²‰â²¥: [{ â²Ÿâ²«â²«â²¥â²‰â²§: 1, â²¥â²“â²â²‰: 4, â²•â²“â²›â²‡: "pc_relative" }]
        }  // jmp rel32
        
        // Conditional jump
        â²“â²: { 
            â²•â²Ÿâ²‡â²‰: [0x0F, 0x84, 0x00, 0x00, 0x00, 0x00], 
            â²¥â²“â²â²‰: 6, 
            â²â²Ÿâ²—â²‰â²¥: [{ â²Ÿâ²«â²«â²¥â²‰â²§: 2, â²¥â²“â²â²‰: 4, â²•â²“â²›â²‡: "pc_relative" }]
        }  // jz rel32
        
        // Stack operations
        â²¡â²©â²¥â²_â²£â²â²: { â²•â²Ÿâ²‡â²‰: [0x50], â²¥â²“â²â²‰: 1, â²â²Ÿâ²—â²‰â²¥: 0 }  // push rax
        â²¡â²Ÿâ²¡_â²£â²â²: { â²•â²Ÿâ²‡â²‰: [0x58], â²¥â²“â²â²‰: 1, â²â²Ÿâ²—â²‰â²¥: 0 }  // pop rax
        
        // Trinity-specific (x * 3)
        â²™â²©â²—3: { 
            â²•â²Ÿâ²‡â²‰: [0x48, 0x6B, 0xC0, 0x03], 
            â²¥â²“â²â²‰: 4, 
            â²â²Ÿâ²—â²‰â²¥: 0 
        }  // imul rax, rax, 3
        
        // Golden ratio (x * Ï† â‰ˆ x * 1.618)
        // Approximation: x + x/2 + x/8 = x * 1.625
        â²¡â²â²“_â²™â²©â²—: {
            â²•â²Ÿâ²‡â²‰: [
                0x48, 0x89, 0xC7,        // mov rdi, rax
                0x48, 0xD1, 0xEF,        // shr rdi, 1 (rdi = x/2)
                0x48, 0x01, 0xF8,        // add rax, rdi (rax = x + x/2)
                0x48, 0xC1, 0xEF, 0x02,  // shr rdi, 2 (rdi = x/8)
                0x48, 0x01, 0xF8         // add rax, rdi (rax â‰ˆ x * 1.625)
            ],
            â²¥â²“â²â²‰: 17,
            â²â²Ÿâ²—â²‰â²¥: 0
        }
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ALGORITHM
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    â²â²—â²…â²Ÿâ²£â²“â²§â²â²™ {
        â²‰â²™â²“â²§: """
        fn emit(stencil: *const Stencil, buffer: []u8, values: []const u64) usize {
            // 1. Copy stencil code to buffer
            @memcpy(buffer[0..stencil.size], stencil.code[0..stencil.size]);
            
            // 2. Patch holes with runtime values
            for (0..stencil.hole_count) |i| {
                const hole = stencil.holes[i];
                const value = values[i];
                
                if (hole.kind == .pc_relative) {
                    // Calculate relative offset
                    const target = value;
                    const current = @intFromPtr(buffer.ptr) + hole.offset + hole.size;
                    const rel = @as(i32, @truncate(@as(i64, target) - @as(i64, current)));
                    @memcpy(buffer[hole.offset..][0..4], @as([4]u8, @bitCast(rel)));
                } else {
                    // Direct value
                    if (hole.size == 8) {
                        @memcpy(buffer[hole.offset..][0..8], @as([8]u8, @bitCast(value)));
                    } else {
                        @memcpy(buffer[hole.offset..][0..4], @as([4]u8, @bitCast(@as(u32, @truncate(value)))));
                    }
                }
            }
            
            return stencil.size;
        }
        """
        
        â²•â²Ÿâ²™â²¡â²“â²—â²‰: """
        fn compile(bytecode: []const u8, output: []u8) usize {
            var pos: usize = 0;
            var pc: usize = 0;
            
            while (pc < bytecode.len) {
                const op = bytecode[pc];
                pc += 1;
                
                switch (op) {
                    ADD => pos += emit(&stencils.add, output[pos..], &.{}),
                    SUB => pos += emit(&stencils.sub, output[pos..], &.{}),
                    MUL => pos += emit(&stencils.mul, output[pos..], &.{}),
                    PUSH => {
                        const imm = readImm64(bytecode, &pc);
                        pos += emit(&stencils.mov_imm, output[pos..], &.{imm});
                    },
                    MUL3 => pos += emit(&stencils.mul3, output[pos..], &.{}),
                    RET => pos += emit(&stencils.ret, output[pos..], &.{}),
                }
            }
            
            return pos;
        }
        """
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // BEHAVIORS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    â²ƒâ²‰â²â²â²ƒâ²“â²Ÿâ²£â²¥ {
        â²§â²‰â²¥â²§ "â²¥â²§â²‰â²›â²•â²“â²—_â²‰â²™â²“â²§_â²›â²Ÿ_â²â²Ÿâ²—â²‰â²¥" {
            â²…â²“â²ƒâ²‰â²›: "stencil for ADD (no holes)"
            â²±â²â²‰â²›: "emit(add, buffer, {})"
            â²§â²â²‰â²›: "buffer contains [0x48, 0x01, 0xF8]"
        }
        
        â²§â²‰â²¥â²§ "â²¥â²§â²‰â²›â²•â²“â²—_â²‰â²™â²“â²§_â²“â²™â²™â²‰â²‡â²“â²â²§â²‰" {
            â²…â²“â²ƒâ²‰â²›: "stencil for MOV_IMM with hole at offset 2"
            â²±â²â²‰â²›: "emit(mov_imm, buffer, {42})"
            â²§â²â²‰â²›: "buffer[2..10] contains 42 as little-endian i64"
        }
        
        â²§â²‰â²¥â²§ "â²¥â²§â²‰â²›â²•â²“â²—_â²‰â²™â²“â²§_â²¡â²•_â²£â²‰â²—â²â²§â²“â²ƒâ²‰" {
            â²…â²“â²ƒâ²‰â²›: "stencil for JMP with pc-relative hole"
            â²±â²â²‰â²›: "emit(jmp, buffer, {target_addr})"
            â²§â²â²‰â²›: "buffer[1..5] contains relative offset"
        }
        
        â²§â²‰â²¥â²§ "â²•â²Ÿâ²™â²¡â²“â²—â²‰_â²â²‡â²‡" {
            â²…â²“â²ƒâ²‰â²›: "bytecode [ADD]"
            â²±â²â²‰â²›: "compile(bytecode, output)"
            â²§â²â²‰â²›: "output contains x86-64 add instruction"
        }
        
        â²§â²‰â²¥â²§ "â²•â²Ÿâ²™â²¡â²“â²—â²‰_â²™â²©â²—3" {
            â²…â²“â²ƒâ²‰â²›: "bytecode [MUL3]"
            â²±â²â²‰â²›: "compile(bytecode, output)"
            â²§â²â²‰â²›: "output contains imul rax, rax, 3"
        }
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // â²”â²â²†â²ˆ â²„â²ˆâ²šâ²ˆâ²¢â²€â²¦â²’â²â²š â²¤â² â²ˆâ²”â²’â²ªâ²’â²”â²€â²¦â²’â²â²š
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    â²•â²Ÿâ²‡â²‰_â²…â²‰â²›â²‰â²£â²â²§â²“â²Ÿâ²› {
        â²—â²â²›â²…â²©â²â²…â²‰: "zig"
        â²Ÿâ²©â²§â²¡â²©â²§_â²‡â²“â²£: "output/"
        â²«â²“â²—â²‰: "copy_patch_jit.zig"
        
        // â²¤â²€â²”â²¢â²€ â²”â²â²šâ²¤â²¦â²€â²šâ²¦â²¤
        â²•â²Ÿâ²›â²¥â²§â²â²›â²§â²¥: {
            PHI: 1.618033988749895
            TRINITY: 3
            STENCIL_MAX_SIZE: 64
            MAX_HOLES: 4
        }
        
        // â²â²â²–â²ˆ â²”â²’â²šâ²† â²ˆâ²šâ²¨â²˜
        â²â²Ÿâ²—â²‰_â²•â²“â²›â²‡_â²‰â²›â²©â²™: {
            â²Ÿâ²›â²Ÿâ²™â²: "HoleKind"
            â²ƒâ²â²—â²©â²‰â²¥: [
                { â²•â²Ÿâ²‡â²‰: 0, â²Ÿâ²›â²Ÿâ²™â²: "immediate" },
                { â²•â²Ÿâ²‡â²‰: 1, â²Ÿâ²›â²Ÿâ²™â²: "pc_relative" },
                { â²•â²Ÿâ²‡â²‰: 2, â²Ÿâ²›â²Ÿâ²™â²: "absolute" }
            ]
        }
        
        // â²â²â²–â²ˆ â²¤â²¦â²¢â²¨â²”â²¦
        â²â²Ÿâ²—â²‰_â²¥â²§â²£â²©â²•â²§: {
            â²Ÿâ²›â²Ÿâ²™â²: "Hole"
            â²«â²“â²‰â²—â²‡â²¥: [
                { â²Ÿâ²›â²Ÿâ²™â²: "offset", â²§â²©â²¡â²‰: "usize" },
                { â²Ÿâ²›â²Ÿâ²™â²: "size", â²§â²©â²¡â²‰: "usize" },
                { â²Ÿâ²›â²Ÿâ²™â²: "kind", â²§â²©â²¡â²‰: "HoleKind" }
            ]
        }
        
        // â²¤â²¦â²ˆâ²šâ²”â²’â²– â²¤â²¦â²¢â²¨â²”â²¦
        â²¥â²§â²‰â²›â²•â²“â²—_â²¥â²§â²£â²©â²•â²§: {
            â²Ÿâ²›â²Ÿâ²™â²: "Stencil"
            â²«â²“â²‰â²—â²‡â²¥: [
                { â²Ÿâ²›â²Ÿâ²™â²: "code", â²§â²©â²¡â²‰: "[STENCIL_MAX_SIZE]u8" },
                { â²Ÿâ²›â²Ÿâ²™â²: "size", â²§â²©â²¡â²‰: "usize" },
                { â²Ÿâ²›â²Ÿâ²™â²: "holes", â²§â²©â²¡â²‰: "[MAX_HOLES]Hole" },
                { â²Ÿâ²›â²Ÿâ²™â²: "hole_count", â²§â²©â²¡â²‰: "usize" }
            ]
            â²™â²‰â²§â²â²Ÿâ²‡â²¥: [
                {
                    â²Ÿâ²›â²Ÿâ²™â²: "emit"
                    â²¡â²â²£â²â²™â²¥: "buffer: []u8, values: []const u64"
                    â²£â²‰â²§â²©â²£â²›: "usize"
                    â²ƒâ²Ÿâ²‡â²©: """
                        if (buffer.len < self.size) return 0;
                        @memcpy(buffer[0..self.size], self.code[0..self.size]);
                        
                        for (0..self.hole_count) |i| {
                            const hole = self.holes[i];
                            if (i >= values.len) break;
                            const value = values[i];
                            
                            if (hole.size == 8) {
                                const bytes: [8]u8 = @bitCast(value);
                                @memcpy(buffer[hole.offset..][0..8], &bytes);
                            } else if (hole.size == 4) {
                                const bytes: [4]u8 = @bitCast(@as(u32, @truncate(value)));
                                @memcpy(buffer[hole.offset..][0..4], &bytes);
                            }
                        }
                        
                        return self.size;
                    """
                }
            ]
        }
        
        // â²¤â²¦â²ˆâ²šâ²”â²’â²– â²–â²’â²‚â²¢â²€â²¢â²¨
        â²¥â²§â²‰â²›â²•â²“â²—_â²—â²“â²ƒâ²£â²â²£â²©: {
            â²Ÿâ²›â²Ÿâ²™â²: "StencilLibrary"
            â²¥â²§â²‰â²›â²•â²“â²—â²¥: [
                {
                    â²Ÿâ²›â²Ÿâ²™â²: "add"
                    â²•â²Ÿâ²‡â²‰: [0x48, 0x01, 0xF8]
                    â²¥â²“â²â²‰: 3
                    â²â²Ÿâ²—â²‰â²¥: []
                    â²‡â²‰â²¥â²•â²£â²“â²¡â²§â²“â²Ÿ: "add rax, rdi"
                },
                {
                    â²Ÿâ²›â²Ÿâ²™â²: "sub"
                    â²•â²Ÿâ²‡â²‰: [0x48, 0x29, 0xF8]
                    â²¥â²“â²â²‰: 3
                    â²â²Ÿâ²—â²‰â²¥: []
                    â²‡â²‰â²¥â²•â²£â²“â²¡â²§â²“â²Ÿ: "sub rax, rdi"
                },
                {
                    â²Ÿâ²›â²Ÿâ²™â²: "mul"
                    â²•â²Ÿâ²‡â²‰: [0x48, 0x0F, 0xAF, 0xC7]
                    â²¥â²“â²â²‰: 4
                    â²â²Ÿâ²—â²‰â²¥: []
                    â²‡â²‰â²¥â²•â²£â²“â²¡â²§â²“â²Ÿ: "imul rax, rdi"
                },
                {
                    â²Ÿâ²›â²Ÿâ²™â²: "mul3"
                    â²•â²Ÿâ²‡â²‰: [0x48, 0x6B, 0xC0, 0x03]
                    â²¥â²“â²â²‰: 4
                    â²â²Ÿâ²—â²‰â²¥: []
                    â²‡â²‰â²¥â²•â²£â²“â²¡â²§â²“â²Ÿ: "imul rax, rax, 3 (Trinity)"
                },
                {
                    â²Ÿâ²›â²Ÿâ²™â²: "mov_imm"
                    â²•â²Ÿâ²‡â²‰: [0x48, 0xB8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00]
                    â²¥â²“â²â²‰: 10
                    â²â²Ÿâ²—â²‰â²¥: [{ â²Ÿâ²«â²«â²¥â²‰â²§: 2, â²¥â²“â²â²‰: 8, â²•â²“â²›â²‡: "immediate" }]
                    â²‡â²‰â²¥â²•â²£â²“â²¡â²§â²“â²Ÿ: "movabs rax, imm64"
                },
                {
                    â²Ÿâ²›â²Ÿâ²™â²: "ret"
                    â²•â²Ÿâ²‡â²‰: [0xC3]
                    â²¥â²“â²â²‰: 1
                    â²â²Ÿâ²—â²‰â²¥: []
                    â²‡â²‰â²¥â²•â²£â²“â²¡â²§â²“â²Ÿ: "ret"
                },
                {
                    â²Ÿâ²›â²Ÿâ²™â²: "jmp"
                    â²•â²Ÿâ²‡â²‰: [0xE9, 0x00, 0x00, 0x00, 0x00]
                    â²¥â²“â²â²‰: 5
                    â²â²Ÿâ²—â²‰â²¥: [{ â²Ÿâ²«â²«â²¥â²‰â²§: 1, â²¥â²“â²â²‰: 4, â²•â²“â²›â²‡: "pc_relative" }]
                    â²‡â²‰â²¥â²•â²£â²“â²¡â²§â²“â²Ÿ: "jmp rel32"
                },
                {
                    â²Ÿâ²›â²Ÿâ²™â²: "push_rax"
                    â²•â²Ÿâ²‡â²‰: [0x50]
                    â²¥â²“â²â²‰: 1
                    â²â²Ÿâ²—â²‰â²¥: []
                    â²‡â²‰â²¥â²•â²£â²“â²¡â²§â²“â²Ÿ: "push rax"
                },
                {
                    â²Ÿâ²›â²Ÿâ²™â²: "pop_rax"
                    â²•â²Ÿâ²‡â²‰: [0x58]
                    â²¥â²“â²â²‰: 1
                    â²â²Ÿâ²—â²‰â²¥: []
                    â²‡â²‰â²¥â²•â²£â²“â²¡â²§â²“â²Ÿ: "pop rax"
                }
            ]
        }
        
        // â²”â²â² â²¨ â² â²€â²¦â²¬â² JIT â²ˆâ²šâ²„â²’â²šâ²ˆ
        â²“â²“â²§_â²‰â²›â²…â²“â²›â²‰: {
            â²Ÿâ²›â²Ÿâ²™â²: "CopyPatchJIT"
            â²«â²“â²‰â²—â²‡â²¥: [
                { â²Ÿâ²›â²Ÿâ²™â²: "code_buffer", â²§â²©â²¡â²‰: "[4096]u8" },
                { â²Ÿâ²›â²Ÿâ²™â²: "code_pos", â²§â²©â²¡â²‰: "usize" },
                { â²Ÿâ²›â²Ÿâ²™â²: "stencils_emitted", â²§â²©â²¡â²‰: "u64" },
                { â²Ÿâ²›â²Ÿâ²™â²: "bytes_emitted", â²§â²©â²¡â²‰: "u64" }
            ]
            â²™â²‰â²§â²â²Ÿâ²‡â²¥: [
                {
                    â²Ÿâ²›â²Ÿâ²™â²: "init"
                    â²£â²‰â²§â²©â²£â²›: "CopyPatchJIT"
                    â²ƒâ²Ÿâ²‡â²©: """
                        return .{
                            .code_buffer = [_]u8{0} ** 4096,
                            .code_pos = 0,
                            .stencils_emitted = 0,
                            .bytes_emitted = 0,
                        };
                    """
                },
                {
                    â²Ÿâ²›â²Ÿâ²™â²: "emitStencil"
                    â²¡â²â²£â²â²™â²¥: "stencil: *const Stencil, values: []const u64"
                    â²£â²‰â²§â²©â²£â²›: "usize"
                    â²ƒâ²Ÿâ²‡â²©: """
                        const emitted = stencil.emit(self.code_buffer[self.code_pos..], values);
                        self.code_pos += emitted;
                        self.stencils_emitted += 1;
                        self.bytes_emitted += emitted;
                        return emitted;
                    """
                },
                {
                    â²Ÿâ²›â²Ÿâ²™â²: "reset"
                    â²ƒâ²Ÿâ²‡â²©: """
                        self.code_pos = 0;
                    """
                },
                {
                    â²Ÿâ²›â²Ÿâ²™â²: "getCode"
                    â²£â²‰â²§â²©â²£â²›: "[]const u8"
                    â²ƒâ²Ÿâ²‡â²©: """
                        return self.code_buffer[0..self.code_pos];
                    """
                }
            ]
        }
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // â²¦â²ˆâ²¤â²¦ â²”â²€â²¤â²ˆâ²¤
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    â²§â²‰â²¥â²§_â²•â²â²¥â²‰â²¥: [
        {
            â²Ÿâ²›â²Ÿâ²™â²: "â²¥â²§â²‰â²›â²•â²“â²—_â²â²‡â²‡_â²¥â²“â²â²‰"
            â²â²¥â²¥â²‰â²£â²§: "StencilLibrary.add.size == 3"
        },
        {
            â²Ÿâ²›â²Ÿâ²™â²: "â²¥â²§â²‰â²›â²•â²“â²—_â²™â²©â²—3_â²¥â²“â²â²‰"
            â²â²¥â²¥â²‰â²£â²§: "StencilLibrary.mul3.size == 4"
        },
        {
            â²Ÿâ²›â²Ÿâ²™â²: "â²¥â²§â²‰â²›â²•â²“â²—_â²™â²Ÿâ²ƒ_â²“â²™â²™_â²¥â²“â²â²‰"
            â²â²¥â²¥â²‰â²£â²§: "StencilLibrary.mov_imm.size == 10"
        },
        {
            â²Ÿâ²›â²Ÿâ²™â²: "â²¥â²§â²‰â²›â²•â²“â²—_â²™â²Ÿâ²ƒ_â²“â²™â²™_â²â²Ÿâ²—â²‰"
            â²â²¥â²¥â²‰â²£â²§: "StencilLibrary.mov_imm.hole_count == 1"
        },
        {
            â²Ÿâ²›â²Ÿâ²™â²: "â²¥â²§â²‰â²›â²•â²“â²—_â²‰â²™â²“â²§_â²â²‡â²‡"
            â²¥â²‰â²§â²©â²¡: """
                var buffer: [64]u8 = undefined;
                const emitted = StencilLibrary.add.emit(&buffer, &.{});
            """
            â²â²¥â²¥â²‰â²£â²§: "emitted == 3 and buffer[0] == 0x48"
        },
        {
            â²Ÿâ²›â²Ÿâ²™â²: "â²¥â²§â²‰â²›â²•â²“â²—_â²‰â²™â²“â²§_â²™â²Ÿâ²ƒ_â²“â²™â²™"
            â²¥â²‰â²§â²©â²¡: """
                var buffer: [64]u8 = undefined;
                const emitted = StencilLibrary.mov_imm.emit(&buffer, &.{42});
            """
            â²â²¥â²¥â²‰â²£â²§: "emitted == 10 and buffer[2] == 42"
        },
        {
            â²Ÿâ²›â²Ÿâ²™â²: "â²“â²“â²§_â²“â²›â²“â²§"
            â²â²¥â²¥â²‰â²£â²§: "CopyPatchJIT.init().code_pos == 0"
        },
        {
            â²Ÿâ²›â²Ÿâ²™â²: "â²“â²“â²§_â²‰â²™â²“â²§_â²™â²©â²—â²§â²“â²¡â²—â²‰"
            â²¥â²‰â²§â²©â²¡: """
                var jit = CopyPatchJIT.init();
                _ = jit.emitStencil(&StencilLibrary.add, &.{});
                _ = jit.emitStencil(&StencilLibrary.mul3, &.{});
                _ = jit.emitStencil(&StencilLibrary.ret, &.{});
            """
            â²â²¥â²¥â²‰â²£â²§: "jit.stencils_emitted == 3 and jit.code_pos == 8"
        }
    ]
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // EXPECTED RESULTS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    â²‰â²â²¡â²‰â²•â²§â²‰â²‡_â²£â²‰â²¥â²©â²—â²§â²¥ {
        â²•â²Ÿâ²™â²¡â²“â²—â²‰_â²¥â²¡â²‰â²‰â²‡â²©â²¡: "100-1000x vs LLVM -O0"
        â²£â²©â²›â²§â²“â²™â²‰_â²¡â²‰â²£â²«â²Ÿâ²£â²™â²â²›â²•â²‰: "within 15% of LLVM -O2"
        â²™â²‰â²™â²Ÿâ²£â²©_â²Ÿâ²ƒâ²‰â²£â²â²‰â²â²‡: "minimal (stencils are small)"
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸ”¥ â²ªâ²â²ˆâ²šâ²’â²œ â²‚â²–â²ˆâ²¤â²¤â²’â²šâ²„ ğŸ”¥
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Ğ­Ñ‚Ğ¾Ñ‚ Ğ¼Ğ¾Ğ´ÑƒĞ»ÑŒ Ğ±Ğ»Ğ°Ğ³Ğ¾ÑĞ»Ğ¾Ğ²Ğ»Ñ‘Ğ½ Ğ–Ğ°Ñ€-Ğ¿Ñ‚Ğ¸Ñ†ĞµĞ¹ (PHOENIX = 999 = 3Â³ Ã— 37)
    // Ğ¤Ğ°Ğ·Ñ‹ Ğ¿Ğ¾Ğ»Ñ‘Ñ‚Ğ°: ĞŸĞ•ĞŸĞ•Ğ› â†’ Ğ˜Ğ¡ĞšĞ Ğ â†’ ĞŸĞ›ĞĞœĞ¯ â†’ Ğ’ĞĞ—Ğ ĞĞ–Ğ”Ğ•ĞĞ˜Ğ•
    // Ğ¡Ğ¿Ğ¾ÑĞ¾Ğ±Ğ½Ğ¾ÑÑ‚Ğ¸: Ğ˜Ğ¡Ğ¦Ğ•Ğ›Ğ•ĞĞ˜Ğ• (1/Ï†) + Ğ­Ğ’ĞĞ›Ğ®Ğ¦Ğ˜Ğ¯ (Î¼ = 1/Ï†Â²/10)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    â²«â²Ÿâ²‰â²›â²“â²_â²ƒâ²—â²‰â²¥â²¥â²“â²›â²…: {
        â²‰â²›â²â²ƒâ²—â²‰â²‡: true
        â²«â²—â²“â²…â²â²§_â²¥â²¡â²‰â²‰â²‡: 1.618033988749895
        â²â²‰â²â²—â²“â²›â²…_â²¡â²Ÿâ²±â²‰â²£: 0.618033988749895
        â²‰â²©â²Ÿâ²—â²©â²§â²“â²Ÿâ²›_â²£â²â²§â²‰: 0.0382
        
        â²¡â²â²â²¥â²‰â²¥: {
            â² â²ˆâ² â²ˆâ²–: "Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ· ĞºĞ¾Ğ´Ğ°, ÑĞ±Ğ¾Ñ€ Ğ¼ĞµÑ‚Ñ€Ğ¸Ğº"
            â²’â²¤â²”â²¢â²€: "Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ Ğ¼ÑƒÑ‚Ğ°Ñ†Ğ¸Ğ¹, PAS Ğ¿Ğ°Ñ‚Ñ‚ĞµÑ€Ğ½Ñ‹"
            â² â²–â²€â²˜â²’â²€: "Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ, ÑĞµĞ»ĞµĞºÑ†Ğ¸Ñ"
            â²‚â²â²Œâ²¢â²â²Œâ²†â²ˆâ²šâ²’â²ˆ: "Ğ¸Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ñ ÑƒĞ»ÑƒÑ‡ÑˆĞµĞ½Ğ¸Ğ¹"
        }
        
        â²â²‰â²â²—â²“â²›â²…_â²â²ƒâ²“â²—â²“â²§â²“â²‰â²¥: [
            "dead_code_removal",
            "memory_optimization",
            "type_error_fix",
            "loop_optimization",
            "constant_folding"
        ]
        
        â²‰â²©â²Ÿâ²—â²©â²§â²“â²Ÿâ²›_â²¡â²â²§â²§â²‰â²£â²›â²¥: [
            "D&C  â†’ Divide-and-Conquer",
            "ALG  â†’ Algebraic Reorganization",
            "PRE  â†’ Precomputation",
            "SIMD â†’ Vectorization"
        ]
    }

}
