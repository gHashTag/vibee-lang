// ═══════════════════════════════════════════════════════════════════════════════
// PERFECT HASH DISPATCH - GENERATED BY ZMEI GORYNYCH
// ═══════════════════════════════════════════════════════════════════════════════
// Pattern: HSH (Minimal Perfect Hash)
// Lookup: O(1) guaranteed
// Formula: h(opcode) = (opcode * TRINITY_PRIME) % TABLE_SIZE
// ═══════════════════════════════════════════════════════════════════════════════

const std = @import("std");

pub const TRINITY_PRIME: u32 = 33;
pub const TABLE_SIZE: u32 = 64;

pub const Handler = *const fn (*VM) void;

/// Perfect hash function: O(1) lookup
pub inline fn hash(opcode: u8) u6 {
    return @truncate((opcode *% TRINITY_PRIME) % TABLE_SIZE);
}

/// Precomputed dispatch table
pub const dispatch_table: [TABLE_SIZE]?Handler = blk: {
    var table: [TABLE_SIZE]?Handler = [_]?Handler{null} ** TABLE_SIZE;
    table[hash(0x01)] = exec_ADD;
    table[hash(0x02)] = exec_SUB;
    table[hash(0x03)] = exec_MUL;
    table[hash(0x04)] = exec_DIV;
    table[hash(0x10)] = exec_PUSH;
    table[hash(0x11)] = exec_POP;
    table[hash(0x12)] = exec_DUP;
    table[hash(0x13)] = exec_SWAP;
    table[hash(0xFF)] = exec_HALT;
    break :blk table;
};

/// O(1) dispatch via perfect hash
pub inline fn dispatch(vm: *VM, opcode: u8) void {
    const idx = hash(opcode);
    if (dispatch_table[idx]) |handler| {
        handler(vm);
    } else {
        vm.status = .Error_InvalidOpcode;
    }
}

// Stub VM for standalone compilation
pub const VM = struct {
    status: Status,
    pub const Status = enum { Running, Error_InvalidOpcode };
};

fn exec_ADD(_: *VM) void {}
fn exec_SUB(_: *VM) void {}
fn exec_MUL(_: *VM) void {}
fn exec_DIV(_: *VM) void {}
fn exec_PUSH(_: *VM) void {}
fn exec_POP(_: *VM) void {}
fn exec_DUP(_: *VM) void {}
fn exec_SWAP(_: *VM) void {}
fn exec_HALT(_: *VM) void {}

test "perfect_hash_no_collisions" {
    var seen: [TABLE_SIZE]bool = [_]bool{false} ** TABLE_SIZE;
    const opcodes = [_]u8{ 0x01, 0x02, 0x03, 0x04, 0x10, 0x11, 0x12, 0x13, 0xFF };
    for (opcodes) |opcode| {
        const idx = hash(opcode);
        try std.testing.expect(!seen[idx]);
        seen[idx] = true;
    }
}
