name: vibee_os_package_manager
version: "0.1.0"
language: gleam
module: kernel/package/package_manager
description: Package Manager - управление зависимостями и пакетами Vibee

behaviors:
  - name: install_package
    given: Package exists in registry
    when: install is called
    then: Package and dependencies are installed
    test_cases:
      - name: install_simple
        input: {package: "vibee_utils", version: "1.0.0"}
        expected: {installed: true, location: "./vibee_packages/vibee_utils"}
      - name: install_with_deps
        input: {package: "vibee_web", dependencies: ["vibee_http", "vibee_json"]}
        expected: {installed: 3, all_resolved: true}
      - name: install_conflict
        input:
          package: "pkg_a"
          requires: "common@1.0"
          existing: "common@2.0"
        expected: {conflict: true, resolution_options: true}

  - name: resolve_dependencies
    given: Package has dependencies
    when: Dependencies are resolved
    then: Compatible versions are selected
    test_cases:
      - name: resolve_simple
        input:
          package: "app"
          deps: [{name: "lib", version: "^1.0.0"}]
          available: ["1.0.0", "1.1.0", "1.2.0", "2.0.0"]
        expected: {resolved: "1.2.0"}
      - name: resolve_diamond
        input:
          a_requires: "common@^1.0"
          b_requires: "common@^1.5"
        expected: {resolved: "common@1.5.x"}

  - name: publish_package
    given: Package is valid
    when: publish is called
    then: Package is uploaded to registry
    test_cases:
      - name: publish_new
        input: {package: "my_pkg", version: "1.0.0"}
        expected: {published: true, url: "registry/my_pkg/1.0.0"}
      - name: publish_existing_version
        input: {package: "my_pkg", version: "1.0.0", exists: true}
        expected: {error: "version_exists"}

  - name: update_packages
    given: Packages are installed
    when: update is called
    then: Packages are updated to latest compatible versions
    test_cases:
      - name: update_all
        input: {installed: ["a@1.0", "b@2.0"], latest: ["a@1.1", "b@2.1"]}
        expected: {updated: ["a@1.1", "b@2.1"]}
      - name: update_single
        input: {package: "a", from: "1.0", to: "1.1"}
        expected: {updated: true}

  - name: remove_package
    given: Package is installed
    when: remove is called
    then: Package is removed
    test_cases:
      - name: remove_simple
        input: {package: "unused_pkg"}
        expected: {removed: true}
      - name: remove_with_dependents
        input: {package: "common", dependents: ["app_a", "app_b"]}
        expected: {error: "has_dependents", dependents: ["app_a", "app_b"]}

  - name: lock_file
    given: Dependencies are resolved
    when: Lock file is generated
    then: Exact versions are recorded
    test_cases:
      - name: generate_lock
        input: {deps: ["a@^1.0", "b@^2.0"]}
        expected: {lock_file: true, exact_versions: true}
      - name: install_from_lock
        input: {lock_file: "vibee.lock"}
        expected: {reproducible: true}

types:
  # Package
  Package:
    name: str
    version: str
    description: str?
    authors: [str]
    license: str?
    repository: str?
    homepage: str?
    keywords: [str]
    dependencies: {str: VersionReq}
    dev_dependencies: {str: VersionReq}
    vibee_version: str?

  VersionReq:
    variants:
      - Exact: {version: str}         # "1.0.0"
      - Caret: {version: str}         # "^1.0.0" - compatible
      - Tilde: {version: str}         # "~1.0.0" - patch updates
      - Range: {min: str, max: str}   # ">=1.0.0 <2.0.0"
      - Any                           # "*"
      - Git: {url: str, ref: str?}
      - Path: {path: str}

  Version:
    major: int
    minor: int
    patch: int
    prerelease: str?
    build: str?

  # Registry
  Registry:
    url: str
    name: str
    auth: RegistryAuth?

  RegistryAuth:
    variants:
      - Token: {token_env: str}
      - Basic: {user_env: str, pass_env: str}

  PackageInfo:
    name: str
    versions: [VersionInfo]
    downloads: int
    created_at: int
    updated_at: int

  VersionInfo:
    version: str
    published_at: int
    checksum: str
    size_bytes: int
    dependencies: {str: str}

  # Resolution
  ResolutionResult:
    resolved: {str: str}              # package -> version
    conflicts: [Conflict]?

  Conflict:
    package: str
    required_by: [RequiredBy]
    available: [str]

  RequiredBy:
    package: str
    version_req: str

  # Lock File
  LockFile:
    version: int
    packages: [LockedPackage]
    checksum: str

  LockedPackage:
    name: str
    version: str
    source: PackageSource
    checksum: str
    dependencies: [str]

  PackageSource:
    variants:
      - Registry: {url: str}
      - Git: {url: str, rev: str}
      - Path: {path: str}

  # Installation
  InstallResult:
    installed: [str]
    updated: [str]
    removed: [str]
    failed: [InstallError]

  InstallError:
    package: str
    error: str

  # Project
  Project:
    manifest: Package
    lock_file: LockFile?
    installed: {str: str}

  # Search
  SearchResult:
    packages: [PackageInfo]
    total: int
    page: int

functions:
  # Installation
  - name: install
    params: {package: str, version: VersionReq?}
    returns: InstallResult
    description: Install package

  - name: install_all
    params: {}
    returns: InstallResult
    description: Install all dependencies from manifest

  - name: uninstall
    params: {package: str}
    returns: bool
    description: Uninstall package

  - name: update
    params: {package: str?}
    returns: InstallResult
    description: Update package(s)

  # Resolution
  - name: resolve
    params: {dependencies: {str: VersionReq}}
    returns: ResolutionResult
    description: Resolve dependencies

  - name: check_conflicts
    params: {dependencies: {str: VersionReq}}
    returns: [Conflict]
    description: Check for conflicts

  # Lock file
  - name: lock_generate
    params: {resolved: {str: str}}
    returns: LockFile
    description: Generate lock file

  - name: lock_read
    params: {path: str}
    returns: LockFile
    description: Read lock file

  - name: lock_write
    params: {lock: LockFile, path: str}
    returns: bool
    description: Write lock file

  # Registry
  - name: registry_search
    params: {query: str, page: int?}
    returns: SearchResult
    description: Search registry

  - name: registry_info
    params: {package: str}
    returns: PackageInfo
    description: Get package info

  - name: registry_publish
    params: {package: Package, tarball: str}
    returns: bool
    description: Publish to registry

  # Project
  - name: project_init
    params: {name: str}
    returns: Project
    description: Initialize new project

  - name: project_add
    params: {package: str, version: VersionReq?, dev: bool}
    returns: bool
    description: Add dependency to project

  - name: project_remove
    params: {package: str}
    returns: bool
    description: Remove dependency

  # Version
  - name: version_parse
    params: {version: str}
    returns: Version
    description: Parse version string

  - name: version_satisfies
    params: {version: str, req: VersionReq}
    returns: bool
    description: Check if version satisfies requirement

  - name: version_compare
    params: {a: str, b: str}
    returns: int
    description: Compare versions (-1, 0, 1)

imports:
  - kernel.security.secrets_manager

manifest_example: |
  # Package Manifest (vibee.yaml)
  
  ```yaml
  name: my_awesome_app
  version: "1.0.0"
  description: "An awesome Vibee application"
  authors:
    - "Developer <dev@example.com>"
  license: "MIT"
  repository: "https://github.com/user/my_awesome_app"
  
  vibee_version: ">=0.1.0"
  
  dependencies:
    vibee_http: "^1.0.0"
    vibee_json: "^2.0.0"
    vibee_db:
      git: "https://github.com/vibee/vibee_db"
      ref: "main"
  
  dev_dependencies:
    vibee_test: "^1.0.0"
    vibee_bench: "^0.5.0"
  ```

lock_file_example: |
  # Lock File (vibee.lock)
  
  ```yaml
  version: 1
  
  packages:
    - name: vibee_http
      version: "1.2.3"
      source:
        Registry: {url: "https://registry.vibee.dev"}
      checksum: "sha256:abc123..."
      dependencies:
        - vibee_tcp
    
    - name: vibee_tcp
      version: "0.5.0"
      source:
        Registry: {url: "https://registry.vibee.dev"}
      checksum: "sha256:def456..."
      dependencies: []
    
    - name: vibee_json
      version: "2.1.0"
      source:
        Registry: {url: "https://registry.vibee.dev"}
      checksum: "sha256:ghi789..."
      dependencies: []
  
  checksum: "sha256:lockfile_hash..."
  ```

cli_commands: |
  # Package Manager CLI
  
  ```bash
  # Initialize project
  vibee init my_project
  
  # Add dependency
  vibee add vibee_http
  vibee add vibee_test --dev
  vibee add vibee_db --git https://github.com/vibee/vibee_db
  
  # Install dependencies
  vibee install
  vibee install vibee_http@1.0.0
  
  # Update
  vibee update
  vibee update vibee_http
  
  # Remove
  vibee remove vibee_unused
  
  # Search
  vibee search http
  
  # Info
  vibee info vibee_http
  
  # Publish
  vibee publish
  
  # List installed
  vibee list
  vibee list --outdated
  ```
