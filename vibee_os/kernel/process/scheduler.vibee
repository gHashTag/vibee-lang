name: vibee_os_scheduler
version: "0.1.0"
language: zig
module: kernel/process/scheduler
description: Планировщик VIBEE OS — распределение процессорного времени между процессами

behaviors:
  - name: schedule_next_process
    given: Текущий процесс завершил квант времени или заблокирован
    when: Вызывается scheduler_next
    then: Выбирается следующий процесс для выполнения
    test_cases:
      - name: round_robin_selection
        input: {ready_queue: [1, 2, 3], current: 1}
        expected: {next_pid: 2}
      - name: single_process
        input: {ready_queue: [1], current: 1}
        expected: {next_pid: 1}
      - name: empty_queue
        input: {ready_queue: [], current: 0}
        expected: {next_pid: 0, idle: true}

  - name: add_process_to_queue
    given: Новый процесс создан или разблокирован
    when: Вызывается scheduler_add
    then: Процесс добавляется в очередь готовых
    test_cases:
      - name: add_new_process
        input: {pid: 5, priority: 10}
        expected: {added: true, queue_size: 4}

  - name: remove_process_from_queue
    given: Процесс завершается или блокируется
    when: Вызывается scheduler_remove
    then: Процесс удаляется из очереди
    test_cases:
      - name: remove_blocked_process
        input: {pid: 2}
        expected: {removed: true, queue_size: 2}

  - name: change_process_priority
    given: Приоритет процесса изменяется
    when: Вызывается scheduler_set_priority
    then: Процесс перемещается в соответствующую очередь
    test_cases:
      - name: increase_priority
        input: {pid: 3, new_priority: 20}
        expected: {success: true, old_priority: 10}

types:
  SchedulerState:
    current_pid: int
    ready_count: int
    blocked_count: int
    idle_time: int
    context_switches: int

  SchedulerPolicy:
    variants:
      - RoundRobin
      - Priority
      - FIFO
      - Cooperative

  ReadyQueue:
    processes: [int]
    head: int
    tail: int

  PriorityQueue:
    high: [int]
    normal: [int]
    low: [int]
    idle: [int]

  TimeSlice:
    duration_ms: int
    remaining_ms: int

  ContextSwitch:
    from_pid: int
    to_pid: int
    reason: SwitchReason
    timestamp: int

  SwitchReason:
    variants:
      - TimeSliceExpired
      - Yield
      - Blocked
      - Terminated
      - Preempted

functions:
  - name: scheduler_init
    params: {policy: SchedulerPolicy}
    returns: bool
    description: Инициализация планировщика

  - name: scheduler_next
    params: {}
    returns: int
    description: Выбор следующего процесса для выполнения

  - name: scheduler_add
    params: {pid: int, priority: int}
    returns: bool
    description: Добавление процесса в очередь готовых

  - name: scheduler_remove
    params: {pid: int}
    returns: bool
    description: Удаление процесса из очереди

  - name: scheduler_block
    params: {pid: int, reason: str}
    returns: bool
    description: Блокировка процесса

  - name: scheduler_unblock
    params: {pid: int}
    returns: bool
    description: Разблокировка процесса

  - name: scheduler_yield
    params: {}
    returns: void
    description: Добровольная передача управления

  - name: scheduler_set_priority
    params: {pid: int, priority: int}
    returns: bool
    description: Изменение приоритета процесса

  - name: scheduler_state
    params: {}
    returns: SchedulerState
    description: Получение состояния планировщика

  - name: scheduler_tick
    params: {}
    returns: bool
    description: Обработка тика таймера (для preemptive scheduling)

  - name: context_switch
    params: {from_pid: int, to_pid: int}
    returns: void
    description: Переключение контекста между процессами

imports:
  - kernel.process

scheduling_algorithm: |
  VIBEE OS использует многоуровневую очередь с обратной связью (MLFQ):
  
  1. Высокий приоритет (интерактивные процессы)
     - Квант времени: 10ms
     - Быстрый отклик
  
  2. Нормальный приоритет (обычные процессы)
     - Квант времени: 50ms
     - Баланс между откликом и throughput
  
  3. Низкий приоритет (фоновые задачи)
     - Квант времени: 100ms
     - Максимальный throughput
  
  4. Idle (когда нет готовых процессов)
     - Энергосбережение
     - Ожидание прерываний
  
  Правила повышения/понижения приоритета:
  - Процесс использовал весь квант → понижение
  - Процесс заблокировался на I/O → повышение
  - Периодический boost всех процессов (предотвращение starvation)
