name: vibee_os_plugin_system
version: "0.1.0"
language: gleam
module: kernel/plugin/plugin_system
description: Plugin System - расширения для Vibee OS через .vibee спецификации

behaviors:
  - name: load_plugin
    given: Plugin .vibee file exists
    when: load is called
    then: Plugin is loaded and registered
    test_cases:
      - name: load_valid_plugin
        input:
          path: "plugins/my_plugin.vibee"
          valid: true
        expected:
          loaded: true
          registered: true
          hooks_connected: true
      - name: load_invalid_plugin
        input:
          path: "plugins/broken.vibee"
          valid: false
        expected:
          loaded: false
          error: "invalid_manifest"

  - name: plugin_provides_hooks
    given: Plugin defines hooks
    when: Hook point is reached
    then: Plugin hook is executed
    test_cases:
      - name: before_compile_hook
        input:
          hook: "before_compile"
          plugin: "linter"
        expected:
          hook_executed: true
          can_modify_input: true
      - name: after_test_hook
        input:
          hook: "after_test"
          plugin: "reporter"
        expected:
          hook_executed: true
          received_results: true

  - name: plugin_adds_commands
    given: Plugin defines commands
    when: Command is invoked
    then: Plugin command is executed
    test_cases:
      - name: custom_command
        input:
          command: "vibee lint"
          plugin: "linter"
        expected:
          executed: true
          output: true

  - name: plugin_adds_types
    given: Plugin defines new types
    when: Plugin is loaded
    then: Types are available globally
    test_cases:
      - name: add_custom_type
        input:
          plugin: "database"
          type: "Connection"
        expected:
          type_available: true
          can_use_in_specs: true

  - name: plugin_isolation
    given: Plugin is loaded
    when: Plugin has bug
    then: Bug does not crash system
    test_cases:
      - name: plugin_error_contained
        input:
          plugin: "buggy"
          error: "null_pointer"
        expected:
          system_running: true
          plugin_disabled: true
          error_logged: true

  - name: plugin_dependencies
    given: Plugin has dependencies
    when: Plugin is loaded
    then: Dependencies are loaded first
    test_cases:
      - name: load_with_deps
        input:
          plugin: "advanced"
          dependencies: ["base", "utils"]
        expected:
          deps_loaded_first: true
          order: ["base", "utils", "advanced"]
      - name: circular_dependency
        input:
          plugin_a: {depends: ["b"]}
          plugin_b: {depends: ["a"]}
        expected:
          error: "circular_dependency"

types:
  # Plugin Manifest
  PluginManifest:
    name: str
    version: str
    description: str
    author: str?
    license: str?
    repository: str?
    vibee_version: str                # Minimum Vibee OS version
    dependencies: [PluginDependency]
    provides: PluginProvides
    config_schema: {str: ConfigField}?

  PluginDependency:
    name: str
    version: str                      # Semver range
    optional: bool

  PluginProvides:
    hooks: [HookDefinition]
    commands: [CommandDefinition]
    types: [str]
    functions: [str]
    behaviors: [str]
    ui_components: [str]?

  HookDefinition:
    name: str
    point: HookPoint
    priority: int                     # Lower = earlier
    description: str

  HookPoint:
    variants:
      # Compilation
      - BeforeParse
      - AfterParse
      - BeforeValidate
      - AfterValidate
      - BeforeCompile
      - AfterCompile
      
      # Testing
      - BeforeTest
      - AfterTest
      - OnTestPass
      - OnTestFail
      
      # Runtime
      - OnStart
      - OnShutdown
      - OnError
      
      # Agent
      - BeforeLLMCall
      - AfterLLMCall
      - OnAgentTask
      
      # UI
      - OnRender
      - OnInput
      
      # Custom
      - Custom: {name: str}

  CommandDefinition:
    name: str
    description: str
    usage: str
    options: [CommandOption]
    handler: str

  CommandOption:
    name: str
    short: str?
    description: str
    required: bool
    default: str?

  ConfigField:
    type: str
    description: str
    default: str?
    required: bool
    validation: str?

  # Plugin Instance
  Plugin:
    manifest: PluginManifest
    state: PluginState
    config: {str: str}
    loaded_at: int
    error: str?

  PluginState:
    variants:
      - Unloaded
      - Loading
      - Loaded
      - Active
      - Disabled
      - Error: {message: str}

  # Hook Execution
  HookContext:
    hook_point: HookPoint
    data: {str: str}
    plugins_executed: [str]
    can_modify: bool
    can_cancel: bool

  HookResult:
    success: bool
    modified_data: {str: str}?
    cancel: bool
    error: str?

  # Plugin Registry
  PluginRegistry:
    plugins: {str: Plugin}
    hooks: {str: [HookRegistration]}
    commands: {str: CommandRegistration}

  HookRegistration:
    plugin: str
    handler: str
    priority: int

  CommandRegistration:
    plugin: str
    handler: str

  # Plugin Discovery
  PluginSource:
    variants:
      - Local: {path: str}
      - Registry: {url: str}
      - Git: {url: str, ref: str?}

  PluginSearchResult:
    name: str
    version: str
    description: str
    downloads: int
    rating: float

functions:
  # Lifecycle
  - name: plugin_load
    params: {path: str}
    returns: Plugin
    description: Load plugin from path

  - name: plugin_unload
    params: {name: str}
    returns: bool
    description: Unload plugin

  - name: plugin_enable
    params: {name: str}
    returns: bool
    description: Enable disabled plugin

  - name: plugin_disable
    params: {name: str}
    returns: bool
    description: Disable plugin

  - name: plugin_reload
    params: {name: str}
    returns: Plugin
    description: Reload plugin

  # Discovery
  - name: plugin_discover
    params: {dir: str}
    returns: [str]
    description: Discover plugins in directory

  - name: plugin_search
    params: {query: str, source: PluginSource}
    returns: [PluginSearchResult]
    description: Search for plugins

  - name: plugin_install
    params: {name: str, source: PluginSource}
    returns: Plugin
    description: Install plugin from source

  # Hooks
  - name: hook_register
    params: {plugin: str, hook: HookDefinition}
    returns: bool
    description: Register hook handler

  - name: hook_execute
    params: {point: HookPoint, context: HookContext}
    returns: HookResult
    description: Execute all hooks for point

  - name: hook_list
    params: {point: HookPoint}
    returns: [HookRegistration]
    description: List registered hooks

  # Commands
  - name: command_register
    params: {plugin: str, command: CommandDefinition}
    returns: bool
    description: Register command

  - name: command_execute
    params: {name: str, args: [str]}
    returns: str
    description: Execute command

  - name: command_list
    params: {}
    returns: [CommandDefinition]
    description: List all commands

  # Configuration
  - name: plugin_configure
    params: {name: str, config: {str: str}}
    returns: bool
    description: Configure plugin

  - name: plugin_get_config
    params: {name: str}
    returns: {str: str}
    description: Get plugin configuration

  # Registry
  - name: registry_list
    params: {}
    returns: [Plugin]
    description: List all plugins

  - name: registry_get
    params: {name: str}
    returns: Plugin?
    description: Get plugin by name

imports:
  - kernel.vibee.compiler
  - kernel.ipc.event_bus

plugin_manifest_example: |
  # Plugin Manifest Example
  
  ```vibee
  # plugins/linter/manifest.vibee
  
  name: vibee_linter
  version: "1.0.0"
  description: Linting rules for Vibee specifications
  author: "Vibee Team"
  license: "MIT"
  vibee_version: ">=0.1.0"
  
  dependencies:
    - name: vibee_core
      version: ">=0.1.0"
  
  provides:
    hooks:
      - name: lint_on_parse
        point: AfterParse
        priority: 10
        description: Run linting after parsing
    
    commands:
      - name: lint
        description: Lint Vibee specifications
        usage: "vibee lint [file.vibee]"
        options:
          - name: fix
            short: f
            description: Auto-fix issues
    
    types:
      - LintRule
      - LintResult
    
    behaviors:
      - check_naming_convention
      - check_test_coverage
      - check_type_usage
  
  config_schema:
    rules:
      type: object
      description: Enabled lint rules
      default: "{}"
    severity:
      type: string
      description: Default severity
      default: "warning"
  ```

built_in_plugins: |
  # Built-in Plugins
  
  ## vibee_linter
  - Naming conventions
  - Test coverage requirements
  - Type usage validation
  - Best practices
  
  ## vibee_formatter
  - Auto-format .vibee files
  - Consistent indentation
  - Sort imports
  
  ## vibee_docs
  - Generate documentation
  - API reference
  - Examples extraction
  
  ## vibee_test_reporter
  - JUnit XML output
  - HTML reports
  - Coverage reports
  
  ## vibee_git_hooks
  - Pre-commit linting
  - Pre-push testing
  - Commit message validation

hook_execution_order: |
  # Hook Execution Order
  
  ```
  BeforeParse (priority order)
       │
       ▼
  [Parse .vibee file]
       │
       ▼
  AfterParse (priority order)
       │
       ▼
  BeforeValidate
       │
       ▼
  [Validate spec]
       │
       ▼
  AfterValidate
       │
       ▼
  BeforeCompile
       │
       ▼
  [Generate code]
       │
       ▼
  AfterCompile
       │
       ▼
  BeforeTest
       │
       ▼
  [Run tests]
       │
       ▼
  AfterTest / OnTestPass / OnTestFail
  ```
  
  Hooks with lower priority numbers execute first.
  Hooks can modify data or cancel execution.
