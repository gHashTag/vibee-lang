name: vibee_os_hot_reload
version: "0.1.0"
language: gleam
module: kernel/runtime/hot_reload
description: Hot Reload - перезагрузка спецификаций без остановки системы

behaviors:
  - name: detect_file_change
    given: File watcher is active
    when: .vibee file is modified
    then: Change is detected and reload triggered
    test_cases:
      - name: detect_modification
        input: {file: "app.vibee", event: "modify"}
        expected: {detected: true, reload_triggered: true}
      - name: detect_creation
        input: {file: "new.vibee", event: "create"}
        expected: {detected: true, reload_triggered: true}
      - name: ignore_non_vibee
        input: {file: "readme.md", event: "modify"}
        expected: {detected: false}

  - name: reload_without_restart
    given: System is running
    when: Spec is reloaded
    then: New spec is active without restart
    test_cases:
      - name: reload_behavior
        input:
          running: true
          old_behavior: "add returns a + b"
          new_behavior: "add returns a + b + 1"
        expected:
          reloaded: true
          no_restart: true
          new_behavior_active: true
      - name: preserve_state
        input:
          state: {counter: 42}
          reload: true
        expected:
          state_preserved: true
          counter: 42

  - name: validate_before_reload
    given: New spec is available
    when: Validation runs
    then: Invalid specs are rejected
    test_cases:
      - name: reject_invalid
        input:
          new_spec: "invalid yaml {"
        expected:
          reloaded: false
          error: "parse_error"
          old_spec_active: true
      - name: reject_type_error
        input:
          new_spec: "behavior with type error"
        expected:
          reloaded: false
          error: "type_error"

  - name: rollback_on_failure
    given: Reload started
    when: Reload fails midway
    Then: System rolls back to previous state
    test_cases:
      - name: rollback_on_error
        input:
          reload_step: 3
          error_at_step: 3
        expected:
          rolled_back: true
          previous_state_restored: true
      - name: partial_reload_rollback
        input:
          files: ["a.vibee", "b.vibee", "c.vibee"]
          error_at: "c.vibee"
        expected:
          all_rolled_back: true

  - name: dependency_aware_reload
    given: Specs have dependencies
    when: Dependency is reloaded
    Then: Dependents are reloaded in correct order
    test_cases:
      - name: reload_with_deps
        input:
          changed: "base.vibee"
          dependents: ["app.vibee", "utils.vibee"]
        expected:
          reload_order: ["base.vibee", "utils.vibee", "app.vibee"]
      - name: circular_dependency
        input:
          a_depends_on: "b"
          b_depends_on: "a"
        expected:
          error: "circular_dependency"

  - name: graceful_connection_handling
    given: Active connections exist
    when: Reload happens
    Then: Connections are handled gracefully
    test_cases:
      - name: drain_connections
        input:
          active_connections: 10
          drain_timeout_ms: 5000
        expected:
          connections_drained: true
          no_dropped_requests: true

types:
  # File Watcher
  FileWatcher:
    paths: [str]
    patterns: [str]
    ignore_patterns: [str]
    debounce_ms: int
    recursive: bool

  FileEvent:
    type: FileEventType
    path: str
    timestamp: int

  FileEventType:
    variants:
      - Created
      - Modified
      - Deleted
      - Renamed: {old_path: str}

  # Reload
  ReloadRequest:
    files: [str]
    force: bool
    validate_only: bool

  ReloadResult:
    success: bool
    reloaded: [ReloadedSpec]
    failed: [ReloadError]
    duration_ms: int
    rolled_back: bool

  ReloadedSpec:
    path: str
    old_version: str?
    new_version: str
    changes: [SpecChange]

  SpecChange:
    type: ChangeType
    name: str
    details: str?

  ChangeType:
    variants:
      - BehaviorAdded
      - BehaviorModified
      - BehaviorRemoved
      - TypeAdded
      - TypeModified
      - TypeRemoved
      - FunctionAdded
      - FunctionModified
      - FunctionRemoved

  ReloadError:
    path: str
    error: str
    phase: ReloadPhase

  ReloadPhase:
    variants:
      - Parse
      - Validate
      - Compile
      - Load
      - Activate

  # State Management
  StateSnapshot:
    id: str
    timestamp: int
    specs: {str: str}                 # path -> checksum
    state: {str: StateValue}
    connections: int

  StateValue:
    variants:
      - Null
      - Bool: {value: bool}
      - Int: {value: int}
      - Float: {value: float}
      - String: {value: str}
      - Binary: {data: [int]}

  # Rollback
  RollbackPoint:
    id: str
    snapshot: StateSnapshot
    created_at: int

  RollbackResult:
    success: bool
    restored_to: str
    duration_ms: int

  # Configuration
  HotReloadConfig:
    enabled: bool
    watch_paths: [str]
    debounce_ms: int
    validate_before_reload: bool
    auto_rollback: bool
    max_rollback_points: int
    drain_timeout_ms: int
    notify_on_reload: bool

  # Notification
  ReloadNotification:
    type: NotificationType
    message: str
    details: ReloadResult?
    timestamp: int

  NotificationType:
    variants:
      - ReloadStarted
      - ReloadSucceeded
      - ReloadFailed
      - RollbackStarted
      - RollbackCompleted

functions:
  # File watching
  - name: watcher_start
    params: {config: HotReloadConfig}
    returns: FileWatcher
    description: Start file watcher

  - name: watcher_stop
    params: {watcher: FileWatcher}
    returns: void
    description: Stop file watcher

  - name: watcher_add_path
    params: {watcher: FileWatcher, path: str}
    returns: void
    description: Add path to watch

  # Reload
  - name: reload
    params: {request: ReloadRequest}
    returns: ReloadResult
    description: Reload specifications

  - name: reload_file
    params: {path: str}
    returns: ReloadResult
    description: Reload single file

  - name: reload_all
    params: {}
    returns: ReloadResult
    description: Reload all specs

  # Validation
  - name: validate_reload
    params: {files: [str]}
    returns: [ReloadError]
    description: Validate without reloading

  # State
  - name: snapshot_create
    params: {}
    returns: StateSnapshot
    description: Create state snapshot

  - name: snapshot_restore
    params: {snapshot: StateSnapshot}
    returns: bool
    description: Restore from snapshot

  # Rollback
  - name: rollback_point_create
    params: {}
    returns: RollbackPoint
    description: Create rollback point

  - name: rollback
    params: {point_id: str}
    returns: RollbackResult
    description: Rollback to point

  - name: rollback_latest
    params: {}
    returns: RollbackResult
    description: Rollback to latest point

  # Dependencies
  - name: dependency_graph
    params: {files: [str]}
    returns: {str: [str]}
    description: Get dependency graph

  - name: reload_order
    params: {changed: [str]}
    returns: [str]
    description: Calculate reload order

  # Notifications
  - name: on_reload
    params: {handler: str}
    returns: void
    description: Register reload handler

imports:
  - kernel.vibee.compiler
  - kernel.ipc.event_bus

hot_reload_flow: |
  # Hot Reload Flow
  
  ```
  File Changed
       │
       ▼
  ┌─────────────┐
  │  Debounce   │  Wait for more changes
  └──────┬──────┘
         │
         ▼
  ┌─────────────┐
  │  Snapshot   │  Save current state
  └──────┬──────┘
         │
         ▼
  ┌─────────────┐
  │   Parse     │──── Error ────▶ Abort, notify
  └──────┬──────┘
         │
         ▼
  ┌─────────────┐
  │  Validate   │──── Error ────▶ Abort, notify
  └──────┬──────┘
         │
         ▼
  ┌─────────────┐
  │  Compile    │──── Error ────▶ Rollback
  └──────┬──────┘
         │
         ▼
  ┌─────────────┐
  │   Drain     │  Wait for active requests
  └──────┬──────┘
         │
         ▼
  ┌─────────────┐
  │   Swap      │  Atomic swap to new code
  └──────┬──────┘
         │
         ▼
  ┌─────────────┐
  │  Activate   │──── Error ────▶ Rollback
  └──────┬──────┘
         │
         ▼
  ┌─────────────┐
  │   Notify    │  Emit reload event
  └─────────────┘
  ```

state_preservation: |
  # State Preservation
  
  Hot reload preserves:
  - In-memory state (variables, caches)
  - Active connections
  - Event subscriptions
  - Timer state
  
  Not preserved (recreated):
  - Compiled code
  - Type definitions
  - Function implementations
  
  ## Example
  
  Before reload:
  ```
  state = {counter: 42, users: [...]}
  ```
  
  After reload:
  ```
  state = {counter: 42, users: [...]}  # Same!
  new_behavior_active = true
  ```

usage_example: |
  # Usage Example
  
  ```bash
  # Start with hot reload
  vibee run app.vibee --watch
  
  # Or enable in REPL
  vibee> :watch on
  Watching for changes...
  
  # Edit app.vibee in editor
  # Save file
  
  # Output:
  [hot-reload] Detected change: app.vibee
  [hot-reload] Validating...
  [hot-reload] Compiling...
  [hot-reload] Reloaded successfully (45ms)
  [hot-reload] Changes:
    + behavior: new_feature
    ~ behavior: existing_feature (modified)
  ```
