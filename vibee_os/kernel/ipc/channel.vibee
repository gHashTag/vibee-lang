name: vibee_os_ipc_channel
version: "0.1.0"
language: zig
module: kernel/ipc
description: Межпроцессное взаимодействие VIBEE OS — каналы сообщений

behaviors:
  - name: create_channel
    given: Процесс хочет создать канал связи
    when: Вызывается channel_create
    then: Создаётся пара sender/receiver endpoints
    test_cases:
      - name: create_unbounded
        input: {capacity: 0}
        expected: {success: true, sender_id: 1, receiver_id: 2}
      - name: create_bounded
        input: {capacity: 10}
        expected: {success: true, sender_id: 3, receiver_id: 4}

  - name: send_message
    given: Канал создан и sender доступен
    when: Вызывается channel_send с сообщением
    then: Сообщение помещается в очередь канала
    test_cases:
      - name: send_text
        input: {channel: 1, message: "hello"}
        expected: {success: true}
      - name: send_to_full_channel
        input: {channel: 1, message: "overflow", channel_full: true}
        expected: {success: false, error: "channel_full"}

  - name: receive_message
    given: Канал содержит сообщения
    when: Вызывается channel_recv
    then: Первое сообщение извлекается из очереди
    test_cases:
      - name: receive_available
        input: {channel: 2}
        expected: {success: true, message: "hello"}
      - name: receive_empty_blocking
        input: {channel: 2, blocking: true, empty: true}
        expected: {blocked: true}
      - name: receive_empty_nonblocking
        input: {channel: 2, blocking: false, empty: true}
        expected: {success: false, error: "would_block"}

  - name: close_channel
    given: Канал больше не нужен
    when: Вызывается channel_close
    then: Канал закрывается и ресурсы освобождаются
    test_cases:
      - name: close_sender
        input: {endpoint: 1}
        expected: {closed: true}
      - name: close_receiver
        input: {endpoint: 2}
        expected: {closed: true}

types:
  Channel:
    id: int
    sender: Endpoint
    receiver: Endpoint
    capacity: int
    message_count: int

  Endpoint:
    id: int
    channel_id: int
    type: EndpointType
    closed: bool

  EndpointType:
    variants:
      - Sender
      - Receiver

  Message:
    id: int
    sender_pid: int
    data: str
    timestamp: int
    priority: int

  ChannelOptions:
    capacity: int
    blocking: bool
    timeout_ms: int?

  ChannelError:
    variants:
      - ChannelFull
      - ChannelEmpty
      - ChannelClosed
      - WouldBlock
      - Timeout
      - InvalidEndpoint

  ChannelResult:
    success: bool
    value: str?
    error: ChannelError?

  ChannelStats:
    messages_sent: int
    messages_received: int
    bytes_transferred: int
    average_latency_us: int

functions:
  - name: channel_create
    params: {options: ChannelOptions}
    returns: {sender: Endpoint, receiver: Endpoint}
    description: Создание нового канала

  - name: channel_send
    params: {sender: Endpoint, message: str}
    returns: ChannelResult
    description: Отправка сообщения

  - name: channel_send_timeout
    params: {sender: Endpoint, message: str, timeout_ms: int}
    returns: ChannelResult
    description: Отправка с таймаутом

  - name: channel_recv
    params: {receiver: Endpoint}
    returns: ChannelResult
    description: Получение сообщения (блокирующее)

  - name: channel_try_recv
    params: {receiver: Endpoint}
    returns: ChannelResult
    description: Попытка получения (неблокирующее)

  - name: channel_recv_timeout
    params: {receiver: Endpoint, timeout_ms: int}
    returns: ChannelResult
    description: Получение с таймаутом

  - name: channel_close
    params: {endpoint: Endpoint}
    returns: bool
    description: Закрытие endpoint

  - name: channel_is_empty
    params: {channel_id: int}
    returns: bool
    description: Проверка пустоты канала

  - name: channel_is_full
    params: {channel_id: int}
    returns: bool
    description: Проверка заполненности канала

  - name: channel_stats
    params: {channel_id: int}
    returns: ChannelStats
    description: Статистика канала

imports:
  - kernel.process
  - kernel.memory

ipc_patterns: |
  Паттерны использования IPC в VIBEE OS:
  
  1. Request-Response (клиент-сервер):
     ```
     client                    server
       |                         |
       |--- request channel ---->|
       |                         |
       |<-- response channel ----|
     ```
  
  2. Pub-Sub (издатель-подписчик):
     ```
     publisher --> topic --> subscriber1
                        \--> subscriber2
                        \--> subscriber3
     ```
  
  3. Pipeline (конвейер):
     ```
     stage1 --> channel --> stage2 --> channel --> stage3
     ```
  
  4. Work Queue (очередь задач):
     ```
     producer --> queue --> worker1
                       \--> worker2
                       \--> worker3
     ```
