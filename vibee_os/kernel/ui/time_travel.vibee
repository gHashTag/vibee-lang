name: vibee_os_time_travel
version: "0.1.0"
language: gleam
module: kernel/ui/time_travel
description: Time-Travel UI - Ğ¿Ğ¾Ğ»Ğ½Ğ°Ñ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğ¹ Ñ Ğ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ÑÑ‚ÑŒÑ Ğ¾Ñ‚ĞºĞ°Ñ‚Ğ°, replay Ğ¸ branching

behaviors:
  - name: every_state_is_recorded
    given: UI state exists
    when: state changes
    then: Previous state is saved to history
    test_cases:
      - name: record_click
        input: {action: "click", element: "button"}
        expected: {recorded: true, history_length: 1}
      - name: record_input
        input: {action: "input", element: "text_field", value: "hello"}
        expected: {recorded: true, history_length: 1, value_saved: "hello"}

  - name: undo_restores_previous
    given: History has entries
    when: undo is triggered
    then: UI returns to previous state
    test_cases:
      - name: undo_text_input
        input: {current: "hello world", history: ["hello", ""]}
        expected: {after_undo: "hello"}
      - name: undo_multiple
        input: {undo_count: 3, history_length: 5}
        expected: {position: 2, states_available: 5}

  - name: redo_restores_undone
    given: Undo was performed
    when: redo is triggered
    then: UI returns to state before undo
    test_cases:
      - name: redo_after_undo
        input: {undone: true, future_states: 2}
        expected: {after_redo: true, future_states: 1}

  - name: branch_creates_timeline
    given: User is at historical state
    when: User makes new change
    then: New branch is created from that point
    test_cases:
      - name: branch_from_past
        input: {position: 3, history_length: 10, new_action: "click"}
        expected: {branches: 2, current_branch: "branch_1"}

  - name: replay_actions
    given: History has recorded actions
    when: replay is triggered
    then: Actions are replayed in sequence
    test_cases:
      - name: replay_all
        input: {history_length: 10, speed: 1.0}
        expected: {replayed: 10, duration_ms: 10000}
      - name: replay_fast
        input: {history_length: 10, speed: 5.0}
        expected: {replayed: 10, duration_ms: 2000}

  - name: snapshot_saves_full_state
    given: UI is in specific state
    when: snapshot is created
    then: Full state is saved with metadata
    test_cases:
      - name: create_snapshot
        input: {name: "before_submit"}
        expected: {snapshot_id: "snap_1", size_kb: 50}
      - name: restore_snapshot
        input: {snapshot_id: "snap_1"}
        expected: {restored: true, state_matches: true}

types:
  # State Management
  UIState:
    id: str
    timestamp: int
    elements: {str: ElementState}
    focus: str?
    scroll_positions: {str: ScrollPosition}
    selections: {str: Selection}
    form_data: {str: str}
    custom: {str: str}

  ElementState:
    id: str
    visible: bool
    enabled: bool
    value: str?
    checked: bool?
    expanded: bool?
    selected: bool?
    style_overrides: {str: str}

  ScrollPosition:
    x: int
    y: int

  Selection:
    start: int
    end: int
    direction: SelectionDirection

  SelectionDirection:
    variants:
      - Forward
      - Backward
      - None

  # History
  History:
    states: [HistoryEntry]
    current_index: int
    branches: [Branch]
    current_branch: str
    max_entries: int
    compression: CompressionMode

  HistoryEntry:
    id: str
    state: UIState
    action: Action
    timestamp: int
    branch: str
    parent: str?
    metadata: EntryMetadata

  EntryMetadata:
    user_id: str?
    session_id: str
    source: ActionSource
    duration_ms: int
    description: str?

  ActionSource:
    variants:
      - User
      - System
      - Agent
      - Replay
      - Test

  Action:
    type: ActionType
    target: str?
    params: {str: str}
    reversible: bool

  ActionType:
    variants:
      # User actions
      - Click: {x: int, y: int}
      - DoubleClick: {x: int, y: int}
      - RightClick: {x: int, y: int}
      - Input: {value: str}
      - KeyPress: {key: str, modifiers: [str]}
      - Scroll: {delta_x: int, delta_y: int}
      - Drag: {from: Point, to: Point}
      - Drop: {element: str, data: str}
      - Focus: {element: str}
      - Blur: {element: str}
      - Select: {start: int, end: int}
      - Gesture: {type: str, params: {str: str}}
      
      # System actions
      - Navigate: {url: str}
      - Resize: {width: int, height: int}
      - OrientationChange: {orientation: str}
      - ThemeChange: {theme: str}
      - LanguageChange: {language: str}
      
      # Compound actions
      - Batch: {actions: [Action]}
      - Custom: {name: str, data: {str: str}}

  Point:
    x: int
    y: int

  # Branching
  Branch:
    id: str
    name: str
    parent_branch: str?
    fork_point: str                   # Entry ID where branch started
    created_at: int
    entries: [str]                    # Entry IDs in this branch
    metadata: BranchMetadata

  BranchMetadata:
    description: str?
    author: str?
    tags: [str]

  # Compression
  CompressionMode:
    variants:
      - None                          # Store full states
      - Delta                         # Store only changes
      - Snapshot                      # Periodic full + deltas
      - Adaptive                      # Choose based on change size

  DeltaState:
    base_id: str
    changes: [StateChange]

  StateChange:
    path: str                         # JSON path to changed value
    old_value: str
    new_value: str

  # Snapshots
  Snapshot:
    id: str
    name: str
    state: UIState
    timestamp: int
    branch: str
    entry_id: str
    metadata: SnapshotMetadata

  SnapshotMetadata:
    description: str?
    tags: [str]
    auto_created: bool
    size_bytes: int

  # Replay
  ReplaySession:
    id: str
    history: History
    start_index: int
    end_index: int
    current_index: int
    speed: float
    state: ReplayState
    options: ReplayOptions

  ReplayState:
    variants:
      - Idle
      - Playing
      - Paused
      - Finished

  ReplayOptions:
    speed: float                      # 1.0 = real-time
    skip_delays: bool                 # Skip wait times
    pause_on_error: bool
    highlight_actions: bool
    show_cursor: bool
    audio_narration: bool

  # Time Travel Commands
  TimeTravelCommand:
    variants:
      - Undo: {count: int}
      - Redo: {count: int}
      - GoTo: {entry_id: str}
      - GoToTime: {timestamp: int}
      - GoToIndex: {index: int}
      - CreateBranch: {name: str}
      - SwitchBranch: {branch_id: str}
      - MergeBranch: {source: str, target: str}
      - CreateSnapshot: {name: str}
      - RestoreSnapshot: {snapshot_id: str}
      - StartReplay: {options: ReplayOptions}
      - PauseReplay
      - StopReplay
      - StepForward
      - StepBackward
      - Clear: {keep_snapshots: bool}

  TimeTravelResult:
    success: bool
    new_state: UIState?
    message: str?
    error: str?

  # Diff and Visualization
  StateDiff:
    from_id: str
    to_id: str
    changes: [StateChange]
    added_elements: [str]
    removed_elements: [str]
    summary: str

  TimelineVisualization:
    entries: [TimelineEntry]
    branches: [TimelineBranch]
    current_position: int
    snapshots: [TimelineSnapshot]

  TimelineEntry:
    id: str
    index: int
    action_type: str
    description: str
    timestamp: int
    branch: str
    is_current: bool

  TimelineBranch:
    id: str
    name: str
    start_index: int
    end_index: int
    color: int

  TimelineSnapshot:
    id: str
    name: str
    index: int

functions:
  # Core operations
  - name: history_create
    params: {max_entries: int, compression: CompressionMode}
    returns: History
    description: Create new history

  - name: history_record
    params: {history: History, state: UIState, action: Action}
    returns: HistoryEntry
    description: Record state change

  - name: history_undo
    params: {history: History, count: int}
    returns: TimeTravelResult
    description: Undo actions

  - name: history_redo
    params: {history: History, count: int}
    returns: TimeTravelResult
    description: Redo actions

  - name: history_goto
    params: {history: History, entry_id: str}
    returns: TimeTravelResult
    description: Go to specific entry

  # Branching
  - name: branch_create
    params: {history: History, name: str}
    returns: Branch
    description: Create new branch at current position

  - name: branch_switch
    params: {history: History, branch_id: str}
    returns: TimeTravelResult
    description: Switch to branch

  - name: branch_merge
    params: {history: History, source: str, target: str}
    returns: TimeTravelResult
    description: Merge branches

  - name: branch_delete
    params: {history: History, branch_id: str}
    returns: bool
    description: Delete branch

  # Snapshots
  - name: snapshot_create
    params: {history: History, name: str}
    returns: Snapshot
    description: Create named snapshot

  - name: snapshot_restore
    params: {history: History, snapshot_id: str}
    returns: TimeTravelResult
    description: Restore snapshot

  - name: snapshot_delete
    params: {history: History, snapshot_id: str}
    returns: bool
    description: Delete snapshot

  - name: snapshot_list
    params: {history: History}
    returns: [Snapshot]
    description: List all snapshots

  # Replay
  - name: replay_start
    params: {history: History, options: ReplayOptions}
    returns: ReplaySession
    description: Start replay session

  - name: replay_pause
    params: {session: ReplaySession}
    returns: void
    description: Pause replay

  - name: replay_resume
    params: {session: ReplaySession}
    returns: void
    description: Resume replay

  - name: replay_stop
    params: {session: ReplaySession}
    returns: void
    description: Stop replay

  - name: replay_step
    params: {session: ReplaySession, direction: str}
    returns: TimeTravelResult
    description: Step forward or backward

  # Diff and visualization
  - name: state_diff
    params: {from_id: str, to_id: str}
    returns: StateDiff
    description: Calculate diff between states

  - name: timeline_visualize
    params: {history: History}
    returns: TimelineVisualization
    description: Generate timeline visualization

  # Persistence
  - name: history_save
    params: {history: History, path: str}
    returns: bool
    description: Save history to file

  - name: history_load
    params: {path: str}
    returns: History
    description: Load history from file

  - name: history_export
    params: {history: History, format: str}
    returns: str
    description: Export history (JSON, CSV, etc.)

imports:
  - kernel.ui.plastic_screen
  - kernel.ui.semantic_pixel

time_travel_philosophy: |
  # Time-Travel UI Philosophy
  
  ## The Problem
  
  Traditional UIs are ephemeral:
  - State is lost on refresh
  - No way to undo complex operations
  - Can't replay user sessions
  - Debugging is guesswork
  
  ## The Solution
  
  Every state change is recorded:
  
  ```
  Stateâ‚€ â†’ Actionâ‚ â†’ Stateâ‚ â†’ Actionâ‚‚ â†’ Stateâ‚‚ â†’ ...
  ```
  
  This enables:
  - **Undo/Redo**: Go back and forward in time
  - **Branching**: Explore alternative paths
  - **Replay**: Watch sessions unfold
  - **Debugging**: See exactly what happened
  - **Testing**: Replay scenarios automatically
  
  ## Implementation
  
  ```
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                    Time Travel                       â”‚
  â”‚                                                      â”‚
  â”‚  Past â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Present â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ Future      â”‚
  â”‚                                                      â”‚
  â”‚  [Sâ‚€]â”€â”€[Sâ‚]â”€â”€[Sâ‚‚]â”€â”€[Sâ‚ƒ]â”€â”€[Sâ‚„]â”€â”€[Sâ‚…]                â”‚
  â”‚                      â†‘                               â”‚
  â”‚                   Current                            â”‚
  â”‚                      â”‚                               â”‚
  â”‚                      â””â”€â”€[Sâ‚ƒ']â”€â”€[Sâ‚„']  (Branch)      â”‚
  â”‚                                                      â”‚
  â”‚  [ğŸ“¸] Snapshot                                       â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  ```

branching_example: |
  # Branching Example
  
  ## Scenario: Form Submission
  
  ```
  Main Timeline:
  [Empty Form] â†’ [Fill Email] â†’ [Fill Password] â†’ [Submit] â†’ [Error]
                                      â†‘
                                   Branch here!
                                      â”‚
  Branch "try_different_password":    â”‚
                                      â””â†’ [Different Password] â†’ [Submit] â†’ [Success!]
  ```
  
  ## Code
  
  ```vscreen
  behavior branch_on_error {
    given: form submission failed
    when: user wants to try again
    then:
      create_branch "retry_{timestamp}"
      announce "Created new timeline branch"
  }
  
  behavior compare_branches {
    given: multiple branches exist
    when: user requests comparison
    then:
      show_diff main_branch current_branch
      highlight_divergence_point
  }
  ```

replay_use_cases: |
  # Replay Use Cases
  
  ## 1. User Support
  
  User reports bug â†’ Support replays their session â†’ Sees exactly what happened
  
  ```vscreen
  behavior export_session {
    given: user reports issue
    when: export_session is triggered
    then:
      create_snapshot "bug_report"
      export_history format json
      attach_to_ticket
  }
  ```
  
  ## 2. Automated Testing
  
  Record user session â†’ Convert to test â†’ Replay automatically
  
  ```vscreen
  behavior record_as_test {
    given: recording mode is on
    when: user completes flow
    then:
      generate_test_spec from history
      save_test "user_flow_{timestamp}"
  }
  ```
  
  ## 3. Onboarding
  
  Record expert session â†’ New users watch replay with annotations
  
  ```vscreen
  behavior annotated_replay {
    given: replay is playing
    when: action occurs
    then:
      show_annotation for action
      highlight_element action.target
      pause_if annotation.requires_attention
  }
  ```
  
  ## 4. A/B Testing
  
  Branch at decision point â†’ Compare outcomes
  
  ```vscreen
  behavior ab_branch {
    given: user reaches decision point
    when: ab_test is active
    then:
      create_branch "variant_a"
      create_branch "variant_b"
      randomly_assign_user
  }
  ```

keyboard_shortcuts: |
  # Time Travel Keyboard Shortcuts
  
  | Shortcut | Action |
  |----------|--------|
  | Ctrl+Z | Undo |
  | Ctrl+Shift+Z | Redo |
  | Ctrl+Y | Redo (alternative) |
  | Ctrl+Alt+Z | Undo to snapshot |
  | Ctrl+S | Create snapshot |
  | Ctrl+B | Create branch |
  | Ctrl+[ | Step backward |
  | Ctrl+] | Step forward |
  | Ctrl+Shift+R | Start replay |
  | Space | Pause/Resume replay |
  | Escape | Stop replay |
