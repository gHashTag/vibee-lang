name: vibee_os_plugin_hive
version: "0.1.0"
language: gleam
module: kernel/ui/plugins
description: Plugin Hive System - hexagonal cells (соты) for modular UI. Each plugin owns a region of pixels.

behaviors:
  - name: register_plugin
    given: Plugin manifest is provided
    when: plugin_register is called
    then: Plugin is registered and assigned pixel region
    test_cases:
      - name: register_calculator
        input: {manifest: {id: "calc", name: "Calculator", size: {w: 300, h: 400}}}
        expected: {registered: true, region_assigned: true, docs_required: true}
      - name: reject_without_docs
        input: {manifest: {id: "nodocs", name: "No Docs"}, has_docs: false}
        expected: {registered: false, error: "documentation_required"}

  - name: plugin_hot_reload
    given: Plugin is running
    when: New version is deployed
    then: Plugin reloads without affecting other plugins
    test_cases:
      - name: hot_reload_success
        input: {plugin_id: "calc", new_version: "1.1.0"}
        expected: {reloaded: true, state_preserved: true, downtime_ms: 0}

  - name: plugin_communication
    given: Two plugins need to communicate
    when: plugin_send is called
    then: Message delivered through supervised channel
    test_cases:
      - name: send_between_plugins
        input: {from: "calc", to: "history", message: {type: "result", value: 42}}
        expected: {delivered: true, ack: true}

  - name: plugin_layout_negotiation
    given: Multiple plugins compete for screen space
    when: layout_negotiate is called
    then: Plugins arranged optimally based on priority and size
    test_cases:
      - name: arrange_3_plugins
        input: {plugins: ["calc", "notes", "clock"], screen: {w: 1920, h: 1080}}
        expected: {arranged: true, no_overlap: true, all_visible: true}

  - name: plugin_isolation
    given: Plugin crashes
    when: Error occurs in plugin process
    then: Only that plugin affected, others continue
    test_cases:
      - name: crash_isolation
        input: {crashing_plugin: "buggy", other_plugins: ["calc", "notes"]}
        expected: {buggy_restarted: true, calc_running: true, notes_running: true}

types:
  Plugin:
    id: str
    name: str
    version: str
    manifest: PluginManifest
    state: PluginState
    region: Region
    supervisor: str
    docs_url: str

  PluginManifest:
    id: str
    name: str
    version: str
    description: str
    author: str
    size: Size
    min_size: Size?
    max_size: Size?
    resizable: bool
    dependencies: [str]
    permissions: [Permission]
    entry_point: str
    docs_path: str

  Size:
    width: int
    height: int

  Permission:
    variants:
      - PixelWrite         # Can write to own pixels
      - PixelReadOther     # Can read other plugin pixels
      - Network            # Can make network requests
      - FileSystem         # Can access files
      - Clipboard          # Can access clipboard
      - Notifications      # Can show notifications
      - FullScreen         # Can go fullscreen

  PluginState:
    variants:
      - Loading
      - Running
      - Paused
      - Error
      - Stopped

  Region:
    x: int
    y: int
    width: int
    height: int
    z_index: int
    visible: bool
    pixels: [str]         # Pixel actor PIDs

  PluginMessage:
    from: str
    to: str
    type: str
    payload: str          # JSON or binary
    timestamp: int
    reply_to: str?

  PluginEvent:
    variants:
      - Registered: {plugin_id: str}
      - Started: {plugin_id: str}
      - Stopped: {plugin_id: str}
      - Crashed: {plugin_id: str, error: str}
      - Resized: {plugin_id: str, new_size: Size}
      - Focused: {plugin_id: str}
      - Blurred: {plugin_id: str}

  HiveLayout:
    plugins: [PluginPlacement]
    screen_size: Size
    grid_size: int        # Hexagonal grid cell size
    gaps: int

  PluginPlacement:
    plugin_id: str
    cell: HexCell
    span: HexSpan

  HexCell:
    q: int                # Axial coordinate
    r: int                # Axial coordinate

  HexSpan:
    width: int            # Cells wide
    height: int           # Cells tall

  PluginRegistry:
    plugins: {str: Plugin}
    layout: HiveLayout
    focused: str?
    z_order: [str]

functions:
  # Registration
  - name: plugin_register
    params: {manifest: PluginManifest}
    returns: Plugin
    description: Register new plugin

  - name: plugin_unregister
    params: {plugin_id: str}
    returns: bool
    description: Unregister plugin

  - name: plugin_validate
    params: {manifest: PluginManifest}
    returns: {valid: bool, errors: [str]}
    description: Validate plugin manifest

  # Lifecycle
  - name: plugin_start
    params: {plugin_id: str}
    returns: bool
    description: Start plugin

  - name: plugin_stop
    params: {plugin_id: str}
    returns: bool
    description: Stop plugin

  - name: plugin_restart
    params: {plugin_id: str}
    returns: bool
    description: Restart plugin

  - name: plugin_reload
    params: {plugin_id: str, new_code: str}
    returns: bool
    description: Hot reload plugin code

  # Communication
  - name: plugin_send
    params: {from: str, to: str, message: PluginMessage}
    returns: bool
    description: Send message between plugins

  - name: plugin_broadcast
    params: {from: str, message: PluginMessage}
    returns: int
    description: Broadcast to all plugins

  - name: plugin_subscribe
    params: {plugin_id: str, event_type: str, callback: str}
    returns: str
    description: Subscribe to events

  # Layout
  - name: layout_arrange
    params: {plugins: [str], screen: Size}
    returns: HiveLayout
    description: Arrange plugins on screen

  - name: layout_resize
    params: {plugin_id: str, new_size: Size}
    returns: bool
    description: Resize plugin region

  - name: layout_move
    params: {plugin_id: str, to: HexCell}
    returns: bool
    description: Move plugin to new cell

  - name: layout_focus
    params: {plugin_id: str}
    returns: void
    description: Focus plugin (bring to front)

  # Registry
  - name: registry_list
    params: {}
    returns: [Plugin]
    description: List all registered plugins

  - name: registry_get
    params: {plugin_id: str}
    returns: Plugin?
    description: Get plugin by ID

  - name: registry_search
    params: {query: str}
    returns: [Plugin]
    description: Search plugins

imports:
  - kernel.ui.pixel_grid
  - kernel.ui.canvas_renderer

hexagonal_layout: |
  # Hexagonal Grid Layout (Соты)
  
  Why hexagons?
  - More neighbors (6 vs 4 for squares)
  - Better space utilization
  - Natural for organic layouts
  - Visually distinctive
  
  ## Axial Coordinates
  
  ```
        _____
       /     \
      /  0,0  \
     /    *    \_____
     \         /     \
      \_____  /  1,0  \
      /     \/    *    \
     / -1,1  \         /
    /    *    \_____  /
    \         /     \/
     \_____  /  0,1  \
            /    *    \
            \         /
             \_____  /
  ```
  
  ## Pixel Mapping
  
  ```
  hex_to_pixel(q, r, size):
    x = size * (3/2 * q)
    y = size * (sqrt(3)/2 * q + sqrt(3) * r)
    return (x, y)
  
  pixel_to_hex(x, y, size):
    q = (2/3 * x) / size
    r = (-1/3 * x + sqrt(3)/3 * y) / size
    return round_hex(q, r)
  ```

plugin_manifest_example: |
  # Example Plugin Manifest
  
  ```yaml
  id: calculator
  name: Calculator
  version: "1.0.0"
  description: Simple calculator with history
  author: VIBEE Team
  
  size:
    width: 300
    height: 400
  
  min_size:
    width: 200
    height: 300
  
  resizable: true
  
  dependencies:
    - core.math
    - ui.buttons
  
  permissions:
    - PixelWrite
    - Clipboard
  
  entry_point: calculator.main
  docs_path: /docs/plugins/calculator.md
  ```

plugin_api: |
  # Plugin API
  
  Every plugin must implement:
  
  ```gleam
  pub type PluginContext {
    PluginContext(
      id: String,
      region: Region,
      send: fn(PluginMessage) -> Result(Nil, Error),
      get_pixels: fn() -> List(Pixel),
      set_pixel: fn(Int, Int, Int) -> Nil,
    )
  }
  
  // Required callbacks
  pub fn init(ctx: PluginContext) -> PluginState
  pub fn update(state: PluginState, msg: PluginMessage) -> PluginState
  pub fn render(state: PluginState, ctx: PluginContext) -> Nil
  pub fn cleanup(state: PluginState) -> Nil
  
  // Optional callbacks
  pub fn on_resize(state: PluginState, new_size: Size) -> PluginState
  pub fn on_focus(state: PluginState) -> PluginState
  pub fn on_blur(state: PluginState) -> PluginState
  ```

documentation_requirement: |
  # Documentation Requirement
  
  Every plugin MUST have documentation:
  
  1. **README.md** - Overview and quick start
  2. **API.md** - Public API documentation
  3. **CHANGELOG.md** - Version history
  
  Plugins without docs are REJECTED at registration.
  
  This ensures:
  - Users can understand what plugin does
  - Developers can extend/integrate
  - Agent can learn plugin capabilities
