name: vibee_os_screen_specification
version: "0.1.0"
language: gleam
module: kernel/ui/screen_spec
description: Screen as Specification - applying Vibee algorithm to the screen itself. Screen = Given/When/Then behaviors.

behaviors:
  - name: screen_is_specification
    given: Screen is a 2D grid of pixels
    when: We treat each visual state as a behavior specification
    then: Screen becomes compilable, testable, verifiable
    test_cases:
      - name: empty_screen_spec
        input: {width: 1920, height: 1080, state: "empty"}
        expected: {valid_spec: true, behaviors: 0, pixels: 2073600}
      - name: button_on_screen
        input: {element: "button", x: 100, y: 100, w: 200, h: 50}
        expected: {valid_spec: true, behaviors: 3, test_cases: 5}

  - name: pixel_has_behavior
    given: A pixel at position (x, y)
    when: Pixel receives input or time passes
    then: Pixel transitions to new state according to its behavior spec
    test_cases:
      - name: pixel_hover_behavior
        input: {x: 100, y: 100, event: "cursor_enter"}
        expected: {state_before: "idle", state_after: "hover", color_changed: true}
      - name: pixel_click_behavior
        input: {x: 100, y: 100, event: "click"}
        expected: {state_before: "hover", state_after: "active", action_triggered: true}

  - name: region_composes_behaviors
    given: Multiple pixels form a region
    when: Region is defined with composite behavior
    then: All pixels in region share behavior specification
    test_cases:
      - name: button_region
        input: {region: "submit_btn", pixels: 10000}
        expected: {shared_behavior: true, hover_all: true, click_all: true}

  - name: screen_compiles_to_pixels
    given: Screen specification in Vibee format
    when: screen_compile is called
    then: Specification generates pixel actors with behaviors
    test_cases:
      - name: compile_login_screen
        input: {spec: "login_form.vscreen"}
        expected: {compiled: true, actors_spawned: 50000, behaviors_attached: 150}

  - name: screen_verifies_visually
    given: Screen is rendered
    when: screen_verify is called
    then: Visual output matches specification (pixel-perfect)
    test_cases:
      - name: verify_button_color
        input: {element: "submit_btn", expected_color: 0x4CAF50}
        expected: {verified: true, all_pixels_match: true}
      - name: verify_layout
        input: {spec: "login_form.vscreen"}
        expected: {verified: true, positions_correct: true, sizes_correct: true}

types:
  ScreenSpec:
    name: str
    version: str
    width: int
    height: int
    behaviors: [VisualBehavior]
    regions: [RegionSpec]
    transitions: [TransitionSpec]
    tests: [VisualTest]

  VisualBehavior:
    name: str
    given: VisualCondition
    when: VisualTrigger
    then: VisualOutcome
    test_cases: [VisualTestCase]

  VisualCondition:
    state: PixelState?
    region: str?
    time_ms: int?
    cursor_distance: int?
    custom: str?

  VisualTrigger:
    variants:
      - CursorEnter
      - CursorLeave
      - CursorMove: {dx: int, dy: int}
      - Click: {button: int}
      - DoubleClick
      - KeyPress: {key: str}
      - TimeElapsed: {ms: int}
      - MessageReceived: {type: str}
      - WavePulse: {phase: float}
      - EmotionChange: {emotion: str}

  VisualOutcome:
    new_state: PixelState?
    color_transition: ColorTransition?
    emit_event: str?
    spawn_wave: WaveSpec?
    trigger_action: str?

  PixelState:
    variants:
      - Idle
      - Hover
      - Active
      - Disabled
      - Loading
      - Error
      - Success
      - Custom: {name: str}

  ColorTransition:
    from: int?
    to: int
    duration_ms: int
    easing: Easing

  Easing:
    variants:
      - Linear
      - EaseIn
      - EaseOut
      - EaseInOut
      - Bounce
      - Elastic

  RegionSpec:
    id: str
    bounds: Rect
    behavior: str          # Reference to VisualBehavior
    z_index: int
    children: [RegionSpec]
    style: StyleSpec

  Rect:
    x: int
    y: int
    width: int
    height: int

  StyleSpec:
    background: int?
    foreground: int?
    border_color: int?
    border_width: int?
    border_radius: int?
    opacity: float?
    shadow: ShadowSpec?

  ShadowSpec:
    offset_x: int
    offset_y: int
    blur: int
    color: int

  TransitionSpec:
    from_state: str
    to_state: str
    trigger: VisualTrigger
    animation: AnimationSpec

  AnimationSpec:
    duration_ms: int
    easing: Easing
    keyframes: [Keyframe]?

  Keyframe:
    percent: float
    properties: {str: float}

  WaveSpec:
    type: WaveType
    origin: Point
    amplitude: float
    frequency: float
    decay: float
    color_map: str

  WaveType:
    variants:
      - Circular
      - Linear
      - Spiral
      - Pulse
      - Ripple

  Point:
    x: int
    y: int

  VisualTest:
    name: str
    setup: [SetupStep]
    actions: [TestAction]
    assertions: [VisualAssertion]

  SetupStep:
    variants:
      - SetState: {region: str, state: str}
      - SetColor: {region: str, color: int}
      - Wait: {ms: int}

  TestAction:
    variants:
      - MoveCursor: {to: Point}
      - Click: {at: Point}
      - Type: {text: str}
      - Wait: {ms: int}
      - TriggerWave: {spec: WaveSpec}

  VisualAssertion:
    variants:
      - PixelColor: {at: Point, expected: int}
      - RegionState: {region: str, expected: str}
      - RegionVisible: {region: str, visible: bool}
      - AnimationComplete: {region: str}
      - EventEmitted: {event: str}

  VisualTestCase:
    name: str
    input: VisualInput
    expected: VisualExpected

  VisualInput:
    trigger: VisualTrigger
    context: {str: str}

  VisualExpected:
    state: PixelState?
    color: int?
    event: str?
    animation: str?

  CompiledScreen:
    spec: ScreenSpec
    pixel_actors: [[str]]    # 2D array of PIDs
    region_supervisors: {str: str}
    behavior_handlers: {str: str}

functions:
  # Specification
  - name: screen_define
    params: {name: str, width: int, height: int}
    returns: ScreenSpec
    description: Create new screen specification

  - name: screen_add_behavior
    params: {spec: ScreenSpec, behavior: VisualBehavior}
    returns: ScreenSpec
    description: Add visual behavior to screen

  - name: screen_add_region
    params: {spec: ScreenSpec, region: RegionSpec}
    returns: ScreenSpec
    description: Add region to screen

  - name: screen_add_transition
    params: {spec: ScreenSpec, transition: TransitionSpec}
    returns: ScreenSpec
    description: Add state transition

  # Compilation
  - name: screen_compile
    params: {spec: ScreenSpec}
    returns: CompiledScreen
    description: Compile specification to pixel actors

  - name: screen_spawn_pixels
    params: {compiled: CompiledScreen}
    returns: int
    description: Spawn all pixel actors

  - name: screen_attach_behaviors
    params: {compiled: CompiledScreen}
    returns: int
    description: Attach behaviors to pixels

  # Verification
  - name: screen_verify
    params: {compiled: CompiledScreen}
    returns: {passed: bool, failures: [str]}
    description: Verify screen matches specification

  - name: screen_test
    params: {compiled: CompiledScreen, test: VisualTest}
    returns: {passed: bool, details: str}
    description: Run visual test

  - name: screen_test_all
    params: {compiled: CompiledScreen}
    returns: {passed: int, failed: int, results: [str]}
    description: Run all visual tests

  # Runtime
  - name: screen_render
    params: {compiled: CompiledScreen}
    returns: [[int]]
    description: Render current state to pixel buffer

  - name: screen_handle_event
    params: {compiled: CompiledScreen, event: VisualTrigger, at: Point}
    returns: void
    description: Handle input event

  - name: screen_transition
    params: {compiled: CompiledScreen, region: str, to_state: str}
    returns: void
    description: Trigger state transition

imports:
  - kernel.ui.pixel_grid
  - kernel.ui.canvas_renderer

screen_as_code: |
  # Screen as Code (Vibee Algorithm Applied)
  
  Traditional: Screen is pixels → Code controls pixels
  Vibee Way:   Screen IS specification → Specification compiles to pixels
  
  ## The Insight
  
  Just as Vibee treats code as behavior specifications:
  
  ```yaml
  # Code behavior
  behaviors:
    - name: add_numbers
      given: Two integers
      when: add() called
      then: Returns sum
  ```
  
  We treat SCREEN as behavior specifications:
  
  ```yaml
  # Screen behavior
  behaviors:
    - name: button_hover
      given: Cursor outside button
      when: Cursor enters button region
      then: Button color transitions to hover state
  ```
  
  ## Benefits
  
  1. **Testable**: Visual behaviors have test cases
  2. **Verifiable**: Screen state can be verified
  3. **Compilable**: Spec → Pixel actors
  4. **Evolvable**: Mutations are spec changes
  5. **Documentable**: Spec IS documentation

example_screen_spec: |
  # Example: Login Screen Specification
  
  ```yaml
  name: login_screen
  version: "1.0.0"
  width: 1920
  height: 1080
  
  behaviors:
    - name: email_input_focus
      given:
        state: Idle
        region: email_input
      when: Click
      then:
        new_state: Active
        color_transition:
          to: 0x2196F3
          duration_ms: 200
          easing: EaseOut
        emit_event: "input_focused"
  
    - name: submit_button_hover
      given:
        state: Idle
        region: submit_btn
      when: CursorEnter
      then:
        new_state: Hover
        color_transition:
          to: 0x45A049
          duration_ms: 150
          easing: EaseInOut
        spawn_wave:
          type: Ripple
          amplitude: 0.3
  
    - name: submit_button_click
      given:
        state: Hover
        region: submit_btn
      when: Click
      then:
        new_state: Active
        trigger_action: "submit_form"
        spawn_wave:
          type: Pulse
          amplitude: 1.0
  
  regions:
    - id: email_input
      bounds: {x: 760, y: 400, width: 400, height: 50}
      behavior: email_input_focus
      style:
        background: 0xFFFFFF
        border_color: 0xCCCCCC
        border_width: 1
        border_radius: 4
  
    - id: submit_btn
      bounds: {x: 810, y: 520, width: 300, height: 50}
      behavior: submit_button_hover
      style:
        background: 0x4CAF50
        foreground: 0xFFFFFF
        border_radius: 4
  
  tests:
    - name: test_button_hover
      setup:
        - SetState: {region: submit_btn, state: Idle}
      actions:
        - MoveCursor: {to: {x: 960, y: 545}}
        - Wait: {ms: 200}
      assertions:
        - RegionState: {region: submit_btn, expected: Hover}
        - PixelColor: {at: {x: 960, y: 545}, expected: 0x45A049}
  ```

bdd_completeness_for_screen: |
  # BDD Completeness Theorem for Screens
  
  Original (Code):
  Spec(C) ⊢ ∀s. ⟦C(s)⟧ = ⟦s⟧
  
  Extended (Screen):
  ScreenSpec(S) ⊢ ∀p. ⟦Render(p)⟧ = ⟦Expected(p)⟧
  
  In words:
  If all visual behaviors pass their test cases,
  then the screen renders correctly for all pixel states.
  
  ## Verification Process
  
  1. Parse screen specification
  2. For each visual behavior:
     a. Set up initial state
     b. Apply trigger
     c. Verify outcome matches expected
  3. If all pass → Screen is correct by construction
  
  ## Visual Test Example
  
  ```
  Test: button_hover_changes_color
  
  Given: Button in Idle state, color = 0x4CAF50
  When:  Cursor enters button region
  Then:  Button transitions to Hover, color = 0x45A049
  
  Verification:
  1. Spawn button pixels with Idle state
  2. Send CursorEnter to button region
  3. Wait for transition (200ms)
  4. Assert all button pixels = 0x45A049
  5. PASS ✓
  ```
