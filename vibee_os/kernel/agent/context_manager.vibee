name: vibee_os_context_manager
version: "0.1.0"
language: zig
module: kernel/agent/context
description: Context Manager - manages LLM context windows, analogous to memory management in traditional OS

behaviors:
  - name: allocate_context_window
    given: An agent needs a context window for processing
    when: context_alloc is called with required size
    then: Context window is allocated from the pool
    test_cases:
      - name: alloc_small_context
        input: {agent_id: "swe", tokens_needed: 4096}
        expected: {success: true, window_id: "ctx_1", tokens_allocated: 4096}
      - name: alloc_large_context
        input: {agent_id: "swe", tokens_needed: 128000}
        expected: {success: true, window_id: "ctx_2", tokens_allocated: 128000}
      - name: alloc_exceeds_limit
        input: {agent_id: "swe", tokens_needed: 1000000, max_available: 200000}
        expected: {success: false, error: "insufficient_context"}

  - name: context_compression
    given: Context window is full but more content needed
    when: context_compress is called
    then: Context is summarized to free space while preserving meaning
    test_cases:
      - name: compress_conversation
        input: {window_id: "ctx_1", current_tokens: 8000, target_tokens: 4000}
        expected: {success: true, new_tokens: 4000, summary_created: true}
      - name: compress_with_important_content
        input: {window_id: "ctx_1", important_messages: [1, 5, 10]}
        expected: {success: true, important_preserved: true}

  - name: context_snapshot
    given: Agent task is being preempted
    when: context_snapshot is called
    then: Context state is saved for later restoration
    test_cases:
      - name: save_snapshot
        input: {window_id: "ctx_1"}
        expected: {success: true, snapshot_id: "snap_1", size_bytes: 32000}
      - name: restore_snapshot
        input: {snapshot_id: "snap_1"}
        expected: {success: true, window_id: "ctx_1", state_restored: true}

  - name: context_sharing
    given: Multiple agents need to share context
    when: context_share is called
    then: Read-only view of context is provided to other agents
    test_cases:
      - name: share_with_test_agent
        input: {window_id: "ctx_1", share_with: "test_agent", permissions: "read"}
        expected: {success: true, shared_view_id: "view_1"}

types:
  ContextWindow:
    id: str
    owner_agent: str
    max_tokens: int
    used_tokens: int
    messages: [ContextMessage]
    system_prompt: str
    metadata: ContextMetadata
    snapshots: [str]  # Snapshot IDs

  ContextMessage:
    id: int
    role: Role
    content: str
    tokens: int
    timestamp: int
    importance: float  # 0.0 - 1.0, used for compression
    pinned: bool       # Never compress/remove
    tool_calls: [ToolCall]?
    tool_results: [ToolResult]?

  Role:
    variants:
      - System
      - User
      - Assistant
      - Tool

  ToolCall:
    id: str
    name: str
    arguments: str

  ToolResult:
    tool_call_id: str
    content: str
    is_error: bool

  ContextMetadata:
    created_at: int
    last_accessed: int
    compression_count: int
    total_messages_processed: int
    average_importance: float

  ContextSnapshot:
    id: str
    window_id: str
    created_at: int
    messages: [ContextMessage]
    system_prompt: str
    size_bytes: int

  ContextPool:
    total_tokens: int
    allocated_tokens: int
    free_tokens: int
    windows: [ContextWindow]
    snapshots: [ContextSnapshot]

  CompressionStrategy:
    variants:
      - Summarize       # LLM summarization
      - Truncate        # Remove oldest messages
      - Selective       # Remove low-importance messages
      - Hierarchical    # Multi-level summarization

  CompressionConfig:
    strategy: CompressionStrategy
    target_ratio: float        # Target compression ratio
    preserve_system: bool      # Always keep system prompt
    preserve_recent: int       # Keep N most recent messages
    importance_threshold: float # Keep messages above this importance

  SharedView:
    id: str
    source_window: str
    viewer_agent: str
    permissions: ViewPermissions
    filter: ViewFilter?

  ViewPermissions:
    can_read: bool
    can_append: bool  # Can add messages (for coordination)

  ViewFilter:
    roles: [Role]?           # Only show these roles
    min_importance: float?   # Only show important messages
    time_range: {start: int, end: int}?

functions:
  # Allocation
  - name: context_alloc
    params: {agent_id: str, max_tokens: int, system_prompt: str}
    returns: ContextWindow
    description: Allocate a new context window

  - name: context_free
    params: {window_id: str}
    returns: bool
    description: Free a context window

  - name: context_resize
    params: {window_id: str, new_max_tokens: int}
    returns: bool
    description: Resize context window (may trigger compression)

  # Message management
  - name: context_add_message
    params: {window_id: str, role: Role, content: str, importance: float}
    returns: int
    description: Add message to context, returns message ID

  - name: context_remove_message
    params: {window_id: str, message_id: int}
    returns: bool
    description: Remove specific message

  - name: context_pin_message
    params: {window_id: str, message_id: int}
    returns: bool
    description: Pin message (prevent compression/removal)

  - name: context_get_messages
    params: {window_id: str, limit: int?}
    returns: [ContextMessage]
    description: Get messages from context

  # Compression
  - name: context_compress
    params: {window_id: str, config: CompressionConfig}
    returns: int
    description: Compress context, returns tokens freed

  - name: context_summarize
    params: {window_id: str, message_range: {start: int, end: int}}
    returns: str
    description: Summarize a range of messages

  # Snapshots
  - name: context_snapshot
    params: {window_id: str}
    returns: str
    description: Create snapshot, returns snapshot ID

  - name: context_restore
    params: {snapshot_id: str}
    returns: ContextWindow
    description: Restore context from snapshot

  - name: context_delete_snapshot
    params: {snapshot_id: str}
    returns: bool
    description: Delete a snapshot

  # Sharing
  - name: context_share
    params: {window_id: str, with_agent: str, permissions: ViewPermissions}
    returns: SharedView
    description: Share context with another agent

  - name: context_unshare
    params: {view_id: str}
    returns: bool
    description: Revoke shared access

  # Pool management
  - name: pool_status
    params: {}
    returns: ContextPool
    description: Get context pool status

  - name: pool_gc
    params: {}
    returns: int
    description: Garbage collect unused contexts, returns freed tokens

imports:
  - kernel.agent.core
  - kernel.memory

context_as_memory: |
  Context Window as Memory Analogy:
  
  Traditional OS Memory    |  VIBEE OS Context
  -------------------------|------------------------
  RAM                      |  Context Window
  Virtual Memory           |  Compressed Context
  Swap Space               |  Snapshots (disk)
  Page Tables              |  Message Index
  Memory Protection        |  Shared Views (permissions)
  Garbage Collection       |  Context Compression
  Memory Pool              |  Context Pool
  
  Key Differences:
  1. Context is semantic (meaning-based), not byte-based
  2. Compression preserves meaning, not just data
  3. Sharing is role-based, not address-based
  4. "Paging" uses LLM summarization
  
  Memory Hierarchy:
  
  ┌─────────────────────────────────────┐
  │  Working Context (fastest)          │  ← Current conversation
  │  ~4K-8K tokens                      │
  ├─────────────────────────────────────┤
  │  Extended Context (fast)            │  ← Full context window
  │  ~32K-128K tokens                   │
  ├─────────────────────────────────────┤
  │  Compressed Context (medium)        │  ← Summarized history
  │  ~1M tokens equivalent              │
  ├─────────────────────────────────────┤
  │  Snapshots (slow)                   │  ← Saved states on disk
  │  Unlimited                          │
  ├─────────────────────────────────────┤
  │  Semantic Memory (slowest)          │  ← Long-term knowledge
  │  Vector database                    │
  └─────────────────────────────────────┘
