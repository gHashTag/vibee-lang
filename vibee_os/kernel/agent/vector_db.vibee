name: vibee_os_vector_db
version: "0.1.0"
language: gleam
module: kernel/agent/vector_db
description: Vector Database - хранение и поиск embeddings для Semantic Memory

behaviors:
  - name: store_embedding
    given: Text and its embedding vector
    when: store is called
    then: Embedding is stored with metadata
    test_cases:
      - name: store_simple
        input:
          id: "doc_1"
          text: "Hello world"
          embedding: [0.1, 0.2, 0.3, 0.4]
          metadata: {source: "test"}
        expected:
          stored: true
          id: "doc_1"
      - name: store_with_namespace
        input:
          id: "doc_2"
          embedding: [0.5, 0.6, 0.7, 0.8]
          namespace: "code"
        expected:
          stored: true
          namespace: "code"

  - name: search_similar
    given: Query embedding
    when: search is called with top_k
    then: Most similar embeddings are returned
    test_cases:
      - name: search_top_3
        input:
          query_embedding: [0.1, 0.2, 0.3, 0.4]
          top_k: 3
        expected:
          results_count: 3
          sorted_by_similarity: true
      - name: search_with_filter
        input:
          query_embedding: [0.1, 0.2, 0.3, 0.4]
          top_k: 5
          filter: {source: "code"}
        expected:
          all_match_filter: true
      - name: search_with_threshold
        input:
          query_embedding: [0.1, 0.2, 0.3, 0.4]
          min_similarity: 0.8
        expected:
          all_above_threshold: true

  - name: delete_embedding
    given: Embedding exists
    when: delete is called with id
    then: Embedding is removed
    test_cases:
      - name: delete_existing
        input: {id: "doc_1"}
        expected: {deleted: true}
      - name: delete_nonexistent
        input: {id: "nonexistent"}
        expected: {deleted: false, error: "not_found"}

  - name: update_embedding
    given: Embedding exists
    when: update is called with new vector
    then: Embedding is updated
    test_cases:
      - name: update_vector
        input:
          id: "doc_1"
          new_embedding: [0.9, 0.8, 0.7, 0.6]
        expected:
          updated: true
      - name: update_metadata
        input:
          id: "doc_1"
          new_metadata: {updated: true}
        expected:
          updated: true
          metadata_merged: true

  - name: batch_operations
    given: Multiple embeddings
    when: batch operation is called
    then: All operations complete efficiently
    test_cases:
      - name: batch_store
        input:
          embeddings: 1000
          dimension: 1536
        expected:
          stored: 1000
          duration_ms_less_than: 1000
      - name: batch_search
        input:
          queries: 10
          top_k: 5
        expected:
          total_results: 50

  - name: persistence
    given: Vector database has data
    when: save/load is called
    then: Data persists across restarts
    test_cases:
      - name: save_and_load
        input:
          embeddings: 100
          save_path: "/tmp/vectors.db"
        expected:
          saved: true
          loaded: true
          count_matches: true

types:
  # Core Types
  Embedding:
    id: str
    vector: [float]
    text: str?
    metadata: {str: str}
    namespace: str?
    created_at: int
    updated_at: int

  # Search
  SearchQuery:
    embedding: [float]
    top_k: int
    min_similarity: float?
    filter: MetadataFilter?
    namespace: str?
    include_metadata: bool
    include_vectors: bool

  MetadataFilter:
    conditions: [FilterCondition]
    operator: FilterOperator

  FilterCondition:
    field: str
    operator: CompareOperator
    value: str

  CompareOperator:
    variants:
      - Equals
      - NotEquals
      - Contains
      - StartsWith
      - GreaterThan
      - LessThan
      - In
      - NotIn

  FilterOperator:
    variants:
      - And
      - Or

  SearchResult:
    id: str
    similarity: float
    text: str?
    metadata: {str: str}?
    vector: [float]?

  SearchResults:
    results: [SearchResult]
    query_time_ms: int
    total_searched: int

  # Batch Operations
  BatchStoreRequest:
    embeddings: [Embedding]
    namespace: str?

  BatchStoreResult:
    stored: int
    failed: int
    errors: [str]

  BatchDeleteRequest:
    ids: [str]
    namespace: str?

  BatchDeleteResult:
    deleted: int
    not_found: int

  # Index Configuration
  IndexConfig:
    dimension: int
    metric: DistanceMetric
    index_type: IndexType
    ef_construction: int?
    m: int?

  DistanceMetric:
    variants:
      - Cosine
      - Euclidean
      - DotProduct

  IndexType:
    variants:
      - Flat                          # Exact search, slow
      - HNSW                          # Approximate, fast
      - IVF                           # Inverted file index
      - LSH                           # Locality-sensitive hashing

  # Database Configuration
  VectorDBConfig:
    backend: VectorBackend
    index: IndexConfig
    persistence_path: str?
    cache_size: int
    auto_save: bool
    auto_save_interval_ms: int

  VectorBackend:
    variants:
      - InMemory
      - SQLite: {path: str}
      - File: {path: str}
      - Remote: {url: str, api_key_env: str}

  # Statistics
  DBStats:
    total_embeddings: int
    namespaces: [str]
    dimension: int
    index_size_bytes: int
    avg_search_time_ms: float

  # Namespace
  Namespace:
    name: str
    count: int
    dimension: int
    metadata_schema: {str: str}?

functions:
  # Lifecycle
  - name: db_create
    params: {config: VectorDBConfig}
    returns: VectorDB
    description: Create new vector database

  - name: db_open
    params: {path: str}
    returns: VectorDB
    description: Open existing database

  - name: db_close
    params: {db: VectorDB}
    returns: bool
    description: Close database

  - name: db_save
    params: {db: VectorDB}
    returns: bool
    description: Save database to disk

  # Single operations
  - name: store
    params: {db: VectorDB, embedding: Embedding}
    returns: bool
    description: Store single embedding

  - name: get
    params: {db: VectorDB, id: str}
    returns: Embedding?
    description: Get embedding by ID

  - name: delete
    params: {db: VectorDB, id: str}
    returns: bool
    description: Delete embedding by ID

  - name: update
    params: {db: VectorDB, id: str, embedding: Embedding}
    returns: bool
    description: Update existing embedding

  # Search
  - name: search
    params: {db: VectorDB, query: SearchQuery}
    returns: SearchResults
    description: Search for similar embeddings

  - name: search_text
    params: {db: VectorDB, text: str, top_k: int}
    returns: SearchResults
    description: Search by text (auto-embeds)

  # Batch operations
  - name: batch_store
    params: {db: VectorDB, request: BatchStoreRequest}
    returns: BatchStoreResult
    description: Store multiple embeddings

  - name: batch_delete
    params: {db: VectorDB, request: BatchDeleteRequest}
    returns: BatchDeleteResult
    description: Delete multiple embeddings

  # Namespace
  - name: namespace_create
    params: {db: VectorDB, name: str}
    returns: Namespace
    description: Create namespace

  - name: namespace_list
    params: {db: VectorDB}
    returns: [Namespace]
    description: List all namespaces

  - name: namespace_delete
    params: {db: VectorDB, name: str}
    returns: bool
    description: Delete namespace and all embeddings

  # Statistics
  - name: stats
    params: {db: VectorDB}
    returns: DBStats
    description: Get database statistics

  # Similarity calculation
  - name: cosine_similarity
    params: {a: [float], b: [float]}
    returns: float
    description: Calculate cosine similarity

  - name: euclidean_distance
    params: {a: [float], b: [float]}
    returns: float
    description: Calculate Euclidean distance

  - name: dot_product
    params: {a: [float], b: [float]}
    returns: float
    description: Calculate dot product

imports:
  - kernel.agent.embedding_model

similarity_algorithms: |
  # Similarity Algorithms
  
  ## Cosine Similarity
  ```
  cos(a, b) = (a · b) / (||a|| × ||b||)
  
  Range: [-1, 1]
  1 = identical
  0 = orthogonal
  -1 = opposite
  ```
  
  ## Euclidean Distance
  ```
  d(a, b) = sqrt(Σ(ai - bi)²)
  
  Range: [0, ∞)
  0 = identical
  Convert to similarity: 1 / (1 + d)
  ```
  
  ## Dot Product
  ```
  a · b = Σ(ai × bi)
  
  Range: (-∞, ∞)
  Higher = more similar
  Requires normalized vectors for comparison
  ```

index_types: |
  # Index Types
  
  ## Flat (Exact)
  - Brute force search
  - O(n) per query
  - 100% accurate
  - Best for < 10K vectors
  
  ## HNSW (Hierarchical Navigable Small World)
  - Approximate nearest neighbor
  - O(log n) per query
  - 95-99% recall
  - Best for 10K - 10M vectors
  - Parameters: M (connections), ef (search width)
  
  ## IVF (Inverted File Index)
  - Clusters vectors
  - Searches only relevant clusters
  - Good for very large datasets
  - Parameters: nlist (clusters), nprobe (search clusters)

usage_example: |
  # Usage Example
  
  ```vibee
  behavior store_code_snippet
    given: Code snippet text
    when: store_snippet is called
    then: 
      embedding = embed(text)
      store(db, {
        id: generate_id(),
        vector: embedding,
        text: text,
        metadata: {type: "code", language: "gleam"},
        namespace: "code"
      })
  
  behavior find_similar_code
    given: Query code
    when: find_similar is called
    then:
      query_embedding = embed(query)
      results = search(db, {
        embedding: query_embedding,
        top_k: 5,
        filter: {type: "code"},
        namespace: "code"
      })
      return results
  ```
