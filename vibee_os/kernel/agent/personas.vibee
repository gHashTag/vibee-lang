name: vibee_os_agent_personas
version: "0.1.0"
language: gleam
module: kernel/agent/personas
description: Agent Personas - специализированные агенты для разных задач (SWE, Test, Review, etc.)

behaviors:
  - name: swe_agent_generates_code
    given: SWE Agent receives task description
    when: generate is called
    then: Agent generates Vibee specification
    test_cases:
      - name: generate_api
        input:
          task: "Create REST API for user management"
          persona: "swe"
        expected:
          has_behaviors: true
          has_types: true
          has_tests: true
      - name: generate_with_context
        input:
          task: "Add delete endpoint"
          context: "existing user API spec"
          persona: "swe"
        expected:
          integrates_with_existing: true

  - name: test_agent_generates_tests
    given: Test Agent receives specification
    when: generate_tests is called
    then: Agent generates comprehensive test cases
    test_cases:
      - name: generate_edge_cases
        input:
          spec: "calculator.vibee"
          persona: "test"
        expected:
          has_edge_cases: true
          has_error_cases: true
          coverage_above: 0.9
      - name: generate_integration_tests
        input:
          specs: ["api.vibee", "db.vibee"]
          persona: "test"
        expected:
          has_integration_tests: true

  - name: review_agent_reviews_code
    given: Review Agent receives specification
    when: review is called
    then: Agent provides feedback and suggestions
    test_cases:
      - name: review_finds_issues
        input:
          spec: "buggy.vibee"
          persona: "review"
        expected:
          has_issues: true
          has_suggestions: true
      - name: review_approves_good_code
        input:
          spec: "clean.vibee"
          persona: "review"
        expected:
          approved: true
          minor_suggestions_only: true

  - name: doc_agent_generates_docs
    given: Doc Agent receives specification
    when: generate_docs is called
    then: Agent generates documentation
    test_cases:
      - name: generate_api_docs
        input:
          spec: "api.vibee"
          persona: "doc"
        expected:
          has_overview: true
          has_examples: true
          has_api_reference: true

  - name: security_agent_audits
    given: Security Agent receives specification
    when: audit is called
    then: Agent identifies security issues
    test_cases:
      - name: find_vulnerabilities
        input:
          spec: "auth.vibee"
          persona: "security"
        expected:
          checked_auth: true
          checked_injection: true
          checked_secrets: true

  - name: agents_collaborate
    given: Multiple agents assigned to task
    when: collaborate is called
    then: Agents work together and produce result
    test_cases:
      - name: swe_and_test_collaborate
        input:
          task: "Create and test calculator"
          agents: ["swe", "test"]
        expected:
          spec_generated: true
          tests_generated: true
          tests_pass: true
      - name: full_team
        input:
          task: "Create production API"
          agents: ["swe", "test", "review", "security", "doc"]
        expected:
          all_agents_contributed: true

types:
  # Persona Definition
  Persona:
    id: str
    name: str
    role: AgentRole
    system_prompt: str
    capabilities: [Capability]
    tools: [str]
    temperature: float
    model: str?
    max_tokens: int?

  AgentRole:
    variants:
      - SWE                           # Software Engineer
      - Test                          # Test Engineer
      - Review                        # Code Reviewer
      - Doc                           # Documentation Writer
      - Security                      # Security Auditor
      - Architect                     # System Architect
      - DevOps                        # DevOps Engineer
      - PM                            # Project Manager
      - Custom: {name: str}

  Capability:
    variants:
      - GenerateSpec
      - GenerateTests
      - ReviewCode
      - GenerateDocs
      - SecurityAudit
      - ArchitectureDesign
      - Refactor
      - Debug
      - Explain
      - Translate

  # Agent Instance
  Agent:
    persona: Persona
    context: AgentContext
    memory: AgentMemory
    state: AgentState

  AgentContext:
    task: str
    specs: [str]
    history: [Message]
    constraints: [str]

  AgentMemory:
    short_term: [MemoryItem]
    long_term_ref: str?               # Reference to vector DB

  MemoryItem:
    content: str
    importance: float
    timestamp: int

  AgentState:
    variants:
      - Idle
      - Thinking
      - Working
      - WaitingForInput
      - WaitingForApproval
      - Done
      - Error: {message: str}

  # Task
  Task:
    id: str
    description: str
    assigned_agents: [str]
    priority: Priority
    deadline: int?
    dependencies: [str]
    status: TaskStatus

  Priority:
    variants:
      - Low
      - Medium
      - High
      - Critical

  TaskStatus:
    variants:
      - Pending
      - InProgress
      - Review
      - Done
      - Blocked

  # Collaboration
  Collaboration:
    id: str
    task: Task
    agents: [Agent]
    messages: [CollabMessage]
    artifacts: [Artifact]
    status: CollabStatus

  CollabMessage:
    from_agent: str
    to_agent: str?                    # null = broadcast
    content: str
    timestamp: int
    type: MessageType

  MessageType:
    variants:
      - Request
      - Response
      - Feedback
      - Approval
      - Rejection
      - Question
      - Answer

  Artifact:
    id: str
    type: ArtifactType
    content: str
    created_by: str
    version: int

  ArtifactType:
    variants:
      - Spec
      - Test
      - Doc
      - Review
      - Report

  CollabStatus:
    variants:
      - Active
      - Completed
      - Failed
      - Cancelled

  # Review
  Review:
    spec: str
    reviewer: str
    status: ReviewStatus
    comments: [ReviewComment]
    approved: bool

  ReviewStatus:
    variants:
      - Pending
      - InProgress
      - Approved
      - ChangesRequested
      - Rejected

  ReviewComment:
    line: int?
    severity: Severity
    message: str
    suggestion: str?

  Severity:
    variants:
      - Info
      - Warning
      - Error
      - Critical

functions:
  # Persona management
  - name: persona_get
    params: {role: AgentRole}
    returns: Persona
    description: Get persona by role

  - name: persona_create
    params: {persona: Persona}
    returns: bool
    description: Create custom persona

  - name: persona_list
    params: {}
    returns: [Persona]
    description: List all personas

  # Agent lifecycle
  - name: agent_create
    params: {persona: Persona, context: AgentContext}
    returns: Agent
    description: Create agent instance

  - name: agent_run
    params: {agent: Agent, task: str}
    returns: str
    description: Run agent on task

  - name: agent_stop
    params: {agent: Agent}
    returns: bool
    description: Stop agent

  # Collaboration
  - name: collab_start
    params: {task: Task, agents: [str]}
    returns: Collaboration
    description: Start collaboration

  - name: collab_message
    params: {collab: Collaboration, message: CollabMessage}
    returns: bool
    description: Send message in collaboration

  - name: collab_complete
    params: {collab: Collaboration}
    returns: [Artifact]
    description: Complete collaboration and get artifacts

  # Specific agent actions
  - name: swe_generate
    params: {task: str, context: str?}
    returns: str
    description: SWE agent generates spec

  - name: test_generate
    params: {spec: str}
    returns: str
    description: Test agent generates tests

  - name: review_spec
    params: {spec: str}
    returns: Review
    description: Review agent reviews spec

  - name: doc_generate
    params: {spec: str}
    returns: str
    description: Doc agent generates documentation

  - name: security_audit
    params: {spec: str}
    returns: [ReviewComment]
    description: Security agent audits spec

imports:
  - kernel.agent.llm_client
  - kernel.agent.semantic_memory

personas_definitions: |
  # Built-in Personas
  
  ## SWE Agent (Software Engineer)
  ```yaml
  id: "swe"
  name: "Software Engineer"
  role: SWE
  system_prompt: |
    You are an expert Vibee software engineer.
    Your job is to write high-quality Vibee specifications.
    
    Rules:
    1. Always use Given/When/Then for behaviors
    2. Include at least 2 test cases per behavior
    3. Define proper types
    4. Handle errors explicitly
    5. Follow Vibee best practices
    
    Output only valid Vibee YAML.
  capabilities: [GenerateSpec, Refactor, Debug]
  tools: [file_read, file_write, search]
  temperature: 0.7
  ```
  
  ## Test Agent
  ```yaml
  id: "test"
  name: "Test Engineer"
  role: Test
  system_prompt: |
    You are an expert test engineer.
    Your job is to write comprehensive test cases.
    
    Include:
    1. Happy path tests
    2. Edge cases (empty, null, boundary)
    3. Error cases
    4. Integration tests
    
    Aim for 100% behavior coverage.
  capabilities: [GenerateTests]
  tools: [file_read, test_run]
  temperature: 0.3
  ```
  
  ## Review Agent
  ```yaml
  id: "review"
  name: "Code Reviewer"
  role: Review
  system_prompt: |
    You are a senior code reviewer.
    Review Vibee specifications for:
    
    1. Correctness - Does it do what it should?
    2. Completeness - Are all cases handled?
    3. Clarity - Is it easy to understand?
    4. Best practices - Does it follow conventions?
    
    Be constructive. Suggest improvements.
  capabilities: [ReviewCode]
  tools: [file_read]
  temperature: 0.5
  ```
  
  ## Security Agent
  ```yaml
  id: "security"
  name: "Security Auditor"
  role: Security
  system_prompt: |
    You are a security expert.
    Audit Vibee specifications for:
    
    1. Authentication/Authorization issues
    2. Input validation
    3. Injection vulnerabilities
    4. Secrets exposure
    5. Data leakage
    
    Report all findings with severity.
  capabilities: [SecurityAudit]
  tools: [file_read, search]
  temperature: 0.2
  ```
  
  ## Doc Agent
  ```yaml
  id: "doc"
  name: "Documentation Writer"
  role: Doc
  system_prompt: |
    You are a technical writer.
    Generate clear documentation including:
    
    1. Overview
    2. Getting started
    3. API reference
    4. Examples
    5. FAQ
    
    Write for developers. Be concise.
  capabilities: [GenerateDocs]
  tools: [file_read]
  temperature: 0.6
  ```

collaboration_example: |
  # Collaboration Example
  
  Task: "Create a user authentication API"
  
  ```
  ┌─────────────────────────────────────────────────────────────┐
  │                    COLLABORATION                             │
  └─────────────────────────────────────────────────────────────┘
  
  1. PM Agent: Breaks down task into subtasks
     └─> [Design API, Implement, Test, Review, Document]
  
  2. Architect Agent: Designs API structure
     └─> auth_api_design.vibee
  
  3. SWE Agent: Implements specification
     └─> auth_api.vibee
  
  4. Test Agent: Generates tests
     └─> auth_api_test.vibee
  
  5. Security Agent: Audits for vulnerabilities
     └─> security_report.md
  
  6. Review Agent: Reviews all artifacts
     └─> Approved with minor suggestions
  
  7. Doc Agent: Generates documentation
     └─> auth_api_docs.md
  
  Result: Complete, tested, reviewed, documented API
  ```
