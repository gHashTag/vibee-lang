name: vibee_os_capability
version: "0.1.0"
language: zig
module: kernel/security/capability
description: Capability-based Security — система безопасности на основе capabilities

behaviors:
  - name: create_capability
    given: Процесс имеет право создавать capabilities
    when: Вызывается cap_create для ресурса
    then: Создаётся новая capability с указанными правами
    test_cases:
      - name: create_file_cap
        input: {resource_type: "file", resource_id: "/home/user/file.txt", rights: ["read"]}
        expected: {success: true, cap_id: 1}
      - name: create_without_permission
        input: {resource_type: "file", resource_id: "/etc/passwd", rights: ["write"], has_permission: false}
        expected: {success: false, error: "permission_denied"}

  - name: derive_capability
    given: Процесс имеет capability с определёнными правами
    when: Вызывается cap_derive с уменьшенными правами
    then: Создаётся новая capability с подмножеством прав
    test_cases:
      - name: derive_read_only
        input: {parent_cap: 1, parent_rights: ["read", "write"], new_rights: ["read"]}
        expected: {success: true, cap_id: 2}
      - name: derive_more_rights
        input: {parent_cap: 1, parent_rights: ["read"], new_rights: ["read", "write"]}
        expected: {success: false, error: "cannot_escalate"}

  - name: revoke_capability
    given: Процесс владеет capability
    when: Вызывается cap_revoke
    then: Capability и все производные от неё отзываются
    test_cases:
      - name: revoke_single
        input: {cap_id: 1}
        expected: {revoked: true, derived_revoked: 0}
      - name: revoke_with_derived
        input: {cap_id: 1, derived_count: 3}
        expected: {revoked: true, derived_revoked: 3}

  - name: check_capability
    given: Процесс пытается выполнить операцию
    when: Вызывается cap_check с capability и требуемым правом
    then: Возвращается разрешение или отказ
    test_cases:
      - name: check_allowed
        input: {cap_id: 1, cap_rights: ["read", "write"], required: "read"}
        expected: {allowed: true}
      - name: check_denied
        input: {cap_id: 1, cap_rights: ["read"], required: "write"}
        expected: {allowed: false}
      - name: check_revoked
        input: {cap_id: 1, revoked: true, required: "read"}
        expected: {allowed: false, error: "capability_revoked"}

  - name: transfer_capability
    given: Процесс хочет передать capability другому процессу
    when: Вызывается cap_transfer
    then: Capability передаётся если есть право Grant
    test_cases:
      - name: transfer_with_grant
        input: {cap_id: 1, rights: ["read", "grant"], to_pid: 5}
        expected: {success: true, new_cap_id: 3}
      - name: transfer_without_grant
        input: {cap_id: 1, rights: ["read"], to_pid: 5}
        expected: {success: false, error: "no_grant_right"}

types:
  Capability:
    id: int
    resource: Resource
    rights: [Right]
    owner_pid: int
    parent_id: int?
    created_at: int
    revoked: bool

  Resource:
    type: ResourceType
    id: str
    metadata: {str: str}?

  ResourceType:
    variants:
      - File
      - Directory
      - Process
      - Thread
      - Channel
      - Socket
      - Memory
      - Device
      - Scheme

  Right:
    variants:
      - Read
      - Write
      - Execute
      - Create
      - Delete
      - Grant
      - Revoke
      - Derive

  CapabilitySpace:
    process_id: int
    capabilities: [Capability]
    root_cap: Capability?

  CapError:
    variants:
      - NotFound
      - PermissionDenied
      - CannotEscalate
      - AlreadyRevoked
      - InvalidResource
      - NoGrantRight

  CapResult:
    success: bool
    cap_id: int?
    error: CapError?

  AccessCheck:
    allowed: bool
    capability: Capability?
    reason: str?

functions:
  # Создание и управление
  - name: cap_create
    params: {resource: Resource, rights: [Right]}
    returns: CapResult
    description: Создание новой capability

  - name: cap_derive
    params: {parent_id: int, rights: [Right]}
    returns: CapResult
    description: Создание производной capability с уменьшенными правами

  - name: cap_revoke
    params: {cap_id: int}
    returns: int
    description: Отзыв capability и всех производных, возвращает количество отозванных

  - name: cap_revoke_all
    params: {resource: Resource}
    returns: int
    description: Отзыв всех capabilities для ресурса

  # Проверка доступа
  - name: cap_check
    params: {cap_id: int, required: Right}
    returns: AccessCheck
    description: Проверка права доступа

  - name: cap_check_any
    params: {cap_ids: [int], required: Right}
    returns: AccessCheck
    description: Проверка права в любой из capabilities

  - name: cap_has_right
    params: {cap_id: int, right: Right}
    returns: bool
    description: Быстрая проверка наличия права

  # Передача
  - name: cap_transfer
    params: {cap_id: int, to_pid: int}
    returns: CapResult
    description: Передача capability другому процессу

  - name: cap_copy
    params: {cap_id: int}
    returns: CapResult
    description: Копирование capability (требует Grant)

  # Информация
  - name: cap_info
    params: {cap_id: int}
    returns: Capability?
    description: Информация о capability

  - name: cap_list
    params: {pid: int}
    returns: [Capability]
    description: Список capabilities процесса

  - name: cap_list_for_resource
    params: {resource: Resource}
    returns: [Capability]
    description: Список capabilities для ресурса

  # Capability Space
  - name: capspace_create
    params: {pid: int}
    returns: CapabilitySpace
    description: Создание capability space для процесса

  - name: capspace_destroy
    params: {pid: int}
    returns: void
    description: Уничтожение capability space (отзыв всех capabilities)

  - name: capspace_fork
    params: {parent_pid: int, child_pid: int}
    returns: CapabilitySpace
    description: Копирование capability space при fork

imports:
  - kernel.process

security_model: |
  Модель безопасности VIBEE OS:
  
  1. ПРИНЦИП МИНИМАЛЬНЫХ ПРИВИЛЕГИЙ
     Процесс получает только те права, которые ему необходимы.
     
  2. НЕТ AMBIENT AUTHORITY
     Нет глобальных прав. Всё через capabilities.
     
  3. ИЕРАРХИЯ CAPABILITIES
     Производные capabilities не могут иметь больше прав чем родительские.
     
  4. ОТЗЫВ КАСКАДОМ
     Отзыв capability отзывает все производные.
     
  5. АУДИТ
     Все операции с capabilities логируются.
  
  Пример использования:
  
  ```
  # Процесс A создаёт файл
  cap1 = cap_create(File("/data/secret.txt"), [Read, Write, Grant])
  
  # Процесс A передаёт read-only доступ процессу B
  cap2 = cap_derive(cap1, [Read])
  cap_transfer(cap2, pid_B)
  
  # Процесс B может читать, но не писать
  cap_check(cap2, Read)   # -> allowed
  cap_check(cap2, Write)  # -> denied
  
  # Процесс A отзывает доступ
  cap_revoke(cap1)  # cap2 тоже отзывается
  ```
