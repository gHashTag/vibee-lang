name: vibee_os_compiler
version: "0.1.0"
language: zig
module: kernel/vibee/compiler
description: Vibee Compiler Integration - runtime parsing, validation, and code generation from specifications

behaviors:
  - name: parse_specification
    given: A .vibee specification file content is provided
    when: vibee_parse is called
    then: Specification is parsed into AST
    test_cases:
      - name: parse_valid_spec
        input: {content: "name: hello\nversion: \"1.0.0\"\nlanguage: zig\nbehaviors:\n  - name: greet"}
        expected: {success: true, ast_type: "Specification", behaviors_count: 1}
      - name: parse_invalid_yaml
        input: {content: "invalid: yaml: content:"}
        expected: {success: false, error: "yaml_parse_error"}
      - name: parse_missing_required
        input: {content: "name: hello"}
        expected: {success: false, error: "missing_required_field", field: "version"}

  - name: validate_specification
    given: AST is parsed from specification
    when: vibee_validate is called
    then: Specification is validated against Vibee language rules
    test_cases:
      - name: validate_complete_spec
        input: {ast: "...", has_behaviors: true, has_tests: true}
        expected: {valid: true, warnings: []}
      - name: validate_missing_tests
        input: {ast: "...", has_behaviors: true, has_tests: false}
        expected: {valid: false, error: "behavior_without_tests", behavior: "greet"}
      - name: validate_type_error
        input: {ast: "...", function_returns: "UnknownType"}
        expected: {valid: false, error: "unknown_type", type: "UnknownType"}

  - name: generate_code
    given: Valid AST is available
    when: vibee_generate is called with target language
    then: Code is generated for the target language
    test_cases:
      - name: generate_zig
        input: {ast: "...", target: "zig"}
        expected: {success: true, code_length: 500, has_tests: true}
      - name: generate_wasm
        input: {ast: "...", target: "wasm"}
        expected: {success: true, code_length: 300}
      - name: generate_unsupported
        input: {ast: "...", target: "cobol"}
        expected: {success: false, error: "unsupported_target"}

  - name: run_tests
    given: Generated code with test cases
    when: vibee_test is called
    then: All test cases are executed and results reported
    test_cases:
      - name: all_tests_pass
        input: {spec: "...", test_count: 5}
        expected: {success: true, passed: 5, failed: 0}
      - name: some_tests_fail
        input: {spec: "...", test_count: 5, failing_tests: 2}
        expected: {success: false, passed: 3, failed: 2}

  - name: enforce_no_manual_code
    given: Code file is being created or modified
    when: vibee_guard is called
    then: Manual code is rejected, only generated code allowed
    test_cases:
      - name: allow_generated
        input: {file: "hello.zig", has_generated_header: true}
        expected: {allowed: true}
      - name: reject_manual
        input: {file: "hello.zig", has_generated_header: false}
        expected: {allowed: false, error: "manual_code_not_allowed"}
      - name: allow_spec
        input: {file: "hello.vibee"}
        expected: {allowed: true}

types:
  Specification:
    name: str
    version: str
    language: TargetLanguage
    module: str
    description: str?
    behaviors: [Behavior]
    types: [TypeDef]
    functions: [FunctionSig]
    imports: [str]

  Behavior:
    name: str
    given: str
    when: str
    then: str
    test_cases: [TestCase]

  TestCase:
    name: str
    input: {str: str}
    expected: {str: str}

  TypeDef:
    name: str
    kind: TypeKind
    fields: [Field]?
    variants: [str]?

  TypeKind:
    variants:
      - Record
      - Enum
      - Alias

  Field:
    name: str
    type: str
    optional: bool

  FunctionSig:
    name: str
    params: [Param]
    returns: str
    description: str?
    effects: [Effect]?

  Param:
    name: str
    type: str

  Effect:
    variants:
      - IO
      - State
      - Error
      - Async

  TargetLanguage:
    variants:
      - Zig
      - Rust
      - Go
      - Python
      - TypeScript
      - WASM
      - Gleam

  AST:
    spec: Specification
    source_map: SourceMap
    errors: [ParseError]
    warnings: [Warning]

  SourceMap:
    file: str
    lines: [LineInfo]

  LineInfo:
    line: int
    column: int
    node_type: str

  ParseError:
    message: str
    line: int
    column: int
    severity: Severity

  Warning:
    message: str
    line: int
    code: str

  Severity:
    variants:
      - Error
      - Warning
      - Info

  ValidationResult:
    valid: bool
    errors: [ValidationError]
    warnings: [Warning]

  ValidationError:
    code: str
    message: str
    location: str?

  GeneratedCode:
    target: TargetLanguage
    code: str
    tests: str
    source_map: SourceMap

  TestResult:
    total: int
    passed: int
    failed: int
    skipped: int
    duration_ms: int
    failures: [TestFailure]

  TestFailure:
    test_name: str
    behavior: str
    expected: str
    actual: str
    error: str?

  GuardResult:
    allowed: bool
    reason: str?
    suggestion: str?

functions:
  # Parsing
  - name: vibee_parse
    params: {content: str, filename: str?}
    returns: AST
    description: Parse Vibee specification into AST

  - name: vibee_parse_file
    params: {path: str}
    returns: AST
    description: Parse Vibee file from path

  # Validation
  - name: vibee_validate
    params: {ast: AST}
    returns: ValidationResult
    description: Validate AST against Vibee rules

  - name: vibee_check_types
    params: {ast: AST}
    returns: ValidationResult
    description: Type check the specification

  # Code Generation
  - name: vibee_generate
    params: {ast: AST, target: TargetLanguage}
    returns: GeneratedCode
    description: Generate code for target language

  - name: vibee_generate_all
    params: {ast: AST, targets: [TargetLanguage]}
    returns: [GeneratedCode]
    description: Generate code for multiple targets

  # Testing
  - name: vibee_test
    params: {ast: AST, target: TargetLanguage}
    returns: TestResult
    description: Run all test cases

  - name: vibee_test_behavior
    params: {ast: AST, behavior_name: str, target: TargetLanguage}
    returns: TestResult
    description: Run tests for specific behavior

  # Guard
  - name: vibee_guard
    params: {file_path: str, content: str}
    returns: GuardResult
    description: Check if file modification is allowed

  - name: vibee_is_generated
    params: {content: str}
    returns: bool
    description: Check if code has generated header

  # Utilities
  - name: vibee_format
    params: {content: str}
    returns: str
    description: Format Vibee specification

  - name: vibee_lint
    params: {ast: AST}
    returns: [Warning]
    description: Lint specification for best practices

imports:
  - kernel.agent.core

generated_header: |
  All generated code MUST have this header:
  
  // ============================================
  // GENERATED BY VIBEE OS - DO NOT EDIT
  // Source: {source_file}
  // Generated: {timestamp}
  // Target: {target_language}
  // ============================================
  
  Any file without this header is considered manual code
  and will be REJECTED by the guard system.

vibee_compliance: |
  VIBEE OS Compiler Compliance:
  
  1. SPECIFICATION PRIMACY
     - All code MUST come from .vibee specifications
     - Manual code is REJECTED at compile time
     - Guard system enforces this rule
  
  2. BEHAVIORAL SEMANTICS
     - Every behavior MUST have Given/When/Then
     - Every behavior MUST have at least one test case
     - Tests are generated alongside code
  
  3. COMPILER ENFORCEMENT
     - Generated files have special header
     - Files without header are rejected
     - Modifications to generated files are rejected
  
  4. MULTI-TARGET
     - Same spec generates code for all targets
     - Semantic equivalence across targets
     - Tests run on all targets
