name: vibee_os_bootstrap
version: "0.1.0"
language: gleam
module: kernel/vibee/bootstrap
description: Bootstrap - интеграция всех компонентов Vibee OS для самозагрузки

behaviors:
  - name: bootstrap_system
    given: Vibee OS source files exist
    when: bootstrap is initiated
    then: System compiles itself and becomes operational
    test_cases:
      - name: full_bootstrap
        input:
          source_dir: "./vibee_os"
          target: "gleam"
        expected:
          compiled: true
          tests_passed: true
          cli_available: true
      - name: bootstrap_with_llm
        input:
          source_dir: "./vibee_os"
          llm_enabled: true
          api_key_set: true
        expected:
          compiled: true
          llm_client_working: true
          chat_available: true

  - name: compile_all_specs
    given: Directory with .vibee files
    when: compile_all is called
    then: All specs are compiled to target language
    test_cases:
      - name: compile_vibee_os
        input:
          dir: "./vibee_os"
          target: "gleam"
        expected:
          files_compiled: 54
          errors: 0
      - name: compile_with_errors
        input:
          dir: "./invalid"
          has_errors: true
        expected:
          files_compiled: 0
          errors: 3

  - name: run_all_tests
    given: Compiled Vibee OS
    when: test_all is called
    then: All test_cases across all specs are executed
    test_cases:
      - name: test_vibee_os
        input:
          dir: "./vibee_os"
        expected:
          total_tests: 500
          pass_rate: 1.0
      - name: test_with_failures
        input:
          dir: "./vibee_os"
          inject_failures: true
        expected:
          total_tests: 500
          pass_rate: 0.95

  - name: self_host
    given: Vibee compiler is compiled
    when: Compiler compiles itself
    then: New compiler is identical to original
    test_cases:
      - name: self_host_success
        input:
          compiler_spec: "kernel/vibee/compiler.vibee"
        expected:
          self_hosted: true
          output_matches: true

  - name: llm_integration_test
    given: LLM client is configured
    when: Integration test runs
    then: LLM responds correctly
    test_cases:
      - name: deepseek_ping
        input:
          provider: "deepseek"
          message: "Say 'pong'"
        expected:
          response_contains: "pong"
          tokens_used: true
      - name: generate_spec_test
        input:
          prompt: "Create a hello world spec"
        expected:
          valid_yaml: true
          has_behaviors: true

types:
  # Bootstrap Configuration
  BootstrapConfig:
    source_dir: str
    output_dir: str
    target: TargetLanguage
    llm_enabled: bool
    test_enabled: bool
    verbose: bool

  TargetLanguage:
    variants:
      - Gleam
      - Zig
      - Rust

  # Bootstrap Result
  BootstrapResult:
    success: bool
    phases: [PhaseResult]
    total_duration_ms: int
    errors: [str]
    warnings: [str]

  PhaseResult:
    phase: BootstrapPhase
    success: bool
    duration_ms: int
    output: str?
    error: str?

  BootstrapPhase:
    variants:
      - Parse                         # Parse all .vibee files
      - Validate                      # Validate specs
      - Compile                       # Generate code
      - Build                         # Build generated code
      - Test                          # Run tests
      - Package                       # Create distributable
      - SelfHost                      # Compile compiler with itself

  # Compilation Stats
  CompilationStats:
    files_parsed: int
    files_compiled: int
    behaviors_total: int
    types_total: int
    functions_total: int
    tests_total: int
    lines_generated: int
    duration_ms: int

  # Integration Test
  IntegrationTest:
    name: str
    components: [str]
    setup: str?
    test: str
    teardown: str?
    timeout_ms: int

  IntegrationResult:
    test: str
    passed: bool
    output: str?
    error: str?
    duration_ms: int

functions:
  # Bootstrap
  - name: bootstrap
    params: {config: BootstrapConfig}
    returns: BootstrapResult
    description: Full system bootstrap

  - name: bootstrap_phase
    params: {phase: BootstrapPhase, config: BootstrapConfig}
    returns: PhaseResult
    description: Run single bootstrap phase

  # Compilation
  - name: compile_all
    params: {dir: str, target: TargetLanguage}
    returns: CompilationStats
    description: Compile all specs in directory

  - name: compile_spec
    params: {path: str, target: TargetLanguage}
    returns: str
    description: Compile single spec, returns generated code

  # Testing
  - name: test_all
    params: {dir: str}
    returns: SuiteResult
    description: Run all tests in directory

  - name: test_spec
    params: {path: str}
    returns: SpecResult
    description: Run tests for single spec

  # Self-hosting
  - name: self_host
    params: {compiler_path: str}
    returns: bool
    description: Compile compiler with itself

  - name: verify_self_host
    params: {original: str, generated: str}
    returns: bool
    description: Verify self-hosted output matches

  # Integration
  - name: integration_test
    params: {test: IntegrationTest}
    returns: IntegrationResult
    description: Run integration test

  - name: integration_suite
    params: {tests: [IntegrationTest]}
    returns: [IntegrationResult]
    description: Run integration test suite

  # LLM Integration
  - name: test_llm_connection
    params: {}
    returns: bool
    description: Test LLM API connection

  - name: test_llm_generation
    params: {prompt: str}
    returns: {valid: bool, spec: str?}
    description: Test spec generation via LLM

imports:
  - kernel.vibee.compiler
  - kernel.vibee.verifier
  - kernel.vibee.test_runner
  - kernel.agent.llm_client
  - shell.vibee_cli

bootstrap_sequence: |
  # Bootstrap Sequence
  
  ```
  ┌─────────────────────────────────────────────────────────────┐
  │                    VIBEE OS BOOTSTRAP                        │
  └─────────────────────────────────────────────────────────────┘
  
  Phase 1: PARSE
  ├── Find all .vibee files
  ├── Parse YAML to AST
  └── Build dependency graph
  
  Phase 2: VALIDATE
  ├── Type check all specs
  ├── Verify imports exist
  └── Check for cycles
  
  Phase 3: COMPILE
  ├── Generate Gleam/Zig code
  ├── Generate test code
  └── Write output files
  
  Phase 4: BUILD
  ├── Run gleam build / zig build
  ├── Link dependencies
  └── Create executable
  
  Phase 5: TEST
  ├── Run all test_cases
  ├── Generate coverage report
  └── Fail if tests fail
  
  Phase 6: SELF-HOST (optional)
  ├── Compile compiler.vibee with new compiler
  ├── Verify output matches
  └── Replace bootstrap compiler
  
  Phase 7: PACKAGE
  ├── Create release archive
  ├── Generate documentation
  └── Publish
  ```

self_hosting_proof: |
  # Self-Hosting Proof
  
  The ultimate test of Vibee: can it compile itself?
  
  ```
  compiler.vibee ──[vibeec v1]──> compiler.gleam ──[gleam]──> vibeec v2
  
  compiler.vibee ──[vibeec v2]──> compiler.gleam' 
  
  Assert: compiler.gleam == compiler.gleam'
  ```
  
  If the outputs match, the compiler is self-hosting.
  
  This proves:
  1. The spec is complete (describes full compiler)
  2. The compiler is correct (generates valid code)
  3. The system is stable (no drift between versions)

integration_tests: |
  # Integration Tests
  
  ## 1. Parse → Compile → Run
  ```yaml
  test: parse_compile_run
  components: [parser, compiler, runtime]
  steps:
    - parse: "hello.vibee"
    - compile: {target: gleam}
    - run: {expect_output: "Hello, World!"}
  ```
  
  ## 2. LLM → Generate → Test
  ```yaml
  test: llm_generate_test
  components: [llm_client, compiler, test_runner]
  steps:
    - llm_generate: "Create a calculator"
    - validate: {expect_valid: true}
    - test: {expect_pass: true}
  ```
  
  ## 3. Full CLI Flow
  ```yaml
  test: cli_full_flow
  components: [cli, compiler, test_runner]
  steps:
    - cli: ["vibee", "init", "test_project"]
    - cli: ["vibee", "gen", "test_project.vibee"]
    - cli: ["vibee", "test", "test_project.vibee"]
    - assert: {exit_code: 0}
  ```
