name: vibee_os_natural_language
version: "0.1.0"
language: gleam
module: kernel/vibee/natural_language
description: Natural Language Interface - преобразование естественного языка в Vibee спецификации через LLM

behaviors:
  - name: english_to_vibee
    given: User describes system in English
    when: nl_to_spec is called
    then: Vibee specification is generated
    test_cases:
      - name: simple_api
        input: {text: "Create a REST API for managing users with CRUD operations"}
        expected: {behaviors: 4, types: 1, functions: 4}
      - name: complex_system
        input: {text: "Build a real-time chat system with rooms, messages, and user presence"}
        expected: {behaviors: 10, types: 5, has_websocket: true}

  - name: russian_to_vibee
    given: User describes system in Russian
    when: nl_to_spec is called with lang=ru
    then: Vibee specification is generated
    test_cases:
      - name: simple_api_ru
        input: {text: "Создай REST API для управления пользователями с CRUD операциями", lang: "ru"}
        expected: {behaviors: 4, types: 1, functions: 4}

  - name: conversation_to_spec
    given: User has multi-turn conversation
    when: Conversation ends with "generate spec"
    then: Complete specification from conversation context
    test_cases:
      - name: iterative_design
        input: {messages: ["I need a todo app", "Add due dates", "Add priorities", "generate spec"]}
        expected: {has_due_dates: true, has_priorities: true}

  - name: spec_from_example
    given: User provides example input/output
    when: nl_from_example is called
    then: Behavior is inferred from examples
    test_cases:
      - name: infer_calculator
        input: {examples: [{"2 + 2": "4"}, {"10 / 2": "5"}]}
        expected: {behavior: "calculate", inferred_operations: ["add", "divide"]}

  - name: clarification_when_ambiguous
    given: User description is ambiguous
    when: Ambiguity detected
    then: System asks clarifying questions
    test_cases:
      - name: ambiguous_auth
        input: {text: "Add authentication"}
        expected: {needs_clarification: true, questions: ["OAuth, JWT, or session-based?"]}

  - name: incremental_refinement
    given: Initial spec is generated
    when: User provides feedback
    then: Spec is refined based on feedback
    test_cases:
      - name: add_validation
        input: {spec: "user_api.vibee", feedback: "Add email validation"}
        expected: {validation_added: true, test_cases_updated: true}

types:
  # Natural Language Input
  NLInput:
    text: str
    language: Language
    context: NLContext?
    examples: [Example]?
    constraints: [str]?

  Language:
    variants:
      - English
      - Russian
      - Spanish
      - Chinese
      - Japanese
      - German
      - French
      - Auto                          # Auto-detect

  NLContext:
    conversation: [Message]
    existing_specs: [str]
    domain: str?
    style: SpecStyle?

  Message:
    role: Role
    content: str
    timestamp: int

  Role:
    variants:
      - User
      - Assistant
      - System

  Example:
    input: str
    output: str
    description: str?

  SpecStyle:
    variants:
      - Minimal                       # Just behaviors
      - Standard                      # Behaviors + types
      - Comprehensive                 # Full with tests
      - Enterprise                    # With security, logging

  # Generation Result
  NLResult:
    success: bool
    spec: Specification?
    clarifications: [Clarification]?
    confidence: float
    explanation: str
    alternatives: [Specification]?

  Clarification:
    question: str
    options: [str]?
    default: str?
    required: bool

  # Intent Recognition
  Intent:
    type: IntentType
    entities: [Entity]
    confidence: float

  IntentType:
    variants:
      - CreateAPI
      - CreateUI
      - CreateService
      - CreateDatabase
      - ModifySpec
      - AddBehavior
      - AddType
      - AddTest
      - Explain
      - Refactor
      - Optimize

  Entity:
    type: EntityType
    value: str
    start: int
    end: int
    confidence: float

  EntityType:
    variants:
      - ResourceName                  # "users", "products"
      - Operation                     # "create", "delete"
      - DataType                      # "string", "integer"
      - Constraint                    # "required", "unique"
      - Relationship                  # "has many", "belongs to"
      - Technology                    # "REST", "GraphQL", "WebSocket"
      - AuthMethod                    # "JWT", "OAuth"

  # Conversation State
  ConversationState:
    id: str
    messages: [Message]
    current_spec: Specification?
    pending_clarifications: [Clarification]
    entities_extracted: [Entity]
    phase: ConversationPhase

  ConversationPhase:
    variants:
      - Gathering                     # Collecting requirements
      - Clarifying                    # Asking questions
      - Generating                    # Creating spec
      - Refining                      # Iterating on spec
      - Complete                      # Done

  # LLM Prompts
  NLPrompt:
    system: str
    user: str
    examples: [PromptExample]
    output_format: str

  PromptExample:
    input: str
    output: str

  # Validation
  NLValidation:
    is_valid: bool
    issues: [ValidationIssue]
    suggestions: [str]

  ValidationIssue:
    type: IssueType
    message: str
    location: str?

  IssueType:
    variants:
      - Ambiguous
      - Incomplete
      - Contradictory
      - TooComplex
      - Unsupported

functions:
  # Main conversion
  - name: nl_to_spec
    params: {input: NLInput}
    returns: NLResult
    description: Convert natural language to Vibee spec

  - name: nl_to_behavior
    params: {text: str}
    returns: Behavior
    description: Convert description to single behavior

  - name: nl_to_type
    params: {text: str}
    returns: TypeDef
    description: Convert description to type definition

  # Conversation
  - name: conversation_start
    params: {initial_message: str}
    returns: ConversationState
    description: Start new conversation

  - name: conversation_continue
    params: {state: ConversationState, message: str}
    returns: ConversationState
    description: Continue conversation

  - name: conversation_generate
    params: {state: ConversationState}
    returns: NLResult
    description: Generate spec from conversation

  # Intent recognition
  - name: recognize_intent
    params: {text: str}
    returns: Intent
    description: Recognize user intent

  - name: extract_entities
    params: {text: str}
    returns: [Entity]
    description: Extract entities from text

  # Clarification
  - name: detect_ambiguity
    params: {text: str}
    returns: [Clarification]
    description: Detect ambiguities needing clarification

  - name: apply_clarification
    params: {state: ConversationState, answers: {str: str}}
    returns: ConversationState
    description: Apply clarification answers

  # Refinement
  - name: refine_spec
    params: {spec: Specification, feedback: str}
    returns: NLResult
    description: Refine spec based on feedback

  - name: explain_spec
    params: {spec: Specification, language: Language}
    returns: str
    description: Explain spec in natural language

  # Examples
  - name: infer_from_examples
    params: {examples: [Example]}
    returns: NLResult
    description: Infer spec from input/output examples

  # Validation
  - name: validate_nl_input
    params: {input: NLInput}
    returns: NLValidation
    description: Validate natural language input

imports:
  - kernel.vibee.compiler
  - kernel.agent.llm_backend
  - config.llm_providers

nl_prompts: |
  # LLM Prompts for Natural Language → Vibee
  
  ## System Prompt
  ```
  You are a Vibee specification expert. Convert natural language descriptions 
  into valid Vibee YAML specifications.
  
  Vibee specs have:
  - behaviors: Given/When/Then with test_cases
  - types: Data structures with variants
  - functions: Function signatures
  
  Always include:
  1. At least 2 test cases per behavior
  2. Edge cases and error handling
  3. Proper type definitions
  
  Output ONLY valid YAML, no explanations.
  ```
  
  ## User Prompt Template
  ```
  Convert this description to a Vibee specification:
  
  {user_description}
  
  Requirements:
  - Language: {target_language}
  - Style: {spec_style}
  - Include tests: yes
  
  Context:
  {context}
  ```
  
  ## Few-Shot Examples
  
  Input: "Create a calculator that can add and subtract"
  Output:
  ```yaml
  name: calculator
  version: "1.0.0"
  
  behaviors:
    - name: add_numbers
      given: Two numbers a and b
      when: add(a, b) is called
      then: Returns sum of a and b
      test_cases:
        - name: add_positive
          input: {a: 2, b: 3}
          expected: {result: 5}
        - name: add_negative
          input: {a: -1, b: 1}
          expected: {result: 0}
  
    - name: subtract_numbers
      given: Two numbers a and b
      when: subtract(a, b) is called
      then: Returns difference of a and b
      test_cases:
        - name: subtract_positive
          input: {a: 5, b: 3}
          expected: {result: 2}
  ```

conversation_example: |
  # Conversation Example
  
  User: I need a todo app
  
  Assistant: I'll help you create a todo app. Let me ask a few questions:
  1. Should todos have due dates?
  2. Do you need priorities (high/medium/low)?
  3. Should todos be organized in lists/projects?
  
  User: Yes to due dates and priorities, no lists for now
  
  Assistant: Got it. Should I add:
  - Recurring todos?
  - Reminders/notifications?
  - Tags/labels?
  
  User: Just tags, keep it simple
  
  Assistant: Perfect. Here's your specification:
  
  ```yaml
  name: todo_app
  version: "1.0.0"
  
  types:
    Todo:
      id: str
      title: str
      description: str?
      due_date: int?
      priority: Priority
      tags: [str]
      completed: bool
      created_at: int
  
    Priority:
      variants:
        - High
        - Medium
        - Low
  
  behaviors:
    - name: create_todo
      given: Valid todo data
      when: todo_create is called
      then: Todo is created with generated id
      test_cases:
        - name: create_simple
          input: {title: "Buy milk"}
          expected: {success: true, has_id: true}
        - name: create_with_priority
          input: {title: "Urgent task", priority: "High"}
          expected: {success: true, priority: "High"}
  
    - name: complete_todo
      given: Todo exists and is not completed
      when: todo_complete(id) is called
      then: Todo is marked as completed
      ...
  ```
  
  Would you like me to add anything else?

multilingual_support: |
  # Multilingual Support
  
  ## Russian Example
  
  Input: "Создай API для управления книгами в библиотеке"
  
  Output:
  ```yaml
  name: library_api
  version: "1.0.0"
  description: API для управления книгами в библиотеке
  
  types:
    Book:
      id: str
      title: str
      author: str
      isbn: str
      available: bool
  
  behaviors:
    - name: add_book
      given: Данные книги валидны
      when: book_add вызывается с данными книги
      then: Книга добавляется в библиотеку
      test_cases:
        - name: add_valid_book
          input: {title: "Война и мир", author: "Толстой"}
          expected: {success: true}
  ```
  
  ## Auto-Detection
  
  The system auto-detects language and generates specs with:
  - Behavior names in English (for code compatibility)
  - Descriptions in user's language
  - Test case names in English
