name: vibee_os_virtual_memory
version: "0.1.0"
language: zig
module: kernel/memory/vspace
description: Виртуальная память VIBEE OS — адресные пространства процессов

behaviors:
  - name: create_address_space
    given: Создаётся новый процесс
    when: Вызывается vspace_create
    then: Создаётся новое виртуальное адресное пространство
    test_cases:
      - name: create_user_space
        input: {type: "user"}
        expected: {success: true, base: 0x10000}
      - name: create_kernel_space
        input: {type: "kernel"}
        expected: {success: true, base: 0x0}

  - name: map_memory_region
    given: Процесс запрашивает отображение памяти
    when: Вызывается vspace_map с адресом и размером
    then: Регион отображается в адресное пространство
    test_cases:
      - name: map_code_region
        input: {vaddr: 0x10000, size: 4096, prot: ["read", "execute"]}
        expected: {success: true}
      - name: map_data_region
        input: {vaddr: 0x20000, size: 8192, prot: ["read", "write"]}
        expected: {success: true}

  - name: unmap_memory_region
    given: Процесс освобождает регион памяти
    when: Вызывается vspace_unmap
    then: Регион удаляется из адресного пространства
    test_cases:
      - name: unmap_region
        input: {vaddr: 0x10000, size: 4096}
        expected: {success: true}

types:
  VirtualSpace:
    id: int
    regions: [MemoryRegion]
    page_table_root: int

  MemoryRegion:
    virtual_address: int
    physical_address: int
    size: int
    protection: Protection
    flags: [RegionFlag]

  Protection:
    read: bool
    write: bool
    execute: bool

  RegionFlag:
    variants:
      - User
      - Kernel
      - Shared
      - Private
      - Stack
      - Heap
      - Code
      - Data

  PageFault:
    address: int
    reason: PageFaultReason
    process_id: int

  PageFaultReason:
    variants:
      - NotPresent
      - ProtectionViolation
      - WriteToReadOnly
      - ExecuteNoExecute

functions:
  - name: vspace_create
    params: {is_kernel: bool}
    returns: VirtualSpace
    description: Создание нового адресного пространства

  - name: vspace_destroy
    params: {space: VirtualSpace}
    returns: bool
    description: Уничтожение адресного пространства

  - name: vspace_map
    params: {space: VirtualSpace, vaddr: int, size: int, prot: Protection}
    returns: bool
    description: Отображение региона памяти

  - name: vspace_unmap
    params: {space: VirtualSpace, vaddr: int, size: int}
    returns: bool
    description: Удаление отображения

  - name: vspace_protect
    params: {space: VirtualSpace, vaddr: int, size: int, prot: Protection}
    returns: bool
    description: Изменение защиты региона

  - name: vspace_switch
    params: {space: VirtualSpace}
    returns: void
    description: Переключение на адресное пространство

  - name: handle_page_fault
    params: {fault: PageFault}
    returns: bool
    description: Обработка page fault

imports:
  - kernel.memory.allocator
