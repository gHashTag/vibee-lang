# ============================================================================
# PDF GENERATOR - Генерация PDF на Vibee
# ============================================================================
# Document creation, templates, tables, charts
# ============================================================================

Specification PDFGenerator:
  """PDF генерация как спецификация документов."""

  # ==========================================================================
  # TYPES
  # ==========================================================================

  Type PDFDocument:
    pages: List<Page>
    metadata: DocumentMetadata
    fonts: Map<String, Font>
    images: Map<String, Image>
    styles: Map<String, Style>

  Type DocumentMetadata:
    title: String?
    author: String?
    subject: String?
    keywords: List<String>?
    creator: String = "Vibee PDF"
    creation_date: Timestamp?
    modification_date: Timestamp?

  Type Page:
    size: PageSize
    orientation: Orientation
    margins: Margins
    content: List<Element>
    header: Element?
    footer: Element?
    background: Element?

  Type PageSize:
    variants:
      - A4: (595.28, 841.89)
      - A3: (841.89, 1190.55)
      - A5: (419.53, 595.28)
      - Letter: (612, 792)
      - Legal: (612, 1008)
      - Custom: (width: Float, height: Float)

  Type Orientation:
    variants: [Portrait, Landscape]

  Type Margins:
    top: Float = 72
    right: Float = 72
    bottom: Float = 72
    left: Float = 72

  Type Element:
    variants:
      - Text: TextElement
      - Paragraph: ParagraphElement
      - Image: ImageElement
      - Table: TableElement
      - List: ListElement
      - Shape: ShapeElement
      - Chart: ChartElement
      - Barcode: BarcodeElement
      - QRCode: QRCodeElement
      - PageBreak
      - Spacer: Float
      - Container: ContainerElement
      - Columns: ColumnsElement

  # ==========================================================================
  # TEXT ELEMENTS
  # ==========================================================================

  Type TextElement:
    content: String
    style: TextStyle

  Type TextStyle:
    font: String = "Helvetica"
    size: Float = 12
    color: Color = Black
    bold: Boolean = false
    italic: Boolean = false
    underline: Boolean = false
    strikethrough: Boolean = false
    alignment: Alignment = Left
    line_height: Float = 1.2
    letter_spacing: Float = 0
    word_spacing: Float = 0

  Type ParagraphElement:
    content: List<TextSpan>
    style: ParagraphStyle

  Type TextSpan:
    text: String
    style: TextStyle?

  Type ParagraphStyle:
    alignment: Alignment = Left
    indent: Float = 0
    first_line_indent: Float = 0
    space_before: Float = 0
    space_after: Float = 12
    line_height: Float = 1.5

  Type Alignment:
    variants: [Left, Center, Right, Justify]

  Type Color:
    variants:
      - RGB: (r: Int, g: Int, b: Int)
      - CMYK: (c: Float, m: Float, y: Float, k: Float)
      - Hex: String
      - Named: String

  # ==========================================================================
  # IMAGE ELEMENTS
  # ==========================================================================

  Type ImageElement:
    source: ImageSource
    width: Float?
    height: Float?
    fit: ImageFit = Contain
    alignment: Alignment = Center
    border: Border?
    caption: String?

  Type ImageSource:
    variants:
      - Path: Path
      - URL: String
      - Base64: String
      - Bytes: Bytes

  Type ImageFit:
    variants:
      - Contain
      - Cover
      - Fill
      - ScaleDown
      - None

  Type Border:
    width: Float = 1
    color: Color = Black
    style: BorderStyle = Solid
    radius: Float = 0

  Type BorderStyle:
    variants: [Solid, Dashed, Dotted, Double]

  # ==========================================================================
  # TABLE ELEMENTS
  # ==========================================================================

  Type TableElement:
    headers: List<TableCell>?
    rows: List<TableRow>
    columns: List<ColumnDef>?
    style: TableStyle

  Type TableRow:
    cells: List<TableCell>
    style: RowStyle?

  Type TableCell:
    content: Element
    colspan: Int = 1
    rowspan: Int = 1
    style: CellStyle?

  Type ColumnDef:
    width: ColumnWidth
    alignment: Alignment = Left

  Type ColumnWidth:
    variants:
      - Fixed: Float
      - Percent: Float
      - Auto
      - Star: Int

  Type TableStyle:
    border: Border?
    header_style: CellStyle?
    alternate_row_color: Color?
    cell_padding: Float = 5

  Type RowStyle:
    background: Color?
    min_height: Float?

  Type CellStyle:
    background: Color?
    padding: Float?
    alignment: Alignment?
    vertical_alignment: VerticalAlignment?
    border: CellBorder?

  Type VerticalAlignment:
    variants: [Top, Middle, Bottom]

  Type CellBorder:
    top: Border?
    right: Border?
    bottom: Border?
    left: Border?

  # ==========================================================================
  # LIST ELEMENTS
  # ==========================================================================

  Type ListElement:
    items: List<ListItem>
    style: ListStyle

  Type ListItem:
    content: Element
    sub_items: List<ListItem>?

  Type ListStyle:
    type: ListType
    indent: Float = 20
    item_spacing: Float = 5
    marker_color: Color = Black

  Type ListType:
    variants:
      - Bullet: BulletStyle
      - Numbered: NumberStyle
      - Custom: String

  Type BulletStyle:
    variants: [Disc, Circle, Square, Dash]

  Type NumberStyle:
    variants: [Decimal, LowerAlpha, UpperAlpha, LowerRoman, UpperRoman]

  # ==========================================================================
  # SHAPE ELEMENTS
  # ==========================================================================

  Type ShapeElement:
    shape: Shape
    style: ShapeStyle

  Type Shape:
    variants:
      - Rectangle: (width: Float, height: Float)
      - RoundedRectangle: (width: Float, height: Float, radius: Float)
      - Circle: Float
      - Ellipse: (width: Float, height: Float)
      - Line: (x1: Float, y1: Float, x2: Float, y2: Float)
      - Polygon: List<(Float, Float)>
      - Path: String

  Type ShapeStyle:
    fill: Color?
    stroke: Color?
    stroke_width: Float = 1
    opacity: Float = 1

  # ==========================================================================
  # CHART ELEMENTS
  # ==========================================================================

  Type ChartElement:
    type: ChartType
    data: ChartData
    options: ChartOptions

  Type ChartType:
    variants:
      - Bar
      - Line
      - Pie
      - Doughnut
      - Area
      - Scatter
      - Radar

  Type ChartData:
    labels: List<String>
    datasets: List<Dataset>

  Type Dataset:
    label: String
    data: List<Float>
    color: Color?
    background_color: Color?

  Type ChartOptions:
    width: Float = 400
    height: Float = 300
    title: String?
    legend: Boolean = true
    legend_position: LegendPosition = Bottom
    grid: Boolean = true

  Type LegendPosition:
    variants: [Top, Bottom, Left, Right]

  # ==========================================================================
  # BARCODE/QR ELEMENTS
  # ==========================================================================

  Type BarcodeElement:
    data: String
    format: BarcodeFormat
    width: Float = 200
    height: Float = 50
    show_text: Boolean = true

  Type BarcodeFormat:
    variants:
      - Code128
      - Code39
      - EAN13
      - EAN8
      - UPC_A
      - UPC_E
      - ITF
      - PDF417
      - DataMatrix

  Type QRCodeElement:
    data: String
    size: Float = 100
    error_correction: ErrorCorrection = Medium
    foreground: Color = Black
    background: Color = White

  Type ErrorCorrection:
    variants: [Low, Medium, Quartile, High]

  # ==========================================================================
  # CONTAINER ELEMENTS
  # ==========================================================================

  Type ContainerElement:
    content: List<Element>
    style: ContainerStyle

  Type ContainerStyle:
    width: Float?
    height: Float?
    padding: Float = 0
    margin: Float = 0
    background: Color?
    border: Border?
    alignment: Alignment = Left

  Type ColumnsElement:
    columns: List<Column>
    gap: Float = 20

  Type Column:
    width: ColumnWidth
    content: List<Element>

  # ==========================================================================
  # PDF BUILDER
  # ==========================================================================

  Behavior PDFBuilder:
    State:
      document: PDFDocument
      current_page: Page?
      cursor_y: Float

    When pdf.create(options):
      Then:
        - document = PDFDocument(
            pages: [],
            metadata: options.metadata ?? DocumentMetadata(),
            fonts: {},
            images: {},
            styles: {}
          )
        - return PDFBuilder(document)

    When builder.add_page(options):
      Then:
        - page = Page(
            size: options.size ?? A4,
            orientation: options.orientation ?? Portrait,
            margins: options.margins ?? Margins(),
            content: [],
            header: options.header,
            footer: options.footer
          )
        - add page to document.pages
        - current_page = page
        - cursor_y = page.margins.top
        - return builder

    When builder.text(content, style):
      Then:
        - element = Text(TextElement(content, style ?? TextStyle()))
        - add element to current_page.content
        - return builder

    When builder.paragraph(content, style):
      Then:
        - spans = if content is String 
            then [TextSpan(content)] 
            else content
        - element = Paragraph(ParagraphElement(spans, style ?? ParagraphStyle()))
        - add element to current_page.content
        - return builder

    When builder.image(source, options):
      Then:
        - element = Image(ImageElement(
            source: source,
            width: options.width,
            height: options.height,
            fit: options.fit ?? Contain,
            caption: options.caption
          ))
        - add element to current_page.content
        - return builder

    When builder.table(data, options):
      Then:
        - rows = data.map(row -> TableRow(
            cells: row.map(cell -> TableCell(
              content: if cell is Element then cell else Text(TextElement(cell.to_string(), TextStyle()))
            ))
          ))
        - element = Table(TableElement(
            headers: options.headers?.map(h -> TableCell(content: Text(TextElement(h, TextStyle(bold: true))))),
            rows: rows,
            style: options.style ?? TableStyle()
          ))
        - add element to current_page.content
        - return builder

    When builder.list(items, style):
      Then:
        - list_items = items.map(item -> 
            if item is ListItem then item
            else ListItem(content: Text(TextElement(item.to_string(), TextStyle())))
          )
        - element = List(ListElement(list_items, style ?? ListStyle(type: Bullet(Disc))))
        - add element to current_page.content
        - return builder

    When builder.chart(type, data, options):
      Then:
        - element = Chart(ChartElement(type, data, options ?? ChartOptions()))
        - add element to current_page.content
        - return builder

    When builder.barcode(data, format, options):
      Then:
        - element = Barcode(BarcodeElement(data, format, options.width ?? 200, options.height ?? 50))
        - add element to current_page.content
        - return builder

    When builder.qrcode(data, options):
      Then:
        - element = QRCode(QRCodeElement(data, options.size ?? 100))
        - add element to current_page.content
        - return builder

    When builder.page_break():
      Then:
        - add PageBreak to current_page.content
        - return builder

    When builder.spacer(height):
      Then:
        - add Spacer(height) to current_page.content
        - return builder

    When builder.columns(columns, gap):
      Then:
        - element = Columns(ColumnsElement(columns, gap ?? 20))
        - add element to current_page.content
        - return builder

    When builder.build():
      Then:
        - return render_document(document)

    When builder.save(path):
      Then:
        - bytes = builder.build()
        - await fs.write_file(path, bytes)

  # ==========================================================================
  # TEMPLATES
  # ==========================================================================

  Behavior PDFTemplates:
    Type Template:
      name: String
      layout: TemplateLayout
      variables: Map<String, VariableType>
      styles: Map<String, Style>

    Type TemplateLayout:
      header: Element?
      footer: Element?
      body: List<TemplateElement>

    Type TemplateElement:
      variants:
        - Static: Element
        - Variable: String
        - Loop: (variable: String, template: List<TemplateElement>)
        - Conditional: (condition: String, then: List<TemplateElement>, else: List<TemplateElement>?)

    When template.render(data):
      Then:
        - builder = pdf.create()
        - builder.add_page({ header: layout.header, footer: layout.footer })
        
        - for element in layout.body:
            - render_template_element(builder, element, data)
        
        - return builder.build()

    When render_template_element(builder, element, data):
      Then:
        - match element:
            Static(e) -> add_element(builder, e)
            Variable(name) -> 
              value = get_variable(data, name)
              builder.text(value.to_string())
            Loop(var, template) ->
              items = get_variable(data, var)
              for item in items:
                for te in template:
                  render_template_element(builder, te, merge(data, { _item: item }))
            Conditional(cond, then_branch, else_branch) ->
              if evaluate_condition(cond, data):
                for te in then_branch:
                  render_template_element(builder, te, data)
              elif else_branch:
                for te in else_branch:
                  render_template_element(builder, te, data)

  # ==========================================================================
  # EXAMPLE
  # ==========================================================================

  Example "PDF Generation":
    ```vibee
    # Simple document
    doc = pdf.create(metadata: DocumentMetadata(
      title: "Invoice #12345",
      author: "My Company"
    ))
    
    doc.add_page(size: A4, margins: Margins(top: 50, bottom: 50))
    
    # Header
    doc.image(ImageSource.Path("/logo.png"), width: 150)
    doc.text("INVOICE", TextStyle(size: 24, bold: true))
    doc.spacer(20)
    
    # Invoice details
    doc.paragraph("Invoice #: 12345")
    doc.paragraph("Date: ${format_date(now())}")
    doc.spacer(20)
    
    # Items table
    doc.table(
      [
        ["Widget A", "10", "$5.00", "$50.00"],
        ["Widget B", "5", "$10.00", "$50.00"],
        ["Service", "2", "$25.00", "$50.00"]
      ],
      headers: ["Item", "Qty", "Price", "Total"],
      style: TableStyle(
        border: Border(width: 1, color: Hex("#cccccc")),
        header_style: CellStyle(background: Hex("#f0f0f0")),
        alternate_row_color: Hex("#fafafa")
      )
    )
    
    doc.spacer(20)
    doc.text("Total: $150.00", TextStyle(size: 16, bold: true, alignment: Right))
    
    # QR code for payment
    doc.qrcode("https://pay.example.com/inv/12345", size: 80)
    
    await doc.save("/invoices/invoice_12345.pdf")

    # Using template
    invoice_template = Template(
      name: "invoice",
      layout: TemplateLayout(
        header: Image(ImageSource.Path("/logo.png")),
        footer: Text(TextElement("Page {{page}} of {{pages}}", TextStyle(size: 10))),
        body: [
          Static(Text(TextElement("INVOICE", TextStyle(size: 24)))),
          Variable("invoice_number"),
          Loop("items", [
            Variable("_item.name"),
            Variable("_item.quantity"),
            Variable("_item.total")
          ])
        ]
      )
    )

    pdf_bytes = invoice_template.render({
      invoice_number: "INV-12345",
      items: [
        { name: "Product A", quantity: 2, total: 100 },
        { name: "Product B", quantity: 1, total: 50 }
      ]
    })
    ```
