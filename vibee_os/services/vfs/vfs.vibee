name: vibee_os_vfs
version: "0.1.0"
language: zig
module: services/vfs
description: Виртуальная файловая система VIBEE OS — унифицированный доступ через схемы

behaviors:
  - name: open_file_by_scheme
    given: Процесс запрашивает доступ к ресурсу
    when: Вызывается vfs_open с URL схемы
    then: Возвращается дескриптор файла или ошибка
    test_cases:
      - name: open_regular_file
        input: {url: "file://home/user/test.txt", mode: "read"}
        expected: {success: true, fd: 3}
      - name: open_console
        input: {url: "console://stdout", mode: "write"}
        expected: {success: true, fd: 1}
      - name: open_nonexistent
        input: {url: "file://nonexistent.txt", mode: "read"}
        expected: {success: false, error: "not_found"}

  - name: read_from_file
    given: Файл открыт для чтения
    when: Вызывается vfs_read с дескриптором
    then: Данные читаются в буфер
    test_cases:
      - name: read_text_file
        input: {fd: 3, size: 100}
        expected: {bytes_read: 13, data: "Hello, World!"}
      - name: read_empty_file
        input: {fd: 4, size: 100}
        expected: {bytes_read: 0, data: ""}

  - name: write_to_file
    given: Файл открыт для записи
    when: Вызывается vfs_write с данными
    then: Данные записываются в файл
    test_cases:
      - name: write_text
        input: {fd: 3, data: "VIBEE OS"}
        expected: {bytes_written: 8}

  - name: register_scheme
    given: Сервис хочет обрабатывать схему
    when: Вызывается scheme_register
    then: Схема регистрируется и запросы направляются сервису
    test_cases:
      - name: register_file_scheme
        input: {name: "file", handler_pid: 2}
        expected: {success: true}
      - name: register_duplicate
        input: {name: "file", handler_pid: 3}
        expected: {success: false, error: "already_registered"}

types:
  FileDescriptor:
    id: int
    scheme: str
    path: str
    mode: FileMode
    position: int
    flags: [FileFlag]

  FileMode:
    variants:
      - Read
      - Write
      - ReadWrite
      - Append

  FileFlag:
    variants:
      - Create
      - Truncate
      - Exclusive
      - Directory
      - NonBlocking

  Scheme:
    name: str
    handler_pid: int
    description: str

  FileInfo:
    name: str
    size: int
    is_directory: bool
    created_at: int
    modified_at: int
    permissions: int

  DirEntry:
    name: str
    is_directory: bool
    size: int

  VfsError:
    variants:
      - NotFound
      - PermissionDenied
      - AlreadyExists
      - NotDirectory
      - IsDirectory
      - InvalidPath
      - SchemeNotFound
      - IoError

  VfsResult:
    success: bool
    value: int?
    error: VfsError?

functions:
  - name: vfs_open
    params: {url: str, mode: FileMode, flags: [FileFlag]}
    returns: VfsResult
    description: Открытие ресурса по URL схемы

  - name: vfs_close
    params: {fd: int}
    returns: bool
    description: Закрытие дескриптора

  - name: vfs_read
    params: {fd: int, size: int}
    returns: {data: str, bytes_read: int}
    description: Чтение данных

  - name: vfs_write
    params: {fd: int, data: str}
    returns: int
    description: Запись данных

  - name: vfs_seek
    params: {fd: int, offset: int, whence: int}
    returns: int
    description: Перемещение позиции чтения/записи

  - name: vfs_stat
    params: {url: str}
    returns: FileInfo?
    description: Получение информации о файле

  - name: vfs_readdir
    params: {url: str}
    returns: [DirEntry]
    description: Чтение содержимого директории

  - name: vfs_mkdir
    params: {url: str}
    returns: bool
    description: Создание директории

  - name: vfs_remove
    params: {url: str}
    returns: bool
    description: Удаление файла или директории

  - name: scheme_register
    params: {name: str, handler_pid: int}
    returns: bool
    description: Регистрация обработчика схемы

  - name: scheme_unregister
    params: {name: str}
    returns: bool
    description: Удаление обработчика схемы

  - name: scheme_list
    params: {}
    returns: [Scheme]
    description: Список зарегистрированных схем

imports:
  - kernel.ipc
  - kernel.process

builtin_schemes: |
  Встроенные схемы VIBEE OS:
  
  file://path        — файловая система
  console://stdin    — стандартный ввод
  console://stdout   — стандартный вывод  
  console://stderr   — стандартный вывод ошибок
  null://            — /dev/null эквивалент
  zero://            — бесконечные нули
  random://          — случайные данные
  proc://pid/...     — информация о процессах
  mem://             — информация о памяти
  tcp://host:port    — TCP соединения
  udp://host:port    — UDP соединения
