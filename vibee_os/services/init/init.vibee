name: vibee_os_init
version: "0.1.0"
language: zig
module: services/init
description: Init процесс VIBEE OS — первый процесс, запускающий систему

behaviors:
  - name: system_boot
    given: Ядро инициализировано
    when: Init процесс запускается как PID 1
    then: Система инициализируется и запускаются базовые сервисы
    test_cases:
      - name: normal_boot
        input: {}
        expected: {pid: 1, services_started: ["vfs", "console", "shell"]}

  - name: start_service
    given: Init управляет сервисами
    when: Запрашивается запуск сервиса
    then: Сервис запускается и регистрируется
    test_cases:
      - name: start_vfs
        input: {service: "vfs"}
        expected: {started: true, pid: 2}
      - name: start_shell
        input: {service: "shell"}
        expected: {started: true, pid: 3}

  - name: reap_zombies
    given: Дочерний процесс завершился
    when: Init получает SIGCHLD
    then: Zombie процесс очищается
    test_cases:
      - name: reap_child
        input: {child_pid: 5, exit_code: 0}
        expected: {reaped: true}

  - name: system_shutdown
    given: Запрошено завершение работы
    when: Init получает команду shutdown
    then: Все сервисы останавливаются и система завершается
    test_cases:
      - name: graceful_shutdown
        input: {timeout_ms: 5000}
        expected: {services_stopped: true, clean_exit: true}

types:
  Service:
    name: str
    pid: int
    state: ServiceState
    restart_policy: RestartPolicy
    dependencies: [str]

  ServiceState:
    variants:
      - Stopped
      - Starting
      - Running
      - Stopping
      - Failed

  RestartPolicy:
    variants:
      - Never
      - OnFailure
      - Always

  BootStage:
    variants:
      - EarlyBoot
      - CoreServices
      - UserServices
      - Ready

  InitConfig:
    services: [ServiceConfig]
    default_shell: str
    timeout_ms: int

  ServiceConfig:
    name: str
    command: str
    args: [str]
    restart: RestartPolicy
    depends_on: [str]

functions:
  - name: init_main
    params: {}
    returns: void
    description: Главная функция init процесса

  - name: boot_system
    params: {}
    returns: bool
    description: Загрузка системы

  - name: start_service
    params: {name: str}
    returns: int
    description: Запуск сервиса, возвращает PID

  - name: stop_service
    params: {name: str}
    returns: bool
    description: Остановка сервиса

  - name: restart_service
    params: {name: str}
    returns: bool
    description: Перезапуск сервиса

  - name: service_status
    params: {name: str}
    returns: ServiceState
    description: Статус сервиса

  - name: list_services
    params: {}
    returns: [Service]
    description: Список всех сервисов

  - name: reap_children
    params: {}
    returns: int
    description: Очистка zombie процессов

  - name: shutdown
    params: {timeout_ms: int}
    returns: void
    description: Завершение работы системы

  - name: reboot
    params: {}
    returns: void
    description: Перезагрузка системы

imports:
  - kernel.process
  - kernel.syscall
  - services.vfs

boot_sequence: |
  Последовательность загрузки VIBEE OS:
  
  1. EARLY BOOT (Ядро)
     - Инициализация памяти
     - Инициализация планировщика
     - Инициализация IPC
     - Запуск init (PID 1)
  
  2. CORE SERVICES (Init)
     - Регистрация схемы console://
     - Регистрация схемы file://
     - Запуск VFS сервиса
  
  3. USER SERVICES (Init)
     - Запуск сетевого стека (если есть)
     - Запуск дополнительных сервисов
  
  4. READY
     - Запуск shell
     - Система готова к работе
  
  Время загрузки: < 100ms (WASM), < 10ms (native)
