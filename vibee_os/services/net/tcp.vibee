name: vibee_os_tcp
version: "0.1.0"
language: zig
module: services/net/tcp
description: TCP стек VIBEE OS — реализация TCP протокола

behaviors:
  - name: tcp_connect
    given: Клиент хочет установить соединение
    when: Вызывается tcp_connect с адресом и портом
    then: Выполняется TCP handshake и возвращается сокет
    test_cases:
      - name: connect_success
        input: {host: "127.0.0.1", port: 8080}
        expected: {success: true, state: "established"}
      - name: connect_refused
        input: {host: "127.0.0.1", port: 9999, server_listening: false}
        expected: {success: false, error: "connection_refused"}
      - name: connect_timeout
        input: {host: "10.255.255.1", port: 80, timeout_ms: 1000}
        expected: {success: false, error: "timeout"}

  - name: tcp_listen
    given: Сервер хочет принимать соединения
    when: Вызывается tcp_listen на порту
    then: Сокет переходит в состояние прослушивания
    test_cases:
      - name: listen_success
        input: {port: 8080, backlog: 10}
        expected: {success: true, state: "listening"}
      - name: listen_port_in_use
        input: {port: 8080, already_bound: true}
        expected: {success: false, error: "address_in_use"}

  - name: tcp_accept
    given: Сервер слушает порт и клиент подключается
    when: Вызывается tcp_accept
    then: Возвращается новый сокет для клиента
    test_cases:
      - name: accept_client
        input: {listen_socket: 1}
        expected: {success: true, client_socket: 2}

  - name: tcp_send
    given: Соединение установлено
    when: Вызывается tcp_send с данными
    then: Данные отправляются и возвращается количество байт
    test_cases:
      - name: send_data
        input: {socket: 1, data: "Hello, TCP!"}
        expected: {bytes_sent: 11}
      - name: send_closed
        input: {socket: 1, data: "test", connection_closed: true}
        expected: {success: false, error: "connection_reset"}

  - name: tcp_recv
    given: Соединение установлено и есть данные
    when: Вызывается tcp_recv
    then: Данные читаются из буфера
    test_cases:
      - name: recv_data
        input: {socket: 1, size: 1024}
        expected: {success: true, data: "Hello!"}
      - name: recv_no_data
        input: {socket: 1, size: 1024, blocking: false, buffer_empty: true}
        expected: {success: true, data: "", would_block: true}

  - name: tcp_close
    given: Соединение больше не нужно
    when: Вызывается tcp_close
    then: Выполняется TCP FIN handshake и сокет закрывается
    test_cases:
      - name: graceful_close
        input: {socket: 1}
        expected: {success: true, state: "closed"}

types:
  TcpSocket:
    id: int
    local_addr: IpAddr
    local_port: int
    remote_addr: IpAddr?
    remote_port: int?
    state: TcpState
    send_buffer: [int]
    recv_buffer: [int]
    seq_num: int
    ack_num: int

  TcpState:
    variants:
      - Closed
      - Listen
      - SynSent
      - SynReceived
      - Established
      - FinWait1
      - FinWait2
      - CloseWait
      - Closing
      - LastAck
      - TimeWait

  IpAddr:
    octets: [int]  # 4 для IPv4, 16 для IPv6
    version: IpVersion

  IpVersion:
    variants:
      - V4
      - V6

  SocketAddr:
    ip: IpAddr
    port: int

  TcpOptions:
    nodelay: bool
    keepalive: bool
    keepalive_interval_ms: int?
    recv_buffer_size: int
    send_buffer_size: int
    timeout_ms: int?

  TcpError:
    variants:
      - ConnectionRefused
      - ConnectionReset
      - ConnectionAborted
      - Timeout
      - AddressInUse
      - AddressNotAvailable
      - NetworkUnreachable
      - HostUnreachable
      - WouldBlock
      - InvalidSocket

  TcpResult:
    success: bool
    socket: int?
    bytes: int?
    data: str?
    error: TcpError?

  TcpStats:
    bytes_sent: int
    bytes_received: int
    packets_sent: int
    packets_received: int
    retransmissions: int
    rtt_ms: int

functions:
  # Клиентские операции
  - name: tcp_connect
    params: {addr: SocketAddr, options: TcpOptions?}
    returns: TcpResult
    description: Установка TCP соединения

  - name: tcp_connect_timeout
    params: {addr: SocketAddr, timeout_ms: int}
    returns: TcpResult
    description: Соединение с таймаутом

  # Серверные операции
  - name: tcp_bind
    params: {addr: SocketAddr}
    returns: TcpResult
    description: Привязка к адресу

  - name: tcp_listen
    params: {socket: int, backlog: int}
    returns: TcpResult
    description: Начало прослушивания

  - name: tcp_accept
    params: {socket: int}
    returns: TcpResult
    description: Принятие соединения

  # Передача данных
  - name: tcp_send
    params: {socket: int, data: str}
    returns: TcpResult
    description: Отправка данных

  - name: tcp_send_all
    params: {socket: int, data: str}
    returns: TcpResult
    description: Отправка всех данных (с повторами)

  - name: tcp_recv
    params: {socket: int, size: int}
    returns: TcpResult
    description: Получение данных

  - name: tcp_recv_exact
    params: {socket: int, size: int}
    returns: TcpResult
    description: Получение точного количества байт

  # Управление
  - name: tcp_close
    params: {socket: int}
    returns: TcpResult
    description: Закрытие соединения

  - name: tcp_shutdown
    params: {socket: int, how: int}
    returns: TcpResult
    description: Частичное закрытие (read/write/both)

  - name: tcp_set_option
    params: {socket: int, option: str, value: int}
    returns: bool
    description: Установка опции сокета

  - name: tcp_get_option
    params: {socket: int, option: str}
    returns: int
    description: Получение опции сокета

  # Информация
  - name: tcp_local_addr
    params: {socket: int}
    returns: SocketAddr?
    description: Локальный адрес

  - name: tcp_remote_addr
    params: {socket: int}
    returns: SocketAddr?
    description: Удалённый адрес

  - name: tcp_state
    params: {socket: int}
    returns: TcpState
    description: Состояние соединения

  - name: tcp_stats
    params: {socket: int}
    returns: TcpStats
    description: Статистика соединения

imports:
  - kernel.hal
  - kernel.ipc

tcp_state_machine: |
  Диаграмма состояний TCP:
  
                              ┌─────────┐
                              │ CLOSED  │
                              └────┬────┘
                     ┌─────────────┼─────────────┐
                     │             │             │
                     ▼             │             ▼
               ┌──────────┐       │       ┌──────────┐
               │  LISTEN  │       │       │ SYN_SENT │
               └────┬─────┘       │       └────┬─────┘
                    │             │             │
                    ▼             │             ▼
            ┌──────────────┐      │      ┌──────────────┐
            │ SYN_RECEIVED │      │      │ ESTABLISHED  │◄─┐
            └──────┬───────┘      │      └──────┬───────┘  │
                   │              │             │          │
                   └──────────────┴─────────────┘          │
                                  │                        │
                                  ▼                        │
                          ┌──────────────┐                 │
                          │  FIN_WAIT_1  │                 │
                          └──────┬───────┘                 │
                                 │                         │
                    ┌────────────┼────────────┐            │
                    ▼            │            ▼            │
             ┌──────────┐       │      ┌──────────┐       │
             │ CLOSING  │       │      │FIN_WAIT_2│       │
             └────┬─────┘       │      └────┬─────┘       │
                  │             │           │             │
                  └─────────────┼───────────┘             │
                                ▼                         │
                         ┌──────────┐                     │
                         │TIME_WAIT │─────────────────────┘
                         └──────────┘
