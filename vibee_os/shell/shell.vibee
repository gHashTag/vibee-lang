name: vibee_os_shell
version: "0.1.0"
language: zig
module: shell
description: Командная оболочка VIBEE OS — интерактивный интерфейс пользователя

behaviors:
  - name: shell_startup
    given: Система загружена и init запустил shell
    when: Shell запускается
    then: Выводится приветствие и приглашение к вводу
    test_cases:
      - name: interactive_start
        input: {interactive: true}
        expected: {banner_shown: true, prompt: "vibee> "}

  - name: execute_builtin_command
    given: Пользователь вводит встроенную команду
    when: Команда распознаётся как builtin
    then: Команда выполняется напрямую в shell
    test_cases:
      - name: help_command
        input: {command: "help"}
        expected: {executed: true, output_contains: "Available commands"}
      - name: echo_command
        input: {command: "echo Hello World"}
        expected: {executed: true, output: "Hello World"}
      - name: exit_command
        input: {command: "exit"}
        expected: {executed: true, should_exit: true}

  - name: execute_external_command
    given: Пользователь вводит внешнюю команду
    when: Команда не является builtin
    then: Создаётся новый процесс для выполнения
    test_cases:
      - name: run_program
        input: {command: "/bin/program arg1 arg2"}
        expected: {spawned: true, waited: true}

  - name: parse_command_line
    given: Пользователь ввёл строку команды
    when: Строка парсится
    then: Извлекаются команда и аргументы
    test_cases:
      - name: simple_command
        input: {line: "ls -la /home"}
        expected: {command: "ls", args: ["-la", "/home"]}
      - name: quoted_args
        input: {line: "echo \"hello world\""}
        expected: {command: "echo", args: ["hello world"]}
      - name: empty_line
        input: {line: ""}
        expected: {command: null, args: []}

  - name: command_history
    given: Пользователь выполнял команды
    when: Запрашивается история
    then: Возвращается список предыдущих команд
    test_cases:
      - name: get_history
        input: {count: 10}
        expected: {commands: ["ls", "cd /home", "cat file.txt"]}

types:
  ShellState:
    running: bool
    current_dir: str
    history: [str]
    env: {str: str}
    last_exit_code: int

  Command:
    name: str
    args: [str]
    stdin: int?
    stdout: int?
    stderr: int?
    background: bool

  ParsedLine:
    commands: [Command]
    pipes: bool
    redirect_in: str?
    redirect_out: str?
    redirect_append: bool

  BuiltinCommand:
    variants:
      - Help
      - Exit
      - Echo
      - Cd
      - Pwd
      - Ls
      - Cat
      - Clear
      - Ps
      - Kill
      - Env
      - Export
      - History
      - Alias

  CommandResult:
    success: bool
    exit_code: int
    output: str?
    error: str?

  Alias:
    name: str
    expansion: str

functions:
  - name: shell_init
    params: {}
    returns: ShellState
    description: Инициализация shell

  - name: shell_run
    params: {state: ShellState}
    returns: int
    description: Главный цикл shell (REPL)

  - name: shell_execute
    params: {state: ShellState, line: str}
    returns: CommandResult
    description: Выполнение строки команды

  - name: parse_line
    params: {line: str}
    returns: ParsedLine
    description: Парсинг командной строки

  - name: execute_builtin
    params: {cmd: BuiltinCommand, args: [str]}
    returns: CommandResult
    description: Выполнение встроенной команды

  - name: execute_external
    params: {cmd: Command}
    returns: CommandResult
    description: Выполнение внешней команды

  - name: builtin_help
    params: {}
    returns: str
    description: Вывод справки

  - name: builtin_echo
    params: {args: [str]}
    returns: str
    description: Вывод аргументов

  - name: builtin_cd
    params: {path: str}
    returns: bool
    description: Смена директории

  - name: builtin_pwd
    params: {}
    returns: str
    description: Текущая директория

  - name: builtin_ls
    params: {path: str?, flags: [str]}
    returns: [str]
    description: Список файлов

  - name: builtin_cat
    params: {files: [str]}
    returns: str
    description: Вывод содержимого файлов

  - name: builtin_ps
    params: {}
    returns: str
    description: Список процессов

  - name: builtin_clear
    params: {}
    returns: void
    description: Очистка экрана

  - name: builtin_env
    params: {}
    returns: {str: str}
    description: Переменные окружения

  - name: builtin_export
    params: {name: str, value: str}
    returns: bool
    description: Установка переменной окружения

  - name: history_add
    params: {state: ShellState, command: str}
    returns: void
    description: Добавление команды в историю

  - name: history_get
    params: {state: ShellState, index: int}
    returns: str?
    description: Получение команды из истории

  - name: alias_set
    params: {state: ShellState, name: str, expansion: str}
    returns: void
    description: Создание алиаса

  - name: alias_expand
    params: {state: ShellState, command: str}
    returns: str
    description: Раскрытие алиасов

imports:
  - kernel.syscall
  - kernel.process
  - services.vfs
  - kernel.drivers.console

shell_banner: |
  ╔═══════════════════════════════════════════════════════════╗
  ║                                                           ║
  ║   ██╗   ██╗██╗██████╗ ███████╗███████╗     ██████╗ ███████╗║
  ║   ██║   ██║██║██╔══██╗██╔════╝██╔════╝    ██╔═══██╗██╔════╝║
  ║   ██║   ██║██║██████╔╝█████╗  █████╗      ██║   ██║███████╗║
  ║   ╚██╗ ██╔╝██║██╔══██╗██╔══╝  ██╔══╝      ██║   ██║╚════██║║
  ║    ╚████╔╝ ██║██████╔╝███████╗███████╗    ╚██████╔╝███████║║
  ║     ╚═══╝  ╚═╝╚═════╝ ╚══════╝╚══════╝     ╚═════╝ ╚══════╝║
  ║                                                           ║
  ║   Behavioral Specification Operating System v0.1.0        ║
  ║   Type 'help' for available commands                      ║
  ║                                                           ║
  ╚═══════════════════════════════════════════════════════════╝

builtin_commands: |
  Встроенные команды VIBEE OS Shell:
  
  help              - показать справку
  exit [code]       - выход из shell
  echo [args...]    - вывод текста
  cd [path]         - сменить директорию
  pwd               - текущая директория
  ls [path] [-la]   - список файлов
  cat [files...]    - вывод содержимого файлов
  clear             - очистить экран
  ps                - список процессов
  kill [pid]        - завершить процесс
  env               - переменные окружения
  export NAME=VALUE - установить переменную
  history           - история команд
  alias NAME=CMD    - создать алиас
  version           - версия системы
  uptime            - время работы
  mem               - использование памяти
