/// Web Server Example
/// A simple HTTP server built with Vibee

use std::http::{Server, Request, Response, Status}
use std::json
use std::fs

// Routes
struct AppRouter {
    routes: HashMap<String, fn(Request) -> Response>,
}

impl AppRouter {
    fn new() -> AppRouter {
        AppRouter { routes: HashMap::new() }
    }
    
    fn get(mut self, path: String, handler: fn(Request) -> Response) {
        self.routes.insert(format!("GET {}", path), handler)
    }
    
    fn post(mut self, path: String, handler: fn(Request) -> Response) {
        self.routes.insert(format!("POST {}", path), handler)
    }
    
    fn handle(self, req: Request) -> Response {
        let key = format!("{} {}", req.method, req.path)
        if let Some(handler) = self.routes.get(&key) {
            handler(req)
        } else {
            Response::new(Status::NotFound)
                .body("Not Found")
        }
    }
}

// Handlers
fn index(req: Request) -> Response {
    Response::new(Status::Ok)
        .header("Content-Type", "text/html")
        .body(r#"
            <!DOCTYPE html>
            <html>
            <head>
                <title>Vibee Web Server</title>
                <style>
                    body { font-family: sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
                    h1 { color: #333; }
                    .api { background: #f5f5f5; padding: 10px; border-radius: 5px; }
                </style>
            </head>
            <body>
                <h1>Welcome to Vibee Web Server!</h1>
                <p>This server is built with Vibee Lang.</p>
                <div class="api">
                    <h2>API Endpoints:</h2>
                    <ul>
                        <li>GET /api/users - List users</li>
                        <li>POST /api/users - Create user</li>
                        <li>GET /api/health - Health check</li>
                    </ul>
                </div>
            </body>
            </html>
        "#)
}

fn api_users_list(req: Request) -> Response {
    let users = vec![
        json::object!{ "id": 1, "name": "Alice", "email": "alice@example.com" },
        json::object!{ "id": 2, "name": "Bob", "email": "bob@example.com" },
        json::object!{ "id": 3, "name": "Charlie", "email": "charlie@example.com" },
    ]
    
    Response::new(Status::Ok)
        .header("Content-Type", "application/json")
        .body(json::stringify(users))
}

fn api_users_create(req: Request) -> Response {
    let body = json::parse(req.body)
    
    if body["name"].is_null() || body["email"].is_null() {
        return Response::new(Status::BadRequest)
            .header("Content-Type", "application/json")
            .body(json::stringify(json::object!{
                "error": "name and email are required"
            }))
    }
    
    let user = json::object!{
        "id": 4,
        "name": body["name"],
        "email": body["email"],
        "created_at": std::time::now().to_string()
    }
    
    Response::new(Status::Created)
        .header("Content-Type", "application/json")
        .body(json::stringify(user))
}

fn api_health(req: Request) -> Response {
    Response::new(Status::Ok)
        .header("Content-Type", "application/json")
        .body(json::stringify(json::object!{
            "status": "healthy",
            "version": "0.1.0",
            "uptime": std::time::uptime().as_secs()
        }))
}

fn static_file(req: Request) -> Response {
    let path = format!("./static{}", req.path)
    
    if fs::exists(path.clone()) {
        let content = fs::read_to_string(path.clone())
        let content_type = match path.split('.').last() {
            Some("html") => "text/html",
            Some("css") => "text/css",
            Some("js") => "application/javascript",
            Some("json") => "application/json",
            Some("png") => "image/png",
            Some("jpg") | Some("jpeg") => "image/jpeg",
            _ => "application/octet-stream",
        }
        
        Response::new(Status::Ok)
            .header("Content-Type", content_type)
            .body(content)
    } else {
        Response::new(Status::NotFound)
            .body("File not found")
    }
}

// Middleware
fn logger(req: Request, next: fn(Request) -> Response) -> Response {
    let start = std::time::now()
    let response = next(req.clone())
    let duration = std::time::now() - start
    
    println("[{}] {} {} - {} ({:?})", 
        std::time::now().format("%Y-%m-%d %H:%M:%S"),
        req.method,
        req.path,
        response.status.code(),
        duration)
    
    response
}

fn cors(req: Request, next: fn(Request) -> Response) -> Response {
    let mut response = next(req)
    response.headers.insert("Access-Control-Allow-Origin", "*")
    response.headers.insert("Access-Control-Allow-Methods", "GET, POST, PUT, DELETE, OPTIONS")
    response.headers.insert("Access-Control-Allow-Headers", "Content-Type, Authorization")
    response
}

// Main
fn main() {
    let mut router = AppRouter::new()
    
    // Register routes
    router.get("/", index)
    router.get("/api/users", api_users_list)
    router.post("/api/users", api_users_create)
    router.get("/api/health", api_health)
    
    // Create server
    let server = Server::new("0.0.0.0:8080")
        .middleware(logger)
        .middleware(cors)
        .handler(|req| router.handle(req))
    
    println("ðŸš€ Server running at http://localhost:8080")
    server.run()
}
