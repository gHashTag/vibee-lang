// ═══════════════════════════════════════════════════════════════
// ПАРСЕР 999 — ВТОРАЯ ГОЛОВА ГОРЫНЫЧА
// Токены → AST (дерево на Тридевятице)
// ═══════════════════════════════════════════════════════════════

имя: парсер_999
версия: Ⲁ
голова: Ⲋ  // Вторая голова Горыныча

// ═══════════════════════════════════════════════════════════════
// AST УЗЛЫ (9 типов = 3²)
// ═══════════════════════════════════════════════════════════════

Ⲉ УзелAST:
  // Медное (структура)
  Ⲁ: Программа([УзелAST])
  Ⲃ: Действие(имя: Ⲅ, параметры: [Параметр], тело: [УзелAST])
  Ⲅ: Структура(имя: Ⲅ, поля: [Поле])
  
  // Серебряное (операции)
  Ⲇ: Выражение(оператор: Ⲅ, левый: УзелAST, правый: УзелAST)
  Ⲉ: Вызов(имя: Ⲅ, аргументы: [УзелAST])
  Ⲋ: Условие(условие: УзелAST, тогда: [УзелAST], иначе: [УзелAST])
  
  // Золотое (данные)
  Ⲍ: Переменная(имя: Ⲅ, тип: ?Ⲅ, значение: ?УзелAST)
  Ⲏ: Литерал(значение: Ⲅ)
  Ⲑ: Идентификатор(имя: Ⲅ)

Ⲏ Параметр:
  имя: Ⲅ
  тип: Ⲅ

Ⲏ Поле:
  имя: Ⲅ
  тип: Ⲅ

// ═══════════════════════════════════════════════════════════════
// ПАРСЕР
// ═══════════════════════════════════════════════════════════════

Ⲏ Парсер:
  токены: [Токен]
  позиция: Ⲛ
  ast: УзелAST

Ⲇ создать_парсер(токены: [Токен]) → Парсер:
  Парсер:
    токены: токены
    позиция: 0
    ast: УзелAST.Программа([])

Ⲇ текущий_токен(парсер: Парсер) → Токен:
  парсер.токены[парсер.позиция]

Ⲇ следующий_токен(парсер: &Парсер) → Токен:
  Ⲗ токен = текущий_токен(парсер)
  парсер.позиция += 1
  токен

Ⲇ ожидать(парсер: &Парсер, символ: Ⲅ) → Токен:
  Ⲗ токен = текущий_токен(парсер)
  Ⲑ токен.символ ≠ символ:
    ошибка("Ожидался " + символ + ", получен " + токен.символ)
  следующий_токен(парсер)

// ═══════════════════════════════════════════════════════════════
// РАЗБОР ПРОГРАММЫ
// ═══════════════════════════════════════════════════════════════

Ⲇ разобрать(парсер: &Парсер) → УзелAST:
  Ⲗ узлы: [УзелAST] = []
  
  Ⲕ текущий_токен(парсер).тип ≠ ТипТокена.Конец:
    Ⲗ узел = разобрать_объявление(парсер)
    узлы.добавить(узел)
  
  УзелAST.Программа(узлы)

Ⲇ разобрать_объявление(парсер: &Парсер) → УзелAST:
  Ⲗ токен = текущий_токен(парсер)
  
  Ⲑ токен.символ:
    Ⲇ: разобрать_действие(парсер)      // Ⲇ = fn
    Ⲏ: разобрать_структуру(парсер)     // Ⲏ = struct
    Ⲉ: разобрать_перечисление(парсер)  // Ⲉ = enum
    Ⲗ: разобрать_переменную(парсер)    // Ⲗ = let
    _: разобрать_выражение(парсер)

// ═══════════════════════════════════════════════════════════════
// РАЗБОР ДЕЙСТВИЯ (ФУНКЦИИ)
// ═══════════════════════════════════════════════════════════════

// Синтаксис: Ⲇ имя(параметры) → тип: тело
Ⲇ разобрать_действие(парсер: &Парсер) → УзелAST:
  ожидать(парсер, Ⲇ)  // Ⲇ = fn
  
  Ⲗ имя = следующий_токен(парсер).значение
  
  ожидать(парсер, '(')
  Ⲗ параметры = разобрать_параметры(парсер)
  ожидать(парсер, ')')
  
  // Опциональный тип возврата
  Ⲗ тип_возврата = Ⲑ текущий_токен(парсер).символ = Ⲫ:  // →
    следующий_токен(парсер)
    следующий_токен(парсер).значение
  Ⲓ:
    Ⲯ
  
  ожидать(парсер, ':')
  Ⲗ тело = разобрать_блок(парсер)
  
  УзелAST.Действие(имя, параметры, тело)

Ⲇ разобрать_параметры(парсер: &Парсер) → [Параметр]:
  Ⲗ параметры: [Параметр] = []
  
  Ⲕ текущий_токен(парсер).символ ≠ ')':
    Ⲗ имя = следующий_токен(парсер).значение
    ожидать(парсер, ':')
    Ⲗ тип = следующий_токен(парсер).значение
    параметры.добавить(Параметр: имя, тип)
    
    Ⲑ текущий_токен(парсер).символ = ',':
      следующий_токен(парсер)
  
  параметры

// ═══════════════════════════════════════════════════════════════
// РАЗБОР ВЫРАЖЕНИЙ
// ═══════════════════════════════════════════════════════════════

Ⲇ разобрать_выражение(парсер: &Парсер) → УзелAST:
  разобрать_логическое(парсер)

// Троичная логика: ∧ ∨ ¬ ?
Ⲇ разобрать_логическое(парсер: &Парсер) → УзелAST:
  Ⲗ левый = разобрать_сравнение(парсер)
  
  Ⲕ текущий_токен(парсер).символ Ⲋ [Ⲣ, Ⲥ]:  // ∧ ∨
    Ⲗ оператор = следующий_токен(парсер).символ
    Ⲗ правый = разобрать_сравнение(парсер)
    левый = УзелAST.Выражение(оператор, левый, правый)
  
  левый

Ⲇ разобрать_сравнение(парсер: &Парсер) → УзелAST:
  Ⲗ левый = разобрать_арифметику(парсер)
  
  Ⲑ текущий_токен(парсер).символ Ⲋ [Ⲋ, Ⲍ, Ⲏ, Ⲑ]:  // = ≠ < >
    Ⲗ оператор = следующий_токен(парсер).символ
    Ⲗ правый = разобрать_арифметику(парсер)
    УзелAST.Выражение(оператор, левый, правый)
  Ⲓ:
    левый

Ⲇ разобрать_арифметику(парсер: &Парсер) → УзелAST:
  Ⲗ левый = разобрать_терм(парсер)
  
  Ⲕ текущий_токен(парсер).символ Ⲋ [Ⲁ, Ⲃ]:  // + -
    Ⲗ оператор = следующий_токен(парсер).символ
    Ⲗ правый = разобрать_терм(парсер)
    левый = УзелAST.Выражение(оператор, левый, правый)
  
  левый

Ⲇ разобрать_терм(парсер: &Парсер) → УзелAST:
  Ⲗ левый = разобрать_атом(парсер)
  
  Ⲕ текущий_токен(парсер).символ Ⲋ [Ⲅ, Ⲇ]:  // × ÷
    Ⲗ оператор = следующий_токен(парсер).символ
    Ⲗ правый = разобрать_атом(парсер)
    левый = УзелAST.Выражение(оператор, левый, правый)
  
  левый

Ⲇ разобрать_атом(парсер: &Парсер) → УзелAST:
  Ⲗ токен = текущий_токен(парсер)
  
  Ⲑ токен.тип:
    Число:
      следующий_токен(парсер)
      УзелAST.Литерал(токен.символ)
    
    Строка:
      следующий_токен(парсер)
      УзелAST.Литерал(токен.значение)
    
    Идентификатор:
      следующий_токен(парсер)
      Ⲑ текущий_токен(парсер).символ = '(':
        разобрать_вызов(парсер, токен.значение)
      Ⲓ:
        УзелAST.Идентификатор(токен.значение)
    
    _:
      Ⲑ токен.символ = '(':
        следующий_токен(парсер)
        Ⲗ выражение = разобрать_выражение(парсер)
        ожидать(парсер, ')')
        выражение
      Ⲓ:
        ошибка("Неожиданный токен: " + токен.символ)

// ═══════════════════════════════════════════════════════════════
// РАЗБОР УСЛОВИЯ
// ═══════════════════════════════════════════════════════════════

// Синтаксис: Ⲑ условие: тогда Ⲓ: иначе
Ⲇ разобрать_условие(парсер: &Парсер) → УзелAST:
  ожидать(парсер, Ⲑ)  // Ⲑ = if
  
  Ⲗ условие = разобрать_выражение(парсер)
  ожидать(парсер, ':')
  Ⲗ тогда = разобрать_блок(парсер)
  
  Ⲗ иначе = Ⲑ текущий_токен(парсер).символ = Ⲓ:  // Ⲓ = else
    следующий_токен(парсер)
    ожидать(парсер, ':')
    разобрать_блок(парсер)
  Ⲓ:
    []
  
  УзелAST.Условие(условие, тогда, иначе)

Ⲇ разобрать_блок(парсер: &Парсер) → [УзелAST]:
  Ⲗ узлы: [УзелAST] = []
  
  // Блок заканчивается на новой строке или Ⲓ/Ⳃ
  Ⲕ текущий_токен(парсер).тип ≠ ТипТокена.Конец ∧
     текущий_токен(парсер).символ ∉ [Ⲓ, Ⳃ]:
    Ⲗ узел = разобрать_выражение(парсер)
    узлы.добавить(узел)
  
  узлы

// ═══════════════════════════════════════════════════════════════
// САМОЭВОЛЮЦИЯ ПАРСЕРА
// ═══════════════════════════════════════════════════════════════

Ⲇ эволюционировать_парсер(парсер: Парсер) → Парсер:
  Ⲗ новый = парсер
  новый.версия = сложить(парсер.версия, Ⲁ)
  новый
