// =============================================================================
// Vibee OS â€” SEO Module
// Search Engine Optimization utilities
// =============================================================================

use result::{Result, Ok, Err}
use datetime::{DateTime}

// =============================================================================
// SEO Types
// =============================================================================

/// Robots directive
enum RobotsDirective {
    Index,
    NoIndex,
    Follow,
    NoFollow,
    NoArchive,
    NoSnippet,
    NoImageIndex,
    MaxSnippet(Int),
    MaxImagePreview(String),
    MaxVideoPreview(Int)
}

impl RobotsDirective {
    fn to_string() -> String {
        match self {
            RobotsDirective.Index => "index",
            RobotsDirective.NoIndex => "noindex",
            RobotsDirective.Follow => "follow",
            RobotsDirective.NoFollow => "nofollow",
            RobotsDirective.NoArchive => "noarchive",
            RobotsDirective.NoSnippet => "nosnippet",
            RobotsDirective.NoImageIndex => "noimageindex",
            RobotsDirective.MaxSnippet(n) => format!("max-snippet:{}", n),
            RobotsDirective.MaxImagePreview(s) => format!("max-image-preview:{}", s),
            RobotsDirective.MaxVideoPreview(n) => format!("max-video-preview:{}", n)
        }
    }
}

/// Open Graph type
enum OgType {
    Website,
    Article,
    Product,
    Profile,
    Video,
    Music,
    Book,
    Custom(String)
}

impl OgType {
    fn to_string() -> String {
        match self {
            OgType.Website => "website",
            OgType.Article => "article",
            OgType.Product => "product",
            OgType.Profile => "profile",
            OgType.Video => "video.other",
            OgType.Music => "music.song",
            OgType.Book => "book",
            OgType.Custom(t) => t
        }
    }
}

/// Twitter card type
enum TwitterCard {
    Summary,
    SummaryLargeImage,
    App,
    Player
}

impl TwitterCard {
    fn to_string() -> String {
        match self {
            TwitterCard.Summary => "summary",
            TwitterCard.SummaryLargeImage => "summary_large_image",
            TwitterCard.App => "app",
            TwitterCard.Player => "player"
        }
    }
}

// =============================================================================
// Meta Tags
// =============================================================================

/// SEO meta data
struct SeoMeta {
    title: String,
    description: Option<String>,
    keywords: [String],
    canonical: Option<String>,
    robots: [RobotsDirective],
    author: Option<String>,
    publisher: Option<String>,
    language: Option<String>,
    alternate_languages: Map<String, String>,
    prev_url: Option<String>,
    next_url: Option<String>
}

impl SeoMeta {
    fn new(title: String) -> Self {
        SeoMeta {
            title: title,
            description: None,
            keywords: [],
            canonical: None,
            robots: [RobotsDirective.Index, RobotsDirective.Follow],
            author: None,
            publisher: None,
            language: None,
            alternate_languages: Map.empty(),
            prev_url: None,
            next_url: None
        }
    }
    
    fn with_description(desc: String) -> Self {
        self.description = Some(desc)
        self
    }
    
    fn with_keywords(keywords: [String]) -> Self {
        self.keywords = keywords
        self
    }
    
    fn with_canonical(url: String) -> Self {
        self.canonical = Some(url)
        self
    }
    
    fn with_robots(directives: [RobotsDirective]) -> Self {
        self.robots = directives
        self
    }
    
    fn noindex() -> Self {
        self.robots = [RobotsDirective.NoIndex, RobotsDirective.NoFollow]
        self
    }
    
    fn with_author(author: String) -> Self {
        self.author = Some(author)
        self
    }
    
    fn with_language(lang: String) -> Self {
        self.language = Some(lang)
        self
    }
    
    fn add_alternate(lang: String, url: String) {
        self.alternate_languages.set(lang, url)
    }
    
    fn with_pagination(prev: Option<String>, next: Option<String>) -> Self {
        self.prev_url = prev
        self.next_url = next
        self
    }
    
    fn render_html() -> String {
        var tags: [String] = []
        
        tags.push(format!("<title>{}</title>", escape_html(self.title.clone())))
        
        if let Some(desc) = self.description.clone() {
            tags.push(format!("<meta name=\"description\" content=\"{}\">", escape_html(desc)))
        }
        
        if !self.keywords.is_empty() {
            tags.push(format!("<meta name=\"keywords\" content=\"{}\">", self.keywords.join(", ")))
        }
        
        if let Some(canonical) = self.canonical.clone() {
            tags.push(format!("<link rel=\"canonical\" href=\"{}\">", canonical))
        }
        
        if !self.robots.is_empty() {
            let robots_str = self.robots.iter().map(|r| r.to_string()).join(", ")
            tags.push(format!("<meta name=\"robots\" content=\"{}\">", robots_str))
        }
        
        if let Some(author) = self.author.clone() {
            tags.push(format!("<meta name=\"author\" content=\"{}\">", escape_html(author)))
        }
        
        if let Some(lang) = self.language.clone() {
            tags.push(format!("<meta http-equiv=\"content-language\" content=\"{}\">", lang))
        }
        
        for (lang, url) in self.alternate_languages.iter() {
            tags.push(format!("<link rel=\"alternate\" hreflang=\"{}\" href=\"{}\">", lang, url))
        }
        
        if let Some(prev) = self.prev_url.clone() {
            tags.push(format!("<link rel=\"prev\" href=\"{}\">", prev))
        }
        
        if let Some(next) = self.next_url.clone() {
            tags.push(format!("<link rel=\"next\" href=\"{}\">", next))
        }
        
        tags.join("\n")
    }
}

// =============================================================================
// Open Graph
// =============================================================================

/// Open Graph meta data
struct OpenGraph {
    og_type: OgType,
    title: String,
    description: Option<String>,
    url: Option<String>,
    image: Option<String>,
    image_width: Option<Int>,
    image_height: Option<Int>,
    image_alt: Option<String>,
    site_name: Option<String>,
    locale: Option<String>,
    article_author: Option<String>,
    article_published: Option<DateTime>,
    article_modified: Option<DateTime>,
    article_section: Option<String>,
    article_tags: [String]
}

impl OpenGraph {
    fn new(title: String) -> Self {
        OpenGraph {
            og_type: OgType.Website,
            title: title,
            description: None,
            url: None,
            image: None,
            image_width: None,
            image_height: None,
            image_alt: None,
            site_name: None,
            locale: None,
            article_author: None,
            article_published: None,
            article_modified: None,
            article_section: None,
            article_tags: []
        }
    }
    
    fn article(title: String, author: String) -> Self {
        var og = OpenGraph.new(title)
        og.og_type = OgType.Article
        og.article_author = Some(author)
        og
    }
    
    fn product(title: String) -> Self {
        var og = OpenGraph.new(title)
        og.og_type = OgType.Product
        og
    }
    
    fn with_description(desc: String) -> Self {
        self.description = Some(desc)
        self
    }
    
    fn with_url(url: String) -> Self {
        self.url = Some(url)
        self
    }
    
    fn with_image(url: String, width: Option<Int>, height: Option<Int>) -> Self {
        self.image = Some(url)
        self.image_width = width
        self.image_height = height
        self
    }
    
    fn with_site_name(name: String) -> Self {
        self.site_name = Some(name)
        self
    }
    
    fn with_locale(locale: String) -> Self {
        self.locale = Some(locale)
        self
    }
    
    fn with_article_dates(published: DateTime, modified: Option<DateTime>) -> Self {
        self.article_published = Some(published)
        self.article_modified = modified
        self
    }
    
    fn with_article_tags(tags: [String]) -> Self {
        self.article_tags = tags
        self
    }
    
    fn render_html() -> String {
        var tags: [String] = []
        
        tags.push(format!("<meta property=\"og:type\" content=\"{}\">", self.og_type.to_string()))
        tags.push(format!("<meta property=\"og:title\" content=\"{}\">", escape_html(self.title.clone())))
        
        if let Some(desc) = self.description.clone() {
            tags.push(format!("<meta property=\"og:description\" content=\"{}\">", escape_html(desc)))
        }
        
        if let Some(url) = self.url.clone() {
            tags.push(format!("<meta property=\"og:url\" content=\"{}\">", url))
        }
        
        if let Some(image) = self.image.clone() {
            tags.push(format!("<meta property=\"og:image\" content=\"{}\">", image))
            
            if let Some(w) = self.image_width {
                tags.push(format!("<meta property=\"og:image:width\" content=\"{}\">", w))
            }
            if let Some(h) = self.image_height {
                tags.push(format!("<meta property=\"og:image:height\" content=\"{}\">", h))
            }
            if let Some(alt) = self.image_alt.clone() {
                tags.push(format!("<meta property=\"og:image:alt\" content=\"{}\">", escape_html(alt)))
            }
        }
        
        if let Some(site) = self.site_name.clone() {
            tags.push(format!("<meta property=\"og:site_name\" content=\"{}\">", escape_html(site)))
        }
        
        if let Some(locale) = self.locale.clone() {
            tags.push(format!("<meta property=\"og:locale\" content=\"{}\">", locale))
        }
        
        // Article specific
        if matches!(self.og_type, OgType.Article) {
            if let Some(author) = self.article_author.clone() {
                tags.push(format!("<meta property=\"article:author\" content=\"{}\">", escape_html(author)))
            }
            if let Some(published) = self.article_published {
                tags.push(format!("<meta property=\"article:published_time\" content=\"{}\">", published.to_iso8601()))
            }
            if let Some(modified) = self.article_modified {
                tags.push(format!("<meta property=\"article:modified_time\" content=\"{}\">", modified.to_iso8601()))
            }
            if let Some(section) = self.article_section.clone() {
                tags.push(format!("<meta property=\"article:section\" content=\"{}\">", escape_html(section)))
            }
            for tag in self.article_tags.iter() {
                tags.push(format!("<meta property=\"article:tag\" content=\"{}\">", escape_html(tag.clone())))
            }
        }
        
        tags.join("\n")
    }
}

// =============================================================================
// Twitter Cards
// =============================================================================

/// Twitter Card meta data
struct TwitterMeta {
    card: TwitterCard,
    site: Option<String>,
    creator: Option<String>,
    title: Option<String>,
    description: Option<String>,
    image: Option<String>,
    image_alt: Option<String>
}

impl TwitterMeta {
    fn summary(title: String) -> Self {
        TwitterMeta {
            card: TwitterCard.Summary,
            site: None,
            creator: None,
            title: Some(title),
            description: None,
            image: None,
            image_alt: None
        }
    }
    
    fn large_image(title: String, image: String) -> Self {
        TwitterMeta {
            card: TwitterCard.SummaryLargeImage,
            site: None,
            creator: None,
            title: Some(title),
            description: None,
            image: Some(image),
            image_alt: None
        }
    }
    
    fn with_site(site: String) -> Self {
        self.site = Some(site)
        self
    }
    
    fn with_creator(creator: String) -> Self {
        self.creator = Some(creator)
        self
    }
    
    fn with_description(desc: String) -> Self {
        self.description = Some(desc)
        self
    }
    
    fn with_image(url: String, alt: Option<String>) -> Self {
        self.image = Some(url)
        self.image_alt = alt
        self
    }
    
    fn render_html() -> String {
        var tags: [String] = []
        
        tags.push(format!("<meta name=\"twitter:card\" content=\"{}\">", self.card.to_string()))
        
        if let Some(site) = self.site.clone() {
            tags.push(format!("<meta name=\"twitter:site\" content=\"{}\">", site))
        }
        
        if let Some(creator) = self.creator.clone() {
            tags.push(format!("<meta name=\"twitter:creator\" content=\"{}\">", creator))
        }
        
        if let Some(title) = self.title.clone() {
            tags.push(format!("<meta name=\"twitter:title\" content=\"{}\">", escape_html(title)))
        }
        
        if let Some(desc) = self.description.clone() {
            tags.push(format!("<meta name=\"twitter:description\" content=\"{}\">", escape_html(desc)))
        }
        
        if let Some(image) = self.image.clone() {
            tags.push(format!("<meta name=\"twitter:image\" content=\"{}\">", image))
            
            if let Some(alt) = self.image_alt.clone() {
                tags.push(format!("<meta name=\"twitter:image:alt\" content=\"{}\">", escape_html(alt)))
            }
        }
        
        tags.join("\n")
    }
}

// =============================================================================
// Structured Data (JSON-LD)
// =============================================================================

/// Schema.org type
enum SchemaType {
    WebSite,
    WebPage,
    Article,
    BlogPosting,
    Product,
    Organization,
    Person,
    BreadcrumbList,
    FAQPage,
    HowTo,
    LocalBusiness,
    Event,
    Recipe,
    Review,
    VideoObject,
    Custom(String)
}

impl SchemaType {
    fn to_string() -> String {
        match self {
            SchemaType.WebSite => "WebSite",
            SchemaType.WebPage => "WebPage",
            SchemaType.Article => "Article",
            SchemaType.BlogPosting => "BlogPosting",
            SchemaType.Product => "Product",
            SchemaType.Organization => "Organization",
            SchemaType.Person => "Person",
            SchemaType.BreadcrumbList => "BreadcrumbList",
            SchemaType.FAQPage => "FAQPage",
            SchemaType.HowTo => "HowTo",
            SchemaType.LocalBusiness => "LocalBusiness",
            SchemaType.Event => "Event",
            SchemaType.Recipe => "Recipe",
            SchemaType.Review => "Review",
            SchemaType.VideoObject => "VideoObject",
            SchemaType.Custom(t) => t
        }
    }
}

/// JSON-LD structured data
struct JsonLd {
    schema_type: SchemaType,
    properties: Map<String, JsonValue>
}

/// JSON value for structured data
enum JsonValue {
    String(String),
    Number(Float),
    Bool(Bool),
    Array([JsonValue]),
    Object(Map<String, JsonValue>),
    Null
}

impl JsonLd {
    fn new(schema_type: SchemaType) -> Self {
        JsonLd {
            schema_type: schema_type,
            properties: Map.empty()
        }
    }
    
    fn website(name: String, url: String) -> Self {
        var ld = JsonLd.new(SchemaType.WebSite)
        ld.set("name", JsonValue.String(name))
        ld.set("url", JsonValue.String(url))
        ld
    }
    
    fn article(headline: String, author: String, published: DateTime) -> Self {
        var ld = JsonLd.new(SchemaType.Article)
        ld.set("headline", JsonValue.String(headline))
        ld.set("author", JsonValue.Object(Map.from([
            ("@type", JsonValue.String("Person")),
            ("name", JsonValue.String(author))
        ])))
        ld.set("datePublished", JsonValue.String(published.to_iso8601()))
        ld
    }
    
    fn organization(name: String, url: String, logo: Option<String>) -> Self {
        var ld = JsonLd.new(SchemaType.Organization)
        ld.set("name", JsonValue.String(name))
        ld.set("url", JsonValue.String(url))
        if let Some(l) = logo {
            ld.set("logo", JsonValue.String(l))
        }
        ld
    }
    
    fn breadcrumbs(items: [(String, String)]) -> Self {
        var ld = JsonLd.new(SchemaType.BreadcrumbList)
        
        let list_items: [JsonValue] = items.iter().enumerate().map(|(i, (name, url))| {
            JsonValue.Object(Map.from([
                ("@type", JsonValue.String("ListItem")),
                ("position", JsonValue.Number((i + 1) as Float)),
                ("name", JsonValue.String(name.clone())),
                ("item", JsonValue.String(url.clone()))
            ]))
        }).collect()
        
        ld.set("itemListElement", JsonValue.Array(list_items))
        ld
    }
    
    fn faq(questions: [(String, String)]) -> Self {
        var ld = JsonLd.new(SchemaType.FAQPage)
        
        let items: [JsonValue] = questions.iter().map(|(q, a)| {
            JsonValue.Object(Map.from([
                ("@type", JsonValue.String("Question")),
                ("name", JsonValue.String(q.clone())),
                ("acceptedAnswer", JsonValue.Object(Map.from([
                    ("@type", JsonValue.String("Answer")),
                    ("text", JsonValue.String(a.clone()))
                ])))
            ]))
        }).collect()
        
        ld.set("mainEntity", JsonValue.Array(items))
        ld
    }
    
    fn product(name: String, description: String, price: Float, currency: String) -> Self {
        var ld = JsonLd.new(SchemaType.Product)
        ld.set("name", JsonValue.String(name))
        ld.set("description", JsonValue.String(description))
        ld.set("offers", JsonValue.Object(Map.from([
            ("@type", JsonValue.String("Offer")),
            ("price", JsonValue.Number(price)),
            ("priceCurrency", JsonValue.String(currency))
        ])))
        ld
    }
    
    fn set(key: String, value: JsonValue) {
        self.properties.set(key, value)
    }
    
    fn render_json() -> String {
        var obj = Map.from([
            ("@context", JsonValue.String("https://schema.org")),
            ("@type", JsonValue.String(self.schema_type.to_string()))
        ])
        
        for (k, v) in self.properties.iter() {
            obj.set(k.clone(), v.clone())
        }
        
        json_stringify(JsonValue.Object(obj))
    }
    
    fn render_html() -> String {
        format!("<script type=\"application/ld+json\">\n{}\n</script>", self.render_json())
    }
}

fn json_stringify(value: JsonValue) -> String {
    match value {
        JsonValue.String(s) => format!("\"{}\"", escape_json(s)),
        JsonValue.Number(n) => n.to_string(),
        JsonValue.Bool(b) => if b { "true" } else { "false" },
        JsonValue.Null => "null",
        JsonValue.Array(arr) => {
            let items = arr.iter().map(|v| json_stringify(v.clone())).join(", ")
            format!("[{}]", items)
        },
        JsonValue.Object(obj) => {
            let pairs = obj.iter().map(|(k, v)| format!("\"{}\": {}", k, json_stringify(v.clone()))).join(", ")
            format!("{{{}}}", pairs)
        }
    }
}

fn escape_json(s: String) -> String {
    s.replace("\\", "\\\\")
     .replace("\"", "\\\"")
     .replace("\n", "\\n")
     .replace("\r", "\\r")
     .replace("\t", "\\t")
}

// =============================================================================
// SEO Page Builder
// =============================================================================

/// Complete SEO configuration for a page
struct SeoPage {
    meta: SeoMeta,
    og: Option<OpenGraph>,
    twitter: Option<TwitterMeta>,
    structured_data: [JsonLd]
}

impl SeoPage {
    fn new(title: String) -> Self {
        SeoPage {
            meta: SeoMeta.new(title),
            og: None,
            twitter: None,
            structured_data: []
        }
    }
    
    fn with_meta(meta: SeoMeta) -> Self {
        self.meta = meta
        self
    }
    
    fn with_og(og: OpenGraph) -> Self {
        self.og = Some(og)
        self
    }
    
    fn with_twitter(twitter: TwitterMeta) -> Self {
        self.twitter = Some(twitter)
        self
    }
    
    fn add_structured_data(ld: JsonLd) {
        self.structured_data.push(ld)
    }
    
    fn render_html() -> String {
        var parts: [String] = [self.meta.render_html()]
        
        if let Some(og) = self.og.clone() {
            parts.push(og.render_html())
        }
        
        if let Some(twitter) = self.twitter.clone() {
            parts.push(twitter.render_html())
        }
        
        for ld in self.structured_data.iter() {
            parts.push(ld.render_html())
        }
        
        parts.join("\n")
    }
}

/// SEO page builder
struct SeoBuilder {
    page: SeoPage
}

impl SeoBuilder {
    fn new(title: String) -> Self {
        SeoBuilder { page: SeoPage.new(title) }
    }
    
    fn description(desc: String) -> Self {
        self.page.meta.description = Some(desc.clone())
        
        if self.page.og.is_none() {
            self.page.og = Some(OpenGraph.new(self.page.meta.title.clone()))
        }
        if let Some(og) = self.page.og.as_mut() {
            og.description = Some(desc.clone())
        }
        
        if self.page.twitter.is_none() {
            self.page.twitter = Some(TwitterMeta.summary(self.page.meta.title.clone()))
        }
        if let Some(tw) = self.page.twitter.as_mut() {
            tw.description = Some(desc)
        }
        
        self
    }
    
    fn keywords(keywords: [String]) -> Self {
        self.page.meta.keywords = keywords
        self
    }
    
    fn canonical(url: String) -> Self {
        self.page.meta.canonical = Some(url.clone())
        
        if let Some(og) = self.page.og.as_mut() {
            og.url = Some(url)
        }
        
        self
    }
    
    fn image(url: String, width: Option<Int>, height: Option<Int>) -> Self {
        if self.page.og.is_none() {
            self.page.og = Some(OpenGraph.new(self.page.meta.title.clone()))
        }
        if let Some(og) = self.page.og.as_mut() {
            og.image = Some(url.clone())
            og.image_width = width
            og.image_height = height
        }
        
        if self.page.twitter.is_none() {
            self.page.twitter = Some(TwitterMeta.large_image(self.page.meta.title.clone(), url.clone()))
        } else if let Some(tw) = self.page.twitter.as_mut() {
            tw.image = Some(url)
            tw.card = TwitterCard.SummaryLargeImage
        }
        
        self
    }
    
    fn noindex() -> Self {
        self.page.meta.robots = [RobotsDirective.NoIndex, RobotsDirective.NoFollow]
        self
    }
    
    fn article(author: String, published: DateTime) -> Self {
        self.page.og = Some(OpenGraph.article(self.page.meta.title.clone(), author.clone())
            .with_description(self.page.meta.description.clone().unwrap_or("")))
        
        let ld = JsonLd.article(self.page.meta.title.clone(), author, published)
        self.page.structured_data.push(ld)
        
        self
    }
    
    fn breadcrumbs(items: [(String, String)]) -> Self {
        let ld = JsonLd.breadcrumbs(items)
        self.page.structured_data.push(ld)
        self
    }
    
    fn faq(questions: [(String, String)]) -> Self {
        let ld = JsonLd.faq(questions)
        self.page.structured_data.push(ld)
        self
    }
    
    fn twitter_site(site: String) -> Self {
        if self.page.twitter.is_none() {
            self.page.twitter = Some(TwitterMeta.summary(self.page.meta.title.clone()))
        }
        if let Some(tw) = self.page.twitter.as_mut() {
            tw.site = Some(site)
        }
        self
    }
    
    fn site_name(name: String) -> Self {
        if self.page.og.is_none() {
            self.page.og = Some(OpenGraph.new(self.page.meta.title.clone()))
        }
        if let Some(og) = self.page.og.as_mut() {
            og.site_name = Some(name)
        }
        self
    }
    
    fn build() -> SeoPage {
        self.page
    }
}

// =============================================================================
// Helper Functions
// =============================================================================

fn escape_html(s: String) -> String {
    s.replace("&", "&amp;")
     .replace("<", "&lt;")
     .replace(">", "&gt;")
     .replace("\"", "&quot;")
     .replace("'", "&#39;")
}

// =============================================================================
// Tests
// =============================================================================

test "seo meta" {
    let meta = SeoMeta.new("Page Title")
        .with_description("Page description")
        .with_canonical("https://example.com/page")
    
    let html = meta.render_html()
    assert(html.contains("<title>Page Title</title>"))?
    assert(html.contains("description"))?
}

test "open graph" {
    let og = OpenGraph.article("Article Title", "John Doe")
        .with_description("Article description")
        .with_image("https://example.com/image.jpg", Some(1200), Some(630))
    
    let html = og.render_html()
    assert(html.contains("og:type"))?
    assert(html.contains("article"))?
}

test "twitter card" {
    let twitter = TwitterMeta.large_image("Title", "https://example.com/image.jpg")
        .with_site("@example")
    
    let html = twitter.render_html()
    assert(html.contains("twitter:card"))?
    assert(html.contains("summary_large_image"))?
}

test "json-ld breadcrumbs" {
    let ld = JsonLd.breadcrumbs([
        ("Home", "https://example.com"),
        ("Category", "https://example.com/category"),
        ("Page", "https://example.com/category/page")
    ])
    
    let json = ld.render_json()
    assert(json.contains("BreadcrumbList"))?
}

test "seo builder" {
    let seo = SeoBuilder.new("My Page")
        .description("Page description")
        .canonical("https://example.com/page")
        .image("https://example.com/image.jpg", Some(1200), Some(630))
        .twitter_site("@mysite")
        .build()
    
    let html = seo.render_html()
    assert(html.contains("og:image"))?
    assert(html.contains("twitter:site"))?
}
