// =============================================================================
// Vibee OS â€” Presentation Module
// Generic presentation creation and manipulation
// =============================================================================

use image::Image

// =============================================================================
// Presentation
// =============================================================================

/// Generic presentation
struct Presentation {
    slides: [Slide]
    theme: Theme
    size: PresentationSize
}

impl Presentation {
    fn new() -> Self { Presentation { slides: [], theme: Theme.default(), size: PresentationSize.widescreen() } }
    
    fn add_slide() -> Slide { let s = Slide.new(); self.slides.push(s.clone()); s }
    fn add_title_slide(title: String, subtitle: String) -> Slide {
        let s = Slide.title(title, subtitle); self.slides.push(s.clone()); s
    }
    fn add_content_slide(title: String, content: String) -> Slide {
        let s = Slide.content(title, content); self.slides.push(s.clone()); s
    }
    fn add_image_slide(title: String, image_path: String) -> Slide {
        let s = Slide.with_image(title, image_path); self.slides.push(s.clone()); s
    }
    
    fn slide(index: Int) -> Option<Slide> { self.slides.get(index).cloned() }
    fn slide_count() -> Int { self.slides.len() }
    fn remove_slide(index: Int) { if index < self.slides.len() { self.slides.remove(index) } }
    fn move_slide(from: Int, to: Int) { if from < self.slides.len() && to < self.slides.len() { let s = self.slides.remove(from); self.slides.insert(to, s) } }
    
    fn set_theme(theme: Theme) { self.theme = theme }
    fn set_size(size: PresentationSize) { self.size = size }
}

// =============================================================================
// Slide
// =============================================================================

struct Slide {
    elements: [SlideElement]
    background: Background
    notes: String
    transition: Transition
}

impl Slide {
    fn new() -> Self { Slide { elements: [], background: Background.Solid("#FFFFFF"), notes: "", transition: Transition.None } }
    
    fn title(title: String, subtitle: String) -> Self {
        let mut s = Self.new()
        s.add_text(title, 50.0, 200.0, 860.0, 100.0).font_size(44.0).bold().center()
        s.add_text(subtitle, 50.0, 320.0, 860.0, 60.0).font_size(24.0).center()
        s
    }
    
    fn content(title: String, content: String) -> Self {
        let mut s = Self.new()
        s.add_text(title, 50.0, 30.0, 860.0, 60.0).font_size(36.0).bold()
        s.add_text(content, 50.0, 110.0, 860.0, 400.0).font_size(18.0)
        s
    }
    
    fn with_image(title: String, image_path: String) -> Self {
        let mut s = Self.new()
        s.add_text(title, 50.0, 30.0, 860.0, 60.0).font_size(36.0).bold()
        s.add_image(image_path, 150.0, 120.0, 660.0, 380.0)
        s
    }
    
    fn add_text(text: String, x: Float64, y: Float64, w: Float64, h: Float64) -> TextElement {
        let elem = TextElement.new(text, x, y, w, h)
        self.elements.push(SlideElement.Text(elem.clone()))
        elem
    }
    
    fn add_image(path: String, x: Float64, y: Float64, w: Float64, h: Float64) -> ImageElement {
        let elem = ImageElement.new(path, x, y, w, h)
        self.elements.push(SlideElement.Image(elem.clone()))
        elem
    }
    
    fn add_shape(shape: ShapeType, x: Float64, y: Float64, w: Float64, h: Float64) -> ShapeElement {
        let elem = ShapeElement.new(shape, x, y, w, h)
        self.elements.push(SlideElement.Shape(elem.clone()))
        elem
    }
    
    fn add_bullet_list(items: [String], x: Float64, y: Float64) -> BulletList {
        let list = BulletList.new(items, x, y)
        self.elements.push(SlideElement.BulletList(list.clone()))
        list
    }
    
    fn set_background(bg: Background) { self.background = bg }
    fn set_notes(notes: String) { self.notes = notes }
    fn set_transition(t: Transition) { self.transition = t }
}

// =============================================================================
// Slide Elements
// =============================================================================

enum SlideElement { Text(TextElement), Image(ImageElement), Shape(ShapeElement), BulletList(BulletList) }

struct TextElement { text: String, x: Float64, y: Float64, width: Float64, height: Float64, style: TextStyle }

impl TextElement {
    fn new(text: String, x: Float64, y: Float64, w: Float64, h: Float64) -> Self {
        TextElement { text: text, x: x, y: y, width: w, height: h, style: TextStyle.default() }
    }
    fn font(name: String) -> Self { self.style.font = name; self }
    fn font_size(size: Float64) -> Self { self.style.size = size; self }
    fn bold() -> Self { self.style.bold = true; self }
    fn italic() -> Self { self.style.italic = true; self }
    fn color(c: String) -> Self { self.style.color = c; self }
    fn center() -> Self { self.style.align = TextAlign.Center; self }
    fn left() -> Self { self.style.align = TextAlign.Left; self }
    fn right() -> Self { self.style.align = TextAlign.Right; self }
}

struct TextStyle { font: String, size: Float64, bold: Bool, italic: Bool, color: String, align: TextAlign }
impl TextStyle { fn default() -> Self { TextStyle { font: "Arial", size: 18.0, bold: false, italic: false, color: "#000000", align: TextAlign.Left } } }
enum TextAlign { Left, Center, Right }

struct ImageElement { path: String, x: Float64, y: Float64, width: Float64, height: Float64 }
impl ImageElement {
    fn new(path: String, x: Float64, y: Float64, w: Float64, h: Float64) -> Self { ImageElement { path: path, x: x, y: y, width: w, height: h } }
    fn resize(w: Float64, h: Float64) -> Self { self.width = w; self.height = h; self }
}

struct ShapeElement { shape_type: ShapeType, x: Float64, y: Float64, width: Float64, height: Float64, fill: String, border: String }
impl ShapeElement {
    fn new(t: ShapeType, x: Float64, y: Float64, w: Float64, h: Float64) -> Self { ShapeElement { shape_type: t, x: x, y: y, width: w, height: h, fill: "#FFFFFF", border: "#000000" } }
    fn fill(c: String) -> Self { self.fill = c; self }
    fn border(c: String) -> Self { self.border = c; self }
}
enum ShapeType { Rectangle, Ellipse, Triangle, Arrow, Star, Line }

struct BulletList { items: [String], x: Float64, y: Float64, style: BulletStyle }
impl BulletList {
    fn new(items: [String], x: Float64, y: Float64) -> Self { BulletList { items: items, x: x, y: y, style: BulletStyle.Disc } }
    fn style(s: BulletStyle) -> Self { self.style = s; self }
}
enum BulletStyle { Disc, Circle, Square, Number, Letter }

// =============================================================================
// Theme and Background
// =============================================================================

struct Theme { name: String, primary: String, secondary: String, background: String, text: String, accent: String }
impl Theme {
    fn default() -> Self { Theme { name: "Default", primary: "#1a73e8", secondary: "#4285f4", background: "#FFFFFF", text: "#202124", accent: "#ea4335" } }
    fn dark() -> Self { Theme { name: "Dark", primary: "#8ab4f8", secondary: "#669df6", background: "#202124", text: "#e8eaed", accent: "#f28b82" } }
    fn corporate() -> Self { Theme { name: "Corporate", primary: "#1a237e", secondary: "#3949ab", background: "#FFFFFF", text: "#212121", accent: "#ff5722" } }
}

enum Background { Solid(String), Gradient(String, String, GradientDirection), Image(String) }
enum GradientDirection { Horizontal, Vertical, Diagonal }

enum Transition { None, Fade, Slide, Zoom, Flip }

struct PresentationSize { width: Float64, height: Float64 }
impl PresentationSize {
    fn standard() -> Self { PresentationSize { width: 720.0, height: 540.0 } }
    fn widescreen() -> Self { PresentationSize { width: 960.0, height: 540.0 } }
}

// =============================================================================
// Presentation Builder
// =============================================================================

actor PresentationBuilder {
    state pres: Presentation
    
    init() { self.pres = Presentation.new() }
    
    on theme(t: Theme) -> Self { self.pres.set_theme(t); self }
    on size(s: PresentationSize) -> Self { self.pres.set_size(s); self }
    on title_slide(title: String, subtitle: String) -> Self { self.pres.add_title_slide(title, subtitle); self }
    on content_slide(title: String, content: String) -> Self { self.pres.add_content_slide(title, content); self }
    on image_slide(title: String, path: String) -> Self { self.pres.add_image_slide(title, path); self }
    on build() -> Presentation { self.pres }
}

// =============================================================================
// Convenience Functions
// =============================================================================

fn new() -> Presentation { Presentation.new() }
fn builder() -> PresentationBuilder { PresentationBuilder.new() }

// =============================================================================
// Tests
// =============================================================================

test "presentation creation" {
    let pres = Presentation.new()
    pres.add_title_slide("Hello", "World")
    assert_eq(pres.slide_count(), 1)?
}

test "builder pattern" {
    let pres = PresentationBuilder.new()
        .theme(Theme.dark())
        .title_slide("Title", "Subtitle")
        .content_slide("Content", "Body text")
        .build()
    assert_eq(pres.slide_count(), 2)?
}

test "themes" {
    let dark = Theme.dark()
    assert_eq(dark.background, "#202124")?
}
