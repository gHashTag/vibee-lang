# VIBEE Dogfooding System

Automated enforcement of spec-driven development for VIBEE framework.

## Overview

The dogfooding system ensures all code in `honeycomb/` is generated from `.vibee` specifications, preventing manual code that bypasses the spec-driven workflow.

## Components

### 1. Scanner (`scanner.gleam`)
Detects violations in Gleam files:
- **NoManualCode**: Manual implementations instead of generated code
- **MissingSpec**: No corresponding `.vibee` spec file
- **OutdatedCode**: Generated code older than spec
- **InvalidGeneration**: Malformed generation markers

### 2. Auto-Fix (`autofix.gleam`)
Automatically fixes violations:
- Regenerates code from specs using `vibeec gen`
- Creates backups before modifications
- Validates fixes and rolls back on failure
- Batch processing for multiple files

### 3. Git Hooks (`hooks.gleam`)
Prevents violations from being committed:
- **Pre-commit**: Scans staged files
- **Pre-push**: Scans all honeycomb/ files
- Bypass with `--no-verify` for emergencies

### 4. File Watcher (`watcher.gleam`)
Real-time monitoring (future):
- Watches honeycomb/ for changes
- Debounces rapid saves
- Triggers automatic scans
- Cross-platform (Linux, macOS, Windows)

### 5. CLI (`cli.gleam`)
Command-line interface:
```bash
gleam run -m honeycomb/dogfooding/cli -- <command>
```

## Installation

### Quick Setup
```bash
# Install git hooks
gleam run -m honeycomb/dogfooding/cli -- install-hooks

# Verify installation
gleam run -m honeycomb/dogfooding/cli -- status
```

### Manual Setup
1. Ensure you're in a git repository
2. Run the install command above
3. Hooks will be installed in `.git/hooks/`

## Usage

### Scan for Violations
```bash
# Scan specific file
gleam run -m honeycomb/dogfooding/cli -- scan honeycomb/agent/core.gleam

# Scan directory
gleam run -m honeycomb/dogfooding/cli -- scan honeycomb/

# Scan all honeycomb/
gleam run -m honeycomb/dogfooding/cli -- scan honeycomb/
```

### Auto-Fix Violations
```bash
# Fix specific file
gleam run -m honeycomb/dogfooding/cli -- fix honeycomb/agent/core.gleam

# Fix all violations
gleam run -m honeycomb/dogfooding/cli -- fix honeycomb/
```

### Check Status
```bash
gleam run -m honeycomb/dogfooding/cli -- status
```

### Uninstall Hooks
```bash
gleam run -m honeycomb/dogfooding/cli -- uninstall-hooks
```

## Git Hooks Behavior

### Pre-Commit Hook
- Runs on `git commit`
- Scans only staged `.gleam` files in `honeycomb/`
- Blocks commit if violations found
- Bypass: `git commit --no-verify`

### Pre-Push Hook
- Runs on `git push`
- Scans all `.gleam` files in `honeycomb/`
- Blocks push if violations found
- Bypass: `git push --no-verify`

## Workflow

### Correct Workflow (No Violations)
1. Write `.vibee` spec in `specs/`
2. Generate code: `vibeec gen --spec specs/example.vibee`
3. Generated file includes marker: `// Generated by vibeec`
4. Commit and push normally

### Incorrect Workflow (Violations)
1. Manually write code in `honeycomb/`
2. Try to commit
3. Pre-commit hook detects violation
4. Commit blocked with error message

### Fixing Violations
```bash
# Option 1: Auto-fix
gleam run -m honeycomb/dogfooding/cli -- fix honeycomb/problem.gleam

# Option 2: Manual fix
# 1. Create spec: specs/problem.vibee
# 2. Generate: vibeec gen --spec specs/problem.vibee
# 3. Commit generated code
```

## Configuration

### Scanner Config
```gleam
ScanConfig(
  rules: [NoManualCode, MissingSpec, OutdatedCode],
  exclude_patterns: ["build/", ".git/", "gleam/src/"],
  auto_fix: False,
)
```

### Auto-Fix Config
```gleam
FixConfig(
  create_backups: True,
  validate_after_fix: True,
  rollback_on_failure: True,
  max_retries: 3,
)
```

### Watcher Config
```gleam
WatchConfig(
  path: "honeycomb/",
  recursive: True,
  debounce_ms: 200,
  filters: [...],
)
```

## Specifications

All components are defined in `.vibee` specs:
- `specs/scanner.vibee` - Violation detection
- `specs/autofix.vibee` - Automatic fixing
- `specs/hooks.vibee` - Git hooks
- `specs/watcher.vibee` - File watching

## Testing

```bash
# Run all tests
gleam test --module honeycomb/dogfooding/cli_test

# Run specific test
gleam test --module honeycomb/dogfooding/cli_test -- scanner_default_config_test
```

## Troubleshooting

### Hooks Not Running
```bash
# Check if hooks are executable
ls -la .git/hooks/pre-commit

# Make executable if needed
chmod +x .git/hooks/pre-commit
```

### False Positives
If scanner incorrectly flags generated code:
1. Ensure generation marker is present
2. Check marker format: `// Generated by vibeec`
3. Verify spec file exists

### Bypass Hooks (Emergency)
```bash
# Commit without checks
git commit --no-verify -m "Emergency fix"

# Push without checks
git push --no-verify
```

## Architecture

```
┌─────────────────────────────────────────────────┐
│                   CLI Interface                  │
│         (honeycomb/dogfooding/cli.gleam)        │
└─────────────────────────────────────────────────┘
                        │
        ┌───────────────┼───────────────┐
        │               │               │
        ▼               ▼               ▼
┌──────────────┐ ┌──────────────┐ ┌──────────────┐
│   Scanner    │ │   Auto-Fix   │ │  Git Hooks   │
│ scanner.gleam│ │autofix.gleam │ │ hooks.gleam  │
└──────────────┘ └──────────────┘ └──────────────┘
        │               │               │
        └───────────────┼───────────────┘
                        │
                        ▼
                ┌──────────────┐
                │   Watcher    │
                │watcher.gleam │
                └──────────────┘
```

## Future Enhancements

1. **Real-time Watcher**: Automatic scanning on file changes
2. **IDE Integration**: VSCode extension for inline violations
3. **CI/CD Integration**: GitHub Actions workflow
4. **Metrics Dashboard**: Violation trends over time
5. **Auto-Spec Generation**: Reverse-engineer specs from code

## Contributing

All code must be generated from specs:
1. Create/update `.vibee` spec
2. Generate code: `vibeec gen`
3. Test generated code
4. Commit both spec and generated code

## License

Part of VIBEE framework - see main LICENSE file.

## Author

Dmitrii Vasilev (VIBEE Framework)

## See Also

- [VIBEE Spec Format](../../VIBEE_SPEC_FORMAT.md)
- [Dogfooding Guide](../../DOGFOODING_NOW.md)
- [Academic Specification](../../docs/academic/VIBEE_FORMAL_SPECIFICATION.md)
