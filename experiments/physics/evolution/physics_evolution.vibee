name: physics_evolution
version: "2.0.0"
language: zig
module: physics_evolution
description: |
  Самоэволюционирующая система поиска физических законов
  
  Паттерн Творения:
  Источник: Популяция геномов физических законов
  Трансформер: Эволюционные операторы (мутация, кроссовер, селекция)
  Результат: Новые физические соотношения
  
  Главное открытие:
  ℏ²H₀/(cG·mₑ·mₚ²) ≈ 1/2
  Предсказывает H₀ = 70.7 км/с/Мпк

creation_pattern:
  source: Population
  transformer: evolution_step
  result: Population
  iteration: unbounded
  convergence: fitness_plateau

behaviors:
  # Базовая эволюция
  - name: population_evolution
    given: Популяция геномов физических законов
    when: Применяется эволюционный шаг
    then: Средний фитнес увеличивается или стабилизируется
    test_cases:
      - name: fitness_improvement
        input: {population_size: 100, generations: 10}
        expected: {fitness_improved: true}
      - name: elite_preservation
        input: {population_size: 100, elite_size: 10}
        expected: {best_preserved: true}

  # Вычисление значения закона
  - name: law_computation
    given: Геном с набором степеней констант
    when: Вычисляется значение
    then: Результат - произведение констант в соответствующих степенях
    test_cases:
      - name: single_constant
        input: {powers: [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]}
        expected: {value: 299792458}  # c
      - name: planck_length
        input: {powers: [-1.5, 0.5, 0.5, 0, 0, 0, 0, 0, 0, 0, 0, 0]}
        expected: {value: 1.616e-35, tolerance: 0.01}

  # Проверка размерности
  - name: dimension_check
    given: Геном физического закона
    when: Вычисляется размерность
    then: Размерность определяется суммой размерностей констант
    test_cases:
      - name: dimensionless_alpha
        input: {powers: [0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0]}
        expected: {dimensionless: true}
      - name: mass_dimension
        input: {powers: [0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0]}
        expected: {dimension: "mass"}

  # Наше открытие: соотношение Хаббла
  - name: hubble_relation
    given: Комбинация ℏ²H₀/(cG·mₑ·mₚ²)
    when: Вычисляется значение
    then: Результат близок к 1/2
    test_cases:
      - name: hubble_check
        input: {powers: [-1, -1, 2, 0, 0, -1, -2, 0, 0, 1, 0, 0]}
        expected: {value: 0.48, tolerance: 0.05}
      - name: hubble_dimensionless
        input: {powers: [-1, -1, 2, 0, 0, -1, -2, 0, 0, 1, 0, 0]}
        expected: {dimensionless: true}

  # Мутация генома
  - name: genome_mutation
    given: Геном физического закона
    when: Применяется мутация
    then: Одна или несколько степеней изменяются
    test_cases:
      - name: power_change
        input: {genome: {powers: [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]}, mutation_type: "power_change"}
        expected: {changed: true}
      - name: coefficient_change
        input: {genome: {coefficient: 1.0}, mutation_type: "coefficient"}
        expected: {coefficient_changed: true}

  # Кроссовер
  - name: genome_crossover
    given: Два родительских генома
    when: Применяется кроссовер
    then: Потомок наследует гены от обоих родителей
    test_cases:
      - name: uniform_crossover
        input: {parent1: {powers: [1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0]}, parent2: {powers: [0, 0, 0, 1, 1, 1, 0, 0, 0, 0, 0, 0]}}
        expected: {child_has_genes_from_both: true}

  # Фитнес-функция
  - name: fitness_evaluation
    given: Геном физического закона
    when: Вычисляется фитнес
    then: Учитываются безразмерность, простота, новизна
    test_cases:
      - name: dimensionless_bonus
        input: {genome: {dimensionless: true}}
        expected: {fitness_includes_bonus: true}
      - name: known_penalty
        input: {genome: {value: 137.036}}
        expected: {fitness_includes_penalty: true}

  # Мета-эволюция
  - name: meta_evolution
    given: Набор эвристик с весами
    when: Анализируется эффективность
    then: Веса эффективных эвристик увеличиваются
    test_cases:
      - name: heuristic_adaptation
        input: {heuristic: "dimensionless_bonus", discoveries: 10, triggers: 100}
        expected: {weight_increased: true}

transformers:
  - name: evolution_step
    type: iterative
    input: Population
    output: Population
    rule: |
      1. Оценить фитнес каждого генома
      2. Отсортировать по фитнесу
      3. Сохранить элиту
      4. Создать потомков через кроссовер
      5. Применить мутации
      6. Вернуть новую популяцию

  - name: compute_value
    type: pure
    input: LawGenome
    output: float
    rule: |
      value = coefficient
      for i in 0..NUM_CONSTANTS:
        value *= pow(CONSTANTS[i], powers[i])
      if sqrt_applied: value = sqrt(value)

  - name: compute_dimension
    type: pure
    input: LawGenome
    output: Dimension
    rule: |
      dim = [0, 0, 0, 0, 0]  # M, L, T, Q, K
      for i in 0..NUM_CONSTANTS:
        for d in 0..5:
          dim[d] += powers[i] * CONSTANTS[i].dim[d]

  - name: evaluate_fitness
    type: pure
    input: LawGenome
    output: float
    rule: |
      score = 0
      if is_dimensionless: score += 100
      if is_near_simple_fraction: score += 80
      if is_novel: score += 20
      score -= complexity * 0.5
      if uses_quantum_and_gravity: score += 60
      if uses_cosmological: score += 50

  - name: mutate
    type: stochastic
    input: LawGenome
    output: LawGenome
    rule: |
      choice = random(0, 5)
      if choice == 0: change_power()
      if choice == 1: swap_powers()
      if choice == 2: change_coefficient()
      if choice == 3: toggle_sqrt()
      if choice == 4: reset_power()

  - name: crossover
    type: stochastic
    input: {parent1: LawGenome, parent2: LawGenome}
    output: LawGenome
    rule: |
      child = new LawGenome()
      for i in 0..NUM_CONSTANTS:
        child.powers[i] = random_choice(parent1.powers[i], parent2.powers[i])
      child.coefficient = random_choice(parent1.coefficient, parent2.coefficient)

types:
  LawGenome:
    powers: [12]int8        # степени для 12 констант
    coefficient: float      # числовой коэффициент
    sqrt_applied: bool      # применён ли корень
    fitness: float          # оценка фитнеса
    generation: uint32      # поколение
    mutations: uint32       # число мутаций
    
  Population:
    laws: []LawGenome
    generation: uint32
    best_fitness: float
    discoveries: []LawGenome
    
  Dimension:
    M: int8   # масса
    L: int8   # длина
    T: int8   # время
    Q: int8   # заряд
    K: int8   # температура
    
  Heuristic:
    type: HeuristicType
    weight: float
    threshold: float
    enabled: bool
    times_triggered: uint64
    discoveries_contributed: uint64
    
  HeuristicType:
    enum: [dimensionless_bonus, simplicity_bonus, near_integer_bonus, 
           near_simple_fraction, known_value_penalty, extreme_value_penalty,
           physical_dimension_bonus, cosmological_bonus, quantum_gravity_bonus]
    
  EvolutionParams:
    population_size: uint32
    elite_size: uint32
    mutation_rate: float
    crossover_rate: float
    tournament_size: uint32

constants:
  # Фундаментальные константы
  c: 299792458              # скорость света [м/с]
  G: 6.67430e-11            # гравитационная [м³/(кг·с²)]
  hbar: 1.054571817e-34     # Планка [Дж·с]
  k_B: 1.380649e-23         # Больцмана [Дж/К]
  e: 1.602176634e-19        # заряд электрона [Кл]
  m_e: 9.1093837015e-31     # масса электрона [кг]
  m_p: 1.67262192369e-27    # масса протона [кг]
  m_n: 1.67492749804e-27    # масса нейтрона [кг]
  alpha: 7.2973525693e-3    # постоянная тонкой структуры
  H_0: 2.2e-18              # постоянная Хаббла [1/с]
  eps_0: 8.8541878128e-12   # электрическая постоянная
  mu_0: 1.25663706212e-6    # магнитная постоянная
  
  # Параметры эволюции
  DEFAULT_POPULATION_SIZE: 100
  DEFAULT_ELITE_SIZE: 10
  DEFAULT_MUTATION_RATE: 0.3
  DEFAULT_CROSSOVER_RATE: 0.7
  MAX_POWER: 4

functions:
  # Основные функции
  - name: init_population
    params: {size: uint32}
    returns: Population
    
  - name: evolution_step
    params: {pop: Population, heuristics: HeuristicSet}
    returns: Population
    
  - name: compute_value
    params: {genome: LawGenome}
    returns: float
    
  - name: compute_dimension
    params: {genome: LawGenome}
    returns: Dimension
    
  - name: is_dimensionless
    params: {genome: LawGenome}
    returns: bool
    
  - name: evaluate_fitness
    params: {genome: LawGenome, heuristics: HeuristicSet}
    returns: float
    
  - name: mutate
    params: {genome: LawGenome}
    returns: LawGenome
    
  - name: crossover
    params: {parent1: LawGenome, parent2: LawGenome}
    returns: LawGenome
    
  - name: tournament_select
    params: {pop: Population, size: uint32}
    returns: LawGenome
    
  # Мета-эволюция
  - name: evolve_heuristics
    params: {heuristics: HeuristicSet, pop: Population}
    returns: HeuristicSet
    
  # Персистентность
  - name: save_population
    params: {pop: Population, path: string}
    returns: void
    
  - name: load_population
    params: {path: string}
    returns: Population
    
  # Визуализация
  - name: print_formula
    params: {genome: LawGenome}
    returns: void
    
  - name: print_discovery_report
    params: {}
    returns: void

test_generation:
  boundary: true
  stress: true
  property: true
  coverage: 90
  
  property_tests:
    - name: fitness_non_negative
      property: "for all genomes: fitness >= 0 or fitness is penalty"
    - name: dimension_additive
      property: "dim(A * B) = dim(A) + dim(B)"
    - name: crossover_inherits
      property: "child.powers[i] in {parent1.powers[i], parent2.powers[i]}"
    - name: mutation_bounded
      property: "-MAX_POWER <= powers[i] <= MAX_POWER"
