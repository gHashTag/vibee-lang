<!DOCTYPE html>
<html>
<head>
  <title>BEAM Ultimate</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{background:#050508;color:#fff;font-family:monospace;display:flex;height:100vh}
    #main{flex:1;display:flex;align-items:center;justify-content:center}
    canvas{image-rendering:pixelated;cursor:crosshair}
    #ui{width:200px;background:#0a0a10;padding:15px;font-size:10px}
    h1{font-size:14px;color:#0af}
    h2{font-size:9px;color:#555;margin:12px 0 6px;text-transform:uppercase}
    .btn{display:block;width:100%;padding:8px;margin:3px 0;background:#151520;border:1px solid #252530;color:#888;cursor:pointer;border-radius:4px}
    .btn:hover{background:#1a1a2a}
    .btn.on{border-color:#0af;color:#fff}
    .row{display:flex;gap:3px}
    .row .btn{flex:1}
    #stats{color:#444;margin-top:15px;line-height:1.8}
    #stats b{color:#0af}
  </style>
</head>
<body>
<div id="main"><canvas id="c"></canvas></div>
<div id="ui">
  <h1>BEAM Ultimate</h1>
  <div style="color:#333;font-size:8px">FBM + Domain Warping + SSAO</div>
  
  <h2>Palette</h2>
  <div class="row">
    <button class="btn on" data-p="0">Sunset</button>
    <button class="btn" data-p="1">Ocean</button>
  </div>
  <div class="row">
    <button class="btn" data-p="2">Fire</button>
    <button class="btn" data-p="3">Neon</button>
  </div>
  
  <h2>Effect</h2>
  <button class="btn on" data-fx="fbm">FBM Noise</button>
  <button class="btn" data-fx="warp">Domain Warp</button>
  <button class="btn" data-fx="turb">Turbulence</button>
  <button class="btn" data-fx="ridge">Ridge</button>
  
  <h2>Post FX</h2>
  <button class="btn on" data-post="bloom">Bloom</button>
  <button class="btn on" data-post="ao">Ambient Occlusion</button>
  <button class="btn" data-post="dof">Depth of Field</button>
  <button class="btn" data-post="motion">Motion Blur</button>
  
  <div id="stats">
    <b id="fps">0</b> FPS<br>
    Time: <b id="time">0</b>s
  </div>
</div>

<script>
const S=160,SC=4,TAU=Math.PI*2;
const cv=document.getElementById('c');
cv.width=S;cv.height=S;
cv.style.width=S*SC+'px';cv.style.height=S*SC+'px';
const ctx=cv.getContext('2d');
const img=ctx.createImageData(S,S);
const prev=new Float32Array(S*S*3);

// Inigo Quilez Cosine Palettes
const palettes=[
  {a:[.5,.5,.5],b:[.5,.5,.5],c:[1,1,1],d:[0,.33,.67]},      // Sunset
  {a:[.5,.5,.5],b:[.5,.5,.5],c:[1,1,1],d:[0,.1,.2]},        // Ocean
  {a:[.5,.5,.5],b:[.5,.5,.5],c:[1,.7,.4],d:[0,.15,.2]},     // Fire
  {a:[.5,.5,.5],b:[.5,.5,.5],c:[2,1,0],d:[.5,.2,0]}         // Neon
];

function palette(t,p){
  return[
    p.a[0]+p.b[0]*Math.cos(TAU*(p.c[0]*t+p.d[0])),
    p.a[1]+p.b[1]*Math.cos(TAU*(p.c[1]*t+p.d[1])),
    p.a[2]+p.b[2]*Math.cos(TAU*(p.c[2]*t+p.d[2]))
  ];
}

// Simplex-like noise
function hash(x,y){const n=Math.sin(x*127.1+y*311.7)*43758.5453;return n-Math.floor(n)}
function noise(x,y){
  const i=Math.floor(x),j=Math.floor(y),f=x-i,g=y-j;
  const u=f*f*(3-2*f),v=g*g*(3-2*g);
  return(hash(i,j)*(1-u)+hash(i+1,j)*u)*(1-v)+(hash(i,j+1)*(1-u)+hash(i+1,j+1)*u)*v;
}

// FBM - Fractal Brownian Motion
function fbm(x,y,oct=6){
  let v=0,a=.5,f=1;
  for(let i=0;i<oct;i++){v+=a*noise(x*f,y*f);a*=.5;f*=2}
  return v;
}

// Turbulence (absolute FBM)
function turbulence(x,y,oct=6){
  let v=0,a=.5,f=1;
  for(let i=0;i<oct;i++){v+=a*Math.abs(noise(x*f,y*f)*2-1);a*=.5;f*=2}
  return v;
}

// Ridge noise
function ridge(x,y,oct=5){
  let v=0,a=.5,f=1,w=1;
  for(let i=0;i<oct;i++){
    let n=1-Math.abs(noise(x*f,y*f)*2-1);
    n=n*n*w;v+=a*n;w=n;a*=.5;f*=2;
  }
  return v;
}

// Domain Warping (Inigo Quilez)
function warp(x,y,t){
  const q=[fbm(x,y),fbm(x+5.2,y+1.3)];
  const r=[fbm(x+4*q[0]+1.7+t*.1,y+4*q[1]+9.2),fbm(x+4*q[0]+8.3,y+4*q[1]+2.8+t*.1)];
  return fbm(x+4*r[0],y+4*r[1]);
}

// Simple SSAO approximation
function ssao(x,y,depth,samples=8){
  let occ=0;
  for(let i=0;i<samples;i++){
    const a=i/samples*TAU;
    const r=.02;
    const sx=x+Math.cos(a)*r,sy=y+Math.sin(a)*r;
    const si=Math.floor(sx*S),sj=Math.floor(sy*S);
    if(si>=0&&si<S&&sj>=0&&sj<S){
      const sd=prev[(sj*S+si)*3];
      if(sd>depth+.01)occ+=1;
    }
  }
  return 1-occ/samples*.5;
}

let pal=0,fx='fbm',post={bloom:true,ao:true,dof:false,motion:false};
let mx=.5,my=.5,tm=0;

cv.onmousemove=e=>{const r=cv.getBoundingClientRect();mx=(e.clientX-r.left)/r.width;my=(e.clientY-r.top)/r.height};

document.querySelectorAll('[data-p]').forEach(b=>b.onclick=()=>{
  pal=+b.dataset.p;
  document.querySelectorAll('[data-p]').forEach(x=>x.classList.remove('on'));
  b.classList.add('on');
});
document.querySelectorAll('[data-fx]').forEach(b=>b.onclick=()=>{
  fx=b.dataset.fx;
  document.querySelectorAll('[data-fx]').forEach(x=>x.classList.remove('on'));
  b.classList.add('on');
});
document.querySelectorAll('[data-post]').forEach(b=>b.onclick=()=>{
  post[b.dataset.post]=!post[b.dataset.post];
  b.classList.toggle('on');
});

let lt=performance.now(),fc=0,ft=0;
function loop(){
  const now=performance.now(),dt=(now-lt)/1000;lt=now;tm+=dt;
  fc++;ft+=dt;if(ft>=1){document.getElementById('fps').textContent=fc;fc=0;ft=0}
  document.getElementById('time').textContent=tm.toFixed(1);
  
  const p=palettes[pal];
  
  for(let j=0;j<S;j++){
    for(let i=0;i<S;i++){
      const x=i/S*4,y=j/S*4;
      const cx=(mx-.5)*4,cy=(my-.5)*4;
      const dx=x-2-cx,dy=y-2-cy;
      const dist=Math.sqrt(dx*dx+dy*dy);
      
      let n;
      switch(fx){
        case'fbm':n=fbm(x+tm*.2,y+tm*.1);break;
        case'warp':n=warp(x,y,tm);break;
        case'turb':n=turbulence(x+tm*.1,y);break;
        case'ridge':n=ridge(x,y+tm*.1);break;
        default:n=fbm(x,y);
      }
      
      // Cursor influence
      n+=Math.exp(-dist*dist)*.3;
      
      // Depth (for SSAO)
      const depth=n;
      
      // Color from palette
      let c=palette(n+tm*.1,p);
      
      // SSAO
      if(post.ao){
        const ao=ssao(i/S,j/S,depth);
        c[0]*=ao;c[1]*=ao;c[2]*=ao;
      }
      
      // Motion blur
      if(post.motion){
        const idx=(j*S+i)*3;
        c[0]=c[0]*.7+prev[idx]*.3;
        c[1]=c[1]*.7+prev[idx+1]*.3;
        c[2]=c[2]*.7+prev[idx+2]*.3;
      }
      
      // DoF
      if(post.dof){
        const blur=Math.abs(depth-.5)*2;
        if(blur>.3){
          const ni=Math.floor(i+Math.sin(j*.5)*blur*2);
          const nj=Math.floor(j+Math.cos(i*.5)*blur*2);
          if(ni>=0&&ni<S&&nj>=0&&nj<S){
            const idx2=(nj*S+ni)*3;
            c[0]=c[0]*.5+prev[idx2]*.5;
            c[1]=c[1]*.5+prev[idx2+1]*.5;
            c[2]=c[2]*.5+prev[idx2+2]*.5;
          }
        }
      }
      
      // Store for next frame
      const idx=(j*S+i)*3;
      prev[idx]=c[0];prev[idx+1]=c[1];prev[idx+2]=c[2];
      
      // ACES tonemap
      const a=2.51,b=.03,d=2.43,e=.59,f=.14;
      c=c.map(v=>Math.max(0,Math.min(1,(v*(a*v+b))/(v*(d*v+e)+f))));
      
      const pi=(j*S+i)*4;
      img.data[pi]=c[0]*255;
      img.data[pi+1]=c[1]*255;
      img.data[pi+2]=c[2]*255;
      img.data[pi+3]=255;
    }
  }
  
  ctx.putImageData(img,0,0);
  
  // Bloom
  if(post.bloom){
    ctx.globalCompositeOperation='lighter';
    ctx.filter='blur(3px)';
    ctx.globalAlpha=.2;
    ctx.drawImage(cv,0,0);
    ctx.globalAlpha=1;
    ctx.filter='none';
    ctx.globalCompositeOperation='source-over';
  }
  
  requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>
