# Змей Горыныч v3 — Компилятор 999 с Макросами

## Архитектура

```
                    ЗМЕЙ ГОРЫНЫЧ v3
                    
     ┌─────┐   ┌─────┐   ┌─────┐
     │  Ⲅ  │   │  Ⲋ  │   │  Ⲑ  │
     │лексер│   │парсер│   │кодоген│
     └──┬──┘   └──┬──┘   └──┬──┘
        │         │         │
        └────┬────┴────┬────┘
             │    Ⲙ    │
          ┌──┴─────────┴──┐
          │    ЧЕШУЯ      │
          │  (макросы)    │
          └───────┬───────┘
                  │
          ┌───────┴───────┐
          │      Ⲭ        │
          │   ХВОСТ       │
          │ (оптимизатор) │
          └───────────────┘
```

## Поток компиляции

```
Исходник → Ⲅ → Токены → Ⲋ → AST → Ⲙ → AST' → Ⲭ → IR → Ⲑ → Код
   Ⲥ           [ⲨⲀ]          ⲨⲂ       ⲨⲂ'      ⲨⲄ       Ⲥ
```

## Компоненты

| Символ | Компонент | Файл | Строк |
|--------|-----------|------|-------|
| Ⲅ | Лексер | gorynych.999 | — |
| Ⲋ | Парсер | gorynych.999 | — |
| Ⲙ | Макросы | makrosy.999 + proc_makrosy.999 + gigiena.999 | 1112 |
| Ⲭ | Оптимизатор | hvost.999 + prohody.999 | 274 |
| Ⲑ | Кодоген | gorynych.999 | — |
| — | Типы | tipy.999 | 248 |
| — | Главный | gorynych.999 | 325 |
| **Σ** | **Всего** | **7 файлов** | **1913** |

## Хвост (Оптимизатор)

### Уровни оптимизации

| Флаг | Уровень | Проходы |
|------|---------|---------|
| -O0 | 0 | Без оптимизаций |
| -O1 | 1 | DCE |
| -O2 | 2 | DCE, CF |
| -O3 | 3 | DCE, CF, CP |
| -O4 | 4 | DCE, CF, CP, CSE |
| -O5 | 5 | DCE, CF, CP, CSE, INL |
| -O9 | 9 | Максимум (многопроходный) |

### Проходы оптимизации

| Символ | Проход | Описание |
|--------|--------|----------|
| Ⲁ | DCE | Удаление мёртвого кода |
| Ⲃ | CF | Свёртка констант |
| Ⲅ | CP | Распространение копий |
| Ⲇ | CSE | Устранение общих подвыражений |
| Ⲉ | INL | Инлайнинг функций |

### Пример оптимизации

**До (AST):**
```
Ⲙ x = 3 + 4
Ⲙ y = x * 2
Ⲙ z = 10
Ⲣ y
```

**После (IR, -O3):**
```
LOAD 14, r0    // 3+4=7, 7*2=14 — свёрнуто
RET r0         // z удалено (мёртвый код)
```

## Система типов

### Базовые типы

| Символ | Тип | Описание |
|--------|-----|----------|
| Ⲋ | число | 27-ричное целое |
| Ⲥ | слово | Строка |
| Ⲧ | троичное | Ⲁ/Ⲃ/Ⲯ |
| Ⲩ | структура | Составной тип |
| Ⲫ | действие | Функция |
| Ⲭ | пустота | void |
| Ⲯ | неведомо | unknown |

### Троичная логика

```
Ⲁ — истина (true)
Ⲃ — ложь (false)
Ⲯ — неведомо (unknown)
```

**Таблица И (&&):**
```
    Ⲁ  Ⲃ  Ⲯ
Ⲁ   Ⲁ  Ⲃ  Ⲯ
Ⲃ   Ⲃ  Ⲃ  Ⲃ
Ⲯ   Ⲯ  Ⲃ  Ⲯ
```

**Таблица ИЛИ (||):**
```
    Ⲁ  Ⲃ  Ⲯ
Ⲁ   Ⲁ  Ⲁ  Ⲁ
Ⲃ   Ⲁ  Ⲃ  Ⲯ
Ⲯ   Ⲁ  Ⲯ  Ⲯ
```

## Система макросов (Чешуя Ⲙ)

### Встроенные макросы

| Символ | Макрос | Описание |
|--------|--------|----------|
| @Ⲇ | derive | Автогенерация trait реализаций |
| @Ⲣ | route | HTTP маршруты |
| @Ⲧ | test | Тестовые функции |
| @Ⲕ | cache | Кэширование результатов |
| @Ⲃ | validate | Валидация полей |

### Процедурные макросы

| Макрос | Описание |
|--------|----------|
| `sql!()` | SQL запросы с проверкой на этапе компиляции |
| `html!()` | HTML шаблоны с интерполяцией |
| `json!()` | JSON литералы |
| `regex!()` | Компиляция regex на этапе компиляции |
| `format!()` | Форматирование строк |
| `include!()` | Включение файлов |
| `env!()` | Переменные окружения |
| `cfg!()` | Условная компиляция |

### Derive трейты

```
@Ⲇ(Entity)       — table_name, columns, from_row, to_row, id
@Ⲇ(Serialize)    — to_json, to_yaml, to_msgpack
@Ⲇ(Deserialize)  — from_json, from_yaml
@Ⲇ(Clone)        — clone
@Ⲇ(Debug)        — debug
@Ⲇ(Eq)           — eq, ne
@Ⲇ(Hash)         — hash
@Ⲇ(Default)      — default
@Ⲇ(Builder)      — with_*, build
```

### Пример использования

```
// Без макросов: ~50 строк boilerplate
// С макросами: 5 строк

@Ⲇ(Entity, Serialize, Clone, Debug)
Ⲏ User:
  id: Ⲋ
  name: Ⲥ
  email: Ⲥ

@Ⲣ(GET, "/users/:id")
@Ⲕ(ttl: 60)
Ⲫ get_user(req: Request) -> Response:
  Ⲙ user = sql!("SELECT * FROM users WHERE id = ?", req.params["id"])
  Ⲣ Response.json(user)
```

## Сравнение версий

| Версия | Язык | Строк | Компоненты | Оптимизация | Макросы |
|--------|------|-------|------------|-------------|---------|
| v0 | Zig | ~2630 | 3 головы | Нет | Нет |
| v1 | .vibee | ~1054 | 3 головы | Нет | Нет |
| v2 | .999 | 790 | 3 головы + хвост | 5 проходов | Нет |
| v3 | .999 | 1913 | 3 головы + чешуя + хвост | 5 проходов | 15+ макросов |

### Сжатие кода

```
v0 (Zig)   ████████████████████████████ 2630 строк
v1 (vibee) ██████████ 1054 строк (-60%)
v2 (999)   ███████ 790 строк (-70%)
v3 (999)   ███████████████ 1913 строк (с макросами)
```

### Сокращение boilerplate

```
Без макросов: ~100 строк на entity + routes
С макросами:  ~10 строк
Сокращение:   10x
```

## Использование

```bash
# Компиляция с оптимизацией по умолчанию (-O3)
./gorynych program.999

# Без оптимизации
./gorynych -O0 program.999

# Максимальная оптимизация
./gorynych -O9 program.999

# Генерация в разные цели
./gorynych --zig program.999
./gorynych --wasm program.999
./gorynych --python program.999
```

## Файлы

```
src/999/
├── gorynych.999      # Главный компилятор (325 строк)
├── makrosy.999       # Декларативные макросы (423 строки)
├── proc_makrosy.999  # Процедурные макросы (364 строки)
├── gigiena.999       # Гигиенические макросы (279 строк)
├── hvost.999         # Хвост — IR (92 строки)
├── prohody.999       # Проходы оптимизации (182 строки)
└── tipy.999          # Система типов (248 строк)
```

## Creation Pattern

```
Source → Transformer → Result

Ⲥ → Ⲅ → [ⲨⲀ]     # Лексер
[ⲨⲀ] → Ⲋ → ⲨⲂ    # Парсер
ⲨⲂ → Ⲭ → ⲨⲄ      # Оптимизатор (НОВОЕ!)
ⲨⲄ → Ⲑ → Ⲥ       # Кодоген
```
