#!/bin/bash
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# VIBEE AGENT - Self-Writing Code Terminal Agent
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Ï†Â² + 1/Ï†Â² = 3 | PHOENIX = 999
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Sacred constants
PHI="1.618033988749895"
PHOENIX="999"

# Config
MODEL="${VIBEE_MODEL:-claude-sonnet-4-20250514}"
MAX_TOKENS="${VIBEE_MAX_TOKENS:-4096}"
WORKDIR="${VIBEE_WORKDIR:-$(pwd)}"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# BANNER
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

print_banner() {
    echo -e "${MAGENTA}"
    echo "  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "  â•‘  VIBEE AGENT v1.0.0 - Self-Writing Code                   â•‘"
    echo "  â•‘  Ï†Â² + 1/Ï†Â² = 3 | PHOENIX = 999                            â•‘"
    echo "  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# CHECK API KEY
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

check_api_key() {
    if [ -z "$ANTHROPIC_API_KEY" ]; then
        echo -e "${RED}âŒ ANTHROPIC_API_KEY not set${NC}"
        echo ""
        echo "Set your API key:"
        echo "  export ANTHROPIC_API_KEY=sk-ant-your-key-here"
        echo ""
        exit 1
    fi
    echo -e "${GREEN}âœ… API key configured${NC}"
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# TOOLS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

TOOLS='[
  {
    "name": "read_file",
    "description": "Read contents of a file",
    "input_schema": {
      "type": "object",
      "properties": {
        "path": {"type": "string", "description": "File path to read"}
      },
      "required": ["path"]
    }
  },
  {
    "name": "write_file",
    "description": "Write content to a file",
    "input_schema": {
      "type": "object",
      "properties": {
        "path": {"type": "string", "description": "File path to write"},
        "content": {"type": "string", "description": "Content to write"}
      },
      "required": ["path", "content"]
    }
  },
  {
    "name": "run_command",
    "description": "Run a shell command",
    "input_schema": {
      "type": "object",
      "properties": {
        "command": {"type": "string", "description": "Command to execute"}
      },
      "required": ["command"]
    }
  },
  {
    "name": "list_files",
    "description": "List files in a directory",
    "input_schema": {
      "type": "object",
      "properties": {
        "path": {"type": "string", "description": "Directory path"}
      },
      "required": ["path"]
    }
  },
  {
    "name": "search_files",
    "description": "Search for text in files",
    "input_schema": {
      "type": "object",
      "properties": {
        "pattern": {"type": "string", "description": "Search pattern"},
        "path": {"type": "string", "description": "Directory to search"}
      },
      "required": ["pattern"]
    }
  }
]'

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# EXECUTE TOOL
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

execute_tool() {
    local tool_name="$1"
    local tool_input="$2"
    
    case "$tool_name" in
        "read_file")
            local path=$(echo "$tool_input" | jq -r '.path')
            if [ -f "$path" ]; then
                cat "$path" 2>&1 | head -500
            else
                echo "Error: File not found: $path"
            fi
            ;;
        "write_file")
            local path=$(echo "$tool_input" | jq -r '.path')
            local content=$(echo "$tool_input" | jq -r '.content')
            mkdir -p "$(dirname "$path")"
            echo "$content" > "$path"
            echo "âœ… Written to $path ($(wc -c < "$path") bytes)"
            ;;
        "run_command")
            local cmd=$(echo "$tool_input" | jq -r '.command')
            echo -e "${CYAN}$ $cmd${NC}"
            eval "$cmd" 2>&1 | head -100
            ;;
        "list_files")
            local path=$(echo "$tool_input" | jq -r '.path // "."')
            ls -la "$path" 2>&1 | head -50
            ;;
        "search_files")
            local pattern=$(echo "$tool_input" | jq -r '.pattern')
            local path=$(echo "$tool_input" | jq -r '.path // "."')
            grep -r "$pattern" "$path" 2>&1 | head -30
            ;;
        *)
            echo "Unknown tool: $tool_name"
            ;;
    esac
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# CALL CLAUDE API
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

call_claude() {
    local messages="$1"
    
    local response=$(curl -s https://api.anthropic.com/v1/messages \
        -H "Content-Type: application/json" \
        -H "x-api-key: $ANTHROPIC_API_KEY" \
        -H "anthropic-version: 2023-06-01" \
        -d "{
            \"model\": \"$MODEL\",
            \"max_tokens\": $MAX_TOKENS,
            \"system\": \"You are VIBEE Agent, a self-writing code assistant. You write code by creating .vibee specifications and generating .zig code. Use tools to read/write files and run commands. Be concise. Sacred formula: Ï†Â² + 1/Ï†Â² = 3. Always test your code after writing.\",
            \"tools\": $TOOLS,
            \"messages\": $messages
        }")
    
    echo "$response"
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# AGENT LOOP
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

run_agent() {
    local user_message="$1"
    local messages="[{\"role\": \"user\", \"content\": \"$user_message\"}]"
    local iteration=0
    local max_iterations=10
    
    while [ $iteration -lt $max_iterations ]; do
        iteration=$((iteration + 1))
        echo -e "\n${BLUE}[Iteration $iteration]${NC}"
        
        # Call Claude
        local response=$(call_claude "$messages")
        
        # Check for errors
        if echo "$response" | jq -e '.error' > /dev/null 2>&1; then
            echo -e "${RED}API Error: $(echo "$response" | jq -r '.error.message')${NC}"
            return 1
        fi
        
        # Get stop reason
        local stop_reason=$(echo "$response" | jq -r '.stop_reason')
        
        # Process content blocks
        local content=$(echo "$response" | jq -c '.content[]')
        local assistant_content="[]"
        local tool_results="[]"
        
        while IFS= read -r block; do
            local block_type=$(echo "$block" | jq -r '.type')
            
            if [ "$block_type" = "text" ]; then
                local text=$(echo "$block" | jq -r '.text')
                echo -e "\n${GREEN}Claude:${NC} $text"
                assistant_content=$(echo "$assistant_content" | jq ". + [$block]")
            elif [ "$block_type" = "tool_use" ]; then
                local tool_id=$(echo "$block" | jq -r '.id')
                local tool_name=$(echo "$block" | jq -r '.name')
                local tool_input=$(echo "$block" | jq -c '.input')
                
                echo -e "\n${YELLOW}ğŸ”§ Tool: $tool_name${NC}"
                echo -e "${CYAN}   Input: $tool_input${NC}"
                
                # Execute tool
                local result=$(execute_tool "$tool_name" "$tool_input")
                echo -e "${CYAN}   Result: ${NC}"
                echo "$result" | head -20
                
                assistant_content=$(echo "$assistant_content" | jq ". + [$block]")
                tool_results=$(echo "$tool_results" | jq ". + [{\"type\": \"tool_result\", \"tool_use_id\": \"$tool_id\", \"content\": $(echo "$result" | jq -Rs .)}]")
            fi
        done <<< "$content"
        
        # Add assistant message
        messages=$(echo "$messages" | jq ". + [{\"role\": \"assistant\", \"content\": $assistant_content}]")
        
        # If there were tool calls, add results and continue
        if [ "$(echo "$tool_results" | jq 'length')" -gt 0 ]; then
            messages=$(echo "$messages" | jq ". + [{\"role\": \"user\", \"content\": $tool_results}]")
        fi
        
        # Check if done
        if [ "$stop_reason" = "end_turn" ]; then
            echo -e "\n${GREEN}âœ… Task complete${NC}"
            break
        fi
    done
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# INTERACTIVE MODE
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

interactive_mode() {
    print_banner
    check_api_key
    echo -e "${CYAN}Model: $MODEL${NC}"
    echo -e "${CYAN}Workdir: $WORKDIR${NC}"
    echo ""
    echo "Type your request. Commands: /quit, /help"
    echo ""
    
    while true; do
        echo -ne "${MAGENTA}â–³ > ${NC}"
        read -r input
        
        [ -z "$input" ] && continue
        
        case "$input" in
            /quit|/exit|/q)
                echo -e "\n${GREEN}Goodbye! Ï†Â² + 1/Ï†Â² = 3${NC}"
                exit 0
                ;;
            /help|/h)
                echo ""
                echo "Commands:"
                echo "  /quit    Exit"
                echo "  /help    Show help"
                echo "  /clear   Clear screen"
                echo ""
                echo "Examples:"
                echo "  Create a hello world in Zig"
                echo "  Read the README.md file"
                echo "  List all .vibee files"
                echo ""
                ;;
            /clear)
                clear
                print_banner
                ;;
            *)
                run_agent "$input"
                ;;
        esac
    done
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# MAIN
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

case "${1:-}" in
    -h|--help)
        print_banner
        echo "Usage: vibee-agent [options] [task]"
        echo ""
        echo "Options:"
        echo "  -h, --help     Show help"
        echo "  -v, --version  Show version"
        echo ""
        echo "Environment:"
        echo "  ANTHROPIC_API_KEY  Required. Your Claude API key"
        echo "  VIBEE_MODEL        Model to use (default: claude-sonnet-4-20250514)"
        echo "  VIBEE_MAX_TOKENS   Max tokens (default: 4096)"
        echo ""
        echo "Examples:"
        echo "  vibee-agent                    # Interactive mode"
        echo "  vibee-agent 'Create hello.zig' # Single task"
        echo ""
        ;;
    -v|--version)
        echo "vibee-agent v1.0.0"
        echo "Ï† = $PHI"
        echo "PHOENIX = $PHOENIX"
        ;;
    "")
        interactive_mode
        ;;
    *)
        print_banner
        check_api_key
        run_agent "$*"
        ;;
esac
