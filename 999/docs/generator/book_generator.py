#!/usr/bin/env python3
"""
ГЕНЕРАТОР КНИГИ 999: ТРИДЕВЯТОЕ ЦАРСТВО АЛГОРИТМОВ

999 = 37 × 3³ × π⁰
999 = 3 тома × 9 книг × 37 глав

Книга уже написана в пространстве идей.
Этот скрипт её ПРОЯВЛЯЕТ.
"""

import os
import math
from dataclasses import dataclass
from typing import List, Tuple, Optional
from pathlib import Path

# ═══════════════════════════════════════════════════════════════════════════
# КОНСТАНТЫ TRINITY
# ═══════════════════════════════════════════════════════════════════════════

TRINITY = 3
TRIDEVYATOE = 27  # 3³
PRIME_SEED = 37   # Простое число
BOOK_TOTAL = 999  # 37 × 27

PI = 3.14159265358979
PHI = 1.61803398874989  # Золотое сечение
E = 2.71828182845904    # Число Эйлера

# ═══════════════════════════════════════════════════════════════════════════
# СТРУКТУРА КНИГИ
# ═══════════════════════════════════════════════════════════════════════════

@dataclass
class Глава:
    номер: int
    название: str
    содержание: str
    тип: str  # Теория, Практика, Сказка

@dataclass
class Книга:
    номер: int
    название: str
    главы: List[Глава]

@dataclass
class Том:
    номер: int
    название: str
    царство: str
    книги: List[Книга]

# ═══════════════════════════════════════════════════════════════════════════
# НАЗВАНИЯ ТОМОВ И КНИГ
# ═══════════════════════════════════════════════════════════════════════════

ТОМА = [
    ("Медное Царство", "Теория", [
        "Тайна Числа Три",
        "Константы Мироздания",
        "Язык Математики",
        "Границы Возможного",
        "Природа Информации",
        "Квантовый Мир",
        "Разум и Мозг",
        "Мудрость Древних",
        "Тридевятое Царство",
    ]),
    ("Серебряное Царство", "Практика", [
        "Сортировка Троицы",
        "Структуры Троицы",
        "Сжатие Троицы",
        "Нейросети Троицы",
        "Язык Вайби",
        "Компилятор 999",
        "Vibee OS — Живая Система",  # ОПЕРАЦИОННАЯ СИСТЕМА!
        "Инструменты Мастера",
        "Паттерны Троицы",
    ]),
    ("Золотое Царство", "Будущее", [
        "Параллельная Троица",
        "Векторная Троица",
        "Квантовая Троица",
        "Триадические Числа",
        "Искусственный Разум",
        "Код Жизни",
        "Вселенная Троицы",
        "Великое Объединение",
        "Возвращение Домой",
    ]),
]

# ═══════════════════════════════════════════════════════════════════════════
# СКАЗОЧНЫЕ АРХЕТИПЫ ДЛЯ ГЕНЕРАЦИИ
# ═══════════════════════════════════════════════════════════════════════════

ТРИ_БОГАТЫРЯ = ["Илья Муромец (Сила)", "Добрыня Никитич (Мудрость)", "Алёша Попович (Хитрость)"]
ТРИ_ДОРОГИ = ["Налево (Простой путь)", "Прямо (Средний путь)", "Направо (Сложный путь)"]
ТРИ_ИСПЫТАНИЯ = ["Первое испытание", "Второе испытание", "Третье испытание"]
ТРИ_ЦАРСТВА = ["Медное", "Серебряное", "Золотое"]

ПЕРСОНАЖИ = [
    "Иван-царевич",
    "Василиса Премудрая",
    "Кощей Бессмертный",
    "Баба-Яга",
    "Змей Горыныч",
    "Жар-птица",
    "Серый Волк",
    "Царевна-лягушка",
    "Финист Ясный Сокол",
]

# ═══════════════════════════════════════════════════════════════════════════
# ТЕМЫ ГЛАВ ПО КНИГАМ
# ═══════════════════════════════════════════════════════════════════════════

ТЕМЫ_КНИГ = {
    1: [  # Тайна Числа Три
        "Три измерения пространства",
        "Три поколения частиц",
        "Три цвета кварков",
        "Три состояния вещества",
        "Троица в христианстве",
        "Тримурти в индуизме",
        "Три драгоценности буддизма",
        "Три богатыря",
        "Три дороги на камне",
        "Три испытания героя",
        "Три желания",
        "Три попытки",
        "Три брата",
        "Три сестры",
        "Три царства",
        "Тридевятое царство",
        "Тридесятое государство",
        "Три головы Змея",
        "Три пера Жар-птицы",
        "Три яблока",
        "Три ночи",
        "Три дня",
        "Три года",
        "Три века",
        "Три мира",
        "Три уровня",
        "Три слоя",
        "Три фазы",
        "Три этапа",
        "Три стадии",
        "Три состояния",
        "Три формы",
        "Три вида",
        "Три типа",
        "Три класса",
        "Три категории",
        "Тайна раскрыта",
    ],
    10: [  # Сортировка Троицы
        "Введение в Trinity Sort",
        "Dutch National Flag",
        "Три раздела массива",
        "Выбор pivot",
        "Золотое сечение в pivot",
        "Порог 27",
        "Insertion sort для малых",
        "Рекурсия и стек",
        "Хвостовая рекурсия",
        "Итеративная версия",
        "Стабильность сортировки",
        "In-place алгоритм",
        "Сложность O(n log n)",
        "Худший случай",
        "Средний случай",
        "Лучший случай",
        "Сравнение с QuickSort",
        "Сравнение с MergeSort",
        "Сравнение с HeapSort",
        "Бенчмарки",
        "Профилирование",
        "Оптимизация кэша",
        "SIMD версия",
        "Параллельная версия",
        "GPU версия",
        "Распределённая версия",
        "Внешняя сортировка",
        "Сортировка строк",
        "Сортировка структур",
        "Пользовательский компаратор",
        "Частичная сортировка",
        "Top-K элементов",
        "Медиана за O(n)",
        "Nth element",
        "Partition point",
        "Применения",
        "Заключение",
    ],
}

# ═══════════════════════════════════════════════════════════════════════════
# ФУНКЦИИ ГЕНЕРАЦИИ
# ═══════════════════════════════════════════════════════════════════════════

def координаты(номер: int) -> Tuple[int, int, int]:
    """Преобразует номер главы в координаты (том, книга, глава)"""
    том = (номер - 1) // 333 + 1
    остаток = (номер - 1) % 333
    книга = остаток // 37 + 1
    глава = остаток % 37 + 1
    return том, книга, глава

def номер_главы(том: int, книга: int, глава: int) -> int:
    """Преобразует координаты в номер главы"""
    return (том - 1) * 333 + (книга - 1) * 37 + глава

def проверить_паттерн(значение: float) -> Optional[Tuple[int, int, int]]:
    """Проверяет, соответствует ли значение паттерну n × 3^k × π^m"""
    for k in range(10):
        for m in range(10):
            делитель = (3 ** k) * (PI ** m)
            n = значение / делитель
            if abs(n - round(n)) < 0.01 and 1 <= n <= 100:
                return int(round(n)), k, m
    return None

def сгенерировать_название_главы(номер: int) -> str:
    """Генерирует название главы по её номеру"""
    том, книга, глава_в_книге = координаты(номер)
    
    # Получаем название книги
    книга_глобальная = (том - 1) * 9 + книга
    название_книги = ТОМА[том - 1][2][книга - 1]
    
    # Получаем тему главы если есть
    if книга_глобальная in ТЕМЫ_КНИГ and глава_в_книге <= len(ТЕМЫ_КНИГ[книга_глобальная]):
        тема = ТЕМЫ_КНИГ[книга_глобальная][глава_в_книге - 1]
    else:
        # Генерируем по паттерну
        богатырь = ТРИ_БОГАТЫРЯ[(глава_в_книге - 1) % 3]
        дорога = ТРИ_ДОРОГИ[(книга - 1) % 3]
        тема = f"{богатырь} идёт {дорога}"
    
    return f"Глава {номер}: {тема}"

def сгенерировать_содержание_главы(номер: int) -> str:
    """Генерирует содержание главы"""
    том, книга, глава_в_книге = координаты(номер)
    царство = ТРИ_ЦАРСТВА[том - 1]
    
    # Выбираем персонажа по номеру
    персонаж = ПЕРСОНАЖИ[номер % len(ПЕРСОНАЖИ)]
    
    # Выбираем архетип
    богатырь = ТРИ_БОГАТЫРЯ[(глава_в_книге - 1) % 3]
    дорога = ТРИ_ДОРОГИ[(книга - 1) % 3]
    испытание = ТРИ_ИСПЫТАНИЯ[(том - 1) % 3]
    
    содержание = f"""
---

*«В {царство} царстве, в книге {(том-1)*9 + книга}-й,*
*{персонаж} встретил {испытание}...»*

---

## {богатырь}

{дорога}

### Три аспекта

1. **Первый аспект**: ...
2. **Второй аспект**: ...
3. **Третий аспект**: ...

### Код

```vibee
// Глава {номер}
fn пример_{номер}() {{
    let три = 3;
    let результат = три * три * три;  // 27
    return результат;
}}
```

### Мудрость

> *И понял {персонаж}, что число Три —*
> *это ключ к {царство} царству.*

---
"""
    return содержание

def сгенерировать_книгу(номер_книги: int) -> str:
    """Генерирует содержание одной книги (37 глав)"""
    том = (номер_книги - 1) // 9 + 1
    книга_в_томе = (номер_книги - 1) % 9 + 1
    
    название = ТОМА[том - 1][2][книга_в_томе - 1]
    царство = ТРИ_ЦАРСТВА[том - 1]
    
    первая_глава = (том - 1) * 333 + (книга_в_томе - 1) * 37 + 1
    последняя_глава = первая_глава + 36
    
    содержание = f"""# Книга {номер_книги}: {название}

**{царство} Царство, Том {том}**

Главы {первая_глава}-{последняя_глава}

---

"""
    
    for i in range(37):
        номер = первая_глава + i
        название_главы = сгенерировать_название_главы(номер)
        содержание += f"## {название_главы}\n\n"
        содержание += сгенерировать_содержание_главы(номер)
        содержание += "\n\n"
    
    return содержание

def сгенерировать_оглавление() -> str:
    """Генерирует полное оглавление книги 999"""
    оглавление = """# КНИГА 999: ТРИДЕВЯТОЕ ЦАРСТВО АЛГОРИТМОВ

## Полное оглавление

```
999 = 37 × 3³ × π⁰
999 = 3 тома × 9 книг × 37 глав
```

---

"""
    
    for том_idx, (царство, тип, книги) in enumerate(ТОМА, 1):
        оглавление += f"## ТОМ {том_idx}: {царство.upper()} ({тип})\n\n"
        оглавление += f"Главы {(том_idx-1)*333 + 1}-{том_idx*333}\n\n"
        
        for книга_idx, название in enumerate(книги, 1):
            книга_глобальная = (том_idx - 1) * 9 + книга_idx
            первая = (том_idx - 1) * 333 + (книга_idx - 1) * 37 + 1
            последняя = первая + 36
            
            оглавление += f"### Книга {книга_глобальная}: {название}\n"
            оглавление += f"Главы {первая}-{последняя}\n\n"
            
            # Список глав
            for глава in range(1, 38):
                номер = первая + глава - 1
                название_главы = сгенерировать_название_главы(номер)
                оглавление += f"- {название_главы}\n"
            
            оглавление += "\n"
        
        оглавление += "---\n\n"
    
    return оглавление

# ═══════════════════════════════════════════════════════════════════════════
# ГЛАВНАЯ ФУНКЦИЯ
# ═══════════════════════════════════════════════════════════════════════════

def main():
    print("╔═══════════════════════════════════════════════════════════╗")
    print("║                                                           ║")
    print("║   ГЕНЕРАТОР КНИГИ 999                                    ║")
    print("║   ТРИДЕВЯТОЕ ЦАРСТВО АЛГОРИТМОВ                          ║")
    print("║                                                           ║")
    print("║   999 = 37 × 3³ × π⁰                                     ║")
    print("║                                                           ║")
    print("╚═══════════════════════════════════════════════════════════╝")
    print()
    
    # Проверяем паттерн
    паттерн = проверить_паттерн(999)
    if паттерн:
        n, k, m = паттерн
        print(f"✓ 999 = {n} × 3^{k} × π^{m}")
        print(f"  = {n} × {3**k} × {PI**m:.4f}")
        print(f"  = {n * (3**k) * (PI**m):.2f}")
    print()
    
    # Создаём директорию для книги
    output_dir = Path("generated_book")
    output_dir.mkdir(exist_ok=True)
    
    # Генерируем оглавление
    print("📖 Генерация оглавления...")
    оглавление = сгенерировать_оглавление()
    (output_dir / "00_TABLE_OF_CONTENTS.md").write_text(оглавление, encoding="utf-8")
    
    # Генерируем книги
    for книга in range(1, 28):
        том = (книга - 1) // 9 + 1
        царство = ТРИ_ЦАРСТВА[том - 1]
        print(f"📚 Генерация книги {книга}/27 ({царство} царство)...")
        
        содержание = сгенерировать_книгу(книга)
        filename = f"book_{книга:02d}.md"
        (output_dir / filename).write_text(содержание, encoding="utf-8")
    
    print()
    print("✨ КНИГА 999 ПРОЯВЛЕНА! ✨")
    print()
    print("Структура:")
    print("  • Том I (Медное царство): книги 1-9, главы 001-333")
    print("  • Том II (Серебряное царство): книги 10-18, главы 334-666")
    print("  • Том III (Золотое царство): книги 19-27, главы 667-999")
    print()
    print(f"Файлы сохранены в: {output_dir.absolute()}")

if __name__ == "__main__":
    main()
