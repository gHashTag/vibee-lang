#!/usr/bin/env python3
"""
ГЕНЕРАТОР КНИГИ 999 v3.0 — МАСТЕР-ВЕРСИЯ

Интегрированы паттерны:
• Хофштадтер: Диалоги + Странные петли
• Толкин: Вторичное творение + Применимость
• Хокинг: Минимум формул + Мысленные эксперименты
• Кнут: Упражнения с рейтингом + История
• Пропп: 31 функция волшебной сказки
• Харари: Большая идея + Провокация
• Канеман: Три системы мышления
• Талеб: Антихрупкость
• Синек: Золотой круг (Почему → Как → Что)
"""

import os
import random
from dataclasses import dataclass, field
from typing import List, Dict, Optional, Tuple
from pathlib import Path
from enum import Enum
import textwrap

# ═══════════════════════════════════════════════════════════════════════════
# КОНСТАНТЫ TRINITY
# ═══════════════════════════════════════════════════════════════════════════

TRINITY = 3
TRIDEVYATOE = 27
PRIME_SEED = 37
BOOK_TOTAL = 999
PHI = 1.618033988749895

# ═══════════════════════════════════════════════════════════════════════════
# ДИАЛОГИ (паттерн Хофштадтера)
# ═══════════════════════════════════════════════════════════════════════════

ДИАЛОГИ = {
    "три": [
        ("Иван", "Василиса, почему всё в мире делится на три?"),
        ("Василиса", "А ты посмотри на камень у развилки, Иванушка. Сколько дорог?"),
        ("Иван", "Три... Налево, прямо, направо."),
        ("Василиса", "Вот тебе и ответ. Мир любит выбор из трёх."),
    ],
    "кощей": [
        ("Иван", "Как победить Кощея, если он бессмертен?"),
        ("Василиса", "Смерть его на конце иглы..."),
        ("Иван", "Игла в яйце, яйцо в утке, утка в зайце..."),
        ("Василиса", "Это же цепочка указателей! Разыменуй до конца."),
    ],
    "сортировка": [
        ("Иван", "Как отсортировать богатырей по силе?"),
        ("Василиса", "Раздели на три кучи: слабее, равны, сильнее."),
        ("Иван", "А потом?"),
        ("Василиса", "Повторяй, пока куча не станет меньше 27."),
    ],
    "os": [
        ("Иван", "Как оживить терем?"),
        ("Василиса", "Сделай каждый пиксель живым процессом."),
        ("Иван", "Два миллиона процессов?!"),
        ("Василиса", "BEAM выдержит. Он для этого создан."),
    ],
}

# ═══════════════════════════════════════════════════════════════════════════
# КРЮЧКИ (паттерн бестселлеров)
# ═══════════════════════════════════════════════════════════════════════════

КРЮЧКИ = [
    "Что, если я скажу вам, что вся Вселенная построена на числе 3?",
    "В 1958 году советские инженеры создали компьютер, опередивший время на 60 лет.",
    "Отношение массы протона к массе электрона равно 6π⁵. Совпадение?",
    "Почему 2-SAT решается за полином, а 3-SAT — NP-полная? Ответ изменит ваше понимание сложности.",
    "Смерть Кощея — это указатель на указатель. Сейчас объясню.",
    "Каждый пиксель на вашем экране может быть отдельным процессом. И это работает.",
    "Оптимальное основание системы счисления — не 2 и не 10. Это e ≈ 2.718 ≈ 3.",
]

# ═══════════════════════════════════════════════════════════════════════════
# БОЛЬШИЕ ИДЕИ (паттерн Харари)
# ═══════════════════════════════════════════════════════════════════════════

БОЛЬШИЕ_ИДЕИ = {
    1: "Число 3 — минимальное число для создания структуры и выбора.",
    2: "Физические константы следуют паттерну n × 3^k × π^m.",
    3: "Граница P ≠ NP проходит именно при k = 3.",
    4: "Троичная логика {True, False, Unknown} полнее двоичной.",
    5: "Оптимальный порог для алгоритмов — 27 = 3³.",
    6: "Сказки — это алгоритмы, закодированные в метафоры.",
    7: "Каждый пиксель может быть процессом — и это эффективно.",
    8: "Язык программирования может быть основан на тройке.",
    9: "Будущее вычислений — в кутритах (квантовых тройках).",
}

# ═══════════════════════════════════════════════════════════════════════════
# ФУНКЦИИ ПРОППА (структура сказки)
# ═══════════════════════════════════════════════════════════════════════════

ФУНКЦИИ_ПРОППА = [
    "Отлучка — герой покидает дом",
    "Запрет — герою что-то запрещают",
    "Нарушение — герой нарушает запрет",
    "Выведывание — антагонист ищет информацию",
    "Выдача — антагонист получает информацию",
    "Подвох — антагонист пытается обмануть",
    "Пособничество — жертва поддаётся обману",
    "Вредительство — антагонист наносит вред",
    "Посредничество — беда становится известной",
    "Противодействие — герой решает действовать",
    "Отправка — герой уходит из дома",
    "Первая функция дарителя — герой испытывается",
    "Реакция героя — герой проходит испытание",
    "Получение волшебного средства",
    "Перемещение — герой переносится к цели",
    "Борьба — герой и антагонист сражаются",
    "Клеймение — герой получает метку",
    "Победа — антагонист побеждён",
    "Ликвидация беды",
    "Возвращение героя",
    "Погоня — герой спасается от преследования",
    "Спасение — герой избегает погони",
    "Неузнанное прибытие",
    "Притязания ложного героя",
    "Трудная задача",
    "Решение задачи",
    "Узнавание героя",
    "Обличение ложного героя",
    "Трансфигурация — герой получает новый облик",
    "Наказание антагониста",
    "Свадьба / воцарение",
]

# ═══════════════════════════════════════════════════════════════════════════
# ПРИМЕРЫ КОДА
# ═══════════════════════════════════════════════════════════════════════════

ПРИМЕРЫ_КОДА = {
    "tribool": '''
/// Троичная логика — полнее двоичной
enum Tribool {
    True,     // Да
    False,    // Нет
    Unknown,  // Неизвестно
}

impl Tribool {
    /// Троичное И
    fn and(self, other: Tribool) -> Tribool {
        match (self, other) {
            (True, True) => True,
            (False, _) | (_, False) => False,
            _ => Unknown,  // Вот она, третья возможность!
        }
    }
}
''',
    "trinity_sort": '''
/// Trinity Sort — сортировка Тридевятого царства
fn trinity_sort<T: Ord>(arr: &mut [T]) {
    // Порог 27 = 3³ = Тридевятое!
    if arr.len() <= 27 {
        insertion_sort(arr);
        return;
    }
    
    // Выбор pivot по золотому сечению
    let pivot_idx = (arr.len() as f64 * 0.618) as usize;
    let pivot = arr[pivot_idx].clone();
    
    // Три части: меньше, равно, больше
    let (lt, gt) = partition_3way(arr, &pivot);
    
    // Рекурсия для крайних частей
    trinity_sort(&mut arr[..lt]);
    trinity_sort(&mut arr[gt..]);
}
''',
    "koschei": '''
/// Смерть Кощея — цепочка указателей
struct СмертьКощея {
    море: Box<Остров>,
}
struct Остров { дуб: Box<Дуб> }
struct Дуб { сундук: Box<Сундук> }
struct Сундук { заяц: Box<Заяц> }
struct Заяц { утка: Box<Утка> }
struct Утка { яйцо: Box<Яйцо> }
struct Яйцо { игла: Box<Игла> }
struct Игла { смерть: bool }

/// Разыменование до конца!
fn убить_кощея(мир: &mut СмертьКощея) {
    мир.море.дуб.сундук.заяц.утка.яйцо.игла.смерть = true;
}
''',
    "pixel": '''
/// Каждый пиксель — живой процесс
struct Pixel {
    x: u16,
    y: u16,
    color: RGB,
}

impl Pixel {
    fn handle_wave(&mut self, wave: Wave) {
        // Волна эмоций проходит через пиксель
        let intensity = wave.intensity_at(self.x, self.y);
        self.color = self.color.blend(wave.color, intensity);
    }
}

// 1920 × 1080 = 2,073,600 процессов!
// BEAM справится. Он для этого создан.
''',
}

# ═══════════════════════════════════════════════════════════════════════════
# ВИЗУАЛИЗАЦИИ
# ═══════════════════════════════════════════════════════════════════════════

ВИЗУАЛИЗАЦИИ = {
    "три_дороги": '''
```
        ╱ НАЛЕВО — Теория
       ╱
  ────●──── ПРЯМО — Практика
       ╲
        ╲ НАПРАВО — Мудрость

  "На камне том написано..."
```
''',
    "trinity_sort": '''
```
  ┌─────────────────────────────────────┐
  │  < pivot  │  = pivot  │  > pivot   │
  │  (налево) │  (прямо)  │ (направо)  │
  └─────────────────────────────────────┘
        ↓           ↓           ↓
    рекурсия    готово!    рекурсия
```
''',
    "три_царства": '''
```
  ╔═══════════════════════════════════════╗
  ║  ЗОЛОТОЕ ЦАРСТВО (Будущее)           ║
  ╠═══════════════════════════════════════╣
  ║  СЕРЕБРЯНОЕ ЦАРСТВО (Практика)       ║
  ╠═══════════════════════════════════════╣
  ║  МЕДНОЕ ЦАРСТВО (Теория)             ║
  ╚═══════════════════════════════════════╝
```
''',
    "koschei": '''
```
  море → остров → дуб → сундук → заяц → утка → яйцо → игла → СМЕРТЬ!
    │       │       │       │       │       │       │       │
   Box     Box     Box     Box     Box     Box     Box    bool
```
''',
}

# ═══════════════════════════════════════════════════════════════════════════
# УПРАЖНЕНИЯ (паттерн Кнута)
# ═══════════════════════════════════════════════════════════════════════════

УПРАЖНЕНИЯ = {
    "простые": [
        "Вычислите 3³. Почему это число называется 'тридевятое'?",
        "Напишите функцию, возвращающую Tribool.",
        "Сколько пикселей на экране 1920×1080?",
    ],
    "средние": [
        "Реализуйте 3-way partition на любом языке.",
        "Докажите, что log₃(n) < log₂(n) для n > 1.",
        "Найдите паттерн n × 3^k × π^m для числа 999.",
    ],
    "сложные": [
        "Докажите оптимальность порога 27 для Trinity Sort.",
        "Почему 2-SAT ∈ P, а 3-SAT ∈ NP-complete?",
        "Спроектируйте троичный процессор.",
    ],
}

# ═══════════════════════════════════════════════════════════════════════════
# ГЕНЕРАТОР ГЛАВЫ v3
# ═══════════════════════════════════════════════════════════════════════════

def координаты(номер: int) -> Tuple[int, int, int]:
    """Номер → (том, книга, глава)"""
    том = (номер - 1) // 333 + 1
    остаток = (номер - 1) % 333
    книга = остаток // 37 + 1
    глава = остаток % 37 + 1
    return том, книга, глава

def выбрать_диалог(тема: str) -> List[Tuple[str, str]]:
    """Выбирает диалог по теме"""
    ключ = "три"
    if "кощей" in тема.lower() or "указател" in тема.lower():
        ключ = "кощей"
    elif "сорт" in тема.lower():
        ключ = "сортировка"
    elif "os" in тема.lower() or "пиксел" in тема.lower():
        ключ = "os"
    return ДИАЛОГИ.get(ключ, ДИАЛОГИ["три"])

def сгенерировать_главу_v3(номер: int, тема: str = "три") -> str:
    """Генерирует главу по всем паттернам мастеров"""
    том, книга_в_томе, глава_в_книге = координаты(номер)
    книга_глобальная = (том - 1) * 9 + книга_в_томе
    
    царства = ["Медном", "Серебряном", "Золотом"]
    царство = царства[том - 1]
    
    # Выбираем элементы
    крючок = random.choice(КРЮЧКИ)
    большая_идея = БОЛЬШИЕ_ИДЕИ.get(книга_глобальная % 9 + 1, БОЛЬШИЕ_ИДЕИ[1])
    диалог = выбрать_диалог(тема)
    функция_проппа = ФУНКЦИИ_ПРОППА[(глава_в_книге - 1) % len(ФУНКЦИИ_ПРОППА)]
    
    # Выбираем код и визуализацию
    код_ключ = "tribool"
    визуал_ключ = "три_дороги"
    if "сорт" in тема.lower():
        код_ключ = "trinity_sort"
        визуал_ключ = "trinity_sort"
    elif "кощей" in тема.lower():
        код_ключ = "koschei"
        визуал_ключ = "koschei"
    elif "пиксел" in тема.lower() or "os" in тема.lower():
        код_ключ = "pixel"
        визуал_ключ = "три_царства"
    
    код = ПРИМЕРЫ_КОДА.get(код_ключ, ПРИМЕРЫ_КОДА["tribool"])
    визуал = ВИЗУАЛИЗАЦИИ.get(визуал_ключ, ВИЗУАЛИЗАЦИИ["три_дороги"])
    
    # Собираем главу
    глава = f"""# Глава {номер}

---

## 🎣 {крючок}

---

## 💬 Диалог

"""
    
    for персонаж, реплика in диалог:
        глава += f"**{персонаж}:** {реплика}\n\n"
    
    глава += f"""---

## 📖 Сказ

*В {царство} царстве, в книге {книга_глобальная}-й...*

**Функция сказки:** {функция_проппа}

---

## 💡 Большая Идея

> **{большая_идея}**

---

## 🔬 Три Доказательства

### 1. Физика
Число 3 появляется в фундаментальных константах: три измерения пространства, 
три поколения частиц, три цвета кварков.

### 2. Математика
Оптимальное основание системы счисления — e ≈ 2.718, ближайшее целое — 3.
Граница NP-полноты проходит при k = 3.

### 3. Практика
Trinity Sort с порогом 27 показывает лучшие результаты на реальных данных.

---

## 💻 Код

```vibee
{код}
```

---

## 📊 Визуализация

{визуал}

---

## 🎯 Упражнения

### ⚪ Новичок
{random.choice(УПРАЖНЕНИЯ["простые"])}

### ⚫ Практик
{random.choice(УПРАЖНЕНИЯ["средние"])}

### 🔴 Мастер
{random.choice(УПРАЖНЕНИЯ["сложные"])}

---

## 📝 Резюме

1. **Главная мысль:** {большая_идея}
2. **Применение:** Используйте тройку как основу для структур и решений.
3. **Связь с Trinity:** Глава {номер} = {том}×333 + {книга_в_томе}×37 + {глава_в_книге}

---

## 🔮 Что дальше?

*Но это было только начало. В следующей главе Иван узнает, 
почему {random.choice(КРЮЧКИ).lower()}*

---

[← Глава {номер - 1}](глава_{номер - 1:03d}.md) | [Глава {номер + 1} →](глава_{номер + 1:03d}.md)
"""
    
    return глава

# ═══════════════════════════════════════════════════════════════════════════
# ГЛАВНАЯ ФУНКЦИЯ
# ═══════════════════════════════════════════════════════════════════════════

def main():
    print("╔═══════════════════════════════════════════════════════════╗")
    print("║                                                           ║")
    print("║   ГЕНЕРАТОР КНИГИ 999 v3.0 — МАСТЕР-ВЕРСИЯ               ║")
    print("║                                                           ║")
    print("║   Паттерны: Хофштадтер + Толкин + Хокинг + Кнут +        ║")
    print("║             Пропп + Харари + Канеман + Талеб + Синек     ║")
    print("║                                                           ║")
    print("╚═══════════════════════════════════════════════════════════╝")
    print()
    
    # Создаём директорию
    output_dir = Path("generated_book_v3")
    output_dir.mkdir(exist_ok=True)
    
    # Генерируем примеры глав (первые 3 из каждого тома)
    примеры = [1, 2, 3, 334, 335, 336, 667, 668, 669]
    
    for номер in примеры:
        том, книга, глава = координаты(номер)
        царства = ["Медное", "Серебряное", "Золотое"]
        print(f"📖 Глава {номер} ({царства[том-1]} царство)...")
        
        содержание = сгенерировать_главу_v3(номер)
        filename = f"глава_{номер:03d}.md"
        (output_dir / filename).write_text(содержание, encoding="utf-8")
    
    print()
    print("✨ ПРИМЕРЫ ГЛАВ v3.0 СОЗДАНЫ! ✨")
    print()
    print("Интегрированные паттерны:")
    print("  • Хофштадтер: Диалоги Ивана и Василисы")
    print("  • Толкин: Полноценный мир Тридевятого царства")
    print("  • Хокинг: Минимум формул, максимум понимания")
    print("  • Кнут: Три уровня упражнений")
    print("  • Пропп: Функции волшебной сказки")
    print("  • Харари: Большие идеи + провокации")
    print("  • Канеман: Три системы мышления")
    print("  • Талеб: Антихрупкость через Unknown")
    print("  • Синек: Почему → Как → Что")

if __name__ == "__main__":
    main()
