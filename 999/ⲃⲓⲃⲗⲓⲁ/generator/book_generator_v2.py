#!/usr/bin/env python3
"""
ГЕНЕРАТОР КНИГИ 999 v2.0
Прокачанная версия с учётом лучших практик написания книг

Принципы:
1. Путь Героя (Hero's Journey) — структура каждого тома
2. Трёхактная структура — каждая книга
3. Сцена-продолжение (Scene-Sequel) — каждая глава
4. Крючки и клиффхэнгеры — вовлечение читателя
5. Show, don't tell — примеры вместо объяснений
"""

import os
import random
from dataclasses import dataclass, field
from typing import List, Dict, Optional, Tuple
from pathlib import Path
from enum import Enum

# ═══════════════════════════════════════════════════════════════════════════
# КОНСТАНТЫ
# ═══════════════════════════════════════════════════════════════════════════

TRINITY = 3
TRIDEVYATOE = 27
PRIME_SEED = 37
BOOK_TOTAL = 999

PHI = 1.618033988749895  # Золотое сечение
PI = 3.141592653589793

# ═══════════════════════════════════════════════════════════════════════════
# ПУТЬ ГЕРОЯ (HERO'S JOURNEY) — СТРУКТУРА ТОМА
# ═══════════════════════════════════════════════════════════════════════════

class ЭтапПутиГероя(Enum):
    """12 этапов пути героя, сгруппированные по 3"""
    
    # АКТ I: ОТПРАВЛЕНИЕ (книги 1-3)
    ОБЫЧНЫЙ_МИР = 1           # Герой в привычной среде
    ПРИЗЫВ_К_ПРИКЛЮЧЕНИЮ = 2  # Проблема требует решения
    ОТКАЗ_ОТ_ПРИЗЫВА = 3      # Сомнения и страхи
    
    # АКТ II-A: ИНИЦИАЦИЯ (книги 4-6)
    ВСТРЕЧА_С_НАСТАВНИКОМ = 4  # Мудрец даёт знания
    ПЕРЕСЕЧЕНИЕ_ПОРОГА = 5     # Вход в новый мир
    ИСПЫТАНИЯ_И_СОЮЗНИКИ = 6   # Друзья и враги
    
    # АКТ II-B: ТРАНСФОРМАЦИЯ (книги 7-9)
    ПРИБЛИЖЕНИЕ_К_ПЕЩЕРЕ = 7   # Подготовка к главному
    ГЛАВНОЕ_ИСПЫТАНИЕ = 8      # Кульминация
    НАГРАДА = 9                # Получение сокровища

# ═══════════════════════════════════════════════════════════════════════════
# ТРЁХАКТНАЯ СТРУКТУРА — КАЖДАЯ КНИГА
# ═══════════════════════════════════════════════════════════════════════════

@dataclass
class ТрёхактнаяСтруктура:
    """Структура книги из 37 глав"""
    
    # АКТ I: ЗАВЯЗКА (главы 1-12, ~32%)
    завязка: List[int] = field(default_factory=lambda: list(range(1, 13)))
    
    # АКТ II: РАЗВИТИЕ (главы 13-30, ~49%)
    развитие: List[int] = field(default_factory=lambda: list(range(13, 31)))
    
    # АКТ III: РАЗВЯЗКА (главы 31-37, ~19%)
    развязка: List[int] = field(default_factory=lambda: list(range(31, 38)))
    
    def определить_акт(self, глава: int) -> str:
        if глава <= 12:
            return "ЗАВЯЗКА"
        elif глава <= 30:
            return "РАЗВИТИЕ"
        else:
            return "РАЗВЯЗКА"
    
    def определить_функцию(self, глава: int) -> str:
        """Функция главы в структуре"""
        функции = {
            1: "Крючок — захватить внимание",
            2: "Экспозиция — представить мир",
            3: "Инцидент — запустить конфликт",
            12: "Первый поворот — точка невозврата",
            18: "Мидпоинт — переломный момент",
            30: "Второй поворот — всё потеряно",
            37: "Кульминация и разрешение",
        }
        return функции.get(глава, "Развитие сюжета")

# ═══════════════════════════════════════════════════════════════════════════
# СЦЕНА-ПРОДОЛЖЕНИЕ (SCENE-SEQUEL) — КАЖДАЯ ГЛАВА
# ═══════════════════════════════════════════════════════════════════════════

@dataclass
class СценаПродолжение:
    """Структура главы"""
    
    # СЦЕНА (активная часть)
    цель: str           # Чего хочет герой
    конфликт: str       # Что мешает
    катастрофа: str     # Неожиданный поворот
    
    # ПРОДОЛЖЕНИЕ (реактивная часть)
    реакция: str        # Эмоциональный отклик
    дилемма: str        # Выбор между вариантами
    решение: str        # Что герой решает делать

# ═══════════════════════════════════════════════════════════════════════════
# КРЮЧКИ И КЛИФФХЭНГЕРЫ
# ═══════════════════════════════════════════════════════════════════════════

КРЮЧКИ = {
    "вопрос": [
        "Почему число 3 появляется везде?",
        "Что скрывает Кощей в своей игле?",
        "Как связаны физика и алгоритмы?",
        "Почему 27 — магическое число?",
        "Что если каждый пиксель — живой?",
    ],
    "действие": [
        "Иван схватил меч и бросился в бой...",
        "Экран вспыхнул двумя миллионами огней...",
        "Массив разделился на три части...",
        "Кощей рассмеялся: «Ты никогда не найдёшь!»",
    ],
    "откровение": [
        "И тогда он понял: всё связано через тройку.",
        "Формула была проста: n × 3^k × π^m.",
        "Смерть Кощея — это указатель на указатель!",
        "27 = 3³ = Тридевятое царство!",
    ],
}

КЛИФФХЭНГЕРЫ = [
    "Но это было только начало...",
    "Однако главное испытание ждало впереди...",
    "И тут он услышал голос из темноты...",
    "Но что-то было не так...",
    "Ответ оказался совсем не тем, что он ожидал...",
    "Три дороги лежали перед ним. Какую выбрать?",
]

# ═══════════════════════════════════════════════════════════════════════════
# ПЕРСОНАЖИ С АРКАМИ РАЗВИТИЯ
# ═══════════════════════════════════════════════════════════════════════════

@dataclass
class Персонаж:
    имя: str
    роль: str
    арка: str  # Как персонаж меняется
    программный_аналог: str
    
ПЕРСОНАЖИ = [
    Персонаж(
        имя="Иван-программист",
        роль="Герой",
        арка="От новичка к мастеру Trinity",
        программный_аналог="main() — точка входа"
    ),
    Персонаж(
        имя="Василиса Премудрая",
        роль="Наставник",
        арка="От загадочной к понятной",
        программный_аналог="Документация / IDE"
    ),
    Персонаж(
        имя="Кощей Бессмертный",
        роль="Антагонист",
        арка="От непобедимого к уязвимому",
        программный_аналог="Legacy-код / Memory leak"
    ),
    Персонаж(
        имя="Три Богатыря",
        роль="Союзники",
        арка="От разрозненных к единым",
        программный_аналог="Box<T>, Rc<T>, Arc<T>"
    ),
    Персонаж(
        имя="Баба-Яга",
        роль="Привратник",
        арка="От враждебной к помощнице",
        программный_аналог="Garbage Collector"
    ),
    Персонаж(
        имя="Змей Горыныч",
        роль="Тень",
        арка="От хаоса к порядку",
        программный_аналог="Race Condition / Deadlock"
    ),
]

# ═══════════════════════════════════════════════════════════════════════════
# ТЕМАТИЧЕСКИЕ ЛИНИИ
# ═══════════════════════════════════════════════════════════════════════════

ТЕМЫ = {
    "главная": "Число 3 — фундамент мироздания и алгоритмов",
    "побочные": [
        "Единство физики и информатики",
        "Сказки как метафоры программирования",
        "Эволюция от простого к сложному",
        "Баланс между теорией и практикой",
    ],
    "символы": {
        "3": "Структура, стабильность, выбор",
        "27": "Полнота, завершённость, Тридевятое",
        "φ": "Оптимальность, красота, баланс",
        "π": "Бесконечность, цикличность, периодичность",
        "игла": "Уязвимость, точка отказа, указатель",
    },
}

# ═══════════════════════════════════════════════════════════════════════════
# УЛУЧШЕННЫЙ ГЕНЕРАТОР ГЛАВ
# ═══════════════════════════════════════════════════════════════════════════

def координаты(номер: int) -> Tuple[int, int, int]:
    """Номер → (том, книга, глава)"""
    том = (номер - 1) // 333 + 1
    остаток = (номер - 1) % 333
    книга = остаток // 37 + 1
    глава = остаток % 37 + 1
    return том, книга, глава

def сгенерировать_крючок(тема: str) -> str:
    """Генерирует захватывающее начало"""
    тип = random.choice(["вопрос", "действие", "откровение"])
    крючки = КРЮЧКИ[тип]
    return random.choice(крючки)

def сгенерировать_клиффхэнгер() -> str:
    """Генерирует интригующий конец"""
    return random.choice(КЛИФФХЭНГЕРЫ)

def определить_этап_пути(книга: int) -> ЭтапПутиГероя:
    """Определяет этап пути героя по номеру книги"""
    этапы = list(ЭтапПутиГероя)
    return этапы[(книга - 1) % 9]

def сгенерировать_главу_v2(номер: int) -> str:
    """Улучшенная генерация главы"""
    том, книга_в_томе, глава_в_книге = координаты(номер)
    книга_глобальная = (том - 1) * 9 + книга_в_томе
    
    структура = ТрёхактнаяСтруктура()
    акт = структура.определить_акт(глава_в_книге)
    функция = структура.определить_функцию(глава_в_книге)
    этап = определить_этап_пути(книга_в_томе)
    
    # Выбираем персонажа
    персонаж = ПЕРСОНАЖИ[номер % len(ПЕРСОНАЖИ)]
    
    # Определяем царство
    царства = ["Медном", "Серебряном", "Золотом"]
    царство = царства[том - 1]
    
    # Генерируем структуру сцены
    сцена = СценаПродолжение(
        цель=f"Понять тайну главы {номер}",
        конфликт=f"Препятствие на пути к знанию",
        катастрофа=f"Неожиданное открытие",
        реакция=f"Осмысление увиденного",
        дилемма=f"Три пути: налево, прямо, направо",
        решение=f"Выбор пути через тройку",
    )
    
    # Собираем главу
    глава = f"""# Глава {номер}

---

## {сгенерировать_крючок("trinity")}

*Акт: {акт} | Функция: {функция}*
*Этап пути героя: {этап.name}*

---

### Сцена

В {царство} царстве {персонаж.имя} ({персонаж.программный_аналог}) 
столкнулся с новым испытанием.

**Цель:** {сцена.цель}

**Конфликт:** {сцена.конфликт}

```vibee
// Код главы {номер}
fn глава_{номер}() -> Result<Мудрость, Ошибка> {{
    let три = 3;
    let тридевятое = три.pow(3);  // 27
    
    // Три попытки
    for попытка in 1..=3 {{
        match испытание(попытка) {{
            Ok(знание) => return Ok(знание),
            Err(_) => continue,
        }}
    }}
    
    Err(Ошибка::НужноБольшеМудрости)
}}
```

**Катастрофа:** {сцена.катастрофа}

### Продолжение

**Реакция:** {сцена.реакция}

**Дилемма:** {сцена.дилемма}

> *«Три дороги перед тобой, добрый молодец:*
> *Налево пойдёшь — теорию найдёшь,*
> *Прямо пойдёшь — практику обретёшь,*
> *Направо пойдёшь — мудрость познаешь.»*

**Решение:** {сцена.решение}

### Мудрость главы {номер}

| Число | Значение | Применение |
|-------|----------|------------|
| 3 | Структура | Три части массива |
| 9 | 3² | Девять книг в томе |
| 27 | 3³ | Тридевятое царство |
| {номер} | Глава | Шаг на пути героя |

---

{сгенерировать_клиффхэнгер()}

---

[← Глава {номер - 1}](глава_{номер - 1:03d}.md) | [Глава {номер + 1} →](глава_{номер + 1:03d}.md)
"""
    
    return глава

# ═══════════════════════════════════════════════════════════════════════════
# ГЕНЕРАЦИЯ КНИГИ
# ═══════════════════════════════════════════════════════════════════════════

def сгенерировать_книгу_v2(номер_книги: int) -> str:
    """Генерирует книгу с трёхактной структурой"""
    том = (номер_книги - 1) // 9 + 1
    книга_в_томе = (номер_книги - 1) % 9 + 1
    
    НАЗВАНИЯ_КНИГ = [
        # Том I
        "Тайна Числа Три", "Константы Мироздания", "Язык Математики",
        "Границы Возможного", "Природа Информации", "Квантовый Мир",
        "Разум и Мозг", "Мудрость Древних", "Тридевятое Царство",
        # Том II
        "Сортировка Троицы", "Структуры Троицы", "Сжатие Троицы",
        "Нейросети Троицы", "Язык Вайби", "Компилятор 999",
        "Vibee OS — Живая Система", "Инструменты Мастера", "Паттерны Троицы",
        # Том III
        "Параллельная Троица", "Векторная Троица", "Квантовая Троица",
        "Триадические Числа", "Искусственный Разум", "Код Жизни",
        "Вселенная Троицы", "Великое Объединение", "Возвращение Домой",
    ]
    
    название = НАЗВАНИЯ_КНИГ[номер_книги - 1]
    царства = ["Медное", "Серебряное", "Золотое"]
    царство = царства[том - 1]
    
    первая_глава = (том - 1) * 333 + (книга_в_томе - 1) * 37 + 1
    
    этап = определить_этап_пути(книга_в_томе)
    
    содержание = f"""# Книга {номер_книги}: {название}

## {царство} Царство, Том {том}

**Главы {первая_глава}-{первая_глава + 36}**

**Этап пути героя:** {этап.name}

---

## Структура книги

```
┌─────────────────────────────────────────────────────────────────┐
│  АКТ I: ЗАВЯЗКА (главы 1-12)                                   │
│  • Крючок — захватить внимание                                 │
│  • Экспозиция — представить концепцию                          │
│  • Первый поворот — точка невозврата                           │
├─────────────────────────────────────────────────────────────────┤
│  АКТ II: РАЗВИТИЕ (главы 13-30)                                │
│  • Испытания и союзники                                        │
│  • Мидпоинт — переломный момент                                │
│  • Второй поворот — всё потеряно                               │
├─────────────────────────────────────────────────────────────────┤
│  АКТ III: РАЗВЯЗКА (главы 31-37)                               │
│  • Кульминация                                                 │
│  • Разрешение                                                  │
│  • Мост к следующей книге                                      │
└─────────────────────────────────────────────────────────────────┘
```

---

"""
    
    # Генерируем все 37 глав
    for i in range(37):
        номер = первая_глава + i
        содержание += сгенерировать_главу_v2(номер)
        содержание += "\n\n"
    
    return содержание

# ═══════════════════════════════════════════════════════════════════════════
# ГЛАВНАЯ ФУНКЦИЯ
# ═══════════════════════════════════════════════════════════════════════════

def main():
    print("╔═══════════════════════════════════════════════════════════╗")
    print("║                                                           ║")
    print("║   ГЕНЕРАТОР КНИГИ 999 v2.0                               ║")
    print("║   С ПУТЁМ ГЕРОЯ И ТРЁХАКТНОЙ СТРУКТУРОЙ                  ║")
    print("║                                                           ║")
    print("║   999 = 37 × 3³ = 3 тома × 9 книг × 37 глав              ║")
    print("║                                                           ║")
    print("╚═══════════════════════════════════════════════════════════╝")
    print()
    
    # Создаём директорию
    output_dir = Path("generated_book_v2")
    output_dir.mkdir(exist_ok=True)
    
    # Генерируем книги
    for книга in range(1, 28):
        том = (книга - 1) // 9 + 1
        царства = ["Медное", "Серебряное", "Золотое"]
        царство = царства[том - 1]
        
        print(f"📚 Книга {книга}/27: {царство} царство...")
        
        содержание = сгенерировать_книгу_v2(книга)
        filename = f"book_{книга:02d}.md"
        (output_dir / filename).write_text(содержание, encoding="utf-8")
    
    print()
    print("✨ КНИГА 999 v2.0 ПРОЯВЛЕНА! ✨")
    print()
    print("Улучшения:")
    print("  • Путь Героя — структура каждого тома")
    print("  • Трёхактная структура — каждая книга")
    print("  • Сцена-Продолжение — каждая глава")
    print("  • Крючки и клиффхэнгеры — вовлечение")
    print("  • Арки персонажей — развитие")

if __name__ == "__main__":
    main()
