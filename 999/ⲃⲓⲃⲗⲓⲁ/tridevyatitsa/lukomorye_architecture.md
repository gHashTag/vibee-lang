# 🌳 Архитектура Лукоморья

> *У лукоморья дуб зелёный;*
> *Златая цепь на дубе том:*
> *И днём и ночью кот учёный*
> *Всё ходит по цепи кругом...*
> — А.С. Пушкин

## Обзор

Архитектура Тридевятицы построена на метафоре **Лукоморья** — сказочного места, где Дуб хранит знания, а Кот их исполняет.

```
┌─────────────────────────────────────────────────────────────┐
│                      🌙 ЛУКОМОРЬЕ                           │
│                   (Runtime Environment)                      │
│                                                              │
│                         🌳 ДУБ                               │
│                    ┌─────────────┐                           │
│         КРОНА      │ 🍃 Качества │  19-27 (Золотое)         │
│       (Heap)       │   атрибуты  │                           │
│                    ├─────────────┤                           │
│         СТВОЛ      │ 🪵 Действия │  10-18 (Серебряное)      │
│       (Stack)      │   функции   │                           │
│                    ├─────────────┤                           │
│         КОРНИ      │ 🌱 Сущности │  1-9 (Медное)            │
│      (Constants)   │   данные    │                           │
│                    └─────────────┘                           │
│                          │                                   │
│                    ⛓️ ЗЛАТАЯ ЦЕПЬ                            │
│                   (Event Loop / GC)                          │
│                          │                                   │
│                    🐱 КОТ УЧЁНЫЙ                             │
│                   (Интерпретатор)                            │
│                                                              │
│         ←── направо: сказку говорит (return value)          │
│         ──→ налево: песнь заводит (side effects)            │
└─────────────────────────────────────────────────────────────┘
```

---

## 🌳 Дуб Зелёный — Модель Памяти

Дуб — это **структура данных** всей программы. Три части дуба соответствуют трём царствам и трём типам памяти:

### 🌱 Корни (Медное Царство) — Константы

```
Значения: 1-9
Тип: Существительные (сущности)
Память: Статическая, неизменяемая
```

Корни уходят глубоко в землю — это **фундаментальные данные**, которые не меняются:

| Символ | Значение | Роль в памяти |
|--------|----------|---------------|
| Ⲁ (1)  | Начало   | NULL / nil    |
| Ⲃ (2)  | Двойственность | Boolean |
| Ⲅ (3)  | Троица   | Enum (3 состояния) |
| Ⲇ (4)  | Основа   | Integer base  |
| Ⲉ (5)  | Жизнь    | Float         |
| Ⲋ (6)  | Гармония | Tuple (2×3)   |
| Ⲍ (7)  | Тайна    | Private data  |
| Ⲏ (8)  | Бесконечность | Pointer  |
| Ⲑ (9)  | Завершение | Return addr |

**Пример:**
```tridevyatitsa
корень ИСТИНА = Ⲃ⁺  // true
корень ЛОЖЬ = Ⲃ⁻    // false
корень НЕВЕДОМО = Ⲃ⁰ // unknown (тернарная логика!)
```

### 🪵 Ствол (Серебряное Царство) — Стек

```
Значения: 10-18
Тип: Глаголы (действия)
Память: Динамическая, LIFO
```

Ствол растёт вверх — это **стек вызовов**, где каждое кольцо — кадр функции:

| Символ | Значение | Операция |
|--------|----------|----------|
| Ⲓ (10) | Движение | CALL     |
| Ⲕ (11) | Сила     | PUSH     |
| Ⲗ (12) | Свет     | LOAD     |
| Ⲙ (13) | Мудрость | COMPUTE  |
| Ⲛ (14) | Порядок  | COMPARE  |
| Ⲝ (15) | Связь    | BRANCH   |
| Ⲟ (16) | Целостность | MERGE |
| Ⲡ (17) | Путь     | JUMP     |
| Ⲣ (18) | Речь     | RETURN   |

**Пример:**
```tridevyatitsa
// Вызов функции — добавляем кольцо на ствол
Ⲓ исцелить(герой)    // CALL
  Ⲕ герой.здоровье   // PUSH аргумент
  Ⲗ зелье.сила       // LOAD значение
  Ⲙ сложить          // COMPUTE
  Ⲣ результат        // RETURN — кольцо снимается
```

### 🍃 Крона (Золотое Царство) — Куча (Heap)

```
Значения: 19-27
Тип: Прилагательные (качества)
Память: Динамическая, управляемая Цепью
```

Крона раскидистая и изменчивая — это **куча**, где живут объекты:

| Символ | Значение | Тип объекта |
|--------|----------|-------------|
| Ⲥ (19) | Слово    | String      |
| Ⲧ (20) | Твердь   | Struct      |
| Ⲩ (21) | Высота   | Array       |
| Ⲫ (22) | Огонь    | Map/Dict    |
| Ⲭ (23) | Дух      | Closure     |
| Ⲯ (24) | Душа     | Object      |
| Ⲱ (25) | Вечность | Immutable   |
| Ⳁ (26) | Царство  | Module      |
| Ⳃ (27) | Полнота  | Universe    |

**Пример:**
```tridevyatitsa
// Создаём объект в кроне
лист герой = Ⲯ {
  имя: Ⲥ "Иван",
  сила: Ⲇ 7,
  заклинания: Ⲩ [огонь, лёд, свет]
}
```

---

## ⛓️ Златая Цепь — Event Loop и Сборщик Мусора

Златая цепь обвивает дуб — это **механизм управления**:

```
        🔄 ЦИКЛ ЦЕПИ
        
    ┌──────────────┐
    │   ОБХОД      │ ← Кот идёт по цепи
    │   КРОНЫ      │   (Mark phase)
    └──────┬───────┘
           │
    ┌──────▼───────┐
    │   ОТМЕТКА    │ ← Живые листья блестят
    │   ЖИВЫХ      │   (Reachable objects)
    └──────┬───────┘
           │
    ┌──────▼───────┐
    │   СБРОС      │ ← Сухие листья падают
    │   МЁРТВЫХ    │   (Sweep phase)
    └──────┬───────┘
           │
           └──────→ 🔄 Повтор
```

### Алгоритм "Кот на цепи"

```python
def обход_цепи():
    """Кот учёный обходит дуб по златой цепи"""
    
    # Начинаем от корней (они всегда живы)
    живые = set(корни)
    
    # Поднимаемся по стволу
    for кольцо in ствол:
        живые.add(кольцо.данные)
    
    # Обходим крону по цепи
    очередь = list(живые)
    while очередь:
        узел = очередь.pop()
        for ссылка in узел.ссылки:
            if ссылка not in живые:
                живые.add(ссылка)
                очередь.append(ссылка)
    
    # Сухие листья падают
    for лист in крона:
        if лист not in живые:
            освободить(лист)  # 🍂
```

---

## 🐱 Кот Учёный — Интерпретатор

Кот — это **исполнитель кода**. Он ходит по цепи и выполняет инструкции:

```
         🐱 КОТ УЧЁНЫЙ
         
    ┌─────────────────────┐
    │   НАПРАВО           │
    │   (return value)    │──→ Сказку говорит
    │                     │    Чистые функции
    │                     │    Вычисления
    └─────────────────────┘
    
    ┌─────────────────────┐
    │   НАЛЕВО            │
    │   (side effects)    │──→ Песнь заводит
    │                     │    I/O операции
    │                     │    Мутации
    └─────────────────────┘
```

### Направо — Сказку говорит (Pure)

Чистые вычисления без побочных эффектов:

```tridevyatitsa
// Кот идёт направо — возвращает значение
сказка сложить(а, б):
    вернуть а + б

// Использование
результат = направо сложить(3, 4)  // 7
```

### Налево — Песнь заводит (Effects)

Операции с побочными эффектами:

```tridevyatitsa
// Кот идёт налево — производит эффект
песнь приветствие(имя):
    молвить "Здравствуй, " + имя + "!"

// Использование
налево приветствие("Иван")  // Выводит на экран
```

### Кругом — Полный цикл

```tridevyatitsa
// Кот ходит кругом — и вычисляет, и производит эффекты
кругом обработать(данные):
    результат = направо преобразовать(данные)
    налево сохранить(результат)
    вернуть результат
```

---

## 🧜‍♀️ Русалка на ветвях — Ленивые вычисления

> *Там на неведомых дорожках*
> *Следы невиданных зверей;*
> *Русалка на ветвях сидит...*

Русалка — это **отложенное вычисление** (thunk), которое сидит на ветке и ждёт:

```tridevyatitsa
// Русалка — ленивое значение
русалка бесконечность = 
    поток(n): вернуть n, бесконечность(n + 1)

// Русалка просыпается только когда её спрашивают
первые_три = взять(3, бесконечность(1))  // [1, 2, 3]
```

---

## 🐺 Леший и другие сущности

### Леший — Обработчик ошибок

```tridevyatitsa
// Леший бродит — ловит ошибки
леший охранять(действие):
    попытка:
        действие()
    поимка ошибка:
        молвить "Леший поймал: " + ошибка
        вернуть НЕВЕДОМО
```

### Баба-Яга — Трансформер

```tridevyatitsa
// Избушка поворачивается — трансформация данных
избушка повернуться(откуда, куда, данные):
    // Преобразование из одного формата в другой
    вернуть преобразовать(данные, откуда, куда)
```

### Кощей — Иммутабельность

```tridevyatitsa
// Смерть Кощея в игле — неизменяемое ядро
кощей создать(значение):
    // Значение нельзя изменить, только создать новое
    вернуть заморозить(значение)
```

---

## 📊 Полная архитектура

```
┌─────────────────────────────────────────────────────────────────┐
│                        ЛУКОМОРЬЕ v1.0                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌──────────┐    ┌──────────┐    ┌──────────┐                   │
│  │  ИСХОД   │───→│   КОТ    │───→│  ИТОГ    │                   │
│  │ (Source) │    │(Runtime) │    │ (Result) │                   │
│  └──────────┘    └────┬─────┘    └──────────┘                   │
│                       │                                          │
│         ┌─────────────┼─────────────┐                           │
│         │             │             │                            │
│         ▼             ▼             ▼                            │
│    ┌─────────┐  ┌──────────┐  ┌─────────┐                       │
│    │  КРОНА  │  │  СТВОЛ   │  │  КОРНИ  │                       │
│    │  (Heap) │  │  (Stack) │  │ (Const) │                       │
│    │ 🍃19-27 │  │ 🪵10-18  │  │ 🌱1-9   │                       │
│    └────┬────┘  └────┬─────┘  └────┬────┘                       │
│         │            │             │                             │
│         └────────────┼─────────────┘                            │
│                      │                                           │
│              ⛓️ ЗЛАТАЯ ЦЕПЬ                                      │
│              (GC / Event Loop)                                   │
│                      │                                           │
│         ┌────────────┼────────────┐                             │
│         │            │            │                              │
│         ▼            ▼            ▼                              │
│    ┌─────────┐  ┌─────────┐  ┌─────────┐                        │
│    │ РУСАЛКА │  │  ЛЕШИЙ  │  │  КОЩЕЙ  │                        │
│    │ (Lazy)  │  │ (Error) │  │(Immut.) │                        │
│    └─────────┘  └─────────┘  └─────────┘                        │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 🎯 Пример программы

```tridevyatitsa
// Программа на языке Лукоморья

// Корни — константы
корень СИЛА_ГЕРОЯ = Ⲇ 10
корень ИМЯ_ГЕРОЯ = Ⲥ "Иван-Царевич"

// Крона — объекты
лист герой = Ⲯ {
    имя: ИМЯ_ГЕРОЯ,
    здоровье: Ⲉ 100.0,
    инвентарь: Ⲩ []
}

// Ствол — функции
сказка исцелить(кого, сколько):
    вернуть кого.здоровье + сколько

песнь приветствовать(кого):
    молвить "Здравствуй, " + кого.имя + "!"

// Главный цикл — Кот ходит кругом
кругом главная():
    налево приветствовать(герой)
    
    новое_здоровье = направо исцелить(герой, 20)
    герой.здоровье = новое_здоровье
    
    налево молвить("Здоровье: " + герой.здоровье)
    
    вернуть герой

// Запуск
главная()
```

---

## 📚 Связь с Creation Pattern

```
┌─────────────────────────────────────────────┐
│           CREATION PATTERN                   │
├─────────────────────────────────────────────┤
│                                              │
│   ИСХОД (Source)     →  КОРНИ (данные)      │
│   ПРЕОБРАЗОВАТЕЛЬ    →  КОТ (runtime)       │
│   ИТОГ (Result)      →  КРОНА (объекты)     │
│                                              │
│   Златая Цепь = связь между ними            │
│                                              │
└─────────────────────────────────────────────┘
```

---

*"И там я был, мёд-пиво пил,*
*По усам текло, а в рот не попало..."*

— Так заканчивается каждая программа: данные прошли через систему, но оригинал остался неизменным (иммутабельность). 🍯
