#!/usr/bin/env python3
"""
═══════════════════════════════════════════════════════════════════════════════
            СВЯЩЕННЫЙ ГЕНЕРАТОР КНИГИ 999
            
            Паттерн: n × 3^k × π^m
            
            Каждая глава порождается из Алфавита Творения
═══════════════════════════════════════════════════════════════════════════════
"""

import math
import json
from pathlib import Path
from dataclasses import dataclass, asdict
from typing import List, Dict, Optional
from genesis_alphabet import АЛФАВИТ, АЛФАВИТ_ПО_ЧИСЛУ, священный_паттерн, Буква

# ═══════════════════════════════════════════════════════════════════════════════
# СВЯЩЕННЫЕ КОНСТАНТЫ
# ═══════════════════════════════════════════════════════════════════════════════

π = math.pi
φ = (1 + math.sqrt(5)) / 2  # Золотое сечение = 1.618...
e = math.e                   # Число Эйлера = 2.718...

# ═══════════════════════════════════════════════════════════════════════════════
# ОБРАЗЫ И АРХЕТИПЫ
# ═══════════════════════════════════════════════════════════════════════════════

# 27 Архетипов (по одному на каждую букву)
АРХЕТИПЫ = {
    1: {"имя": "Источник", "образ": "Точка света во тьме", "урок": "Всё начинается с единого"},
    2: {"имя": "Зеркало", "образ": "Отражение в воде", "урок": "Познай себя через другого"},
    3: {"имя": "Треугольник", "образ": "Три огня на алтаре", "урок": "Синтез рождает новое"},
    4: {"имя": "Крест", "образ": "Перекрёсток четырёх дорог", "урок": "Выбор определяет судьбу"},
    5: {"имя": "Звезда", "образ": "Пятиконечная звезда человека", "урок": "Жизнь — священный дар"},
    6: {"имя": "Соты", "образ": "Пчелиные соты", "урок": "Гармония в совместном труде"},
    7: {"имя": "Радуга", "образ": "Семицветная дуга после грозы", "урок": "Тайна открывается достойным"},
    8: {"имя": "Лемниската", "образ": "Змея, кусающая свой хвост", "урок": "Бесконечность в каждом мгновении"},
    9: {"имя": "Круг", "образ": "Полная луна", "урок": "Завершение — начало нового"},
    
    10: {"имя": "Странник", "образ": "Путник на дороге", "урок": "Путь важнее цели"},
    11: {"имя": "Воин", "образ": "Меч в камне", "урок": "Сила в правде"},
    12: {"имя": "Светоч", "образ": "Факел в пещере", "урок": "Неси свет во тьму"},
    13: {"имя": "Мудрец", "образ": "Старец под дубом", "урок": "Мудрость приходит с опытом"},
    14: {"имя": "Судья", "образ": "Весы правосудия", "урок": "Справедливость превыше всего"},
    15: {"имя": "Ткач", "образ": "Паук в центре паутины", "урок": "Всё связано со всем"},
    16: {"имя": "Строитель", "образ": "Каменщик у храма", "урок": "Целое больше суммы частей"},
    17: {"имя": "Проводник", "образ": "Звезда над горизонтом", "урок": "Следуй за своей звездой"},
    18: {"имя": "Вестник", "образ": "Птица с посланием", "урок": "Слово имеет силу"},
    
    19: {"имя": "Именователь", "образ": "Адам в саду", "урок": "Имя определяет сущность"},
    20: {"имя": "Хранитель", "образ": "Страж у врат", "урок": "Храни то, что доверено"},
    21: {"имя": "Орёл", "образ": "Птица над облаками", "урок": "Поднимись над суетой"},
    22: {"имя": "Феникс", "образ": "Птица в пламени", "урок": "Из пепла восстань обновлённым"},
    23: {"имя": "Ангел", "образ": "Крылатый вестник", "урок": "Дух выше материи"},
    24: {"имя": "Душа", "образ": "Бабочка из кокона", "урок": "Пробуждение неизбежно"},
    25: {"имя": "Вечность", "образ": "Звёздное небо", "урок": "Время — иллюзия"},
    26: {"имя": "Царь", "образ": "Корона на троне", "урок": "Власть — это ответственность"},
    27: {"имя": "Всё", "образ": "Вселенная в капле росы", "урок": "В малом содержится великое"},
}

# Герои для каждого царства
ГЕРОИ = {
    "Медное": [
        {"имя": "Иван-дурак", "роль": "искатель", "дар": "простота сердца"},
        {"имя": "Василиса Премудрая", "роль": "мудрость", "дар": "знание тайн"},
        {"имя": "Емеля", "роль": "мечтатель", "дар": "исполнение желаний"},
    ],
    "Серебряное": [
        {"имя": "Илья Муромец", "роль": "защитник", "дар": "несокрушимая сила"},
        {"имя": "Добрыня Никитич", "роль": "дипломат", "дар": "мудрость в бою"},
        {"имя": "Алёша Попович", "роль": "хитрец", "дар": "смекалка"},
    ],
    "Золотое": [
        {"имя": "Финист Ясный Сокол", "роль": "трансформер", "дар": "перевоплощение"},
        {"имя": "Царевна-Лебедь", "роль": "красота", "дар": "преображение"},
        {"имя": "Жар-птица", "роль": "свет", "дар": "озарение"},
    ],
}

# Места для каждого царства
МЕСТА = {
    "Медное": [
        {"имя": "Избушка на курьих ножках", "суть": "порог между мирами"},
        {"имя": "Дремучий лес", "суть": "место испытаний"},
        {"имя": "Калинов мост", "суть": "переход через смерть"},
    ],
    "Серебряное": [
        {"имя": "Тридевятое царство", "суть": "мир возможностей"},
        {"имя": "Остров Буян", "суть": "центр мира"},
        {"имя": "Подводное царство", "суть": "глубины подсознания"},
    ],
    "Золотое": [
        {"имя": "Лукоморье", "суть": "место силы"},
        {"имя": "Ирий (Рай)", "суть": "высший мир"},
        {"имя": "Китеж-град", "суть": "сокрытая истина"},
    ],
}

# Артефакты
АРТЕФАКТЫ = {
    "Медное": [
        {"имя": "Клубок путеводный", "сила": "указывает путь"},
        {"имя": "Скатерть-самобранка", "сила": "изобилие"},
        {"имя": "Гусли-самогуды", "сила": "гармония"},
    ],
    "Серебряное": [
        {"имя": "Меч-кладенец", "сила": "победа над злом"},
        {"имя": "Шапка-невидимка", "сила": "сокрытие"},
        {"имя": "Сапоги-скороходы", "сила": "преодоление пространства"},
    ],
    "Золотое": [
        {"имя": "Живая вода", "сила": "воскрешение"},
        {"имя": "Молодильные яблоки", "сила": "вечная юность"},
        {"имя": "Перо Жар-птицы", "сила": "свет истины"},
    ],
}


# ═══════════════════════════════════════════════════════════════════════════════
# СВЯЩЕННЫЙ ПАТТЕРН n × 3^k × π^m
# ═══════════════════════════════════════════════════════════════════════════════

@dataclass
class СвященнаяГлава:
    """Глава, порождённая священным паттерном"""
    номер: int
    
    # Паттерн
    n: int              # Базовое число (1-27)
    k: int              # Царство (0, 1, 2)
    m: float            # Трансцендентность
    значение: float     # n × 3^k × π^m
    
    # Буква алфавита
    буква: str
    имя_буквы: str
    смысл_буквы: str
    акт_творения: str
    
    # Царство
    царство: str
    священность: str
    
    # Архетип
    архетип: str
    образ: str
    урок: str
    
    # Содержание
    герой: Dict
    место: Dict
    артефакт: Dict
    
    # Мудрость
    притча: str
    код: str


def вычислить_глубокий_паттерн(глава: int) -> dict:
    """
    Расширенный паттерн с учётом φ (золотое сечение) и e (число Эйлера)
    
    Полная формула: n × 3^k × π^m × φ^p × e^q
    
    где:
        p = 1 если глава в последовательности Фибоначчи
        q = 1 если глава — простое число
    """
    # Базовый паттерн
    n = ((глава - 1) % 27) + 1
    k = min((глава - 1) // 333, 2)
    
    # Трансцендентность
    if глава % 27 == 0:
        m = 2
        священность = "священное"
    elif глава % 9 == 0:
        m = 1
        священность = "благословенное"
    elif глава % 3 == 0:
        m = 0.5
        священность = "благое"
    else:
        m = 0
        священность = "обычное"
    
    # Фибоначчи
    фибоначчи = {1, 2, 3, 5, 8, 13, 21, 34, 55, 89, 144, 233, 377, 610, 987}
    p = 1 if глава in фибоначчи else 0
    
    # Простые числа (упрощённо для первых 1000)
    def простое(n):
        if n < 2: return False
        for i in range(2, int(n**0.5) + 1):
            if n % i == 0: return False
        return True
    q = 1 if простое(глава) else 0
    
    # Полное значение
    значение = n * (3 ** k) * (π ** m) * (φ ** p) * (e ** q)
    
    return {
        "n": n, "k": k, "m": m, "p": p, "q": q,
        "значение": значение,
        "священность": священность,
        "фибоначчи": p == 1,
        "простое": q == 1
    }


def сгенерировать_притчу(буква: Буква, архетип: dict, герой: dict) -> str:
    """Генерирует притчу на основе буквы и архетипа"""
    притчи = [
        f"Шёл {герой['имя']} путём-дорогою, и встретил {архетип['имя']}. "
        f"«{архетип['урок']}», — молвил {архетип['имя']}. "
        f"И понял {герой['имя']}: {буква.акт_творения}",
        
        f"В стародавние времена, когда {буква.смысл} ещё не было явлено миру, "
        f"явился {архетип['образ']}. И стало ясно: {архетип['урок']}.",
        
        f"Три раза спрашивал {герой['имя']} у {архетип['имя']}: «Что есть {буква.смысл}?» "
        f"И трижды отвечал мудрец: «{буква.акт_творения}»",
    ]
    
    # Выбираем притчу на основе номера буквы
    return притчи[буква.число % len(притчи)]


def сгенерировать_код(глава: int, буква: Буква, паттерн: dict) -> str:
    """Генерирует код на языке Тридевятица"""
    return f"""// Глава {глава}: {буква.смысл}
// Паттерн: {паттерн['n']} × 3^{паттерн['k']} × π^{паттерн['m']:.1f} = {паттерн['значение']:.4f}

сказка глава_{глава}():
    // {буква.акт_творения}
    
    корень {буква.символ} = {буква.число}  // {буква.имя}
    корень царство = "{буква.царство}"
    корень священность = {паттерн['m']}
    
    если священность >= 2:
        вернуть "⭐⭐⭐ СВЯЩЕННОЕ"
    иначе если священность >= 1:
        вернуть "⭐⭐ благословенное"
    иначе если священность >= 0.5:
        вернуть "⭐ благое"
    иначе:
        вернуть "обычное"

// Мудрость: {АРХЕТИПЫ[буква.число]['урок']}
"""


def сгенерировать_главу(номер: int) -> СвященнаяГлава:
    """Генерирует полную главу по священному паттерну"""
    
    # Вычисляем паттерн
    паттерн = вычислить_глубокий_паттерн(номер)
    n = паттерн["n"]
    k = паттерн["k"]
    
    # Получаем букву
    буква = АЛФАВИТ_ПО_ЧИСЛУ[n]
    
    # Определяем царство
    царства = ["Медное", "Серебряное", "Золотое"]
    царство = царства[k]
    
    # Получаем архетип
    архетип = АРХЕТИПЫ[n]
    
    # Выбираем героя, место, артефакт
    герой_idx = (номер - 1) % 3
    герой = ГЕРОИ[царство][герой_idx]
    место = МЕСТА[царство][герой_idx]
    артефакт = АРТЕФАКТЫ[царство][герой_idx]
    
    # Генерируем притчу и код
    притча = сгенерировать_притчу(буква, архетип, герой)
    код = сгенерировать_код(номер, буква, паттерн)
    
    return СвященнаяГлава(
        номер=номер,
        n=n, k=k, m=паттерн["m"],
        значение=паттерн["значение"],
        буква=буква.символ,
        имя_буквы=буква.имя,
        смысл_буквы=буква.смысл,
        акт_творения=буква.акт_творения,
        царство=царство,
        священность=паттерн["священность"],
        архетип=архетип["имя"],
        образ=архетип["образ"],
        урок=архетип["урок"],
        герой=герой,
        место=место,
        артефакт=артефакт,
        притча=притча,
        код=код
    )


def глава_в_markdown(глава: СвященнаяГлава) -> str:
    """Конвертирует главу в Markdown"""
    
    # Символы священности
    священность_символ = {
        "священное": "⭐⭐⭐",
        "благословенное": "⭐⭐",
        "благое": "⭐",
        "обычное": ""
    }[глава.священность]
    
    царство_символ = {
        "Медное": "🥉",
        "Серебряное": "🥈",
        "Золотое": "🥇"
    }[глава.царство]
    
    return f"""# Глава {глава.номер}: {глава.смысл_буквы}

## {царство_символ} {глава.царство} царство {священность_символ}

> **Буква:** {глава.буква} ({глава.имя_буквы}) = {глава.n}
> **Паттерн:** {глава.n} × 3^{глава.k} × π^{глава.m:.1f} = {глава.значение:.4f}
> **Священность:** {глава.священность}

---

## 📜 Акт Творения

*{глава.акт_творения}*

---

## 🎭 Архетип: {глава.архетип}

**Образ:** {глава.образ}

**Урок:** {глава.урок}

---

## 👤 Герой: {глава.герой['имя']}

- **Роль:** {глава.герой['роль']}
- **Дар:** {глава.герой['дар']}

## 🏰 Место: {глава.место['имя']}

*{глава.место['суть']}*

## ⚔️ Артефакт: {глава.артефакт['имя']}

*Сила: {глава.артефакт['сила']}*

---

## 📖 Притча

{глава.притча}

---

## 💻 Код

```tridevyatitsa
{глава.код}
```

---

## 🌟 Мудрость главы

> {глава.урок}

---

[← Глава {глава.номер - 1}] | [Глава {глава.номер + 1} →]
"""


def сгенерировать_книгу_999():
    """Генерирует все 999 глав"""
    
    output_dir = Path("generated_tridevyatitsa/sacred")
    output_dir.mkdir(parents=True, exist_ok=True)
    
    print("═" * 70)
    print("        ГЕНЕРАЦИЯ СВЯЩЕННОЙ КНИГИ 999")
    print("        Паттерн: n × 3^k × π^m × φ^p × e^q")
    print("═" * 70)
    print()
    
    # Генерируем все главы
    for номер in range(1, 1000):
        глава = сгенерировать_главу(номер)
        markdown = глава_в_markdown(глава)
        
        (output_dir / f"{номер:03d}_chapter.md").write_text(markdown, encoding="utf-8")
        
        if номер % 100 == 0:
            print(f"  ✓ Главы 1-{номер}")
    
    # Сохраняем JSON для viewer
    все_главы = []
    for номер in range(1, 1000):
        глава = сгенерировать_главу(номер)
        все_главы.append(asdict(глава))
    
    (output_dir / "book_999.json").write_text(
        json.dumps(все_главы, ensure_ascii=False, indent=2),
        encoding="utf-8"
    )
    
    print()
    print(f"✨ Сгенерировано 999 глав в {output_dir}")
    print(f"✨ JSON данные: {output_dir / 'book_999.json'}")


# ═══════════════════════════════════════════════════════════════════════════════
# MAIN
# ═══════════════════════════════════════════════════════════════════════════════

if __name__ == "__main__":
    сгенерировать_книгу_999()
